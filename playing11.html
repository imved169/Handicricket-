<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HandiCricket - Select Playing 11</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root{
      --primary:#1e88e5; --primary-dark:#1565c0;
      --secondary:#ffeb3b; --success:#4CAF50; --danger:#f44336;
      --dark-blue:#061e3e; --medium-blue:#0a2a4a;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      background:linear-gradient(135deg,var(--dark-blue),var(--medium-blue));
      color:#fff;font-family:'Poppins',sans-serif;padding:15px;min-height:100vh;
      display:flex;align-items:center;justify-content:center;
    }
    .container{width:100%;max-width:960px;background:rgba(0,0,0,0.34);border-radius:18px;padding:22px;
      box-shadow:0 10px 25px rgba(0,0,0,.4);border:1px solid rgba(255,255,255,0.06);backdrop-filter:blur(8px)}
    h1{color:var(--secondary);text-shadow:0 0 12px rgba(255,235,59,.5);margin-bottom:14px;font-size:2rem}
    .match-info{background:rgba(13,42,82,.6);padding:16px;border-radius:10px;border-left:4px solid var(--primary);text-align:left;margin-bottom:14px}
    .match-info h2{color:var(--secondary);margin-bottom:8px;font-size:1.05rem}
    .team-selection{display:flex;flex-wrap:wrap;gap:18px;justify-content:center;margin-top:16px}
    .team-box{flex:1;min-width:340px;background:rgba(13,42,82,.6);border-radius:12px;padding:18px}
    .team-box h2{color:var(--secondary);margin-bottom:8px;border-bottom:2px solid var(--primary);padding-bottom:8px}
    .player-input{display:flex;margin:12px 0}
    select{flex:1;padding:10px;border-radius:8px 0 0 8px;border:2px solid var(--primary);background:#fff;color:#000;font-size:14px}
    .player-input button{padding:10px 14px;border-radius:0 8px 8px 0;border:none;background:var(--success);color:#fff;cursor:pointer}
    .player-list{list-style:none;padding:0;margin:12px 0;max-height:300px;overflow:auto}
    .player-list li{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;margin:8px 0;background:rgba(30,136,229,.16);border:1px solid rgba(255,255,255,.06)}
    .player-list li.captain{background:rgba(255,215,0,.18);border-left:4px solid gold}
    .player-list li.vice-captain{background:rgba(192,192,192,.12);border-left:4px solid silver}
    .player-actions{display:flex;gap:8px}
    .make-captain,.make-vice,.remove-player{font-size:12px;padding:6px 8px;border-radius:6px;border:1px solid;cursor:pointer;background:none}
    .make-captain{color:gold;border-color:gold}
    .make-vice{color:silver;border-color:silver}
    .remove-player{color:var(--danger);border-color:rgba(244,67,54,.6)}
    .captain-badge,.vice-badge{font-size:10px;padding:3px 6px;border-radius:4px;margin-left:6px;font-weight:700}
    .captain-badge{background:gold;color:#000}
    .vice-badge{background:silver;color:#000}
    .player-count{color:#ccc;margin-top:8px;font-weight:500}
    button.action-btn{padding:14px 20px;border-radius:10px;border:none;background:linear-gradient(145deg,var(--success),#2E7D32);color:#fff;font-weight:600;cursor:pointer;width:100%;max-width:280px;margin-top:12px}
    button.action-btn:disabled{background:#666;cursor:not-allowed}
    .waiting{margin-top:12px;padding:12px;border-radius:10px;background:rgba(255,235,59,.12);border:1px solid rgba(255,235,59,.18)}
    .loading-spinner{border:2px solid rgba(255,255,255,.2);border-top:2px solid var(--primary);border-radius:50%;width:18px;height:18px;animation:spin 1s linear infinite;display:inline-block;vertical-align:middle;margin-right:8px}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    /* modal */
    .team-management-modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:92%;max-width:420px;background:linear-gradient(145deg,var(--dark-blue),var(--medium-blue));padding:18px;border-radius:12px;display:none;z-index:50;border:1px solid rgba(255,255,255,.06)}
    .squad-list{max-height:320px;overflow:auto;margin-top:10px}
    .modal-actions{display:flex;gap:10px;margin-top:12px}
    @media(max-width:760px){.team-selection{flex-direction:column}.team-box{min-width:unset}}
  </style>
</head>
<body>
  <div class="container">
    <h1>üèè Select Your Playing 11</h1>

    <div class="match-info">
      <h2>Match Details</h2>
      <p>Room Code: <strong id="roomCode">-</strong></p>
      <p>Format: <strong id="matchFormat">-</strong></p>
      <p>Toss: <strong id="tossResult">Waiting...</strong></p>
    </div>

    <button id="teamManagementBtn" class="team-management-btn" style="display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:none;background:linear-gradient(145deg,var(--primary),var(--primary-dark));color:#fff;cursor:pointer;margin:8px 0;">
      <i class="fas fa-users"></i> Manage Squad
    </button>

    <div class="team-selection">
      <div class="team-box">
        <h2 id="yourTeamName">Your Team</h2>

        <div class="player-input">
          <select id="playerSelect"><option value="">Select player from squad</option></select>
          <button id="addPlayerBtn">Add Player</button>
        </div>

        <ul class="player-list" id="playerList"></ul>
        <p class="player-count" id="playerCount">Players: 0/11 (Select Captain & Vice-Captain)</p>
      </div>

      <div class="team-box">
        <h2 id="opponentTeamName">Opponent Team</h2>

        <div class="waiting" id="opponentWaiting">
          <span class="loading-spinner"></span>
          <span id="opponentWaitingText">Waiting for opponent to select their team...</span>
        </div>

        <ul class="player-list" id="opponentPlayerList" style="display:none;"></ul>
      </div>
    </div>

    <div style="display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin-top:14px;">
      <button id="submitTeamBtn" class="action-btn" disabled>Submit Team</button>
      <button id="startMatchBtn" class="action-btn" style="display:none;background:linear-gradient(145deg,#1e88e5,#1565c0);">Start Match</button>
    </div>

    <div class="waiting" id="waitingForOpponent" style="display:none;">
      <span class="loading-spinner"></span> Waiting for opponent to submit their team...
    </div>
  </div>

  <!-- Team Management Modal -->
  <div id="teamManagementModal" class="team-management-modal">
    <h3 style="color:var(--secondary);margin-bottom:8px;border-bottom:2px solid var(--primary);padding-bottom:8px">Team Management</h3>
    <div class="squad-list" id="squadList"><p style="color:#aaa;text-align:center">Loading squad...</p></div>
    <div class="modal-actions">
      <button id="editSquadBtn" style="flex:1;padding:10px;border-radius:8px;border:none;background:linear-gradient(145deg,var(--success),#2e7d32);color:#fff">Edit Squad</button>
      <button id="closeTeamManagement" style="flex:1;padding:10px;border-radius:8px;border:none;background:linear-gradient(145deg,var(--danger),#d32f2f);color:#fff">Close</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getDatabase, ref, onValue, update, get, set } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

    // Use your project config (kept same as your index/toss). Replace if needed.
    const firebaseConfig = {
      apiKey: "AIzaSyCN6aZMwlsZe7JJaovU0WA3UQygWr4jYmA",
      authDomain: "handicricket-85a06.firebaseapp.com",
      projectId: "handicricket-85a06",
      storageBucket: "handicricket-85a06.appspot.com",
      messagingSenderId: "599182538558",
      appId: "1:599182538558:web:3e965753ab05f8f1e3de6f",
      measurementId: "G-HSV9H4LEJQ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // URL params
    const params = new URLSearchParams(window.location.search);
    const roomId = params.get('room');
    const player = params.get('player'); // player1 or player2
    const teamName = decodeURIComponent(params.get('team') || '');
    const opponent = player === 'player1' ? 'player2' : 'player1';

    if (!roomId || !player) {
      alert('Invalid room or player');
      location.href = 'index.html';
    }

    // Refs
    const roomRef = ref(db, `rooms/${roomId}`);
    const tossRef = ref(db, `rooms/${roomId}/toss`);
    const teamsRef = ref(db, `rooms/${roomId}/teams`);
    const playerRef = ref(db, `rooms/${roomId}/${player}`);
    const opponentRef = ref(db, `rooms/${roomId}/${opponent}`);

    // DOM
    const roomCodeEl = document.getElementById('roomCode');
    const matchFormatEl = document.getElementById('matchFormat');
    const tossResultEl = document.getElementById('tossResult');
    const yourTeamName = document.getElementById('yourTeamName');
    const opponentTeamName = document.getElementById('opponentTeamName');

    const playerSelect = document.getElementById('playerSelect');
    const addPlayerBtn = document.getElementById('addPlayerBtn');
    const playerList = document.getElementById('playerList');
    const playerCount = document.getElementById('playerCount');
    const submitTeamBtn = document.getElementById('submitTeamBtn');
    const waitingForOpponent = document.getElementById('waitingForOpponent');
    const startMatchBtn = document.getElementById('startMatchBtn');

    const opponentWaiting = document.getElementById('opponentWaiting');
    const opponentPlayerList = document.getElementById('opponentPlayerList');

    // Modal
    const teamManagementBtn = document.getElementById('teamManagementBtn');
    const teamManagementModal = document.getElementById('teamManagementModal');
    const squadList = document.getElementById('squadList');
    const editSquadBtn = document.getElementById('editSquadBtn');
    const closeTeamManagement = document.getElementById('closeTeamManagement');

    // State
    let players = [];
    let squadPlayers = [];
    let opponentPlayers = [];
    let captain = null;
    let viceCaptain = null;
    let username = localStorage.getItem('hc_username') || '';

    const formatNames = {"5":"T5 (5 Overs)","10":"T10 (10 Overs)","20":"T20 (20 Overs)","50":"ODI (50 Overs)","test":"Test"};

    // Initialize view
    roomCodeEl.textContent = roomId;
    yourTeamName.textContent = teamName || 'Your Team';

    // set connected
    update(playerRef, { connected:true, team: teamName }).catch(()=>{});

    // Listen to room root for format, team names, and fallback toss fields
    onValue(roomRef, (snap) => {
      if (!snap.exists()) return;
      const room = snap.val();

      // Format
      const f = room.format || (room.player1 && room.player1.format) || '20';
      matchFormatEl.textContent = formatNames[f] || f;

      // Opponent team names
      const t1 = room.team1 || (room.player1 && room.player1.team) || 'Team A';
      const t2 = room.team2 || (room.player2 && room.player2.team) || 'Team B';
      opponentTeamName.textContent = player === 'player1' ? (t2) : (t1);

      // Backwards-compatible toss info stored at room root (if any)
      if (room.tossWinner || room.battingFirst || room.tossCall) {
        const winner = room.tossWinner || null;
        const battingFirst = room.battingFirst || null;
        const tossCall = room.tossCall || null;

        if (winner) {
          const winnerName = (winner === 'player1') ? (t1) : (t2);
          const choiceText = tossCall === 'bat' ? 'bat' : (tossCall === 'bowl' ? 'bowl' : 'decide');
          tossResultEl.textContent = `${winnerName} won the toss and chose to ${choiceText} first`;
        }
        if (battingFirst) {
          // ensure UI reflects battingFirst when already chosen
          // no UI action needed here; start redirect will include battingFirst
        }
      }
    });

    // Listen to toss node (preferred place where toss flow writes data - compatible with toss.html). Ó®Å4Ó®Ç
    onValue(tossRef, (snap) => {
      if (!snap.exists()) return;
      const t = snap.val();

      // t.result, t.winner, t.battingChoice, t.battingFirst are expected (see toss implementation).
      if (t && (t.result || t.winner || t.battingChoice || t.battingFirst)) {
        const roomTeams = {}; // we'll get team names from room root
        get(roomRef).then(rs => {
          const r = rs.exists() ? rs.val() : {};
          const t1 = r.team1 || (r.player1 && r.player1.team) || 'Team A';
          const t2 = r.team2 || (r.player2 && r.player2.team) || 'Team B';
          const winner = t.winner;
          const resultText = t.result ? t.result.toUpperCase() : '‚Äî';
          const call = t.call || t.battingChoice || null;

          if (winner) {
            const winnerName = winner === 'player1' ? t1 : t2;
            const action = call === 'bat' ? 'bat' : (call === 'bowl' ? 'bowl' : (t.battingChoice ? (t.battingChoice === 'bat' ? 'bat' : 'bowl') : 'decide'));
            tossResultEl.textContent = `${winnerName} won the toss (${resultText}) and chose to ${action} first`;
          } else {
            tossResultEl.textContent = `Toss result: ${resultText}`;
          }
        });
      }
    });

    // Listen for existing submitted team info (teamsRef)
    onValue(teamsRef, (snap) => {
      const teams = snap.exists() ? snap.val() : {};
      if (teams[opponent]) {
        opponentPlayers = teams[opponent].players || [];
        updateOpponentListUI();
      }

      // both players submitted -> show start for player1, redirect player2
      if (teams.player1 && teams.player2) {
        if (player === 'player1') {
          startMatchBtn.style.display = 'inline-block';
          waitingForOpponent.style.display = 'none';
        } else {
          // For player2: redirect automatically to first-innings page (we include battingFirst when available)
          // Determine battingFirst (prefer toss node)
          get(tossRef).then(ts => {
            const t = ts.exists() ? ts.val() : {};
            const battingFirst = t?.battingFirst || ( (snap.val().battingFirst) ? snap.val().battingFirst : null );
            const bfParam = battingFirst ? `&battingFirst=${battingFirst}` : '';
            location.href = `game_first_innings.html?room=${roomId}&player=${player}${bfParam}`;
          });
        }
      }
    });

    // Load user's squad from /users/{username} and populate select
    function loadSquad() {
      if (!username) {
        alert('Please login first');
        location.href = 'index.html';
        return;
      }
      get(ref(db, `users/${username}`)).then(s => {
        if (!s.exists()) {
          alert('Unable to load squad');
          return;
        }
        const user = s.val();
        squadPlayers = user.players || [];
        populatePlayerSelect();
      }).catch(err => {
        console.error('Error loading squad',err);
        alert('Error loading squad. Try again.');
      });
    }

    function populatePlayerSelect() {
      playerSelect.innerHTML = '<option value="">Select player from squad</option>';
      squadPlayers.forEach(p => {
        if (!players.includes(p)) {
          const opt = document.createElement('option'); opt.value = p; opt.textContent = p;
          playerSelect.appendChild(opt);
        }
      });
    }

    // Add player
    addPlayerBtn.addEventListener('click', () => {
      const val = playerSelect.value.trim();
      if (!val) return;
      if (players.length >= 11) { alert('Maximum 11 players allowed'); return; }
      if (players.includes(val)) { alert('Player already added'); return; }
      players.push(val); updatePlayerUI(); populatePlayerSelect(); playerSelect.value='';
      if (players.length>=11){ playerSelect.disabled=true; addPlayerBtn.disabled=true; }
      submitTeamBtn.disabled = !(players.length===11 && captain && viceCaptain);
    });

    function updatePlayerUI(){
      playerList.innerHTML = '';
      players.forEach((p,i)=>{
        const li = document.createElement('li');
        if (p===captain) li.classList.add('captain');
        if (p===viceCaptain) li.classList.add('vice-captain');

        const span = document.createElement('span'); span.style.maxWidth='65%'; span.style.overflow='hidden'; span.style.textOverflow='ellipsis'; span.textContent = p;

        if (p===captain){ const b = document.createElement('span'); b.className='captain-badge'; b.textContent='C'; span.appendChild(b); }
        else if (p===viceCaptain){ const v = document.createElement('span'); v.className='vice-badge'; v.textContent='VC'; span.appendChild(v); }

        const actions = document.createElement('div'); actions.className='player-actions';

        if (p !== captain) {
          const cbtn = document.createElement('button'); cbtn.className='make-captain'; cbtn.textContent='C'; cbtn.title='Make captain';
          cbtn.onclick = ()=>{ captain = p; if(viceCaptain===p) viceCaptain=null; updatePlayerUI(); submitTeamBtn.disabled = !(players.length===11 && captain && viceCaptain); };
          actions.appendChild(cbtn);
        }
        if (p !== viceCaptain) {
          const vbtn = document.createElement('button'); vbtn.className='make-vice'; vbtn.textContent='VC'; vbtn.title='Make vice-captain';
          vbtn.onclick = ()=>{ viceCaptain = p; if(captain===p) captain=null; updatePlayerUI(); submitTeamBtn.disabled = !(players.length===11 && captain && viceCaptain); };
          actions.appendChild(vbtn);
        }
        const rbtn = document.createElement('button'); rbtn.className='remove-player'; rbtn.textContent='√ó'; rbtn.title='Remove'; rbtn.onclick = ()=>{ players.splice(i,1); if(captain===p) captain=null; if(viceCaptain===p) viceCaptain=null; updatePlayerUI(); populatePlayerSelect(); playerSelect.disabled=false; addPlayerBtn.disabled=false; submitTeamBtn.disabled = !(players.length===11 && captain && viceCaptain); };
        actions.appendChild(rbtn);

        li.appendChild(span); li.appendChild(actions);
        playerList.appendChild(li);
      });

      playerCount.textContent = `Players: ${players.length}/11` + (captain?` | Captain: ${captain}`:'') + (viceCaptain?` | VC: ${viceCaptain}`:'');
    }

    // Update opponent UI
    function updateOpponentListUI(){
      if (opponentPlayers && opponentPlayers.length>0){
        opponentWaiting.style.display='none';
        opponentPlayerList.style.display='block';
        opponentPlayerList.innerHTML = opponentPlayers.map(p=>`<li style="justify-content:center;"><span style="max-width:90%;overflow:hidden;text-overflow:ellipsis">${p}</span></li>`).join('');
      }
    }

    // Submit team to DB
    submitTeamBtn.addEventListener('click', ()=>{
      if (players.length !== 11) { alert('Select 11 players'); return; }
      if (!captain || !viceCaptain) { alert('Select captain and vice-captain'); return; }

      update(teamsRef, {
        [player]: {
          name: teamName,
          players: players,
          captain: captain,
          viceCaptain: viceCaptain
        }
      }).then(()=>{
        submitTeamBtn.style.display='none';
        waitingForOpponent.style.display='block';
        // Player1 waits for player2; player2 redirect is handled in teamsRef listener above.
      }).catch(err=>{ console.error('submit team err',err); alert('Failed to submit team'); });
    });

    // Start match (player1 only). Include battingFirst param from toss node (preferred).
    startMatchBtn.addEventListener('click', ()=>{
      // get battingFirst from toss node (if available)
      get(tossRef).then(ts=>{
        const t = ts.exists() ? ts.val() : {};
        const battingFirst = t?.battingFirst || null;
        // mark room started
        update(roomRef, { gameStarted:true, status:'in-progress' }).then(()=>{
          const bf = battingFirst ? `&battingFirst=${encodeURIComponent(battingFirst)}` : '';
          location.href = `game_first_innings.html?room=${roomId}&player=${player}${bf}`;
        }).catch(err=>{ console.error('start match err',err); alert('Could not start match'); });
      });
    });

    // Opponent disconnect handling
    onValue(opponentRef, (snap)=>{
      if (!snap.exists() || !snap.val() || !snap.val().connected) {
        // keep user on page but show alert
        // (don't automatically navigate away ‚Äî let them retry)
        console.warn('Opponent disconnected');
      }
    });

    // Team management modal
    teamManagementBtn.addEventListener('click', ()=>{
      if (!username) { alert('Please login'); location.href='index.html'; return; }
      get(ref(db, `users/${username}`)).then(s=>{
        if (!s.exists()) { squadList.innerHTML = '<p style="color:#aaa;text-align:center">No squad</p>'; teamManagementModal.style.display='block'; return; }
        const user = s.val();
        const pArr = user.players || [];
        squadList.innerHTML = '';
        pArr.forEach(pl=>{
          const li = document.createElement('div'); li.style.padding='8px 10px'; li.style.borderRadius='6px'; li.style.margin='6px 0'; li.style.background='rgba(30,136,229,.12)'; li.textContent = pl;
          squadList.appendChild(li);
        });
        teamManagementModal.style.display='block';
      }).catch(err=>{ console.error(err); alert('Failed to load squad') });
    });

    closeTeamManagement.addEventListener('click', ()=> teamManagementModal.style.display='none');
    editSquadBtn.addEventListener('click', ()=> { teamManagementModal.style.display='none'; location.href=`squad.html?username=${username}`; });

    // initial load
    loadSquad();

    // Expose helpers (if any existing code relies on them)
    window.removePlayer = function(i){ if (players[i]) { players.splice(i,1); updatePlayerUI(); } };
    window.setCaptain = function(p){ captain=p; if (viceCaptain===p) viceCaptain=null; updatePlayerUI(); };
    window.setViceCaptain = function(p){ viceCaptain=p; if (captain===p) captain=null; updatePlayerUI(); };

  </script>
</body>
</html>