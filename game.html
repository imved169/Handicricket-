<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HandiCricket - Game</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Additional styles for new features */
        .indicator {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            margin-left: 10px;
            font-weight: bold;
            font-size: 0.8em;
        }
        .powerplay {
            background-color: #FFEB3B;
            color: #000;
        }
        .freehit {
            background-color: #4CAF50;
            color: white;
        }
        .dead-over {
            background-color: #F44336;
            color: white;
        }
        .player-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            background: rgba(0,0,0,0.1);
            padding: 10px;
            border-radius: 8px;
        }
        .batter-stats, .bowler-stats {
            width: 48%;
        }
        .wicket-progress {
            height: 5px;
            background: #333;
            border-radius: 3px;
            margin-top: 5px;
        }
        .wicket-progress-fill {
            height: 100%;
            background: #F44336;
            border-radius: 3px;
            width: 0%;
        }
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 100;
            animation: fadeInOut 3s forwards;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { opacity: 0; }
        }
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background-color: #f00;
            animation: confetti-fall 5s linear forwards;
            z-index: 1000;
        }
        @keyframes confetti-fall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèè HandiCricket</h1>
        
        <div class="game-info">
            <div>Game ID: <span id="game-id"></span></div>
            <div>You are: <span id="player-role"></span></div>
            <div>Format: <span id="match-format"></span></div>
            <div id="powerplay-indicator" class="indicator powerplay hidden">üö® Powerplay</div>
            <div id="freehit-indicator" class="indicator freehit hidden">üéØ Free Hit</div>
            <div id="deadover-indicator" class="indicator dead-over hidden">‚ò†Ô∏è Dead Over</div>
        </div>
        
        <div class="scoreboard">
            <div id="score">0/0 <span id="wicket-progress-text">(0.00/1.0)</span></div>
            <div id="overs">0.0</div>
            <div id="target" class="hidden">Target: <span id="target-runs"></span> (<span id="required-rate"></span>)</div>
        </div>
        
        <div id="game-status">Setting up game...</div>
        
        <div id="toss-section" class="hidden">
            <h3>Toss Time!</h3>
            <button id="heads" class="btn">Heads</button>
            <button id="tails" class="btn">Tails</button>
        </div>
        
        <div id="batting-choice" class="hidden">
            <h3>You won the toss!</h3>
            <button id="bat-first" class="btn">Bat First</button>
            <button id="bowl-first" class="btn">Bowl First</button>
        </div>
        
        <div id="game-section" class="hidden">
            <div class="cards">
                <button class="card" data-value="0">0</button>
                <button class="card" data-value="1">1</button>
                <button class="card" data-value="2">2</button>
                <button class="card" data-value="3">3</button>
                <button class="card" data-value="4">4</button>
                <button class="card" data-value="5">5</button>
                <button class="card" data-value="6">6</button>
            </div>
            
            <div id="ball-result"></div>
            
            <div class="player-stats">
                <div class="batter-stats">
                    <h4>Batter: <span id="current-batter"></span> <span id="batter-wickets" class="wicket-count"></span></h4>
                    <div class="wicket-progress"><div id="batter-wicket-progress" class="wicket-progress-fill"></div></div>
                    <p>Runs: <span id="batter-runs"></span> (<span id="batter-sr"></span>)</p>
                    <p>4s/6s: <span id="batter-boundaries"></span></p>
                    <p>Balls: <span id="batter-balls"></span> (<span id="batter-dots"></span> dots)</p>
                </div>
                <div class="bowler-stats">
                    <h4>Bowler: <span id="current-bowler"></span></h4>
                    <p>Overs: <span id="bowler-overs"></span>/<span id="bowler-max-overs"></span></p>
                    <p>Wickets: <span id="bowler-wickets"></span></p>
                    <p>Runs: <span id="bowler-runs-given"></span> (<span id="bowler-economy"></span>)</p>
                    <p>Maidens: <span id="bowler-maidens"></span></p>
                </div>
            </div>
        </div>
        
        <div id="game-over" class="hidden">
            <h2 id="result-message"></h2>
            <div id="match-summary"></div>
            <button id="new-game" class="btn">New Game</button>
        </div>
        
        <div id="notifications"></div>
        
        <div id="chat-container" class="hidden">
            <div id="chat-messages"></div>
            <div class="chat-input">
                <input type="text" id="chat-input" placeholder="Type your message...">
                <button id="send-message" class="btn">Send</button>
            </div>
            <div class="quick-emojis">
                <button class="emoji-btn" data-emoji="üëç">üëç</button>
                <button class="emoji-btn" data-emoji="üëè">üëè</button>
                <button class="emoji-btn" data-emoji="üòÆ">üòÆ</button>
                <button class="emoji-btn" data-emoji="üéâ">üéâ</button>
                <button class="emoji-btn" data-emoji="üòÖ">üòÖ</button>
            </div>
        </div>
        <button id="toggle-chat" class="btn secondary">üí¨ Chat</button>
    </div>

    <script type="module">
        import { db, ref, set, onValue, get, push } from './firebase.js';
        
        // Enhanced format rules with all features
        const formatRules = {
            "5": { 
                name: "5 Overs", 
                totalOvers: 5, 
                totalWickets: 11, 
                powerplayOvers: 2, 
                powerplayWicketValue: 0.5,
                maxBowlerOvers: 1,
                deadOvers: [],
                isTest: false
            },
            "10": { 
                name: "10 Overs", 
                totalOvers: 10, 
                totalWickets: 11, 
                powerplayOvers: 3, 
                powerplayWicketValue: 0.5,
                maxBowlerOvers: 2,
                deadOvers: [],
                isTest: false
            },
            "20": { 
                name: "T20", 
                totalOvers: 20, 
                totalWickets: 11, 
                powerplayOvers: 6, 
                powerplayWicketValue: 0.5,
                maxBowlerOvers: 4,
                deadOvers: [],
                isTest: false
            },
            "50": { 
                name: "ODI", 
                totalOvers: 50, 
                totalWickets: 11, 
                powerplayOvers: [1,10,21,30,41,42], 
                powerplayWicketValue: 0.25,
                maxBowlerOvers: 10,
                deadOvers: [11,20,31,40],
                isTest: false
            },
            "test": { 
                name: "Test", 
                totalOvers: Infinity, 
                totalWickets: 30, 
                powerplayOvers: 0, 
                powerplayWicketValue: 0.33,
                maxBowlerOvers: Infinity,
                deadOvers: [],
                isTest: true,
                maxWicketsPerBatter: 3
            }
        };
        
        // Enhanced game state with all features
        const state = {
            gameId: localStorage.getItem('gameId'),
            player: localStorage.getItem('player'),
            opponent: null,
            isBatting: false,
            runs: 0,
            wickets: 0,
            balls: 0,
            legalBalls: 0,
            target: 0,
            innings: 1,
            freeHit: false,
            freeHitNextBall: false,
            format: null,
            team1Score: 0,
            team2Score: 0,
            team1Wickets: 0,
            team2Wickets: 0,
            currentBatter: null,
            currentBowler: null,
            batterStats: {},
            bowlerStats: {},
            batterWickets: {}, // Tracks wickets per batter (0.0-1.0 or 0.0-3.0 for Test)
            fallOfWickets: [],
            teamPlayers: [],
            zerosThisOver: { player1: 0, player2: 0 },
            powerplayActive: false,
            deadOverActive: false,
            deadOversUsed: 0,
            team1Name: localStorage.getItem('team1Name') || 'Team 1',
            team2Name: localStorage.getItem('team2Name') || 'Team 2',
            bowlerOvers: {} // Tracks overs bowled by each bowler
        };
        
        // Initialize game
        document.addEventListener('DOMContentLoaded', () => {
            if (!state.gameId || !state.player) {
                window.location.href = 'index.html';
                return;
            }
            
            state.opponent = state.player === 'player1' ? 'player2' : 'player1';
            
            // Display game info
            document.getElementById('game-id').textContent = state.gameId;
            document.getElementById('player-role').textContent = state.player;
            
            // Load format from localStorage
            const format = localStorage.getItem('format') || '5';
            state.format = formatRules[format];
            document.getElementById('match-format').textContent = state.format.name;
            
            // Initialize player stats
            initializePlayerStats();
            
            // Listen for game changes
            const gameRef = ref(db, `games/${state.gameId}`);
            onValue(gameRef, (snapshot) => {
                const game = snapshot.val();
                if (!game) {
                    alert('Game ended');
                    window.location.href = 'index.html';
                    return;
                }
                
                handleGameState(game);
            });
            
            // Initialize chat
            setupChat();
        });
        
        function initializePlayerStats() {
            // Initialize batter stats
            state.batterStats = {};
            state.batterWickets = {};
            const battingTeam = state.isBatting ? state.player : state.opponent;
            const batters = battingTeam === "player1" ? state.teamPlayers : state.teamPlayers;
            batters.forEach(player => {
                state.batterStats[player] = { 
                    runs: 0, 
                    balls: 0, 
                    dots: 0, 
                    fours: 0, 
                    sixes: 0 
                };
                state.batterWickets[player] = 0;
            });
            
            // Initialize bowler stats
            state.bowlerStats = {};
            state.bowlerOvers = {};
            const bowlingTeam = state.isBatting ? state.opponent : state.player;
            const bowlers = bowlingTeam === "player1" ? state.teamPlayers : state.teamPlayers;
            bowlers.forEach(player => {
                state.bowlerStats[player] = { 
                    overs: 0, 
                    maidens: 0, 
                    runs: 0, 
                    wickets: 0,
                    balls: 0 
                };
                state.bowlerOvers[player] = 0;
            });
        }
        
        function handleGameState(game) {
            switch (game.status) {
                case 'toss':
                    handleToss(game);
                    break;
                case 'batting-choice':
                    handleBattingChoice(game);
                    break;
                case 'playing':
                    handlePlaying(game);
                    break;
                case 'completed':
                    handleGameEnd(game);
                    break;
                default:
                    document.getElementById('game-status').textContent = 'Waiting...';
            }
        }
        
        function handleToss(game) {
            document.getElementById('toss-section').classList.remove('hidden');
            document.getElementById('game-status').textContent = 'Call the toss!';
            
            if (game.toss?.[state.player]) {
                document.getElementById('toss-section').classList.add('hidden');
                document.getElementById('game-status').textContent = 'Waiting for opponent...';
                return;
            }
            
            document.getElementById('heads').onclick = () => callToss('heads');
            document.getElementById('tails').onclick = () => callToss('tails');
        }
        
        async function callToss(call) {
            await set(ref(db, `games/${state.gameId}/toss/${state.player}`), call);
            
            const toss = await get(ref(db, `games/${state.gameId}/toss`));
            if (toss.val()?.player1 && toss.val()?.player2) {
                const result = Math.random() < 0.5 ? 'heads' : 'tails';
                const winner = toss.val()[state.player] === result ? state.player : state.opponent;
                
                await set(ref(db, `games/${state.gameId}`), {
                    status: 'batting-choice',
                    tossWinner: winner,
                    tossResult: result
                });
            }
        }
        
        function handleBattingChoice(game) {
            if (game.tossWinner === state.player) {
                document.getElementById('batting-choice').classList.remove('hidden');
                document.getElementById('game-status').textContent = 'Choose to bat or bowl';
                
                document.getElementById('bat-first').onclick = () => setChoice(state.player);
                document.getElementById('bowl-first').onclick = () => setChoice(state.opponent);
            } else {
                document.getElementById('game-status').textContent = 'Opponent won toss, waiting...';
            }
        }
        
        async function setChoice(battingFirst) {
            await set(ref(db, `games/${state.gameId}`), {
                status: 'playing',
                battingFirst: battingFirst,
                innings: 1,
                score: { runs: 0, wickets: 0, balls: 0 }
            });
        }
        
        function handlePlaying(game) {
            document.getElementById('toss-section').classList.add('hidden');
            document.getElementById('batting-choice').classList.add('hidden');
            document.getElementById('game-section').classList.remove('hidden');
            
            state.isBatting = game.battingFirst === state.player ? game.innings === 1 : game.innings === 2;
            state.runs = game.score?.runs || 0;
            state.wickets = game.score?.wickets || 0;
            state.balls = game.score?.balls || 0;
            state.legalBalls = game.score?.legalBalls || 0;
            state.innings = game.innings || 1;
            state.target = game.target || 0;
            state.freeHit = game.freeHit || false;
            state.freeHitNextBall = game.freeHitNextBall || false;
            
            if (state.teamPlayers.length === 0) {
                const team1 = JSON.parse(localStorage.getItem('team1') || '[]');
                const team2 = JSON.parse(localStorage.getItem('team2') || '[]');
                state.teamPlayers = state.player === 'player1' ? team1 : team2;
                
                if (state.teamPlayers.length > 0) {
                    state.currentBatter = state.teamPlayers[0];
                    state.currentBowler = state.teamPlayers.find(p => !p.includes('wicketkeeper'));
                }
            }
            
            if (state.innings === 2 && state.target > 0) {
                document.getElementById('target').classList.remove('hidden');
                document.getElementById('target-runs').textContent = state.target;
                updateRequiredRate();
            }
            
            updateUI();
            
            document.querySelectorAll('.card').forEach(card => {
                card.onclick = () => playCard(parseInt(card.dataset.value));
            });
            
            onValue(ref(db, `games/${state.gameId}/plays`), async (snapshot) => {
                const plays = snapshot.val();
                if (!plays?.player1 || !plays?.player2) return;
                
                const batterCard = state.isBatting ? plays[state.player] : plays[state.opponent];
                const bowlerCard = state.isBatting ? plays[state.opponent] : plays[state.player];
                
                const outcome = calculateOutcome(batterCard, bowlerCard);
                updateScore(outcome);
                
                await set(ref(db, `games/${state.gameId}/plays`), {
                    player1: null,
                    player2: null
                });
            });
        }
        
        function calculateOutcome(bat, bowl) {
            // Enhanced outcome calculation with all features
            
            // Check for zero card limitations
            if (bat === 0) {
                state.zerosThisOver[state.player]++;
                if (state.zerosThisOver[state.player] > 3 && !state.format.isTest) {
                    return {
                        runs: state.isBatting ? -5 : 1,
                        wicket: false,
                        message: state.isBatting ? "Too many zeros! -5 runs" : "NO BALL! +1 run (Too many zeros)",
                        freeHitNextBall: !state.isBatting,
                        legalBall: false
                    };
                }
            }
            
            if (bowl === 0) {
                state.zerosThisOver[state.opponent]++;
                if (state.zerosThisOver[state.opponent] > 3 && !state.format.isTest) {
                    return {
                        runs: 1,
                        wicket: false,
                        message: "NO BALL! +1 run (Too many zeros)",
                        freeHitNextBall: true,
                        legalBall: false
                    };
                }
            }
            
            // No Ball (both 0)
            if (bat === 0 && bowl === 0) {
                if (state.format.isTest) {
                    return { 
                        runs: 0, 
                        wicket: false, 
                        message: "No run (Test Match)",
                        legalBall: true
                    };
                }
                return { 
                    runs: 1, 
                    wicket: false, 
                    message: "NO BALL! +1 run (Free Hit next ball)",
                    freeHitNextBall: true,
                    legalBall: false
                };
            }
            
            // Free Hit
            if (state.freeHit) {
                if (bat === bowl && bat > 0) {
                    return { 
                        runs: 0, 
                        wicket: false, 
                        message: "Wicket on Free Hit (not out)",
                        freeHit: false,
                        legalBall: true
                    };
                }
                return {
                    runs: bat,
                    wicket: false,
                    message: `${bat} Run(s)! (Free Hit)`,
                    freeHit: false,
                    legalBall: true
                };
            }
            
            // Wicket (same number > 0)
            if (bat === bowl && bat > 0) {
                const wicketValue = getWicketValue();
                const newWicketTotal = (state.batterWickets[state.currentBatter] || 0) + wicketValue;
                const isOut = newWicketTotal >= (state.format.isTest ? state.format.maxWicketsPerBatter : 1.0);
                
                return {
                    runs: 0,
                    wicket: true,
                    wicketValue: wicketValue,
                    message: isOut ? "WICKET! (Out)" : `WICKET! (${(1.0 - newWicketTotal).toFixed(2)} left)`,
                    isOut: isOut,
                    legalBall: true
                };
            }
            
            // Batter plays 0 (Test match special rule)
            if (bat === 0 && bowl > 0) {
                if (state.format.isTest) {
                    return {
                        runs: bowl,
                        wicket: false,
                        message: `${bowl} Run(s) to bowler!`,
                        legalBall: true
                    };
                }
                return {
                    runs: bowl,
                    wicket: false,
                    message: `Batter played 0. Runs = ${bowl}`,
                    legalBall: true
                };
            }
            
            // Bowler plays 0 (Test match special rule)
            if (bowl === 0 && bat > 0) {
                if (state.format.isTest) {
                    return {
                        runs: bat,
                        wicket: false,
                        message: `${bat} Run(s)!`,
                        legalBall: true
                    };
                }
                return {
                    runs: bat,
                    wicket: false,
                    message: "Dot ball!",
                    legalBall: true
                };
            }
            
            // Normal runs
            return {
                runs: bat,
                wicket: false,
                message: `${bat} Run(s)!`,
                legalBall: true
            };
        }
        
        function getWicketValue() {
            const currentOver = Math.floor(state.legalBalls / 6);
            let isPowerplay = false;
            
            if (Array.isArray(state.format.powerplayOvers)) {
                for (let i = 0; i < state.format.powerplayOvers.length; i += 2) {
                    if (currentOver >= state.format.powerplayOvers[i] - 1 && 
                        currentOver <= state.format.powerplayOvers[i+1] - 1) {
                        isPowerplay = true;
                        break;
                    }
                }
            } else if (currentOver < state.format.powerplayOvers) {
                isPowerplay = true;
            }
            
            if (state.format.isTest) {
                return 0.33; // Test match wicket value
            }
            
            return isPowerplay ? 
                state.format.powerplayWicketValue : 
                (state.format.name === "ODI" ? 0.5 : 1.0);
        }
        
        function checkPowerplayStatus() {
            const currentOver = Math.floor(state.legalBalls / 6) + 1;
            
            // Reset indicators
            state.powerplayActive = false;
            state.deadOverActive = false;
            
            if (Array.isArray(state.format.powerplayOvers)) {
                for (let i = 0; i < state.format.powerplayOvers.length; i += 2) {
                    if (currentOver >= state.format.powerplayOvers[i] && 
                        currentOver <= state.format.powerplayOvers[i+1]) {
                        state.powerplayActive = true;
                        break;
                    }
                }
            } else {
                state.powerplayActive = currentOver <= state.format.powerplayOvers;
            }
            
            // Check for dead overs (ODI format)
            if (Array.isArray(state.format.deadOvers) && state.format.deadOvers.length > 0) {
                for (let i = 0; i < state.format.deadOvers.length; i += 2) {
                    if (currentOver >= state.format.deadOvers[i] && 
                        currentOver <= state.format.deadOvers[i+1]) {
                        state.deadOverActive = true;
                        break;
                    }
                }
            }
        }
        
        async function playCard(card) {
            await set(ref(db, `games/${state.gameId}/plays/${state.player}`), card);
            document.getElementById('ball-result').textContent = 'Waiting for opponent...';
        }
        
        function updateScore(outcome) {
            // Update runs
            state.runs += outcome.runs;
            
            // Update wickets if applicable
            if (outcome.wicket) {
                state.wickets += outcome.wicketValue || 0;
                state.batterWickets[state.currentBatter] = (state.batterWickets[state.currentBatter] || 0) + (outcome.wicketValue || 0);
                
                if (outcome.isOut) {
                    state.fallOfWickets.push({
                        score: state.runs,
                        batter: state.currentBatter,
                        over: `${Math.floor(state.legalBalls/6)}.${state.legalBalls%6}`
                    });
                    
                    // Get next batter
                    const nextBatterIndex = state.teamPlayers.indexOf(state.currentBatter) + 1;
                    if (nextBatterIndex < state.teamPlayers.length) {
                        state.currentBatter = state.teamPlayers[nextBatterIndex];
                    }
                }
            }
            
            // Update ball counts
            state.balls++;
            if (outcome.legalBall) state.legalBalls++;
            
            // Handle free hit flags
            if (outcome.freeHitNextBall) {
                state.freeHitNextBall = true;
            }
            if (outcome.freeHit !== undefined) {
                state.freeHit = outcome.freeHit;
            }
            
            // Update player stats
            updatePlayerStats(outcome);
            
            // Update UI
            document.getElementById('score').textContent = `${state.runs}/${Math.floor(state.wickets)}`;
            document.getElementById('wicket-progress-text').textContent = 
                `(${(state.batterWickets[state.currentBatter] || 0).toFixed(2)}/${state.format.isTest ? '3.0' : '1.0'})`;
            document.getElementById('overs').textContent = `${Math.floor(state.legalBalls/6)}.${state.legalBalls%6}`;
            document.getElementById('ball-result').textContent = outcome.message;
            
            if (state.innings === 2) {
                updateRequiredRate();
            }
            
            // Check for milestones and game end
            checkMilestones();
            checkGameEnd();
            
            // Update Firebase
            set(ref(db, `games/${state.gameId}/score`), {
                runs: state.runs,
                wickets: state.wickets,
                balls: state.balls,
                legalBalls: state.legalBalls,
                freeHit: state.freeHit,
                freeHitNextBall: state.freeHitNextBall
            });
        }
        
        function updatePlayerStats(outcome) {
            // Update batter stats
            if (state.currentBatter) {
                state.batterStats[state.currentBatter] = state.batterStats[state.currentBatter] || { 
                    runs: 0, balls: 0, dots: 0, fours: 0, sixes: 0 
                };
                
                state.batterStats[state.currentBatter].runs += outcome.runs;
                if (outcome.legalBall) state.batterStats[state.currentBatter].balls++;
                
                if (outcome.runs === 0 && outcome.legalBall) state.batterStats[state.currentBatter].dots++;
                if (outcome.runs === 4) state.batterStats[state.currentBatter].fours++;
                if (outcome.runs === 6) state.batterStats[state.currentBatter].sixes++;
            }
            
            // Update bowler stats
            if (state.currentBowler) {
                state.bowlerStats[state.currentBowler] = state.bowlerStats[state.currentBowler] || { 
                    overs: 0, maidens: 0, runs: 0, wickets: 0, balls: 0 
                };
                
                state.bowlerStats[state.currentBowler].runs += outcome.runs;
                if (outcome.legalBall) state.bowlerStats[state.currentBowler].balls++;
                if (outcome.wicket) state.bowlerStats[state.currentBowler].wickets += outcome.wicketValue || 0;
                
                // Update overs count
                if (outcome.legalBall) {
                    state.bowlerOvers[state.currentBowler] = (state.bowlerOvers[state.currentBowler] || 0) + (1/6);
                    
                    // Check for maiden over
                    if (state.legalBalls % 6 === 0) {
                        const ballsThisOver = state.bowlerStats[state.currentBowler].balls % 6;
                        const runsThisOver = state.bowlerStats[state.currentBowler].runs - 
                            (state.bowlerStats[state.currentBowler].runsAtOverStart || 0);
                        
                        if (runsThisOver === 0 && ballsThisOver === 6) {
                            state.bowlerStats[state.currentBowler].maidens++;
                        }
                        
                        state.bowlerStats[state.currentBowler].runsAtOverStart = state.bowlerStats[state.currentBowler].runs;
                    }
                }
            }
            
            // Update UI
            updatePlayerUI();
        }
        
        function updatePlayerUI() {
            // Update batter UI
            if (state.currentBatter) {
                const batter = state.batterStats[state.currentBatter] || { runs: 0, balls: 0, fours: 0, sixes: 0, dots: 0 };
                const wicketProgress = (state.batterWickets[state.currentBatter] || 0) / 
                    (state.format.isTest ? state.format.maxWicketsPerBatter : 1.0) * 100;
                
                document.getElementById('current-batter').textContent = state.currentBatter;
                document.getElementById('batter-wickets').textContent = 
                    state.format.isTest ? `(${Math.floor(state.batterWickets[state.currentBatter] || 0)}/3)` : '';
                document.getElementById('batter-wicket-progress').style.width = `${wicketProgress}%`;
                document.getElementById('batter-runs').textContent = batter.runs;
                document.getElementById('batter-balls').textContent = batter.balls;
                document.getElementById('batter-dots').textContent = batter.dots;
                document.getElementById('batter-sr').textContent = batter.balls > 0 ? 
                    ((batter.runs / batter.balls * 100).toFixed(2)) : '0.00';
                document.getElementById('batter-boundaries').textContent = `${batter.fours}/${batter.sixes}`;
            }
            
            // Update bowler UI
            if (state.currentBowler) {
                const bowler = state.bowlerStats[state.currentBowler] || { wickets: 0, runs: 0, balls: 0, maidens: 0 };
                const overs = Math.floor(bowler.balls / 6) + (bowler.balls % 6) / 10;
                
                document.getElementById('current-bowler').textContent = state.currentBowler;
                document.getElementById('bowler-overs').textContent = overs.toFixed(1);
                document.getElementById('bowler-max-overs').textContent = state.format.maxBowlerOvers;
                document.getElementById('bowler-wickets').textContent = bowler.wickets;
                document.getElementById('bowler-runs-given').textContent = bowler.runs;
                document.getElementById('bowler-maidens').textContent = bowler.maidens;
                document.getElementById('bowler-economy').textContent = overs > 0 ? 
                    ((bowler.runs / overs).toFixed(2)) : '0.00';
            }
        }
        
        function updateRequiredRate() {
            const ballsRemaining = state.format.totalOvers * 6 - state.legalBalls;
            if (ballsRemaining > 0) {
                const requiredRuns = state.target - state.runs;
                const requiredRate = (requiredRuns / (ballsRemaining / 6)).toFixed(2);
                document.getElementById('required-rate').textContent = `RR: ${requiredRate}`;
            }
        }
        
        function checkGameEnd() {
            const ballsLeft = state.format.totalOvers * 6 - state.legalBalls;
            const wicketsLeft = state.format.totalWickets - Math.floor(state.wickets);
            
            if (state.innings === 1 && (state.wickets >= state.format.totalWickets || state.legalBalls >= state.format.totalOvers * 6)) {
                endInnings();
            }
            else if (state.innings === 2) {
                if (state.runs >= state.target) {
                    endGame(true);
                } else if (state.wickets >= state.format.totalWickets || state.legalBalls >= state.format.totalOvers * 6) {
                    endGame(false);
                }
            }
        }
        
        async function endInnings() {
            const target = state.runs + 1;
            
            await set(ref(db, `games/${state.gameId}`), {
                status: 'playing',
                innings: 2,
                target: target,
                score: { runs: 0, wickets: 0, balls: 0, legalBalls: 0 },
                freeHit: false,
                freeHitNextBall: false
            });
            
            state.innings = 2;
            state.runs = 0;
            state.wickets = 0;
            state.balls = 0;
            state.legalBalls = 0;
            state.isBatting = !state.isBatting;
            state.target = target;
            state.freeHit = false;
            state.freeHitNextBall = false;
            state.zerosThisOver = { player1: 0, player2: 0 };
            
            document.getElementById('target').classList.remove('hidden');
            document.getElementById('target-runs').textContent = target;
            document.getElementById('ball-result').textContent = `Target: ${target}`;
            updateRequiredRate();
            
            initializePlayerStats();
        }
        
        async function endGame(isWin) {
            await set(ref(db, `games/${state.gameId}/status`), 'completed');
            
            document.getElementById('game-section').classList.add('hidden');
            document.getElementById('game-over').classList.remove('hidden');
            
            const message = isWin ? 
                `You won by ${state.isBatting ? state.target - state.runs : state.format.totalWickets - state.wickets} ${state.isBatting ? 'runs' : 'wickets'}!` :
                `You lost by ${state.isBatting ? state.runs - state.target : state.wickets} ${state.isBatting ? 'runs' : 'wickets'}`;
            
            document.getElementById('result-message').textContent = message;
            
            const summary = document.getElementById('match-summary');
            summary.innerHTML = `
                <h3>Match Summary</h3>
                <p><strong>${state.team1Name}:</strong> ${state.team1Score}/${Math.floor(state.team1Wickets || 0)}</p>
                <p><strong>${state.team2Name}:</strong> ${state.runs}/${Math.floor(state.wickets)}</p>
                <h4>Fall of Wickets:</h4>
                <ul>
                    ${state.fallOfWickets.map(w => `<li>${w.score}/${Math.floor(state.wickets)} - ${w.batter} (${w.over})</li>`).join('')}
                </ul>
                <h4>Top Performers:</h4>
                <p>Best Batter: ${getTopBatter()}</p>
                <p>Best Bowler: ${getTopBowler()}</p>
            `;
            
            document.getElementById('new-game').onclick = () => {
                localStorage.clear();
                window.location.href = 'index.html';
            };
        }
        
        function getTopBatter() {
            let topBatter = null;
            let maxRuns = -1;
            
            for (const [name, stats] of Object.entries(state.batterStats)) {
                if (stats.runs > maxRuns) {
                    maxRuns = stats.runs;
                    topBatter = name;
                }
            }
            
            return topBatter ? `${topBatter} (${maxRuns} runs)` : 'None';
        }
        
        function getTopBowler() {
            let topBowler = null;
            let maxWickets = -1;
            let minEconomy = Infinity;
            
            // First find bowler with most wickets
            for (const [name, stats] of Object.entries(state.bowlerStats)) {
                if (stats.wickets > maxWickets) {
                    maxWickets = stats.wickets;
                    topBowler = name;
                }
            }
            
            // If tie, use economy rate
            if (maxWickets > 0) {
                const candidates = Object.entries(state.bowlerStats)
                    .filter(([_, stats]) => stats.wickets === maxWickets);
                
                if (candidates.length > 1) {
                    for (const [name, stats] of candidates) {
                        const overs = stats.balls / 6;
                        const economy = overs > 0 ? (stats.runs / overs) : Infinity;
                        if (economy < minEconomy) {
                            minEconomy = economy;
                            topBowler = name;
                        }
                    }
                }
            }
            
            return topBowler ? `${topBowler} (${maxWickets} wickets)` : 'None';
        }
        
        function handleGameEnd(game) {
            document.getElementById('game-section').classList.add('hidden');
            document.getElementById('game-over').classList.remove('hidden');
            
            const winner = game.winner === state.player ? 'You won!' : 'You lost!';
            document.getElementById('result-message').textContent = `Game over! ${winner}`;
        }
        
        function updateUI() {
            document.getElementById('game-status').textContent = 
                state.isBatting ? 'You are batting' : 'You are bowling';
            
            document.getElementById('score').textContent = `${state.runs}/${Math.floor(state.wickets)}`;
            document.getElementById('wicket-progress-text').textContent = 
                `(${(state.batterWickets[state.currentBatter] || 0).toFixed(2)}/${state.format.isTest ? '3.0' : '1.0'})`;
            document.getElementById('overs').textContent = `${Math.floor(state.legalBalls/6)}.${state.legalBalls%6}`;
            
            checkPowerplayStatus();
            document.getElementById('powerplay-indicator').classList.toggle('hidden', !state.powerplayActive);
            document.getElementById('freehit-indicator').classList.toggle('hidden', !state.freeHit);
            document.getElementById('deadover-indicator').classList.toggle('hidden', !state.deadOverActive);
            
            updatePlayerUI();
        }
        
        function setupChat() {
            const chatRef = ref(db, `games/${state.gameId}/chat`);
            
            onValue(chatRef, (snapshot) => {
                const messages = snapshot.val() || [];
                const chatContainer = document.getElementById('chat-messages');
                chatContainer.innerHTML = '';
                
                messages.forEach(msg => {
                    const msgElement = document.createElement('div');
                    msgElement.className = `chat-message ${msg.sender === state.player ? 'own-message' : ''}`;
                    msgElement.innerHTML = `
                        <strong>${msg.sender === 'player1' ? state.team1Name : state.team2Name}:</strong>
                        <span>${msg.message}</span>
                        <small>${new Date(msg.timestamp).toLocaleTimeString()}</small>
                    `;
                    chatContainer.appendChild(msgElement);
                });
                chatContainer.scrollTop = chatContainer.scrollHeight;
            });
            
            document.getElementById('send-message').addEventListener('click', sendMessage);
            document.getElementById('chat-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });
            
            document.querySelectorAll('.emoji-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    sendEmoji(btn.dataset.emoji);
                });
            });
            
            document.getElementById('toggle-chat').addEventListener('click', () => {
                document.getElementById('chat-container').classList.toggle('hidden');
            });
        }
        
        function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (message) {
                push(ref(db, `games/${state.gameId}/chat`), {
                    sender: state.player,
                    message: message,
                    timestamp: Date.now()
                });
                input.value = '';
            }
        }
        
        function sendEmoji(emoji) {
            push(ref(db, `games/${state.gameId}/chat`), {
                sender: state.player,
                message: emoji,
                timestamp: Date.now(),
                isEmoji: true
            });
            
            const emojiElement = document.createElement('div');
            emojiElement.className = 'emoji-animation';
            emojiElement.textContent = emoji;
            document.body.appendChild(emojiElement);
            setTimeout(() => emojiElement.remove(), 2000);
        }
        
        function checkMilestones() {
            if (!state.currentBatter) return;
            
            const batterStats = state.batterStats[state.currentBatter] || { runs: 0, balls: 0 };
            const bowlerStats = state.bowlerStats[state.currentBowler] || { wickets: 0 };
            
            // Check for batter milestones
            if (batterStats.runs >= 50 && !batterStats.fiftyNotified) {
                showNotification(`${state.currentBatter} scores a half-century!`, 'milestone');
                batterStats.fiftyNotified = true;
            }
            
            if (batterStats.runs >= 100 && !batterStats.centuryNotified) {
                showNotification(`${state.currentBatter} scores a century! üíØ`, 'milestone');
                batterStats.centuryNotified = true;
                createConfetti();
            }
            
            // Check for bowler milestones
            if (bowlerStats.wickets >= 5 && !bowlerStats.fiveWicketsNotified) {
                showNotification(`${state.currentBowler} takes a 5-wicket haul!`, 'milestone');
                bowlerStats.fiveWicketsNotified = true;
                createConfetti();
            }
        }
        
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.getElementById('notifications').appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('fade-out');
                setTimeout(() => notification.remove(), 1000);
            }, 3000);
        }
        
        function createConfetti() {
            const colors = ['#f00', '#0f0', '#00f', '#ff0', '#f0f', '#0ff'];
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = `${Math.random() * 100}%`;
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.width = `${Math.random() * 10 + 5}px`;
                confetti.style.height = `${Math.random() * 10 + 5}px`;
                confetti.style.animationDuration = `${Math.random() * 3 + 2}s`;
                document.body.appendChild(confetti);
                setTimeout(() => confetti.remove(), 5000);
            }
        }
    </script>
</body>
</html>
