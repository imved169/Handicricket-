<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>HandiCricket ‚Äî Auction</title>
<link rel="icon" href="favicon.ico" />
<style>
  /* Modernized, but consistent look & feel */
  :root{
    --bg-1:#061e3e;
    --bg-2:#0a2a4a;
    --accent:#1e88e5;
    --gold:#ffeb3b;
    --glass: rgba(255,255,255,0.04);
    --panel: rgba(10,30,60,0.6);
    --muted: rgba(255,255,255,0.7);
    --success: linear-gradient(145deg,#4CAF50,#2E7D32);
    --danger: linear-gradient(145deg,#FF5722,#E64A19);
    --neutral: linear-gradient(145deg,#607D8B,#455A64);
  }

  html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
  body{
    background: linear-gradient(135deg,var(--bg-1),var(--bg-2));
    color:#fff; -webkit-font-smoothing:antialiased;
    display:flex; align-items:flex-start; justify-content:center; padding:28px 18px;
  }

  .card{
    width: min(1200px, 98%);
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:14px; padding:22px; box-shadow: 0 10px 30px rgba(0,0,0,0.45);
    border: 1px solid rgba(255,255,255,0.04);
  }

  header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:18px; }
  header h1{ margin:0; font-size:20px; color:var(--gold); text-shadow: 0 6px 18px rgba(255,235,59,0.06); }
  header .small{ font-size:12px; color:var(--muted); }

  .top-row { display:flex; gap:14px; margin-bottom:18px; flex-wrap:wrap; }
  .panel{
    background: var(--panel);
    padding:12px; border-radius:10px; min-width:180px;
    border:1px solid rgba(255,255,255,0.03);
  }
  .user-info p{ margin:6px 0; font-size:14px; }
  .user-team{ color:var(--gold); font-weight:700; }

  .layout{
    display:grid;
    grid-template-columns: 1fr 420px;
    gap:18px;
  }

  /* Left column: pool + controls */
  .left{
    display:flex; flex-direction:column; gap:14px;
  }

  .controls-row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  .btn{
    border:0; padding:10px 14px; border-radius:10px; cursor:pointer; color:#fff; font-weight:700;
    box-shadow: 0 6px 14px rgba(0,0,0,0.35);
  }
  .btn:active{ transform: translateY(1px); }
  .btn-primary{ background: var(--success); }
  .btn-danger{ background: var(--danger); }
  .btn-neutral{ background: var(--neutral); }

  .player-pool{
    background: rgba(255,255,255,0.02); padding:12px; border-radius:10px;
    max-height:520px; overflow:auto; border:1px solid rgba(255,255,255,0.02);
  }
  .pool-row{ display:flex; gap:12px; align-items:center; padding:10px; border-radius:8px; margin-bottom:10px; background: linear-gradient(180deg, rgba(30,136,229,0.04), rgba(30,136,229,0.02)); cursor:pointer; transition: transform .12s, box-shadow .12s; }
  .pool-row:hover{ transform: translateY(-4px); box-shadow: 0 8px 18px rgba(0,0,0,0.45); }
  .pool-row.current { background: linear-gradient(90deg, rgba(255,235,59,0.08), rgba(255,235,59,0.02)); border:1px solid rgba(255,235,59,0.12); }
  .player-meta{ flex:1; text-align:left; }
  .player-meta h4{ margin:0 0 6px 0; font-size:16px; color:var(--gold); }
  .player-meta small{ color:var(--muted); display:block; }

  /* Right column: bid & team */
  .right{
    display:flex; flex-direction:column; gap:12px;
  }
  .current-box{ background: rgba(0,0,0,0.25); padding:14px; border-radius:10px; border:1px solid rgba(255,255,255,0.02); }
  .current-box h3{ margin:0 0 10px 0; color:var(--gold); }
  .bid-amount{ font-size:28px; font-weight:800; color:var(--gold); margin-bottom:8px; }
  .bid-by{ color:var(--muted); margin-bottom:10px; }

  .team-list{ background: rgba(255,255,255,0.02); padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,0.02); max-height:420px; overflow:auto; }
  .team-list h4{ margin-top:0; color:var(--gold); }
  .team-item{ padding:8px; border-radius:6px; background: rgba(30,136,229,0.02); margin-bottom:8px; display:flex; justify-content:space-between; align-items:center; }

  /* retention & bulk */
  .retention{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
  .retain-chip{ background: rgba(255,255,255,0.03); padding:6px 8px; border-radius:8px; cursor:pointer; }
  .retain-chip.selected{ background: rgba(76,175,80,0.12); border:1px solid rgba(76,175,80,0.18); }

  textarea{ width:100%; min-height:90px; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background: rgba(255,255,255,0.02); color:#fff; resize:vertical; font-family:inherit; }

  /* small helpers */
  .muted{ color:var(--muted); font-size:13px; }
  .hidden{ display:none !important; }

  @media (max-width:1080px){
    .layout{ grid-template-columns: 1fr; }
    .right{ order:2; }
  }
</style>
</head>
<body>
  <div class="card" id="root">
    <header>
      <div>
        <h1>üèè HandiCricket ‚Äî IPL 2025 Auction</h1>
        <div class="small muted">Realtime auction room ‚Äî admin-controlled selection + 30s auto-sold</div>
      </div>
      <div class="small muted" id="timeNow"> </div>
    </header>

    <!-- top info -->
    <div class="top-row">
      <div class="panel user-info">
        <p>Team: <span id="teamDisplay" class="user-team">‚Äî</span></p>
        <p>Budget: <span id="budgetDisplay">‚Çπ120.00 Cr</span></p>
        <p>Players: <span id="playerCount">0/25</span></p>
        <p>RTM Cards: <span id="rtmCardsDisplay">0</span></p>
      </div>

      <div class="panel">
        <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
          <div class="muted">You are:</div>
          <div id="userBadge" style="font-weight:700;color:var(--gold)"></div>
          <div style="flex:1"></div>
          <div id="adminBadge" class="muted"></div>
        </div>
      </div>

      <div class="panel">
        <div style="display:flex;gap:8px;align-items:center;">
          <button id="btnBack" class="btn btn-neutral">Back</button>
          <button id="btnDebug" class="btn btn-neutral hidden">Debug</button>
        </div>
      </div>
    </div>

    <!-- main layout -->
    <div class="layout">
      <!-- LEFT -->
      <div class="left">
        <!-- Retention -->
        <div class="panel" id="retentionPanel" style="display:none;">
          <h4>Player Retention</h4>
          <div class="muted">Select up to 6 players to retain. Captain costs ‚Çπ4Cr, others ‚Çπ2Cr. RTM cards = 6 - retained.</div>
          <div id="retentionPlayers" style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;"></div>
          <div style="margin-top:10px;display:flex;gap:8px;align-items:center;">
            <button id="btnMarkCaptain" class="btn btn-neutral" disabled>Mark Captain</button>
            <button id="btnSubmitRetention" class="btn btn-primary" disabled>Submit Retention</button>
            <div style="margin-left:auto" class="muted">Selected: <span id="retentionCount">0</span>/6 ‚Äî Cost: ‚Çπ<span id="retentionCost">0</span>Cr</div>
          </div>
        </div>

        <!-- Admin setup -->
        <div class="panel" id="adminSetup" style="display:none;">
          <h4>Admin Setup</h4>
          <div class="muted">Add players to the pool or bulk add. Start auction when ready.</div>
          <div style="margin-top:10px;display:flex;gap:8px;">
            <input id="inputPlayerName" placeholder="Player name" style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff;">
            <select id="selectRole" style="padding:8px;border-radius:8px;">
              <option value="batter">Batter</option>
              <option value="bowler">Pacer</option>
              <option value="spinner">Spinner</option>
              <option value="allrounder">All-Rounder</option>
              <option value="wk">Wicket-Keeper</option>
            </select>
            <button id="btnAddPlayer" class="btn btn-primary">Add</button>
          </div>

          <div style="margin-top:10px;">
            <textarea id="bulkTextarea" placeholder='Bulk format: one per line ‚Äî "Player Name,Role"'></textarea>
            <div style="display:flex;gap:8px;margin-top:8px;">
              <button id="btnBulkAdd" class="btn btn-primary">Add Bulk</button>
              <button id="btnStartAuction" class="btn btn-primary">Start Auction</button>
              <div style="margin-left:auto" class="muted">Room: <span id="roomCode" style="font-weight:700;color:var(--gold)">‚Äî</span></div>
            </div>
          </div>
        </div>

        <!-- Join room -->
        <div class="panel" id="joinPanel" style="display:none;">
          <h4>Join Auction</h4>
          <div class="muted">Enter room code given by admin</div>
          <div style="margin-top:10px;display:flex;gap:8px;">
            <input id="inputRoom" placeholder="6-digit code" style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff;">
            <button id="btnJoin" class="btn btn-primary">Join</button>
          </div>
        </div>

        <!-- Player pool -->
        <div class="player-pool panel" id="poolPanel">
          <h4>Player Pool</h4>
          <div id="poolList" style="margin-top:10px;"></div>
          <div class="muted" style="margin-top:10px;">Admins: click a player to put them on the block. Non-admins watch & bid.</div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="right">
        <div class="current-box">
          <h3>Current Player</h3>
          <div id="currentCard" style="min-height:78px;display:flex;flex-direction:column;justify-content:center;">
            <div class="muted">No player selected</div>
          </div>

          <div style="margin-top:10px;">
            <div class="bid-amount" id="currentBidDisplay">‚Çπ0.50 Cr</div>
            <div class="bid-by muted" id="currentBidBy">Bid By: -</div>
            <div style="display:flex;gap:8px;align-items:center;">
              <button id="btnBid" class="btn btn-primary">Bid (+‚Çπ0.25Cr)</button>
              <button id="btnPass" class="btn btn-neutral">Pass</button>
              <button id="btnRTM" class="btn btn-neutral hidden">Use RTM</button>
              <button id="btnFinal" class="btn btn-primary hidden">Final Bid</button>
              <button id="btnSold" class="btn btn-danger hidden">Sold</button>
              <div style="margin-left:auto" class="muted">Time Left: <span id="timeLeft">‚Äî</span>s</div>
            </div>
          </div>
        </div>

        <div class="team-list">
          <h4>Your Team</h4>
          <div id="myTeamList" style="margin-top:10px;"></div>
          <div style="margin-top:10px;" class="muted">Remaining: <span id="remainingBudget">‚Çπ120.00 Cr</span></div>
        </div>

        <div class="panel" style="margin-top:10px;">
          <h4>Retention Summary</h4>
          <div class="muted">Selected: <span id="retSummaryCount">0</span> | Cost: ‚Çπ<span id="retSummaryCost">0</span>Cr | RTM: <span id="retSummaryRTM">0</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase + App logic -->
  <script type="module">
  /* eslint-disable */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
  import { getDatabase, ref, set, update, get, onValue, child } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

  // ---------- FIREBASE CONFIG (unchanged) ----------
  const firebaseConfig = {
    apiKey: "AIzaSyCN6aZMwlsZe7JJaovU0WA3UQygWr4jYmA",
    authDomain: "handicricket-85a06.firebaseapp.com",
    projectId: "handicricket-85a06",
    storageBucket: "handicricket-85a06.appspot.com",
    messagingSenderId: "599182538558",
    appId: "1:599182538558:web:3e965753ab05f8f1e3de6f",
    measurementId: "G-HSV9H4LEJQ"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // ---------- DOM ----------
  const teamDisplay = document.getElementById('teamDisplay');
  const budgetDisplay = document.getElementById('budgetDisplay');
  const playerCount = document.getElementById('playerCount');
  const rtmCardsDisplay = document.getElementById('rtmCardsDisplay');
  const retentionPanel = document.getElementById('retentionPanel');
  const retentionPlayersEl = document.getElementById('retentionPlayers');
  const btnMarkCaptain = document.getElementById('btnMarkCaptain');
  const btnSubmitRetention = document.getElementById('btnSubmitRetention');
  const retentionCountEl = document.getElementById('retentionCount');
  const retentionCostEl = document.getElementById('retentionCost');
  const btnAddPlayer = document.getElementById('btnAddPlayer');
  const inputPlayerName = document.getElementById('inputPlayerName');
  const selectRole = document.getElementById('selectRole');
  const bulkTextarea = document.getElementById('bulkTextarea');
  const btnBulkAdd = document.getElementById('btnBulkAdd');
  const btnStartAuction = document.getElementById('btnStartAuction');
  const poolList = document.getElementById('poolList');
  const currentCard = document.getElementById('currentCard');
  const currentBidDisplay = document.getElementById('currentBidDisplay');
  const currentBidBy = document.getElementById('currentBidBy');
  const btnBid = document.getElementById('btnBid');
  const btnPass = document.getElementById('btnPass');
  const btnRTM = document.getElementById('btnRTM');
  const btnFinal = document.getElementById('btnFinal');
  const btnSold = document.getElementById('btnSold');
  const timeLeftEl = document.getElementById('timeLeft');
  const myTeamList = document.getElementById('myTeamList');
  const remainingBudgetEl = document.getElementById('remainingBudget');
  const roomCodeEl = document.getElementById('roomCode');
  const adminSetupEl = document.getElementById('adminSetup');
  const joinPanel = document.getElementById('joinPanel');
  const inputRoom = document.getElementById('inputRoom');
  const btnJoin = document.getElementById('btnJoin');
  const btnBack = document.getElementById('btnBack');
  const userBadge = document.getElementById('userBadge');
  const adminBadge = document.getElementById('adminBadge');
  const retSummaryCount = document.getElementById('retSummaryCount');
  const retSummaryCost = document.getElementById('retSummaryCost');
  const retSummaryRTM = document.getElementById('retSummaryRTM');

  // ---------- STATE ----------
  const currentUser = localStorage.getItem('hc_username') || null;
  const currentTeam = localStorage.getItem('hc_team') || null;
  let isAdmin = (currentUser === 'imved169' || currentTeam === 'Ratnagiri Hunters');

  if (!currentUser || !currentTeam) {
    alert('Please login first');
    window.location.href = 'index.html';
  }

  userBadge.textContent = `${currentUser} (${currentTeam})`;
  adminBadge.textContent = isAdmin ? 'Admin' : '';
  teamDisplay.textContent = currentTeam;

  // Default player/team state
  let myBudget = 120.00;
  let myTeam = [];
  let playersPool = []; // array of {id,name,role,basePrice,sold,stats}
  let previousSquad = [];
  let selectedRetentions = [];
  let retentionCaptain = null;
  let rtmCards = 0;

  // Auction state mirrored with Firebase:
  let auctionRoomCode = '';
  let currentPlayer = null; // object
  let currentBid = 0.5;
  let currentBidder = null;
  let rtmActive = false;
  let rtmTeam = null;
  let rtmPlayerId = null;
  let finalBidFlag = false;

  // Timer
  let autoTimer = null;
  let autoTimerLeft = 0;

  // ---------- UTIL ----------
  const CR = (v) => `‚Çπ${v.toFixed(2)} Cr`;
  function uid(){ return Date.now().toString() + Math.random().toString(36).slice(2,8); }

  // ---------- Initialize UI based on role ----------
  (function initUI(){
    budgetDisplay.textContent = CR(myBudget);
    remainingBudgetEl.textContent = CR(myBudget);
    playerCount.textContent = `${myTeam.length}/25`;
    rtmCardsDisplay.textContent = rtmCards;
    roomCodeEl.textContent = '‚Äî';

    if (isAdmin) {
      adminSetupEl.style.display = 'block';
      retentionPanel.style.display = 'block';
    } else {
      joinPanel.style.display = 'block';
      retentionPanel.style.display = 'block'; // retention still allowed if previous squad exists
    }
  })();

  // ---------- Database helpers ----------
  const auctionsRef = (room) => ref(db, `auctions/${room}`);
  const usersRef = () => ref(db, `users`);
  const userRef = (user) => ref(db, `users/${user}`);

  // ---------- Persistence: load user's previous squad & settings ----------

  async function loadMyUserData(){
    const uref = userRef(currentUser);
    try {
      const snap = await get(uref);
      if (snap.exists()){
        const data = snap.val();
        previousSquad = data.players || [];
        myBudget = data.auctionBudget || myBudget;
        myTeam = data.teamPlayers || myTeam;
        rtmCards = data.rtmCards || rtmCards;
        // show retention if previous squad exists
        if (previousSquad.length > 0) {
          retentionPanel.style.display = 'block';
          renderRetentionPlayers();
        }
      } else {
        // no record: show retention only if admin or skip
      }
      updateBudgetUI();
    } catch(e){
      console.error('load user', e);
    }
  }

  // ---------- Retention logic ----------
  function renderRetentionPlayers(){
    retentionPlayersEl.innerHTML = '';
    previousSquad.forEach(p => {
      const chip = document.createElement('div');
      chip.className = 'retain-chip';
      chip.textContent = p;
      chip.dataset.name = p;
      chip.addEventListener('click', () => {
        toggleRetention(p, chip);
      });
      retentionPlayersEl.appendChild(chip);
    });
    updateRetentionSummary();
  }

  function toggleRetention(name, el){
    const idx = selectedRetentions.indexOf(name);
    if (idx === -1){
      if (selectedRetentions.length >= 6) return alert('Max 6 retentions');
      selectedRetentions.push(name);
      el.classList.add('selected');
      if (!retentionCaptain) {
        retentionCaptain = name;
        el.classList.add('captain');
        btnMarkCaptain.disabled = true;
      } else {
        btnMarkCaptain.disabled = false;
      }
    } else {
      selectedRetentions.splice(idx,1);
      el.classList.remove('selected');
      if (retentionCaptain === name) {
        el.classList.remove('captain');
        retentionCaptain = selectedRetentions.length>0 ? selectedRetentions[0] : null;
        if (retentionCaptain){
          const newCapEl = Array.from(retentionPlayersEl.children).find(c => c.dataset.name === retentionCaptain);
          if (newCapEl) newCapEl.classList.add('captain');
        }
      }
      btnMarkCaptain.disabled = selectedRetentions.length <= 1;
    }
    updateRetentionSummary();
  }

  btnMarkCaptain.addEventListener('click', ()=>{
    if (selectedRetentions.length <= 1) return;
    const pick = prompt('Enter captain name from selected:\n' + selectedRetentions.join('\n'));
    if (pick && selectedRetentions.includes(pick)){
      // remove previous captain class
      Array.from(retentionPlayersEl.children).forEach(c => c.classList.remove('captain'));
      const n = Array.from(retentionPlayersEl.children).find(c => c.dataset.name === pick);
      if (n) n.classList.add('captain');
      retentionCaptain = pick;
      updateRetentionSummary();
    } else alert('Invalid selection');
  });

  btnSubmitRetention.addEventListener('click', async ()=>{
    // compute cost
    const captainCost = retentionCaptain ? 4 : 0;
    const otherCost = Math.max(0, selectedRetentions.length - 1) * 2;
    const total = captainCost + otherCost;
    myBudget = +(120 - total).toFixed(2);
    rtmCards = Math.max(0, 6 - selectedRetentions.length);

    // persist to user record
    await update(userRef(currentUser), {
      retainedPlayers: selectedRetentions,
      retentionCaptain: retentionCaptain,
      auctionBudget: myBudget,
      rtmCards
    });

    // update UI
    updateBudgetUI();
    rtmCardsDisplay.textContent = rtmCards;
    alert(`Retention saved. Cost ‚Çπ${total}Cr. Remaining: ‚Çπ${myBudget}Cr, RTM: ${rtmCards}`);
    retentionPanel.style.display = 'none';
  });

  function updateRetentionSummary(){
    retentionCountEl.textContent = selectedRetentions.length;
    const capCost = retentionCaptain ? 4 : 0;
    const otherCost = Math.max(0, selectedRetentions.length -1) * 2;
    const tot = capCost + otherCost;
    retentionCostEl.textContent = tot;
    retSummaryCount.textContent = selectedRetentions.length;
    retSummaryCost.textContent = tot;
    retSummaryRTM.textContent = Math.max(0, 6 - selectedRetentions.length);
    btnSubmitRetention.disabled = selectedRetentions.length === 0;
  }

  // ---------- Admin functions: create room, add players, bulk add, start ----------

  // create a room for admin
  function createRoom(){
    auctionRoomCode = String(Math.floor(100000 + Math.random()*900000));
    roomCodeEl.textContent = auctionRoomCode;
    set(auctionsRef(auctionRoomCode), {
      createdBy: currentUser,
      createdAt: Date.now(),
      playersPool: [],
      teams: {},
      status: 'setup'
    });
    listenRoom(auctionRoomCode);
  }

  // Add single player (admin)
  btnAddPlayer.addEventListener('click', async ()=>{
    const name = inputPlayerName.value.trim();
    const role = selectRole.value;
    if (!name) return alert('Enter player name');
    const p = { id: uid(), name, role, basePrice: 0.5, sold: false };
    // read pool and push
    const poolRef = ref(db, `auctions/${auctionRoomCode}/playersPool`);
    const snap = await get(poolRef);
    const arr = snap.exists() ? snap.val() : [];
    arr.push(p);
    await set(poolRef, arr);
    inputPlayerName.value = '';
    alert('Added to pool');
  });

  // Bulk add
  btnBulkAdd.addEventListener('click', async ()=>{
    const raw = bulkTextarea.value.trim();
    if (!raw) return alert('Enter bulk player lines');
    const lines = raw.split('\n').map(l=>l.trim()).filter(Boolean);
    const newPlayers = [];
    for (const line of lines){
      const [name, role] = line.split(',').map(s=>s && s.trim());
      if (name && role){
        newPlayers.push({ id: uid(), name, role: role.toLowerCase(), basePrice: 0.5, sold:false });
      }
    }
    if (newPlayers.length === 0) return alert('No valid lines. Use "Name,Role" per line');
    const poolRef = ref(db, `auctions/${auctionRoomCode}/playersPool`);
    const snap = await get(poolRef);
    const arr = snap.exists() ? snap.val() : [];
    const merged = [...arr, ...newPlayers];
    await set(poolRef, merged);
    bulkTextarea.value = '';
    alert(`Added ${newPlayers.length} players`);
  });

  // Start auction (admin)
  btnStartAuction.addEventListener('click', async ()=>{
    // require at least one player
    const poolRef = ref(db, `auctions/${auctionRoomCode}/playersPool`);
    const snap = await get(poolRef);
    const arr = snap.exists() ? snap.val() : [];
    if (!arr || arr.length === 0) return alert('Add players first');
    // build teams from users table
    const usersSnap = await get(usersRef());
    const teamsData = {};
    if (usersSnap.exists()){
      const users = usersSnap.val();
      Object.entries(users).forEach(([username, ud])=>{
        teamsData[ud.team || username] = {
          budget: ud.auctionBudget || 120,
          players: (ud.retainedPlayers || []).map(name => ({
            name,
            role: 'unknown',
            price: (ud.retentionCaptain && ud.retentionCaptain === name) ? 4 : 2
          })),
          rtmCards: ud.rtmCards || 0
        };
      });
    } else {
      // fallback: create current user's team if alone
      teamsData[currentTeam] = { budget: myBudget, players: [], rtmCards };
    }

    // set teams and status
    await update(auctionsRef(auctionRoomCode), { teams: teamsData, status: 'active' });
    alert('Auction started ‚Äî admins can click players to put them on the block.');
  });

  // ---------- Join and listen to room ----------
  btnJoin.addEventListener('click', async ()=>{
    const code = inputRoom.value.trim();
    if (!code || code.length !== 6) return alert('Enter a 6-digit code');
    auctionRoomCode = code;
    roomCodeEl.textContent = auctionRoomCode;
    // join: add team if not exists
    const roomSnap = await get(auctionsRef(auctionRoomCode));
    if (!roomSnap.exists()) return alert('Room not found');
    // add / update my team in teams node
    const teamsRef = ref(db, `auctions/${auctionRoomCode}/teams`);
    const snapTeams = await get(teamsRef);
    const teams = snapTeams.exists() ? snapTeams.val() : {};
    if (!teams[currentTeam]) {
      teams[currentTeam] = { budget: myBudget, players: [], rtmCards };
      await set(teamsRef, teams);
    }
    listenRoom(auctionRoomCode);
    joinPanel.style.display = 'none';
  });

  // ---------- Listen to auction room updates ----------
  function listenRoom(room){
    const roomReference = auctionsRef(room);
    onValue(roomReference, snap => {
      if (!snap.exists()) return;
      const data = snap.val();

      // players pool
      playersPool = data.playersPool || [];
      renderPool();

      // teams
      const teams = data.teams || {};
      const myTeamData = teams[currentTeam] || null;
      if (myTeamData){
        myBudget = myTeamData.budget || myBudget;
        myTeam = myTeamData.players || myTeam;
        rtmCards = myTeamData.rtmCards || rtmCards;
        updateBudgetUI();
        renderMyTeam();
      }

      // current player and bids
      if (data.currentPlayer){
        currentPlayer = data.currentPlayer;
        currentBid = data.currentBid || 0.5;
        currentBidder = data.currentBidder || null;
        rtmActive = data.rtmActive || false;
        rtmTeam = data.rtmTeam || null;
        rtmPlayerId = data.rtmPlayer || null;
        finalBidFlag = data.finalBid || false;
        renderCurrentPlayer();
      } else {
        // no current player
        currentPlayer = null;
        currentBid = 0.5;
        currentBidder = null;
        renderCurrentPlayer();
      }

      // RTM/final-bid flows
      if (data.rtmActive){
        // if someone activated RTM we show appropriate UI
      }

    });
  }

  // ---------- Render helpers ----------
  function renderPool(){
    poolList.innerHTML = '';
    // group by role ordering preferred
    const roles = ['batter','allrounder','bowler','spinner','wk'];
    const sorted = playersPool.slice().sort((a,b)=> roles.indexOf(a.role) - roles.indexOf(b.role));
    sorted.forEach(p=>{
      const row = document.createElement('div');
      row.className = 'pool-row' + ((currentPlayer && currentPlayer.id === p.id) ? ' current' : '');
      row.innerHTML = `
        <div class="player-meta">
          <h4>${p.name}</h4>
          <small>${(p.role || 'Unknown').toUpperCase()} ‚Ä¢ Base ‚Çπ0.50 Cr ${p.stats ? '‚Ä¢ '+p.stats : ''}</small>
        </div>
      `;
      // admin can click to set current player
      if (isAdmin){
        row.addEventListener('click', ()=> {
          if (confirm(`Put ${p.name} on block for auction?`)) setCurrentPlayer(p);
        });
      }
      poolList.appendChild(row);
    });
  }

  function renderCurrentPlayer(){
    if (!currentPlayer){
      currentCard.innerHTML = '<div class="muted">No player selected</div>';
      currentBidDisplay.textContent = CR(0.5);
      currentBidBy.textContent = 'Bid By: -';
      btnBid.disabled = true;
      btnPass.disabled = true;
      btnRTM.classList.add('hidden');
      btnFinal.classList.add('hidden');
      btnSold.classList.add('hidden');
      timeLeftEl.textContent = '‚Äî';
      return;
    }

    currentCard.innerHTML = `<strong style="color:var(--gold)">${currentPlayer.name}</strong>
      <div class="muted">${(currentPlayer.role || 'Unknown').toUpperCase()}</div>`;

    currentBidDisplay.textContent = CR(currentBid || 0.5);
    currentBidBy.textContent = `Bid By: ${currentBidder || '-'}`;

    // enable buttons based on state
    btnBid.disabled = (currentBidder === currentTeam) || ((myBudget - (currentBid + 0.25)) < 0);
    btnPass.disabled = false;
    // RTM eligibility: in previous squad but not retained and user has RTM card
    const fromMySquad = previousSquad.includes(currentPlayer.name) && !selectedRetentions.includes(currentPlayer.name);
    if (fromMySquad && rtmCards > 0 && !rtmActive){
      btnRTM.classList.remove('hidden');
    } else {
      btnRTM.classList.add('hidden');
    }

    // if finalBidFlag and I am the rtmTeam then prompt UI
    if (finalBidFlag && rtmTeam === currentTeam){
      // if user is the RTM team they must match/decline (handled elsewhere)
      btnFinal.classList.remove('hidden');
    } else {
      btnFinal.classList.add('hidden');
    }

    // sold button visible to admin (to force-sell)
    if (isAdmin){
      btnSold.classList.remove('hidden');
    } else {
      btnSold.classList.add('hidden');
    }

    // start local timer UI if auction timer exists in DB (we can't read a timer node easily; we'll show local countdown when current player set)
    // We'll rely on the server side (admin selection) to start timer; when admin selects it sets currentPlayer in DB which we detect and start local timer.
    if (autoTimer) { /* already running */ } else {
      // attempt to start local timer with 30s when current player is newly seen
      startLocalAutoTimer();
    }
  }

  function renderMyTeam(){
    myTeamList.innerHTML = '';
    if (!myTeam || myTeam.length === 0) {
      myTeamList.innerHTML = '<div class="muted">No players yet</div>';
      return;
    }
    myTeam.forEach(p=>{
      const div = document.createElement('div');
      div.className = 'team-item';
      div.innerHTML = `<div>${p.name} <small class="muted">${p.role || ''}</small></div><div style="font-weight:700">${CR(p.price || p.price || 0)}</div>`;
      myTeamList.appendChild(div);
    });
    playerCount.textContent = `${myTeam.length}/25`;
  }

  function updateBudgetUI(){
    budgetDisplay.textContent = CR(myBudget);
    remainingBudgetEl.textContent = CR(myBudget);
    rtmCardsDisplay.textContent = rtmCards;
  }

  // ---------- Setting current player (admin action) ----------
  async function setCurrentPlayer(p){
    if (!isAdmin) return;
    // reset RTM flags as new player selected
    await update(auctionsRef(auctionRoomCode), {
      currentPlayer: p,
      currentBid: 0.5,
      currentBidder: null,
      rtmActive: false,
      rtmTeam: null,
      rtmPlayer: null,
      finalBid: false
    });
    // admin local: start timer
    startAutoTimerOnServer(); // sets server-side flag/timestamp if needed (we simply start here)
  }

  // When admin selects a player we start timer locally and rely on DB presence for others to show countdown
  function startLocalAutoTimer(){
    // clear existing
    if (autoTimer) { clearInterval(autoTimer); autoTimer = null; }
    autoTimerLeft = 30;
    timeLeftEl.textContent = autoTimerLeft;
    autoTimer = setInterval(()=>{
      autoTimerLeft--;
      timeLeftEl.textContent = autoTimerLeft;
      if (autoTimerLeft <= 0){
        clearInterval(autoTimer);
        autoTimer = null;
        // After timeout: if there's a bidder -> mark sold, else do nothing (maybe pass)
        if (currentPlayer && currentBidder){
          // only admin should mark sold automatically; but we emulate admin auto-sold by updating DB to trigger markPlayerAsSold
          if (isAdmin) {
            markPlayerAsSold();
          } else {
            // non-admins do nothing ‚Äî admin will eventually mark sold
          }
        }
      }
    }, 1000);
  }

  // Admin also triggers server-side marker for timer start (optional, here it's local)
  async function startAutoTimerOnServer(){
    // We can set a timestamp if desired; not necessary for current flow
    await update(auctionsRef(auctionRoomCode), { lastTimerStart: Date.now() });
  }

  // ---------- Bidding buttons ----------
  btnBid.addEventListener('click', async ()=>{
    if (!currentPlayer) return;
    const newBid = +( (currentBid || 0.5) + 0.25 ).toFixed(2);
    if (newBid > myBudget) return alert('Insufficient budget');
    await update(auctionsRef(auctionRoomCode), { currentBid: newBid, currentBidder: currentTeam });
    // reset timer
    if (autoTimer){ clearInterval(autoTimer); autoTimer = null; startLocalAutoTimer(); }
  });

  btnPass.addEventListener('click', ()=> {
    // no DB action; just pass and wait
    // In real auction pass logic tracked by admin or clients
    alert('You passed on this bid.');
  });

  // RTM flow: use card
  btnRTM.addEventListener('click', async ()=>{
    if (!currentPlayer) return;
    if (rtmCards <= 0) return alert('No RTM cards left');
    rtmCards -= 1;
    await update(userRef(currentUser), { rtmCards });
    // Update auction node to notify others
    await update(auctionsRef(auctionRoomCode), {
      rtmActive: true,
      rtmTeam: currentTeam,
      rtmPlayer: currentPlayer.id
    });
    alert(`RTM used on ${currentPlayer.name}. Original bidder gets one final chance.`);
  });

  // Final bid (original bidder when RTM used)
  btnFinal.addEventListener('click', async ()=>{
    if (!currentPlayer) return;
    const newBid = +( (currentBid || 0.5) + 0.25 ).toFixed(2);
    await update(auctionsRef(auctionRoomCode), {
      currentBid: newBid,
      currentBidder: currentTeam,
      finalBid: true
    });
    btnFinal.classList.add('hidden');
  });

  // Sold (admin action ‚Äî or auto when time runs out and admin allowed)
  btnSold.addEventListener('click', async ()=>{
    if (!isAdmin) return alert('Only admin can mark sold');
    if (!currentPlayer || !currentBidder) return alert('No bidder to award to');
    // perform marking: update teams node, mark player sold in pool, reset currentPlayer
    const roomRef = auctionsRef(auctionRoomCode);
    const snap = await get(roomRef);
    const room = snap.exists() ? snap.val() : {};
    const teams = room.teams || {};

    // Add player to winning team
    const winner = currentBidder;
    const price = currentBid || 0.5;
    if (!teams[winner]) teams[winner] = { budget: 120, players: [], rtmCards: 0 };
    const winnerPlayers = teams[winner].players || [];
    winnerPlayers.push({ name: currentPlayer.name, role: currentPlayer.role, price });
    teams[winner].players = winnerPlayers;
    teams[winner].budget = +( (teams[winner].budget || 120) - price ).toFixed(2);

    // mark player sold in pool
    const pool = (room.playersPool || []).map(p => p.id === currentPlayer.id ? ({...p, sold:true}) : p);

    // reset auction flags
    const updates = {
      teams,
      playersPool: pool,
      currentPlayer: null,
      currentBid: 0.5,
      currentBidder: null,
      rtmActive: false,
      rtmTeam: null,
      rtmPlayer: null,
      finalBid: false
    };

    await set(roomRef, { ...room, ...updates });
    // local cleanup
    currentPlayer = null; currentBid = 0.5; currentBidder = null;
    renderPool(); renderCurrentPlayer();
    alert('Player marked sold and assigned.');
  });

  // Mark player as sold (used by auto-timer implicitly if admin)
  async function markPlayerAsSold(){
    // this reuses same logic as btnSold ‚Äî find winner and update
    if (!currentPlayer || !currentBidder) return;
    btnSold.click(); // admin flow
  }

  // ---------- When page loads, load user data and if admin create room, else wait ----------
  (async function boot(){
    await loadMyUserData();

    if (isAdmin){
      createRoom();
    } else {
      // show join UI already present
    }
  })();

  // ---------- helper: convert to money string ----------
  function CRvalue(num){
    return `‚Çπ${(num || 0).toFixed(2)} Cr`;
  }

  // alias
  function CR(num){ return CRvalue(num); }

  // ---------- listen to DB for immediate pool updates if admin created room earlier ----------
  // If admin created room above we already called listenRoom in createRoom
  // But if user refreshed and room code set earlier in localStorage, we can attempt to reconnect
  (async function tryReconnectRoom(){
    // try read from user record if they have lastActiveRoom set
    try {
      const snap = await get(userRef(currentUser));
      if (snap.exists()){
        const data = snap.val();
        if (data.lastAuctionRoom && !auctionRoomCode){
          auctionRoomCode = data.lastAuctionRoom;
          roomCodeEl.textContent = auctionRoomCode;
          listenRoom(auctionRoomCode);
        }
      }
    } catch(e){ /* silent */ }
  })();

  // ---------- render helpers final ----------
  function updateBudgetUI(){
    budgetDisplay.textContent = CR(myBudget);
    remainingBudgetEl.textContent = CR(myBudget);
    rtmCardsDisplay.textContent = rtmCards;
  }

  // render pool & my team initially
  function renderPoolInitial(){ renderPool(); renderMyTeam(); updateBudgetUI(); }
  renderPoolInitial();

  // back button
  btnBack.addEventListener('click', ()=> window.location.href = 'index.html');

  // debug
  // document.getElementById('btnDebug').addEventListener('click', ()=> console.log({
  //   currentPlayer, currentBid, currentBidder, playersPool, myTeam
  // }));

  </script>
</body>
</html>