<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HandiCricket - First Innings</title>
  <style>
    body {
      background: linear-gradient(135deg, #061e3e, #0a2a4a);
      color: white;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      text-align: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    h1 {
      color: #ffeb3b;
      margin: 0;
      font-size: 24px;
    }

    .match-info {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
      font-size: 14px;
      color: #aaa;
    }

    .scoreboard {
      background: rgba(0, 0, 0, 0.4);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .score-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .team-name {
      font-weight: bold;
      font-size: 18px;
      color: #ffeb3b;
    }

    .score {
      font-size: 24px;
      font-weight: bold;
    }

    .overs {
      font-size: 16px;
      color: #aaa;
    }

    .batsmen {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
    }

    .batsman-card {
      flex: 1;
      background: rgba(30, 136, 229, 0.2);
      border-radius: 8px;
      padding: 10px;
      border-left: 3px solid #1e88e5;
    }

    .batsman-name {
      font-weight: bold;
      margin-bottom: 5px;
      display: flex;
      justify-content: space-between;
    }

    .batsman-runs {
      font-size: 18px;
    }

    .batsman-balls {
      font-size: 14px;
      color: #aaa;
    }

    .wicket-bar {
      height: 5px;
      background: rgba(255,255,255,0.2);
      border-radius: 3px;
      margin-top: 5px;
      overflow: hidden;
    }

    .wicket-progress {
      height: 100%;
      background: #f44336;
      width: 0%;
      transition: width 0.3s;
    }

    .bowler-card {
      background: rgba(244, 67, 54, 0.2);
      border-radius: 8px;
      padding: 10px;
      border-left: 3px solid #f44336;
    }

    .bowler-name {
      font-weight: bold;
      margin-bottom: 5px;
    }

    .bowler-stats {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
    }

    .game-area {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }

    .game-controls {
      flex: 1;
      background: rgba(0, 0, 0, 0.4);
      border-radius: 10px;
      padding: 15px;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .game-log {
      flex: 1;
      background: rgba(0, 0, 0, 0.4);
      border-radius: 10px;
      padding: 15px;
      border: 1px solid rgba(255,255,255,0.1);
      max-height: 300px;
      overflow-y: auto;
    }

    .log-entry {
      margin-bottom: 5px;
      padding-bottom: 5px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      font-size: 14px;
    }

    .log-entry.wicket {
      color: #f44336;
    }

    .log-entry.boundary {
      color: #4CAF50;
    }

    .log-entry.special {
      color: #ffeb3b;
    }

    .cards {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }

    .card {
      width: 60px;
      height: 90px;
      background: white;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: bold;
      color: #333;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 3px 6px rgba(0,0,0,0.2);
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 10px rgba(0,0,0,0.3);
    }

    .card.selected {
      background: #ffeb3b;
      transform: translateY(-5px);
      box-shadow: 0 6px 10px rgba(255,235,59,0.3);
    }

    .card.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: 6px;
      background: #1e88e5;
      color: white;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      flex: 1;
    }

    .btn:hover {
      background: #1565c0;
      transform: translateY(-2px);
    }

    .btn:disabled {
      background: #666;
      cursor: not-allowed;
      transform: none;
    }

    .btn-primary {
      background: #4CAF50;
    }

    .btn-primary:hover {
      background: #2E7D32;
    }

    .btn-danger {
      background: #f44336;
    }

    .btn-danger:hover {
      background: #d32f2f;
    }

    .btn-warning {
      background: #FF9800;
    }

    .btn-warning:hover {
      background: #F57C00;
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }

    .modal.active {
      opacity: 1;
      pointer-events: all;
    }

    .modal-content {
      background: #061e3e;
      border-radius: 10px;
      padding: 20px;
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    .modal-title {
      color: #ffeb3b;
      margin-top: 0;
      margin-bottom: 20px;
      text-align: center;
    }

    .player-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .player-item {
      padding: 10px;
      margin-bottom: 5px;
      background: rgba(30, 136, 229, 0.2);
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .player-item:hover {
      background: rgba(30, 136, 229, 0.4);
    }

    .player-item.selected {
      background: rgba(255, 235, 59, 0.3);
      border-left: 3px solid #ffeb3b;
    }

    .player-item.captain::after {
      content: " (C)";
      color: gold;
    }

    .player-item.vice-captain::after {
      content: " (VC)";
      color: silver;
    }

    .powerplay-indicator {
      display: inline-block;
      padding: 3px 8px;
      background: rgba(255, 235, 59, 0.3);
      border-radius: 4px;
      font-size: 12px;
      margin-left: 10px;
      color: #ffeb3b;
    }

    .dead-over-indicator {
      display: inline-block;
      padding: 3px 8px;
      background: rgba(244, 67, 54, 0.3);
      border-radius: 4px;
      font-size: 12px;
      margin-left: 10px;
      color: #f44336;
    }

    .free-hit-indicator {
      display: inline-block;
      padding: 3px 8px;
      background: rgba(76, 175, 80, 0.3);
      border-radius: 4px;
      font-size: 12px;
      margin-left: 10px;
      color: #4CAF50;
    }

    .dot-counter {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
      font-size: 12px;
      color: #aaa;
    }

    .dot-bubble {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: rgba(255,255,255,0.1);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .dot-bubble.filled {
      background: #f44336;
    }

    .dot-counter-label {
      margin-bottom: 5px;
    }

    .dot-counters {
      margin-top: 15px;
    }

    .summary-section {
      background: rgba(0, 0, 0, 0.4);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .summary-title {
      color: #ffeb3b;
      margin-top: 0;
      margin-bottom: 15px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding-bottom: 5px;
    }

    .summary-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .stat-item {
      display: flex;
      justify-content: space-between;
    }

    .stat-label {
      color: #aaa;
    }

    .stat-value {
      font-weight: bold;
    }

    .players-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 14px;
    }

    .players-table th {
      background: rgba(30, 136, 229, 0.5);
      padding: 8px;
      text-align: left;
    }

    .players-table td {
      padding: 8px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .players-table tr:nth-child(even) {
      background: rgba(30, 136, 229, 0.1);
    }

    .highlight {
      background: rgba(255, 235, 59, 0.2);
    }

    @media (max-width: 768px) {
      .game-area {
        flex-direction: column;
      }

      .batsmen {
        flex-direction: column;
      }

      .cards {
        flex-wrap: wrap;
      }

      .card {
        width: 45px;
        height: 70px;
        font-size: 18px;
      }
    }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <h1 id="inningsTitle">First Innings</h1>
      <div class="match-info">
        <div id="matchFormat">T20 Match</div>
        <div id="tossResult">Team A won the toss and chose to bat</div>
      </div>
    </div>

    <div class="scoreboard">
      <div class="score-header">
        <div class="team-name" id="battingTeamName">Team A</div>
        <div class="score" id="teamScore">0/0</div>
        <div class="overs" id="oversCount">0.0</div>
      </div>
      <div class="batsmen">
        <div class="batsman-card">
          <div class="batsman-name">
            <span id="batsman1Name">-</span>
            <span id="batsman1Status"></span>
          </div>
          <div class="batsman-runs" id="batsman1Runs">0</div>
          <div class="batsman-balls" id="batsman1Balls">0</div>
          <div class="wicket-bar">
            <div class="wicket-progress" id="batsman1Wickets" style="width: 0%"></div>
          </div>
        </div>
        <div class="batsman-card">
          <div class="batsman-name">
            <span id="batsman2Name">-</span>
            <span id="batsman2Status"></span>
          </div>
          <div class="batsman-runs" id="batsman2Runs">0</div>
          <div class="batsman-balls" id="batsman2Balls">0</div>
          <div class="wicket-bar">
            <div class="wicket-progress" id="batsman2Wickets" style="width: 0%"></div>
          </div>
        </div>
      </div>
      <div class="bowler-card">
        <div class="bowler-name" id="bowlerName">Bowler: -</div>
        <div class="bowler-stats">
          <span id="bowlerOvers">Overs: 0</span>
          <span id="bowlerWickets">Wickets: 0</span>
          <span id="bowlerRuns">Runs: 0</span>
        </div>
      </div>
    </div>

    <div class="game-area">
      <div class="game-controls">
        <div id="gameStatus">Waiting for bowler selection...</div>
        
        <div class="dot-counters">
          <div class="dot-counter">
            <div class="dot-counter-label">Batter Dots:</div>
            <div class="dot-bubbles">
              <div class="dot-bubble" id="batterDot1"></div>
              <div class="dot-bubble" id="batterDot2"></div>
              <div class="dot-bubble" id="batterDot3"></div>
              <div class="dot-bubble" id="batterDot4"></div>
            </div>
          </div>
          <div class="dot-counter">
            <div class="dot-counter-label">Bowler Dots:</div>
            <div class="dot-bubbles">
              <div class="dot-bubble" id="bowlerDot1"></div>
              <div class="dot-bubble" id="bowlerDot2"></div>
              <div class="dot-bubble" id="bowlerDot3"></div>
              <div class="dot-bubble" id="bowlerDot4"></div>
            </div>
          </div>
        </div>

        <div id="specialIndicator"></div>

        <div class="cards" id="cardsContainer">
          <div class="card" data-value="0">0</div>
          <div class="card" data-value="1">1</div>
          <div class="card" data-value="2">2</div>
          <div class="card" data-value="3">3</div>
          <div class="card" data-value="4">4</div>
          <div class="card" data-value="5">5</div>
          <div class="card" data-value="6">6</div>
        </div>

        <div class="action-buttons">
          <button class="btn btn-primary" id="submitBtn" disabled>Submit</button>
          <button class="btn btn-warning" id="undoBtn" disabled>Undo</button>
          <button class="btn" id="changeBowlerBtn">Change Bowler</button>
        </div>
      </div>

      <div class="game-log" id="gameLog">
        <div class="log-entry">Match started</div>
      </div>
    </div>

    <div class="summary-section">
      <h3 class="summary-title">Partnership</h3>
      <div class="summary-stats">
        <div class="stat-item">
          <span class="stat-label">Runs:</span>
          <span class="stat-value" id="partnershipRuns">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Balls:</span>
          <span class="stat-value" id="partnershipBalls">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Run Rate:</span>
          <span class="stat-value" id="partnershipRR">0.00</span>
        </div>
      </div>
    </div>

    <div class="action-buttons">
      <button class="btn" id="showTeamsBtn">Show Teams</button>
      <button class="btn btn-primary" id="endInningsBtn" style="display: none;">End Innings</button>
    </div>
  </div>

  <!-- Player Selection Modal -->
  <div class="modal" id="playerSelectionModal">
    <div class="modal-content">
      <h3 class="modal-title" id="selectionModalTitle">Select Bowler</h3>
      <ul class="player-list" id="playerSelectionList">
        <!-- Filled by JavaScript -->
      </ul>
      <div class="action-buttons">
        <button class="btn btn-primary" id="confirmSelectionBtn" disabled>Confirm</button>
        <button class="btn btn-danger" id="cancelSelectionBtn">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Teams Modal -->
  <div class="modal" id="teamsModal">
    <div class="modal-content">
      <h3 class="modal-title">Teams</h3>
      <div class="summary-section">
        <h4 class="summary-title" id="battingTeamModalTitle">Batting Team</h4>
        <table class="players-table">
          <thead>
            <tr>
              <th>Player</th>
              <th>Role</th>
              <th>Runs</th>
              <th>Balls</th>
              <th>Wickets</th>
            </tr>
          </thead>
          <tbody id="battingTeamPlayers">
            <!-- Filled by JavaScript -->
          </tbody>
        </table>
      </div>
      <div class="summary-section">
        <h4 class="summary-title" id="bowlingTeamModalTitle">Bowling Team</h4>
        <table class="players-table">
          <thead>
            <tr>
              <th>Player</th>
              <th>Role</th>
              <th>Overs</th>
              <th>Wickets</th>
              <th>Runs</th>
            </tr>
          </thead>
          <tbody id="bowlingTeamPlayers">
            <!-- Filled by JavaScript -->
          </tbody>
        </table>
      </div>
      <div class="action-buttons">
        <button class="btn btn-danger" id="closeTeamsBtn">Close</button>
      </div>
    </div>
  </div>

  <!-- Innings Summary Modal -->
  <div class="modal" id="inningsSummaryModal">
    <div class="modal-content">
      <h3 class="modal-title" id="inningsSummaryTitle">First Innings Summary</h3>
      <div class="summary-section">
        <div class="summary-stats">
          <div class="stat-item">
            <span class="stat-label">Total Runs:</span>
            <span class="stat-value" id="summaryTotalRuns">0</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Wickets:</span>
            <span class="stat-value" id="summaryWickets">0</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Overs:</span>
            <span class="stat-value" id="summaryOvers">0.0</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Run Rate:</span>
            <span class="stat-value" id="summaryRunRate">0.00</span>
          </div>
        </div>
      </div>
      <div class="summary-section">
        <h4 class="summary-title">Batting Performances</h4>
        <table class="players-table">
          <thead>
            <tr>
              <th>Batter</th>
              <th>Runs</th>
              <th>Balls</th>
              <th>SR</th>
            </tr>
          </thead>
          <tbody id="inningsBatters">
            <!-- Filled by JavaScript -->
          </tbody>
        </table>
      </div>
      <div class="summary-section">
        <h4 class="summary-title">Bowling Performances</h4>
        <table class="players-table">
          <thead>
            <tr>
              <th>Bowler</th>
              <th>Overs</th>
              <th>Wickets</th>
              <th>ER</th>
            </tr>
          </thead>
          <tbody id="inningsBowlers">
            <!-- Filled by JavaScript -->
          </tbody>
        </table>
      </div>
      <div class="action-buttons">
        <button class="btn btn-primary" id="continueToSecondInningsBtn">Continue to Second Innings</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getDatabase, ref, onValue, update, get, set } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCN6aZMwlsZe7JJaovU0WA3UQygWr4jYmA",
      authDomain: "handicricket-85a06.firebaseapp.com",
      projectId: "handicricket-85a06",
      storageBucket: "handicricket-85a06.appspot.com",
      messagingSenderId: "599182538558",
      appId: "1:599182538558:web:3e965753ab05f8f1e3de6f",
      measurementId: "G-HSV9H4LEJQ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Get URL parameters
    const params = new URLSearchParams(window.location.search);
    const roomId = params.get('room');
    const playerRole = params.get('player');
    const teamName = decodeURIComponent(params.get('team'));

    if (!roomId || !playerRole) {
      alert('Invalid room or player');
      window.location.href = 'index.html';
    }

    // DOM elements
    const inningsTitle = document.getElementById('inningsTitle');
    const matchFormat = document.getElementById('matchFormat');
    const tossResult = document.getElementById('tossResult');
    const battingTeamName = document.getElementById('battingTeamName');
    const teamScore = document.getElementById('teamScore');
    const oversCount = document.getElementById('oversCount');
    const batsman1Name = document.getElementById('batsman1Name');
    const batsman1Runs = document.getElementById('batsman1Runs');
    const batsman1Balls = document.getElementById('batsman1Balls');
    const batsman1Wickets = document.getElementById('batsman1Wickets');
    const batsman1Status = document.getElementById('batsman1Status');
    const batsman2Name = document.getElementById('batsman2Name');
    const batsman2Runs = document.getElementById('batsman2Runs');
    const batsman2Balls = document.getElementById('batsman2Balls');
    const batsman2Wickets = document.getElementById('batsman2Wickets');
    const batsman2Status = document.getElementById('batsman2Status');
    const bowlerName = document.getElementById('bowlerName');
    const bowlerOvers = document.getElementById('bowlerOvers');
    const bowlerWickets = document.getElementById('bowlerWickets');
    const bowlerRuns = document.getElementById('bowlerRuns');
    const gameStatus = document.getElementById('gameStatus');
    const specialIndicator = document.getElementById('specialIndicator');
    const cardsContainer = document.getElementById('cardsContainer');
    const submitBtn = document.getElementById('submitBtn');
    const undoBtn = document.getElementById('undoBtn');
    const changeBowlerBtn = document.getElementById('changeBowlerBtn');
    const gameLog = document.getElementById('gameLog');
    const partnershipRuns = document.getElementById('partnershipRuns');
    const partnershipBalls = document.getElementById('partnershipBalls');
    const partnershipRR = document.getElementById('partnershipRR');
    const showTeamsBtn = document.getElementById('showTeamsBtn');
    const endInningsBtn = document.getElementById('endInningsBtn');

    // Dot counters
    const batterDot1 = document.getElementById('batterDot1');
    const batterDot2 = document.getElementById('batterDot2');
    const batterDot3 = document.getElementById('batterDot3');
    const batterDot4 = document.getElementById('batterDot4');
    const bowlerDot1 = document.getElementById('bowlerDot1');
    const bowlerDot2 = document.getElementById('bowlerDot2');
    const bowlerDot3 = document.getElementById('bowlerDot3');
    const bowlerDot4 = document.getElementById('bowlerDot4');

    // Modals
    const playerSelectionModal = document.getElementById('playerSelectionModal');
    const selectionModalTitle = document.getElementById('selectionModalTitle');
    const playerSelectionList = document.getElementById('playerSelectionList');
    const confirmSelectionBtn = document.getElementById('confirmSelectionBtn');
    const cancelSelectionBtn = document.getElementById('cancelSelectionBtn');
    const teamsModal = document.getElementById('teamsModal');
    const battingTeamModalTitle = document.getElementById('battingTeamModalTitle');
    const bowlingTeamModalTitle = document.getElementById('bowlingTeamModalTitle');
    const battingTeamPlayers = document.getElementById('battingTeamPlayers');
    const bowlingTeamPlayers = document.getElementById('bowlingTeamPlayers');
    const closeTeamsBtn = document.getElementById('closeTeamsBtn');
    const inningsSummaryModal = document.getElementById('inningsSummaryModal');
    const inningsSummaryTitle = document.getElementById('inningsSummaryTitle');
    const summaryTotalRuns = document.getElementById('summaryTotalRuns');
    const summaryWickets = document.getElementById('summaryWickets');
    const summaryOvers = document.getElementById('summaryOvers');
    const summaryRunRate = document.getElementById('summaryRunRate');
    const inningsBatters = document.getElementById('inningsBatters');
    const inningsBowlers = document.getElementById('inningsBowlers');
    const continueToSecondInningsBtn = document.getElementById('continueToSecondInningsBtn');

    // Game state
    let gameData = {
      battingTeam: '',
      bowlingTeam: '',
      battingPlayers: [],
      bowlingPlayers: [],
      currentBatsmen: [],
      currentBowler: null,
      score: 0,
      wickets: 0,
      overs: 0,
      balls: 0,
      innings: 1,
      format: 't20',
      powerplayOvers: [],
      isPowerplay: false,
      deadOvers: [],
      isDeadOver: false,
      isFreeHit: false,
      batterDots: 0,
      bowlerDots: 0,
      partnership: {
        runs: 0,
        balls: 0
      },
      matchData: {
        firstInnings: {},
        secondInnings: {}
      },
      playerStats: {},
      toss: {
        winner: '',
        battingFirst: '',
        battingChoice: ''
      }
    };

    let selectedCard = null;
    let selectedPlayer = null;
    let isBowlerSelection = false;
    let isBatsmanSelection = false;
    let lastAction = null;
    let isPlayerBattingTeam = false;
    let isPlayerBowlingTeam = false;

    // Initialize the game
    async function initGame() {
      try {
        const roomRef = ref(db, `rooms/${roomId}`);
        const roomSnap = await get(roomRef);
        
        if (!roomSnap.exists()) {
          alert('Room not found');
          window.location.href = 'index.html';
          return;
        }

        const roomData = roomSnap.val();
        
        // Set game format
        gameData.format = roomData.player1?.format || 't20';
        matchFormat.textContent = getFormatName(gameData.format);
        
        // Set toss info
        if (roomData.toss) {
          gameData.toss = roomData.toss;
          const winnerName = roomData.toss.winner === 'player1' ? 
            roomData.player1?.team || 'Team A' : 
            roomData.player2?.team || 'Team B';
          
          const battingFirstName = roomData.toss.battingFirst === 'player1' ? 
            roomData.player1?.team || 'Team A' : 
            roomData.player2?.team || 'Team B';
          
          tossResult.textContent = `${winnerName} won the toss and chose to ${roomData.toss.battingChoice}`;
          
          // Set batting and bowling teams
          gameData.battingTeam = roomData.toss.battingFirst === 'player1' ? 
            roomData.player1?.team || 'Team A' : 
            roomData.player2?.team || 'Team B';
            
          gameData.bowlingTeam = roomData.toss.battingFirst === 'player1' ? 
            roomData.player2?.team || 'Team B' : 
            roomData.player1?.team || 'Team A';
            
          battingTeamName.textContent = gameData.battingTeam;
          
          // Check if current player is in batting or bowling team
          isPlayerBattingTeam = (playerRole === 'player1' && roomData.toss.battingFirst === 'player1') || 
                               (playerRole === 'player2' && roomData.toss.battingFirst === 'player2');
                               
          isPlayerBowlingTeam = !isPlayerBattingTeam;
          
          // Set powerplay overs based on format
          setPowerplayOvers();
        }
        
        // Set teams data
        if (roomData.teams) {
          gameData.battingPlayers = roomData.toss.battingFirst === 'player1' ? 
            roomData.teams.player1?.players || [] : 
            roomData.teams.player2?.players || [];
            
          gameData.bowlingPlayers = roomData.toss.battingFirst === 'player1' ? 
            roomData.teams.player2?.players || [] : 
            roomData.teams.player1?.players || [];
            
          // Initialize player stats
          initPlayerStats();
        }
        
        // Load existing game data if available
        if (roomData.gameData) {
          loadGameData(roomData.gameData);
        } else {
          // Start new game
          startNewInnings();
        }
        
        // Set up realtime updates
        onValue(roomRef, (snap) => {
          if (snap.exists() && snap.val().gameData) {
            loadGameData(snap.val().gameData);
          }
        });
        
      } catch (error) {
        console.error('Error initializing game:', error);
        alert('Failed to initialize game. Please try again.');
      }
    }

    // Set powerplay overs based on format
    function setPowerplayOvers() {
      switch (gameData.format) {
        case '5': // T5
          gameData.powerplayOvers = [1, 2];
          break;
        case '10': // T10
          gameData.powerplayOvers = [1, 3];
          break;
        case '20': // T20
          gameData.powerplayOvers = Array.from({length: 6}, (_, i) => i + 1); // First 6 overs
          break;
        case '50': // ODI
          gameData.powerplayOvers = [
            ...Array.from({length: 10}, (_, i) => i + 1), // 1-10
            ...Array.from({length: 10}, (_, i) => i + 21), // 21-30
            41, 42 // 41-42
          ];
          break;
        default: // Test or others
          gameData.powerplayOvers = [];
      }
      
      // Check if current over is powerplay
      checkPowerplay();
    }

    // Check if current over is powerplay
    function checkPowerplay() {
      gameData.isPowerplay = gameData.powerplayOvers.includes(Math.floor(gameData.overs) + 1);
      updateSpecialIndicators();
    }

    // Check if current over is dead over (ODI only)
    function checkDeadOver() {
      if (gameData.format !== '50') {
        gameData.isDeadOver = false;
        return;
      }
      
      // In ODI, bowling team can choose 10 overs as dead overs
      gameData.isDeadOver = gameData.deadOvers.includes(Math.floor(gameData.overs) + 1);
      updateSpecialIndicators();
    }

    // Update special indicators (powerplay, dead over, free hit)
    function updateSpecialIndicators() {
      specialIndicator.innerHTML = '';
      
      if (gameData.isPowerplay) {
        const ppIndicator = document.createElement('span');
        ppIndicator.className = 'powerplay-indicator';
        ppIndicator.textContent = 'Powerplay';
        specialIndicator.appendChild(ppIndicator);
      }
      
      if (gameData.isDeadOver) {
        const deadIndicator = document.createElement('span');
        deadIndicator.className = 'dead-over-indicator';
        deadIndicator.textContent = 'Dead Over';
        specialIndicator.appendChild(deadIndicator);
      }
      
      if (gameData.isFreeHit) {
        const freeHitIndicator = document.createElement('span');
        freeHitIndicator.className = 'free-hit-indicator';
        freeHitIndicator.textContent = 'Free Hit';
        specialIndicator.appendChild(freeHitIndicator);
      }
    }

    // Get format name
    function getFormatName(format) {
      switch (format) {
        case '5': return 'T5 Match (5 Overs)';
        case '10': return 'T10 Match (10 Overs)';
        case '20': return 'T20 Match (20 Overs)';
        case '50': return 'ODI Match (50 Overs)';
        case 'test': return 'Test Match';
        default: return 'Match';
      }
    }

    // Initialize player stats
    function initPlayerStats() {
      // Initialize batting team stats
      gameData.battingPlayers.forEach(player => {
        if (!gameData.playerStats[player]) {
          gameData.playerStats[player] = {
            runs: 0,
            balls: 0,
            wickets: 0,
            fours: 0,
            sixes: 0,
            isOut: false,
            role: ''
          };
        }
      });
      
      // Initialize bowling team stats
      gameData.bowlingPlayers.forEach(player => {
        if (!gameData.playerStats[player]) {
          gameData.playerStats[player] = {
            overs: 0,
            balls: 0,
            wickets: 0,
            runs: 0,
            maidens: 0,
            isBowling: false
          };
        }
      });
    }

    // Load game data from Firebase
    function loadGameData(data) {
      gameData = {...gameData, ...data};
      
      // Update UI
      updateScoreboard();
      updatePartnership();
      updateDotCounters();
      updateSpecialIndicators();
      
      // Check if we need to select new batsman or bowler
      if (gameData.currentBatsmen.length < 2 && gameData.wickets < 10) {
        if (isPlayerBattingTeam) {
          selectNewBatsman();
        }
      }
      
      if (!gameData.currentBowler && isPlayerBowlingTeam) {
        selectBowler();
      }
      
      // Enable/disable controls based on player role
      if ((isPlayerBattingTeam && gameData.currentBatsmen.length === 2) || 
          (isPlayerBowlingTeam && gameData.currentBowler)) {
        enableGameControls();
      } else {
        disableGameControls();
      }
      
      // Show end innings button if all out or overs completed
      const maxOvers = getMaxOvers();
      if ((gameData.wickets >= 10 || gameData.overs >= maxOvers) && isPlayerBattingTeam) {
        endInningsBtn.style.display = 'inline-block';
      } else {
        endInningsBtn.style.display = 'none';
      }
    }

    // Start new innings
    function startNewInnings() {
      gameData.score = 0;
      gameData.wickets = 0;
      gameData.overs = 0;
      gameData.balls = 0;
      gameData.partnership = { runs: 0, balls: 0 };
      gameData.batterDots = 0;
      gameData.bowlerDots = 0;
      gameData.isFreeHit = false;
      
      // Reset player stats for this innings
      Object.keys(gameData.playerStats).forEach(player => {
        gameData.playerStats[player].runs = 0;
        gameData.playerStats[player].balls = 0;
        gameData.playerStats[player].wickets = 0;
        gameData.playerStats[player].fours = 0;
        gameData.playerStats[player].sixes = 0;
        gameData.playerStats[player].isOut = false;
        gameData.playerStats[player].overs = 0;
        gameData.playerStats[player].balls = 0;
        gameData.playerStats[player].wickets = 0;
        gameData.playerStats[player].runs = 0;
        gameData.playerStats[player].maidens = 0;
        gameData.playerStats[player].isBowling = false;
      });
      
      // Select initial batsmen
      if (isPlayerBattingTeam) {
        selectNewBatsman();
        selectNewBatsman();
      }
      
      // Select initial bowler
      if (isPlayerBowlingTeam) {
        selectBowler();
      }
      
      updateScoreboard();
      updateGameStatus();
      saveGameData();
    }

    // Select new batsman
    function selectNewBatsman() {
      isBatsmanSelection = true;
      selectionModalTitle.textContent = 'Select New Batsman';
      playerSelectionList.innerHTML = '';
      
      // Get available batsmen (not out and not already batting)
      const availableBatsmen = gameData.battingPlayers.filter(player => 
        !gameData.playerStats[player].isOut && 
        !gameData.currentBatsmen.includes(player)
      );
      
      if (availableBatsmen.length === 0) {
        alert('No available batsmen');
        return;
      }
      
      availableBatsmen.forEach(player => {
        const li = document.createElement('li');
        li.className = 'player-item';
        li.textContent = player;
        
        // Add captain/vice-captain indicators
        const teamData = gameData.toss.battingFirst === 'player1' ? 
          (roomData.teams?.player1 || {}) : 
          (roomData.teams?.player2 || {});
          
        if (teamData.captain === player) {
          li.classList.add('captain');
        } else if (teamData.viceCaptain === player) {
          li.classList.add('vice-captain');
        }
        
        li.addEventListener('click', () => {
          document.querySelectorAll('.player-item').forEach(item => {
            item.classList.remove('selected');
          });
          li.classList.add('selected');
          selectedPlayer = player;
          confirmSelectionBtn.disabled = false;
        });
        
        playerSelectionList.appendChild(li);
      });
      
      playerSelectionModal.classList.add('active');
    }

    // Select bowler
    function selectBowler() {
      isBowlerSelection = true;
      selectionModalTitle.textContent = 'Select Bowler';
      playerSelectionList.innerHTML = '';
      
      // Get available bowlers (not currently bowling and within over limit)
      const availableBowlers = gameData.bowlingPlayers.filter(player => {
        const stats = gameData.playerStats[player];
        const maxOvers = getMaxOversPerBowler();
        return stats.overs < maxOvers || maxOvers === 0;
      });
      
      if (availableBowlers.length === 0) {
        alert('No available bowlers');
        return;
      }
      
      availableBowlers.forEach(player => {
        const li = document.createElement('li');
        li.className = 'player-item';
        
        const stats = gameData.playerStats[player];
        const oversBowled = stats.overs + (stats.balls / 6).toFixed(1);
        const maxOvers = getMaxOversPerBowler();
        const oversLeft = maxOvers === 0 ? '∞' : (maxOvers - stats.overs).toFixed(1);
        
        li.innerHTML = `
          ${player} 
          <span style="float: right; font-size: 12px; color: #aaa;">
            ${oversBowled} / ${maxOvers === 0 ? '∞' : maxOvers} (${oversLeft} left)
          </span>
        `;
        
        // Add captain/vice-captain indicators
        const teamData = gameData.toss.battingFirst === 'player1' ? 
          (roomData.teams?.player2 || {}) : 
          (roomData.teams?.player1 || {});
          
        if (teamData.captain === player) {
          li.classList.add('captain');
        } else if (teamData.viceCaptain === player) {
          li.classList.add('vice-captain');
        }
        
        li.addEventListener('click', () => {
          document.querySelectorAll('.player-item').forEach(item => {
            item.classList.remove('selected');
          });
          li.classList.add('selected');
          selectedPlayer = player;
          confirmSelectionBtn.disabled = false;
        });
        
        playerSelectionList.appendChild(li);
      });
      
      playerSelectionModal.classList.add('active');
    }

    // Confirm player selection
    confirmSelectionBtn.addEventListener('click', () => {
      if (!selectedPlayer) return;
      
      if (isBatsmanSelection) {
        // Add new batsman
        gameData.currentBatsmen.push(selectedPlayer);
        addLogEntry(`${selectedPlayer} comes to bat`);
        
        if (gameData.currentBatsmen.length === 2) {
          isBatsmanSelection = false;
          enableGameControls();
        }
      }
      
      if (isBowlerSelection) {
        // Set new bowler
        if (gameData.currentBowler) {
          gameData.playerStats[gameData.currentBowler].isBowling = false;
          addLogEntry(`${gameData.currentBowler} finishes bowling`);
        }
        
        gameData.currentBowler = selectedPlayer;
        gameData.playerStats[selectedPlayer].isBowling = true;
        addLogEntry(`${selectedPlayer} comes to bowl`);
        
        isBowlerSelection = false;
        enableGameControls();
      }
      
      selectedPlayer = null;
      playerSelectionModal.classList.remove('active');
      updateScoreboard();
      updateGameStatus();
      saveGameData();
    });

    // Cancel selection
    cancelSelectionBtn.addEventListener('click', () => {
      isBatsmanSelection = false;
      isBowlerSelection = false;
      selectedPlayer = null;
      playerSelectionModal.classList.remove('active');
    });

    // Change bowler
    changeBowlerBtn.addEventListener('click', () => {
      if (isPlayerBowlingTeam) {
        selectBowler();
      }
    });

    // Card selection
    cardsContainer.querySelectorAll('.card').forEach(card => {
      card.addEventListener('click', function() {
        if (this.classList.contains('disabled')) return;
        
        cardsContainer.querySelectorAll('.card').forEach(c => {
          c.classList.remove('selected');
        });
        
        this.classList.add('selected');
        selectedCard = parseInt(this.dataset.value);
        submitBtn.disabled = false;
      });
    });

    // Submit card selection
    submitBtn.addEventListener('click', () => {
      if (selectedCard === null) return;
      
      // Determine batter and bowler cards
      let batterCard, bowlerCard;
      
      if (isPlayerBattingTeam) {
        batterCard = selectedCard;
        // For now, assume bowler card is random (in real game, this would come from opponent)
        bowlerCard = Math.floor(Math.random() * 7); // 0-6
      } else {
        bowlerCard = selectedCard;
        // For now, assume batter card is random
        batterCard = Math.floor(Math.random() * 7); // 0-6
      }
      
      // Process delivery
      processDelivery(batterCard, bowlerCard);
      
      // Reset selection
      selectedCard = null;
      cardsContainer.querySelectorAll('.card').forEach(c => {
        c.classList.remove('selected');
      });
      submitBtn.disabled = true;
    });

    // Process a delivery
    function processDelivery(batterCard, bowlerCard) {
      let runs = 0;
      let isWicket = false;
      let isNoBall = false;
      let isDotBall = false;
      let message = '';
      
      // Check for no-ball (both 0 and not test match)
      if (batterCard === 0 && bowlerCard === 0 && gameData.format !== 'test') {
        isNoBall = true;
        runs = 1; // No ball +1 run
        gameData.isFreeHit = true; // Next ball is free hit
        message = 'No ball! +1 run and free hit';
      }
      // Check for free hit
      else if (gameData.isFreeHit) {
        if (batterCard === bowlerCard) {
          // Wicket but doesn't count on free hit
          message = `Free hit! ${batterCard} = ${bowlerCard} but no wicket`;
        } else {
          runs = batterCard;
          message = `Free hit! Batter scores ${runs} runs`;
        }
        gameData.isFreeHit = false;
      }
      // Check for dead over rules (ODI only)
      else if (gameData.isDeadOver && gameData.format === '50') {
        if (batterCard === 0 && bowlerCard > 0) {
          isDotBall = true;
          message = 'Dead over: Dot ball';
        } else if (batterCard > 0 && bowlerCard === 0) {
          isDotBall = true;
          message = 'Dead over: Dot ball';
        } else if (batterCard > 0 && bowlerCard > 0) {
          if (batterCard === bowlerCard) {
            isWicket = true;
            message = `Wicket! ${batterCard} = ${bowlerCard}`;
          } else {
            runs = batterCard;
            message = `Batter scores ${runs} runs`;
          }
        }
      }
      // Normal delivery rules
      else {
        if (batterCard === 0 && bowlerCard > 0) {
          runs = bowlerCard;
          message = `Bowler scores ${runs} runs`;
        } else if (batterCard > 0 && bowlerCard === 0) {
          isDotBall = true;
          message = 'Dot ball';
        } else if (batterCard > 0 && bowlerCard > 0) {
          if (batterCard === bowlerCard) {
            isWicket = true;
            message = `Wicket! ${batterCard} = ${bowlerCard}`;
          } else {
            runs = batterCard;
            message = `Batter scores ${runs} runs`;
          }
        }
      }
      
      // Update dot counters
      if (batterCard === 0 && !isNoBall) {
        gameData.batterDots++;
        updateDotCounters();
      }
      
      if (bowlerCard === 0 && !isNoBall) {
        gameData.bowlerDots++;
        updateDotCounters();
      }
      
      // Check for 4th dot ball penalties
      if (gameData.batterDots >= 4 && !isNoBall) {
        runs -= 5; // -5 runs for 4th dot
        message += ' (4th dot ball: -5 runs)';
        gameData.batterDots = 0;
      }
      
      if (gameData.bowlerDots >= 4 && !isNoBall && gameData.format !== 'test') {
        isNoBall = true;
        runs += 1; // No ball +1 run
        gameData.isFreeHit = true; // Next ball is free hit
        message = '4th dot ball by bowler: No ball! +1 run and free hit';
        gameData.bowlerDots = 0;
      }
      
      // Update game state
      if (!isNoBall) {
        gameData.balls++;
        if (gameData.balls >= 6) {
          gameData.overs++;
          gameData.balls = 0;
          gameData.batterDots = 0;
          gameData.bowlerDots = 0;
          
          // Check if over is complete and we need to change powerplay/dead over status
          checkPowerplay();
          checkDeadOver();
        }
      }
      
      // Update score and wickets
      if (isWicket) {
        const wicketValue = getWicketValue();
        const batsmanIndex = Math.floor(Math.random() * 2); // Randomly select which batsman is out
        const batsman = gameData.currentBatsmen[batsmanIndex];
        
        gameData.playerStats[batsman].wickets += wicketValue;
        gameData.playerStats[batsman].balls++;
        
        // Check if batsman is fully out (wickets >= 1.0)
        if (gameData.playerStats[batsman].wickets >= 1.0) {
          gameData.playerStats[batsman].isOut = true;
          gameData.wickets++;
          gameData.currentBatsmen.splice(batsmanIndex, 1);
          gameData.partnership = { runs: 0, balls: 0 };
          
          // Update bowler stats
          gameData.playerStats[gameData.currentBowler].wickets++;
          
          message += ` - ${batsman} is out!`;
          
          // Select new batsman if not all out
          if (gameData.wickets < 10 && isPlayerBattingTeam) {
            selectNewBatsman();
          }
        } else {
          message += ` - ${batsman} loses ${wicketValue.toFixed(2)} of a wicket`;
        }
      } else {
        // Update batsman and bowler stats
        const batsmanIndex = Math.floor(Math.random() * 2); // Randomly select which batsman scores
        const batsman = gameData.currentBatsmen[batsmanIndex];
        
        gameData.score += runs;
        gameData.playerStats[batsman].runs += runs;
        gameData.playerStats[batsman].balls++;
        gameData.playerStats[gameData.currentBowler].runs += runs;
        
        if (runs === 4) gameData.playerStats[batsman].fours++;
        if (runs === 6) gameData.playerStats[batsman].sixes++;
        
        // Update partnership
        gameData.partnership.runs += runs;
        gameData.partnership.balls++;
      }
      
      // Add log entry
      addLogEntry(message, isWicket ? 'wicket' : (runs > 0 ? 'boundary' : ''));
      
      // Update UI
      updateScoreboard();
      updatePartnership();
      updateDotCounters();
      
      // Check if innings is complete
      const maxOvers = getMaxOvers();
      if (gameData.wickets >= 10 || gameData.overs >= maxOvers) {
        endInnings();
      }
      
      // Save game data
      saveGameData();
    }

    // Get wicket value based on format and powerplay
    function getWicketValue() {
      if (gameData.format === 'test') return 0.33; // 1/3 for test matches
      
      if (gameData.isPowerplay) {
        switch (gameData.format) {
          case '50': return 0.25; // 1/4 for ODI powerplay
          default: return 0.5; // 1/2 for T20, T10, T5 powerplay
        }
      } else {
        switch (gameData.format) {
          case '50': return 0.5; // 1/2 for ODI non-powerplay
          default: return 1.0; // Full wicket for others
        }
      }
    }

    // Get max overs based on format
    function getMaxOvers() {
      switch (gameData.format) {
        case '5': return 5;
        case '10': return 10;
        case '20': return 20;
        case '50': return 50;
        case 'test': return 0; // Unlimited for test
        default: return 20; // Default to T20
      }
    }

    // Get max overs per bowler based on format
    function getMaxOversPerBowler() {
      switch (gameData.format) {
        case '5': return 1;
        case '10': return 2;
        case '20': return 4;
        case '50': return 10;
        case 'test': return 0; // Unlimited for test
        default: return 4; // Default to T20
      }
    }

    // Update scoreboard
    function updateScoreboard() {
      teamScore.textContent = `${gameData.score}/${gameData.wickets}`;
      oversCount.textContent = `${Math.floor(gameData.overs)}.${gameData.balls}`;
      
      // Update batsmen
      if (gameData.currentBatsmen.length > 0) {
        const batsman1 = gameData.currentBatsmen[0];
        batsman1Name.textContent = batsman1;
        batsman1Runs.textContent = gameData.playerStats[batsman1]?.runs || 0;
        batsman1Balls.textContent = gameData.playerStats[batsman1]?.balls || 0;
        const wickets1 = (gameData.playerStats[batsman1]?.wickets || 0) * 100;
        batsman1Wickets.style.width = `${wickets1}%`;
        
        if (gameData.playerStats[batsman1]?.isOut) {
          batsman1Status.textContent = 'OUT';
          batsman1Status.style.color = '#f44336';
        } else {
          batsman1Status.textContent = gameData.currentBowler === batsman1 ? '*' : '';
          batsman1Status.style.color = '#4CAF50';
        }
      } else {
        batsman1Name.textContent = '-';
        batsman1Runs.textContent = '0';
        batsman1Balls.textContent = '0';
        batsman1Wickets.style.width = '0%';
        batsman1Status.textContent = '';
      }
      
      if (gameData.currentBatsmen.length > 1) {
        const batsman2 = gameData.currentBatsmen[1];
        batsman2Name.textContent = batsman2;
        batsman2Runs.textContent = gameData.playerStats[batsman2]?.runs || 0;
        batsman2Balls.textContent = gameData.playerStats[batsman2]?.balls || 0;
        const wickets2 = (gameData.playerStats[batsman2]?.wickets || 0) * 100;
        batsman2Wickets.style.width = `${wickets2}%`;
        
        if (gameData.playerStats[batsman2]?.isOut) {
          batsman2Status.textContent = 'OUT';
          batsman2Status.style.color = '#f44336';
        } else {
          batsman2Status.textContent = gameData.currentBowler === batsman2 ? '*' : '';
          batsman2Status.style.color = '#4CAF50';
        }
      } else {
        batsman2Name.textContent = '-';
        batsman2Runs.textContent = '0';
        batsman2Balls.textContent = '0';
        batsman2Wickets.style.width = '0%';
        batsman2Status.textContent = '';
      }
      
      // Update bowler
      if (gameData.currentBowler) {
        bowlerName.textContent = `Bowler: ${gameData.currentBowler}`;
        const overs = Math.floor(gameData.playerStats[gameData.currentBowler]?.overs || 0);
        const balls = (gameData.playerStats[gameData.currentBowler]?.balls || 0) % 6;
        bowlerOvers.textContent = `Overs: ${overs}.${balls}`;
        bowlerWickets.textContent = `Wickets: ${gameData.playerStats[gameData.currentBowler]?.wickets || 0}`;
        bowlerRuns.textContent = `Runs: ${gameData.playerStats[gameData.currentBowler]?.runs || 0}`;
      } else {
        bowlerName.textContent = 'Bowler: -';
        bowlerOvers.textContent = 'Overs: 0';
        bowlerWickets.textContent = 'Wickets: 0';
        bowlerRuns.textContent = 'Runs: 0';
      }
    }

    // Update partnership
    function updatePartnership() {
      partnershipRuns.textContent = gameData.partnership.runs;
      partnershipBalls.textContent = gameData.partnership.balls;
      
      const rr = gameData.partnership.balls > 0 ? 
        (gameData.partnership.runs / gameData.partnership.balls * 6).toFixed(2) : 
        '0.00';
      partnershipRR.textContent = rr;
    }

    // Update dot counters
    function updateDotCounters() {
      // Update batter dots
      batterDot1.classList.toggle('filled', gameData.batterDots >= 1);
      batterDot2.classList.toggle('filled', gameData.batterDots >= 2);
      batterDot3.classList.toggle('filled', gameData.batterDots >= 3);
      batterDot4.classList.toggle('filled', gameData.batterDots >= 4);
      
      // Update bowler dots
      bowlerDot1.classList.toggle('filled', gameData.bowlerDots >= 1);
      bowlerDot2.classList.toggle('filled', gameData.bowlerDots >= 2);
      bowlerDot3.classList.toggle('filled', gameData.bowlerDots >= 3);
      bowlerDot4.classList.toggle('filled', gameData.bowlerDots >= 4);
    }

    // Add log entry
    function addLogEntry(message, type = '') {
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.textContent = `${Math.floor(gameData.overs)}.${gameData.balls} - ${message}`;
      gameLog.appendChild(entry);
      gameLog.scrollTop = gameLog.scrollHeight;
    }

    // Update game status
    function updateGameStatus() {
      if (gameData.currentBatsmen.length < 2 && gameData.wickets < 10) {
        gameStatus.textContent = 'Waiting for batsman selection...';
      } else if (!gameData.currentBowler) {
        gameStatus.textContent = 'Waiting for bowler selection...';
      } else {
        gameStatus.textContent = 'Game in progress';
      }
    }

    // Enable game controls
    function enableGameControls() {
      cardsContainer.querySelectorAll('.card').forEach(card => {
        card.classList.remove('disabled');
      });
      submitBtn.disabled = true;
      undoBtn.disabled = false;
    }

    // Disable game controls
    function disableGameControls() {
      cardsContainer.querySelectorAll('.card').forEach(card => {
        card.classList.add('disabled');
      });
      submitBtn.disabled = true;
      undoBtn.disabled = true;
    }

    // End innings
    function endInnings() {
      // Save innings data
      gameData.matchData.firstInnings = {
        team: gameData.battingTeam,
        score: gameData.score,
        wickets: gameData.wickets,
        overs: gameData.overs + (gameData.balls / 6),
        playerStats: gameData.playerStats
      };
      
      // Show innings summary
      showInningsSummary();
      
      // Save game data
      saveGameData();
    }

    // Show innings summary
    function showInningsSummary() {
      inningsSummaryTitle.textContent = `${gameData.battingTeam} Innings Summary`;
      summaryTotalRuns.textContent = gameData.score;
      summaryWickets.textContent = gameData.wickets;
      summaryOvers.textContent = `${Math.floor(gameData.overs)}.${gameData.balls}`;
      
      const totalBalls = Math.floor(gameData.overs) * 6 + gameData.balls;
      const runRate = totalBalls > 0 ? (gameData.score / totalBalls * 6).toFixed(2) : '0.00';
      summaryRunRate.textContent = runRate;
      
      // Show batting performances
      inningsBatters.innerHTML = '';
      gameData.battingPlayers.forEach(player => {
        const stats = gameData.playerStats[player];
        const row = document.createElement('tr');
        
        if (stats.isOut) {
          row.classList.add('highlight');
        }
        
        const sr = stats.balls > 0 ? (stats.runs / stats.balls * 100).toFixed(2) : '0.00';
        
        row.innerHTML = `
          <td>${player} ${stats.isOut ? '(OUT)' : ''}</td>
          <td>${stats.runs}</td>
          <td>${stats.balls}</td>
          <td>${sr}</td>
        `;
        inningsBatters.appendChild(row);
      });
      
      // Show bowling performances
      inningsBowlers.innerHTML = '';
      gameData.bowlingPlayers.forEach(player => {
        const stats = gameData.playerStats[player];
        const overs = Math.floor(stats.overs) + (stats.balls / 6).toFixed(1);
        const economy = stats.overs > 0 ? (stats.runs / stats.overs).toFixed(2) : '0.00';
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${player}</td>
          <td>${overs}</td>
          <td>${stats.wickets}</td>
          <td>${economy}</td>
        `;
        inningsBowlers.appendChild(row);
      });
      
      inningsSummaryModal.classList.add('active');
    }

    // Continue to second innings
    continueToSecondInningsBtn.addEventListener('click', () => {
      // Prepare for second innings
      gameData.innings = 2;
      gameData.battingTeam = gameData.bowlingTeam;
      gameData.bowlingTeam = gameData.matchData.firstInnings.team;
      isPlayerBattingTeam = !isPlayerBattingTeam;
      isPlayerBowlingTeam = !isPlayerBowlingTeam;
      
      // Swap teams
      const temp = gameData.battingPlayers;
      gameData.battingPlayers = gameData.bowlingPlayers;
      gameData.bowlingPlayers = temp;
      
      // Start second innings
      startNewInnings();
      
      // Update UI
      inningsTitle.textContent = 'Second Innings';
      battingTeamName.textContent = gameData.battingTeam;
      
      inningsSummaryModal.classList.remove('active');
    });

    // Show teams
    showTeamsBtn.addEventListener('click', () => {
      battingTeamModalTitle.textContent = `${gameData.battingTeam} (Batting)`;
      bowlingTeamModalTitle.textContent = `${gameData.bowlingTeam} (Bowling)`;
      
      // Show batting team
      battingTeamPlayers.innerHTML = '';
      gameData.battingPlayers.forEach(player => {
        const stats = gameData.playerStats[player];
        const row = document.createElement('tr');
        
        // Add captain/vice-captain indicators
        let role = '';
        const teamData = gameData.toss.battingFirst === 'player1' ? 
          (roomData.teams?.player1 || {}) : 
          (roomData.teams?.player2 || {});
          
        if (teamData.captain === player) {
          role = 'Captain';
        } else if (teamData.viceCaptain === player) {
          role = 'Vice Captain';
        }
        
        const sr = stats.balls > 0 ? (stats.runs / stats.balls * 100).toFixed(2) : '0.00';
        
        row.innerHTML = `
          <td>${player} ${stats.isOut ? '(OUT)' : ''}</td>
          <td>${role}</td>
          <td>${stats.runs}</td>
          <td>${stats.balls}</td>
          <td>${stats.wickets.toFixed(2)}</td>
        `;
        battingTeamPlayers.appendChild(row);
      });
      
      // Show bowling team
      bowlingTeamPlayers.innerHTML = '';
      gameData.bowlingPlayers.forEach(player => {
        const stats = gameData.playerStats[player];
        const overs = Math.floor(stats.overs) + (stats.balls / 6).toFixed(1);
        
        // Add captain/vice-captain indicators
        let role = '';
        const teamData = gameData.toss.battingFirst === 'player1' ? 
          (roomData.teams?.player2 || {}) : 
          (roomData.teams?.player1 || {});
          
        if (teamData.captain === player) {
          role = 'Captain';
        } else if (teamData.viceCaptain === player) {
          role = 'Vice Captain';
        }
        
        row.innerHTML = `
          <td>${player}</td>
          <td>${role}</td>
          <td>${overs}</td>
          <td>${stats.wickets}</td>
          <td>${stats.runs}</td>
        `;
        bowlingTeamPlayers.appendChild(row);
      });
      
      teamsModal.classList.add('active');
    });

    // Close teams modal
    closeTeamsBtn.addEventListener('click', () => {
      teamsModal.classList.remove('active');
    });

    // Save game data to Firebase
    function saveGameData() {
      const roomRef = ref(db, `rooms/${roomId}`);
      update(roomRef, {
        gameData: gameData
      }).catch(error => {
        console.error('Error saving game data:', error);
      });
    }

    // Initialize the game when page loads
    window.addEventListener('load', initGame);
  </script>
</body>
</html>