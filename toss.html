<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HandiCricket - Toss</title>

  <style>
    body {
      background: linear-gradient(135deg, #061e3e, #0a2a4a);
      color: white;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      text-align: center;
      padding: 20px;
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .container {
      max-width: 650px;
      margin: 0 auto;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    h1 {
      color: #ffeb3b;
      text-shadow: 0 0 10px rgba(255, 235, 59, 0.5);
      margin-bottom: 25px;
    }

    .info-box {
      background: rgba(13, 42, 82, 0.5);
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      text-align: left;
    }

    .room-code {
      font-weight: bold;
      color: #ffeb3b;
      font-size: 18px;
    }

    .team-info {
      display: flex;
      justify-content: space-between;
      margin-bottom: 30px;
      background: rgba(13, 42, 82, 0.5);
      padding: 15px;
      border-radius: 10px;
      border-left: 4px solid #1e88e5;
    }

    .team {
      flex: 1;
      padding: 10px;
    }

    .team-name {
      font-weight: bold;
      font-size: 18px;
      margin-bottom: 5px;
    }

    .team-role {
      color: #aaa;
      font-size: 14px;
    }

    .vs {
      display: flex;
      align-items: center;
      padding: 0 15px;
      font-weight: bold;
      color: #ffeb3b;
    }

    .coin {
      width: 130px;
      height: 130px;
      background: linear-gradient(145deg, #ffd700, #daa520);
      border-radius: 50%;
      margin: 0 auto 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 45px;
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
      position: relative;
      transform-style: preserve-3d;
    }

    .coin.flipping {
      animation: flip 1s linear 5;
    }

    .coin .heads,
    .coin .tails {
      position: absolute;
      backface-visibility: hidden;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      font-size: 40px;
    }

    .coin .tails {
      transform: rotateY(180deg);
    }

    @keyframes flip {
      0% {
        transform: rotateY(0deg);
      }
      100% {
        transform: rotateY(360deg);
      }
    }

    /* Buttons */
    .toss-btn,
    .batting-btn,
    .continue-btn {
      padding: 12px 25px;
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    }

    .toss-btn:hover,
    .batting-btn:hover,
    .continue-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 10px rgba(0, 0, 0, 0.3);
    }

    .toss-btn.heads {
      background: linear-gradient(145deg, #4caf50, #2e7d32);
    }

    .toss-btn.tails {
      background: linear-gradient(145deg, #9c27b0, #7b1fa2);
    }

    .toss-btn {
      background: linear-gradient(145deg, #1e88e5, #1565c0);
    }

    .batting-btn {
      background: linear-gradient(145deg, #ff9800, #f57c00);
    }

    .batting-btn.bowl {
      background: linear-gradient(145deg, #2196f3, #1565c0);
    }

    .continue-btn {
      background: linear-gradient(145deg, #4caf50, #2e7d32);
      width: 100%;
      margin-top: 20px;
      display: none;
    }

    .toss-result,
    #tossOutcome {
      min-height: 100px;
      padding: 20px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      margin: 20px 0;
      font-size: 18px;
      line-height: 1.5;
    }

    .toss-options {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 30px;
    }

    .batting-options {
      display: none;
      justify-content: center;
      gap: 15px;
      margin-top: 20px;
    }

    .waiting {
      display: none;
      padding: 15px;
      background: rgba(255, 235, 59, 0.2);
      border-radius: 10px;
      margin-top: 20px;
    }

    .loading-spinner {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top: 3px solid #1e88e5;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 10px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

  </style>
</head>
<body>

  <div class="container">
    <h1>üèè Match Toss</h1>

    <div class="info-box">
      <div>Room Code: <span class="room-code" id="roomCode"></span></div>
      <div>Match Format: <span id="formatInfo"></span></div>
      <div>You are: <span id="playerInfo"></span></div>
    </div>

    <div class="team-info">
      <div class="team">
        <div class="team-name" id="team1Name">Loading...</div>
        <div class="team-role" id="team1Role"></div>
      </div>
      <div class="vs">VS</div>
      <div class="team">
        <div class="team-name" id="team2Name">Loading...</div>
        <div class="team-role" id="team2Role"></div>
      </div>
    </div>

    <div class="coin" id="coin">
      <div class="heads">H</div>
      <div class="tails">T</div>
    </div>

    <div id="callSection" style="display: none;">
      <h3>Call Heads or Tails</h3>
      <div class="toss-options">
        <button class="toss-btn heads" id="headsBtn">Heads</button>
        <button class="toss-btn tails" id="tailsBtn">Tails</button>
      </div>
    </div>

    <div id="flipSection" style="display: none;">
      <h3>Flip the Coin</h3>
      <button class="toss-btn" id="flipBtn">Flip Coin</button>
    </div>

    <div class="toss-result" id="tossResult">
      Initializing toss process...
    </div>

    <div class="batting-options" id="battingOptions">
      <h3>You won the toss!</h3>
      <button class="batting-btn" id="batBtn">Bat First</button>
      <button class="batting-btn bowl" id="bowlBtn">Bowl First</button>
    </div>

    <div class="waiting" id="waiting">
      <div class="loading-spinner"></div>
      <p id="waitingText">Waiting for opponent...</p>
    </div>

    <div class="toss-result" id="tossOutcome" style="display: none;"></div>

    <button class="continue-btn" id="continueBtn">Continue to Playing XI</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, get } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

    /* üî• YOUR FIREBASE CONFIG (use SAME as your index.html for multiplayer) */
    const firebaseConfig = {
      apiKey: "AIzaSyD8kSmj_HRdxfKZhYUYq_H0A1r2C5VN5cA",
      authDomain: "handicricket-392da.firebaseapp.com",
      databaseURL: "https://handicricket-392da-default-rtdb.firebaseio.com",
      projectId: "handicricket-392da",
      storageBucket: "handicricket-392da.firebasestorage.app",
      messagingSenderId: "398034348468",
      appId: "1:398034348468:web:d1a61a4d5b586a4dd22ae1",
      measurementId: "G-8NNMWYZ6NB"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    /* URL PARAMETERS */
    const params = new URLSearchParams(location.search);
    const room = params.get("room");
    const player = params.get("player");
    const teamName = decodeURIComponent(params.get("team"));
    const format = params.get("format");

    const opponent = player === "player1" ? "player2" : "player1";

    /* DOM */
    const roomCodeEl = document.getElementById("roomCode");
    const formatInfoEl = document.getElementById("formatInfo");
    const playerInfoEl = document.getElementById("playerInfo");

    const team1NameEl = document.getElementById("team1Name");
    const team2NameEl = document.getElementById("team2Name");
    const team1RoleEl = document.getElementById("team1Role");
    const team2RoleEl = document.getElementById("team2Role");

    const coin = document.getElementById("coin");
    const tossResult = document.getElementById("tossResult");
    const tossOutcome = document.getElementById("tossOutcome");

    const callSection = document.getElementById("callSection");
    const flipSection = document.getElementById("flipSection");
    const battingOptions = document.getElementById("battingOptions");
    const waiting = document.getElementById("waiting");
    const waitingText = document.getElementById("waitingText");

    const continueBtn = document.getElementById("continueBtn");

    /* Firebase Refs */
    const roomRef = ref(db, `rooms/${room}`);
    const tossRef = ref(db, `rooms/${room}/toss`);
    const player1Ref = ref(db, `rooms/${room}/player1`);
    const player2Ref = ref(db, `rooms/${room}/player2`);

    /* Format names */
    const formatNames = {
      "5": "T5 (5 Overs)",
      "10": "T10 (10 Overs)",
      "20": "T20 (20 Overs)",
      "50": "ODI (50 Overs)",
    };

    /* Variables to store team names */
    let player1Team = "Team A";
    let player2Team = "Team B";

    /* INIT UI */
    roomCodeEl.textContent = room;
    formatInfoEl.textContent = formatNames[format] || format;
    playerInfoEl.textContent = player.toUpperCase();

    /* SET PLAYER CONNECTED */
    update(ref(db, `rooms/${room}/${player}`), {
      connected: true,
      team: teamName,
    });

    /* UPDATE TEAM NAMES FROM FIREBASE */
    function updateTeamNames() {
      // Get player1 data
      get(player1Ref).then((snap) => {
        if (snap.exists()) {
          player1Team = snap.val().team || "Team A";
          updateUI();
        }
      });

      // Get player2 data
      get(player2Ref).then((snap) => {
        if (snap.exists()) {
          player2Team = snap.val().team || "Team B";
          updateUI();
        }
      });
    }

    /* UPDATE UI WITH TEAM NAMES */
    function updateUI() {
      team1NameEl.textContent = player1Team;
      team2NameEl.textContent = player2Team;

      if (player === "player1") {
        team1RoleEl.textContent = "(You)";
        team2RoleEl.textContent = "(Opponent)";
      } else {
        team1RoleEl.textContent = "(Opponent)";
        team2RoleEl.textContent = "(You)";
      }
    }

    /* OPPONENT CONNECT */
    onValue(ref(db, `rooms/${room}/${opponent}`), (snap) => {
      if (snap.exists() && snap.val().connected) {
        // Update opponent team name when they connect
        if (opponent === "player1") {
          player1Team = snap.val().team || "Team A";
        } else {
          player2Team = snap.val().team || "Team B";
        }
        updateUI();

        waitingText.textContent = "Opponent connected!";
        setTimeout(() => {
          waiting.style.display = "none";
          startTossLogic();
        }, 800);
      } else {
        waiting.style.display = "block";
        waitingText.textContent = "Waiting for opponent...";
      }
    });

    /* INITIAL TEAM NAME SETUP */
    updateTeamNames();

    /* MAIN TOSS FLOW */
    function startTossLogic() {
      onValue(tossRef, (snap) => {
        const t = snap.val() || {};

        if (player === "player1" && !t.caller) {
          tossResult.textContent = "Call Heads or Tails";
          callSection.style.display = "block";
          flipSection.style.display = "none";
        }
        else if (player === "player2" && t.caller && !t.flipper) {
          tossResult.textContent = "Opponent called. Please flip the coin.";
          callSection.style.display = "none";
          flipSection.style.display = "block";
        }
        else if (t.result) {
          showFinalToss(t);
        }
      });
    }

    /* Player1 makes call */
    document.getElementById("headsBtn").onclick = () => makeCall("heads");
    document.getElementById("tailsBtn").onclick = () => makeCall("tails");

    function makeCall(choice) {
      callSection.style.display = "none";
      waiting.style.display = "block";
      waitingText.textContent = "Waiting for opponent to flip...";

      update(tossRef, {
        caller: player,
        call: choice,
      });
    }

    /* Player2 flips coin */
    document.getElementById("flipBtn").onclick = flipCoin;

    function flipCoin() {
      flipSection.style.display = "none";
      waiting.style.display = "block";
      waitingText.textContent = "Flipping...";

      coin.classList.add("flipping");

      setTimeout(() => {
        coin.classList.remove("flipping");

        const result = Math.random() < 0.5 ? "heads" : "tails";

        get(tossRef).then((snap) => {
          const call = snap.val().call;
          const winner = call === result ? "player1" : "player2";

          coin.style.transform =
            result === "heads" ? "rotateY(0deg)" : "rotateY(180deg)";

          update(tossRef, {
            flipper: player,
            result,
            winner,
          });
        });
      }, 5000);
    }

    /* DISPLAY RESULT */
    function showFinalToss(t) {
      waiting.style.display = "none";
      callSection.style.display = "none";
      flipSection.style.display = "none";

      if (t.result === "heads") coin.style.transform = "rotateY(0deg)";
      else coin.style.transform = "rotateY(180deg)";

      if (player === t.winner) {
        tossResult.innerHTML = `<b>You won the toss!</b>`;
        battingOptions.style.display = "flex";
      } else {
        tossResult.innerHTML = `<b>Opponent won the toss.</b><br> Waiting for their decision...`;
        waiting.style.display = "block";
      }

      if (t.battingFirst) {
        showBattingOutcome(t);
      }
    }

    /* Winner chooses batting */
    document.getElementById("batBtn").onclick = () => chooseBatBowl("bat");
    document.getElementById("bowlBtn").onclick = () => chooseBatBowl("bowl");

    function chooseBatBowl(choice) {
      const battingFirst =
        choice === "bat" ? player : opponent;

      update(tossRef, {
        battingChoice: choice,
        battingFirst,
      });
    }

    /* Show final outcome */
    function showBattingOutcome(t) {
      waiting.style.display = "none";
      battingOptions.style.display = "none";

      const battingTeamName = t.battingFirst === "player1" ? player1Team : player2Team;
      const bowlingTeamName = t.battingFirst === "player1" ? player2Team : player1Team;

      tossOutcome.style.display = "block";
      tossOutcome.innerHTML = `
        <b>${battingTeamName}</b> will <b>bat</b> first.<br>
        <b>${bowlingTeamName}</b> will <b>bowl</b> first.
      `;

      continueBtn.style.display = "block";
    }

    /* CONTINUE TO playing11.html */
    continueBtn.onclick = () => {
      const nextURL = `playing11.html?room=${room}&player=${player}&team=${encodeURIComponent(
        teamName
      )}&format=${format}`;
      location.href = nextURL;
    };
  </script>
</body>
</html>