<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Match History - HandiCricket</title>
  <meta name="description" content="View your HandiCricket match history and statistics">
  
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/responsive.css">
  <link rel="stylesheet" href="css/animations.css">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/svg+xml" href="https://cdn.jsdelivr.net/npm/feather-icons@4.28.0/icons/target.svg">
</head>
<body>
  <div id="loading-overlay" class="loading-overlay">
    <div class="loading-spinner"></div>
    <p>Loading match history...</p>
  </div>

  <div id="error-modal" class="error-modal" style="display: none;">
    <div class="error-content">
      <h3>Error</h3>
      <p id="error-message"></p>
      <button id="retry-btn" class="btn btn-primary">Try Again</button>
    </div>
  </div>

  <header class="header">
    <div class="container">
      <h1 class="logo">
        <span class="cricket-icon">üèè</span>
        HandiCricket History
      </h1>
      <nav class="nav">
        <a href="index.html" class="nav-link">üè† Home</a>
        <a href="#statistics" class="nav-link">üìä Stats</a>
        <a href="#achievements" class="nav-link">üèÜ Achievements</a>
      </nav>
    </div>
  </header>

  <main class="main history-container">
    <!-- Player Statistics Overview -->
    <section class="stats-overview">
      <h2 class="section-title">Your Cricket Statistics</h2>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">üéØ</div>
          <div class="stat-content">
            <h3 id="totalMatches" class="stat-value">0</h3>
            <p class="stat-label">Total Matches</p>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon">üèÜ</div>
          <div class="stat-content">
            <h3 id="matchesWon" class="stat-value">0</h3>
            <p class="stat-label">Matches Won</p>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon">üìà</div>
          <div class="stat-content">
            <h3 id="winPercentage" class="stat-value">0%</h3>
            <p class="stat-label">Win Percentage</p>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon">üé™</div>
          <div class="stat-content">
            <h3 id="highestScore" class="stat-value">0</h3>
            <p class="stat-label">Highest Score</p>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon">üéØ</div>
          <div class="stat-content">
            <h3 id="averageScore" class="stat-value">0.00</h3>
            <p class="stat-label">Average Score</p>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon">‚öæ</div>
          <div class="stat-content">
            <h3 id="totalWickets" class="stat-value">0</h3>
            <p class="stat-label">Total Wickets</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Format-wise Statistics -->
    <section class="format-stats">
      <h2 class="section-title">Performance by Format</h2>
      <div class="format-tabs">
        <button class="format-tab active" data-format="all">All Formats</button>
        <button class="format-tab" data-format="5">5 Overs</button>
        <button class="format-tab" data-format="10">10 Overs</button>
        <button class="format-tab" data-format="20">T20</button>
        <button class="format-tab" data-format="50">ODI</button>
        <button class="format-tab" data-format="test">Test</button>
      </div>
      
      <div class="format-stats-content">
        <div class="performance-chart">
          <canvas id="performanceChart" width="400" height="200"></canvas>
        </div>
        
        <div class="format-details">
          <div class="detail-grid">
            <div class="detail-item">
              <span class="detail-label">Matches Played:</span>
              <span id="formatMatches" class="detail-value">0</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Win Rate:</span>
              <span id="formatWinRate" class="detail-value">0%</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Average Score:</span>
              <span id="formatAvgScore" class="detail-value">0.00</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Best Performance:</span>
              <span id="formatBestScore" class="detail-value">0</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Match History Filters -->
    <section class="history-filters">
      <h2 class="section-title">Match History</h2>
      <div class="filter-controls">
        <div class="filter-group">
          <label for="formatFilter">Format:</label>
          <select id="formatFilter" class="filter-select">
            <option value="all">All Formats</option>
            <option value="5">5 Overs</option>
            <option value="10">10 Overs</option>
            <option value="20">T20</option>
            <option value="50">ODI</option>
            <option value="test">Test Match</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label for="resultFilter">Result:</label>
          <select id="resultFilter" class="filter-select">
            <option value="all">All Results</option>
            <option value="won">Won</option>
            <option value="lost">Lost</option>
            <option value="draw">Draw</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label for="opponentFilter">Opponent:</label>
          <select id="opponentFilter" class="filter-select">
            <option value="all">All Opponents</option>
            <option value="human">Human Players</option>
            <option value="ai">AI Opponents</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label for="dateFilter">Date Range:</label>
          <select id="dateFilter" class="filter-select">
            <option value="all">All Time</option>
            <option value="today">Today</option>
            <option value="week">This Week</option>
            <option value="month">This Month</option>
            <option value="year">This Year</option>
          </select>
        </div>
        
        <button id="clearFilters" class="btn btn-secondary">Clear Filters</button>
      </div>
    </section>

    <!-- Match History List -->
    <section class="match-history">
      <div class="history-actions">
        <div class="search-box">
          <input type="text" id="searchInput" placeholder="Search matches..." class="search-input">
          <button id="searchBtn" class="btn btn-secondary">üîç</button>
        </div>
        <div class="sort-controls">
          <label for="sortBy">Sort by:</label>
          <select id="sortBy" class="sort-select">
            <option value="date">Date (Newest First)</option>
            <option value="date-asc">Date (Oldest First)</option>
            <option value="score">Score (Highest First)</option>
            <option value="score-asc">Score (Lowest First)</option>
            <option value="format">Format</option>
          </select>
        </div>
      </div>
      
      <div id="matchesList" class="matches-list">
        <div class="no-matches">
          <div class="no-matches-icon">üèè</div>
          <h3>No matches found</h3>
          <p>Start playing to build your match history!</p>
          <a href="index.html" class="btn btn-primary">Play Now</a>
        </div>
      </div>
      
      <div class="pagination">
        <button id="prevPage" class="btn btn-secondary" disabled>‚Üê Previous</button>
        <span id="pageInfo" class="page-info">Page 1 of 1</span>
        <button id="nextPage" class="btn btn-secondary" disabled>Next ‚Üí</button>
      </div>
    </section>

    <!-- Achievements Section -->
    <section id="achievements" class="achievements">
      <h2 class="section-title">Achievements</h2>
      <div class="achievements-grid" id="achievementsList">
        <!-- Achievements will be populated dynamically -->
      </div>
    </section>

    <!-- Recent Activity -->
    <section class="recent-activity">
      <h2 class="section-title">Recent Activity</h2>
      <div id="activityFeed" class="activity-feed">
        <div class="no-activity">
          <p>No recent activity</p>
        </div>
      </div>
    </section>
  </main>

  <!-- Match Details Modal -->
  <div id="matchDetailsModal" class="modal" style="display: none;">
    <div class="modal-content match-details-modal">
      <span class="close">&times;</span>
      <h2 id="matchDetailsTitle">Match Details</h2>
      <div id="matchDetailsContent" class="match-details-content">
        <!-- Dynamic content -->
      </div>
      <div class="match-actions">
        <button id="replayMatch" class="btn btn-primary">üîÑ Play Similar</button>
        <button id="shareMatch" class="btn btn-secondary">üì§ Share</button>
        <button id="deleteMatch" class="btn btn-danger">üóëÔ∏è Delete</button>
      </div>
    </div>
  </div>

  <script src="js/firebase.js"></script>
  <script src="js/utils.js"></script>
  <script>
    let matchHistory = [];
    let filteredMatches = [];
    let currentPage = 1;
    const matchesPerPage = 10;
    let selectedFormat = 'all';
    let playerStats = {};
    let achievements = [];

    // Initialize page
    document.addEventListener('DOMContentLoaded', async () => {
      await initializeHistory();
      setupEventListeners();
    });

    async function initializeHistory() {
      try {
        showLoading('Loading match history...');
        
        await Promise.all([
          loadMatchHistory(),
          loadPlayerStatistics(),
          loadAchievements()
        ]);
        
        updateStatisticsDisplay();
        updateFormatStats('all');
        filterAndDisplayMatches();
        updateAchievementsDisplay();
        loadRecentActivity();
        
        hideLoading();
      } catch (error) {
        showError('Failed to load match history: ' + error.message);
      }
    }

    async function loadMatchHistory() {
      try {
        // Load matches from localStorage and Firebase
        const localMatches = loadFromLocalStorage('matchHistory') || [];
        const firebaseMatches = await loadFirebaseMatches();
        
        // Merge and deduplicate matches
        const allMatches = [...localMatches, ...firebaseMatches];
        matchHistory = deduplicateMatches(allMatches);
        
        // Sort by date (newest first)
        matchHistory.sort((a, b) => new Date(b.date) - new Date(a.date));
        
      } catch (error) {
        console.error('Error loading match history:', error);
        matchHistory = loadFromLocalStorage('matchHistory') || [];
      }
    }

    async function loadFirebaseMatches() {
      try {
        const snapshot = await firebase.get(firebase.ref(firebase.db, 'matchHistory'));
        return snapshot.exists() ? Object.values(snapshot.val()) : [];
      } catch (error) {
        console.error('Error loading Firebase matches:', error);
        return [];
      }
    }

    function deduplicateMatches(matches) {
      const uniqueMatches = new Map();
      matches.forEach(match => {
        const key = `${match.date}_${match.roomId || match.id}`;
        if (!uniqueMatches.has(key) || match.source === 'firebase') {
          uniqueMatches.set(key, match);
        }
      });
      return Array.from(uniqueMatches.values());
    }

    async function loadPlayerStatistics() {
      playerStats = calculatePlayerStatistics(matchHistory);
    }

    function calculatePlayerStatistics(matches) {
      if (matches.length === 0) {
        return {
          totalMatches: 0,
          matchesWon: 0,
          winPercentage: 0,
          highestScore: 0,
          averageScore: 0,
          totalWickets: 0,
          formatStats: {}
        };
      }

      const stats = {
        totalMatches: matches.length,
        matchesWon: 0,
        totalRuns: 0,
        totalWickets: 0,
        highestScore: 0,
        formatStats: {}
      };

      matches.forEach(match => {
        // Count wins
        if (match.result && match.result.winner === 'player') {
          stats.matchesWon++;
        }

        // Calculate runs and wickets
        const playerScore = match.playerScore || match.score?.player || 0;
        stats.totalRuns += playerScore;
        stats.highestScore = Math.max(stats.highestScore, playerScore);

        if (match.playerWickets !== undefined) {
          stats.totalWickets += match.playerWickets;
        }

        // Format-specific stats
        const format = match.format || '5';
        if (!stats.formatStats[format]) {
          stats.formatStats[format] = {
            matches: 0,
            wins: 0,
            totalRuns: 0,
            highestScore: 0
          };
        }

        stats.formatStats[format].matches++;
        if (match.result && match.result.winner === 'player') {
          stats.formatStats[format].wins++;
        }
        stats.formatStats[format].totalRuns += playerScore;
        stats.formatStats[format].highestScore = Math.max(
          stats.formatStats[format].highestScore, 
          playerScore
        );
      });

      stats.winPercentage = ((stats.matchesWon / stats.totalMatches) * 100).toFixed(1);
      stats.averageScore = (stats.totalRuns / stats.totalMatches).toFixed(2);

      return stats;
    }

    async function loadAchievements() {
      achievements = [
        {
          id: 'first_match',
          title: 'First Steps',
          description: 'Play your first match',
          icon: 'üèè',
          condition: () => playerStats.totalMatches >= 1,
          unlocked: false
        },
        {
          id: 'first_win',
          title: 'Victory!',
          description: 'Win your first match',
          icon: 'üèÜ',
          condition: () => playerStats.matchesWon >= 1,
          unlocked: false
        },
        {
          id: 'century',
          title: 'Century Maker',
          description: 'Score 100 runs in a single match',
          icon: 'üíØ',
          condition: () => playerStats.highestScore >= 100,
          unlocked: false
        },
        {
          id: 'win_streak_5',
          title: 'On Fire',
          description: 'Win 5 matches in a row',
          icon: 'üî•',
          condition: () => checkWinStreak(5),
          unlocked: false
        },
        {
          id: 'format_master',
          title: 'Format Master',
          description: 'Play all game formats',
          icon: 'üéØ',
          condition: () => Object.keys(playerStats.formatStats).length >= 5,
          unlocked: false
        },
        {
          id: 'veteran',
          title: 'Veteran Player',
          description: 'Play 50 matches',
          icon: '‚≠ê',
          condition: () => playerStats.totalMatches >= 50,
          unlocked: false
        }
      ];

      // Check which achievements are unlocked
      achievements.forEach(achievement => {
        achievement.unlocked = achievement.condition();
      });
    }

    function checkWinStreak(targetStreak) {
      let currentStreak = 0;
      let maxStreak = 0;

      for (let i = 0; i < matchHistory.length; i++) {
        const match = matchHistory[i];
        if (match.result && match.result.winner === 'player') {
          currentStreak++;
          maxStreak = Math.max(maxStreak, currentStreak);
        } else {
          currentStreak = 0;
        }
      }

      return maxStreak >= targetStreak;
    }

    function setupEventListeners() {
      // Format tabs
      document.querySelectorAll('.format-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.format-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          selectedFormat = tab.dataset.format;
          updateFormatStats(selectedFormat);
        });
      });

      // Filters
      document.getElementById('formatFilter').addEventListener('change', filterAndDisplayMatches);
      document.getElementById('resultFilter').addEventListener('change', filterAndDisplayMatches);
      document.getElementById('opponentFilter').addEventListener('change', filterAndDisplayMatches);
      document.getElementById('dateFilter').addEventListener('change', filterAndDisplayMatches);
      document.getElementById('clearFilters').addEventListener('click', clearAllFilters);

      // Search and sort
      document.getElementById('searchInput').addEventListener('input', debounce(filterAndDisplayMatches, 300));
      document.getElementById('searchBtn').addEventListener('click', filterAndDisplayMatches);
      document.getElementById('sortBy').addEventListener('change', filterAndDisplayMatches);

      // Pagination
      document.getElementById('prevPage').addEventListener('click', () => changePage(-1));
      document.getElementById('nextPage').addEventListener('click', () => changePage(1));

      // Modal
      document.querySelector('.close').addEventListener('click', closeMatchDetailsModal);
      document.getElementById('replayMatch').addEventListener('click', replayMatch);
      document.getElementById('shareMatch').addEventListener('click', shareMatch);
      document.getElementById('deleteMatch').addEventListener('click', deleteMatch);

      // Error modal
      document.getElementById('retry-btn').addEventListener('click', hideError);
    }

    function updateStatisticsDisplay() {
      document.getElementById('totalMatches').textContent = playerStats.totalMatches;
      document.getElementById('matchesWon').textContent = playerStats.matchesWon;
      document.getElementById('winPercentage').textContent = playerStats.winPercentage + '%';
      document.getElementById('highestScore').textContent = playerStats.highestScore;
      document.getElementById('averageScore').textContent = playerStats.averageScore;
      document.getElementById('totalWickets').textContent = playerStats.totalWickets;
    }

    function updateFormatStats(format) {
      let stats;
      
      if (format === 'all') {
        stats = {
          matches: playerStats.totalMatches,
          wins: playerStats.matchesWon,
          winRate: playerStats.winPercentage,
          avgScore: playerStats.averageScore,
          bestScore: playerStats.highestScore
        };
      } else {
        const formatStats = playerStats.formatStats[format] || {
          matches: 0, wins: 0, totalRuns: 0, highestScore: 0
        };
        
        stats = {
          matches: formatStats.matches,
          wins: formatStats.wins,
          winRate: formatStats.matches > 0 ? ((formatStats.wins / formatStats.matches) * 100).toFixed(1) : 0,
          avgScore: formatStats.matches > 0 ? (formatStats.totalRuns / formatStats.matches).toFixed(2) : 0,
          bestScore: formatStats.highestScore
        };
      }

      document.getElementById('formatMatches').textContent = stats.matches;
      document.getElementById('formatWinRate').textContent = stats.winRate + '%';
      document.getElementById('formatAvgScore').textContent = stats.avgScore;
      document.getElementById('formatBestScore').textContent = stats.bestScore;

      updatePerformanceChart(format);
    }

    function updatePerformanceChart(format) {
      const canvas = document.getElementById('performanceChart');
      const ctx = canvas.getContext('2d');
      
      // Clear canvas
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // Get matches for the selected format
      let matches = format === 'all' ? matchHistory : matchHistory.filter(m => m.format === format);
      matches = matches.slice(0, 10).reverse(); // Last 10 matches
      
      if (matches.length === 0) {
        ctx.fillStyle = '#666';
        ctx.font = '16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('No data available', canvas.width / 2, canvas.height / 2);
        return;
      }
      
      // Chart dimensions
      const padding = 40;
      const chartWidth = canvas.width - (padding * 2);
      const chartHeight = canvas.height - (padding * 2);
      
      // Find max score for scaling
      const maxScore = Math.max(...matches.map(m => m.playerScore || m.score?.player || 0), 10);
      
      // Draw chart
      ctx.strokeStyle = '#1e88e5';
      ctx.lineWidth = 2;
      ctx.beginPath();
      
      matches.forEach((match, index) => {
        const x = padding + (index * (chartWidth / (matches.length - 1)));
        const score = match.playerScore || match.score?.player || 0;
        const y = padding + chartHeight - ((score / maxScore) * chartHeight);
        
        if (index === 0) {
          ctx.moveTo(x, y);
        } else {
          ctx.lineTo(x, y);
        }
        
        // Draw point
        ctx.fillStyle = match.result?.winner === 'player' ? '#4caf50' : '#f44336';
        ctx.beginPath();
        ctx.arc(x, y, 4, 0, 2 * Math.PI);
        ctx.fill();
      });
      
      ctx.stroke();
      
      // Draw axes
      ctx.strokeStyle = '#666';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(padding, padding);
      ctx.lineTo(padding, padding + chartHeight);
      ctx.lineTo(padding + chartWidth, padding + chartHeight);
      ctx.stroke();
      
      // Labels
      ctx.fillStyle = '#999';
      ctx.font = '12px Arial';
      ctx.textAlign = 'center';
      ctx.fillText('Recent Matches', canvas.width / 2, canvas.height - 10);
      
      ctx.save();
      ctx.translate(15, canvas.height / 2);
      ctx.rotate(-Math.PI / 2);
      ctx.fillText('Score', 0, 0);
      ctx.restore();
    }

    function filterAndDisplayMatches() {
      const formatFilter = document.getElementById('formatFilter').value;
      const resultFilter = document.getElementById('resultFilter').value;
      const opponentFilter = document.getElementById('opponentFilter').value;
      const dateFilter = document.getElementById('dateFilter').value;
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const sortBy = document.getElementById('sortBy').value;

      // Apply filters
      filteredMatches = matchHistory.filter(match => {
        // Format filter
        if (formatFilter !== 'all' && match.format !== formatFilter) return false;
        
        // Result filter
        if (resultFilter !== 'all') {
          if (resultFilter === 'won' && match.result?.winner !== 'player') return false;
          if (resultFilter === 'lost' && match.result?.winner === 'player') return false;
          if (resultFilter === 'draw' && match.result?.winner !== 'draw') return false;
        }
        
        // Opponent filter
        if (opponentFilter !== 'all') {
          if (opponentFilter === 'human' && match.isAI) return false;
          if (opponentFilter === 'ai' && !match.isAI) return false;
        }
        
        // Date filter
        if (dateFilter !== 'all') {
          const matchDate = new Date(match.date);
          const now = new Date();
          
          switch (dateFilter) {
            case 'today':
              if (matchDate.toDateString() !== now.toDateString()) return false;
              break;
            case 'week':
              const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
              if (matchDate < weekAgo) return false;
              break;
            case 'month':
              if (matchDate.getMonth() !== now.getMonth() || matchDate.getFullYear() !== now.getFullYear()) return false;
              break;
            case 'year':
              if (matchDate.getFullYear() !== now.getFullYear()) return false;
              break;
          }
        }
        
        // Search filter
        if (searchTerm) {
          const searchableText = `
            ${match.opponent || ''} 
            ${match.format || ''} 
            ${match.result?.description || ''}
          `.toLowerCase();
          
          if (!searchableText.includes(searchTerm)) return false;
        }
        
        return true;
      });

      // Apply sorting
      filteredMatches.sort((a, b) => {
        switch (sortBy) {
          case 'date':
            return new Date(b.date) - new Date(a.date);
          case 'date-asc':
            return new Date(a.date) - new Date(b.date);
          case 'score':
            return (b.playerScore || 0) - (a.playerScore || 0);
          case 'score-asc':
            return (a.playerScore || 0) - (b.playerScore || 0);
          case 'format':
            return (a.format || '').localeCompare(b.format || '');
          default:
            return 0;
        }
      });

      currentPage = 1;
      displayMatches();
    }

    function displayMatches() {
      const matchesList = document.getElementById('matchesList');
      const startIndex = (currentPage - 1) * matchesPerPage;
      const endIndex = startIndex + matchesPerPage;
      const pageMatches = filteredMatches.slice(startIndex, endIndex);

      if (pageMatches.length === 0) {
        matchesList.innerHTML = `
          <div class="no-matches">
            <div class="no-matches-icon">üèè</div>
            <h3>No matches found</h3>
            <p>Try adjusting your filters or search terms.</p>
          </div>
        `;
      } else {
        matchesList.innerHTML = pageMatches.map(match => createMatchCard(match)).join('');
        
        // Add click listeners
        matchesList.querySelectorAll('.match-card').forEach((card, index) => {
          card.addEventListener('click', () => showMatchDetails(pageMatches[index]));
        });
      }

      updatePagination();
    }

    function createMatchCard(match) {
      const date = new Date(match.date).toLocaleDateString();
      const time = new Date(match.date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      const formatName = getFormatName(match.format);
      const isWin = match.result?.winner === 'player';
      const resultClass = isWin ? 'win' : (match.result?.winner === 'draw' ? 'draw' : 'loss');
      const resultIcon = isWin ? 'üèÜ' : (match.result?.winner === 'draw' ? 'ü§ù' : 'üòû');
      
      return `
        <div class="match-card ${resultClass} fade-in">
          <div class="match-header">
            <div class="match-format">${formatName}</div>
            <div class="match-date">${date} ${time}</div>
            <div class="match-result-icon">${resultIcon}</div>
          </div>
          
          <div class="match-teams">
            <div class="team player-team">
              <h4>You</h4>
              <div class="score">${match.playerScore || 0}/${match.playerWickets || 0}</div>
            </div>
            <div class="vs">VS</div>
            <div class="team opponent-team">
              <h4>${match.opponent || (match.isAI ? 'AI' : 'Opponent')}</h4>
              <div class="score">${match.opponentScore || 0}/${match.opponentWickets || 0}</div>
            </div>
          </div>
          
          <div class="match-summary">
            <div class="result-text">${match.result?.description || 'Match completed'}</div>
            ${match.isAI ? '<div class="ai-badge">ü§ñ AI Match</div>' : ''}
          </div>
          
          <div class="match-stats">
            <div class="stat">
              <span class="stat-label">Your SR:</span>
              <span class="stat-value">${match.playerStats?.strikeRate || '0.00'}</span>
            </div>
            <div class="stat">
              <span class="stat-label">Boundaries:</span>
              <span class="stat-value">${match.playerStats?.boundaries || 0}</span>
            </div>
            <div class="stat">
              <span class="stat-label">Overs:</span>
              <span class="stat-value">${formatOvers(match.playerStats?.balls || 0)}</span>
            </div>
          </div>
        </div>
      `;
    }

    function updatePagination() {
      const totalPages = Math.ceil(filteredMatches.length / matchesPerPage);
      
      document.getElementById('prevPage').disabled = currentPage <= 1;
      document.getElementById('nextPage').disabled = currentPage >= totalPages;
      document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
    }

    function changePage(direction) {
      const totalPages = Math.ceil(filteredMatches.length / matchesPerPage);
      const newPage = currentPage + direction;
      
      if (newPage >= 1 && newPage <= totalPages) {
        currentPage = newPage;
        displayMatches();
        
        // Scroll to top of matches list
        document.getElementById('matchesList').scrollIntoView({ behavior: 'smooth' });
      }
    }

    function clearAllFilters() {
      document.getElementById('formatFilter').value = 'all';
      document.getElementById('resultFilter').value = 'all';
      document.getElementById('opponentFilter').value = 'all';
      document.getElementById('dateFilter').value = 'all';
      document.getElementById('searchInput').value = '';
      document.getElementById('sortBy').value = 'date';
      
      filterAndDisplayMatches();
    }

    function showMatchDetails(match) {
      const modal = document.getElementById('matchDetailsModal');
      const title = document.getElementById('matchDetailsTitle');
      const content = document.getElementById('matchDetailsContent');
      
      title.textContent = `${getFormatName(match.format)} Match Details`;
      
      content.innerHTML = `
        <div class="match-overview">
          <div class="match-info-grid">
            <div class="info-item">
              <span class="label">Date:</span>
              <span class="value">${new Date(match.date).toLocaleString()}</span>
            </div>
            <div class="info-item">
              <span class="label">Format:</span>
              <span class="value">${getFormatName(match.format)}</span>
            </div>
            <div class="info-item">
              <span class="label">Opponent:</span>
              <span class="value">${match.opponent || (match.isAI ? 'AI Opponent' : 'Unknown')}</span>
            </div>
            <div class="info-item">
              <span class="label">Result:</span>
              <span class="value ${match.result?.winner === 'player' ? 'win' : 'loss'}">
                ${match.result?.description || 'Match completed'}
              </span>
            </div>
          </div>
        </div>
        
        <div class="detailed-scores">
          <h3>Detailed Scorecard</h3>
          <div class="scorecard-grid">
            <div class="team-scorecard">
              <h4>Your Performance</h4>
              <div class="score-breakdown">
                <div class="main-score">${match.playerScore || 0}/${match.playerWickets || 0}</div>
                <div class="score-details">
                  <div>Balls: ${match.playerStats?.balls || 0}</div>
                  <div>Strike Rate: ${match.playerStats?.strikeRate || '0.00'}</div>
                  <div>Boundaries: ${match.playerStats?.boundaries || 0}</div>
                </div>
              </div>
            </div>
            
            <div class="team-scorecard">
              <h4>Opponent Performance</h4>
              <div class="score-breakdown">
                <div class="main-score">${match.opponentScore || 0}/${match.opponentWickets || 0}</div>
                <div class="score-details">
                  <div>Balls: ${match.opponentStats?.balls || 0}</div>
                  <div>Strike Rate: ${match.opponentStats?.strikeRate || '0.00'}</div>
                  <div>Boundaries: ${match.opponentStats?.boundaries || 0}</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        ${match.ballByBall ? `
          <div class="ball-by-ball">
            <h3>Ball by Ball Commentary</h3>
            <div class="commentary-list">
              ${Object.entries(match.ballByBall).slice(-10).map(([ball, data]) => `
                <div class="commentary-item">
                  <span class="ball-number">Ball ${ball}:</span>
                  <span class="ball-result">${data.description || `${data.runs} runs`}</span>
                </div>
              `).join('')}
            </div>
          </div>
        ` : ''}
      `;
      
      modal.style.display = 'block';
      
      // Store current match for actions
      modal.currentMatch = match;
    }

    function closeMatchDetailsModal() {
      document.getElementById('matchDetailsModal').style.display = 'none';
    }

    function replayMatch() {
      const match = document.getElementById('matchDetailsModal').currentMatch;
      if (match) {
        const params = new URLSearchParams({
          format: match.format,
          difficulty: match.aiDifficulty || 'medium'
        });
        
        if (match.isAI) {
          window.location.href = `ai-game.html?${params.toString()}`;
        } else {
          window.location.href = `index.html?quickMatch=${match.format}`;
        }
      }
    }

    function shareMatch() {
      const match = document.getElementById('matchDetailsModal').currentMatch;
      if (match) {
        const shareText = `I just played a ${getFormatName(match.format)} match in HandiCricket! 
Score: ${match.playerScore}/${match.playerWickets} vs ${match.opponentScore}/${match.opponentWickets}
Result: ${match.result?.description}
Play at: ${window.location.origin}`;
        
        if (navigator.share) {
          navigator.share({
            title: 'HandiCricket Match Result',
            text: shareText,
            url: window.location.origin
          });
        } else {
          copyToClipboard(shareText).then(() => {
            showNotification('Match details copied to clipboard!', 'success');
          });
        }
      }
    }

    function deleteMatch() {
      const match = document.getElementById('matchDetailsModal').currentMatch;
      if (match && confirm('Are you sure you want to delete this match from your history?')) {
        // Remove from arrays
        const index = matchHistory.findIndex(m => 
          m.date === match.date && m.roomId === match.roomId
        );
        
        if (index > -1) {
          matchHistory.splice(index, 1);
          
          // Update localStorage
          saveToLocalStorage('matchHistory', matchHistory);
          
          // Recalculate stats and refresh display
          playerStats = calculatePlayerStatistics(matchHistory);
          updateStatisticsDisplay();
          updateFormatStats(selectedFormat);
          filterAndDisplayMatches();
          
          closeMatchDetailsModal();
          showNotification('Match deleted from history', 'success');
        }
      }
    }

    function updateAchievementsDisplay() {
      const achievementsList = document.getElementById('achievementsList');
      
      achievementsList.innerHTML = achievements.map(achievement => `
        <div class="achievement-card ${achievement.unlocked ? 'unlocked' : 'locked'}">
          <div class="achievement-icon">${achievement.icon}</div>
          <div class="achievement-content">
            <h4 class="achievement-title">${achievement.title}</h4>
            <p class="achievement-description">${achievement.description}</p>
          </div>
          <div class="achievement-status">
            ${achievement.unlocked ? '‚úÖ' : 'üîí'}
          </div>
        </div>
      `).join('');
    }

    function loadRecentActivity() {
      const activityFeed = document.getElementById('activityFeed');
      
      if (matchHistory.length === 0) {
        activityFeed.innerHTML = '<div class="no-activity"><p>No recent activity</p></div>';
        return;
      }
      
      const recentMatches = matchHistory.slice(0, 5);
      
      activityFeed.innerHTML = recentMatches.map(match => {
        const timeAgo = formatRelativeTime(new Date(match.date).getTime());
        const isWin = match.result?.winner === 'player';
        
        return `
          <div class="activity-item fade-in">
            <div class="activity-icon">${isWin ? 'üèÜ' : 'üèè'}</div>
            <div class="activity-content">
              <div class="activity-text">
                ${isWin ? 'Won' : 'Played'} a ${getFormatName(match.format)} match
                ${match.isAI ? 'against AI' : 'with opponent'}
              </div>
              <div class="activity-time">${timeAgo}</div>
            </div>
            <div class="activity-score">${match.playerScore || 0}/${match.playerWickets || 0}</div>
          </div>
        `;
      }).join('');
    }

    // Auto-refresh recent activity every minute
    setInterval(loadRecentActivity, 60000);
  </script>

  <style>
    .history-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem;
    }

    .stats-overview {
      margin-bottom: 3rem;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-top: 1.5rem;
    }

    .stat-card {
      background: var(--card-bg);
      padding: 1.5rem;
      border-radius: 16px;
      box-shadow: var(--shadow-lg);
      text-align: center;
      transition: transform 0.3s;
    }

    .stat-card:hover {
      transform: translateY(-5px);
    }

    .stat-icon {
      font-size: 2.5rem;
      margin-bottom: 1rem;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      color: var(--primary-color);
      margin-bottom: 0.5rem;
    }

    .stat-label {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .format-stats {
      margin-bottom: 3rem;
    }

    .format-tabs {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      justify-content: center;
    }

    .format-tab {
      padding: 0.75rem 1.5rem;
      border: 2px solid var(--border-color);
      background: transparent;
      color: var(--text-secondary);
      border-radius: 25px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .format-tab.active, .format-tab:hover {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }

    .format-stats-content {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 2rem;
      background: var(--card-bg);
      padding: 2rem;
      border-radius: 16px;
      box-shadow: var(--shadow-lg);
    }

    .performance-chart {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .detail-grid {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .detail-item {
      display: flex;
      justify-content: space-between;
      padding: 0.75rem;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
    }

    .detail-label {
      color: var(--text-secondary);
    }

    .detail-value {
      color: var(--primary-color);
      font-weight: bold;
    }

    .history-filters {
      margin-bottom: 2rem;
    }

    .filter-controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      background: var(--card-bg);
      padding: 1.5rem;
      border-radius: 16px;
      box-shadow: var(--shadow);
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .filter-group label {
      color: var(--text-secondary);
      font-size: 0.9rem;
      font-weight: 500;
    }

    .filter-select {
      padding: 0.75rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: var(--card-bg);
      color: var(--text-primary);
    }

    .history-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      gap: 1rem;
    }

    .search-box {
      display: flex;
      gap: 0.5rem;
      flex: 1;
      max-width: 400px;
    }

    .search-input {
      flex: 1;
      padding: 0.75rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: var(--card-bg);
      color: var(--text-primary);
    }

    .sort-controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .sort-select {
      padding: 0.75rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: var(--card-bg);
      color: var(--text-primary);
    }

    .matches-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .match-card {
      background: var(--card-bg);
      padding: 1.5rem;
      border-radius: 16px;
      box-shadow: var(--shadow);
      cursor: pointer;
      transition: all 0.3s;
      border-left: 4px solid transparent;
    }

    .match-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .match-card.win {
      border-left-color: var(--success-color);
    }

    .match-card.loss {
      border-left-color: var(--danger-color);
    }

    .match-card.draw {
      border-left-color: var(--warning-color);
    }

    .match-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .match-format {
      background: var(--primary-color);
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.9rem;
      font-weight: bold;
    }

    .match-date {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .match-result-icon {
      font-size: 1.5rem;
    }

    .match-teams {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 1rem;
      align-items: center;
      margin-bottom: 1rem;
    }

    .team {
      text-align: center;
    }

    .team h4 {
      color: var(--primary-color);
      margin-bottom: 0.5rem;
      font-size: 1.1rem;
    }

    .team .score {
      font-size: 1.5rem;
      font-weight: bold;
    }

    .vs {
      font-size: 1.2rem;
      font-weight: bold;
      color: var(--text-secondary);
      text-align: center;
    }

    .match-summary {
      text-align: center;
      margin-bottom: 1rem;
    }

    .result-text {
      color: var(--text-secondary);
      font-style: italic;
      margin-bottom: 0.5rem;
    }

    .ai-badge {
      background: var(--warning-color);
      color: black;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.8rem;
      display: inline-block;
    }

    .match-stats {
      display: flex;
      justify-content: space-around;
      gap: 1rem;
    }

    .stat {
      text-align: center;
    }

    .stat-label {
      color: var(--text-secondary);
      font-size: 0.8rem;
      display: block;
    }

    .stat-value {
      color: var(--primary-color);
      font-weight: bold;
    }

    .no-matches {
      text-align: center;
      padding: 3rem;
      color: var(--text-secondary);
    }

    .no-matches-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
    }

    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1rem;
      margin-top: 2rem;
    }

    .page-info {
      color: var(--text-secondary);
    }

    .achievements {
      margin-bottom: 3rem;
    }

    .achievements-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1rem;
    }

    .achievement-card {
      background: var(--card-bg);
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      gap: 1rem;
      transition: all 0.3s;
    }

    .achievement-card.unlocked {
      border-left: 4px solid var(--success-color);
    }

    .achievement-card.locked {
      opacity: 0.6;
      border-left: 4px solid var(--border-color);
    }

    .achievement-icon {
      font-size: 2rem;
    }

    .achievement-content {
      flex: 1;
    }

    .achievement-title {
      color: var(--primary-color);
      margin-bottom: 0.5rem;
    }

    .achievement-description {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .achievement-status {
      font-size: 1.5rem;
    }

    .recent-activity {
      margin-bottom: 2rem;
    }

    .activity-feed {
      background: var(--card-bg);
      padding: 1.5rem;
      border-radius: 16px;
      box-shadow: var(--shadow);
    }

    .activity-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem 0;
      border-bottom: 1px solid var(--border-color);
    }

    .activity-item:last-child {
      border-bottom: none;
    }

    .activity-icon {
      font-size: 1.5rem;
    }

    .activity-content {
      flex: 1;
    }

    .activity-text {
      color: var(--text-primary);
      margin-bottom: 0.25rem;
    }

    .activity-time {
      color: var(--text-secondary);
      font-size: 0.8rem;
    }

    .activity-score {
      color: var(--primary-color);
      font-weight: bold;
    }

    .no-activity {
      text-align: center;
      color: var(--text-secondary);
      padding: 2rem;
    }

    .match-details-modal {
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .match-overview {
      margin-bottom: 2rem;
    }

    .match-info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      background: rgba(255, 255, 255, 0.05);
      padding: 1rem;
      border-radius: 8px;
    }

    .info-item {
      display: flex;
      justify-content: space-between;
    }

    .info-item .label {
      color: var(--text-secondary);
    }

    .info-item .value {
      color: var(--primary-color);
      font-weight: bold;
    }

    .info-item .value.win {
      color: var(--success-color);
    }

    .info-item .value.loss {
      color: var(--danger-color);
    }

    .detailed-scores {
      margin-bottom: 2rem;
    }

    .scorecard-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .team-scorecard {
      background: rgba(255, 255, 255, 0.05);
      padding: 1rem;
      border-radius: 8px;
    }

    .team-scorecard h4 {
      color: var(--primary-color);
      margin-bottom: 1rem;
      text-align: center;
    }

    .score-breakdown {
      text-align: center;
    }

    .main-score {
      font-size: 2rem;
      font-weight: bold;
      color: var(--success-color);
      margin-bottom: 1rem;
    }

    .score-details {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .ball-by-ball {
      margin-bottom: 2rem;
    }

    .commentary-list {
      max-height: 200px;
      overflow-y: auto;
      background: rgba(255, 255, 255, 0.05);
      padding: 1rem;
      border-radius: 8px;
    }

    .commentary-item {
      display: flex;
      gap: 1rem;
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--border-color);
    }

    .commentary-item:last-child {
      border-bottom: none;
    }

    .ball-number {
      color: var(--primary-color);
      font-weight: bold;
      min-width: 80px;
    }

    .ball-result {
      color: var(--text-secondary);
    }

    .match-actions {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-top: 2rem;
    }

    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .format-stats-content {
        grid-template-columns: 1fr;
      }

      .filter-controls {
        grid-template-columns: 1fr;
      }

      .history-actions {
        flex-direction: column;
        align-items: stretch;
      }

      .search-box {
        max-width: none;
      }

      .match-teams {
        grid-template-columns: 1fr;
        gap: 0.5rem;
      }

      .vs {
        order: -1;
      }

      .match-stats {
        flex-direction: column;
        gap: 0.5rem;
      }

      .scorecard-grid {
        grid-template-columns: 1fr;
      }

      .match-actions {
        flex-direction: column;
      }

      .achievements-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 480px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }

      .format-tabs {
        flex-direction: column;
      }

      .match-header {
        flex-direction: column;
        gap: 0.5rem;
        text-align: center;
      }
    }
  </style>
</body>
</html>
