<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>HandiCricket - Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { 
      background: #061e3e; 
      color: white; 
      font-family: sans-serif; 
      text-align: center; 
      padding: 20px; 
    }
    .card-row { 
      margin-top: 20px; 
      display: flex; 
      flex-wrap: wrap; 
      justify-content: center; 
      gap: 10px; 
    }
    button.card { 
      width: 60px; 
      height: 60px; 
      font-size: 20px; 
      border-radius: 12px; 
      border: none; 
      background: #1e88e5; 
      color: white; 
    }
    button.card:disabled { 
      background: #607d8b; 
      color: #ccc; 
    }
    #scoreboard, #roleText { 
      margin-top: 10px; 
      font-size: 18px; 
    }
    #status { 
      margin-top: 15px; 
      font-size: 16px; 
      color: #ffeb3b; 
    }
    #currentPlayers {
      font-weight: bold;
      margin: 10px 0;
    }
    #teamStatus {
      margin: 15px 0;
      padding: 10px;
      background: #0d2a52;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <h2>üèè HandiCricket</h2>
  <div id="roleText"></div>
  
  <div id="teamStatus">
    <div id="currentPlayers">
      Batter: <span id="currentBatter">-</span> | Bowler: <span id="currentBowler">-</span>
    </div>
    <div id="scoreboard">Runs: 0 | Wickets: 0 | Overs: 0.0</div>
  </div>
  
  <div id="status">Waiting for players...</div>

  <div class="card-row" id="cardButtons">
    <button class="card" data-value="0">0</button>
    <button class="card" data-value="1">1</button>
    <button class="card" data-value="2">2</button>
    <button class="card" data-value="3">3</button>
    <button class="card" data-value="4">4</button>
    <button class="card" data-value="5">5</button>
    <button class="card" data-value="6">6</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getDatabase, ref, onValue, set, update } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAGU0Tsj9pwZcgwQjZzTFvGOE032l2b7HI",
      authDomain: "handicricket-d1ab7.firebaseapp.com",
      projectId: "handicricket-d1ab7",
      storageBucket: "handicricket-d1ab7.appspot.com",
      messagingSenderId: "356065986337",
      appId: "1:356065986337:web:399102c5dabfca2b6fe060"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const params = new URLSearchParams(window.location.search);
    const room = params.get('room');
    const player = params.get('player');
    const opponent = player === "player1" ? "player2" : "player1";

    let runs = 0, wickets = 0, legalBalls = 0;
    let currentBatter = null, currentBowler = null;
    let isBatting = false;

    const status = document.getElementById("status");
    const scoreboard = document.getElementById("scoreboard");
    const buttons = document.querySelectorAll(".card");
    const roleText = document.getElementById("roleText");
    const currentBatterEl = document.getElementById("currentBatter");
    const currentBowlerEl = document.getElementById("currentBowler");

    async function setupRole() {
      const tossSnap = await get(ref(db, `rooms/${room}/tossWinner`));
      const battingFirstSnap = await get(ref(db, `rooms/${room}/battingFirst`));
      
      const battingFirst = battingFirstSnap.val();
      isBatting = (player === battingFirst);
      
      roleText.innerText = isBatting ? "You are Batting" : "You are Bowling";
      updateButtonStates();
    }

    function updateButtonStates() {
      const canPlay = (isBatting && currentBatter) || (!isBatting && currentBowler);
      buttons.forEach(btn => {
        btn.disabled = !canPlay;
      });
      status.innerText = canPlay ? "Play your card..." : "Waiting for selections...";
    }

    function updateScoreboard() {
      const overs = Math.floor(legalBalls / 6);
      const balls = legalBalls % 6;
      scoreboard.innerText = `Runs: ${runs} | Wickets: ${wickets} | Overs: ${overs}.${balls}`;
    }

    onValue(ref(db, `rooms/${room}/currentPlays`), (snap) => {
      const plays = snap.val();
      if (!plays || plays.player1 === null || plays.player2 === null) return;

      const batCard = isBatting ? plays[player] : plays[opponent];
      const bowlCard = isBatting ? plays[opponent] : plays[player];

      if (batCard === bowlCard) {
        wickets++;
        status.innerText = "WICKET!";
      } else {
        runs += batCard;
        status.innerText = `${batCard} runs scored!`;
      }

      legalBalls++;
      updateScoreboard();

      setTimeout(() => {
        update(ref(db, `rooms/${room}/currentPlays`), {
          player1: null,
          player2: null
        });
      }, 1500);
    });

    onValue(ref(db, `rooms/${room}/currentBatter`), (snap) => {
      currentBatter = snap.val();
      currentBatterEl.innerText = currentBatter || "-";
      updateButtonStates();
    });

    onValue(ref(db, `rooms/${room}/currentBowler`), (snap) => {
      currentBowler = snap.val();
      currentBowlerEl.innerText = currentBowler || "-";
      updateButtonStates();
    });

    buttons.forEach(btn => {
      btn.addEventListener("click", async () => {
        const val = parseInt(btn.dataset.value);
        await update(ref(db, `rooms/${room}/currentPlays`), {
          [player]: val
        });
        status.innerText = "Waiting for opponent...";
        buttons.forEach(b => b.disabled = true);
      });
    });

    setupRole();
  </script>
</body>
</html>
