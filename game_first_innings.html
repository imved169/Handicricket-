<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HandiCricket - First Innings</title>
  <style>
    :root {
      --primary: #1e88e5;
      --secondary: #1565c0;
      --success: #4CAF50;
      --danger: #f44336;
      --warning: #ff9800;
      --info: #2196F3;
      --dark: #061e3e;
      --light: #f8f9fa;
      --powerplay: rgba(255, 235, 59, 0.3);
      --dead-over: rgba(244, 67, 54, 0.3);
      --free-hit: rgba(76, 175, 80, 0.3);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)), 
                  url('https://example.com/stadium-bg.jpg') no-repeat center center fixed;
      background-size: cover;
      color: white;
      height: 100vh;
      overflow-x: hidden;
      position: relative;
    }

    /* Header Section */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      background: rgba(6, 30, 62, 0.8);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .team-names {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .team {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .team-name {
      font-weight: bold;
      font-size: 1.2rem;
    }

    .team-role {
      font-size: 0.8rem;
      color: #aaa;
    }

    .vs {
      font-weight: bold;
      color: #ffeb3b;
    }

    .match-info {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      font-size: 0.9rem;
    }

    .format {
      color: #ffeb3b;
      font-weight: bold;
    }

    /* Scoreboard Section */
    .scoreboard {
      display: flex;
      justify-content: space-between;
      padding: 15px 20px;
      background: rgba(0, 0, 0, 0.5);
      margin: 10px 20px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .score-main {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .score-runs {
      font-size: 2.5rem;
      font-weight: bold;
      color: #ffeb3b;
    }

    .score-wickets {
      font-size: 1.5rem;
    }

    .score-overs {
      font-size: 1.2rem;
    }

    .score-details {
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .run-rate {
      font-size: 1.1rem;
      margin-bottom: 5px;
    }

    .target {
      font-size: 1.1rem;
      color: #ffeb3b;
    }

    /* Ticker Section */
    .ticker {
      background: rgba(30, 136, 229, 0.2);
      padding: 8px 0;
      margin: 0 20px;
      border-radius: 5px;
      overflow: hidden;
      white-space: nowrap;
    }

    .ticker-content {
      display: inline-block;
      padding-left: 100%;
      animation: ticker 20s linear infinite;
    }

    @keyframes ticker {
      0% { transform: translateX(0); }
      100% { transform: translateX(-100%); }
    }

    /* Player Comparison */
    .player-comparison {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      margin: 10px 20px;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .player {
      flex: 1;
      padding: 5px;
      text-align: center;
    }

    .player-name {
      font-weight: bold;
      margin-bottom: 5px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { color: white; }
      50% { color: #ffeb3b; }
      100% { color: white; }
    }

    .player-stats {
      display: flex;
      justify-content: space-around;
      font-size: 0.9rem;
    }

    .vs-circle {
      width: 40px;
      height: 40px;
      background: #1e88e5;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      margin: 0 10px;
    }

    /* Over Progress */
    .over-progress {
      display: flex;
      justify-content: center;
      padding: 10px 20px;
      margin: 10px 20px;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .ball {
      width: 25px;
      height: 25px;
      border-radius: 50%;
      margin: 0 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: bold;
    }

    .ball-dot {
      background: #666;
    }

    .ball-run {
      background: #4CAF50;
    }

    .ball-boundary {
      background: #FF9800;
    }

    .ball-wicket {
      background: #f44336;
    }

    .ball-wide {
      background: #2196F3;
    }

    .ball-noball {
      background: #9C27B0;
    }

    /* Match Timeline */
    .timeline {
      display: flex;
      overflow-x: auto;
      padding: 10px 20px;
      margin: 10px 20px;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      scrollbar-width: thin;
    }

    .timeline::-webkit-scrollbar {
      height: 5px;
    }

    .timeline::-webkit-scrollbar-thumb {
      background: #1e88e5;
      border-radius: 5px;
    }

    .event {
      min-width: 120px;
      padding: 5px 10px;
      margin-right: 10px;
      border-radius: 5px;
      background: rgba(30, 136, 229, 0.2);
      font-size: 0.8rem;
    }

    .event-wicket {
      background: rgba(244, 67, 54, 0.3);
      border-left: 3px solid #f44336;
    }

    .event-boundary {
      background: rgba(255, 152, 0, 0.3);
      border-left: 3px solid #FF9800;
    }

    .event-milestone {
      background: rgba(76, 175, 80, 0.3);
      border-left: 3px solid #4CAF50;
    }

    /* Game Controls */
    .controls {
      display: flex;
      flex-direction: column;
      padding: 15px 20px;
      margin: 10px 20px;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .run-buttons {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
    }

    .run-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: none;
      background: linear-gradient(145deg, #1e88e5, #1565c0);
      color: white;
      font-size: 1.2rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }

    .run-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    .run-btn:active {
      transform: translateY(1px);
    }

    .run-btn.selected {
      background: linear-gradient(145deg, #4CAF50, #2E7D32);
      border: 2px solid #ffeb3b;
    }

    .run-btn:disabled {
      background: #666;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .run-btn::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 5px;
      height: 5px;
      background: rgba(255, 255, 255, 0.5);
      opacity: 0;
      border-radius: 100%;
      transform: scale(1, 1) translate(-50%);
      transform-origin: 50% 50%;
    }

    .run-btn:focus:not(:active)::after {
      animation: ripple 1s ease-out;
    }

    @keyframes ripple {
      0% {
        transform: scale(0, 0);
        opacity: 0.5;
      }
      100% {
        transform: scale(20, 20);
        opacity: 0;
      }
    }

    .action-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
    }

    .action-btn {
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      background: linear-gradient(145deg, #607D8B, #455A64);
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }

    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .action-btn:active {
      transform: translateY(1px);
    }

    .action-btn.danger {
      background: linear-gradient(145deg, #f44336, #d32f2f);
    }

    .action-btn.success {
      background: linear-gradient(145deg, #4CAF50, #2E7D32);
    }

    /* Status Indicators */
    .status-indicators {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin: 10px 20px;
    }

    .indicator {
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.8rem;
      font-weight: bold;
      animation: pulse 2s infinite;
    }

    .powerplay {
      background: var(--powerplay);
      border: 1px solid #ffeb3b;
    }

    .dead-over {
      background: var(--dead-over);
      border: 1px solid #f44336;
    }

    .free-hit {
      background: var(--free-hit);
      border: 1px solid #4CAF50;
    }

    /* Commentary */
    .commentary {
      height: 100px;
      overflow-y: auto;
      padding: 10px 20px;
      margin: 10px 20px;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      font-size: 0.9rem;
      line-height: 1.4;
    }

    .commentary-item {
      margin-bottom: 5px;
      padding-bottom: 5px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .over-mark {
      color: #ffeb3b;
      font-weight: bold;
    }

    /* Selection Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }

    .modal.active {
      opacity: 1;
      pointer-events: all;
    }

    .modal-content {
      background: linear-gradient(145deg, #061e3e, #0a2a4a);
      width: 90%;
      max-width: 500px;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.1);
      transform: translateY(-20px);
      transition: transform 0.3s;
    }

    .modal.active .modal-content {
      transform: translateY(0);
    }

    .modal-header {
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .modal-title {
      color: #ffeb3b;
      font-size: 1.2rem;
    }

    .modal-body {
      max-height: 400px;
      overflow-y: auto;
      margin-bottom: 15px;
    }

    .player-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 10px;
    }

    .player-card {
      padding: 10px;
      background: rgba(30, 136, 229, 0.2);
      border-radius: 5px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      border: 1px solid transparent;
    }

    .player-card:hover {
      background: rgba(30, 136, 229, 0.4);
    }

    .player-card.selected {
      background: rgba(255, 235, 59, 0.2);
      border: 1px solid #ffeb3b;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .modal-btn {
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      background: linear-gradient(145deg, #1e88e5, #1565c0);
      color: white;
      font-weight: bold;
      cursor: pointer;
    }

    .modal-btn:disabled {
      background: #666;
      cursor: not-allowed;
    }

    /* End of Innings Modal */
    .summary-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }

    .summary-modal.active {
      opacity: 1;
      pointer-events: all;
    }

    .summary-content {
      background: linear-gradient(145deg, #061e3e, #0a2a4a);
      width: 90%;
      max-width: 800px;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.1);
      max-height: 90vh;
      overflow-y: auto;
    }

    .summary-header {
      text-align: center;
      margin-bottom: 20px;
    }

    .summary-title {
      color: #ffeb3b;
      font-size: 1.5rem;
      margin-bottom: 10px;
    }

    .summary-score {
      font-size: 1.2rem;
      margin-bottom: 15px;
    }

    .summary-highlight {
      background: rgba(255, 235, 59, 0.2);
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 20px;
      border-left: 3px solid #ffeb3b;
    }

    .summary-section {
      margin-bottom: 20px;
    }

    .section-title {
      color: #ffeb3b;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding-bottom: 5px;
      margin-bottom: 10px;
    }

    .awards {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
    }

    .award-card {
      flex: 1;
      min-width: 150px;
      background: rgba(255, 215, 0, 0.1);
      border: 1px solid gold;
      padding: 10px;
      border-radius: 5px;
    }

    .award-title {
      font-size: 0.8rem;
      color: gold;
      margin-bottom: 5px;
    }

    .award-winner {
      font-weight: bold;
    }

    .stats-tables {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 15px;
    }

    .stats-table {
      flex: 1;
      min-width: 250px;
      background: rgba(13, 42, 82, 0.5);
      border-radius: 5px;
      padding: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }

    th {
      background: rgba(30, 136, 229, 0.5);
      padding: 5px;
      text-align: left;
    }

    td {
      padding: 5px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    tr:nth-child(even) {
      background: rgba(30, 136, 229, 0.1);
    }

    .summary-footer {
      text-align: center;
      margin-top: 20px;
    }

    .continue-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      background: linear-gradient(145deg, #4CAF50, #2E7D32);
      color: white;
      font-weight: bold;
      cursor: pointer;
    }

    /* Animations */
    @keyframes scorePop {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }

    .score-pop {
      animation: scorePop 0.5s;
    }

    @keyframes wicketFlash {
      0% { background-color: inherit; }
      50% { background-color: rgba(244, 67, 54, 0.5); }
      100% { background-color: inherit; }
    }

    .wicket-flash {
      animation: wicketFlash 0.5s;
    }

    @keyframes boundaryCelebration {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    .boundary-celebration {
      animation: boundaryCelebration 0.5s;
    }

    @keyframes screenShake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
      20%, 40%, 60%, 80% { transform: translateX(5px); }
    }

    .screen-shake {
      animation: screenShake 0.5s;
    }

    .confetti {
      position: fixed;
      width: 10px;
      height: 10px;
      background-color: #f00;
      opacity: 0;
      z-index: 999;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        align-items: flex-start;
      }

      .match-info {
        align-items: flex-start;
        margin-top: 10px;
      }

      .run-buttons {
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
      }

      .run-btn {
        width: 40px;
        height: 40px;
        font-size: 1rem;
      }

      .player-comparison {
        flex-direction: column;
      }

      .vs-circle {
        margin: 10px 0;
        transform: rotate(90deg);
      }

      .stats-tables {
        flex-direction: column;
      }
    }

    @media (max-width: 480px) {
      .team-names {
        flex-direction: column;
        gap: 5px;
      }

      .vs {
        display: none;
      }

      .player-list {
        grid-template-columns: 1fr 1fr;
      }
    }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <!-- Main Game UI -->
  <div class="header">
    <div class="team-names">
      <div class="team">
        <div class="team-name" id="team1Name">Team A</div>
        <div class="team-role" id="team1Role"></div>
      </div>
      <div class="vs">VS</div>
      <div class="team">
        <div class="team-name" id="team2Name">Team B</div>
        <div class="team-role" id="team2Role"></div>
      </div>
    </div>
    <div class="match-info">
      <div class="format" id="matchFormat">T20 (20 Overs)</div>
      <div id="matchTime">10:30 AM, 15 Jun 2023</div>
    </div>
  </div>

  <div class="scoreboard">
    <div class="score-main">
      <div class="score-runs" id="scoreRuns">0</div>
      <div class="score-wickets" id="scoreWickets">0</div>
      <div class="score-overs" id="scoreOvers">0.0</div>
    </div>
    <div class="score-details">
      <div class="run-rate" id="runRate">Run Rate: 0.00</div>
      <div class="target" id="targetScore" style="display: none;">Target: 0</div>
    </div>
  </div>

  <div class="ticker">
    <div class="ticker-content" id="tickerContent">
      Welcome to HandiCricket! Match about to begin...
    </div>
  </div>

  <div class="status-indicators" id="statusIndicators">
    <!-- Indicators will be added dynamically -->
  </div>

  <div class="player-comparison">
    <div class="player" id="batterInfo">
      <div class="player-name">Batter</div>
      <div class="player-stats">
        <div>Runs: <span id="batterRuns">0</span></div>
        <div>Balls: <span id="batterBalls">0</span></div>
      </div>
    </div>
    <div class="vs-circle">VS</div>
    <div class="player" id="bowlerInfo">
      <div class="player-name">Bowler</div>
      <div class="player-stats">
        <div>Overs: <span id="bowlerOvers">0</span></div>
        <div>Wkts: <span id="bowlerWickets">0</span></div>
      </div>
    </div>
  </div>

  <div class="over-progress" id="overProgress">
    <!-- Balls will be added dynamically -->
  </div>

  <div class="timeline" id="matchTimeline">
    <!-- Events will be added dynamically -->
  </div>

  <div class="controls">
    <div class="run-buttons">
      <button class="run-btn" id="run0" data-runs="0">0</button>
      <button class="run-btn" id="run1" data-runs="1">1</button>
      <button class="run-btn" id="run2" data-runs="2">2</button>
      <button class="run-btn" id="run3" data-runs="3">3</button>
      <button class="run-btn" id="run4" data-runs="4">4</button>
      <button class="run-btn" id="run5" data-runs="5">5</button>
      <button class="run-btn" id="run6" data-runs="6">6</button>
    </div>
    <div class="action-buttons">
      <button class="action-btn" id="wideBtn">Wide</button>
      <button class="action-btn" id="noballBtn">No Ball</button>
      <button class="action-btn danger" id="wicketBtn">Wicket</button>
      <button class="action-btn success" id="submitBtn">Submit</button>
    </div>
  </div>

  <div class="commentary" id="commentary">
    <!-- Commentary will be added dynamically -->
  </div>

  <!-- Selection Modals -->
  <div class="modal" id="batterModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Select Batter</div>
      </div>
      <div class="modal-body">
        <div class="player-list" id="batterList">
          <!-- Players will be added dynamically -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn" id="confirmBatter" disabled>Confirm</button>
      </div>
    </div>
  </div>

  <div class="modal" id="bowlerModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Select Bowler</div>
      </div>
      <div class="modal-body">
        <div class="player-list" id="bowlerList">
          <!-- Players will be added dynamically -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn" id="confirmBowler" disabled>Confirm</button>
      </div>
    </div>
  </div>

  <!-- End of Innings Modal -->
  <div class="summary-modal" id="summaryModal">
    <div class="summary-content">
      <div class="summary-header">
        <div class="summary-title">End of Innings</div>
        <div class="summary-score" id="summaryScore">Team A: 120/5 (20.0)</div>
        <div class="summary-highlight" id="summaryHighlight">
          Team A set a target of 121 runs for Team B
        </div>
      </div>
      
      <div class="summary-section">
        <div class="section-title">Player Awards</div>
        <div class="awards">
          <div class="award-card">
            <div class="award-title">Player of the Innings</div>
            <div class="award-winner" id="potm">Player Name</div>
          </div>
          <div class="award-card">
            <div class="award-title">Top Batter</div>
            <div class="award-winner" id="topBatter">Player Name (50 runs)</div>
          </div>
          <div class="award-card">
            <div class="award-title">Top Bowler</div>
            <div class="award-winner" id="topBowler">Player Name (3 wickets)</div>
          </div>
        </div>
      </div>
      
      <div class="summary-section">
        <div class="section-title">Batting Performance</div>
        <div class="stats-tables">
          <div class="stats-table">
            <table id="battingTable">
              <thead>
                <tr>
                  <th>Batter</th>
                  <th>R</th>
                  <th>B</th>
                  <th>SR</th>
                </tr>
              </thead>
              <tbody>
                <!-- Rows will be added dynamically -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <div class="summary-section">
        <div class="section-title">Bowling Performance</div>
        <div class="stats-tables">
          <div class="stats-table">
            <table id="bowlingTable">
              <thead>
                <tr>
                  <th>Bowler</th>
                  <th>O</th>
                  <th>W</th>
                  <th>ER</th>
                </tr>
              </thead>
              <tbody>
                <!-- Rows will be added dynamically -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <div class="summary-footer">
        <button class="continue-btn" id="continueToSecondInnings">Continue to Second Innings</button>
      </div>
    </div>
  </div>

  <!-- Confetti container -->
  <div id="confetti-container"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, get, push } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCN6aZMwlsZe7JJaovU0WA3UQygWr4jYmA",
      authDomain: "handicricket-85a06.firebaseapp.com",
      projectId: "handicricket-85a06",
      storageBucket: "handicricket-85a06.appspot.com",
      messagingSenderId: "599182538558",
      appId: "1:599182538558:web:3e965753ab05f8f1e3de6f",
      measurementId: "G-HSV9H4LEJQ"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Get URL parameters
    const params = new URLSearchParams(window.location.search);
    const roomId = params.get('room');
    const playerRole = params.get('player');
    const isSpectator = playerRole === 'spectator';

    if (!roomId || (!playerRole && !isSpectator)) {
      alert('Invalid room or player');
      window.location.href = 'index.html';
    }

    // Firebase references
    const roomRef = ref(db, `rooms/${roomId}`);
    const matchRef = ref(db, `matches/${roomId}`);
    const firstInningsRef = ref(db, `matches/${roomId}/firstInnings`);
    const secondInningsRef = ref(db, `matches/${roomId}/secondInnings`);
    const tossRef = ref(db, `rooms/${roomId}/toss`);
    const teamsRef = ref(db, `rooms/${roomId}/teams`);
    const playerRef = ref(db, `rooms/${roomId}/${playerRole}`);
    const commentaryRef = ref(db, `matches/${roomId}/commentary`);
    const statsRef = ref(db, `matches/${roomId}/stats`);

    // Game state
    let gameState = {
      battingTeam: null,
      bowlingTeam: null,
      currentBatter: null,
      currentBowler: null,
      selectedRuns: null,
      isPowerplay: false,
      isDeadOver: false,
      isFreeHit: false,
      currentOver: 0,
      currentBall: 0,
      totalRuns: 0,
      totalWickets: 0,
      extras: 0,
      batterStats: {},
      bowlerStats: {},
      overHistory: [],
      matchFormat: null,
      maxOvers: null,
      powerplayOvers: null,
      deadOvers: [],
      team1Players: [],
      team2Players: [],
      team1Name: '',
      team2Name: '',
      team1Captain: '',
      team2Captain: '',
      team1ViceCaptain: '',
      team2ViceCaptain: '',
      isFirstInnings: true,
      inningsComplete: false,
      matchComplete: false
    };

    // DOM elements
    const team1NameEl = document.getElementById('team1Name');
    const team2NameEl = document.getElementById('team2Name');
    const team1RoleEl = document.getElementById('team1Role');
    const team2RoleEl = document.getElementById('team2Role');
    const matchFormatEl = document.getElementById('matchFormat');
    const scoreRunsEl = document.getElementById('scoreRuns');
    const scoreWicketsEl = document.getElementById('scoreWickets');
    const scoreOversEl = document.getElementById('scoreOvers');
    const runRateEl = document.getElementById('runRate');
    const targetScoreEl = document.getElementById('targetScore');
    const tickerContentEl = document.getElementById('tickerContent');
    const statusIndicatorsEl = document.getElementById('statusIndicators');
    const batterNameEl = document.getElementById('batterInfo').querySelector('.player-name');
    const batterRunsEl = document.getElementById('batterRuns');
    const batterBallsEl = document.getElementById('batterBalls');
    const bowlerNameEl = document.getElementById('bowlerInfo').querySelector('.player-name');
    const bowlerOversEl = document.getElementById('bowlerOvers');
    const bowlerWicketsEl = document.getElementById('bowlerWickets');
    const overProgressEl = document.getElementById('overProgress');
    const matchTimelineEl = document.getElementById('matchTimeline');
    const commentaryEl = document.getElementById('commentary');
    const runButtons = document.querySelectorAll('.run-btn');
    const wideBtn = document.getElementById('wideBtn');
    const noballBtn = document.getElementById('noballBtn');
    const wicketBtn = document.getElementById('wicketBtn');
    const submitBtn = document.getElementById('submitBtn');
    
    // Modal elements
    const batterModal = document.getElementById('batterModal');
    const bowlerModal = document.getElementById('bowlerModal');
    const batterListEl = document.getElementById('batterList');
    const bowlerListEl = document.getElementById('bowlerList');
    const confirmBatterBtn = document.getElementById('confirmBatter');
    const confirmBowlerBtn = document.getElementById('confirmBowler');
    
    // Summary modal elements
    const summaryModal = document.getElementById('summaryModal');
    const summaryScoreEl = document.getElementById('summaryScore');
    const summaryHighlightEl = document.getElementById('summaryHighlight');
    const potmEl = document.getElementById('potm');
    const topBatterEl = document.getElementById('topBatter');
    const topBowlerEl = document.getElementById('topBowler');
    const battingTableEl = document.getElementById('battingTable').querySelector('tbody');
    const bowlingTableEl = document.getElementById('bowlingTable').querySelector('tbody');
    const continueToSecondInningsBtn = document.getElementById('continueToSecondInnings');

    // Initialize game
    function initGame() {
      // Set player online status
      if (!isSpectator) {
        set(playerRef, {
          connected: true,
          lastActive: Date.now()
        });
      }

      // Load match data from Firebase
      loadMatchData();
      
      // Set up event listeners
      setupEventListeners();
      
      // Set current date and time
      const now = new Date();
      document.getElementById('matchTime').textContent = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) + 
        ', ' + now.toLocaleDateString();
    }

    // Load match data from Firebase
    function loadMatchData() {
      // Load room data
      onValue(roomRef, (snapshot) => {
        if (snapshot.exists()) {
          const roomData = snapshot.val();
          
          // Set team names and roles
          gameState.team1Name = roomData.player1?.team || 'Team A';
          gameState.team2Name = roomData.player2?.team || 'Team B';
          
          team1NameEl.textContent = gameState.team1Name;
          team2NameEl.textContent = gameState.team2Name;
          
          if (playerRole === 'player1') {
            team1RoleEl.textContent = '(You)';
            team2RoleEl.textContent = '(Opponent)';
          } else if (playerRole === 'player2') {
            team1RoleEl.textContent = '(Opponent)';
            team2RoleEl.textContent = '(You)';
          }
          
          // Set match format
          if (roomData.player1?.format) {
            gameState.matchFormat = roomData.player1.format;
            setMatchFormat(gameState.matchFormat);
            matchFormatEl.textContent = formatName(gameState.matchFormat);
          }
        }
      });
      
      // Load toss data
      onValue(tossRef, (snapshot) => {
        if (snapshot.exists()) {
          const tossData = snapshot.val();
          
          // Determine batting and bowling teams
          if (tossData.battingFirst) {
            gameState.battingTeam = tossData.battingFirst === 'player1' ? 'team1' : 'team2';
            gameState.bowlingTeam = tossData.battingFirst === 'player1' ? 'team2' : 'team1';
            
            // Update UI to show who is batting/bowling
            if (gameState.battingTeam === 'team1') {
              team1RoleEl.textContent += ' (Batting)';
              team2RoleEl.textContent += ' (Bowling)';
            } else {
              team1RoleEl.textContent += ' (Bowling)';
              team2RoleEl.textContent += ' (Batting)';
            }
          }
        }
      });
      
      // Load teams data
      onValue(teamsRef, (snapshot) => {
        if (snapshot.exists()) {
          const teamsData = snapshot.val();
          
          if (teamsData.player1) {
            gameState.team1Players = teamsData.player1.players || [];
            gameState.team1Captain = teamsData.player1.captain || '';
            gameState.team1ViceCaptain = teamsData.player1.viceCaptain || '';
          }
          
          if (teamsData.player2) {
            gameState.team2Players = teamsData.player2.players || [];
            gameState.team2Captain = teamsData.player2.captain || '';
            gameState.team2ViceCaptain = teamsData.player2.viceCaptain || '';
          }
          
          // If we have both teams, we can start the match
          if (teamsData.player1 && teamsData.player2 && !gameState.currentBatter) {
            startNewInnings();
          }
        }
      });
      
      // Load match progress
      onValue(matchRef, (snapshot) => {
        if (snapshot.exists()) {
          const matchData = snapshot.val();
          
          // Check if first innings is complete
          if (matchData.firstInningsComplete && !gameState.inningsComplete) {
            gameState.inningsComplete = true;
            showInningsSummary();
          }
          
          // Check if match is complete
          if (matchData.matchComplete) {
            // Redirect to match summary
            window.location.href = `match_summary.html?id=${roomId}`;
          }
        }
      });
      
      // Load commentary
      onValue(commentaryRef, (snapshot) => {
        if (snapshot.exists()) {
          const commentaryData = snapshot.val();
          updateCommentary(commentaryData);
        }
      });
      
      // Load stats
      onValue(statsRef, (snapshot) => {
        if (snapshot.exists()) {
          const statsData = snapshot.val();
          updateStats(statsData);
        }
      });
    }

    // Set match format and rules
    function setMatchFormat(format) {
      switch (format) {
        case '5': // T5
          gameState.maxOvers = 5;
          gameState.powerplayOvers = 2;
          gameState.deadOvers = [];
          break;
        case '10': // T10
          gameState.maxOvers = 10;
          gameState.powerplayOvers = 3;
          gameState.deadOvers = [];
          break;
        case '20': // T20
          gameState.maxOvers = 20;
          gameState.powerplayOvers = 6;
          gameState.deadOvers = [];
          break;
        case '50': // ODI
          gameState.maxOvers = 50;
          gameState.powerplayOvers = 10;
          gameState.deadOvers = [11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 
                                31, 32, 33, 34, 35, 36, 37, 38, 39, 40];
          break;
        default:
          gameState.maxOvers = 20;
          gameState.powerplayOvers = 6;
          gameState.deadOvers = [];
      }
    }

    // Format name for display
    function formatName(formatKey) {
      const formats = {
        '5': 'T5 (5 Overs)',
        '10': 'T10 (10 Overs)',
        '20': 'T20 (20 Overs)',
        '50': 'ODI (50 Overs)'
      };
      return formats[formatKey] || formatKey;
    }

    // Start a new innings
    function startNewInnings() {
      // Reset innings-specific state
      gameState.currentOver = 0;
      gameState.currentBall = 0;
      gameState.totalRuns = 0;
      gameState.totalWickets = 0;
      gameState.extras = 0;
      gameState.batterStats = {};
      gameState.bowlerStats = {};
      gameState.overHistory = [];
      gameState.isFirstInnings = true;
      gameState.inningsComplete = false;
      
      // Update UI
      updateScoreboard();
      
      // Show batter selection modal
      showBatterSelection();
    }

    // Show batter selection modal
    function showBatterSelection() {
      // Clear previous selections
      batterListEl.innerHTML = '';
      
      // Get the batting team players
      const battingTeamPlayers = gameState.battingTeam === 'team1' ? 
        gameState.team1Players : gameState.team2Players;
      
      // Add players to the list
      battingTeamPlayers.forEach((player, index) => {
        const playerCard = document.createElement('div');
        playerCard.className = 'player-card';
        playerCard.textContent = player;
        playerCard.dataset.player = player;
        
        // Highlight captain and vice-captain
        if (player === (gameState.battingTeam === 'team1' ? gameState.team1Captain : gameState.team2Captain)) {
          playerCard.innerHTML += ' <span class="captain-badge">C</span>';
        } else if (player === (gameState.battingTeam === 'team1' ? gameState.team1ViceCaptain : gameState.team2ViceCaptain)) {
          playerCard.innerHTML += ' <span class="vice-badge">VC</span>';
        }
        
        playerCard.addEventListener('click', () => {
          document.querySelectorAll('#batterList .player-card').forEach(card => {
            card.classList.remove('selected');
          });
          playerCard.classList.add('selected');
          confirmBatterBtn.disabled = false;
          gameState.currentBatter = player;
        });
        
        batterListEl.appendChild(playerCard);
      });
      
      // Show modal
      batterModal.classList.add('active');
    }

    // Show bowler selection modal
    function showBowlerSelection() {
      // Clear previous selections
      bowlerListEl.innerHTML = '';
      
      // Get the bowling team players
      const bowlingTeamPlayers = gameState.bowlingTeam === 'team1' ? 
        gameState.team1Players : gameState.team2Players;
      
      // Add players to the list
      bowlingTeamPlayers.forEach((player, index) => {
        const playerCard = document.createElement('div');
        playerCard.className = 'player-card';
        playerCard.textContent = player;
        playerCard.dataset.player = player;
        
        // Highlight captain and vice-captain
        if (player === (gameState.bowlingTeam === 'team1' ? gameState.team1Captain : gameState.team2Captain)) {
          playerCard.innerHTML += ' <span class="captain-badge">C</span>';
        } else if (player === (gameState.bowlingTeam === 'team1' ? gameState.team1ViceCaptain : gameState.team2ViceCaptain)) {
          playerCard.innerHTML += ' <span class="vice-badge">VC</span>';
        }
        
        playerCard.addEventListener('click', () => {
          document.querySelectorAll('#bowlerList .player-card').forEach(card => {
            card.classList.remove('selected');
          });
          playerCard.classList.add('selected');
          confirmBowlerBtn.disabled = false;
          gameState.currentBowler = player;
        });
        
        bowlerListEl.appendChild(playerCard);
      });
      
      // Show modal
      bowlerModal.classList.add('active');
    }

    // Update scoreboard UI
    function updateScoreboard() {
      scoreRunsEl.textContent = gameState.totalRuns;
      scoreWicketsEl.textContent = gameState.totalWickets;
      
      // Format overs as X.Y (e.g., 4.3 for 4 overs and 3 balls)
      const overs = Math.floor(gameState.currentBall / 6);
      const balls = gameState.currentBall % 6;
      scoreOversEl.textContent = `${overs}.${balls}`;
      
      // Calculate run rate
      const completedOvers = gameState.currentBall / 6;
      const runRate = completedOvers > 0 ? (gameState.totalRuns / completedOvers).toFixed(2) : '0.00';
      runRateEl.textContent = `Run Rate: ${runRate}`;
      
      // Update batter and bowler stats if they exist
      if (gameState.currentBatter && gameState.batterStats[gameState.currentBatter]) {
        const batter = gameState.batterStats[gameState.currentBatter];
        batterNameEl.textContent = gameState.currentBatter;
        batterRunsEl.textContent = batter.runs || 0;
        batterBallsEl.textContent = batter.balls || 0;
      }
      
      if (gameState.currentBowler && gameState.bowlerStats[gameState.currentBowler]) {
        const bowler = gameState.bowlerStats[gameState.currentBowler];
        bowlerNameEl.textContent = gameState.currentBowler;
        bowlerOversEl.textContent = (bowler.balls || 0) / 6;
        bowlerWicketsEl.textContent = bowler.wickets || 0;
      }
      
      // Update over progress
      updateOverProgress();
      
      // Update status indicators
      updateStatusIndicators();
    }

    // Update over progress display
    function updateOverProgress() {
      overProgressEl.innerHTML = '';
      
      // Current over balls
      const currentOverBalls = gameState.currentBall % 6;
      
      // Add balls for current over
      for (let i = 0; i < currentOverBalls; i++) {
        const ball = document.createElement('div');
        ball.className = 'ball ball-dot'; // Default to dot ball, we'll update this later
        ball.textContent = i + 1;
        overProgressEl.appendChild(ball);
      }
      
      // Add empty balls for remaining in over
      for (let i = currentOverBalls; i < 6; i++) {
        const ball = document.createElement('div');
        ball.className = 'ball';
        ball.textContent = i + 1;
        overProgressEl.appendChild(ball);
      }
    }

    // Update status indicators (powerplay, dead over, free hit)
    function updateStatusIndicators() {
      statusIndicatorsEl.innerHTML = '';
      
      // Check powerplay
      const currentOver = Math.floor(gameState.currentBall / 6);
      gameState.isPowerplay = currentOver < gameState.powerplayOvers;
      
      if (gameState.isPowerplay) {
        const indicator = document.createElement('div');
        indicator.className = 'indicator powerplay';
        indicator.textContent = 'Powerplay';
        statusIndicatorsEl.appendChild(indicator);
      }
      
      // Check dead over (ODI format only)
      if (gameState.matchFormat === '50') {
        gameState.isDeadOver = gameState.deadOvers.includes(currentOver + 1); // Overs are 1-indexed
        
        if (gameState.isDeadOver) {
          const indicator = document.createElement('div');
          indicator.className = 'indicator dead-over';
          indicator.textContent = 'Dead Over';
          statusIndicatorsEl.appendChild(indicator);
        }
      }
      
      // Check free hit
      if (gameState.isFreeHit) {
        const indicator = document.createElement('div');
        indicator.className = 'indicator free-hit';
        indicator.textContent = 'Free Hit';
        statusIndicatorsEl.appendChild(indicator);
      }
    }

    // Update match timeline
    function updateTimeline() {
      matchTimelineEl.innerHTML = '';
      
      gameState.overHistory.forEach((over, overIndex) => {
        const overEvent = document.createElement('div');
        overEvent.className = 'event';
        overEvent.textContent = `Over ${overIndex + 1}: ${over.runs}/${over.wickets}`;
        matchTimelineEl.appendChild(overEvent);
        
        // Add ball events if available
        if (over.balls) {
          over.balls.forEach((ball, ballIndex) => {
            const ballEvent = document.createElement('div');
            ballEvent.className = 'event';
            
            if (ball.wicket) {
              ballEvent.classList.add('event-wicket');
              ballEvent.textContent = `${overIndex + 1}.${ballIndex + 1}: Wicket! ${ball.batter} ${ball.description}`;
            } else if (ball.runs >= 4) {
              ballEvent.classList.add('event-boundary');
              ballEvent.textContent = `${overIndex + 1}.${ballIndex + 1}: ${ball.runs} runs`;
            } else {
              ballEvent.textContent = `${overIndex + 1}.${ballIndex + 1}: ${ball.runs} run${ball.runs !== 1 ? 's' : ''}`;
            }
            
            matchTimelineEl.appendChild(ballEvent);
          });
        }
      });
      
      // Scroll to end
      matchTimelineEl.scrollLeft = matchTimelineEl.scrollWidth;
    }

    // Update commentary
    function updateCommentary(commentaryData) {
      commentaryEl.innerHTML = '';
      
      // Convert object to array and sort by timestamp
      const commentaryItems = Object.values(commentaryData).sort((a, b) => a.timestamp - b.timestamp);
      
      commentaryItems.forEach(item => {
        const comment = document.createElement('div');
        comment.className = 'commentary-item';
        comment.innerHTML = `<span class="over-mark">${item.over}</span> ${item.text}`;
        commentaryEl.appendChild(comment);
      });
      
      // Scroll to bottom
      commentaryEl.scrollTop = commentaryEl.scrollHeight;
    }

    // Update stats
    function updateStats(statsData) {
      // This would update any additional stats displays
      // Implementation depends on what stats you want to show
    }

    // Add commentary entry
    function addCommentary(over, ball, text) {
      const newCommentaryRef = push(commentaryRef);
      set(newCommentaryRef, {
        over: `${over}.${ball}`,
        text: text,
        timestamp: Date.now()
      });
    }

    // Show innings summary modal
    function showInningsSummary() {
      // Calculate innings stats
      const totalRuns = gameState.totalRuns;
      const totalWickets = gameState.totalWickets;
      const totalOvers = Math.floor(gameState.currentBall / 6);
      const totalBalls = gameState.currentBall % 6;
      const runRate = (totalRuns / (totalOvers + totalBalls / 6)).toFixed(2);
      
      // Update summary score
      summaryScoreEl.textContent = `${gameState.battingTeam === 'team1' ? gameState.team1Name : gameState.team2Name}: ${totalRuns}/${totalWickets} (${totalOvers}.${totalBalls})`;
      
      // Update highlight
      summaryHighlightEl.textContent = `${gameState.battingTeam === 'team1' ? gameState.team1Name : gameState.team2Name} set a target of ${totalRuns + 1} runs for ${gameState.bowlingTeam === 'team1' ? gameState.team1Name : gameState.team2Name}`;
      
      // Find top batter
      let topBatter = { name: '', runs: 0 };
      Object.entries(gameState.batterStats).forEach(([name, stats]) => {
        if (stats.runs > topBatter.runs) {
          topBatter = { name, runs: stats.runs };
        }
      });
      
      // Find top bowler
      let topBowler = { name: '', wickets: 0 };
      Object.entries(gameState.bowlerStats).forEach(([name, stats]) => {
        if (stats.wickets > topBowler.wickets) {
          topBowler = { name, wickets: stats.wickets };
        }
      });
      
      // Update awards
      potmEl.textContent = topBatter.name; // Simplistic - could be more sophisticated
      topBatterEl.textContent = `${topBatter.name} (${topBatter.runs} runs)`;
      topBowlerEl.textContent = `${topBowler.name} (${topBowler.wickets} wickets)`;
      
      // Update batting table
      battingTableEl.innerHTML = '';
      Object.entries(gameState.batterStats).forEach(([name, stats]) => {
        const row = document.createElement('tr');
        const strikeRate = stats.balls > 0 ? ((stats.runs / stats.balls) * 100).toFixed(2) : '0.00';
        
        row.innerHTML = `
          <td>${name}</td>
          <td>${stats.runs}</td>
          <td>${stats.balls}</td>
          <td>${strikeRate}</td>
        `;
        
        if (name === topBatter.name) {
          row.style.backgroundColor = 'rgba(255, 235, 59, 0.2)';
        }
        
        battingTableEl.appendChild(row);
      });
      
      // Update bowling table
      bowlingTableEl.innerHTML = '';
      Object.entries(gameState.bowlerStats).forEach(([name, stats]) => {
        const row = document.createElement('tr');
        const economy = stats.balls > 0 ? (stats.runsConceded / (stats.balls / 6)).toFixed(2) : '0.00';
        
        row.innerHTML = `
          <td>${name}</td>
          <td>${(stats.balls / 6).toFixed(1)}</td>
          <td>${stats.wickets}</td>
          <td>${economy}</td>
        `;
        
        if (name === topBowler.name) {
          row.style.backgroundColor = 'rgba(255, 235, 59, 0.2)';
        }
        
        bowlingTableEl.appendChild(row);
      });
      
      // Show modal
      summaryModal.classList.add('active');
    }

    // Create confetti effect
    function createConfetti() {
      const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff'];
      const container = document.getElementById('confetti-container');
      
      for (let i = 0; i < 100; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = Math.random() * 100 + 'vw';
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
        confetti.style.width = Math.random() * 10 + 5 + 'px';
        confetti.style.height = Math.random() * 10 + 5 + 'px';
        
        container.appendChild(confetti);
        
        // Animation
        const animation = confetti.animate([
          { top: '-10px', opacity: 1 },
          { top: '100vh', opacity: 0 }
        ], {
          duration: Math.random() * 3000 + 2000,
          easing: 'cubic-bezier(0.1, 0.8, 0.9, 1)'
        });
        
        animation.onfinish = () => {
          confetti.remove();
        };
      }
    }

    // Set up event listeners
    function setupEventListeners() {
      // Run buttons
      runButtons.forEach(button => {
        button.addEventListener('click', () => {
          // Deselect all buttons
          runButtons.forEach(btn => btn.classList.remove('selected'));
          
          // Select clicked button
          button.classList.add('selected');
          gameState.selectedRuns = parseInt(button.dataset.runs);
        });
      });
      
      // Wide button
      wideBtn.addEventListener('click', () => {
        gameState.selectedRuns = 'wide';
        runButtons.forEach(btn => btn.classList.remove('selected'));
      });
      
      // No ball button
      noballBtn.addEventListener('click', () => {
        gameState.selectedRuns = 'noball';
        runButtons.forEach(btn => btn.classList.remove('selected'));
      });
      
      // Wicket button
      wicketBtn.addEventListener('click', () => {
        gameState.selectedRuns = 'wicket';
        runButtons.forEach(btn => btn.classList.remove('selected'));
      });
      
      // Submit button
      submitBtn.addEventListener('click', submitBall);
      
      // Confirm batter selection
      confirmBatterBtn.addEventListener('click', () => {
        if (gameState.currentBatter) {
          // Initialize batter stats if not exists
          if (!gameState.batterStats[gameState.currentBatter]) {
            gameState.batterStats[gameState.currentBatter] = {
              runs: 0,
              balls: 0,
              fours: 0,
              sixes: 0,
              dots: 0
            };
          }
          
          // Close modal
          batterModal.classList.remove('active');
          
          // Show bowler selection if we don't have one yet
          if (!gameState.currentBowler) {
            showBowlerSelection();
          }
        }
      });
      
      // Confirm bowler selection
      confirmBowlerBtn.addEventListener('click', () => {
        if (gameState.currentBowler) {
          // Initialize bowler stats if not exists
          if (!gameState.bowlerStats[gameState.currentBowler]) {
            gameState.bowlerStats[gameState.currentBowler] = {
              balls: 0,
              runsConceded: 0,
              wickets: 0,
              wides: 0,
              noballs: 0
            };
          }
          
          // Close modal
          bowlerModal.classList.remove('active');
        }
      });
      
      // Continue to second innings button
      continueToSecondInningsBtn.addEventListener('click', () => {
        // Save first innings data
        saveInningsData();
        
        // Update match state for second innings
        update(matchRef, {
          firstInningsComplete: true,
          firstInnings: {
            team: gameState.battingTeam === 'team1' ? gameState.team1Name : gameState.team2Name,
            totalRuns: gameState.totalRuns,
            totalWickets: gameState.totalWickets,
            totalBalls: gameState.currentBall,
            batterStats: gameState.batterStats,
            bowlerStats: gameState.bowlerStats
          },
          target: gameState.totalRuns + 1
        }).then(() => {
          // Redirect to second innings
          window.location.href = `game_second_innings.html?room=${roomId}&player=${playerRole}`;
        });
      });
      
      // Handle beforeunload to set player as offline
      window.addEventListener('beforeunload', () => {
        if (!isSpectator) {
          set(playerRef, {
            connected: false,
            lastActive: Date.now()
          });
        }
      });
    }

    // Submit ball result
    function submitBall() {
      if (!gameState.currentBatter || !gameState.currentBowler) {
        alert('Please select both batter and bowler');
        return;
      }
      
      if (gameState.selectedRuns === null && !gameState.isFreeHit) {
        alert('Please select a run value or special condition');
        return;
      }
      
      // Process the ball
      processBall();
      
      // Reset selection
      gameState.selectedRuns = null;
      runButtons.forEach(btn => btn.classList.remove('selected'));
      
      // Check if innings is complete
      checkInningsComplete();
    }

    // Process a ball
    function processBall() {
      const currentOver = Math.floor(gameState.currentBall / 6);
      const currentBallInOver = gameState.currentBall % 6;
      
      // Initialize over in history if needed
      if (!gameState.overHistory[currentOver]) {
        gameState.overHistory[currentOver] = {
          runs: 0,
          wickets: 0,
          balls: []
        };
      }
      
      let runs = 0;
      let isWicket = false;
      let description = '';
      
      // Handle different ball types
      if (gameState.selectedRuns === 'wide') {
        runs = 1;
        gameState.extras += runs;
        description = 'Wide';
        gameState.bowlerStats[gameState.currentBowler].wides += 1;
        gameState.bowlerStats[gameState.currentBowler].runsConceded += runs;
        
        // Add commentary
        addCommentary(currentOver + 1, currentBallInOver + 1, `Wide ball by ${gameState.currentBowler}, ${runs} run${runs !== 1 ? 's' : ''} conceded`);
      } 
      else if (gameState.selectedRuns === 'noball') {
        runs = 1;
        gameState.extras += runs;
        description = 'No ball';
        gameState.bowlerStats[gameState.currentBowler].noballs += 1;
        gameState.bowlerStats[gameState.currentBowler].runsConceded += runs;
        gameState.isFreeHit = true;
        
        // Add commentary
        addCommentary(currentOver + 1, currentBallInOver + 1, `No ball by ${gameState.currentBowler}, free hit coming up!`);
      } 
      else if (gameState.selectedRuns === 'wicket') {
        if (gameState.isFreeHit) {
          // Can't get out on free hit except run out
          description = 'Free hit survived';
          addCommentary(currentOver + 1, currentBallInOver + 1, `${gameState.currentBatter} survives the free hit`);
        } else {
          isWicket = true;
          gameState.totalWickets += 1;
          description = 'Bowled';
          gameState.bowlerStats[gameState.currentBowler].wickets += 1;
          
          // Add commentary
          addCommentary(currentOver + 1, currentBallInOver + 1, `Wicket! ${gameState.currentBowler} bowls ${gameState.currentBatter}`);
          
          // Show wicket animation
          document.body.classList.add('screen-shake');
          setTimeout(() => {
            document.body.classList.remove('screen-shake');
          }, 500);
          
          // Show batter selection for next batter
          setTimeout(() => {
            showBatterSelection();
          }, 1000);
        }
      } 
      else {
        // Normal ball
        runs = gameState.selectedRuns;
        
        if (gameState.isFreeHit) {
          description = 'Free hit - ' + (runs === 0 ? 'dot ball' : `${runs} run${runs !== 1 ? 's' : ''}`);
          gameState.isFreeHit = false;
        } else {
          description = runs === 0 ? 'dot ball' : `${runs} run${runs !== 1 ? 's' : ''}`;
        }
        
        // Update batter stats
        gameState.batterStats[gameState.currentBatter].runs += runs;
        gameState.batterStats[gameState.currentBatter].balls += 1;
        
        if (runs === 0) {
          gameState.batterStats[gameState.currentBatter].dots += 1;
        } else if (runs === 4) {
          gameState.batterStats[gameState.currentBatter].fours += 1;
        } else if (runs === 6) {
          gameState.batterStats[gameState.currentBatter].sixes += 1;
        }
        
        // Update bowler stats
        gameState.bowlerStats[gameState.currentBowler].runsConceded += runs;
        gameState.bowlerStats[gameState.currentBowler].balls += 1;
        
        // Add runs to total
        gameState.totalRuns += runs;
        
        // Add commentary
        addCommentary(currentOver + 1, currentBallInOver + 1, `${gameState.currentBatter} scores ${runs} run${runs !== 1 ? 's' : ''} off ${gameState.currentBowler}`);
        
        // Show boundary celebration for 4 or 6
        if (runs === 4 || runs === 6) {
          scoreRunsEl.classList.add('boundary-celebration');
          setTimeout(() => {
            scoreRunsEl.classList.remove('boundary-celebration');
          }, 500);
        }
      }
      
      // Add ball to over history
      gameState.overHistory[currentOver].balls.push({
        batter: gameState.currentBatter,
        bowler: gameState.currentBowler,
        runs: runs,
        wicket: isWicket,
        description: description
      });
      
      // Update over totals
      gameState.overHistory[currentOver].runs += runs;
      if (isWicket) {
        gameState.overHistory[currentOver].wickets += 1;
      }
      
      // Increment ball count (unless it's a wide or no ball)
      if (gameState.selectedRuns !== 'wide' && gameState.selectedRuns !== 'noball') {
        gameState.currentBall += 1;
      }
      
      // Check if over is complete (6 legal balls)
      if (gameState.currentBall % 6 === 0 && gameState.selectedRuns !== 'wide' && gameState.selectedRuns !== 'noball') {
        // Show bowler selection for next over
        setTimeout(() => {
          showBowlerSelection();
        }, 1000);
      }
      
      // Update UI
      updateScoreboard();
      updateTimeline();
      
      // Show score pop animation
      scoreRunsEl.classList.add('score-pop');
      setTimeout(() => {
        scoreRunsEl.classList.remove('score-pop');
      }, 300);
    }

    // Check if innings is complete
    function checkInningsComplete() {
      const currentOver = Math.floor(gameState.currentBall / 6);
      
      // Innings is complete if:
      // 1. All wickets have fallen (10 wickets)
      // 2. All overs have been bowled
      if (gameState.totalWickets >= 10 || currentOver >= gameState.maxOvers) {
        gameState.inningsComplete = true;
        
        // Save innings data
        saveInningsData();
        
        // Show innings summary
        showInningsSummary();
      }
    }

    // Save innings data to Firebase
    function saveInningsData() {
      const inningsRef = gameState.isFirstInnings ? firstInningsRef : secondInningsRef;
      
      set(inningsRef, {
        team: gameState.battingTeam === 'team1' ? gameState.team1Name : gameState.team2Name,
        totalRuns: gameState.totalRuns,
        totalWickets: gameState.totalWickets,
        totalBalls: gameState.currentBall,
        batterStats: gameState.batterStats,
        bowlerStats: gameState.bowlerStats,
        overHistory: gameState.overHistory,
        complete: true
      });
      
      // Update match status
      update(matchRef, {
        [gameState.isFirstInnings ? 'firstInningsComplete' : 'secondInningsComplete']: true,
        [gameState.isFirstInnings ? 'firstInnings' : 'secondInnings']: {
          team: gameState.battingTeam === 'team1' ? gameState.team1Name : gameState.team2Name,
          totalRuns: gameState.totalRuns,
          totalWickets: gameState.totalWickets,
          totalBalls: gameState.currentBall,
          batterStats: gameState.batterStats,
          bowlerStats: gameState.bowlerStats
        },
        target: gameState.totalRuns + 1
      });
    }

    // Initialize the game
    initGame();
  </script>
</body>
</html>