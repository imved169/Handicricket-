<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HandiCricket - First Innings</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #1e88e5;
      --secondary: #1565c0;
      --success: #4CAF50;
      --danger: #f44336;
      --warning: #ff9800;
      --info: #2196F3;
      --dark: #061e3e;
      --light: #f5f5f5;
      --text-light: #ffffff;
      --text-dark: #333333;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)), url('https://example.com/cricket-stadium.jpg');
      background-size: cover;
      background-position: center;
      color: var(--text-light);
      min-height: 100vh;
      overflow-x: hidden;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Header Section */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 20px;
    }

    .team-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .team-logo {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background-color: rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .team-name {
      font-size: 18px;
      font-weight: bold;
    }

    .vs {
      font-size: 24px;
      font-weight: bold;
      color: var(--warning);
    }

    .match-info {
      text-align: center;
    }

    .match-format {
      font-size: 16px;
      color: var(--warning);
      margin-bottom: 5px;
    }

    .innings-info {
      font-size: 14px;
      color: var(--text-light);
      opacity: 0.8;
    }

    /* Scoreboard Section */
    .scoreboard {
      background: rgba(0, 0, 0, 0.5);
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    .scoreboard-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
    }

    .batting-team {
      font-size: 20px;
      font-weight: bold;
    }

    .score {
      font-size: 36px;
      font-weight: bold;
      text-align: center;
      margin: 10px 0;
    }

    .score-details {
      display: flex;
      justify-content: space-between;
      font-size: 16px;
    }

    .run-rate {
      color: var(--success);
      font-weight: bold;
    }

    /* Over Progress */
    .over-progress {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin: 15px 0;
    }

    .ball {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background-color: rgba(255, 255, 255, 0.2);
      position: relative;
    }

    .ball.dot {
      background-color: var(--light);
    }

    .ball.run-1 {
      background-color: var(--info);
    }

    .ball.run-2 {
      background-color: var(--success);
    }

    .ball.run-4 {
      background-color: var(--warning);
    }

    .ball.run-6 {
      background-color: var(--danger);
    }

    .ball.wicket {
      background-color: var(--danger);
    }

    .ball.wide, .ball.noball {
      background-color: var(--primary);
    }

    .ball::after {
      content: attr(data-ball);
      position: absolute;
      top: -20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 10px;
      color: var(--text-light);
    }

    /* Player Comparison */
    .player-comparison {
      display: flex;
      justify-content: space-between;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      padding: 15px;
      margin: 20px 0;
    }

    .player {
      flex: 1;
      text-align: center;
    }

    .player.active {
      animation: pulse 2s infinite;
    }

    .player-name {
      font-weight: bold;
      font-size: 18px;
      margin-bottom: 5px;
    }

    .player-stats {
      font-size: 14px;
      opacity: 0.8;
    }

    .vs-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      align-self: center;
    }

    /* Game Controls */
    .game-controls {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }

    .control-btn {
      padding: 12px;
      border: none;
      border-radius: 6px;
      background: var(--primary);
      color: var(--text-light);
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }

    .control-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .control-btn:active {
      transform: translateY(0);
    }

    .control-btn.dot {
      background: var(--light);
      color: var(--text-dark);
    }

    .control-btn.run-1 {
      background: var(--info);
    }

    .control-btn.run-2 {
      background: var(--success);
    }

    .control-btn.run-4 {
      background: var(--warning);
    }

    .control-btn.run-6 {
      background: var(--danger);
    }

    .control-btn.wicket {
      background: var(--danger);
    }

    .control-btn.wide {
      background: var(--primary);
    }

    .control-btn.noball {
      background: var(--secondary);
    }

    /* Match Timeline */
    .timeline-container {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .timeline-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .timeline-title {
      font-weight: bold;
    }

    .timeline {
      max-height: 150px;
      overflow-y: auto;
    }

    .timeline-event {
      padding: 5px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .timeline-event.wicket {
      color: var(--danger);
    }

    .timeline-event.boundary {
      color: var(--warning);
    }

    .timeline-event.milestone {
      color: var(--success);
    }

    /* Status Indicators */
    .status-indicators {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .status-badge {
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
    }

    .status-badge.powerplay {
      background: rgba(255, 235, 59, 0.2);
      color: var(--warning);
      animation: pulse 2s infinite;
    }

    .status-badge.dead-over {
      background: rgba(244, 67, 54, 0.2);
      color: var(--danger);
    }

    .status-badge.free-hit {
      background: rgba(76, 175, 80, 0.2);
      color: var(--success);
      animation: pulse 2s infinite;
    }

    /* Player Selection Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }

    .modal.active {
      opacity: 1;
      pointer-events: all;
    }

    .modal-content {
      background: var(--dark);
      border-radius: 10px;
      padding: 20px;
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .modal-title {
      font-size: 20px;
      font-weight: bold;
    }

    .close-modal {
      background: none;
      border: none;
      color: var(--text-light);
      font-size: 24px;
      cursor: pointer;
    }

    .player-list {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    .player-card {
      background: rgba(30, 136, 229, 0.2);
      border-radius: 6px;
      padding: 10px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .player-card:hover {
      background: rgba(30, 136, 229, 0.4);
    }

    .player-card.selected {
      background: rgba(255, 235, 59, 0.3);
      border: 2px solid var(--warning);
    }

    .player-card-name {
      font-weight: bold;
    }

    .player-card-stats {
      font-size: 12px;
      opacity: 0.8;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 20px;
    }

    .confirm-btn {
      padding: 8px 20px;
      background: var(--success);
      color: var(--text-light);
      border: none;
      border-radius: 4px;
      font-weight: bold;
      cursor: pointer;
    }

    /* Wicket Bar */
    .wicket-bars {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin: 15px 0;
    }

    .wicket-bar {
      flex: 1 0 calc(20% - 5px);
      min-width: 100px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      overflow: hidden;
      height: 10px;
    }

    .wicket-progress {
      height: 100%;
      background: var(--danger);
      width: 0%;
      transition: width 0.3s;
    }

    .wicket-label {
      font-size: 10px;
      margin-top: 2px;
      display: flex;
      justify-content: space-between;
    }

    /* Animations */
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
      20%, 40%, 60%, 80% { transform: translateX(5px); }
    }

    .shake {
      animation: shake 0.5s;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        gap: 10px;
      }

      .game-controls {
        grid-template-columns: repeat(2, 1fr);
      }

      .player-list {
        grid-template-columns: 1fr;
      }

      .wicket-bar {
        flex: 1 0 calc(50% - 5px);
      }
    }

    /* Special Effects */
    .confetti {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 999;
      display: none;
    }

    .confetti-piece {
      position: absolute;
      width: 10px;
      height: 10px;
      background: var(--warning);
      opacity: 0;
    }

    .score-popup {
      position: absolute;
      font-size: 24px;
      font-weight: bold;
      color: var(--warning);
      opacity: 0;
      pointer-events: none;
      z-index: 100;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header Section -->
    <div class="header">
      <div class="team-info">
        <div class="team-logo">A</div>
        <div class="team-name" id="team1Name">Team A</div>
      </div>
      
      <div class="vs">VS</div>
      
      <div class="team-info">
        <div class="team-logo">B</div>
        <div class="team-name" id="team2Name">Team B</div>
      </div>
      
      <div class="match-info">
        <div class="match-format" id="matchFormat">T20 Match</div>
        <div class="innings-info" id="inningsInfo">1st Innings</div>
      </div>
    </div>

    <!-- Status Indicators -->
    <div class="status-indicators">
      <div class="status-badge powerplay" id="powerplayBadge" style="display: none;">POWERPLAY</div>
      <div class="status-badge dead-over" id="deadOverBadge" style="display: none;">DEAD OVER</div>
      <div class="status-badge free-hit" id="freeHitBadge" style="display: none;">FREE HIT</div>
    </div>

    <!-- Scoreboard Section -->
    <div class="scoreboard">
      <div class="scoreboard-header">
        <div class="batting-team" id="battingTeamName">Batting: Team A</div>
        <div class="run-rate" id="runRate">RR: 0.00</div>
      </div>
      
      <div class="score" id="scoreDisplay">0/0</div>
      
      <div class="score-details">
        <div id="oversDisplay">Overs: 0.0</div>
        <div id="targetDisplay" style="display: none;">Target: 0</div>
      </div>
      
      <!-- Over Progress -->
      <div class="over-progress" id="overProgress"></div>
      
      <!-- Wicket Bars -->
      <div class="wicket-bars" id="wicketBars"></div>
    </div>

    <!-- Player Comparison -->
    <div class="player-comparison">
      <div class="player" id="batterInfo">
        <div class="player-name" id="batterName">Batter</div>
        <div class="player-stats" id="batterStats">0 (0)</div>
      </div>
      
      <div class="vs-circle">VS</div>
      
      <div class="player" id="bowlerInfo">
        <div class="player-name" id="bowlerName">Bowler</div>
        <div class="player-stats" id="bowlerStats">0-0-0</div>
      </div>
    </div>

    <!-- Game Controls -->
    <div class="game-controls">
      <button class="control-btn dot" data-run="0">0</button>
      <button class="control-btn run-1" data-run="1">1</button>
      <button class="control-btn run-2" data-run="2">2</button>
      <button class="control-btn run-4" data-run="4">4</button>
      <button class="control-btn run-6" data-run="6">6</button>
      <button class="control-btn wicket" data-run="W">W</button>
      <button class="control-btn wide" data-run="Wd">Wd</button>
      <button class="control-btn noball" data-run="Nb">Nb</button>
    </div>

    <!-- Match Timeline -->
    <div class="timeline-container">
      <div class="timeline-header">
        <div class="timeline-title">Match Timeline</div>
        <div id="partnershipDisplay">Partnership: 0 (0)</div>
      </div>
      <div class="timeline" id="matchTimeline"></div>
    </div>

    <!-- Control Buttons -->
    <div style="display: flex; gap: 10px; margin-top: 20px;">
      <button class="control-btn" id="showTeamsBtn" style="background: var(--warning);">Show Teams</button>
      <button class="control-btn" id="timeoutBtn" style="background: var(--info);">Timeout</button>
      <button class="control-btn" id="endInningsBtn" style="background: var(--danger); display: none;">End Innings</button>
    </div>
  </div>

  <!-- Player Selection Modal -->
  <div class="modal" id="playerModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">Select Player</div>
        <button class="close-modal" id="closeModal">&times;</button>
      </div>
      <div class="player-list" id="modalPlayerList"></div>
      <div class="modal-actions">
        <button class="confirm-btn" id="confirmSelection">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Teams Modal -->
  <div class="modal" id="teamsModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Teams</div>
        <button class="close-modal" id="closeTeamsModal">&times;</button>
      </div>
      <div style="display: flex; gap: 20px; margin-bottom: 15px;">
        <div style="flex: 1;">
          <h3 id="team1ModalName">Team A</h3>
          <div id="team1Players"></div>
        </div>
        <div style="flex: 1;">
          <h3 id="team2ModalName">Team B</h3>
          <div id="team2Players"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Confetti Effect -->
  <div class="confetti" id="confetti"></div>

  <!-- Score Popup -->
  <div class="score-popup" id="scorePopup">+4</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, get, push, remove } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCN6aZMwlsZe7JJaovU0WA3UQygWr4jYmA",
      authDomain: "handicricket-85a06.firebaseapp.com",
      projectId: "handicricket-85a06",
      storageBucket: "handicricket-85a06.appspot.com",
      messagingSenderId: "599182538558",
      appId: "1:599182538558:web:3e965753ab05f8f1e3de6f",
      measurementId: "G-HSV9H4LEJQ"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Get URL parameters
    const params = new URLSearchParams(window.location.search);
    const roomId = params.get('room');
    const playerRole = params.get('player'); // player1 or player2
    const innings = params.get('innings') || '1'; // 1 or 2

    if (!roomId || !playerRole) {
      alert('Invalid room or player');
      window.location.href = 'index.html';
    }

    // Firebase references
    const roomRef = ref(db, `rooms/${roomId}`);
    const gameRef = ref(db, `rooms/${roomId}/game`);
    const teamsRef = ref(db, `rooms/${roomId}/teams`);
    const tossRef = ref(db, `rooms/${roomId}/toss`);
    const playerRef = ref(db, `rooms/${roomId}/${playerRole}`);
    const opponentRef = ref(db, `rooms/${roomId}/${playerRole === 'player1' ? 'player2' : 'player1'}`);
    const commentaryRef = ref(db, `rooms/${roomId}/commentary`);
    const timelineRef = ref(db, `rooms/${roomId}/timeline`);

    // Game state
    let gameState = {
      battingTeam: null,
      bowlingTeam: null,
      currentBatter: null,
      currentBowler: null,
      runs: 0,
      wickets: 0,
      balls: 0,
      overs: 0,
      extras: 0,
      batterStats: {},
      bowlerStats: {},
      team1Players: [],
      team2Players: [],
      team1Name: '',
      team2Name: '',
      format: 'T20',
      maxOvers: 20,
      powerplayOvers: 6,
      isPowerplay: true,
      isDeadOver: false,
      isFreeHit: false,
      currentOver: [],
      partnershipRuns: 0,
      partnershipBalls: 0,
      lastWicketScore: 0,
      target: 0,
      innings: parseInt(innings),
      playerWickets: {}, // Track wickets per player
      selectedRun: null,
      selectedDelivery: null,
      gameStarted: false,
      tossWinner: null,
      battingFirst: null,
      battingChoice: null
    };

    // DOM elements
    const team1NameEl = document.getElementById('team1Name');
    const team2NameEl = document.getElementById('team2Name');
    const battingTeamNameEl = document.getElementById('battingTeamName');
    const scoreDisplayEl = document.getElementById('scoreDisplay');
    const oversDisplayEl = document.getElementById('oversDisplay');
    const targetDisplayEl = document.getElementById('targetDisplay');
    const runRateEl = document.getElementById('runRate');
    const overProgressEl = document.getElementById('overProgress');
    const wicketBarsEl = document.getElementById('wicketBars');
    const batterNameEl = document.getElementById('batterName');
    const batterStatsEl = document.getElementById('batterStats');
    const bowlerNameEl = document.getElementById('bowlerName');
    const bowlerStatsEl = document.getElementById('bowlerStats');
    const matchFormatEl = document.getElementById('matchFormat');
    const inningsInfoEl = document.getElementById('inningsInfo');
    const matchTimelineEl = document.getElementById('matchTimeline');
    const partnershipDisplayEl = document.getElementById('partnershipDisplay');
    const powerplayBadgeEl = document.getElementById('powerplayBadge');
    const deadOverBadgeEl = document.getElementById('deadOverBadge');
    const freeHitBadgeEl = document.getElementById('freeHitBadge');
    const endInningsBtnEl = document.getElementById('endInningsBtn');
    const showTeamsBtnEl = document.getElementById('showTeamsBtn');
    const timeoutBtnEl = document.getElementById('timeoutBtn');

    // Modal elements
    const playerModalEl = document.getElementById('playerModal');
    const modalTitleEl = document.getElementById('modalTitle');
    const modalPlayerListEl = document.getElementById('modalPlayerList');
    const closeModalEl = document.getElementById('closeModal');
    const confirmSelectionEl = document.getElementById('confirmSelection');
    const teamsModalEl = document.getElementById('teamsModal');
    const team1ModalNameEl = document.getElementById('team1ModalName');
    const team2ModalNameEl = document.getElementById('team2ModalName');
    const team1PlayersEl = document.getElementById('team1Players');
    const team2PlayersEl = document.getElementById('team2Players');
    const closeTeamsModalEl = document.getElementById('closeTeamsModal');

    // Special effects
    const confettiEl = document.getElementById('confetti');
    const scorePopupEl = document.getElementById('scorePopup');

    // Initialize game
    async function initGame() {
      try {
        // Set player online status
        await set(playerRef, {
          connected: true,
          ready: false,
          selectedRun: null,
          selectedDelivery: null
        });

        // Load room data
        const roomSnap = await get(roomRef);
        if (!roomSnap.exists()) {
          alert('Room not found');
          window.location.href = 'index.html';
          return;
        }

        const roomData = roomSnap.val();
        
        // Load teams data
        const teamsSnap = await get(teamsRef);
        if (!teamsSnap.exists()) {
          alert('Teams not set up');
          window.location.href = 'index.html';
          return;
        }

        const teamsData = teamsSnap.val();
        
        // Load toss data
        const tossSnap = await get(tossRef);
        if (!tossSnap.exists()) {
          alert('Toss not completed');
          window.location.href = 'index.html';
          return;
        }

        const tossData = tossSnap.val();

        // Set game state from room data
        gameState.team1Name = roomData.player1.team;
        gameState.team2Name = roomData.player2.team;
        gameState.team1Players = teamsData.player1.players;
        gameState.team2Players = teamsData.player2.players;
        gameState.format = roomData.player1.format || 'T20';
        gameState.tossWinner = tossData.winner;
        gameState.battingFirst = tossData.battingFirst;
        gameState.battingChoice = tossData.battingChoice;

        // Set match format parameters
        setFormatParameters();

        // Determine batting and bowling teams based on innings
        if (gameState.innings === 1) {
          gameState.battingTeam = gameState.battingFirst === 'player1' ? 'player1' : 'player2';
          gameState.bowlingTeam = gameState.battingFirst === 'player1' ? 'player2' : 'player1';
        } else {
          gameState.battingTeam = gameState.battingFirst === 'player1' ? 'player2' : 'player1';
          gameState.bowlingTeam = gameState.battingFirst === 'player1' ? 'player1' : 'player2';
          // Load target from first innings
          const gameSnap = await get(gameRef);
          if (gameSnap.exists() && gameSnap.val().firstInnings) {
            gameState.target = gameSnap.val().firstInnings.runs + 1;
            targetDisplayEl.textContent = `Target: ${gameState.target}`;
            targetDisplayEl.style.display = 'block';
          }
        }

        // Initialize wicket tracking for all players
        gameState.team1Players.forEach(player => {
          gameState.playerWickets[player] = 0;
        });
        gameState.team2Players.forEach(player => {
          gameState.playerWickets[player] = 0;
        });

        // Update UI
        updateTeamNames();
        updateWicketBars();
        matchFormatEl.textContent = `${gameState.format} Match`;
        inningsInfoEl.textContent = gameState.innings === 1 ? '1st Innings' : '2nd Innings';

        // Set up real-time listeners
        setupListeners();

        // Show batter selection modal if needed
        if (!gameState.currentBatter) {
          showBatterSelection();
        }

        // Show bowler selection modal if needed
        if (!gameState.currentBowler) {
          showBowlerSelection();
        }

      } catch (error) {
        console.error('Error initializing game:', error);
        alert('Error initializing game. Please try again.');
      }
    }

    // Set format-specific parameters
    function setFormatParameters() {
      switch (gameState.format) {
        case '5':
          gameState.maxOvers = 5;
          gameState.powerplayOvers = 2;
          break;
        case '10':
          gameState.maxOvers = 10;
          gameState.powerplayOvers = 3;
          break;
        case '20':
          gameState.maxOvers = 20;
          gameState.powerplayOvers = 6;
          break;
        case '50':
          gameState.maxOvers = 50;
          gameState.powerplayOvers = 10; // First powerplay
          break;
        default:
          gameState.maxOvers = 20;
          gameState.powerplayOvers = 6;
      }
    }

    // Update team names in UI
    function updateTeamNames() {
      team1NameEl.textContent = gameState.team1Name;
      team2NameEl.textContent = gameState.team2Name;
      
      const battingTeamName = gameState.battingTeam === 'player1' ? gameState.team1Name : gameState.team2Name;
      const bowlingTeamName = gameState.battingTeam === 'player1' ? gameState.team2Name : gameState.team1Name;
      
      battingTeamNameEl.textContent = `Batting: ${battingTeamName}`;
      team1ModalNameEl.textContent = gameState.team1Name;
      team2ModalNameEl.textContent = gameState.team2Name;
      
      // Update teams modal
      team1PlayersEl.innerHTML = gameState.team1Players.map(player => 
        `<div class="player-card">
          <div class="player-card-name">${player}</div>
          <div class="player-card-stats">Wickets: ${gameState.playerWickets[player] || 0}</div>
        </div>`
      ).join('');
      
      team2PlayersEl.innerHTML = gameState.team2Players.map(player => 
        `<div class="player-card">
          <div class="player-card-name">${player}</div>
          <div class="player-card-stats">Wickets: ${gameState.playerWickets[player] || 0}</div>
        </div>`
      ).join('');
    }

    // Update wicket bars in UI
    function updateWicketBars() {
      wicketBarsEl.innerHTML = '';
      
      const battingTeamPlayers = gameState.battingTeam === 'player1' ? 
        gameState.team1Players : gameState.team2Players;
      
      battingTeamPlayers.forEach(player => {
        const wicketValue = gameState.playerWickets[player] || 0;
        const barContainer = document.createElement('div');
        barContainer.className = 'wicket-bar';
        
        const barProgress = document.createElement('div');
        barProgress.className = 'wicket-progress';
        barProgress.style.width = `${Math.min(wicketValue * 100, 100)}%`;
        
        const barLabel = document.createElement('div');
        barLabel.className = 'wicket-label';
        barLabel.innerHTML = `
          <span>${player}</span>
          <span>${wicketValue.toFixed(2)}</span>
        `;
        
        barContainer.appendChild(barProgress);
        barContainer.appendChild(barLabel);
        wicketBarsEl.appendChild(barContainer);
      });
    }

    // Set up real-time Firebase listeners
    function setupListeners() {
      // Listen for game state changes
      onValue(gameRef, (snap) => {
        if (snap.exists()) {
          const gameData = snap.val();
          
          // Update scoreboard
          if (gameData.currentInnings) {
            const inningsData = gameState.innings === 1 ? 
              gameData.firstInnings : gameData.secondInnings;
            
            if (inningsData) {
              gameState.runs = inningsData.runs || 0;
              gameState.wickets = inningsData.wickets || 0;
              gameState.balls = inningsData.balls || 0;
              gameState.overs = Math.floor(gameState.balls / 6);
              gameState.extras = inningsData.extras || 0;
              gameState.currentOver = inningsData.currentOver || [];
              gameState.partnershipRuns = inningsData.partnershipRuns || 0;
              gameState.partnershipBalls = inningsData.partnershipBalls || 0;
              gameState.lastWicketScore = inningsData.lastWicketScore || 0;
              
              updateScoreboard();
              updateOverProgress();
            }
          }
          
          // Update current players
          if (gameData.currentBatter) {
            gameState.currentBatter = gameData.currentBatter;
            updateBatterInfo();
          }
          
          if (gameData.currentBowler) {
            gameState.currentBowler = gameData.currentBowler;
            updateBowlerInfo();
          }
          
          // Update player stats
          if (gameData.batterStats) {
            gameState.batterStats = gameData.batterStats;
            updateBatterInfo();
          }
          
          if (gameData.bowlerStats) {
            gameState.bowlerStats = gameData.bowlerStats;
            updateBowlerInfo();
          }
          
          // Update player wickets
          if (gameData.playerWickets) {
            gameState.playerWickets = gameData.playerWickets;
            updateWicketBars();
          }
          
          // Check for powerplay/dead over status
          checkOverStatus();
        }
      });
      
      // Listen for commentary
      onValue(commentaryRef, (snap) => {
        if (snap.exists()) {
          const commentary = snap.val();
          matchTimelineEl.innerHTML = Object.values(commentary)
            .map(event => `<div class="timeline-event ${event.type}">${event.text}</div>`)
            .join('');
          matchTimelineEl.scrollTop = matchTimelineEl.scrollHeight;
        }
      });
      
      // Listen for opponent actions
      onValue(opponentRef, (snap) => {
        if (!snap.exists() || !snap.val().connected) {
          alert('Opponent disconnected');
          window.location.href = 'index.html';
        }
      });
    }

    // Update scoreboard UI
    function updateScoreboard() {
      scoreDisplayEl.textContent = `${gameState.runs}/${gameState.wickets}`;
      oversDisplayEl.textContent = `Overs: ${Math.floor(gameState.balls / 6)}.${gameState.balls % 6}`;
      
      const runRate = gameState.overs > 0 ? 
        (gameState.runs / gameState.overs).toFixed(2) : 0.00;
      runRateEl.textContent = `RR: ${runRate}`;
      
      partnershipDisplayEl.textContent = 
        `Partnership: ${gameState.partnershipRuns} (${gameState.partnershipBalls})`;
    }

    // Update over progress UI
    function updateOverProgress() {
      overProgressEl.innerHTML = '';
      
      for (let i = 0; i < 6; i++) {
        const ball = document.createElement('div');
        ball.className = 'ball';
        
        if (i < gameState.currentOver.length) {
          const ballEvent = gameState.currentOver[i];
          ball.classList.add(getBallClass(ballEvent));
          ball.setAttribute('data-ball', ballEvent);
        }
        
        overProgressEl.appendChild(ball);
      }
    }

    // Get CSS class for ball based on event
    function getBallClass(event) {
      if (event === 'W') return 'wicket';
      if (event === 'Wd') return 'wide';
      if (event === 'Nb') return 'noball';
      if (event === '0') return 'dot';
      if (event === '1') return 'run-1';
      if (event === '2') return 'run-2';
      if (event === '4') return 'run-4';
      if (event === '6') return 'run-6';
      return '';
    }

    // Update batter info UI
    function updateBatterInfo() {
      if (!gameState.currentBatter) return;
      
      batterNameEl.textContent = gameState.currentBatter;
      
      const batterStats = gameState.batterStats[gameState.currentBatter] || {};
      const runs = batterStats.runs || 0;
      const balls = batterStats.balls || 0;
      const strikeRate = balls > 0 ? ((runs / balls) * 100).toFixed(2) : 0.00;
      
      batterStatsEl.textContent = `${runs} (${balls}) SR: ${strikeRate}`;
      
      // Highlight active player
      if (playerRole === gameState.battingTeam) {
        batterNameEl.classList.add('active');
      } else {
        batterNameEl.classList.remove('active');
      }
    }

    // Update bowler info UI
    function updateBowlerInfo() {
      if (!gameState.currentBowler) return;
      
      bowlerNameEl.textContent = gameState.currentBowler;
      
      const bowlerStats = gameState.bowlerStats[gameState.currentBowler] || {};
      const runs = bowlerStats.runs || 0;
      const wickets = bowlerStats.wickets || 0;
      const overs = bowlerStats.overs || 0;
      const economy = overs > 0 ? (runs / overs).toFixed(2) : 0.00;
      
      bowlerStatsEl.textContent = `${overs}-${wickets}-${runs} ER: ${economy}`;
      
      // Highlight active player
      if (playerRole === gameState.bowlingTeam) {
        bowlerNameEl.classList.add('active');
      } else {
        bowlerNameEl.classList.remove('active');
      }
    }

    // Check powerplay/dead over status
    function checkOverStatus() {
      const currentOver = Math.floor(gameState.balls / 6);
      
      // Powerplay status
      if (currentOver < gameState.powerplayOvers) {
        gameState.isPowerplay = true;
        powerplayBadgeEl.style.display = 'block';
      } else {
        gameState.isPowerplay = false;
        powerplayBadgeEl.style.display = 'none';
      }
      
      // Dead over status (ODI only)
      if (gameState.format === '50') {
        // Dead overs in ODI: 11-20 and 31-40
        if ((currentOver >= 10 && currentOver < 20) || 
            (currentOver >= 30 && currentOver < 40)) {
          gameState.isDeadOver = true;
          deadOverBadgeEl.style.display = 'block';
        } else {
          gameState.isDeadOver = false;
          deadOverBadgeEl.style.display = 'none';
        }
      } else {
        gameState.isDeadOver = false;
        deadOverBadgeEl.style.display = 'none';
      }
      
      // Free hit status
      if (gameState.isFreeHit) {
        freeHitBadgeEl.style.display = 'block';
      } else {
        freeHitBadgeEl.style.display = 'none';
      }
    }

    // Show batter selection modal
    function showBatterSelection() {
      modalTitleEl.textContent = 'Select Batter';
      modalPlayerListEl.innerHTML = '';
      
      const battingTeamPlayers = gameState.battingTeam === 'player1' ? 
        gameState.team1Players : gameState.team2Players;
      
      battingTeamPlayers.forEach(player => {
        // Skip if player is already out (wicket value >= 1.0)
        if ((gameState.playerWickets[player] || 0) >= 1.0) return;
        
        const playerCard = document.createElement('div');
        playerCard.className = 'player-card';
        playerCard.innerHTML = `
          <div class="player-card-name">${player}</div>
          <div class="player-card-stats">Wickets: ${gameState.playerWickets[player] || 0}</div>
        `;
        
        playerCard.addEventListener('click', () => {
          document.querySelectorAll('.player-card').forEach(card => {
            card.classList.remove('selected');
          });
          playerCard.classList.add('selected');
          gameState.currentBatter = player;
        });
        
        modalPlayerListEl.appendChild(playerCard);
      });
      
      playerModalEl.classList.add('active');
    }

    // Show bowler selection modal
    function showBowlerSelection() {
      modalTitleEl.textContent = 'Select Bowler';
      modalPlayerListEl.innerHTML = '';
      
      const bowlingTeamPlayers = gameState.bowlingTeam === 'player1' ? 
        gameState.team1Players : gameState.team2Players;
      
      bowlingTeamPlayers.forEach(player => {
        const playerCard = document.createElement('div');
        playerCard.className = 'player-card';
        playerCard.innerHTML = `
          <div class="player-card-name">${player}</div>
          <div class="player-card-stats">Wickets: ${gameState.bowlerStats[player]?.wickets || 0}</div>
        `;
        
        playerCard.addEventListener('click', () => {
          document.querySelectorAll('.player-card').forEach(card => {
            card.classList.remove('selected');
          });
          playerCard.classList.add('selected');
          gameState.currentBowler = player;
        });
        
        modalPlayerListEl.appendChild(playerCard);
      });
      
      playerModalEl.classList.add('active');
    }

    // Confirm player selection
    confirmSelectionEl.addEventListener('click', async () => {
      if (!gameState.currentBatter && !gameState.currentBowler) {
        alert('Please select a player');
        return;
      }
      
      try {
        if (modalTitleEl.textContent.includes('Batter')) {
          await update(gameRef, {
            currentBatter: gameState.currentBatter
          });
        } else {
          await update(gameRef, {
            currentBowler: gameState.currentBowler
          });
        }
        
        playerModalEl.classList.remove('active');
      } catch (error) {
        console.error('Error updating player selection:', error);
        alert('Error selecting player. Please try again.');
      }
    });

    // Close modal
    closeModalEl.addEventListener('click', () => {
      playerModalEl.classList.remove('active');
    });

    // Show teams modal
    showTeamsBtnEl.addEventListener('click', () => {
      teamsModalEl.classList.add('active');
    });

    // Close teams modal
    closeTeamsModalEl.addEventListener('click', () => {
      teamsModalEl.classList.remove('active');
    });

    // Handle run selection
    document.querySelectorAll('.control-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        if (playerRole !== gameState.battingTeam && playerRole !== gameState.bowlingTeam) {
          alert('You are a spectator and cannot play');
          return;
        }
        
        const run = btn.getAttribute('data-run');
        
        if (playerRole === gameState.battingTeam) {
          // Batting team selects runs
          gameState.selectedRun = run;
          await update(playerRef, {
            selectedRun: run
          });
        } else {
          // Bowling team selects delivery
          gameState.selectedDelivery = run;
          await update(playerRef, {
            selectedDelivery: run
          });
        }
        
        // Check if both players have made selections
        checkBallOutcome();
      });
    });

    // Check ball outcome when both players have selected
    async function checkBallOutcome() {
      const playerSnap = await get(playerRef);
      const opponentSnap = await get(opponentRef);
      
      if (!playerSnap.exists() || !opponentSnap.exists()) return;
      
      const playerData = playerSnap.val();
      const opponentData = opponentSnap.val();
      
      // Determine which player is batting and which is bowling
      const battingPlayer = playerRole === gameState.battingTeam ? playerData : opponentData;
      const bowlingPlayer = playerRole === gameState.bowlingTeam ? playerData : opponentData;
      
      if (battingPlayer.selectedRun && bowlingPlayer.selectedDelivery) {
        // Both players have made selections - process the ball
        await processBall(battingPlayer.selectedRun, bowlingPlayer.selectedDelivery);
        
        // Reset selections
        await update(playerRef, {
          selectedRun: null,
          selectedDelivery: null
        });
        
        await update(opponentRef, {
          selectedRun: null,
          selectedDelivery: null
        });
      }
    }

    // Process ball outcome
    async function processBall(battingChoice, bowlingChoice) {
      let runs = 0;
      let isWicket = false;
      let isWide = false;
      let isNoBall = false;
      let commentaryText = '';
      
      // Handle wides and no-balls first
      if (bowlingChoice === 'Wd') {
        isWide = true;
        runs = 1;
        commentaryText = `Wide ball! ${runs} run${runs > 1 ? 's' : ''} conceded.`;
      } else if (bowlingChoice === 'Nb') {
        isNoBall = true;
        runs = 1;
        commentaryText = `No ball! Free hit coming up. ${runs} run${runs > 1 ? 's' : ''} conceded.`;
      } else {
        // Normal ball - compare batting and bowling choices
        if (battingChoice === bowlingChoice) {
          // Wicket - batter is out
          isWicket = true;
          
          // Check if it's a free hit (can't be out except run out)
          if (gameState.isFreeHit) {
            isWicket = false;
            commentaryText = `Free hit saved the batter!`;
          } else {
            // Calculate wicket value based on format and over status
            let wicketValue = 0;
            
            if (gameState.format === '50') {
              // ODI format
              if (gameState.isPowerplay) {
                wicketValue = 0.25;
              } else if (gameState.isDeadOver) {
                wicketValue = 0.5;
              } else {
                wicketValue = 0.5;
              }
            } else {
              // T20, T10, T5 formats
              if (gameState.isPowerplay) {
                wicketValue = 0.5;
              } else {
                wicketValue = 1.0;
              }
            }
            
            // Add to player's wicket count
            const currentWickets = gameState.playerWickets[gameState.currentBatter] || 0;
            const newWickets = currentWickets + wicketValue;
            
            // Update player wickets
            gameState.playerWickets[gameState.currentBatter] = newWickets;
            
            // Check if player is out (wicket value >= 1.0)
            if (newWickets >= 1.0) {
              commentaryText = `${gameState.currentBatter} is out!`;
              gameState.wickets++;
              
              // Add to bowler's wickets
              if (gameState.currentBowler) {
                if (!gameState.bowlerStats[gameState.currentBowler]) {
                  gameState.bowlerStats[gameState.currentBowler] = {
                    wickets: 0,
                    runs: 0,
                    overs: 0
                  };
                }
                gameState.bowlerStats[gameState.currentBowler].wickets++;
              }
              
              // Reset partnership
              gameState.lastWicketScore = gameState.runs;
              gameState.partnershipRuns = 0;
              gameState.partnershipBalls = 0;
              
              // Check if innings is over (all wickets lost)
              const battingTeamPlayers = gameState.battingTeam === 'player1' ? 
                gameState.team1Players : gameState.team2Players;
              
              const allOut = battingTeamPlayers.every(player => {
                return (gameState.playerWickets[player] || 0) >= 1.0;
              });
              
              if (allOut) {
                commentaryText = `All out! ${gameState.team1Name} ${gameState.runs}/${gameState.wickets}`;
                await endInnings();
                return;
              }
              
              // Show batter selection modal
              showBatterSelection();
            } else {
              commentaryText = `${gameState.currentBatter} loses ${wicketValue} wicket value!`;
            }
          }
        } else {
          // Runs scored
          runs = parseInt(battingChoice);
          
          // Update batter stats
          if (!gameState.batterStats[gameState.currentBatter]) {
            gameState.batterStats[gameState.currentBatter] = {
              runs: 0,
              balls: 0,
              fours: 0,
              sixes: 0
            };
          }
          
          gameState.batterStats[gameState.currentBatter].runs += runs;
          gameState.batterStats[gameState.currentBatter].balls++;
          
          if (runs === 4) {
            gameState.batterStats[gameState.currentBatter].fours++;
            commentaryText = `${gameState.currentBatter} hits a FOUR!`;
            showBoundaryAnimation();
          } else if (runs === 6) {
            gameState.batterStats[gameState.currentBatter].sixes++;
            commentaryText = `${gameState.currentBatter} hits a SIX!`;
            showBoundaryAnimation();
          } else {
            commentaryText = `${gameState.currentBatter} scores ${runs} run${runs > 1 ? 's' : ''}.`;
          }
          
          // Update partnership
          gameState.partnershipRuns += runs;
          gameState.partnershipBalls++;
          
          // Check for milestones
          checkMilestones(gameState.batterStats[gameState.currentBatter].runs);
        }
      }
      
      // Update runs if not a wicket
      if (!isWicket) {
        gameState.runs += runs;
        showScorePopup(runs);
      }
      
      // Update balls bowled (except wides and no-balls)
      if (!isWide && !isNoBall) {
        gameState.balls++;
        
        // Update bowler stats
        if (gameState.currentBowler) {
          if (!gameState.bowlerStats[gameState.currentBowler]) {
            gameState.bowlerStats[gameState.currentBowler] = {
              wickets: 0,
              runs: 0,
              overs: 0
            };
          }
          
          gameState.bowlerStats[gameState.currentBowler].runs += runs;
          
          // Calculate overs (integer part is overs, decimal is balls)
          const ballsBowled = (gameState.bowlerStats[gameState.currentBowler].overs * 6) + 1;
          gameState.bowlerStats[gameState.currentBowler].overs = Math.floor(ballsBowled / 6) + 
            (ballsBowled % 6) / 10;
        }
      }
      
      // Update extras
      if (isWide || isNoBall) {
        gameState.extras += runs;
      }
      
      // Update current over
      let ballEvent = isWicket ? 'W' : 
                     isWide ? 'Wd' : 
                     isNoBall ? 'Nb' : 
                     battingChoice;
      
      gameState.currentOver.push(ballEvent);
      
      // Check if over is complete (6 legal balls)
      const legalBalls = gameState.currentOver.filter(ball => ball !== 'Wd' && ball !== 'Nb').length;
      if (legalBalls >= 6) {
        commentaryText += ` Over complete.`;
        gameState.currentOver = [];
        
        // Show bowler selection modal for next over
        showBowlerSelection();
      }
      
      // Check if innings is complete (all overs bowled)
      if (Math.floor(gameState.balls / 6) >= gameState.maxOvers) {
        commentaryText = `Innings complete! ${gameState.team1Name} ${gameState.runs}/${gameState.wickets}`;
        await endInnings();
        return;
      }
      
      // Set free hit for next ball if no-ball
      gameState.isFreeHit = isNoBall;
      
      // Add commentary
      const over = Math.floor(gameState.balls / 6);
      const ball = (gameState.balls % 6) || 6;
      
      const commentaryEvent = {
        text: `Over ${over}.${ball}: ${commentaryText}`,
        type: isWicket ? 'wicket' : 
              runs >= 4 ? 'boundary' : 
              'normal',
        timestamp: Date.now()
      };
      
      await push(commentaryRef, commentaryEvent);
      
      // Update game state in Firebase
      const inningsKey = gameState.innings === 1 ? 'firstInnings' : 'secondInnings';
      
      await update(gameRef, {
        [inningsKey]: {
          runs: gameState.runs,
          wickets: gameState.wickets,
          balls: gameState.balls,
          extras: gameState.extras,
          currentOver: gameState.currentOver,
          partnershipRuns: gameState.partnershipRuns,
          partnershipBalls: gameState.partnershipBalls,
          lastWicketScore: gameState.lastWicketScore
        },
        batterStats: gameState.batterStats,
        bowlerStats: gameState.bowlerStats,
        playerWickets: gameState.playerWickets,
        isFreeHit: gameState.isFreeHit
      });
      
      // Update UI
      updateScoreboard();
      updateOverProgress();
      updateBatterInfo();
      updateBowlerInfo();
      checkOverStatus();
    }

    // Check for batting milestones
    function checkMilestones(runs) {
      if (runs === 50) {
        addCommentary(`${gameState.currentBatter} reaches 50! What an innings!`, 'milestone');
        showConfetti();
      } else if (runs === 100) {
        addCommentary(`CENTURY for ${gameState.currentBatter}! Magnificent batting!`, 'milestone');
        showConfetti();
      }
    }

    // Add commentary
    async function addCommentary(text, type) {
      const over = Math.floor(gameState.balls / 6);
      const ball = (gameState.balls % 6) || 6;
      
      const commentaryEvent = {
        text: `Over ${over}.${ball}: ${text}`,
        type: type || 'normal',
        timestamp: Date.now()
      };
      
      await push(commentaryRef, commentaryEvent);
    }

    // End innings
    async function endInnings() {
      // Save innings data
      const inningsKey = gameState.innings === 1 ? 'firstInnings' : 'secondInnings';
      
      await update(gameRef, {
        [inningsKey]: {
          runs: gameState.runs,
          wickets: gameState.wickets,
          balls: gameState.balls,
          extras: gameState.extras,
          batterStats: gameState.batterStats,
          bowlerStats: gameState.bowlerStats,
          playerWickets: gameState.playerWickets,
          complete: true
        },
        gameStatus: gameState.innings === 1 ? 'firstInningsComplete' : 'matchComplete'
      });
      
      // If first innings, show "End Innings" button for player1 to start second innings
      if (gameState.innings === 1 && playerRole === 'player1') {
        endInningsBtnEl.style.display = 'inline-block';
      }
      
      // If second innings, show match summary
      if (gameState.innings === 2) {
        await saveMatchResult();
        window.location.href = `match_summary.html?id=${roomId}`;
      }
    }

    // Save match result to completed matches
    async function saveMatchResult() {
      try {
        // Get match data
        const gameSnap = await get(gameRef);
        if (!gameSnap.exists()) return;
        
        const gameData = gameSnap.val();
        const roomSnap = await get(roomRef);
        const roomData = roomSnap.val();
        const tossSnap = await get(tossRef);
        const tossData = tossSnap.val();
        
        // Determine winner
        let winner = null;
        let winningMargin = '';
        
        if (gameData.secondInnings.runs >= gameData.firstInnings.runs + 1) {
          // Batting team in second innings won
          winner = tossData.battingFirst === 'player1' ? 'player2' : 'player1';
          const wicketsLeft = 10 - gameData.secondInnings.wickets;
          winningMargin = `${wicketsLeft} wicket${wicketsLeft !== 1 ? 's' : ''}`;
        } else {
          // Batting team in first innings won
          winner = tossData.battingFirst === 'player1' ? 'player1' : 'player2';
          const runsDifference = gameData.firstInnings.runs - gameData.secondInnings.runs;
          winningMargin = `${runsDifference} run${runsDifference !== 1 ? 's' : ''}`;
        }
        
        // Determine player of the match (simplified - highest scorer in winning team)
        let playerOfTheMatch = '';
        let highestScore = 0;
        
        const winningTeam = winner === 'player1' ? roomData.player1.team : roomData.player2.team;
        const winningTeamStats = winner === 'player1' ? 
          gameData.firstInnings.batterStats : gameData.secondInnings.batterStats;
        
        for (const [player, stats] of Object.entries(winningTeamStats)) {
          if (stats.runs > highestScore) {
            highestScore = stats.runs;
            playerOfTheMatch = player;
          }
        }
        
        // Save to completed matches
        const matchData = {
          player1: {
            team: roomData.player1.team,
            totalRuns: gameData.firstInnings.runs,
            totalWickets: gameData.firstInnings.wickets,
            batterStats: gameData.firstInnings.batterStats,
            bowlerStats: gameData.firstInnings.bowlerStats
          },
          player2: {
            team: roomData.player2.team,
            totalRuns: gameData.secondInnings.runs,
            totalWickets: gameData.secondInnings.wickets,
            batterStats: gameData.secondInnings.batterStats,
            bowlerStats: gameData.secondInnings.bowlerStats
          },
          format: roomData.player1.format,
          timestamp: Date.now(),
          winner: winner,
          winningMargin: winningMargin,
          playerOfTheMatch: playerOfTheMatch
        };
        
        await push(ref(db, 'completedMatches'), matchData);
        
      } catch (error) {
        console.error('Error saving match result:', error);
      }
    }

    // Show boundary animation
    function showBoundaryAnimation() {
      // Create confetti pieces
      confettiEl.innerHTML = '';
      confettiEl.style.display = 'block';
      
      for (let i = 0; i < 50; i++) {
        const piece = document.createElement('div');
        piece.className = 'confetti-piece';
        piece.style.left = `${Math.random() * 100}%`;
        piece.style.top = `${Math.random() * 100}%`;
        piece.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
        piece.style.transform = `rotate(${Math.random() * 360}deg)`;
        piece.style.opacity = '1';
        piece.style.transition = 'all 1s ease-out';
        
        confettiEl.appendChild(piece);
        
        // Animate
        setTimeout(() => {
          piece.style.opacity = '0';
          piece.style.transform = `translate(${(Math.random() - 0.5) * 200}px, ${Math.random() * 200}px) rotate(${Math.random() * 360}deg)`;
        }, 10);
      }
      
      // Hide after animation
      setTimeout(() => {
        confettiEl.style.display = 'none';
      }, 2000);
    }

    // Show score popup
    function showScorePopup(runs) {
      scorePopupEl.textContent = `+${runs}`;
      scorePopupEl.style.left = `${50 + (Math.random() * 20 - 10)}%`;
      scorePopupEl.style.top = `${50 + (Math.random() * 20 - 10)}%`;
      scorePopupEl.style.opacity = '1';
      scorePopupEl.style.transform = 'translate(-50%, -50%) scale(1)';
      
      setTimeout(() => {
        scorePopupEl.style.opacity = '0';
        scorePopupEl.style.transform = 'translate(-50%, -50%) scale(1.5)';
      }, 1000);
    }

    // End innings button handler
    endInningsBtnEl.addEventListener('click', async () => {
      // Redirect to second innings
      window.location.href = `game_first_innings.html?room=${roomId}&player=${playerRole}&innings=2`;
    });

    // Timeout button handler
    timeoutBtnEl.addEventListener('click', async () => {
      // Implement timeout logic
      await addCommentary(`Timeout called by ${playerRole === 'player1' ? gameState.team1Name : gameState.team2Name}`, 'normal');
      alert('Timeout called. Game paused for 60 seconds.');
    });

    // Initialize the game
    initGame();
  </script>
</body>
</html>