<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HandiCricket - Score</title>
  <style>
    body { background-color: #0a2540; color: white; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; }
    .card { background: #102d4a; padding: 20px; border-radius: 16px; max-width: 400px; width: 100%; margin-top: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.3); text-align: center; }
    .card-buttons button {
      width: 60px; height: 60px; margin: 5px; border-radius: 50%; font-size: 18px;
      border: none; background: #1e88e5; color: white; transition: 0.2s;
    }
    .card-buttons button.disabled { background-color: #555 !important; opacity: 0.6; pointer-events: none; }
    #result, #roomInfo, #playerNames, #scoreboard { margin-top: 15px; font-size: 16px; }
  </style>
</head>
<body>
  <h1>üèè HandiCricket - Game</h1>
  <div class="card">
    <div id="roomInfo">Loading room...</div>
    <div id="playerNames">Loading players...</div>
    <div id="role">Loading role...</div>
    <div id="scoreboard">Runs: 0 | Wickets: 0 | Overs: 0.0</div>
    <div class="card-buttons" id="buttons"></div>
    <div id="result">Waiting for players...</div>
  </div>

  
<script type="module">
  import { db, ref, set, get, onValue } from './firebase.js';

  const urlParams = new URLSearchParams(window.location.search);
  const roomCode = urlParams.get('room');
  const player = urlParams.get('player');
  const opponent = player === "player1" ? "player2" : "player1";

  const roomInfo = document.getElementById('roomInfo');
  const roleEl = document.getElementById('role');
  const playerNames = document.getElementById('playerNames');
  const resultEl = document.getElementById('result');
  const scoreboard = document.getElementById('scoreboard');
  const buttonsDiv = document.getElementById('buttons');

  let runs = 0, wickets = 0, balls = 0;
  let tossWinner = "", isBatting = false;

  const buttonValues = [0, 1, 2, 3, 4, 5, 6];
  buttonValues.forEach(num => {
    const btn = document.createElement("button");
    btn.textContent = num;
    btn.classList.add("card-button");
    btn.dataset.value = num;
    btn.onclick = () => playCard(num);
    buttonsDiv.appendChild(btn);
  });

  function disableButtons() {
    document.querySelectorAll(".card-button").forEach(btn => {
      btn.classList.add("disabled");
      btn.disabled = true;
    });
  }

  function enableButtons() {
    document.querySelectorAll(".card-button").forEach(btn => {
      btn.classList.remove("disabled");
      btn.disabled = false;
    });
  }

  function updateScoreboard() {
    scoreboard.textContent = `Runs: ${runs} | Wickets: ${wickets} | Overs: ${Math.floor(balls / 6)}.${balls % 6}`;
  }

  function resetCurrentPlays() {
    set(ref(db, `rooms/${roomCode}/currentPlays`), { player1: null, player2: null });
  }

  function playCard(value) {
    disableButtons();
    resultEl.innerText = "Waiting for opponent...";
    set(ref(db, `rooms/${roomCode}/currentPlays/${player}`), value);
  }

  // Fetch toss winner and role
  get(ref(db, `rooms/${roomCode}/tossWinner`)).then(snap => {
    tossWinner = snap.val();
    isBatting = (player === tossWinner);
    roleEl.textContent = isBatting ? "You are Batting" : "You are Bowling";
    enableButtons();
  });

  onValue(ref(db, `rooms/${roomCode}/currentPlays`), async (snap) => {
    const data = snap.val();
    if (!data || data.player1 === null || data.player2 === null) return;

    // Prevent double processing
    if (window.lastResult === JSON.stringify(data)) return;
    window.lastResult = JSON.stringify(data);

    const bat = data[tossWinner];
    const bowl = data[tossWinner === "player1" ? "player2" : "player1"];

    let result = "", runAdd = 0;

    if (bat === bowl && bat !== 0) {
      result = "WICKET!";
      wickets++;
    } else if (bat === 0 && bowl === 0) {
      result = "NO BALL +1 Run";
      runAdd = 1;
      balls--;  // Don't count the ball
    } else if (bat === 0) {
      result = `Runs: ${bowl}`;
      runAdd = bowl;
    } else {
      result = `Runs: ${bat}`;
      runAdd = bat;
    }

    runs += runAdd;
    balls++;
    updateScoreboard();
    resultEl.innerText = result;

    await resetCurrentPlays();
    enableButtons();
  });

  // Load player names
  onValue(ref(db, `rooms/${roomCode}`), snap => {
    const room = snap.val();
    if (room) {
      roomInfo.innerText = `Room: ${roomCode}`;
      const p1 = room.player1?.team || "Player 1";
      const p2 = room.player2?.team || "Player 2";
      playerNames.innerText = `${p1} vs ${p2}`;
    }
  });

  disableButtons();
</script>

</body>
</html>