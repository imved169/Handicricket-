<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HandiCricket - Game</title>
    <style>
        /* Base Styles */
        body { 
            background: #061e3e; 
            color: white; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            text-align: center; 
            padding: 20px;
            margin: 0;
            overflow-x: hidden;
        }
        
        h1 { 
            margin: 10px 0 20px;
            color: #ffeb3b;
            text-shadow: 0 0 5px rgba(255, 235, 59, 0.5);
        }
        
        /* Card Buttons */
        .cards { 
            margin: 25px auto;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 12px;
            max-width: 500px;
            position: relative;
        }
        
        .card { 
            width: 70px;
            height: 70px;
            font-size: 24px;
            border-radius: 12px;
            border: none;
            background: linear-gradient(145deg, #1e88e5, #1565c0);
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.2s;
        }
        
        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }
        
        .card:active {
            transform: translateY(1px);
        }
        
        .card:disabled { 
            background: #607d8b;
            color: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* Selection Modal */
        .selection-modal { 
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 400px;
            background: linear-gradient(145deg, #123456, #0a1f3a);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 100;
            display: none;
        }
        
        .selection-list { 
            max-height: 40vh;
            overflow-y: auto;
            margin: 10px 0;
            padding-right: 5px;
        }
        
        /* Player Items */
        .player-item, .batter-item {
            padding: 10px;
            margin: 5px 0;
            background: rgba(30, 136, 229, 0.2);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }
        
        .player-item:hover, .batter-item:hover {
            background: rgba(30, 136, 229, 0.4);
            transform: translateX(5px);
        }
        
        .player-item.selected, .batter-item.selected {
            background: rgba(13, 71, 161, 0.6);
            border-left: 3px solid #ffeb3b;
        }
        
        .batter-stats, .bowler-stats {
            font-size: 0.85em;
            color: #aaa;
            margin-top: 3px;
            display: flex;
            justify-content: space-between;
        }
        
        /* Scoreboard and Game Info */
        .scoreboard { 
            background: rgba(13, 42, 82, 0.8);
            padding: 15px;
            border-radius: 10px;
            margin: 15px auto;
            max-width: 500px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            text-align: center;
        }
        
        .scoreboard div {
            padding: 5px;
        }
        
        .scoreboard strong {
            font-size: 1.2em;
            color: #4caf50;
        }
        
        .game-info {
            background: rgba(13, 42, 82, 0.8);
            padding: 12px;
            border-radius: 10px;
            margin: 15px auto;
            max-width: 500px;
        }
        
        #currentPlayers {
            display: flex;
            justify-content: space-around;
            margin-bottom: 10px;
        }
        
        #game-status {
            margin: 15px 0;
            padding: 10px;
            font-size: 18px;
            color: #ffeb3b;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Indicators */
        .indicator {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: bold;
            margin: 0 5px;
            display: inline-block;
        }
        
        .powerplay {
            background: #ffeb3b;
            color: #000;
        }
        
        .freehit {
            background: #4CAF50;
            color: white;
        }
        
        .dead-over {
            background: #f44336;
            color: white;
        }
        
        .hidden {
            display: none;
        }
        
        /* Player Stats */
        .player-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            background: rgba(0,0,0,0.1);
            padding: 10px;
            border-radius: 8px;
        }
        
        .batter-stats, .bowler-stats {
            width: 48%;
        }
        
        .wicket-progress {
            height: 5px;
            background: #333;
            border-radius: 3px;
            margin-top: 5px;
        }
        
        .wicket-progress-fill {
            height: 100%;
            background: #F44336;
            border-radius: 3px;
            width: 0%;
        }
        
        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 100;
            animation: fadeInOut 3s forwards;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { opacity: 0; }
        }
        
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background-color: #f00;
            animation: confetti-fall 5s linear forwards;
            z-index: 1000;
        }
        
        @keyframes confetti-fall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .card {
                width: 60px;
                height: 60px;
                font-size: 20px;
            }
            
            .scoreboard {
                grid-template-columns: 1fr 1fr;
            }
            
            .selection-modal {
                width: 95%;
                max-height: 50vh;
            }
            
            .player-stats {
                flex-direction: column;
            }
            
            .batter-stats, .bowler-stats {
                width: 100%;
                margin-bottom: 10px;
            }
        }
        
        @media (max-width: 480px) {
            .scoreboard {
                grid-template-columns: 1fr;
            }
            
            .card {
                width: 50px;
                height: 50px;
                font-size: 18px;
            }
            
            .selection-modal {
                padding: 10px;
            }
            
            .player-item, .batter-item {
                padding: 8px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèè HandiCricket</h1>
        
        <div class="game-info">
            <div>Game ID: <span id="game-id"></span></div>
            <div>You are: <span id="player-role"></span></div>
            <div>Format: <span id="match-format"></span></div>
            <div id="powerplay-indicator" class="indicator powerplay hidden">üö® Powerplay</div>
            <div id="freehit-indicator" class="indicator freehit hidden">üéØ Free Hit</div>
            <div id="deadover-indicator" class="indicator dead-over hidden">‚ò†Ô∏è Dead Over</div>
        </div>
        
        <div class="scoreboard">
            <div id="score">0/0 <span id="wicket-progress-text">(0.00/1.0)</span></div>
            <div id="overs">0.0</div>
            <div id="target" class="hidden">Target: <span id="target-runs"></span> (<span id="required-rate"></span>)</div>
        </div>
        
        <div id="currentPlayers">
            <div>Batter: <span id="current-batter">-</span></div>
            <div>Bowler: <span id="current-bowler">-</span></div>
        </div>
        
        <div id="game-status">Initializing game...</div>

        <div class="cards" id="cardButtons">
            <!-- Selection Modal -->
            <div id="selectionModal" class="selection-modal">
                <h3 id="selectionTitle">Select Next Batter</h3>
                <div id="selectionList" class="selection-list"></div>
                <button id="confirmSelection" style="width: 100%; margin-top: 10px; padding: 8px; background: #4CAF50; color: white; border: none; border-radius: 8px; cursor: pointer;">Confirm</button>
            </div>
            
            <!-- Card buttons -->
            <button class="card" data-value="0">0</button>
            <button class="card" data-value="1">1</button>
            <button class="card" data-value="2">2</button>
            <button class="card" data-value="3">3</button>
            <button class="card" data-value="4">4</button>
            <button class="card" data-value="5">5</button>
            <button class="card" data-value="6">6</button>
        </div>

        <button id="startInningsBtn" class="hidden">
            <div id="startInningsText">Start Second Innings</div>
            <div id="opponentReadyStatus" class="hidden">
                <span>‚úì Opponent Ready</span>
            </div>
            <div id="autoStartTimer" class="hidden"></div>
        </button>

        <div class="player-stats">
            <div class="batter-stats">
                <h4>Batter: <span id="current-batter-name"></span> <span id="batter-wickets" class="wicket-count"></span></h4>
                <div class="wicket-progress"><div id="batter-wicket-progress" class="wicket-progress-fill"></div></div>
                <p>Runs: <span id="batter-runs"></span> (<span id="batter-sr"></span>)</p>
                <p>4s/6s: <span id="batter-boundaries"></span></p>
                <p>Balls: <span id="batter-balls"></span> (<span id="batter-dots"></span> dots)</p>
            </div>
            <div class="bowler-stats">
                <h4>Bowler: <span id="current-bowler-name"></span></h4>
                <p>Overs: <span id="bowler-overs"></span>/<span id="bowler-max-overs"></span></p>
                <p>Wickets: <span id="bowler-wickets"></span></p>
                <p>Runs: <span id="bowler-runs-given"></span> (<span id="bowler-economy"></span>)</p>
                <p>Maidens: <span id="bowler-maidens"></span></p>
            </div>
        </div>
        
        <div id="ball-result"></div>
        
        <div id="notifications"></div>

        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
            import { getDatabase, ref, onValue, set, get, update, push, remove } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

            // Firebase configuration
            const firebaseConfig = {
                apiKey: "AIzaSyCN6aZMwlsZe7JJaovU0WA3UQygWr4jYmA",
                authDomain: "handicricket-85a06.firebaseapp.com",
                projectId: "handicricket-85a06",
                storageBucket: "handicricket-85a06.appspot.com",
                messagingSenderId: "599182538558",
                appId: "1:599182538558:web:3e965753ab05f8f1e3de6f",
                measurementId: "G-HSV9H4LEJQ"
            };

            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            const db = getDatabase(app);

            // Get URL parameters
            const params = new URLSearchParams(window.location.search);
            const room = params.get('room');
            const player = params.get('player');
            const opponent = player === "player1" ? "player2" : "player1";

            // Game format rules
            const formatRules = {
                "5": { 
                    name: "5 Overs", 
                    totalOvers: 5, 
                    totalWickets: 11, 
                    powerplayOvers: 2, 
                    powerplayWicketValue: 0.5,
                    regularWicketValue: 1.0,
                    livesPerPlayer: 2,
                    deadOvers: []
                },
                "10": { 
                    name: "10 Overs", 
                    totalOvers: 10, 
                    totalWickets: 11, 
                    powerplayOvers: 3, 
                    powerplayWicketValue: 0.5,
                    regularWicketValue: 1.0,
                    livesPerPlayer: 2,
                    deadOvers: []
                },
                "20": { 
                    name: "T20", 
                    totalOvers: 20, 
                    totalWickets: 11, 
                    powerplayOvers: 6, 
                    powerplayWicketValue: 0.5,
                    regularWicketValue: 1.0,
                    livesPerPlayer: 2,
                    deadOvers: []
                },
                "50": { 
                    name: "ODI", 
                    totalOvers: 50, 
                    totalWickets: 11, 
                    powerplayOvers: [1,10, 21,30, 41,42], 
                    powerplayWicketValue: 0.25,
                    regularWicketValue: 0.5,
                    livesPerPlayer: 4,
                    deadOvers: [11,20, 31,40]
                },
                "test": { 
                    name: "Test Match", 
                    totalOvers: Infinity, 
                    totalWickets: 30, 
                    powerplayOvers: 0, 
                    powerplayWicketValue: 0.33,
                    regularWicketValue: 0.33,
                    livesPerPlayer: 3,
                    deadOvers: []
                }
            };

            // Game state variables
            let runs = 0, wickets = 0;
            let legalBalls = 0;
            let freeHit = false;
            let freeHitNextBall = false;
            let currentBatter = null;
            let currentBowler = null;
            let battersUsed = [];
            let bowlersUsed = [];
            let bowlerOvers = {};
            let isBatting = false;
            let currentFormat = {};
            let isTestMatch = false;
            let innings = 1;
            let currentInningRuns = 0;
            let currentInningWickets = 0;
            let team1Score = 0;
            let team2Score = 0;
            let team1Wickets = 0;
            let team2Wickets = 0;
            let daysRemaining = 5;
            let oversToday = 0;
            const maxOversPerDay = 90;
            let isPowerplay = false;
            let isDeadOver = false;
            let batterWickets = {};
            let zerosThisOver = { player1: 0, player2: 0 };
            let bowlerRuns = {};
            let gameInProgress = true;
            let lastOverRuns = 0;
            let lastOverWickets = 0;
            let lastWicketScore = 0;
            let ballByBall = {};
            let fallOfWickets = [];
            let batterStats = {};
            let bowlerStats = {};
            let autoStartTimer;
            let countdownInterval;
            let tossWinner = null;
            let battingFirst = null;
            const milestoneLevels = [50, 100, 150, 200, 250, 300, 350, 400];
            let batterSelected = false;
            let bowlerSelected = false;

            // DOM elements
            const status = document.getElementById("game-status");
            const scoreboard = document.querySelector(".scoreboard");
            const buttons = document.querySelectorAll(".card");
            const roleText = document.getElementById("player-role");
            const currentBatterEl = document.getElementById("current-batter");
            const currentBowlerEl = document.getElementById("current-bowler");
            const selectionModal = document.getElementById("selectionModal");
            const selectionTitle = document.getElementById("selectionTitle");
            const selectionList = document.getElementById("selectionList");
            const confirmSelection = document.getElementById("confirmSelection");
            const formatDisplay = document.getElementById("match-format");
            const targetDisplay = document.getElementById("target");
            const targetRunsEl = document.getElementById("target-runs");
            const requiredRateEl = document.getElementById("required-rate");
            const startInningsBtn = document.getElementById("startInningsBtn");
            const opponentReadyStatus = document.getElementById("opponentReadyStatus");
            const autoStartTimerEl = document.getElementById("autoStartTimer");
            const startInningsText = document.getElementById("startInningsText");
            const powerplayIndicator = document.getElementById("powerplay-indicator");
            const freehitIndicator = document.getElementById("freehit-indicator");
            const deadoverIndicator = document.getElementById("deadover-indicator");

            // Firebase references
            const playerRef = ref(db, `rooms/${room}/${player}/online`);
            const opponentRef = ref(db, `rooms/${room}/${opponent}/online`);
            const roomRef = ref(db, `rooms/${room}`);
            const playsRef = ref(db, `rooms/${room}/currentPlays`);
            const batterRef = ref(db, `rooms/${room}/currentBatter`);
            const bowlerRef = ref(db, `rooms/${room}/currentBowler`);
            const inningsReadyRef = ref(db, `rooms/${room}/inningsReady`);
            const autoStartTimeRef = ref(db, `rooms/${room}/autoStartTime`);
            const startSecondInningsRef = ref(db, `rooms/${room}/startSecondInnings`);
            const declaredRef = ref(db, `rooms/${room}/declared`);
            const followOnRef = ref(db, `rooms/${room}/followOn`);
            const spectatorsRef = ref(db, `rooms/${room}/spectators`);
            const reactionsRef = ref(db, `rooms/${room}/reactions`);
            const matchStatsRef = ref(db, `rooms/${room}/matchStats`);
            const liveStateRef = ref(db, `rooms/${room}/liveState`);
            const overSummariesRef = ref(db, `rooms/${room}/overSummaries`);
            const resultRef = ref(db, `rooms/${room}/result`);
            const savedGameRef = ref(db, `savedGames/${room}`);

            // Initialize batter stats with milestone tracking
            function initializeBatterStats() {
                get(roomRef).then(snapshot => {
                    const data = snapshot.val();
                    
                    if (data.player1?.playing11) {
                        data.player1.playing11.forEach(player => {
                            batterStats[player] = { 
                                runs: 0, 
                                balls: 0,
                                fours: 0,
                                sixes: 0,
                                centuryNotified: false,
                                fiftyNotified: false
                            };
                            batterWickets[player] = 0;
                            milestoneLevels.forEach(level => {
                                batterStats[player][`milestone${level}Notified`] = false;
                            });
                        });
                    }
                    
                    if (data.player2?.playing11) {
                        data.player2.playing11.forEach(player => {
                            batterStats[player] = { 
                                runs: 0, 
                                balls: 0,
                                fours: 0,
                                sixes: 0,
                                centuryNotified: false,
                                fiftyNotified: false
                            };
                            batterWickets[player] = 0;
                            milestoneLevels.forEach(level => {
                                batterStats[player][`milestone${level}Notified`] = false;
                            });
                        });
                    }
                }).catch(error => {
                    console.error("Error initializing batter stats:", error);
                });
            }

            // Check for batting milestones (50, 100, 150, etc.)
            function checkBattingMilestones() {
                if (!currentBatter) return;

                const batterRuns = batterStats[currentBatter]?.runs || 0;
                
                // Check for 50, 100, etc.
                for (const milestone of milestoneLevels) {
                    if (batterRuns >= milestone && 
                        !batterStats[currentBatter][`milestone${milestone}Notified`]) {
                        
                        showNotification(`${currentBatter} scores ${milestone} runs! üéâ`, 'batting');
                        batterStats[currentBatter][`milestone${milestone}Notified`] = true;
                        
                        if (milestone >= 150) {
                            createConfetti();
                        }
                        break;
                    }
                }
                
                // Special handling for 50 and 100
                if (batterRuns >= 50 && !batterStats[currentBatter].fiftyNotified) {
                    showNotification(`${currentBatter} scores a half-century!`, 'batting');
                    batterStats[currentBatter].fiftyNotified = true;
                }
                
                if (batterRuns >= 100 && !batterStats[currentBatter].centuryNotified) {
                    showNotification(`${currentBatter} scores a century! üíØ`, 'batting');
                    batterStats[currentBatter].centuryNotified = true;
                    createConfetti();
                }
            }

            // Show notification with different styles
            function showNotification(message, type = 'info') {
                const notif = document.createElement('div');
                notif.className = `notification ${type}`;
                notif.textContent = message;
                document.getElementById('notifications').appendChild(notif);
                
                // Position randomly but within view
                notif.style.left = `${Math.random() * 60 + 20}%`;
                notif.style.top = `${Math.random() * 60 + 20}%`;
                
                setTimeout(() => {
                    notif.style.opacity = '0';
                    setTimeout(() => notif.remove(), 500);
                }, 2500);
            }

            // Create confetti effect
            function createConfetti() {
                const colors = ['#f00', '#0f0', '#00f', '#ff0', '#f0f', '#0ff'];
                for (let i = 0; i < 150; i++) {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = `${Math.random() * 100}%`;
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.width = `${Math.random() * 10 + 5}px`;
                    confetti.style.height = `${Math.random() * 10 + 5}px`;
                    confetti.style.animationDuration = `${Math.random() * 3 + 2}s`;
                    confetti.style.animationDelay = `${Math.random() * 0.5}s`;
                    document.body.appendChild(confetti);
                    setTimeout(() => confetti.remove(), 5000);
                }
            }

            // Function to start the second innings
            async function startSecondInnings() {
                try {
                    disableButtons();
                    status.innerText = "Starting second innings...";
                    
                    if (countdownInterval) clearInterval(countdownInterval);
                    
                    await set(startSecondInningsRef, true);
                    
                    // Reset game state for new innings
                    await update(roomRef, {
                        currentPlays: { player1: null, player2: null },
                        currentBatter: null,
                        currentBowler: null,
                        inningsReady: null,
                        autoStartTime: null
                    });
                    
                    innings++;
                    startInningsBtn.classList.add('hidden');
                    resetInning();
                } catch (error) {
                    console.error("Error starting second innings:", error);
                    status.innerText = "Error starting second innings. Please try again.";
                    enableButtons();
                }
            }

            // Update spectator data with match details
            function updateSpectatorData() {
                const currentOver = Math.floor(legalBalls / 6);
                
                // Update over summaries
                if (currentOver > lastOverRuns) {
                    const overSummary = `Over ${currentOver}: ${runs - lastOverRuns} runs, ${wickets - lastOverWickets} wickets`;
                    set(ref(db, `${overSummariesRef.path}/${currentOver}`), overSummary);
                    lastOverRuns = runs;
                    lastOverWickets = wickets;
                }

                // Calculate match stats
                const runRate = legalBalls > 0 ? (runs / (legalBalls / 6)).toFixed(2) : "0.00";
                const boundaries = Object.values(ballByBall).filter(ball => [4,6].includes(ball.runs)).length;
                const requiredRate = innings === 2 ? ((team1Score - runs + 1) / Math.max(1, (currentFormat.totalOvers * 6 - legalBalls) / 6)).toFixed(2) : null;

                // Update match stats
                set(matchStatsRef, {
                    runRate: runRate,
                    boundaries: boundaries,
                    dotBalls: Object.values(ballByBall).filter(ball => ball.runs === 0).length,
                    wickets: Math.floor(wickets),
                    partnership: runs - lastWicketScore,
                    requiredRate: requiredRate,
                    currentOver: `${currentOver}.${legalBalls % 6}`,
                    isPowerplay: isPowerplay,
                    isDeadOver: isDeadOver,
                    freeHit: freeHit,
                    fallOfWickets: fallOfWickets.slice(-5)
                });

                // Update live state
                set(liveStateRef, {
                    runs: runs,
                    wickets: Math.floor(wickets),
                    legalBalls: legalBalls,
                    currentBatter: currentBatter,
                    currentBowler: currentBowler,
                    isPowerplay: isPowerplay,
                    isDeadOver: isDeadOver,
                    freeHit: freeHit,
                    innings: innings,
                    timestamp: Date.now()
                });
            }

            // Update target display for 2nd innings
            function updateTargetDisplay() {
                if (innings === 2) {
                    targetDisplay.classList.remove('hidden');
                    targetRunsEl.textContent = team1Score + 1;
                    
                    const ballsRemaining = currentFormat.totalOvers * 6 - legalBalls;
                    if (ballsRemaining > 0) {
                        const requiredRuns = team1Score - runs + 1;
                        const requiredRate = (requiredRuns / (ballsRemaining / 6)).toFixed(2);
                        requiredRateEl.textContent = `RR: ${requiredRate}`;
                    } else {
                        requiredRateEl.textContent = "";
                    }
                } else {
                    targetDisplay.classList.add('hidden');
                }
            }

            // Check powerplay status based on current over
            function checkPowerplayStatus() {
                const currentOver = Math.floor(legalBalls / 6);
                
                isPowerplay = false;
                isDeadOver = false;
                
                if (isTestMatch) return;

                // Handle array-based powerplay overs (for ODI format)
                if (Array.isArray(currentFormat.powerplayOvers)) {
                    for (let i = 0; i < currentFormat.powerplayOvers.length; i += 2) {
                        const startOver = currentFormat.powerplayOvers[i] - 1;
                        const endOver = currentFormat.powerplayOvers[i+1] - 1;
                        
                        if (currentOver >= startOver && currentOver <= endOver) {
                            isPowerplay = true;
                            break;
                        }
                    }
                } 
                // Handle simple powerplay (first X overs)
                else if (currentOver < currentFormat.powerplayOvers) {
                    isPowerplay = true;
                }

                // Check for dead overs (ODI format)
                if (Array.isArray(currentFormat.deadOvers) && currentFormat.deadOvers.length > 0) {
                    for (let i = 0; i < currentFormat.deadOvers.length; i += 2) {
                        const startOver = currentFormat.deadOvers[i] - 1;
                        const endOver = currentFormat.deadOvers[i+1] - 1;
                        
                        if (currentOver >= startOver && currentOver <= endOver) {
                            isDeadOver = true;
                            break;
                        }
                    }
                }

                // Update indicators
                powerplayIndicator.classList.toggle('hidden', !isPowerplay);
                freehitIndicator.classList.toggle('hidden', !freeHit);
                deadoverIndicator.classList.toggle('hidden', !isDeadOver);
            }

            // Update scoreboard display
            function updateScoreboard() {
                const overs = Math.floor(legalBalls / 6);
                const balls = legalBalls % 6;
                const displayWickets = Math.floor(wickets);
                const totalWickets = currentFormat.totalWickets;
                
                // Basic score display
                document.getElementById('score').textContent = `${runs}/${displayWickets}`;
                document.getElementById('wicket-progress-text').textContent = 
                    `(${(batterWickets[currentBatter] || 0).toFixed(2)}/${isTestMatch ? '3.0' : '1.0'})`;
                document.getElementById('overs').textContent = `${overs}.${balls}`;

                // Update target display
                updateTargetDisplay();
                
                // Update player stats
                updatePlayerStatsUI();
                
                // Check powerplay status
                checkPowerplayStatus();
            }

            // Update player stats UI
            function updatePlayerStatsUI() {
                // Update batter stats
                if (currentBatter) {
                    const batter = batterStats[currentBatter] || { runs: 0, balls: 0, fours: 0, sixes: 0, dots: 0 };
                    const wicketProgress = (batterWickets[currentBatter] || 0) / (isTestMatch ? 3.0 : 1.0) * 100;
                    
                    document.getElementById('current-batter-name').textContent = currentBatter;
                    document.getElementById('batter-wickets').textContent = isTestMatch ? `(${Math.floor(batterWickets[currentBatter] || 0)}/3)` : '';
                    document.getElementById('batter-wicket-progress').style.width = `${wicketProgress}%`;
                    document.getElementById('batter-runs').textContent = batter.runs;
                    document.getElementById('batter-balls').textContent = batter.balls;
                    document.getElementById('batter-dots').textContent = batter.dots;
                    document.getElementById('batter-sr').textContent = batter.balls > 0 ? 
                        ((batter.runs / batter.balls * 100).toFixed(2)) : '0.00';
                    document.getElementById('batter-boundaries').textContent = `${batter.fours}/${batter.sixes}`;
                }
                
                // Update bowler stats
                if (currentBowler) {
                    const bowler = bowlerStats[currentBowler] || { wickets: 0, runs: 0, balls: 0, maidens: 0 };
                    const overs = Math.floor(bowler.balls / 6) + (bowler.balls % 6) / 10;
                    
                    document.getElementById('current-bowler-name').textContent = currentBowler;
                    document.getElementById('bowler-overs').textContent = overs.toFixed(1);
                    document.getElementById('bowler-max-overs').textContent = isTestMatch ? '‚àû' : Math.ceil(currentFormat.totalOvers / 5);
                    document.getElementById('bowler-wickets').textContent = bowler.wickets;
                    document.getElementById('bowler-runs-given').textContent = bowler.runs;
                    document.getElementById('bowler-maidens').textContent = bowler.maidens;
                    document.getElementById('bowler-economy').textContent = overs > 0 ? 
                        ((bowler.runs / overs).toFixed(2)) : '0.00';
                }
            }

            // Reset plays after each ball
            async function resetPlays() {
                try {
                    await update(playsRef, {
                        player1: null,
                        player2: null
                    });
                    enableButtons();
                } catch (error) {
                    console.error("Error resetting plays:", error);
                    enableButtons();
                }
            }

            // Set up player roles (batting/bowling)
            async function setupRole() {
                try {
                    const [tossSnap, battingFirstSnap, decisionSnap, teamSnap] = await Promise.all([
                        get(ref(db, `rooms/${room}/tossWinner`)),
                        get(ref(db, `rooms/${room}/battingFirst`)),
                        get(ref(db, `rooms/${room}/decision`)),
                        get(ref(db, `rooms/${room}/${opponent}/playing11`))
                    ]);
                    
                    tossWinner = tossSnap.val();
                    battingFirst = battingFirstSnap.val();
                    const decision = decisionSnap.val();
                    const opponentTeam = teamSnap.val()?.[0] || "Opponent";

                    isBatting = (innings % 2 === 1) ? (player === battingFirst) : (player !== battingFirst);

                    roleText.textContent = isBatting ? 
                        `Batting (${decision === 'bat' ? 'chose to bat' : 'chose to bowl'})` : 
                        `Bowling (${decision === 'bowl' ? 'chose to bowl' : 'chose to bat'})`;

                    currentBatterEl.textContent = "-";
                    currentBowlerEl.textContent = "-";

                    // Disable buttons until selections are made
                    batterSelected = false;
                    bowlerSelected = false;
                    updateButtonStates();

                    if (isBatting && !currentBatter) {
                        showBatterSelection();
                    } else if (!isBatting && !currentBowler) {
                        showBowlerSelection();
                    }
                } catch (error) {
                    console.error("Error setting up role:", error);
                    showNotification("Error determining your role", 'error');
                }
            }

            // Set up selection modal for batters/bowlers
            function setupSelectionModal() {
                confirmSelection.addEventListener("click", async () => {
                    const selectedPlayer = document.querySelector(".batter-item.selected") || 
                                         document.querySelector(".player-item.selected");
                    if (!selectedPlayer) {
                        showNotification("Please select a player", 'error');
                        return;
                    }

                    const playerName = selectedPlayer.dataset.name;
                    const selectionType = selectionTitle.textContent.includes("Batter") ? "batter" : "bowler";

                    try {
                        if (selectionType === "batter") {
                            currentBatter = playerName;
                            if (!battersUsed.includes(playerName)) {
                                battersUsed.push(playerName);
                            }
                            batterWickets[playerName] = batterWickets[playerName] || 0;
                            currentBatterEl.textContent = playerName;
                            await set(batterRef, playerName);
                            batterSelected = true;
                        } else {
                            currentBowler = playerName;
                            bowlerOvers[playerName] = bowlerOvers[playerName] || 0;
                            currentBowlerEl.textContent = playerName;
                            await set(bowlerRef, playerName);
                            bowlerSelected = true;
                        }

                        selectionModal.style.display = "none";
                        updateButtonStates();
                    } catch (error) {
                        console.error("Error confirming selection:", error);
                        showNotification("Error selecting player", 'error');
                    }
                });
            }

            // Enhanced batter selection modal
            async function showBatterSelection() {
                disableButtons();
                try {
                    status.textContent = "Loading batters...";
                    
                    // Verify room data exists first
                    const roomSnap = await get(roomRef);
                    if (!roomSnap.exists() || !roomSnap.val()[player]) {
                        showNotification("Game data not loaded", 'error');
                        enableButtons();
                        return;
                    }

                    // Get player data
                    const snapshot = await get(ref(db, `rooms/${room}/${player}/playing11`));
                    const players = snapshot.val();
                    
                    if (!players || players.length === 0) {
                        showNotification("No batters available", 'error');
                        enableButtons();
                        return;
                    }
                    
                    // Filter available batters
                    const availableBatters = players.filter(p => {
                        const wicketsUsed = batterWickets[p] || 0;
                        return !battersUsed.includes(p) || wicketsUsed < 1.0;
                    });
                    
                    if (availableBatters.length === 0) {
                        showNotification("All batters are out!", 'error');
                        enableButtons();
                        return;
                    }

                    // Update selection UI
                    selectionTitle.textContent = "Select Next Batter";
                    selectionList.innerHTML = "";
                    
                    availableBatters.forEach(player => {
                        const stats = batterStats[player] || { runs: 0, balls: 0, fours: 0, sixes: 0 };
                        const wicketsLost = batterWickets[player] || 0;
                        const strikeRate = stats.balls > 0 ? (stats.runs / stats.balls * 100).toFixed(2) : "0.00";
                        const wicketsLeft = (1.0 - wicketsLost).toFixed(2);
                        
                        const batterEl = document.createElement("div");
                        batterEl.className = "batter-item";
                        batterEl.dataset.name = player;
                        batterEl.innerHTML = `
                            <div>${player}</div>
                            <div class="batter-stats">
                                <div class="batter-status">
                                    <span>${stats.runs} runs</span>
                                    <span>${stats.balls} balls</span>
                                    <span>SR: ${strikeRate}</span>
                                </div>
                                <div class="batter-status">
                                    <span>${stats.fours} fours</span>
                                    <span>${stats.sixes} sixes</span>
                                    <span>${wicketsLeft}/1.0 wickets</span>
                                </div>
                            </div>
                        `;
                        
                        batterEl.addEventListener("click", function() {
                            document.querySelectorAll(".batter-item").forEach(el => el.classList.remove("selected"));
                            this.classList.add("selected");
                        });
                        
                        selectionList.appendChild(batterEl);
                    });

                    // Show modal above cards
                    selectionModal.style.display = "block";
                    status.textContent = "Select your next batter...";
                } catch (error) {
                    console.error("Batter selection error:", error);
                    showNotification("Error loading batters", 'error');
                    enableButtons();
                }
            }

            // Show bowler selection modal
            async function showBowlerSelection() {
                disableButtons();
                try {
                    status.textContent = "Loading bowlers...";
                    
                    const snapshot = await get(ref(db, `rooms/${room}/${player}/playing11`));
                    const players = snapshot.val();
                    
                    if (!players || players.length === 0) {
                        showNotification("No bowlers available", 'error');
                        enableButtons();
                        return;
                    }
                    
                    const maxOversPerBowler = isTestMatch ? Infinity : Math.ceil(currentFormat.totalOvers / 5);
                    const availableBowlers = players.filter(p => (bowlerOvers[p] || 0) < maxOversPerBowler);
                    
                    if (availableBowlers.length === 0) {
                        showNotification("All bowlers have bowled their maximum overs!", 'error');
                        enableButtons();
                        return;
                    }

                    selectionTitle.textContent = "Select Next Bowler";
                    selectionList.innerHTML = "";
                    
                    availableBowlers.forEach(player => {
                        const oversBowled = bowlerOvers[player] || 0;
                        const stats = bowlerStats[player] || { wickets: 0, runs: 0 };
                        const economy = oversBowled > 0 ? (stats.runs / oversBowled).toFixed(2) : "0.00";
                        
                        const playerEl = document.createElement("div");
                        playerEl.className = "player-item";
                        playerEl.dataset.name = player;
                        playerEl.innerHTML = `
                            <div>${player}</div>
                            <div class="bowler-stats">
                                <div>${oversBowled.toFixed(1)} overs</div>
                                <div>${stats.wickets} wickets</div>
                                <div>ER: ${economy}</div>
                            </div>
                        `;
                        
                        playerEl.addEventListener("click", function() {
                            document.querySelectorAll(".player-item").forEach(el => el.classList.remove("selected"));
                            this.classList.add("selected");
                        });
                        
                        selectionList.appendChild(playerEl);
                    });

                    // Show modal above cards
                    selectionModal.style.display = "block";
                    status.textContent = "Select your next bowler...";
                } catch (error) {
                    console.error("Bowler selection error:", error);
                    showNotification("Error loading bowlers", 'error');
                    enableButtons();
                }
            }

            // Set up the innings button with enhanced functionality
            function setupInningsButton() {
                startInningsBtn.addEventListener("click", startSecondInnings);

                onValue(inningsReadyRef, (snap) => {
                    if (!snap.exists()) return;
                    
                    const isReady = snap.val();
                    
                    if (isReady && innings === 1 && !isTestMatch) {
                        opponentReadyStatus.classList.remove('hidden');
                        startInningsText.textContent = "Ready to Start";
                        startInningsBtn.disabled = false;
                        
                        status.textContent = `Team 1 scored ${team1Score} runs! Opponent is ready to start second innings.`;
                    }
                });

                onValue(autoStartTimeRef, (snap) => {
                    if (!snap.exists() || !snap.val()) {
                        autoStartTimerEl.classList.add('hidden');
                        return;
                    }
                    
                    const startTime = snap.val();
                    const now = Date.now();
                    
                    if (startTime > now) {
                        autoStartTimerEl.classList.remove('hidden');
                        
                        if (countdownInterval) clearInterval(countdownInterval);
                        countdownInterval = setInterval(() => {
                            const remaining = Math.max(0, Math.ceil((startTime - Date.now()) / 1000));
                            autoStartTimerEl.textContent = `Auto-start in ${remaining}s`;
                            
                            if (remaining <= 0) {
                                clearInterval(countdownInterval);
                                autoStartTimerEl.classList.add('hidden');
                            }
                        }, 1000);
                    }
                });

                onValue(startSecondInningsRef, (snap) => {
                    if (snap.exists() && snap.val() && innings === 1 && !isTestMatch) {
                        innings++;
                        startInningsBtn.classList.add('hidden');
                        resetInning();
                    }
                });
            }

            // Process the outcome of a ball
            async function processBallOutcome(batCard, bowlCard, battingPlayer, bowlingPlayer) {
                let outcome = "";
                let isLegalBall = false;
                let isWicket = false;
                let isPlayerOut = false;
                let runsScored = 0;
                let boundary = false;
                let isSix = false;

                // Track zeros for both players
                if (batCard === 0) zerosThisOver[battingPlayer]++;
                if (bowlCard === 0) zerosThisOver[bowlingPlayer]++;

                // Handle free hit for next ball
                if (freeHitNextBall) {
                    freeHit = true;
                    freeHitNextBall = false;
                    freehitIndicator.classList.remove('hidden');
                }

                // 1. Check for no ball (both 0)
                if (batCard === 0 && bowlCard === 0) {
                    if (!isTestMatch) {
                        outcome = "NO BALL! +1 run (Free Hit next ball)";
                        runs += 1;
                        currentInningRuns += 1;
                        freeHitNextBall = true;
                        isLegalBall = false;
                    } else {
                        outcome = "No run (Test Match)";
                    }
                } 
                // 2. Handle free hit balls
                else if (freeHit) {
                    if (batCard === bowlCard && batCard > 0) {
                        outcome = "Wicket on Free Hit (not out)";
                        isWicket = false;
                    } else {
                        runsScored = batCard;
                        runs += batCard;
                        currentInningRuns += batCard;
                        outcome = `${batCard} Run(s)! (Free Hit)`;
                        if (batCard === 4 || batCard === 6) boundary = true;
                        if (batCard === 6) isSix = true;
                    }
                    freeHit = false;
                    freehitIndicator.classList.add('hidden');
                    isLegalBall = true;
                }
                // 3. Handle wickets (same number > 0)
                else if (batCard === bowlCard && batCard > 0) {
                    let wicketValue;
                    if (isTestMatch) {
                        wicketValue = 0.33;
                    } 
                    else if (currentFormat.name === "ODI") {
                        wicketValue = isPowerplay ? 0.25 : 0.5;
                    }
                    else {
                        wicketValue = isPowerplay ? 0.5 : 1.0;
                    }
                    
                    batterWickets[currentBatter] = (batterWickets[currentBatter] || 0) + wicketValue;
                    wickets += wicketValue;
                    
                    if (batterWickets[currentBatter] >= (isTestMatch ? 3.0 : 1.0)) {
                        isPlayerOut = true;
                        outcome = "WICKET! (Out)";
                        wickets = Math.ceil(wickets);
                        batterWickets[currentBatter] = 0;
                        fallOfWickets.push({
                            score: runs,
                            over: `${Math.floor(legalBalls/6)}.${legalBalls%6}`,
                            batter: currentBatter
                        });
                    } else {
                        outcome = `WICKET! (${(isTestMatch ? 3.0 : 1.0) - batterWickets[currentBatter]).toFixed(2)} wickets left)`;
                    }
                    
                    isLegalBall = true;
                    isWicket = true;
                }
                // 4. Handle batter playing 0
                else if (batCard === 0 && bowlCard > 0) {
                    if (zerosThisOver[battingPlayer] > 3) {
                        runs -= 5;
                        outcome = "4th 0 in over! -5 runs";
                    } else {
                        if (isTestMatch) {
                            bowlerRuns[currentBowler] = (bowlerRuns[currentBowler] || 0) + bowlCard;
                            outcome = `Bowler's ${bowlCard} runs added to their stats`;
                        } else {
                            runsScored = bowlCard;
                            runs += bowlCard;
                            currentInningRuns += bowlCard;
                            outcome = `Batter played 0. Runs = ${bowlCard}`;
                            if (bowlCard === 4 || bowlCard === 6) boundary = true;
                            if (bowlCard === 6) isSix = true;
                        }
                    }
                    isLegalBall = true;
                }
                // 5. Handle bowler playing 0
                else if (bowlCard === 0 && batCard > 0) {
                    if (zerosThisOver[bowlingPlayer] > 3 && !isTestMatch) {
                        outcome = "4th 0 in over! No ball";
                        runs += 1;
                        freeHitNextBall = true;
                    } else {
                        if (isTestMatch) {
                            runsScored = batCard;
                            runs += batCard;
                            currentInningRuns += batCard;
                            outcome = `${batCard} Run(s)!`;
                            if (batCard === 4 || batCard === 6) boundary = true;
                            if (batCard === 6) isSix = true;
                        } else {
                            outcome = "DOT BALL!";
                        }
                    }
                    isLegalBall = true;
                }
                // 6. Normal runs
                else {
                    runsScored = batCard;
                    runs += batCard;
                    currentInningRuns += batCard;
                    outcome = `${batCard} Run(s)!`;
                    if (batCard === 4 || batCard === 6) boundary = true;
                    if (batCard === 6) isSix = true;
                    isLegalBall = true;
                }

                // Update batter stats
                if (currentBatter && runsScored > 0) {
                    batterStats[currentBatter] = batterStats[currentBatter] || { runs: 0, balls: 0, fours: 0, sixes: 0, dots: 0 };
                    batterStats[currentBatter].runs += runsScored;
                    if (isLegalBall) batterStats[currentBatter].balls += 1;
                    
                    if (runsScored === 0 && isLegalBall) batterStats[currentBatter].dots += 1;
                    if (batCard === 4) batterStats[currentBatter].fours += 1;
                    if (batCard === 6) batterStats[currentBatter].sixes += 1;
                }
                
                // Update bowler stats
                if (currentBowler) {
                    bowlerStats[currentBowler] = bowlerStats[currentBowler] || { wickets: 0, runs: 0, balls: 0, maidens: 0 };
                    if (isWicket) bowlerStats[currentBowler].wickets += 1;
                    bowlerStats[currentBowler].runs += runsScored;
                    if (isLegalBall) bowlerStats[currentBowler].balls += 1;
                    
                    // Check for maiden over
                    if (isLegalBall && legalBalls % 6 === 0) {
                        const ballsThisOver = bowlerStats[currentBowler].balls % 6;
                        const runsThisOver = bowlerStats[currentBowler].runs - 
                            (bowlerStats[currentBowler].runsAtOverStart || 0);
                        
                        if (runsThisOver === 0 && ballsThisOver === 6) {
                            bowlerStats[currentBowler].maidens += 1;
                        }
                        
                        bowlerStats[currentBowler].runsAtOverStart = bowlerStats[currentBowler].runs;
                    }
                }

                // Record ball in ball-by-ball
                ballByBall[legalBalls] = {
                    runs: runsScored,
                    wicket: isWicket || isPlayerOut,
                    batter: currentBatter,
                    bowler: currentBowler,
                    timestamp: Date.now(),
                    outcome: outcome
                };

                // Record last wicket score for partnership
                if (isWicket) {
                    lastWicketScore = runs;
                }

                // Handle legal balls
                if (isLegalBall) {
                    legalBalls++;
                    if (isTestMatch) oversToday++;
                    
                    if (currentBowler) {
                        bowlerOvers[currentBowler] = (bowlerOvers[currentBowler] || 0) + (1/6);
                        if (legalBalls % 6 === 0) {
                            bowlerOvers[currentBowler] = Math.round(bowlerOvers[currentBowler] * 10) / 10;
                            zerosThisOver = { player1: 0, player2: 0 };
                        }
                    }
                    
                    // Check for end of day's play in test matches
                    if (isTestMatch && oversToday >= maxOversPerDay) {
                        endDaysPlay();
                        return;
                    }
                }

                // Update UI
                document.getElementById('ball-result').textContent = outcome;
                updateScoreboard();
                updateSpectatorData();
                
                // Check for milestones
                checkMilestones();
                checkBattingMilestones();

                // Check for match/innings end conditions
                if (innings === 2 && runs > team1Score) {
                    endMatch();
                    return;
                }
                
                if ((isTestMatch && currentInningWickets >= 30) || 
                    (!isTestMatch && (wickets >= currentFormat.totalWickets || legalBalls >= currentFormat.totalOvers * 6))) {
                    endInning();
                    return;
                }

                // Prepare for next ball
                setTimeout(async () => {
                    await resetPlays();
                    
                    if ((isPlayerOut || isWicket) && player === battingPlayer) {
                        batterSelected = false;
                        showBatterSelection();
                    } else if (isLegalBall && legalBalls % 6 === 0) {
                        bowlerSelected = false;
                        if (player === bowlingPlayer) {
                            showBowlerSelection();
                        } else {
                            status.textContent = "Waiting for opponent to select bowler...";
                        }
                    } else {
                        updateButtonStates();
                    }
                }, 1500);
            }

            // Set up Firebase listeners
            function setupFirebaseListeners() {
                let playTimeout;

                // Handle plays from both players
                onValue(playsRef, async (snap) => {
                    const plays = snap.val();
                    
                    if (!plays || plays.player1 === undefined || plays.player2 === undefined) {
                        return;
                    }

                    if (plays.player1 === null || plays.player2 === null) {
                        return;
                    }

                    // Check opponent connection
                    const connectionSnap = await get(opponentRef);
                    if (!connectionSnap.exists() || !connectionSnap.val()) {
                        status.textContent = "Opponent disconnected. Waiting...";
                        return;
                    }

                    // Determine batting and bowling players
                    const battingPlayer = innings % 2 === 1 ? battingFirst : (battingFirst === "player1" ? "player2" : "player1");
                    const bowlingPlayer = battingPlayer === "player1" ? "player2" : "player1";

                    const batCard = plays[battingPlayer];
                    const bowlCard = plays[bowlingPlayer];

                    // Process the outcome
                    await processBallOutcome(batCard, bowlCard, battingPlayer, bowlingPlayer);
                });

                // Listen for current batter changes
                onValue(batterRef, (snap) => {
                    const batter = snap.val();
                    if (batter && batter !== currentBatter) {
                        currentBatter = batter;
                        currentBatterEl.textContent = batter;
                        batterSelected = true;
                        if (!battersUsed.includes(batter)) {
                            battersUsed.push(batter);
                            if (batterWickets[batter] === undefined) {
                                batterWickets[batter] = 0;
                            }
                        }
                        updateButtonStates();
                    }
                });

                // Listen for current bowler changes
                onValue(bowlerRef, (snap) => {
                    const bowler = snap.val();
                    if (bowler && bowler !== currentBowler) {
                        currentBowler = bowler;
                        currentBowlerEl.textContent = bowler;
                        bowlerSelected = true;
                        updateButtonStates();
                    }
                });

                // Listen for follow-on status
                onValue(followOnRef, (snap) => {
                    const followOnBtn = document.getElementById("enforceFollowOn");
                    if (followOnBtn) {
                        followOnBtn.style.display = snap.exists() && snap.val() ? "block" : "none";
                    }
                });

                // Listen for spectator count
                onValue(spectatorsRef, (snap) => {
                    const spectators = snap.val() || {};
                    document.getElementById('spectatorCount').textContent = `üë• Spectators: ${Object.keys(spectators).length}`;
                });

                // Listen for reactions
                onValue(reactionsRef, (snap) => {
                    const reactions = snap.val();
                    if (!reactions) return;
                    
                    const lastReaction = Object.values(reactions).pop();
                    if (lastReaction && lastReaction.player !== player) {
                        showReaction(lastReaction.emoji);
                    }
                });
            }

            // Show reaction emoji
            function showReaction(emoji) {
                const reactionEl = document.createElement('div');
                reactionEl.textContent = emoji;
                reactionEl.style.position = 'fixed';
                reactionEl.style.fontSize = '48px';
                reactionEl.style.animation = 'fadeInOut 2s';
                reactionEl.style.zIndex = '999';
                reactionEl.style.left = `${Math.random() * 70 + 15}%`;
                reactionEl.style.top = `${Math.random() * 70 + 15}%`;
                document.body.appendChild(reactionEl);
                setTimeout(() => reactionEl.remove(), 2000);
            }

            // Set up card button events
            function setupCardButtons() {
                buttons.forEach(btn => {
                    btn.addEventListener("click", async () => {
                        const val = parseInt(btn.dataset.value);
                        disableButtons();
                        status.textContent = "Waiting for opponent...";
                        
                        try {
                            const opponentOnline = await get(opponentRef);
                            if (!opponentOnline.exists() || !opponentOnline.val()) {
                                status.textContent = "Opponent is offline!";
                                updateButtonStates();
                                return;
                            }
                            
                            await update(playsRef, {
                                [player]: val
                            });
                        } catch (error) {
                            console.error("Error submitting play:", error);
                            status.textContent = "Error submitting play - try again";
                            updateButtonStates();
                        }
                    });
                });
            }

            // End current inning
            async function endInning() {
                disableButtons();
                
                // Update team scores
                if (innings === 1) {
                    team1Score = currentInningRuns;
                    team1Wickets = wickets;
                    status.textContent = `Team 1 scored ${team1Score} runs!`;
                    
                    if (!isTestMatch) {
                        startInningsBtn.classList.remove('hidden');
                        status.textContent += " Click 'Start Second Innings' when ready.";
                        
                        await set(inningsReadyRef, false);
                        
                        // Set auto-start timer for 30 seconds
                        const autoStartTime = Date.now() + 30000;
                        await set(autoStartTimeRef, autoStartTime);
                        
                        return;
                    }
                } else {
                    team2Score = currentInningRuns;
                    team2Wickets = wickets;
                    status.textContent = `Team 2 scored ${team2Score} runs!`;
                }
                
                // Check for follow-on in test matches
                const followOnPossible = isTestMatch && innings === 2 && team1Score - team2Score >= 200;
                
                if (followOnPossible) {
                    status.textContent = `Team 1 can enforce follow-on (lead of ${team1Score - team2Score})`;
                    await set(followOnRef, true);
                } else {
                    if (isTestMatch) {
                        innings++;
                        if (innings > 2) {
                            endMatch();
                            return;
                        }
                        resetInning();
                    }
                }
                
                updateScoreboard();
                updateSpectatorData();
            }

            // Reset inning state
            async function resetInning() {
                runs = 0;
                wickets = 0;
                currentInningRuns = 0;
                currentInningWickets = 0;
                legalBalls = 0;
                oversToday = 0;
                battersUsed = [];
                bowlerOvers = {};
                batterWickets = {};
                freeHit = false;
                freeHitNextBall = false;
                currentBatter = null;
                currentBowler = null;
                batterSelected = false;
                bowlerSelected = false;
                zerosThisOver = { player1: 0, player2: 0 };
                fallOfWickets = [];
                
                await update(playsRef, { player1: null, player2: null });
                
                isBatting = (innings % 2 === 1) ? (player === battingFirst) : (player !== battingFirst);
                
                startInningsBtn.classList.add('hidden');
                opponentReadyStatus.classList.add('hidden');
                autoStartTimerEl.classList.add('hidden');
                startInningsText.textContent = "Start Second Innings";
                
                await set(inningsReadyRef, false);
                await set(autoStartTimeRef, null);
                await set(batterRef, null);
                await set(bowlerRef, null);
                
                setupRole();
            }

            // End day's play (Test matches)
            function endDaysPlay() {
                disableButtons();
                status.textContent = "Stumps for the day!";
                daysRemaining--;
                
                setTimeout(() => {
                    if (daysRemaining > 0) {
                        oversToday = 0;
                        updateButtonStates();
                        status.textContent = `Day ${6 - daysRemaining} starting...`;
                        updateScoreboard();
                        updateSpectatorData();
                    } else {
                        endMatch();
                    }
                }, 3000);
            }

            // End match and show result
            async function endMatch() {
                let result = "";
                let winner = "";
                let winMargin = 0;
                
                if (isTestMatch) {
                    if (team1Score > team2Score) {
                        winMargin = team1Score - team2Score;
                        result = `Team 1 wins by ${winMargin} runs`;
                        winner = "player1";
                    } else if (team2Score > team1Score) {
                        winMargin = 10 - Math.floor(team2Wickets);
                        result = `Team 2 wins by ${winMargin} wickets`;
                        winner = "player2";
                    } else {
                        result = "Match drawn";
                    }
                } else {
                    if (innings === 2) {
                        if (team2Score > team1Score) {
                            winMargin = currentFormat.totalWickets - Math.floor(team2Wickets);
                            result = `Team 2 wins by ${winMargin} wickets`;
                            winner = "player2";
                        } else if (team1Score > team2Score) {
                            winMargin = team1Score - team2Score;
                            result = `Team 1 wins by ${winMargin} runs`;
                            winner = "player1";
                        } else {
                            result = "Match tied";
                        }
                    } else {
                        winMargin = currentFormat.totalWickets - Math.floor(team1Wickets);
                        result = `Team 1 wins by ${winMargin} wickets`;
                        winner = "player1";
                    }
                }
                
                // Show winner celebration
                if (winner) {
                    showNotification(`${winner === "player1" ? "Team 1" : "Team 2"} wins the match! üèÜ`, 'winner');
                    createConfetti();
                }
                
                status.textContent = `Match Over! ${result}`;
                disableButtons();
                
                // Save result to Firebase
                await set(resultRef, result);
                updateSpectatorData();
                
                // Redirect to results page after delay
                setTimeout(() => {
                    window.location.href = `result.html?room=${room}&player=${player}&winner=${winner}&result=${encodeURIComponent(result)}`;
                }, 5000);
            }

            // Check for milestones (centuries, 5-wicket hauls)
            function checkMilestones() {
                if (currentBatter && batterStats[currentBatter]?.runs >= 100 && 
                    !batterStats[currentBatter].centuryNotified) {
                    showNotification(`${currentBatter} scores a century! üéâ`, 'batting');
                    batterStats[currentBatter].centuryNotified = true;
                    createConfetti();
                }
                
                if (currentBowler && bowlerStats[currentBowler]?.wickets >= 5 && 
                    !bowlerStats[currentBowler].fiveWicketNotified) {
                    showNotification(`${currentBowler} takes 5 wickets! üéØ`, 'bowling');
                    bowlerStats[currentBowler].fiveWicketNotified = true;
                    createConfetti();
                }
            }

            // Update button states based on selection status
            function updateButtonStates() {
                const bothReady = batterSelected && bowlerSelected;
                
                buttons.forEach(btn => {
                    btn.disabled = !bothReady;
                    btn.style.opacity = bothReady ? '1' : '0.6';
                });

                status.textContent = bothReady ? 
                    (freeHit ? "FREE HIT! Play your card..." : "Play your card...") :
                    "Waiting for batter/bowler selection...";
            }

            // Disable all card buttons
            function disableButtons() {
                buttons.forEach(btn => {
                    btn.disabled = true;
                    btn.style.opacity = '0.6';
                });
                if (!startInningsBtn.classList.contains('hidden')) {
                    startInningsBtn.disabled = true;
                }
            }

            // Enable all card buttons if both players are selected
            function enableButtons() {
                if (batterSelected && bowlerSelected) {
                    buttons.forEach(btn => {
                        btn.disabled = false;
                        btn.style.opacity = '1';
                    });
                    if (!startInningsBtn.classList.contains('hidden')) {
                        startInningsBtn.disabled = false;
                    }
                }
            }

            // Initialize the game
            async function initGame() {
                try {
                    status.textContent = "Initializing game...";
                    
                    gameInProgress = true;
                    status.textContent = "Initializing game...";
                    
                    // Check if room exists
                    const roomSnap = await get(roomRef);
                    if (!roomSnap.exists()) {
                        showNotification("Room does not exist!", 'error');
                        setTimeout(() => window.location.href = "index.html", 2000);
                        return;
                    }

                    const roomData = roomSnap.val();
                    
                    // Check toss status first
                    if (!roomData.tossWinner || !roomData.battingFirst) {
                        showNotification("Toss not completed yet!", 'info');
                        setTimeout(() => window.location.href = `toss.html?room=${room}&player=${player}`, 2000);
                        return;
                    }

                    // Get toss and batting first info
                    tossWinner = roomData.tossWinner;
                    battingFirst = roomData.battingFirst;
                    
                    // Set game format
                    const format = roomData.player1?.format || "5";
                    currentFormat = formatRules[format];
                    isTestMatch = format === "test";
                    
                    formatDisplay.textContent = `${currentFormat.name} | ${isTestMatch ? "3 wickets per batter" : "1 wicket per batter"}`;
                    
                    // Initialize batter stats
                    initializeBatterStats();

                    // Set up game components
                    await setupRole();
                    setupSelectionModal();
                    setupInningsButton();
                    setupCardButtons();
                    setupFirebaseListeners();
                    
                    // Initial UI update
                    updateScoreboard();
                    status.textContent = "Game ready!";
                } catch (error) {
                    console.error("Initialization error:", error);
                    showNotification("Failed to initialize game", 'error');
                    setTimeout(initGame, 3000); // Retry instead of redirecting immediately
                }
            }

            // Start the game
            initGame();
        </script>
    </div>
</body>
  </html>
