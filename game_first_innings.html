<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HandiCricket - First Innings</title>
  <style>
    :root {
      --primary: #1e88e5;
      --primary-dark: #1565c0;
      --secondary: #ffeb3b;
      --secondary-dark: #fbc02d;
      --danger: #f44336;
      --danger-dark: #d32f2f;
      --success: #4CAF50;
      --success-dark: #2E7D32;
      --warning: #FF9800;
      --warning-dark: #F57C00;
      --info: #2196F3;
      --info-dark: #1976D2;
      --dark: #061e3e;
      --darker: #0a2a4a;
      --light: #ffffff;
      --lighter: #f5f5f5;
      --gray: #cccccc;
      --dark-gray: #666666;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background-color: var(--dark);
      color: var(--light);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      overflow-x: hidden;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .header {
      background: linear-gradient(135deg, var(--darker), var(--dark));
      padding: 10px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      z-index: 10;
    }

    .header h1 {
      color: var(--secondary);
      text-shadow: 0 0 5px rgba(255, 235, 59, 0.5);
      font-size: 1.5rem;
    }

    .room-info {
      display: flex;
      gap: 15px;
      font-size: 0.9rem;
    }

    .room-info span {
      background: rgba(30, 136, 229, 0.2);
      padding: 5px 10px;
      border-radius: 15px;
      border: 1px solid var(--primary);
    }

    .game-container {
      display: flex;
      flex: 1;
      overflow: hidden;
      position: relative;
    }

    .cricket-ground {
      flex: 1;
      background: url('1000012316.jpg') center/cover no-repeat;
      position: relative;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .pitch {
      width: 80%;
      height: 20px;
      background: linear-gradient(to right, #8B4513, #A0522D, #8B4513);
      position: relative;
      transform: rotate(90deg);
      z-index: 1;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
    }

    .stumps {
      position: absolute;
      width: 40px;
      height: 120px;
      background: linear-gradient(to bottom, #8B4513, #A0522D);
      display: flex;
      justify-content: space-between;
      padding: 0 5px;
      z-index: 2;
    }

    .stump {
      width: 5px;
      height: 100%;
      background: linear-gradient(to bottom, #654321, #8B4513);
      position: relative;
    }

    .bails {
      position: absolute;
      width: 100%;
      height: 5px;
      background: #ffffff;
      top: 0;
      left: 0;
    }

    .batsman {
      position: absolute;
      width: 30px;
      height: 60px;
      background: url('batsman.png') center/contain no-repeat;
      z-index: 3;
      bottom: 50px;
      left: 50%;
      transform: translateX(-50%);
      transition: all 0.3s ease;
    }

    .bowler {
      position: absolute;
      width: 30px;
      height: 60px;
      background: url('bowler.png') center/contain no-repeat;
      z-index: 3;
      top: 50px;
      left: 50%;
      transform: translateX(-50%);
      transition: all 0.3s ease;
    }

    .ball {
      position: absolute;
      width: 15px;
      height: 15px;
      background: #ff5722;
      border-radius: 50%;
      z-index: 4;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
      transition: all 0.5s cubic-bezier(0.17, 0.67, 0.83, 0.67);
    }

    .score-panel {
      width: 300px;
      background: rgba(0, 0, 0, 0.7);
      border-left: 1px solid rgba(255, 255, 255, 0.1);
      padding: 15px;
      overflow-y: auto;
      z-index: 5;
    }

    .score-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .score-title {
      font-size: 1.2rem;
      color: var(--secondary);
    }

    .score-display {
      font-size: 1.5rem;
      font-weight: bold;
    }

    .over-display {
      font-size: 0.9rem;
      color: var(--gray);
    }

    .batter-stats, .bowler-stats {
      margin: 15px 0;
      padding: 10px;
      background: rgba(30, 136, 229, 0.1);
      border-radius: 5px;
    }

    .stats-title {
      font-size: 0.9rem;
      color: var(--secondary);
      margin-bottom: 5px;
    }

    .stats-row {
      display: flex;
      justify-content: space-between;
      margin: 5px 0;
      font-size: 0.9rem;
    }

    .stats-name {
      font-weight: bold;
    }

    .stats-value {
      color: var(--secondary);
    }

    .wicket-bar {
      height: 10px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 5px;
      margin-top: 5px;
      overflow: hidden;
    }

    .wicket-progress {
      height: 100%;
      background: var(--danger);
      width: 100%;
      transition: width 0.3s ease;
    }

    .controls {
      margin-top: 20px;
    }

    .card-selection {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }

    .card-btn {
      padding: 10px;
      border: none;
      border-radius: 5px;
      background: var(--primary);
      color: white;
      font-weight: bold;
      font-size: 1.2rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .card-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
    }

    .card-btn:active {
      transform: translateY(0);
    }

    .action-btns {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .action-btn {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 5px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }

    .submit-btn {
      background: var(--success);
    }

    .submit-btn:hover {
      background: var(--success-dark);
    }

    .skip-btn {
      background: var(--warning);
    }

    .skip-btn:hover {
      background: var(--warning-dark);
    }

    .undo-btn {
      background: var(--danger);
    }

    .undo-btn:hover {
      background: var(--danger-dark);
    }

    .team-selection-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 100;
    }

    .team-modal-content {
      background: var(--darker);
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
    }

    .team-modal-title {
      color: var(--secondary);
      margin-bottom: 15px;
      text-align: center;
    }

    .player-list {
      list-style: none;
      margin: 15px 0;
    }

    .player-item {
      padding: 10px;
      margin: 5px 0;
      background: rgba(30, 136, 229, 0.2);
      border-radius: 5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .player-name {
      font-weight: bold;
    }

    .player-role {
      font-size: 0.8rem;
      color: var(--gray);
    }

    .captain-badge {
      background: gold;
      color: black;
      padding: 2px 5px;
      border-radius: 3px;
      font-size: 0.7rem;
      margin-left: 5px;
    }

    .vice-badge {
      background: silver;
      color: black;
      padding: 2px 5px;
      border-radius: 3px;
      font-size: 0.7rem;
      margin-left: 5px;
    }

    .select-batter, .select-bowler {
      margin-top: 10px;
    }

    .select-title {
      font-size: 0.9rem;
      margin-bottom: 5px;
      color: var(--secondary);
    }

    .select-dropdown {
      width: 100%;
      padding: 8px;
      border-radius: 5px;
      border: none;
      background: var(--light);
      color: var(--dark);
    }

    .confirm-btn {
      width: 100%;
      padding: 10px;
      margin-top: 15px;
      background: var(--success);
      color: white;
      border: none;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }

    .confirm-btn:hover {
      background: var(--success-dark);
    }

    .innings-summary-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 100;
    }

    .summary-content {
      background: var(--darker);
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
    }

    .summary-title {
      color: var(--secondary);
      text-align: center;
      margin-bottom: 15px;
    }

    .summary-stats {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
    }

    .summary-stat {
      text-align: center;
      padding: 10px;
      background: rgba(30, 136, 229, 0.2);
      border-radius: 5px;
      flex: 1;
      margin: 0 5px;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--secondary);
    }

    .stat-label {
      font-size: 0.8rem;
      color: var(--gray);
    }

    .batters-table, .bowlers-table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
      font-size: 0.9rem;
    }

    .batters-table th, .bowlers-table th {
      background: rgba(30, 136, 229, 0.5);
      padding: 8px;
      text-align: left;
    }

    .batters-table td, .bowlers-table td {
      padding: 8px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .batters-table tr:nth-child(even), .bowlers-table tr:nth-child(even) {
      background: rgba(30, 136, 229, 0.1);
    }

    .continue-btn {
      width: 100%;
      padding: 10px;
      margin-top: 15px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }

    .continue-btn:hover {
      background: var(--primary-dark);
    }

    .match-result-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 100;
    }

    .result-content {
      background: var(--darker);
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      text-align: center;
    }

    .result-title {
      color: var(--secondary);
      font-size: 1.5rem;
      margin-bottom: 15px;
    }

    .result-message {
      font-size: 1.2rem;
      margin-bottom: 15px;
    }

    .result-stats {
      margin: 15px 0;
      padding: 15px;
      background: rgba(30, 136, 229, 0.2);
      border-radius: 5px;
    }

    .result-stat {
      display: flex;
      justify-content: space-between;
      margin: 10px 0;
    }

    .save-btn {
      width: 100%;
      padding: 10px;
      margin-top: 15px;
      background: var(--success);
      color: white;
      border: none;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }

    .save-btn:hover {
      background: var(--success-dark);
    }

    .powerplay-indicator {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(255, 235, 59, 0.3);
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.8rem;
      color: var(--secondary);
      border: 1px solid var(--secondary);
      z-index: 5;
    }

    .dead-over-indicator {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(255, 0, 0, 0.3);
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.8rem;
      color: var(--danger);
      border: 1px solid var(--danger);
      z-index: 5;
    }

    .freehit-indicator {
      position: absolute;
      top: 40px;
      left: 10px;
      background: rgba(0, 255, 0, 0.3);
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.8rem;
      color: #00ff00;
      border: 1px solid #00ff00;
      z-index: 5;
    }

    .dot-counter {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(255, 255, 255, 0.2);
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.8rem;
      z-index: 5;
    }

    .zero-counter {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background: rgba(255, 255, 255, 0.2);
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.8rem;
      z-index: 5;
    }

    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      z-index: 100;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .toast.show {
      opacity: 1;
    }

    @keyframes bat {
      0% { transform: translateX(-50%) rotate(0deg); }
      50% { transform: translateX(-50%) rotate(30deg); }
      100% { transform: translateX(-50%) rotate(0deg); }
    }

    @keyframes bowl {
      0% { transform: translateX(-50%) translateY(0); }
      50% { transform: translateX(-50%) translateY(100px); }
      100% { transform: translateX(-50%) translateY(0); }
    }

    @keyframes ball {
      0% { transform: translate(-50%, -50%) scale(1); }
      50% { transform: translate(-50%, -50%) scale(1.2); }
      100% { transform: translate(-50%, -50%) scale(1); }
    }

    @keyframes wicket {
      0% { transform: translateY(0); }
      50% { transform: translateY(-20px); }
      100% { transform: translateY(0); }
    }

    @keyframes boundary {
      0% { transform: scale(1); opacity: 1; }
      100% { transform: scale(3); opacity: 0; }
    }

    @media (max-width: 768px) {
      .game-container {
        flex-direction: column;
      }

      .score-panel {
        width: 100%;
        height: 300px;
      }

      .cricket-ground {
        height: 300px;
      }
    }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <div class="header">
    <h1>HandiCricket - First Innings</h1>
    <div class="room-info">
      <span id="roomCodeDisplay">Room: 0000</span>
      <span id="formatDisplay">Format: T20</span>
    </div>
  </div>

  <div class="game-container">
    <div class="cricket-ground">
      <div class="powerplay-indicator" id="powerplayIndicator" style="display: none;">POWERPLAY</div>
      <div class="dead-over-indicator" id="deadOverIndicator" style="display: none;">DEAD OVER</div>
      <div class="freehit-indicator" id="freehitIndicator" style="display: none;">FREE HIT</div>
      <div class="dot-counter" id="dotCounter">Dots: 0/3</div>
      <div class="zero-counter" id="zeroCounter">Zeros: 0/3</div>
      
      <div class="pitch">
        <div class="stumps">
          <div class="stump">
            <div class="bails"></div>
          </div>
          <div class="stump">
            <div class="bails"></div>
          </div>
          <div class="stump">
            <div class="bails"></div>
          </div>
        </div>
      </div>
      <div class="batsman" id="batsman"></div>
      <div class="bowler" id="bowler"></div>
      <div class="ball" id="ball"></div>
    </div>

    <div class="score-panel">
      <div class="score-header">
        <div class="score-title">Score</div>
        <div class="score-display" id="scoreDisplay">0/0</div>
      </div>
      <div class="over-display" id="overDisplay">Over: 0.0</div>

      <div class="batter-stats">
        <div class="stats-title">Batter: <span id="currentBatter">Player 1</span></div>
        <div class="stats-row">
          <span class="stats-name">Runs:</span>
          <span class="stats-value" id="batterRuns">0</span>
        </div>
        <div class="stats-row">
          <span class="stats-name">Balls:</span>
          <span class="stats-value" id="batterBalls">0</span>
        </div>
        <div class="stats-row">
          <span class="stats-name">SR:</span>
          <span class="stats-value" id="batterSR">0.00</span>
        </div>
        <div class="stats-row">
          <span class="stats-name">Wicket:</span>
          <span class="stats-value" id="batterWicket">1.00</span>
        </div>
        <div class="wicket-bar">
          <div class="wicket-progress" id="wicketProgress" style="width: 100%;"></div>
        </div>
      </div>

      <div class="bowler-stats">
        <div class="stats-title">Bowler: <span id="currentBowler">Player A</span></div>
        <div class="stats-row">
          <span class="stats-name">Overs:</span>
          <span class="stats-value" id="bowlerOvers">0.0</span>
        </div>
        <div class="stats-row">
          <span class="stats-name">Runs:</span>
          <span class="stats-value" id="bowlerRuns">0</span>
        </div>
        <div class="stats-row">
          <span class="stats-name">Wickets:</span>
          <span class="stats-value" id="bowlerWickets">0</span>
        </div>
        <div class="stats-row">
          <span class="stats-name">ER:</span>
          <span class="stats-value" id="bowlerER">0.00</span>
        </div>
      </div>

      <div class="controls">
        <div class="card-selection">
          <button class="card-btn" data-card="0">0</button>
          <button class="card-btn" data-card="1">1</button>
          <button class="card-btn" data-card="2">2</button>
          <button class="card-btn" data-card="3">3</button>
          <button class="card-btn" data-card="4">4</button>
          <button class="card-btn" data-card="5">5</button>
          <button class="card-btn" data-card="6">6</button>
        </div>
        <div class="action-btns">
          <button class="action-btn submit-btn" id="submitBtn">Submit</button>
          <button class="action-btn skip-btn" id="skipBtn">Skip</button>
          <button class="action-btn undo-btn" id="undoBtn">Undo</button>
        </div>
      </div>
    </div>
  </div>

  <div class="team-selection-modal" id="teamSelectionModal">
    <div class="team-modal-content">
      <h2 class="team-modal-title">Select Your Team</h2>
      <ul class="player-list" id="teamPlayerList">
        <!-- Players will be added here -->
      </ul>
      <div class="select-batter">
        <div class="select-title">Select Batter:</div>
        <select class="select-dropdown" id="batterSelect">
          <option value="">-- Select Batter --</option>
        </select>
      </div>
      <div class="select-bowler">
        <div class="select-title">Select Bowler:</div>
        <select class="select-dropdown" id="bowlerSelect">
          <option value="">-- Select Bowler --</option>
        </select>
      </div>
      <button class="confirm-btn" id="confirmTeamBtn">Confirm Selection</button>
    </div>
  </div>

  <div class="innings-summary-modal" id="inningsSummaryModal">
    <div class="summary-content">
      <h2 class="summary-title">Innings Summary</h2>
      <div class="summary-stats">
        <div class="summary-stat">
          <div class="stat-value" id="summaryRuns">0</div>
          <div class="stat-label">Runs</div>
        </div>
        <div class="summary-stat">
          <div class="stat-value" id="summaryWickets">0</div>
          <div class="stat-label">Wickets</div>
        </div>
        <div class="summary-stat">
          <div class="stat-value" id="summaryOvers">0.0</div>
          <div class="stat-label">Overs</div>
        </div>
        <div class="summary-stat">
          <div class="stat-value" id="summaryRR">0.00</div>
          <div class="stat-label">Run Rate</div>
        </div>
      </div>
      <h3>Batting Performance</h3>
      <table class="batters-table">
        <thead>
          <tr>
            <th>Batter</th>
            <th>Runs</th>
            <th>Balls</th>
            <th>SR</th>
          </tr>
        </thead>
        <tbody id="battersSummary">
          <!-- Batter stats will be added here -->
        </tbody>
      </table>
      <h3>Bowling Performance</h3>
      <table class="bowlers-table">
        <thead>
          <tr>
            <th>Bowler</th>
            <th>Overs</th>
            <th>Runs</th>
            <th>Wkts</th>
            <th>ER</th>
          </tr>
        </thead>
        <tbody id="bowlersSummary">
          <!-- Bowler stats will be added here -->
        </tbody>
      </table>
      <button class="continue-btn" id="continueInningsBtn">Continue to Next Innings</button>
    </div>
  </div>

  <div class="match-result-modal" id="matchResultModal">
    <div class="result-content">
      <h2 class="result-title">Match Result</h2>
      <div class="result-message" id="resultMessage">Team A won by 10 runs</div>
      <div class="result-stats">
        <div class="result-stat">
          <span>Team A:</span>
          <span id="team1ScoreResult">150/5 (20.0)</span>
        </div>
        <div class="result-stat">
          <span>Team B:</span>
          <span id="team2ScoreResult">140/8 (20.0)</span>
        </div>
        <div class="result-stat">
          <span>Player of the Match:</span>
          <span id="pomResult">Player X</span>
        </div>
      </div>
      <button class="save-btn" id="saveMatchBtn">Save Match Data</button>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, get, push } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCN6aZMwlsZe7JJaovU0WA3UQygWr4jYmA",
      authDomain: "handicricket-85a06.firebaseapp.com",
      projectId: "handicricket-85a06",
      storageBucket: "handicricket-85a06.appspot.com",
      messagingSenderId: "599182538558",
      appId: "1:599182538558:web:3e965753ab05f8f1e3de6f",
      measurementId: "G-HSV9H4LEJQ"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Get URL parameters
    const params = new URLSearchParams(window.location.search);
    const roomId = params.get('room');
    const playerRole = params.get('player'); // player1 or player2
    const opponentRole = playerRole === 'player1' ? 'player2' : 'player1';

    if (!roomId || !playerRole) {
      alert('Invalid room or player');
      window.location.href = 'index.html';
    }

    // Firebase references
    const roomRef = ref(db, `rooms/${roomId}`);
    const gameRef = ref(db, `games/${roomId}`);
    const playerRef = ref(db, `games/${roomId}/${playerRole}`);
    const opponentRef = ref(db, `games/${roomId}/${opponentRole}`);
    const tossRef = ref(db, `rooms/${roomId}/toss`);
    const teamsRef = ref(db, `rooms/${roomId}/teams`);
    const completedMatchesRef = ref(db, 'completedMatches');

    // Game state
    let gameState = {
      battingTeam: playerRole,
      bowlingTeam: opponentRole,
      currentInnings: 'first',
      innings: {
        first: {
          runs: 0,
          wickets: 0,
          balls: 0,
          overs: 0,
          batterStats: {},
          bowlerStats: {},
          batters: [],
          bowlers: [],
          currentBatter: null,
          currentBowler: null,
          extras: 0,
          isPowerplay: true,
          isDeadOver: false,
          isFreeHit: false,
          dotBalls: 0,
          zeroDeliveries: 0
        },
        second: {
          runs: 0,
          wickets: 0,
          balls: 0,
          overs: 0,
          batterStats: {},
          bowlerStats: {},
          batters: [],
          bowlers: [],
          currentBatter: null,
          currentBowler: null,
          extras: 0,
          isPowerplay: true,
          isDeadOver: false,
          isFreeHit: false,
          dotBalls: 0,
          zeroDeliveries: 0
        }
      },
      matchFormat: '20', // Default to T20
      powerplayOvers: {
        '5': [1, 2], // T5: overs 1-2
        '10': [1, 3], // T10: overs 1-3
        '20': [1, 6], // T20: overs 1-6
        '50': [[1, 10], [21, 30], [41, 42]] // ODI: multiple powerplays
      },
      deadOvers: [], // For ODI format
      maxOversPerBowler: {
        '5': 1, // T5: max 1 over per bowler
        '10': 2, // T10: max 2 overs per bowler
        '20': 4, // T20: max 4 overs per bowler
        '50': 10 // ODI: max 10 overs per bowler
      },
      teams: {
        player1: {
          name: '',
          players: [],
          captain: '',
          viceCaptain: ''
        },
        player2: {
          name: '',
          players: [],
          captain: '',
          viceCaptain: ''
        }
      },
      toss: {
        winner: '',
        battingFirst: '',
        battingChoice: ''
      },
      currentBall: {
        batterCard: null,
        bowlerCard: null,
        runs: 0,
        isWicket: false,
        isNoBall: false,
        isWide: false,
        isBye: false,
        isLegBye: false,
        isFreeHit: false
      },
      isGameStarted: false,
      isGameOver: false,
      winner: null,
      winningMargin: '',
      playerOfTheMatch: '',
      timestamp: Date.now()
    };

    // DOM elements
    const roomCodeDisplay = document.getElementById('roomCodeDisplay');
    const formatDisplay = document.getElementById('formatDisplay');
    const scoreDisplay = document.getElementById('scoreDisplay');
    const overDisplay = document.getElementById('overDisplay');
    const currentBatter = document.getElementById('currentBatter');
    const batterRuns = document.getElementById('batterRuns');
    const batterBalls = document.getElementById('batterBalls');
    const batterSR = document.getElementById('batterSR');
    const batterWicket = document.getElementById('batterWicket');
    const wicketProgress = document.getElementById('wicketProgress');
    const currentBowler = document.getElementById('currentBowler');
    const bowlerOvers = document.getElementById('bowlerOvers');
    const bowlerRuns = document.getElementById('bowlerRuns');
    const bowlerWickets = document.getElementById('bowlerWickets');
    const bowlerER = document.getElementById('bowlerER');
    const cardButtons = document.querySelectorAll('.card-btn');
    const submitBtn = document.getElementById('submitBtn');
    const skipBtn = document.getElementById('skipBtn');
    const undoBtn = document.getElementById('undoBtn');
    const teamSelectionModal = document.getElementById('teamSelectionModal');
    const teamPlayerList = document.getElementById('teamPlayerList');
    const batterSelect = document.getElementById('batterSelect');
    const bowlerSelect = document.getElementById('bowlerSelect');
    const confirmTeamBtn = document.getElementById('confirmTeamBtn');
    const inningsSummaryModal = document.getElementById('inningsSummaryModal');
    const summaryRuns = document.getElementById('summaryRuns');
    const summaryWickets = document.getElementById('summaryWickets');
    const summaryOvers = document.getElementById('summaryOvers');
    const summaryRR = document.getElementById('summaryRR');
    const battersSummary = document.getElementById('battersSummary');
    const bowlersSummary = document.getElementById('bowlersSummary');
    const continueInningsBtn = document.getElementById('continueInningsBtn');
    const matchResultModal = document.getElementById('matchResultModal');
    const resultMessage = document.getElementById('resultMessage');
    const team1ScoreResult = document.getElementById('team1ScoreResult');
    const team2ScoreResult = document.getElementById('team2ScoreResult');
    const pomResult = document.getElementById('pomResult');
    const saveMatchBtn = document.getElementById('saveMatchBtn');
    const powerplayIndicator = document.getElementById('powerplayIndicator');
    const deadOverIndicator = document.getElementById('deadOverIndicator');
    const freehitIndicator = document.getElementById('freehitIndicator');
    const dotCounter = document.getElementById('dotCounter');
    const zeroCounter = document.getElementById('zeroCounter');
    const toast = document.getElementById('toast');
    const batsman = document.getElementById('batsman');
    const bowler = document.getElementById('bowler');
    const ball = document.getElementById('ball');

    // Animation functions
    function animateBat() {
      batsman.style.animation = 'bat 0.5s ease-in-out';
      setTimeout(() => {
        batsman.style.animation = '';
      }, 500);
    }

    function animateBowl() {
      bowler.style.animation = 'bowl 0.5s ease-in-out';
      setTimeout(() => {
        bowler.style.animation = '';
      }, 500);
    }

    function animateBall() {
      ball.style.display = 'block';
      ball.style.left = '50%';
      ball.style.top = '50%';
      ball.style.transform = 'translate(-50%, -50%)';
      ball.style.animation = 'ball 0.5s ease-in-out';
      setTimeout(() => {
        ball.style.animation = '';
        ball.style.display = 'none';
      }, 500);
    }

    function animateWicket() {
      const stumps = document.querySelector('.stumps');
      stumps.style.animation = 'wicket 0.5s ease-in-out';
      setTimeout(() => {
        stumps.style.animation = '';
      }, 500);
    }

    function animateBoundary() {
      const boundary = document.createElement('div');
      boundary.style.position = 'absolute';
      boundary.style.width = '50px';
      boundary.style.height = '50px';
      boundary.style.borderRadius = '50%';
      boundary.style.border = '2px solid gold';
      boundary.style.left = '50%';
      boundary.style.top = '50%';
      boundary.style.transform = 'translate(-50%, -50%)';
      boundary.style.animation = 'boundary 1s ease-in-out forwards';
      document.querySelector('.cricket-ground').appendChild(boundary);
      setTimeout(() => {
        boundary.remove();
      }, 1000);
    }

    // Helper functions
    function showToast(message, duration = 3000) {
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, duration);
    }

    function calculateStrikeRate(runs, balls) {
      return balls > 0 ? ((runs / balls) * 100).toFixed(2) : '0.00';
    }

    function calculateEconomyRate(runs, overs) {
      return overs > 0 ? (runs / overs).toFixed(2) : '0.00';
    }

    function formatOvers(balls) {
      const overs = Math.floor(balls / 6);
      const ballsInOver = balls % 6;
      return `${overs}.${ballsInOver}`;
    }

    function isPowerplay(innings, currentOver) {
      const format = gameState.matchFormat;
      const powerplay = gameState.powerplayOvers[format];
      
      if (!powerplay) return false;
      
      if (format === '50') {
        // ODI has multiple powerplays
        return powerplay.some(([start, end]) => currentOver >= start && currentOver <= end);
      } else {
        // Other formats have single powerplay
        return currentOver >= powerplay[0] && currentOver <= powerplay[1];
      }
    }

    function isDeadOver(innings, currentOver) {
      if (gameState.matchFormat !== '50') return false;
      return gameState.deadOvers.includes(Math.floor(currentOver) + 1);
    }

    function getWicketValue() {
      const innings = gameState.innings[gameState.currentInnings];
      const currentOver = innings.overs + (innings.balls / 6);
      
      if (gameState.matchFormat === 'test') {
        return 0.33; // 1/3 of a wicket in Test
      } else if (innings.isPowerplay) {
        if (gameState.matchFormat === '50') {
          return 0.25; // 1/4 of a wicket in ODI powerplay
        } else {
          return 0.5; // 1/2 of a wicket in other formats' powerplay
        }
      } else {
        if (gameState.matchFormat === '50') {
          return 0.5; // 1/2 of a wicket in ODI non-powerplay
        } else {
          return 1.0; // Full wicket in other formats' non-powerplay
        }
      }
    }

    function updateUI() {
      const innings = gameState.innings[gameState.currentInnings];
      const batter = innings.currentBatter;
      const bowler = innings.currentBowler;
      
      // Update scoreboard
      scoreDisplay.textContent = `${innings.runs}/${innings.wickets}`;
      overDisplay.textContent = `Over: ${formatOvers(innings.balls)}`;
      
      // Update batter stats
      if (batter && innings.batterStats[batter]) {
        const stats = innings.batterStats[batter];
        currentBatter.textContent = batter;
        batterRuns.textContent = stats.runs;
        batterBalls.textContent = stats.balls;
        batterSR.textContent = calculateStrikeRate(stats.runs, stats.balls);
        batterWicket.textContent = stats.wicket.toFixed(2);
        wicketProgress.style.width = `${stats.wicket * 100}%`;
      }
      
      // Update bowler stats
      if (bowler && innings.bowlerStats[bowler]) {
        const stats = innings.bowlerStats[bowler];
        currentBowler.textContent = bowler;
        bowlerOvers.textContent = formatOvers(stats.balls);
        bowlerRuns.textContent = stats.runs;
        bowlerWickets.textContent = stats.wickets;
        bowlerER.textContent = calculateEconomyRate(stats.runs, stats.balls / 6);
      }
      
      // Update powerplay/dead over indicators
      const currentOver = innings.overs + (innings.balls / 6);
      innings.isPowerplay = isPowerplay(innings, currentOver);
      innings.isDeadOver = isDeadOver(innings, currentOver);
      
      powerplayIndicator.style.display = innings.isPowerplay ? 'block' : 'none';
      deadOverIndicator.style.display = innings.isDeadOver ? 'block' : 'none';
      freehitIndicator.style.display = innings.isFreeHit ? 'block' : 'none';
      
      dotCounter.textContent = `Dots: ${innings.dotBalls}/3`;
      zeroCounter.textContent = `Zeros: ${innings.zeroDeliveries}/3`;
    }

    function processDelivery(batterCard, bowlerCard) {
      const innings = gameState.innings[gameState.currentInnings];
      const batter = innings.currentBatter;
      const bowler = innings.currentBowler;
      
      // Reset current ball state
      gameState.currentBall = {
        batterCard,
        bowlerCard,
        runs: 0,
        isWicket: false,
        isNoBall: false,
        isWide: false,
        isBye: false,
        isLegBye: false,
        isFreeHit: innings.isFreeHit
      };
      
      // Handle Test format rules
      if (gameState.matchFormat === 'test') {
        if (batterCard === 0 && bowlerCard === 0) {
          // Dot ball
          gameState.currentBall.runs = 0;
          innings.dotBalls++;
        } else if (batterCard === 0 && bowlerCard > 0) {
          // Bowler's card counts as runs
          gameState.currentBall.runs = bowlerCard;
        } else if (batterCard > 0 && bowlerCard === 0) {
          // Batter's card counts as runs
          gameState.currentBall.runs = batterCard;
        } else if (batterCard > 0 && bowlerCard > 0) {
          if (batterCard === bowlerCard) {
            // Wicket
            const wicketValue = getWicketValue();
            gameState.currentBall.isWicket = true;
            innings.batterStats[batter].wicket -= wicketValue;
            
            if (innings.batterStats[batter].wicket <= 0) {
              innings.batterStats[batter].wicket = 0;
              innings.wickets++;
              showToast(`${batter} is out!`);
              animateWicket();
            } else {
              showToast(`Wicket chance! ${batter} loses ${wicketValue.toFixed(2)} wicket`);
            }
          } else {
            // Batter's card counts as runs
            gameState.currentBall.runs = batterCard;
          }
        }
      } 
      // Handle limited overs formats
      else {
        // Check for no-ball (4th zero by bowler)
        if (bowlerCard === 0) {
          innings.zeroDeliveries++;
          
          if (innings.zeroDeliveries >= 4 && !innings.isDeadOver) {
            gameState.currentBall.isNoBall = true;
            gameState.currentBall.runs = 1; // No ball +1 run
            innings.extras += 1;
            innings.isFreeHit = true;
            showToast('No ball! Free hit next ball');
          } else if (batterCard === 0) {
            // Dot ball
            gameState.currentBall.runs = 0;
            innings.dotBalls++;
          } else {
            // Batter's card counts as runs
            gameState.currentBall.runs = batterCard;
          }
        } 
        // Check for dead over rules (ODI only)
        else if (innings.isDeadOver) {
          if (batterCard === 0) {
            // Dot ball
            gameState.currentBall.runs = 0;
            innings.dotBalls++;
          } else if (batterCard === bowlerCard) {
            // Wicket
            const wicketValue = getWicketValue();
            gameState.currentBall.isWicket = true;
            innings.batterStats[batter].wicket -= wicketValue;
            
            if (innings.batterStats[batter].wicket <= 0) {
              innings.batterStats[batter].wicket = 0;
              innings.wickets++;
              showToast(`${batter} is out!`);
              animateWicket();
            } else {
              showToast(`Wicket chance! ${batter} loses ${wicketValue.toFixed(2)} wicket`);
            }
          } else {
            // Batter's card counts as runs
            gameState.currentBall.runs = batterCard;
          }
        } 
        // Normal delivery
        else {
          if (batterCard === 0) {
            // Check for 4th dot ball penalty
            innings.dotBalls++;
            
            if (innings.dotBalls >= 4) {
              gameState.currentBall.runs = -5; // Penalty of -5 runs
              showToast('4th dot ball! -5 runs penalty');
            } else {
              // Bowler's card counts as runs
              gameState.currentBall.runs = bowlerCard;
            }
          } else if (batterCard === bowlerCard) {
            // Wicket
            const wicketValue = getWicketValue();
            gameState.currentBall.isWicket = true;
            innings.batterStats[batter].wicket -= wicketValue;
            
            if (innings.batterStats[batter].wicket <= 0) {
              innings.batterStats[batter].wicket = 0;
              innings.wickets++;
              showToast(`${batter} is out!`);
              animateWicket();
            } else {
              showToast(`Wicket chance! ${batter} loses ${wicketValue.toFixed(2)} wicket`);
            }
          } else {
            // Batter's card counts as runs
            gameState.currentBall.runs = batterCard;
          }
        }
      }
      
      // Update innings stats
      innings.runs += gameState.currentBall.runs;
      innings.balls++;
      
      if (innings.balls % 6 === 0) {
        innings.overs++;
        innings.balls = 0;
        innings.dotBalls = 0;
        innings.zeroDeliveries = 0;
        
        // Reset free hit after over ends
        innings.isFreeHit = false;
        
        // Check if we need to change bowler
        if (gameState.matchFormat !== 'test') {
          const maxOvers = gameState.maxOversPerBowler[gameState.matchFormat];
          const bowlerStats = innings.bowlerStats[bowler];
          const oversBowled = bowlerStats.balls / 6;
          
          if (oversBowled >= maxOvers) {
            showToast(`${bowler} has bowled maximum overs`);
            // Need to select new bowler
            selectNewBowler();
          }
        }
      }
      
      // Update batter stats
      if (batter) {
        innings.batterStats[batter].runs += Math.max(0, gameState.currentBall.runs);
        innings.batterStats[batter].balls++;
        innings.batterStats[batter].sr = calculateStrikeRate(
          innings.batterStats[batter].runs, 
          innings.batterStats[batter].balls
        );
      }
      
      // Update bowler stats
      if (bowler) {
        innings.bowlerStats[bowler].runs += Math.max(0, gameState.currentBall.runs);
        innings.bowlerStats[bowler].balls++;
        
        if (gameState.currentBall.isWicket) {
          innings.bowlerStats[bowler].wickets++;
        }
      }
      
      // Animate based on result
      if (gameState.currentBall.runs > 0) {
        animateBat();
        animateBall();
        
        if (gameState.currentBall.runs >= 4) {
          animateBoundary();
        }
      } else if (gameState.currentBall.isWicket) {
        animateBowl();
        animateWicket();
      } else {
        animateBowl();
        animateBall();
      }
      
      // Check if innings is complete
      checkInningsComplete();
      
      // Update UI
      updateUI();
    }

    function checkInningsComplete() {
      const innings = gameState.innings[gameState.currentInnings];
      const currentOver = innings.overs + (innings.balls / 6);
      let maxOvers;
      
      switch (gameState.matchFormat) {
        case '5': maxOvers = 5; break;
        case '10': maxOvers = 10; break;
        case '20': maxOvers = 20; break;
        case '50': maxOvers = 50; break;
        case 'test': maxOvers = Infinity; break; // Test has no over limit
        default: maxOvers = 20;
      }
      
      if (innings.wickets >= 10 || currentOver >= maxOvers) {
        // Innings is complete
        showInningsSummary();
        
        if (gameState.currentInnings === 'first') {
          // Prepare for second innings
          gameState.currentInnings = 'second';
          gameState.battingTeam = gameState.toss.battingFirst === 'player1' ? 'player2' : 'player1';
          gameState.bowlingTeam = gameState.toss.battingFirst === 'player1' ? 'player1' : 'player2';
          
          // Reset for second innings
          resetForNewInnings();
        } else {
          // Match is complete
          determineMatchResult();
          showMatchResult();
        }
      }
    }

    function showInningsSummary() {
      const innings = gameState.innings[gameState.currentInnings];
      
      // Update summary stats
      summaryRuns.textContent = innings.runs;
      summaryWickets.textContent = innings.wickets;
      summaryOvers.textContent = formatOvers(innings.balls);
      summaryRR.textContent = calculateEconomyRate(innings.runs, innings.overs + (innings.balls / 6));
      
      // Update batters table
      battersSummary.innerHTML = '';
      for (const batter of innings.batters) {
        const stats = innings.batterStats[batter];
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${batter} ${batter === gameState.teams[gameState.battingTeam].captain ? '(C)' : ''} ${batter === gameState.teams[gameState.battingTeam].viceCaptain ? '(VC)' : ''}</td>
          <td>${stats.runs}</td>
          <td>${stats.balls}</td>
          <td>${calculateStrikeRate(stats.runs, stats.balls)}</td>
        `;
        battersSummary.appendChild(row);
      }
      
      // Update bowlers table
      bowlersSummary.innerHTML = '';
      for (const bowler of innings.bowlers) {
        const stats = innings.bowlerStats[bowler];
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${bowler} ${bowler === gameState.teams[gameState.bowlingTeam].captain ? '(C)' : ''} ${bowler === gameState.teams[gameState.bowlingTeam].viceCaptain ? '(VC)' : ''}</td>
          <td>${formatOvers(stats.balls)}</td>
          <td>${stats.runs}</td>
          <td>${stats.wickets}</td>
          <td>${calculateEconomyRate(stats.runs, stats.balls / 6)}</td>
        `;
        bowlersSummary.appendChild(row);
      }
      
      inningsSummaryModal.style.display = 'flex';
    }

    function determineMatchResult() {
      const firstInnings = gameState.innings.first;
      const secondInnings = gameState.innings.second;
      
      if (secondInnings.runs > firstInnings.runs) {
        // Batting team won
        gameState.winner = gameState.battingTeam;
        gameState.winningMargin = `${secondInnings.wickets < 10 ? 
          `${10 - secondInnings.wickets} wickets` : 
          `${secondInnings.runs - firstInnings.runs} runs`}`;
      } else if (secondInnings.runs < firstInnings.runs) {
        // Bowling team won
        gameState.winner = gameState.bowlingTeam;
        gameState.winningMargin = `${firstInnings.runs - secondInnings.runs} runs`;
      } else {
        // Tie
        gameState.winner = 'tie';
        gameState.winningMargin = 'scores are tied';
      }
      
      // Determine player of the match (simplified - highest scorer)
      let maxRuns = 0;
      let pom = '';
      
      // Check first innings
      for (const batter in firstInnings.batterStats) {
        if (firstInnings.batterStats[batter].runs > maxRuns) {
          maxRuns = firstInnings.batterStats[batter].runs;
          pom = batter;
        }
      }
      
      // Check second innings
      for (const batter in secondInnings.batterStats) {
        if (secondInnings.batterStats[batter].runs > maxRuns) {
          maxRuns = secondInnings.batterStats[batter].runs;
          pom = batter;
        }
      }
      
      gameState.playerOfTheMatch = pom;
    }

    function showMatchResult() {
      const firstInnings = gameState.innings.first;
      const secondInnings = gameState.innings.second;
      
      // Set team names
      const team1Name = gameState.teams.player1.name;
      const team2Name = gameState.teams.player2.name;
      
      // Set scores
      team1ScoreResult.textContent = gameState.toss.battingFirst === 'player1' ? 
        `${firstInnings.runs}/${firstInnings.wickets} (${formatOvers(firstInnings.balls)})` : 
        `${secondInnings.runs}/${secondInnings.wickets} (${formatOvers(secondInnings.balls)})`;
      
      team2ScoreResult.textContent = gameState.toss.battingFirst === 'player1' ? 
        `${secondInnings.runs}/${secondInnings.wickets} (${formatOvers(secondInnings.balls)})` : 
        `${firstInnings.runs}/${firstInnings.wickets} (${formatOvers(firstInnings.balls)})`;
      
      // Set result message
      if (gameState.winner === 'tie') {
        resultMessage.textContent = 'Match is tied!';
      } else {
        const winnerName = gameState.winner === 'player1' ? team1Name : team2Name;
        resultMessage.textContent = `${winnerName} won by ${gameState.winningMargin}`;
      }
      
      // Set player of the match
      pomResult.textContent = gameState.playerOfTheMatch;
      
      matchResultModal.style.display = 'flex';
    }

    function resetForNewInnings() {
      const innings = gameState.innings[gameState.currentInnings];
      
      // Reset innings-specific stats
      innings.runs = 0;
      innings.wickets = 0;
      innings.balls = 0;
      innings.overs = 0;
      innings.extras = 0;
      innings.isPowerplay = true;
      innings.isDeadOver = false;
      innings.isFreeHit = false;
      innings.dotBalls = 0;
      innings.zeroDeliveries = 0;
      
      // Initialize batter stats for the new innings
      innings.batterStats = {};
      innings.batters = [...gameState.teams[gameState.battingTeam].players];
      innings.batters.forEach(player => {
        innings.batterStats[player] = {
          runs: 0,
          balls: 0,
          sr: '0.00',
          wicket: 1.0 // Full wicket at start
        };
      });
      
      // Initialize bowler stats for the new innings
      innings.bowlerStats = {};
      innings.bowlers = [...gameState.teams[gameState.bowlingTeam].players];
      innings.bowlers.forEach(player => {
        innings.bowlerStats[player] = {
          runs: 0,
          balls: 0,
          wickets: 0,
          er: '0.00'
        };
      });
      
      // Select initial batter and bowler
      selectNewBatter();
      selectNewBowler();
      
      // Update UI
      updateUI();
    }

    function selectNewBatter() {
      const innings = gameState.innings[gameState.currentInnings];
      
      // Find next available batter (not out)
      const availableBatters = innings.batters.filter(batter => 
        innings.batterStats[batter].wicket > 0
      );
      
      if (availableBatters.length > 0) {
        innings.currentBatter = availableBatters[0];
        showToast(`${innings.currentBatter} is the new batter`);
      } else {
        // All out
        innings.currentBatter = null;
      }
      
      updateUI();
    }

    function selectNewBowler() {
      const innings = gameState.innings[gameState.currentInnings];
      
      // Find bowlers who haven't bowled their max overs
      const availableBowlers = innings.bowlers.filter(bowler => {
        const stats = innings.bowlerStats[bowler];
        const oversBowled = stats.balls / 6;
        const maxOvers = gameState.maxOversPerBowler[gameState.matchFormat];
        return oversBowled < maxOvers;
      });
      
      if (availableBowlers.length > 0) {
        innings.currentBowler = availableBowlers[Math.floor(Math.random() * availableBowlers.length)];
        showToast(`${innings.currentBowler} is the new bowler`);
      } else {
        // All bowlers have bowled their max overs (shouldn't happen in limited overs)
        innings.currentBowler = null;
      }
      
      updateUI();
    }

    function saveMatchData() {
      // Prepare match data for saving
      const matchData = {
        team1Name: gameState.teams.player1.name,
        team2Name: gameState.teams.player2.name,
        format: gameState.matchFormat,
        winner: gameState.winner,
        winningMargin: gameState.winningMargin,
        playerOfTheMatch: gameState.playerOfTheMatch,
        firstInnings: {
          battingTeam: gameState.toss.battingFirst === 'player1' ? 'player1' : 'player2',
          totalRuns: gameState.innings.first.runs,
          totalWickets: gameState.innings.first.wickets,
          balls: gameState.innings.first.balls,
          batterStats: gameState.innings.first.batterStats,
          bowlerStats: gameState.innings.first.bowlerStats
        },
        secondInnings: {
          battingTeam: gameState.toss.battingFirst === 'player1' ? 'player2' : 'player1',
          totalRuns: gameState.innings.second.runs,
          totalWickets: gameState.innings.second.wickets,
          balls: gameState.innings.second.balls,
          batterStats: gameState.innings.second.batterStats,
          bowlerStats: gameState.innings.second.bowlerStats
        },
        timestamp: Date.now()
      };
      
      // Save to completed matches
      const newMatchRef = push(completedMatchesRef);
      set(newMatchRef, matchData)
        .then(() => {
          showToast('Match data saved successfully');
          // Redirect to match summary
          window.location.href = `match_summary.html?id=${newMatchRef.key}`;
        })
        .catch(error => {
          console.error('Error saving match data:', error);
          showToast('Failed to save match data');
        });
    }

    // Event listeners
    cardButtons.forEach(button => {
      button.addEventListener('click', () => {
        if (gameState.currentBall.batterCard === null) {
          // Selecting batter's card
          gameState.currentBall.batterCard = parseInt(button.dataset.card);
          showToast(`Selected ${gameState.currentBall.batterCard} as batter's card`);
        } else if (gameState.currentBall.bowlerCard === null) {
          // Selecting bowler's card
          gameState.currentBall.bowlerCard = parseInt(button.dataset.card);
          showToast(`Selected ${gameState.currentBall.bowlerCard} as bowler's card`);
        }
      });
    });

    submitBtn.addEventListener('click', () => {
      if (gameState.currentBall.batterCard === null || gameState.currentBall.bowlerCard === null) {
        showToast('Please select both batter and bowler cards');
        return;
      }
      
      processDelivery(gameState.currentBall.batterCard, gameState.currentBall.bowlerCard);
    });

    skipBtn.addEventListener('click', () => {
      // Auto-select random cards for skipped turn
      const batterCard = Math.floor(Math.random() * 7); // 0-6
      const bowlerCard = Math.floor(Math.random() * 7); // 0-6
      
      gameState.currentBall.batterCard = batterCard;
      gameState.currentBall.bowlerCard = bowlerCard;
      
      processDelivery(batterCard, bowlerCard);
    });

    undoBtn.addEventListener('click', () => {
      // Reset current ball selection
      gameState.currentBall.batterCard = null;
      gameState.currentBall.bowlerCard = null;
      showToast('Selection undone');
    });

    confirmTeamBtn.addEventListener('click', () => {
      const selectedBatter = batterSelect.value;
      const selectedBowler = bowlerSelect.value;
      
      if (!selectedBatter || !selectedBowler) {
        showToast('Please select both batter and bowler');
        return;
      }
      
      const innings = gameState.innings[gameState.currentInnings];
      innings.currentBatter = selectedBatter;
      innings.currentBowler = selectedBowler;
      
      teamSelectionModal.style.display = 'none';
      showToast('Team selection confirmed');
      
      // Start the game
      gameState.isGameStarted = true;
      updateUI();
    });

    continueInningsBtn.addEventListener('click', () => {
      inningsSummaryModal.style.display = 'none';
      
      if (gameState.currentInnings === 'second') {
        // Match is complete, show result
        showMatchResult();
      }
    });

    saveMatchBtn.addEventListener('click', () => {
      saveMatchData();
    });

    // Initialize game
    function initializeGame() {
      // Load room data
      get(roomRef).then(snap => {
        if (snap.exists()) {
          const room = snap.val();
          
          // Set match format
          gameState.matchFormat = room.player1?.format || '20';
          formatDisplay.textContent = `Format: ${formatNames[gameState.matchFormat] || gameState.matchFormat}`;
          
          // Set team names
          gameState.teams.player1.name = room.player1?.team || 'Team A';
          gameState.teams.player2.name = room.player2?.team || 'Team B';
          
          // Load toss data
          if (room.toss) {
            gameState.toss = room.toss;
          }
          
          // Load teams data
          if (room.teams) {
            gameState.teams.player1.players = room.teams.player1?.players || [];
            gameState.teams.player1.captain = room.teams.player1?.captain || '';
            gameState.teams.player1.viceCaptain = room.teams.player1?.viceCaptain || '';
            
            gameState.teams.player2.players = room.teams.player2?.players || [];
            gameState.teams.player2.captain = room.teams.player2?.captain || '';
            gameState.teams.player2.viceCaptain = room.teams.player2?.viceCaptain || '';
          }
          
          // Set batting and bowling teams based on toss
          gameState.battingTeam = gameState.toss.battingFirst;
          gameState.bowlingTeam = gameState.toss.battingFirst === 'player1' ? 'player2' : 'player1';
          
          // Initialize first innings
          const firstInnings = gameState.innings.first;
          firstInnings.batters = [...gameState.teams[gameState.battingTeam].players];
          firstInnings.bowlers = [...gameState.teams[gameState.bowlingTeam].players];
          
          // Initialize batter stats
          firstInnings.batters.forEach(player => {
            firstInnings.batterStats[player] = {
              runs: 0,
              balls: 0,
              sr: '0.00',
              wicket: 1.0 // Full wicket at start
            };
          });
          
          // Initialize bowler stats
          firstInnings.bowlers.forEach(player => {
            firstInnings.bowlerStats[player] = {
              runs: 0,
              balls: 0,
              wickets: 0,
              er: '0.00'
            };
          });
          
          // Show team selection modal
          showTeamSelectionModal();
        } else {
          alert('Room not found');
          window.location.href = 'index.html';
        }
      });
    }

    function showTeamSelectionModal() {
      // Populate team player list
      teamPlayerList.innerHTML = '';
      const teamPlayers = gameState.teams[playerRole].players;
      
      teamPlayers.forEach(player => {
        const li = document.createElement('li');
        li.className = 'player-item';
        li.innerHTML = `
          <span class="player-name">${player}</span>
          <span class="player-role">
            ${player === gameState.teams[playerRole].captain ? '<span class="captain-badge">C</span>' : ''}
            ${player === gameState.teams[playerRole].viceCaptain ? '<span class="vice-badge">VC</span>' : ''}
          </span>
        `;
        teamPlayerList.appendChild(li);
      });
      
      // Populate batter select dropdown
      batterSelect.innerHTML = '<option value="">-- Select Batter --</option>';
      gameState.teams[playerRole].players.forEach(player => {
        const option = document.createElement('option');
        option.value = player;
        option.textContent = player;
        batterSelect.appendChild(option);
      });
      
      // Populate bowler select dropdown
      bowlerSelect.innerHTML = '<option value="">-- Select Bowler --</option>';
      gameState.teams[playerRole === 'player1' ? 'player2' : 'player1'].players.forEach(player => {
        const option = document.createElement('option');
        option.value = player;
        option.textContent = player;
        bowlerSelect.appendChild(option);
      });
      
      // Show modal
      teamSelectionModal.style.display = 'flex';
    }

    // Format names
    const formatNames = {
      '5': 'T5 (5 Overs)',
      '10': 'T10 (10 Overs)',
      '20': 'T20 (20 Overs)',
      '50': 'ODI (50 Overs)',
      'test': 'Test'
    };

    // Start the game
    initializeGame();
  </script>
</body>
</html>