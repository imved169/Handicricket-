<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HandiCricket - Auction Room</title>
  <style>
    body {
      background: linear-gradient(135deg, #061e3e, #0a2a4a);
      color: white;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    h1 {
      color: #ffeb3b;
      text-shadow: 0 0 10px rgba(255, 235, 59, 0.5);
      text-align: center;
      margin-bottom: 20px;
    }
    
    .section {
      margin-bottom: 30px;
      padding: 20px;
      background: rgba(13, 42, 82, 0.5);
      border-radius: 10px;
    }
    
    .section-title {
      color: #1e88e5;
      border-bottom: 2px solid #1e88e5;
      padding-bottom: 8px;
      margin-top: 0;
    }
    
    .flex-row {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .flex-col {
      flex: 1;
      min-width: 300px;
    }
    
    .team-info {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
      padding: 10px;
      background: rgba(30, 136, 229, 0.2);
      border-radius: 8px;
    }
    
    .team-name {
      font-weight: bold;
      color: #ffeb3b;
    }
    
    .team-budget {
      color: #4CAF50;
    }
    
    .player-card {
      background: rgba(30, 136, 229, 0.2);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
      position: relative;
    }
    
    .player-name {
      font-size: 1.5rem;
      color: #ffeb3b;
      margin-top: 0;
    }
    
    .player-role {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: bold;
      margin-right: 8px;
    }
    
    .role-batter {
      background-color: #f44336;
    }
    
    .role-pacer {
      background-color: #2196F3;
    }
    
    .role-spinner {
      background-color: #4CAF50;
    }
    
    .role-allrounder {
      background-color: #FF9800;
    }
    
    .role-wk {
      background-color: #9C27B0;
    }
    
    .player-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin: 10px 0;
    }
    
    .player-stat {
      font-size: 0.9rem;
    }
    
    .player-stat span {
      color: #aaa;
    }
    
    .current-bid {
      font-size: 1.8rem;
      text-align: center;
      margin: 15px 0;
      color: #ffeb3b;
    }
    
    .bid-buttons {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-bottom: 10px;
    }
    
    .btn {
      padding: 10px;
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .btn-bid {
      background: linear-gradient(145deg, #4CAF50, #2E7D32);
    }
    
    .btn-pass {
      background: linear-gradient(145deg, #607D8B, #455A64);
    }
    
    .btn-rtm {
      background: linear-gradient(145deg, #FF9800, #F57C00);
    }
    
    .btn-sold {
      background: linear-gradient(145deg, #9C27B0, #7B1FA2);
    }
    
    .btn-admin {
      background: linear-gradient(145deg, #f44336, #d32f2f);
    }
    
    .btn-next {
      background: linear-gradient(145deg, #1e88e5, #1565c0);
    }
    
    .btn-retain {
      background: linear-gradient(145deg, #009688, #00796B);
    }
    
    .btn-captain {
      background: linear-gradient(145deg, #FFD700, #FFC600);
      color: #333;
    }
    
    .timer {
      text-align: center;
      font-size: 1.5rem;
      margin: 10px 0;
      color: #ffeb3b;
    }
    
    .player-pool {
      max-height: 400px;
      overflow-y: auto;
    }
    
    .player-list {
      list-style: none;
      padding: 0;
    }
    
    .player-list-item {
      padding: 10px;
      margin: 5px 0;
      background: rgba(30, 136, 229, 0.1);
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .player-list-item:hover {
      background: rgba(30, 136, 229, 0.3);
    }
    
    .player-list-item.selected {
      background: rgba(255, 235, 59, 0.2);
      border: 1px solid #ffeb3b;
    }
    
    .player-list-item .role {
      font-size: 0.7rem;
      padding: 2px 5px;
      border-radius: 3px;
    }
    
    .retention-player {
      background: rgba(76, 175, 80, 0.2);
    }
    
    .retention-player.selected {
      background: rgba(76, 175, 80, 0.4);
    }
    
    .retention-player.captain {
      background: rgba(255, 215, 0, 0.3);
    }
    
    .retention-info {
      margin-top: 15px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
    }
    
    .retention-info p {
      margin: 5px 0;
    }
    
    .squad-list {
      list-style: none;
      padding: 0;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .squad-list li {
      padding: 8px;
      margin: 3px 0;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 5px;
    }
    
    .input-group {
      margin-bottom: 15px;
    }
    
    .input-group label {
      display: block;
      margin-bottom: 5px;
      color: #aaa;
    }
    
    .input-group input, .input-group select, .input-group textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #1e88e5;
      border-radius: 5px;
      background: rgba(30, 136, 229, 0.1);
      color: white;
    }
    
    .input-group textarea {
      min-height: 100px;
    }
    
    .checkbox-group {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .checkbox-group input {
      margin-right: 8px;
    }
    
    .status-message {
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      text-align: center;
    }
    
    .success {
      background: rgba(76, 175, 80, 0.3);
      color: #a5d6a7;
    }
    
    .error {
      background: rgba(244, 67, 54, 0.3);
      color: #ef9a9a;
    }
    
    .warning {
      background: rgba(255, 152, 0, 0.3);
      color: #ffcc80;
    }
    
    .hidden {
      display: none;
    }
    
    .loading-spinner {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 3px solid #1e88e5;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @media (max-width: 768px) {
      .bid-buttons {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .player-stats {
        grid-template-columns: 1fr;
      }
      
      .flex-row {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üèè IPL 2025 Auction Room</h1>
    
    <div id="userInfo" class="section">
      <h2 class="section-title">Team Information</h2>
      <div class="team-info">
        <span class="team-name" id="teamNameDisplay"></span>
        <span class="team-budget">Budget: ‚Çπ<span id="teamBudget">150.00</span> Cr</span>
      </div>
      <div id="retentionInfo" class="retention-info">
        <p>Players Retained: <span id="retainedCount">0</span>/6 (Cost: ‚Çπ<span id="retentionCost">0.00</span> Cr)</p>
        <p>RTM Cards: <span id="rtmCards">0</span></p>
        <p>Current Captain: <span id="currentCaptain">None</span></p>
      </div>
    </div>
    
    <div id="retentionSection" class="section">
      <h2 class="section-title">Player Retention</h2>
      <p>Retain up to 6 players from your previous squad. Captain retention costs ‚Çπ4 Cr, others ‚Çπ2 Cr.</p>
      <div class="flex-row">
        <div class="flex-col">
          <div class="player-pool">
            <ul class="player-list" id="retentionPlayerList"></ul>
          </div>
        </div>
        <div class="flex-col">
          <div id="retentionControls">
            <button id="retainBtn" class="btn btn-retain">Retain Selected Players</button>
            <button id="chooseCaptainBtn" class="btn btn-captain">Choose as Captain</button>
            <div class="status-message" id="retentionMessage"></div>
          </div>
        </div>
      </div>
    </div>
    
    <div id="auctionRoomSection" class="section hidden">
      <h2 class="section-title">Auction Room</h2>
      <div class="flex-row">
        <div class="flex-col">
          <div class="player-card" id="currentPlayerCard">
            <h3 class="player-name">No player selected</h3>
            <div class="player-stats">
              <div class="player-stat">Base Price: <span>‚Çπ0.00 Cr</span></div>
              <div class="player-stat">Role: <span>-</span></div>
            </div>
            <div class="current-bid" id="currentBidDisplay">Current Bid: ‚Çπ0.00 Cr</div>
            <div class="timer" id="auctionTimer">30s</div>
            <div class="bid-buttons">
              <button class="btn btn-bid" data-increment="0.10">+0.10 Cr</button>
              <button class="btn btn-bid" data-increment="0.25">+0.25 Cr</button>
              <button class="btn btn-bid" data-increment="0.50">+0.50 Cr</button>
              <button class="btn btn-bid" data-increment="1.00">+1.00 Cr</button>
            </div>
            <div class="flex-row">
              <button id="passBtn" class="btn btn-pass">Pass</button>
              <button id="rtmBtn" class="btn btn-rtm">Use RTM</button>
            </div>
          </div>
          
          <div id="adminControls" class="hidden">
            <h3 class="section-title">Admin Controls</h3>
            <div class="flex-row">
              <button id="soldBtn" class="btn btn-sold">Sold</button>
              <button id="nextPlayerBtn" class="btn btn-next">Next Player</button>
            </div>
            <div class="input-group">
              <label for="autoTimerCheckbox">
                <input type="checkbox" id="autoTimerCheckbox" checked> Auto timer (30s)
              </label>
            </div>
          </div>
        </div>
        
        <div class="flex-col">
          <h3 class="section-title">Your Squad</h3>
          <ul class="squad-list" id="squadList"></ul>
          <p>Players: <span id="squadCount">0</span>/25</p>
          <p>Budget Remaining: ‚Çπ<span id="remainingBudget">150.00</span> Cr</p>
        </div>
      </div>
    </div>
    
    <div id="playerPoolSection" class="section hidden">
      <h2 class="section-title">Player Pool Management</h2>
      <div class="flex-row">
        <div class="flex-col">
          <div class="input-group">
            <label for="playerName">Player Name</label>
            <input type="text" id="playerName" placeholder="Enter player name">
          </div>
          <div class="input-group">
            <label for="playerRole">Role</label>
            <select id="playerRole">
              <option value="Batter">Batter</option>
              <option value="Pacer">Pacer</option>
              <option value="Spinner">Spinner</option>
              <option value="All-Rounder">All-Rounder</option>
              <option value="Wicket-Keeper">Wicket-Keeper</option>
            </select>
          </div>
          <div class="input-group">
            <label for="basePrice">Base Price (in Cr)</label>
            <input type="number" id="basePrice" min="0.2" step="0.1" value="0.2">
          </div>
          <button id="addPlayerBtn" class="btn btn-admin">Add Player</button>
        </div>
        
        <div class="flex-col">
          <div class="input-group">
            <label for="bulkPlayers">Bulk Add Players (CSV format: Name,Role,BasePrice)</label>
            <textarea id="bulkPlayers" placeholder="Virat Kohli,Batter,2.0&#10;Jasprit Bumrah,Pacer,1.5&#10;..."></textarea>
          </div>
          <button id="bulkAddBtn" class="btn btn-admin">Bulk Add Players</button>
        </div>
      </div>
      
      <div class="flex-row">
        <div class="flex-col">
          <h3 class="section-title">Player Pool</h3>
          <div class="player-pool">
            <ul class="player-list" id="playerPoolList"></ul>
          </div>
          <div class="flex-row">
            <button id="startWithQueueBtn" class="btn btn-admin">Start Auction with Queue</button>
            <button id="clearQueueBtn" class="btn btn-admin">Clear Queue</button>
          </div>
        </div>
        
        <div class="flex-col">
          <h3 class="section-title">Auction Queue</h3>
          <div class="player-pool">
            <ul class="player-list" id="auctionQueueList"></ul>
          </div>
        </div>
      </div>
    </div>
    
    <div id="roomSection" class="section">
      <h2 class="section-title">Auction Room Setup</h2>
      <div class="input-group">
        <label for="roomCodeInput">Room Code (for participants)</label>
        <input type="text" id="roomCodeInput" placeholder="Enter 4-digit code" maxlength="4">
      </div>
      <button id="createRoomBtn" class="btn btn-admin">Create Auction Room</button>
      <button id="joinRoomBtn" class="btn btn-admin">Join Auction Room</button>
      <div class="status-message" id="roomMessage"></div>
    </div>
    
    <button id="backBtn" class="btn" style="background: #607D8B; margin-top: 20px;">Back to Home</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getDatabase, ref, set, update, get, child, onValue, push } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCN6aZMwlsZe7JJaovU0WA3UQygWr4jYmA",
      authDomain: "handicricket-85a06.firebaseapp.com",
      projectId: "handicricket-85a06",
      storageBucket: "handicricket-85a06.appspot.com",
      messagingSenderId: "599182538558",
      appId: "1:599182538558:web:3e965753ab05f8f1e3de6f",
      measurementId: "G-HSV9H4LEJQ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // DOM elements
    const teamNameDisplay = document.getElementById('teamNameDisplay');
    const teamBudgetDisplay = document.getElementById('teamBudget');
    const retainedCountDisplay = document.getElementById('retainedCount');
    const retentionCostDisplay = document.getElementById('retentionCost');
    const rtmCardsDisplay = document.getElementById('rtmCards');
    const currentCaptainDisplay = document.getElementById('currentCaptain');
    const retentionPlayerList = document.getElementById('retentionPlayerList');
    const retainBtn = document.getElementById('retainBtn');
    const chooseCaptainBtn = document.getElementById('chooseCaptainBtn');
    const retentionMessage = document.getElementById('retentionMessage');
    const auctionRoomSection = document.getElementById('auctionRoomSection');
    const currentPlayerCard = document.getElementById('currentPlayerCard');
    const currentBidDisplay = document.getElementById('currentBidDisplay');
    const auctionTimer = document.getElementById('auctionTimer');
    const passBtn = document.getElementById('passBtn');
    const rtmBtn = document.getElementById('rtmBtn');
    const adminControls = document.getElementById('adminControls');
    const soldBtn = document.getElementById('soldBtn');
    const nextPlayerBtn = document.getElementById('nextPlayerBtn');
    const autoTimerCheckbox = document.getElementById('autoTimerCheckbox');
    const squadList = document.getElementById('squadList');
    const squadCount = document.getElementById('squadCount');
    const remainingBudget = document.getElementById('remainingBudget');
    const playerPoolSection = document.getElementById('playerPoolSection');
    const playerNameInput = document.getElementById('playerName');
    const playerRoleSelect = document.getElementById('playerRole');
    const basePriceInput = document.getElementById('basePrice');
    const addPlayerBtn = document.getElementById('addPlayerBtn');
    const bulkPlayersTextarea = document.getElementById('bulkPlayers');
    const bulkAddBtn = document.getElementById('bulkAddBtn');
    const playerPoolList = document.getElementById('playerPoolList');
    const startWithQueueBtn = document.getElementById('startWithQueueBtn');
    const clearQueueBtn = document.getElementById('clearQueueBtn');
    const auctionQueueList = document.getElementById('auctionQueueList');
    const roomSection = document.getElementById('roomSection');
    const roomCodeInput = document.getElementById('roomCodeInput');
    const createRoomBtn = document.getElementById('createRoomBtn');
    const joinRoomBtn = document.getElementById('joinRoomBtn');
    const roomMessage = document.getElementById('roomMessage');
    const backBtn = document.getElementById('backBtn');
    const retentionSection = document.getElementById('retentionSection');
    const userInfoSection = document.getElementById('userInfo');

    // Game state
    let currentUser = localStorage.getItem('hc_username');
    let currentTeam = localStorage.getItem('hc_team');
    let isAdmin = false;
    let roomCode = '';
    let timerInterval;
    let timeLeft = 30;
    let currentPlayer = null;
    let currentBid = 0;
    let currentBidder = null;
    let auctionState = 'waiting'; // waiting, bidding, sold
    let playerPool = [];
    let auctionQueue = [];
    let retainedPlayers = [];
    let retentionCaptain = null;
    let teamBudget = 150;
    let rtmCards = 0;
    let squad = [];
    let previousSquad = [];

    // Check if user is logged in
    if (!currentUser || !currentTeam) {
      alert('Please login first');
      window.location.href = 'index.html';
    }

    // Set team name
    teamNameDisplay.textContent = currentTeam;

    // Check if user is admin
    isAdmin = currentUser === 'imved169' && currentTeam === 'Ratnagiri Hunters';

    // Load previous squad for retention
    const userRef = ref(db, `users/${currentUser}`);
    onValue(userRef, (snap) => {
      if (snap.exists()) {
        const userData = snap.val();
        previousSquad = userData.players || [];
        updateRetentionPlayerList();
      }
    });

    // Load player pool
    const playersRef = ref(db, 'players');
    onValue(playersRef, (snap) => {
      if (snap.exists()) {
        playerPool = Object.entries(snap.val()).map(([id, player]) => ({
          id,
          ...player
        }));
        updatePlayerPoolList();
      }
    });

    // Load auction room data if joined
    const roomRef = ref(db, `auctions/${roomCode}`);
    onValue(roomRef, (snap) => {
      if (snap.exists()) {
        const roomData = snap.val();
        
        if (roomData.currentPlayer) {
          currentPlayer = roomData.currentPlayer;
          updateCurrentPlayerCard();
        }
        
        if (roomData.currentBid) {
          currentBid = roomData.currentBid.amount;
          currentBidder = roomData.currentBid.team;
          updateCurrentBidDisplay();
        }
        
        if (roomData.auctionQueue) {
          auctionQueue = roomData.auctionQueue;
          updateAuctionQueueList();
        }
        
        if (roomData.timer && roomData.timer > 0) {
          timeLeft = roomData.timer;
          updateTimerDisplay();
        }
        
        if (roomData.auctionState) {
          auctionState = roomData.auctionState;
        }
      }
    });

    // Retention functions
    function updateRetentionPlayerList() {
      retentionPlayerList.innerHTML = '';
      
      previousSquad.forEach(player => {
        const li = document.createElement('li');
        li.className = 'player-list-item retention-player';
        if (retainedPlayers.includes(player)) {
          li.classList.add('selected');
        }
        if (player === retentionCaptain) {
          li.classList.add('captain');
        }
        
        li.innerHTML = `
          <span>${player}</span>
          <input type="checkbox" ${retainedPlayers.includes(player) ? 'checked' : ''}>
        `;
        
        li.addEventListener('click', () => {
          const checkbox = li.querySelector('input');
          checkbox.checked = !checkbox.checked;
          
          if (checkbox.checked && retainedPlayers.length >= 6 && !retainedPlayers.includes(player)) {
            retentionMessage.textContent = 'Maximum 6 players can be retained';
            retentionMessage.className = 'status-message error';
            checkbox.checked = false;
            return;
          }
          
          if (checkbox.checked) {
            if (!retainedPlayers.includes(player)) {
              retainedPlayers.push(player);
            }
          } else {
            retainedPlayers = retainedPlayers.filter(p => p !== player);
            if (player === retentionCaptain) {
              retentionCaptain = null;
              currentCaptainDisplay.textContent = 'None';
            }
          }
          
          li.classList.toggle('selected', checkbox.checked);
          updateRetentionInfo();
        });
        
        retentionPlayerList.appendChild(li);
      });
      
      updateRetentionInfo();
    }

    function updateRetentionInfo() {
      const captainCost = retentionCaptain ? 4 : 0;
      const otherCost = retainedPlayers.filter(p => p !== retentionCaptain).length * 2;
      const totalCost = captainCost + otherCost;
      
      retainedCountDisplay.textContent = retainedPlayers.length;
      retentionCostDisplay.textContent = totalCost.toFixed(2);
      rtmCardsDisplay.textContent = 6 - retainedPlayers.length;
      rtmCards = 6 - retainedPlayers.length;
      
      if (retentionCaptain) {
        currentCaptainDisplay.textContent = retentionCaptain;
      }
    }

    retainBtn.addEventListener('click', async () => {
      if (retainedPlayers.length === 0) {
        retentionMessage.textContent = 'Please select at least one player to retain';
        retentionMessage.className = 'status-message error';
        return;
      }
      
      const captainCost = retentionCaptain ? 4 : 0;
      const otherCost = retainedPlayers.filter(p => p !== retentionCaptain).length * 2;
      const totalCost = captainCost + otherCost;
      
      // Deduct from budget
      teamBudget -= totalCost;
      teamBudgetDisplay.textContent = teamBudget.toFixed(2);
      
      // Save retention data
      try {
        await update(userRef, {
          retainedPlayers: retainedPlayers,
          retentionCaptain: retentionCaptain,
          budget: teamBudget,
          rtmCards: rtmCards
        });
        
        retentionMessage.textContent = 'Players retained successfully!';
        retentionMessage.className = 'status-message success';
        
        // Hide retention section after 2 seconds
        setTimeout(() => {
          retentionSection.classList.add('hidden');
          auctionRoomSection.classList.remove('hidden');
          playerPoolSection.classList.remove('hidden');
        }, 2000);
      } catch (error) {
        console.error('Error saving retention:', error);
        retentionMessage.textContent = 'Failed to save retention. Please try again.';
        retentionMessage.className = 'status-message error';
      }
    });

    chooseCaptainBtn.addEventListener('click', () => {
      const selectedPlayers = Array.from(retentionPlayerList.querySelectorAll('.selected'));
      
      if (selectedPlayers.length !== 1) {
        retentionMessage.textContent = 'Please select exactly one player to be captain';
        retentionMessage.className = 'status-message error';
        return;
      }
      
      const playerName = selectedPlayers[0].querySelector('span').textContent;
      retentionCaptain = playerName;
      
      // Update UI
      Array.from(retentionPlayerList.querySelectorAll('.captain')).forEach(el => {
        el.classList.remove('captain');
      });
      selectedPlayers[0].classList.add('captain');
      
      retentionMessage.textContent = `${playerName} selected as captain (‚Çπ4 Cr)`;
      retentionMessage.className = 'status-message success';
      
      updateRetentionInfo();
    });

    // Player pool management
    function updatePlayerPoolList() {
      playerPoolList.innerHTML = '';
      
      playerPool.forEach(player => {
        const li = document.createElement('li');
        li.className = 'player-list-item';
        if (auctionQueue.some(p => p.id === player.id)) {
          li.classList.add('selected');
        }
        
        li.innerHTML = `
          <span>${player.name}</span>
          <span class="role ${getRoleClass(player.role)}">${player.role}</span>
        `;
        
        li.addEventListener('click', () => {
          if (isAdmin) {
            if (auctionQueue.some(p => p.id === player.id)) {
              auctionQueue = auctionQueue.filter(p => p.id !== player.id);
              li.classList.remove('selected');
            } else {
              auctionQueue.push(player);
              li.classList.add('selected');
            }
            updateAuctionQueueList();
          }
        });
        
        playerPoolList.appendChild(li);
      });
    }

    function updateAuctionQueueList() {
      auctionQueueList.innerHTML = '';
      
      auctionQueue.forEach((player, index) => {
        const li = document.createElement('li');
        li.className = 'player-list-item';
        li.innerHTML = `
          <span>${index + 1}. ${player.name}</span>
          <span class="role ${getRoleClass(player.role)}">${player.role}</span>
        `;
        auctionQueueList.appendChild(li);
      });
      
      // Save queue to database if admin
      if (isAdmin && roomCode) {
        update(ref(db, `auctions/${roomCode}`), {
          auctionQueue: auctionQueue
        });
      }
    }

    function getRoleClass(role) {
      switch(role) {
        case 'Batter': return 'role-batter';
        case 'Pacer': return 'role-pacer';
        case 'Spinner': return 'role-spinner';
        case 'All-Rounder': return 'role-allrounder';
        case 'Wicket-Keeper': return 'role-wk';
        default: return '';
      }
    }

    addPlayerBtn.addEventListener('click', async () => {
      const name = playerNameInput.value.trim();
      const role = playerRoleSelect.value;
      const basePrice = parseFloat(basePriceInput.value);
      
      if (!name) {
        showMessage('Please enter player name', 'error');
        return;
      }
      
      if (isNaN(basePrice) || basePrice < 0.2) {
        showMessage('Base price must be at least ‚Çπ0.2 Cr', 'error');
        return;
      }
      
      try {
        const playerKey = name.toLowerCase().replace(/\s+/g, '_');
        await set(ref(db, `players/${playerKey}`), {
          name: name,
          role: role,
          basePrice: basePrice,
          team: null,
          price: 0
        });
        
        showMessage(`${name} added to player pool`, 'success');
        playerNameInput.value = '';
      } catch (error) {
        console.error('Error adding player:', error);
        showMessage('Failed to add player', 'error');
      }
    });

    bulkAddBtn.addEventListener('click', async () => {
      const bulkText = bulkPlayersTextarea.value.trim();
      if (!bulkText) {
        showMessage('Please enter players in CSV format', 'error');
        return;
      }
      
      const lines = bulkText.split('\n');
      const playersToAdd = [];
      
      for (const line of lines) {
        const parts = line.split(',');
        if (parts.length !== 3) continue;
        
        const name = parts[0].trim();
        const role = parts[1].trim();
        const basePrice = parseFloat(parts[2].trim());
        
        if (name && role && !isNaN(basePrice) && basePrice >= 0.2) {
          playersToAdd.push({
            name,
            role,
            basePrice
          });
        }
      }
      
      if (playersToAdd.length === 0) {
        showMessage('No valid players found in the input', 'error');
        return;
      }
      
      try {
        const updates = {};
        playersToAdd.forEach(player => {
          const playerKey = player.name.toLowerCase().replace(/\s+/g, '_');
          updates[`players/${playerKey}`] = {
            name: player.name,
            role: player.role,
            basePrice: player.basePrice,
            team: null,
            price: 0
          };
        });
        
        await update(ref(db), updates);
        showMessage(`Added ${playersToAdd.length} players to the pool`, 'success');
        bulkPlayersTextarea.value = '';
      } catch (error) {
        console.error('Error bulk adding players:', error);
        showMessage('Failed to add players', 'error');
      }
    });

    startWithQueueBtn.addEventListener('click', async () => {
      if (auctionQueue.length === 0) {
        showMessage('Please add players to the auction queue first', 'error');
        return;
      }
      
      if (!roomCode) {
        showMessage('Please create or join an auction room first', 'error');
        return;
      }
      
      try {
        // Start with first player in queue
        currentPlayer = auctionQueue[0];
        currentBid = currentPlayer.basePrice;
        currentBidder = null;
        auctionState = 'bidding';
        timeLeft = 30;
        
        await update(ref(db, `auctions/${roomCode}`), {
          currentPlayer: currentPlayer,
          currentBid: {
            amount: currentBid,
            team: currentBidder
          },
          auctionState: auctionState,
          timer: timeLeft
        });
        
        updateCurrentPlayerCard();
        updateCurrentBidDisplay();
        startTimer();
        
        showMessage('Auction started with queue', 'success');
      } catch (error) {
        console.error('Error starting auction:', error);
        showMessage('Failed to start auction', 'error');
      }
    });

    clearQueueBtn.addEventListener('click', () => {
      auctionQueue = [];
      updateAuctionQueueList();
      showMessage('Auction queue cleared', 'success');
    });

    // Auction room functions
    function updateCurrentPlayerCard() {
      if (!currentPlayer) {
        currentPlayerCard.querySelector('.player-name').textContent = 'No player selected';
        currentPlayerCard.querySelectorAll('.player-stat span').forEach(span => {
          span.textContent = '-';
        });
        return;
      }
      
      currentPlayerCard.querySelector('.player-name').textContent = currentPlayer.name;
      currentPlayerCard.querySelector('.player-stat:nth-child(1) span').textContent = `‚Çπ${currentPlayer.basePrice.toFixed(2)} Cr`;
      currentPlayerCard.querySelector('.player-stat:nth-child(2) span').textContent = currentPlayer.role;
      
      // Update role class
      const roleSpans = currentPlayerCard.querySelectorAll('.role');
      roleSpans.forEach(span => span.className = 'role ' + getRoleClass(currentPlayer.role));
    }

    function updateCurrentBidDisplay() {
      if (currentBidder) {
        currentBidDisplay.textContent = `Current Bid: ‚Çπ${currentBid.toFixed(2)} Cr by ${currentBidder}`;
      } else {
        currentBidDisplay.textContent = `Base Price: ‚Çπ${currentBid.toFixed(2)} Cr`;
      }
    }

    function updateTimerDisplay() {
      auctionTimer.textContent = `${timeLeft}s`;
    }

    function startTimer() {
      if (timerInterval) clearInterval(timerInterval);
      
      timerInterval = setInterval(() => {
        timeLeft--;
        updateTimerDisplay();
        
        // Update timer in database
        if (isAdmin && roomCode) {
          update(ref(db, `auctions/${roomCode}/timer`), timeLeft);
        }
        
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          if (isAdmin && autoTimerCheckbox.checked) {
            sellPlayer();
          }
        }
      }, 1000);
    }

    function sellPlayer() {
      if (!currentPlayer || !currentBidder) return;
      
      // Add to squad
      squad.push({
        name: currentPlayer.name,
        price: currentBid,
        role: currentPlayer.role
      });
      
      // Deduct from budget
      teamBudget -= currentBid;
      teamBudgetDisplay.textContent = teamBudget.toFixed(2);
      remainingBudget.textContent = teamBudget.toFixed(2);
      
      // Update squad list
      updateSquadList();
      
      // Save to database
      if (roomCode) {
        update(ref(db, `auctions/${roomCode}`), {
          auctionState: 'sold',
          timer: 0
        });
        
        // Update player team
        const playerKey = currentPlayer.id || currentPlayer.name.toLowerCase().replace(/\s+/g, '_');
        update(ref(db, `players/${playerKey}`), {
          team: currentBidder,
          price: currentBid
        });
        
        // Update user squad
        const bidderKey = currentBidder.toLowerCase().replace(/\s+/g, '_');
        update(ref(db, `users/${bidderKey}/auctionPurchases`), [...squad]);
      }
      
      // Reset for next player
      currentPlayer = null;
      currentBid = 0;
      currentBidder = null;
      auctionState = 'waiting';
      
      updateCurrentPlayerCard();
      updateCurrentBidDisplay();
    }

    function updateSquadList() {
      squadList.innerHTML = '';
      
      squad.forEach(player => {
        const li = document.createElement('li');
        li.innerHTML = `
          ${player.name} (${player.role}) - ‚Çπ${player.price.toFixed(2)} Cr
        `;
        squadList.appendChild(li);
      });
      
      squadCount.textContent = squad.length;
    }

    // Bid buttons
    document.querySelectorAll('.btn-bid').forEach(btn => {
      btn.addEventListener('click', () => {
        if (!currentPlayer || auctionState !== 'bidding') return;
        
        const increment = parseFloat(btn.dataset.increment);
        const newBid = currentBid + increment;
        
        if (newBid > teamBudget) {
          showMessage('Bid exceeds your remaining budget', 'error');
          return;
        }
        
        currentBid = newBid;
        currentBidder = currentTeam;
        timeLeft = 30;
        
        updateCurrentBidDisplay();
        
        // Update in database
        if (roomCode) {
          update(ref(db, `auctions/${roomCode}`), {
            currentBid: {
              amount: currentBid,
              team: currentBidder
            },
            timer: timeLeft
          });
        }
      });
    });

    passBtn.addEventListener('click', () => {
      if (!currentPlayer || auctionState !== 'bidding') return;
      
      showMessage('You passed on this player', 'warning');
    });

    rtmBtn.addEventListener('click', () => {
      if (!currentPlayer || auctionState !== 'bidding' || rtmCards <= 0) return;
      
      // Check if player was in previous squad
      if (!previousSquad.includes(currentPlayer.name)) {
        showMessage('This player was not in your previous squad', 'error');
        return;
      }
      
      // Check if already retained
      if (retainedPlayers.includes(currentPlayer.name)) {
        showMessage('This player is already retained', 'error');
        return;
      }
      
      // Use RTM to match current bid
      if (currentBid > teamBudget) {
        showMessage('RTM bid exceeds your remaining budget', 'error');
        return;
      }
      
      rtmCards--;
      rtmCardsDisplay.textContent = rtmCards;
      currentBidder = currentTeam;
      
      showMessage(`Using RTM card to match bid for ${currentPlayer.name}`, 'success');
      
      // Update in database
      if (roomCode) {
        update(ref(db, `auctions/${roomCode}`), {
          currentBid: {
            amount: currentBid,
            team: currentBidder
          },
          timer: timeLeft
        });
        
        // Update user RTM count
        update(userRef, {
          rtmCards: rtmCards
        });
      }
    });

    // Admin controls
    soldBtn.addEventListener('click', () => {
      if (!isAdmin || !currentPlayer || !currentBidder) return;
      
      sellPlayer();
    });

    nextPlayerBtn.addEventListener('click', () => {
      if (!isAdmin || !roomCode) return;
      
      if (auctionQueue.length > 0) {
        // Get next player from queue
        const nextIndex = auctionQueue.findIndex(p => p.id === currentPlayer?.id) + 1;
        if (nextIndex < auctionQueue.length) {
          currentPlayer = auctionQueue[nextIndex];
          currentBid = currentPlayer.basePrice;
          currentBidder = null;
          auctionState = 'bidding';
          timeLeft = 30;
          
          update(ref(db, `auctions/${roomCode}`), {
            currentPlayer: currentPlayer,
            currentBid: {
              amount: currentBid,
              team: currentBidder
            },
            auctionState: auctionState,
            timer: timeLeft
          });
          
          updateCurrentPlayerCard();
          updateCurrentBidDisplay();
          startTimer();
        } else {
          showMessage('No more players in queue', 'warning');
        }
      } else {
        // Get random unsold player
        const unsoldPlayers = playerPool.filter(p => !p.team);
        if (unsoldPlayers.length > 0) {
          currentPlayer = unsoldPlayers[Math.floor(Math.random() * unsoldPlayers.length)];
          currentBid = currentPlayer.basePrice;
          currentBidder = null;
          auctionState = 'bidding';
          timeLeft = 30;
          
          update(ref(db, `auctions/${roomCode}`), {
            currentPlayer: currentPlayer,
            currentBid: {
              amount: currentBid,
              team: currentBidder
            },
            auctionState: auctionState,
            timer: timeLeft
          });
          
          updateCurrentPlayerCard();
          updateCurrentBidDisplay();
          startTimer();
        } else {
          showMessage('No unsold players remaining', 'warning');
        }
      }
    });

    // Room management
    createRoomBtn.addEventListener('click', async () => {
      const code = roomCodeInput.value.trim();
      
      if (code.length !== 4) {
        showMessage('Room code must be 4 characters', 'error', roomMessage);
        return;
      }
      
      // Check if room exists
      const roomSnap = await get(ref(db, `auctions/${code}`));
      if (roomSnap.exists()) {
        showMessage('Room already exists', 'error', roomMessage);
        return;
      }
      
      try {
        await set(ref(db, `auctions/${code}`), {
          createdBy: currentUser,
          createdAt: Date.now(),
          auctionState: 'waiting',
          timer: 0
        });
        
        roomCode = code;
        showMessage(`Room ${code} created successfully!`, 'success', roomMessage);
        
        // Show admin controls
        if (isAdmin) {
          adminControls.classList.remove('hidden');
          playerPoolSection.classList.remove('hidden');
        }
        
        roomSection.classList.add('hidden');
        auctionRoomSection.classList.remove('hidden');
      } catch (error) {
        console.error('Error creating room:', error);
        showMessage('Failed to create room', 'error', roomMessage);
      }
    });

    joinRoomBtn.addEventListener('click', async () => {
      const code = roomCodeInput.value.trim();
      
      if (code.length !== 4) {
        showMessage('Room code must be 4 characters', 'error', roomMessage);
        return;
      }
      
      // Check if room exists
      const roomSnap = await get(ref(db, `auctions/${code}`));
      if (!roomSnap.exists()) {
        showMessage('Room not found', 'error', roomMessage);
        return;
      }
      
      roomCode = code;
      showMessage(`Joined room ${code}`, 'success', roomMessage);
      
      roomSection.classList.add('hidden');
      auctionRoomSection.classList.remove('hidden');
      
      // Hide admin controls if not admin
      if (!isAdmin) {
        adminControls.classList.add('hidden');
        playerPoolSection.classList.add('hidden');
      }
    });

    // Helper functions
    function showMessage(message, type, element = null) {
      const target = element || document.getElementById('statusMessage');
      if (!target) return;
      
      target.textContent = message;
      target.className = `status-message ${type}`;
      
      if (type !== 'error') {
        setTimeout(() => {
          target.textContent = '';
          target.className = 'status-message';
        }, 3000);
      }
    }

    backBtn.addEventListener('click', () => {
      window.location.href = 'index.html';
    });

    // Initialize UI based on user state
    if (isAdmin) {
      adminControls.classList.remove('hidden');
      playerPoolSection.classList.remove('hidden');
    }
  </script>
</body>
</html>