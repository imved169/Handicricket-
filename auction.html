<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HandiCricket - IPL 2025 Auction</title>
  <style>
    body {
      background: linear-gradient(135deg, #061e3e, #0a2a4a);
      color: white;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    h1 {
      color: #ffeb3b;
      text-shadow: 0 0 10px rgba(255, 235, 59, 0.5);
      margin-top: 0;
      text-align: center;
    }
    
    h2 {
      color: #1e88e5;
      border-bottom: 2px solid #1e88e5;
      padding-bottom: 8px;
    }
    
    .section {
      display: none;
      margin-bottom: 20px;
    }
    
    .section.active {
      display: block;
    }
    
    .btn {
      padding: 10px 15px;
      border: none;
      border-radius: 8px;
      background: linear-gradient(145deg, #1e88e5, #1565c0);
      color: white;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s;
      margin: 5px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    }
    
    .btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 10px rgba(0, 0, 0, 0.3);
    }
    
    .btn:active {
      transform: translateY(1px);
    }
    
    .btn-primary {
      background: linear-gradient(145deg, #1e88e5, #1565c0);
    }
    
    .btn-success {
      background: linear-gradient(145deg, #4CAF50, #2E7D32);
    }
    
    .btn-warning {
      background: linear-gradient(145deg, #FF9800, #F57C00);
    }
    
    .btn-danger {
      background: linear-gradient(145deg, #f44336, #d32f2f);
    }
    
    .btn-purple {
      background: linear-gradient(145deg, #9C27B0, #7B1FA2);
    }
    
    .btn-gold {
      background: linear-gradient(145deg, #FFD700, #FFC000);
      color: #333;
    }
    
    .btn-back {
      background: linear-gradient(145deg, #607D8B, #455A64);
    }
    
    .info-card {
      background: rgba(13, 42, 82, 0.5);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
    }
    
    .team-info {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .team-card {
      flex: 1;
      min-width: 200px;
      background: rgba(30, 136, 229, 0.2);
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .team-card h3 {
      margin-top: 0;
      color: #ffeb3b;
    }
    
    .player-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
    }
    
    .player-tag {
      padding: 5px 10px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 5px;
      font-size: 14px;
    }
    
    .player-tag.captain {
      background: rgba(255, 215, 0, 0.3);
      border: 1px solid gold;
    }
    
    .player-tag.retained {
      background: rgba(76, 175, 80, 0.3);
      border: 1px solid #4CAF50;
    }
    
    .input-group {
      margin-bottom: 15px;
    }
    
    label {
      display: block;
      margin-bottom: 5px;
      color: #aaa;
    }
    
    input, select {
      width: 100%;
      padding: 10px;
      border: 1px solid #1e88e5;
      border-radius: 8px;
      background: rgba(30, 136, 229, 0.1);
      color: white;
      font-size: 16px;
      box-sizing: border-box;
    }
    
    select option {
      background: #061e3e;
    }
    
    .retention-container {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .retention-player {
      flex: 1;
      min-width: 200px;
      background: rgba(13, 42, 82, 0.5);
      border-radius: 10px;
      padding: 15px;
      cursor: pointer;
      transition: all 0.3s;
      border: 2px solid transparent;
    }
    
    .retention-player:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 10px rgba(0, 0, 0, 0.3);
    }
    
    .retention-player.selected {
      border-color: #ffeb3b;
      background: rgba(30, 136, 229, 0.3);
    }
    
    .retention-player.captain {
      border-color: gold;
      background: rgba(255, 215, 0, 0.2);
    }
    
    .auction-player-card {
      background: rgba(13, 42, 82, 0.5);
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      text-align: center;
      border: 2px solid #1e88e5;
    }
    
    .auction-player-card h2 {
      color: #ffeb3b;
      margin-top: 0;
      border: none;
    }
    
    .player-role {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 14px;
      margin: 5px;
    }
    
    .role-batter {
      background: rgba(255, 152, 0, 0.2);
      border: 1px solid #FF9800;
    }
    
    .role-pacer {
      background: rgba(244, 67, 54, 0.2);
      border: 1px solid #f44336;
    }
    
    .role-spinner {
      background: rgba(76, 175, 80, 0.2);
      border: 1px solid #4CAF50;
    }
    
    .role-allrounder {
      background: rgba(156, 39, 176, 0.2);
      border: 1px solid #9C27B0;
    }
    
    .role-wk {
      background: rgba(0, 150, 136, 0.2);
      border: 1px solid #009688;
    }
    
    .bid-actions {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }
    
    .bid-btn {
      min-width: 80px;
    }
    
    .timer {
      font-size: 24px;
      font-weight: bold;
      color: #ffeb3b;
      margin: 15px 0;
    }
    
    .bid-history {
      max-height: 200px;
      overflow-y: auto;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      padding: 10px;
      margin-top: 15px;
    }
    
    .bid-entry {
      padding: 5px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .player-pool {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
    }
    
    .player-pool-item {
      padding: 8px 12px;
      background: rgba(30, 136, 229, 0.2);
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .player-pool-item:hover {
      background: rgba(30, 136, 229, 0.4);
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .modal-content {
      background: #0a2a4a;
      border-radius: 10px;
      padding: 20px;
      max-width: 90%;
      max-height: 90%;
      overflow-y: auto;
      width: 500px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
    }
    
    .close-modal {
      float: right;
      cursor: pointer;
      font-size: 24px;
    }
    
    .admin-controls {
      background: rgba(244, 67, 54, 0.2);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
    }
    
    .bulk-input {
      width: 100%;
      height: 150px;
      padding: 10px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-family: monospace;
    }
    
    .rtm-badge {
      display: inline-block;
      padding: 2px 6px;
      background: #9C27B0;
      border-radius: 4px;
      font-size: 12px;
      margin-left: 5px;
    }
    
    .notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 15px;
      border-radius: 8px;
      z-index: 1000;
      display: none;
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }
      
      .team-card, .retention-player {
        min-width: 100%;
      }
      
      .bid-actions {
        flex-direction: column;
      }
      
      .bid-btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üèè IPL 2025 Auction</h1>
    
    <div id="userInfo" class="info-card" style="display: none;">
      <p>Team: <strong id="teamNameDisplay"></strong></p>
      <p>Budget: <strong id="budgetDisplay">‚Çπ150 Cr</strong></p>
      <p>RTM Cards: <strong id="rtmDisplay">0</strong></p>
      <p>Players: <strong id="squadCount">0/25</strong></p>
    </div>
    
    <!-- Retention Section -->
    <div id="retentionSection" class="section active">
      <h2>Player Retention</h2>
      <div class="info-card">
        <p>Retain up to 6 players from your previous squad. Captain retention costs ‚Çπ4 Cr, other players cost ‚Çπ2 Cr each.</p>
        <p>You'll earn RTM (Right-to-Match) cards equal to 6 minus the number of players retained.</p>
        <p id="retentionCost">Total retention cost: ‚Çπ0 Cr</p>
        <button id="confirmRetentionBtn" class="btn btn-success">Confirm Retention</button>
      </div>
      
      <div id="retentionPlayersContainer" class="retention-container">
        <!-- Players will be loaded here -->
      </div>
    </div>
    
    <!-- Auction Setup Section -->
    <div id="setupSection" class="section">
      <h2>Auction Setup</h2>
      
      <div id="adminSetup" class="admin-controls" style="display: none;">
        <h3>Admin Controls</h3>
        <div class="input-group">
          <label for="roomCodeInput">Room Code</label>
          <input type="text" id="roomCodeInput" placeholder="Enter 4-digit code" maxlength="4">
          <button id="createRoomBtn" class="btn btn-primary">Create Room</button>
        </div>
        
        <div id="playerManagement" style="display: none;">
          <h3>Add Players to Auction Pool</h3>
          <div class="input-group">
            <label for="playerName">Player Name</label>
            <input type="text" id="playerName" placeholder="Player name">
          </div>
          <div class="input-group">
            <label for="playerRole">Role</label>
            <select id="playerRole">
              <option value="Batter">Batter</option>
              <option value="Pacer">Pacer</option>
              <option value="Spinner">Spinner</option>
              <option value="All-Rounder">All-Rounder</option>
              <option value="Wicket-Keeper">Wicket-Keeper</option>
            </select>
          </div>
          <div class="input-group">
            <label for="basePrice">Base Price (in Cr)</label>
            <input type="number" id="basePrice" min="0.2" step="0.1" value="0.2">
          </div>
          <button id="addPlayerBtn" class="btn btn-success">Add Player</button>
          
          <h3>Or Bulk Add Players</h3>
          <textarea class="bulk-input" id="bulkPlayers" placeholder="Format: Player Name, Role, Base Price (Cr)&#10;Example:&#10;Virat Kohli, Batter, 2&#10;Jasprit Bumrah, Pacer, 1.5"></textarea>
          <button id="bulkAddBtn" class="btn btn-warning">Bulk Add Players</button>
        </div>
      </div>
      
      <div id="joinRoomSection">
        <div class="input-group">
          <label for="joinRoomCode">Room Code</label>
          <input type="text" id="joinRoomCode" placeholder="Enter 4-digit code" maxlength="4">
          <button id="joinRoomBtn" class="btn btn-primary">Join Room</button>
        </div>
      </div>
      
      <div id="roomInfo" class="info-card" style="display: none;">
        <h3>Room: <span id="roomCodeDisplay"></span></h3>
        <p>Status: <span id="roomStatus">Waiting to start...</span></p>
        <div id="adminStartControls" style="display: none;">
          <button id="startAuctionBtn" class="btn btn-success">Start Auction</button>
          <button id="selectPlayerBtn" class="btn btn-warning">Select Next Player</button>
        </div>
      </div>
    </div>
    
    <!-- Auction Section -->
    <div id="auctionSection" class="section">
      <h2>Live Auction</h2>
      
      <div id="currentPlayerCard" class="auction-player-card" style="display: none;">
        <h2 id="auctionPlayerName">Player Name</h2>
        <div>
          <span id="auctionPlayerRole" class="player-role">Role</span>
          <span id="auctionPlayerPrice" class="player-role role-wk">Base Price: ‚Çπ0.2 Cr</span>
        </div>
        
        <div class="timer" id="auctionTimer">30s</div>
        
        <div class="bid-actions">
          <button class="btn btn-primary bid-btn" data-increment="0.10">+0.10 Cr</button>
          <button class="btn btn-primary bid-btn" data-increment="0.25">+0.25 Cr</button>
          <button class="btn btn-primary bid-btn" data-increment="0.50">+0.50 Cr</button>
          <button class="btn btn-primary bid-btn" data-increment="1.00">+1.00 Cr</button>
          <button id="passBtn" class="btn btn-danger">Pass</button>
          <button id="rtmBtn" class="btn btn-purple">Use RTM</button>
        </div>
        
        <div class="bid-history" id="bidHistory">
          <!-- Bid history will appear here -->
        </div>
        
        <div id="adminAuctionControls" style="display: none; margin-top: 20px;">
          <button id="sellPlayerBtn" class="btn btn-success">Sold!</button>
          <button id="nextPlayerBtn" class="btn btn-warning">Next Player</button>
        </div>
      </div>
      
      <div id="waitingMessage" class="info-card">
        <p>Waiting for auction to start...</p>
      </div>
      
      <div id="playerPoolSection" style="display: none;">
        <h3>Auction Pool</h3>
        <div class="player-pool" id="playerPool">
          <!-- Players available for auction will appear here -->
        </div>
      </div>
    </div>
    
    <!-- Teams Section -->
    <div id="teamsSection" class="section">
      <h2>Team Squads</h2>
      <div class="team-info" id="teamsContainer">
        <!-- Team cards will be loaded here -->
      </div>
    </div>
    
    <button id="backBtn" class="btn btn-back" style="margin-top: 20px;">Back to Home</button>
  </div>
  
  <!-- Player Selection Modal -->
  <div id="playerSelectModal" class="modal">
    <div class="modal-content">
      <span class="close-modal">&times;</span>
      <h2>Select Player for Auction</h2>
      <div id="modalPlayerPool" class="player-pool">
        <!-- Players will be loaded here -->
      </div>
    </div>
  </div>
  
  <!-- Notification -->
  <div id="notification" class="notification"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getDatabase, ref, set, update, get, child, onValue, push } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCN6aZMwlsZe7JJaovU0WA3UQygWr4jYmA",
      authDomain: "handicricket-85a06.firebaseapp.com",
      projectId: "handicricket-85a06",
      storageBucket: "handicricket-85a06.appspot.com",
      messagingSenderId: "599182538558",
      appId: "1:599182538558:web:3e965753ab05f8f1e3de6f",
      measurementId: "G-HSV9H4LEJQ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    
    // DOM elements
    const teamNameDisplay = document.getElementById('teamNameDisplay');
    const budgetDisplay = document.getElementById('budgetDisplay');
    const rtmDisplay = document.getElementById('rtmDisplay');
    const squadCount = document.getElementById('squadCount');
    const userInfo = document.getElementById('userInfo');
    
    // Section elements
    const retentionSection = document.getElementById('retentionSection');
    const setupSection = document.getElementById('setupSection');
    const auctionSection = document.getElementById('auctionSection');
    const teamsSection = document.getElementById('teamsSection');
    
    // Retention elements
    const retentionPlayersContainer = document.getElementById('retentionPlayersContainer');
    const confirmRetentionBtn = document.getElementById('confirmRetentionBtn');
    const retentionCost = document.getElementById('retentionCost');
    
    // Setup elements
    const adminSetup = document.getElementById('adminSetup');
    const roomCodeInput = document.getElementById('roomCodeInput');
    const createRoomBtn = document.getElementById('createRoomBtn');
    const joinRoomCode = document.getElementById('joinRoomCode');
    const joinRoomBtn = document.getElementById('joinRoomBtn');
    const roomInfo = document.getElementById('roomInfo');
    const roomCodeDisplay = document.getElementById('roomCodeDisplay');
    const roomStatus = document.getElementById('roomStatus');
    const adminStartControls = document.getElementById('adminStartControls');
    const startAuctionBtn = document.getElementById('startAuctionBtn');
    const selectPlayerBtn = document.getElementById('selectPlayerBtn');
    const playerManagement = document.getElementById('playerManagement');
    const playerName = document.getElementById('playerName');
    const playerRole = document.getElementById('playerRole');
    const basePrice = document.getElementById('basePrice');
    const addPlayerBtn = document.getElementById('addPlayerBtn');
    const bulkPlayers = document.getElementById('bulkPlayers');
    const bulkAddBtn = document.getElementById('bulkAddBtn');
    
    // Auction elements
    const currentPlayerCard = document.getElementById('currentPlayerCard');
    const waitingMessage = document.getElementById('waitingMessage');
    const auctionPlayerName = document.getElementById('auctionPlayerName');
    const auctionPlayerRole = document.getElementById('auctionPlayerRole');
    const auctionPlayerPrice = document.getElementById('auctionPlayerPrice');
    const auctionTimer = document.getElementById('auctionTimer');
    const bidHistory = document.getElementById('bidHistory');
    const passBtn = document.getElementById('passBtn');
    const rtmBtn = document.getElementById('rtmBtn');
    const adminAuctionControls = document.getElementById('adminAuctionControls');
    const sellPlayerBtn = document.getElementById('sellPlayerBtn');
    const nextPlayerBtn = document.getElementById('nextPlayerBtn');
    const playerPoolSection = document.getElementById('playerPoolSection');
    const playerPool = document.getElementById('playerPool');
    
    // Team elements
    const teamsContainer = document.getElementById('teamsContainer');
    
    // Modal elements
    const playerSelectModal = document.getElementById('playerSelectModal');
    const closeModal = document.querySelector('.close-modal');
    const modalPlayerPool = document.getElementById('modalPlayerPool');
    
    // Notification
    const notification = document.getElementById('notification');
    
    // Back button
    const backBtn = document.getElementById('backBtn');
    
    // Current user data
    let currentUser = localStorage.getItem('hc_username');
    let currentTeam = localStorage.getItem('hc_team');
    let isAdmin = false;
    let roomCode = '';
    let auctionData = {};
    let retentionData = {
      retainedPlayers: [],
      captain: null,
      cost: 0,
      rtmCards: 0
    };
    
    // Check if user is logged in
    if (!currentUser || !currentTeam) {
      window.location.href = 'index.html';
    } else {
      userInfo.style.display = 'block';
      teamNameDisplay.textContent = currentTeam;
      
      // Check if admin (imved169, Ratnagiri Hunters)
      isAdmin = currentUser === 'imved169' || currentTeam === 'Ratnagiri Hunters';
      if (isAdmin) {
        adminSetup.style.display = 'block';
      }
    }
    
    // Load previous squad for retention
    const userRef = ref(db, `users/${currentUser}`);
    onValue(userRef, (snap) => {
      if (snap.exists()) {
        const userData = snap.val();
        const players = userData.players || [];
        
        // Clear previous players
        retentionPlayersContainer.innerHTML = '';
        
        // Add players to retention section
        players.forEach(player => {
          const playerCard = document.createElement('div');
          playerCard.className = 'retention-player';
          playerCard.dataset.player = player;
          playerCard.innerHTML = `
            <h3>${player}</h3>
            <button class="btn btn-gold choose-captain" style="margin-top: 10px;">Choose as Captain</button>
          `;
          
          playerCard.addEventListener('click', () => {
            if (!playerCard.classList.contains('captain')) {
              playerCard.classList.toggle('selected');
              updateRetentionCost();
            }
          });
          
          // Add captain selection
          const captainBtn = playerCard.querySelector('.choose-captain');
          captainBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            
            // Remove captain from any other player
            document.querySelectorAll('.retention-player').forEach(p => {
              p.classList.remove('captain');
            });
            
            // Set this player as captain
            playerCard.classList.add('captain');
            playerCard.classList.add('selected');
            updateRetentionCost();
          });
          
          retentionPlayersContainer.appendChild(playerCard);
        });
      }
    });
    
    // Update retention cost display
    function updateRetentionCost() {
      const selectedPlayers = document.querySelectorAll('.retention-player.selected');
      const captain = document.querySelector('.retention-player.captain');
      
      retentionData.retainedPlayers = Array.from(selectedPlayers).map(p => p.dataset.player);
      retentionData.captain = captain ? captain.dataset.player : null;
      
      // Calculate cost (captain: 4Cr, others: 2Cr)
      retentionData.cost = retentionData.captain ? 4 : 0;
      retentionData.cost += (retentionData.retainedPlayers.length - (retentionData.captain ? 1 : 0)) * 2;
      
      // Calculate RTM cards (max 6 players, RTM = 6 - retained)
      retentionData.rtmCards = Math.max(0, 6 - retentionData.retainedPlayers.length);
      
      retentionCost.textContent = `Total retention cost: ‚Çπ${retentionData.cost} Cr`;
      rtmDisplay.textContent = retentionData.rtmCards;
    }
    
    // Confirm retention
    confirmRetentionBtn.addEventListener('click', async () => {
      if (retentionData.retainedPlayers.length > 6) {
        showNotification('You can retain maximum 6 players', 'error');
        return;
      }
      
      try {
        // Update user data with retention info
        await update(userRef, {
          retainedPlayers: retentionData.retainedPlayers,
          retentionCaptain: retentionData.captain,
          rtmCards: retentionData.rtmCards,
          budget: 150 - retentionData.cost // Starting budget is 150 Cr
        });
        
        // Update UI
        budgetDisplay.textContent = `‚Çπ${150 - retentionData.cost} Cr`;
        
        // Move to setup section
        retentionSection.classList.remove('active');
        setupSection.classList.add('active');
        
        showNotification('Retention confirmed!', 'success');
      } catch (error) {
        console.error('Error confirming retention:', error);
        showNotification('Failed to confirm retention', 'error');
      }
    });
    
    // Create room
    createRoomBtn.addEventListener('click', () => {
      const code = roomCodeInput.value.trim();
      
      if (!code || code.length !== 4 || isNaN(code)) {
        showNotification('Please enter a valid 4-digit code', 'error');
        return;
      }
      
      roomCode = code;
      
      // Create room in Firebase
      set(ref(db, `auctions/${roomCode}`), {
        status: 'setup',
        admin: currentUser,
        teams: {
          [currentTeam]: {
            budget: 150 - retentionData.cost,
            rtmCards: retentionData.rtmCards,
            squad: []
          }
        },
        auctionPool: {},
        currentPlayer: null,
        bids: {}
      }).then(() => {
        roomCodeDisplay.textContent = roomCode;
        roomStatus.textContent = 'Setup in progress';
        roomInfo.style.display = 'block';
        playerManagement.style.display = 'block';
        joinRoomSection.style.display = 'none';
        
        if (isAdmin) {
          adminStartControls.style.display = 'block';
        }
        
        showNotification('Room created successfully!', 'success');
      }).catch(error => {
        console.error('Error creating room:', error);
        showNotification('Failed to create room', 'error');
      });
    });
    
    // Join room
    joinRoomBtn.addEventListener('click', () => {
      const code = joinRoomCode.value.trim();
      
      if (!code || code.length !== 4 || isNaN(code)) {
        showNotification('Please enter a valid 4-digit code', 'error');
        return;
      }
      
      roomCode = code;
      const roomRef = ref(db, `auctions/${roomCode}`);
      
      get(roomRef).then((snap) => {
        if (!snap.exists()) {
          showNotification('Room not found', 'error');
          return;
        }
        
        const roomData = snap.val();
        
        // Check if team already joined
        if (roomData.teams && roomData.teams[currentTeam]) {
          showNotification('Your team has already joined this room', 'info');
        } else {
          // Add team to room
          update(ref(db, `auctions/${roomCode}/teams`), {
            [currentTeam]: {
              budget: 150 - retentionData.cost,
              rtmCards: retentionData.rtmCards,
              squad: []
            }
          }).then(() => {
            showNotification('Joined room successfully!', 'success');
          });
        }
        
        // Update UI
        roomCodeDisplay.textContent = roomCode;
        roomStatus.textContent = roomData.status === 'live' ? 'Auction in progress' : 'Waiting to start';
        roomInfo.style.display = 'block';
        joinRoomSection.style.display = 'none';
        
        if (isAdmin && roomData.admin === currentUser) {
          adminStartControls.style.display = 'block';
          playerManagement.style.display = 'block';
        }
        
        // Move to setup section
        retentionSection.classList.remove('active');
        setupSection.classList.add('active');
      }).catch(error => {
        console.error('Error joining room:', error);
        showNotification('Failed to join room', 'error');
      });
    });
    
    // Add player to auction pool
    addPlayerBtn.addEventListener('click', () => {
      const name = playerName.value.trim();
      const role = playerRole.value;
      const price = parseFloat(basePrice.value);
      
      if (!name || !role || isNaN(price)) {
        showNotification('Please fill all fields correctly', 'error');
        return;
      }
      
      const playerKey = name.toLowerCase().replace(/\s+/g, '_');
      
      set(ref(db, `auctions/${roomCode}/auctionPool/${playerKey}`), {
        name: name,
        role: role,
        basePrice: price,
        status: 'available'
      }).then(() => {
        playerName.value = '';
        basePrice.value = '0.2';
        showNotification('Player added to auction pool', 'success');
      }).catch(error => {
        console.error('Error adding player:', error);
        showNotification('Failed to add player', 'error');
      });
    });
    
    // Bulk add players
    bulkAddBtn.addEventListener('click', () => {
      const playersText = bulkPlayers.value.trim();
      if (!playersText) {
        showNotification('Please enter player data', 'error');
        return;
      }
      
      const lines = playersText.split('\n');
      const playersToAdd = {};
      
      lines.forEach(line => {
        const parts = line.split(',').map(p => p.trim());
        if (parts.length === 3) {
          const name = parts[0];
          const role = parts[1];
          const price = parseFloat(parts[2]);
          
          if (name && role && !isNaN(price)) {
            const playerKey = name.toLowerCase().replace(/\s+/g, '_');
            playersToAdd[`auctionPool/${playerKey}`] = {
              name: name,
              role: role,
              basePrice: price,
              status: 'available'
            };
          }
        }
      });
      
      if (Object.keys(playersToAdd).length === 0) {
        showNotification('No valid player data found', 'error');
        return;
      }
      
      update(ref(db, `auctions/${roomCode}`), playersToAdd)
        .then(() => {
          bulkPlayers.value = '';
          showNotification(`Added ${Object.keys(playersToAdd).length} players to pool`, 'success');
        })
        .catch(error => {
          console.error('Error bulk adding players:', error);
          showNotification('Failed to add players', 'error');
        });
    });

    // Start auction
startAuctionBtn.addEventListener('click', () => {
  update(ref(db, `auctions/${roomCode}`), {
    status: 'live'
  }).then(() => {
    roomStatus.textContent = 'Auction in progress';
    showNotification('Auction started!', 'success');
    
    // Automatically show auction section for admin
    setupSection.classList.remove('active');
    auctionSection.classList.add('active');
    
    // Show player pool by default
    waitingMessage.style.display = 'block';
    currentPlayerCard.style.display = 'none';
    playerPoolSection.style.display = 'block';
  }).catch(error => {
    console.error('Error starting auction:', error);
    showNotification('Failed to start auction', 'error');
  });
});
    
    // Select next player (admin)
    selectPlayerBtn.addEventListener('click', () => {
      // Show modal with available players
      const roomRef = ref(db, `auctions/${roomCode}/auctionPool`);
      get(roomRef).then((snap) => {
        if (!snap.exists()) {
          showNotification('No players in auction pool', 'error');
          return;
        }
        
        const players = snap.val();
        modalPlayerPool.innerHTML = '';
        
        Object.entries(players).forEach(([key, player]) => {
          if (player.status === 'available') {
            const playerItem = document.createElement('div');
            playerItem.className = 'player-pool-item';
            playerItem.innerHTML = `
              ${player.name} (${player.role}) - ‚Çπ${player.basePrice} Cr
            `;
            playerItem.addEventListener('click', () => {
              selectPlayerForAuction(key, player);
              playerSelectModal.style.display = 'none';
            });
            modalPlayerPool.appendChild(playerItem);
          }
        });
        
        playerSelectModal.style.display = 'flex';
      });
    });
    
    // Select player for auction
    function selectPlayerForAuction(playerKey, player) {
      update(ref(db, `auctions/${roomCode}`), {
        currentPlayer: {
          key: playerKey,
          name: player.name,
          role: player.role,
          basePrice: player.basePrice,
          currentBid: player.basePrice,
          currentBidder: null,
          status: 'bidding'
        },
        bids: {} // Clear previous bids
      }).then(() => {
        showNotification(`${player.name} is now up for auction!`, 'success');
      }).catch(error => {
        console.error('Error selecting player:', error);
        showNotification('Failed to select player', 'error');
      });
    }
    
    // Listen for auction updates
function setupAuctionListener() {
  const auctionRef = ref(db, `auctions/${roomCode}`);
  onValue(auctionRef, (snap) => {
    if (!snap.exists()) return;
    
    auctionData = snap.val();
    
    // If admin and auction just started, show auction section
    if (isAdmin && auctionData.status === 'live' && setupSection.classList.contains('active')) {
      setupSection.classList.remove('active');
      auctionSection.classList.add('active');
    }
        
        // Update room status
        if (setupSection.classList.contains('active')) {
          roomStatus.textContent = auctionData.status === 'live' ? 'Auction in progress' : 'Setup in progress';
        }
        
        // Show/hide sections based on status
        if (auctionData.status === 'live') {
          setupSection.classList.remove('active');
          auctionSection.classList.add('active');
          
          // Show current player if available
          if (auctionData.currentPlayer) {
            waitingMessage.style.display = 'none';
            currentPlayerCard.style.display = 'block';
            playerPoolSection.style.display = 'none';
            
            auctionPlayerName.textContent = auctionData.currentPlayer.name;
            auctionPlayerRole.textContent = auctionData.currentPlayer.role;
            auctionPlayerRole.className = `player-role role-${auctionData.currentPlayer.role.toLowerCase().replace('-', '')}`;
            auctionPlayerPrice.textContent = `Current Bid: ‚Çπ${auctionData.currentPlayer.currentBid} Cr`;
            
            // Update bid history
            bidHistory.innerHTML = '';
            if (auctionData.bids) {
              Object.values(auctionData.bids).forEach(bid => {
                const bidEntry = document.createElement('div');
                bidEntry.className = 'bid-entry';
                bidEntry.textContent = `${bid.team} bid ‚Çπ${bid.amount} Cr`;
                bidHistory.appendChild(bidEntry);
              });
            }
            
            // Start timer if it's a new bid
            if (auctionData.currentPlayer.status === 'bidding') {
              startTimer(30);
            }
          } else {
            waitingMessage.style.display = 'block';
            currentPlayerCard.style.display = 'none';
            playerPoolSection.style.display = 'block';
          }
          
          // Show admin controls
          if (isAdmin && auctionData.admin === currentUser) {
            adminAuctionControls.style.display = 'block';
          } else {
            adminAuctionControls.style.display = 'none';
          }
        }
        
        // Update player pool
        if (auctionData.auctionPool) {
          playerPool.innerHTML = '';
          Object.entries(auctionData.auctionPool).forEach(([key, player]) => {
            if (player.status === 'available') {
              const playerItem = document.createElement('div');
              playerItem.className = 'player-pool-item';
              playerItem.innerHTML = `
                ${player.name} (${player.role}) - ‚Çπ${player.basePrice} Cr
              `;
              playerPool.appendChild(playerItem);
            }
          });
        }
        
        // Update teams info
        if (auctionData.teams) {
          teamsContainer.innerHTML = '';
          Object.entries(auctionData.teams).forEach(([teamName, teamData]) => {
            const teamCard = document.createElement('div');
            teamCard.className = 'team-card';
            teamCard.innerHTML = `
              <h3>${teamName}</h3>
              <p>Budget: ‚Çπ${teamData.budget} Cr</p>
              <p>Players: ${teamData.squad ? teamData.squad.length : 0}/25</p>
              <p>RTM Cards: ${teamData.rtmCards || 0}</p>
              <div class="player-list">
                ${teamData.squad ? teamData.squad.map(p => 
                  `<div class="player-tag ${p.isCaptain ? 'captain' : ''} ${p.isRetained ? 'retained' : ''}">
                    ${p.name} (‚Çπ${p.price} Cr)
                  </div>`
                ).join('') : ''}
              </div>
            `;
            teamsContainer.appendChild(teamCard);
          });
        }
        
        // Update current team info
        if (auctionData.teams && auctionData.teams[currentTeam]) {
          const teamData = auctionData.teams[currentTeam];
          budgetDisplay.textContent = `‚Çπ${teamData.budget} Cr`;
          rtmDisplay.textContent = teamData.rtmCards || 0;
          squadCount.textContent = `${teamData.squad ? teamData.squad.length : 0}/25`;
        }
      });
    }
    
    // Timer for bidding
    let timerInterval;
    function startTimer(seconds) {
      clearInterval(timerInterval);
      let timeLeft = seconds;
      auctionTimer.textContent = `${timeLeft}s`;
      
      timerInterval = setInterval(() => {
        timeLeft--;
        auctionTimer.textContent = `${timeLeft}s`;
        
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          if (isAdmin && auctionData.admin === currentUser) {
            showNotification('Time up! Click "Sold!" or "Next Player"', 'warning');
          }
        }
      }, 1000);
    }
    
    // Place bid
    document.querySelectorAll('.bid-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        if (!auctionData.currentPlayer || !currentTeam) return;
        
        const increment = parseFloat(btn.dataset.increment);
        const newBid = auctionData.currentPlayer.currentBid + increment;
        const teamBudget = auctionData.teams[currentTeam].budget;
        
        if (newBid > teamBudget) {
          showNotification('Not enough budget for this bid', 'error');
          return;
        }
        
        const bidRef = push(ref(db, `auctions/${roomCode}/bids`));
        set(bidRef, {
          team: currentTeam,
          amount: newBid,
          timestamp: Date.now()
        }).then(() => {
          update(ref(db, `auctions/${roomCode}/currentPlayer`), {
            currentBid: newBid,
            currentBidder: currentTeam
          });
        }).catch(error => {
          console.error('Error placing bid:', error);
          showNotification('Failed to place bid', 'error');
        });
      });
    });
    
    // Pass on player
    passBtn.addEventListener('click', () => {
      if (!isAdmin) {
        // For regular users, just show they passed
        showNotification('You passed on this player', 'info');
        
        // For admin, show who passed
        if (auctionData.admin === currentUser) {
          const bidRef = push(ref(db, `auctions/${roomCode}/bids`));
          set(bidRef, {
            team: currentTeam,
            action: 'passed',
            timestamp: Date.now()
          });
        }
      }
    });
    
    // Use RTM
    rtmBtn.addEventListener('click', () => {
      if (!auctionData.currentPlayer || !currentTeam) return;
      
      const teamData = auctionData.teams[currentTeam];
      if (teamData.rtmCards <= 0) {
        showNotification('No RTM cards remaining', 'error');
        return;
      }
      
      // Check if player was in previous squad (simplified check)
      const playerName = auctionData.currentPlayer.name;
      const userRef = ref(db, `users/${currentUser}`);
      get(userRef).then((snap) => {
        if (snap.exists()) {
          const userData = snap.val();
          const wasInSquad = userData.players && userData.players.includes(playerName);
          
          if (!wasInSquad) {
            showNotification('This player was not in your previous squad', 'error');
            return;
          }
          
          // Use RTM
          update(ref(db, `auctions/${roomCode}/teams/${currentTeam}`), {
            rtmCards: teamData.rtmCards - 1
          }).then(() => {
            // Match the current bid
            const bidRef = push(ref(db, `auctions/${roomCode}/bids`));
            set(bidRef, {
              team: currentTeam,
              action: 'rtm',
              amount: auctionData.currentPlayer.currentBid,
              timestamp: Date.now()
            }).then(() => {
              showNotification('RTM card used!', 'success');
            });
          });
        }
      });
    });
    
    // Sell player (admin)
    sellPlayerBtn.addEventListener('click', () => {
      if (!auctionData.currentPlayer || !auctionData.currentPlayer.currentBidder) {
        showNotification('No valid bid to sell', 'error');
        return;
      }
      
      const playerKey = auctionData.currentPlayer.key;
      const winningTeam = auctionData.currentPlayer.currentBidder;
      const price = auctionData.currentPlayer.currentBid;
      
      // Add player to winning team's squad
      const newPlayer = {
        name: auctionData.currentPlayer.name,
        role: auctionData.currentPlayer.role,
        price: price,
        isCaptain: false,
        isRetained: false
      };
      
      const updates = {};
      updates[`teams/${winningTeam}/squad`] = [...(auctionData.teams[winningTeam].squad || []), newPlayer];
      updates[`teams/${winningTeam}/budget`] = auctionData.teams[winningTeam].budget - price;
      updates[`auctionPool/${playerKey}/status`] = 'sold';
      updates['currentPlayer'] = null;
      
      update(ref(db, `auctions/${roomCode}`), updates)
        .then(() => {
          showNotification(`Sold ${auctionData.currentPlayer.name} to ${winningTeam} for ‚Çπ${price} Cr`, 'success');
        })
        .catch(error => {
          console.error('Error selling player:', error);
          showNotification('Failed to sell player', 'error');
        });
    });
    
    // Next player (admin)
    nextPlayerBtn.addEventListener('click', () => {
      update(ref(db, `auctions/${roomCode}`), {
        currentPlayer: null
      }).catch(error => {
        console.error('Error moving to next player:', error);
        showNotification('Failed to move to next player', 'error');
      });
    });
    
    // Back button
    backBtn.addEventListener('click', () => {
      window.location.href = 'index.html';
    });
    
    // Close modal
    closeModal.addEventListener('click', () => {
      playerSelectModal.style.display = 'none';
    });
    
    // Show notification
    function showNotification(message, type) {
      notification.textContent = message;
      notification.style.display = 'block';
      notification.style.background = type === 'error' ? 'rgba(244, 67, 54, 0.9)' : 
                                    type === 'success' ? 'rgba(76, 175, 80, 0.9)' : 
                                    'rgba(33, 150, 243, 0.9)';
      
      setTimeout(() => {
        notification.style.display = 'none';
      }, 3000);
    }
    
    // Initialize
    setupAuctionListener();
  </script>
</body>
  </html>
