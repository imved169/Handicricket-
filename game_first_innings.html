<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HandiCricket - First Innings</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { 
      background: #061e3e url('https://images.unsplash.com/photo-1608096299210-db7e38487075?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D') no-repeat center center fixed;
      background-size: cover;
      color: white; 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      text-align: center; 
      padding: 8px;
      margin: 0;
      overflow-x: hidden;
      position: relative;
    }
    
    body::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(6, 30, 62, 0.85);
      z-index: -1;
    }
    
    /* Stadium effects */
    .stadium-effects {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: -1;
      overflow: hidden;
    }
    
    .crowd {
      position: absolute;
      bottom: 0;
      width: 100%;
      height: 100px;
      background: url('https://i.imgur.com/JQJQZQK.png') repeat-x;
      background-size: contain;
      opacity: 0.3;
      animation: crowdMove 20s linear infinite;
    }
    
    @keyframes crowdMove {
      0% { background-position: 0 0; }
      100% { background-position: -1000px 0; }
    }
    
    .pitch {
      position: absolute;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      width: 80%;
      height: 300px;
      background: linear-gradient(to bottom, #2a5c2a, #1e3e1e);
      border-radius: 50% 50% 0 0;
      box-shadow: 0 0 50px rgba(0,0,0,0.5);
    }
    
    h1 { 
      margin: 8px 0 12px;
      color: #ffeb3b;
      text-shadow: 0 0 5px rgba(255, 235, 59, 0.5);
      font-size: 1.5rem;
    }
    
    .container {
      max-width: 100%;
      width: 100%;
      margin: 0 auto;
      background: rgba(0, 0, 0, 0.4);
      border-radius: 10px;
      padding: 8px;
      box-sizing: border-box;
      backdrop-filter: blur(5px);
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    
    /* Enhanced Scoreboard */
    .scorebox-main {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px;
      background: rgba(13, 42, 82, 0.8);
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }

    .team-score {
      display: flex;
      flex-direction: column;
    }

    .score-large {
      font-size: 1.8rem;
      font-weight: bold;
      color: #ffeb3b;
    }

    .score-details {
      text-align: right;
      font-size: 0.85rem;
    }

    /* Live score ticker */
    .live-ticker {
      background: linear-gradient(90deg, #1e88e5, #0d47a1);
      color: white;
      padding: 6px;
      border-radius: 4px;
      margin: 6px 0;
      font-size: 0.8rem;
      white-space: nowrap;
      overflow: hidden;
      position: relative;
    }
    
    .ticker-content {
      display: inline-block;
      padding-left: 100%;
      animation: ticker 20s linear infinite;
    }
    
    @keyframes ticker {
      0% { transform: translateX(0); }
      100% { transform: translateX(-100%); }
    }
    
    .ticker-item {
      display: inline-block;
      margin-right: 30px;
    }
    
    .ticker-item span {
      margin: 0 5px;
      color: #ffeb3b;
      font-weight: bold;
    }

    /* Match Info Bar */
    .match-info-bar {
      display: flex;
      justify-content: center;
      align-items: center;
      background: rgba(13, 42, 82, 0.5);
      padding: 6px 8px;
      border-radius: 6px;
      margin: 4px 0 8px 0;
      font-size: 0.75rem;
      gap: 6px;
      flex-wrap: wrap;
    }

    .match-info-item {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 45%;
    }

    .divider {
      color: #666;
      flex-shrink: 0;
    }

    /* Over Progress */
    .over-progress {
      background: rgba(13, 42, 82, 0.5);
      padding: 6px;
      border-radius: 6px;
      margin: 6px 0;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .over-title {
      font-size: 0.75rem;
      color: #aaa;
      margin-bottom: 4px;
    }

    .balls-container {
      display: flex;
      gap: 4px;
    }

    .ball {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: bold;
      transition: transform 0.2s;
    }

    .ball.dot {
      background: #333;
      color: white;
    }

    .ball.run {
      background: #4CAF50;
      color: white;
    }

    .ball.wicket {
      background: #F44336;
      color: white;
    }

    .ball.wide {
      background: #FF9800;
      color: white;
    }

    .ball.noball {
      background: #9C27B0;
      color: white;
    }

    .ball.empty {
      background: rgba(255,255,255,0.1);
    }

    .over-number {
      text-align: right;
      font-size: 0.75rem;
      margin-top: 4px;
      color: #aaa;
    }

    /* Timeline Styles */
    .timeline-container {
      background: rgba(13, 42, 82, 0.7);
      border-radius: 8px;
      margin: 8px 0;
      padding: 6px;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .timeline-container h4 {
      margin: 0 0 6px 0;
      font-size: 0.85rem;
    }

    .timeline {
      display: flex;
      overflow-x: auto;
      gap: 6px;
      padding-bottom: 4px;
    }

    .timeline-item {
      min-width: 70px;
      padding: 4px;
      border-radius: 4px;
      background: rgba(30, 136, 229, 0.2);
      font-size: 0.7rem;
      text-align: center;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .timeline-item.wicket {
      background: rgba(244, 67, 54, 0.2);
      border-left: 2px solid #F44336;
    }

    .timeline-item.boundary {
      background: rgba(255, 193, 7, 0.2);
      border-left: 2px solid #FFC107;
    }

    .timeline-item.milestone {
      background: rgba(76, 175, 80, 0.2);
      border-left: 2px solid #4CAF50;
    }

    .timeline-over {
      font-weight: bold;
      margin-bottom: 2px;
    }

    .timeline-event {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Player Comparison Styles - Enhanced */
    .comparison-container {
      background: rgba(13, 42, 82, 0.7);
      border-radius: 8px;
      margin: 8px 0;
      padding: 6px;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .comparison-container h4 {
      margin: 0 0 6px 0;
      font-size: 0.85rem;
    }

    .comparison-box {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .player-comparison {
      flex: 1;
      padding: 6px;
      border-radius: 6px;
      text-align: center;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .batter-comparison {
      background: rgba(76, 175, 80, 0.1);
      border-left: 3px solid #4CAF50;
    }

    .bowler-comparison {
      background: rgba(244, 67, 54, 0.1);
      border-left: 3px solid #F44336;
    }

    .comparison-header {
      font-size: 0.65rem;
      text-transform: uppercase;
      color: #aaa;
      margin-bottom: 4px;
    }

    .comparison-name {
      font-weight: bold;
      margin: 4px 0;
      font-size: 0.85rem;
    }
    
    .comparison-name.highlight {
      animation: highlightPlayer 2s infinite;
    }
    
    @keyframes highlightPlayer {
      0% { text-shadow: 0 0 5px rgba(255,255,255,0.5); }
      50% { text-shadow: 0 0 15px gold; }
      100% { text-shadow: 0 0 5px rgba(255,255,255,0.5); }
    }

    .comparison-stats {
      font-size: 0.75rem;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
    }

    .comparison-stats div {
      flex: 1;
      min-width: 50%;
      margin: 2px 0;
    }

    .vs-circle {
      width: 30px;
      height: 30px;
      background: #1e88e5;
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 0.65rem;
      border: 2px solid white;
    }

    /* Animations */
    @keyframes scoreIncrease {
      0% { transform: scale(1); color: white; }
      50% { transform: scale(1.3); color: #4CAF50; }
      100% { transform: scale(1); color: white; }
    }

    @keyframes wicketFlash {
      0% { background-color: rgba(244, 67, 54, 0); }
      50% { background-color: rgba(244, 67, 54, 0.3); }
      100% { background-color: rgba(244, 67, 54, 0); }
    }

    @keyframes boundary {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); color: #FFC107; }
      100% { transform: scale(1); }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes ballTrail {
      0% { transform: translateX(0) translateY(0); opacity: 1; }
      100% { transform: translateX(100px) translateY(-50px); opacity: 0; }
    }
    
    @keyframes stumpFall {
      0% { transform: rotate(0); }
      100% { transform: rotate(-45deg); }
    }
    
    @keyframes screenShake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      50% { transform: translateX(5px); }
      75% { transform: translateX(-5px); }
    }
    
    @keyframes ripple {
      0% { transform: scale(0.5); opacity: 1; }
      100% { transform: scale(3); opacity: 0; }
    }

    .score-change {
      animation: scoreIncrease 0.8s ease-in-out;
    }

    .wicket-flash {
      animation: wicketFlash 1.5s ease-in-out;
    }

    .boundary-flash {
      animation: boundary 1s ease-in-out;
    }
    
    .screen-shake {
      animation: screenShake 0.5s ease-in-out;
    }

    /* Card Buttons */
    .card-btns { 
      margin: 10px auto;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 6px;
      position: relative;
    }
    
    .card-btns button { 
      width: 50px;
      height: 50px;
      font-size: 18px;
      border-radius: 8px;
      border: none;
      background: linear-gradient(145deg, #1e88e5, #1565c0);
      color: white;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
    }
    
    .card-btns button::after {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: rgba(255,255,255,0.1);
      transform: rotate(45deg);
      transition: all 0.3s;
      opacity: 0;
    }
    
    .card-btns button:hover::after {
      opacity: 1;
      top: -30%;
      left: -30%;
    }
    
    .card-btns button:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 8px rgba(0, 0, 0, 0.3);
    }
    
    .card-btns button:active {
      transform: translateY(1px);
    }
    
    .card-btns button:disabled { 
      background: #607d8b;
      color: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .card-btns button.selected {
      background: #4caf50;
      border: 2px solid #ffeb3b;
      transform: scale(1.05);
    }
    
    /* Status Indicators */
    #statusIndicators {
      margin: 6px 0;
      display: flex;
      justify-content: center;
      gap: 6px;
      flex-wrap: wrap;
    }
    
    .free-hit-indicator,
    .powerplay-indicator,
    .dead-over {
      padding: 3px 6px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
      margin: 0 2px;
      display: inline-block;
    }
    
    .free-hit-indicator {
      background: #4CAF50;
      color: white;
      animation: pulse 1.5s infinite;
    }
    
    .powerplay-indicator {
      background: #ffeb3b;
      color: #000;
      animation: pulse 2s infinite;
    }
    
    .dead-over {
      background: #f44336;
      color: white;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    /* Result Display */
    #result {
      font-size: 15px;
      margin: 8px 0;
      padding: 6px;
      min-height: 45px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.5);
      border-radius: 6px;
      border-left: 3px solid #1e88e5;
    }
    
    #result.error {
      color: #ff4444;
      background: rgba(255, 0, 0, 0.1);
      padding: 6px;
      border-radius: 4px;
      border-left: 3px solid #ff4444;
    }
    
    /* Connection Status */
    #connectionStatus {
      padding: 6px;
      border-radius: 6px;
      text-align: center;
      margin: 8px auto;
      max-width: 250px;
      font-weight: bold;
      font-size: 13px;
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .online { 
      background: #4CAF50;
      color: white;
    }
    
    .offline { 
      background: #F44336;
      color: white;
    }
    
    /* Selection Modal */
    .selection-modal { 
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 350px;
      background: linear-gradient(145deg, #123456, #0a1f3a);
      padding: 10px;
      border-radius: 12px;
      margin-bottom: 12px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.1);
      z-index: 100;
      display: none;
    }
    
    .selection-list { 
      max-height: 50vh;
      overflow-y: auto;
      margin: 6px 0;
      padding-right: 4px;
    }
    
    .player-item, .batter-item {
      padding: 6px;
      margin: 3px 0;
      background: rgba(30, 136, 229, 0.2);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      border-left: 3px solid transparent;
      font-size: 13px;
    }
    
    .player-item:hover, .batter-item:hover {
      background: rgba(30, 136, 229, 0.4);
      transform: translateX(5px);
    }
    
    .player-item.selected, .batter-item.selected {
      background: rgba(13, 71, 161, 0.6);
      border-left: 3px solid #ffeb3b;
    }
    
    /* Top Controls */
    #topControls {
      display: flex;
      justify-content: center;
      gap: 6px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    
    #topControls button {
      padding: 6px 10px;
      border: none;
      border-radius: 6px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    #saveBtn { 
      background: #FF9800;
      color: white;
    }
    
    #saveBtn:hover {
      background: #F57C00;
    }
    
    #exitBtn { 
      background: #f44336;
      color: white;
    }
    
    #exitBtn:hover {
      background: #d32f2f;
    }
    
    #resetPlaysBtn { 
      background: #9c27b0;
      color: white;
    }
    
    #resetPlaysBtn:hover {
      background: #7b1fa2;
    }
    
    /* Teams Modal */
    .teams-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 1000;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .teams-container {
      width: 90%;
      max-width: 320px;
      height: 65vh;
      display: flex;
      overflow: hidden;
      position: relative;
      scroll-snap-type: x mandatory;
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
    }

    .team-slide {
      min-width: 100%;
      height: 100%;
      padding: 8px;
      background: rgba(13, 42, 82, 0.9);
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      overflow-y: auto;
      scroll-snap-align: start;
      flex-shrink: 0;
      box-sizing: border-box;
    }

    .team-slide h3 {
      text-align: center;
      margin-bottom: 6px;
      color: #ffeb3b;
      border-bottom: 2px solid #1e88e5;
      padding-bottom: 3px;
      font-size: 0.95rem;
      position: sticky;
      top: 0;
      background: rgba(13, 42, 82, 0.9);
      z-index: 1;
    }

    .team-slide ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .team-slide li {
      padding: 6px 8px;
      margin: 3px 0;
      background: rgba(30, 136, 229, 0.2);
      border-radius: 6px;
      border-left: 2px solid #1e88e5;
      transition: all 0.3s;
      font-size: 13px;
      word-break: break-word;
      overflow-wrap: break-word;
    }

    .team-slide li:hover {
      background: rgba(30, 136, 229, 0.4);
      transform: translateX(5px);
    }

    .close-teams {
      position: absolute;
      top: 12px;
      right: 12px;
      background: #f44336;
      color: white;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      font-size: 16px;
      cursor: pointer;
      z-index: 1001;
      transition: all 0.2s;
    }
    
    .close-teams:hover {
      transform: scale(1.1);
    }

    .teams-nav {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-top: 12px;
    }

    .team-nav-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 5px;
      background: #1e88e5;
      color: white;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.2s;
    }
    
    .team-nav-btn:hover {
      background: #1565c0;
    }

    .team-nav-btn:disabled {
      background: #666;
      cursor: not-allowed;
    }

    .team-nav-indicator {
      display: flex;
      gap: 6px;
      margin-top: 8px;
    }

    .team-nav-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #555;
      cursor: pointer;
      transition: all 0.2s;
    }

    .team-nav-dot.active {
      background: #1e88e5;
      transform: scale(1.2);
    }

    .show-teams-btn {
      padding: 8px 16px;
      font-size: 13px;
      border: none;
      border-radius: 8px;
      background: linear-gradient(135deg, #9c27b0, #7b1fa2);
      color: white;
      cursor: pointer;
      margin: 12px auto;
      display: block;
      transition: all 0.3s;
    }

    .show-teams-btn:hover {
      background: linear-gradient(135deg, #7b1fa2, #6a1b9a);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    /* Team Names Display */
    .team-names-compact {
      margin-bottom: 8px;
      font-size: 13px;
      background: rgba(13, 42, 82, 0.5);
      padding: 6px;
      border-radius: 6px;
      text-align: center;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .team-name-line {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
      gap: 4px;
    }

    .team-label {
      color: #aaa;
      font-size: 11px;
    }

    .team-divider {
      color: #666;
      margin: 0 4px;
    }

    /* Over Summary */
    .over-summary-container {
      margin: 8px 0;
      padding: 6px;
      background: rgba(13, 42, 82, 0.5);
      border-radius: 6px;
      max-height: 100px;
      overflow-y: auto;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .over-summary-item {
      padding: 3px;
      margin: 3px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      font-size: 12px;
    }

    /* Spectator Mode */
    .spectator-mode {
      background: #9c27b0;
      padding: 3px 6px;
      border-radius: 15px;
      margin-bottom: 6px;
      display: inline-block;
      font-size: 11px;
      animation: pulse 2s infinite;
    }

    /* Milestone Notifications */
    .milestone-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 15px;
      z-index: 1001;
      animation: fadeInOut 3s forwards;
      box-shadow: 0 4px 15px rgba(0,0,0,0.5);
      border: 1px solid rgba(255,255,255,0.2);
      max-width: 250px;
    }
    
    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateY(5px); }
      10% { opacity: 1; transform: translateY(0); }
      90% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(5px); }
    }
    
    .milestone-notification.batting {
      border-left: 4px solid #4CAF50;
    }
    
    .milestone-notification.error {
      border-left: 4px solid #F44336;
    }
    
    .milestone-notification.info {
      border-left: 4px solid #FFC107;
    }
    
    .milestone-notification.winner {
      border-left: 4px solid #9C27B0;
      font-size: 18px;
      background: linear-gradient(135deg, rgba(0,0,0,0.9), rgba(70,0,100,0.9));
    }
    
    /* Confetti */
    .confetti {
      position: fixed;
      width: 8px;
      height: 8px;
      background-color: #f00;
      animation: confetti-fall 5s linear forwards;
      z-index: 1000;
    }
    
    @keyframes confetti-fall {
      0% {
        transform: translateY(-100vh) rotate(0deg);
        opacity: 1;
      }
      100% {
        transform: translateY(100vh) rotate(360deg);
        opacity: 0;
      }
    }
    
    /* Loading Spinner */
    .loading-spinner {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 3px solid #1e88e5;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 12px auto;
      display: none;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Reset Notification */
    .reset-notification {
      position: fixed;
      top: 20%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.9);
      color: white;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 13px;
      z-index: 1001;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      display: flex;
      flex-direction: column;
      gap: 6px;
      width: 80%;
      max-width: 280px;
      border: 1px solid rgba(255,255,255,0.2);
    }
    
    .reset-notification-buttons {
      display: flex;
      justify-content: center;
      gap: 6px;
    }
    
    .reset-notification button {
      padding: 4px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      font-size: 11px;
      transition: all 0.2s;
    }
    
    .reset-accept {
      background: #4CAF50;
      color: white;
    }
    
    .reset-accept:hover {
      background: #388E3C;
    }
    
    .reset-decline {
      background: #f44336;
      color: white;
    }
    
    .reset-decline:hover {
      background: #d32f2f;
    }
    
    /* Innings Summary Popup - Updated to match image */
    .summary-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(145deg, #123456, #0a1f3a);
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.1);
      z-index: 1001;
      text-align: center;
      color: white;
      max-width: 320px;
      width: 90%;
      display: none;
    }
    
    .summary-popup h3 {
      margin-top: 0;
      color: #ffeb3b;
      font-size: 1.2rem;
      border-bottom: 2px solid #1e88e5;
      padding-bottom: 6px;
      margin-bottom: 12px;
    }
    
    .summary-content {
      text-align: left;
      margin-bottom: 12px;
    }
    
    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
      font-size: 13px;
    }
    
    .summary-label {
      color: #aaa;
    }
    
    .summary-value {
      font-weight: bold;
    }
    
    .summary-highlight {
      background: rgba(255, 235, 59, 0.2);
      padding: 4px;
      border-radius: 4px;
      margin: 8px 0;
      font-weight: bold;
      text-align: center;
      border-left: 3px solid #ffeb3b;
    }
    
    .summary-countdown {
      font-size: 22px;
      font-weight: bold;
      margin: 8px 0;
      color: #4CAF50;
    }
    
    .summary-popup button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 15px;
      cursor: pointer;
      margin-top: 8px;
      transition: all 0.3s;
      width: 100%;
    }
    
    .summary-popup button:hover {
      background: #388E3C;
      transform: scale(1.05);
    }
    
    /* Match graphics */
    .match-graphics {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 999;
    }
    
    .ball-trail {
      position: absolute;
      width: 10px;
      height: 10px;
      background: white;
      border-radius: 50%;
      z-index: 1000;
      animation: ballTrail 0.5s forwards;
    }
    
    .stump {
      position: absolute;
      width: 5px;
      height: 30px;
      background: #8B4513;
      bottom: 50px;
      transform-origin: bottom center;
    }
    
    .stump.left {
      left: calc(50% - 15px);
    }
    
    .stump.middle {
      left: 50%;
      transform: translateX(-50%);
    }
    
    .stump.right {
      left: calc(50% + 10px);
    }
    
    .stump.bail {
      width: 20px;
      height: 5px;
      background: #D2B48C;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
    }
    
    .ripple-effect {
      position: absolute;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: rgba(255,255,255,0.5);
      animation: ripple 1s forwards;
      z-index: 999;
    }
    
    /* Mini scorecard */
    .mini-scorecard {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: rgba(0,0,0,0.7);
      padding: 8px;
      border-radius: 6px;
      font-size: 12px;
      z-index: 100;
      border: 1px solid rgba(255,255,255,0.2);
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    
    .mini-scorecard .score {
      font-weight: bold;
      color: #ffeb3b;
    }
    
    /* Match awards */
    .awards-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
      justify-content: center;
    }
    
    .award-badge {
      background: rgba(255,215,0,0.2);
      border: 1px solid gold;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
    }
    
    /* Stats charts */
    .stats-chart {
      width: 100%;
      height: 100px;
      margin: 10px 0;
      background: rgba(255,255,255,0.1);
      border-radius: 4px;
      position: relative;
      overflow: hidden;
    }
    
    .chart-bar {
      position: absolute;
      bottom: 0;
      background: #1e88e5;
      width: 20px;
      transition: height 0.5s;
    }
    
    /* Umpire signals */
    .umpire-signal {
      position: fixed;
      bottom: 20%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 10px;
      border-radius: 50%;
      font-size: 24px;
      z-index: 1001;
      animation: fadeInOut 2s forwards;
    }
    
    /* Weather effects */
    .weather-rain {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url('https://i.imgur.com/JQJQZQK.png');
      opacity: 0.3;
      z-index: 999;
      pointer-events: none;
      animation: rain 0.5s linear infinite;
    }
    
    @keyframes rain {
      0% { background-position: 0 0; }
      100% { background-position: 0 100px; }
    }
    
    /* Stats slides */
    .stats-slide {
      min-width: 100%;
      height: 100%;
      padding: 8px;
      background: rgba(13, 42, 82, 0.9);
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      overflow-y: auto;
      scroll-snap-align: start;
      flex-shrink: 0;
      box-sizing: border-box;
    }
    
    .stats-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-top: 8px;
    }
    
    .stats-table th, .stats-table td {
      padding: 4px;
      text-align: left;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .stats-table th {
      position: sticky;
      top: 0;
      background: rgba(13, 42, 82, 0.9);
      color: #ffeb3b;
    }
    
    .stats-table tr:nth-child(even) {
      background: rgba(30, 136, 229, 0.1);
    }
    
    .stats-table tr:hover {
      background: rgba(30, 136, 229, 0.2);
    }
    
    /* Commentary styles */
    .commentary-item {
      padding: 6px;
      margin: 4px 0;
      background: rgba(30, 136, 229, 0.1);
      border-radius: 4px;
      font-size: 12px;
      border-left: 3px solid #1e88e5;
    }
    
    .commentary-over {
      font-weight: bold;
      color: #ffeb3b;
      margin-bottom: 2px;
    }
    
    .commentary-text {
      font-style: italic;
    }
    
    /* Responsive Styles */
    @media (max-width: 768px) {
      .card-btns button {
        width: 45px;
        height: 45px;
        font-size: 16px;
      }
      
      .selection-modal {
        width: 95%;
        max-height: 60vh;
      }
      
      .teams-container {
        width: 95%;
        max-width: 350px;
        height: 55%;
      }
      
      .team-slide {
        min-width: 100%;
      }
    }
    
    @media (max-width: 480px) {
      body {
        padding: 6px;
      }
      
      .container {
        padding: 8px;
      }
      
      h1 {
        font-size: 1.3rem;
        margin: 6px 0 10px;
      }
      
      .card-btns button {
        width: 40px;
        height: 40px;
        font-size: 15px;
      }
      
      .selection-modal {
        padding: 8px;
      }
      
      .player-item, .batter-item {
        padding: 5px;
        font-size: 12px;
      }
      
      #topControls button {
        padding: 5px 8px;
        font-size: 10px;
      }
      
      .team-slide h3 {
        font-size: 0.9rem;
      }
      
      .team-slide li {
        font-size: 11px;
        padding: 5px 6px;
      }
      
      .team-names {
        flex-direction: column;
        gap: 4px;
      }
      
      .teams-container {
        height: 70vh;
        max-width: 300px;
      }

      .score-large {
        font-size: 1.5rem;
      }
      
      .match-info-bar {
        font-size: 0.7rem;
      }
    }
  </style>
</head>
<body>
  <div class="stadium-effects">
    <div class="crowd"></div>
    <div class="pitch"></div>
  </div>
  
  <div class="match-graphics" id="matchGraphics"></div>
  
  <div class="container">
    <div class="team-names-compact">
      <div class="team-name-line">
        <span class="team-label">Batting:</span>
        <span id="team1Name">Team A</span>
        <span class="team-divider">|</span>
        <span class="team-label">Bowling:</span>
        <span id="team2Name">Team B</span>
      </div>
    </div>
    
    <!-- Live score ticker -->
    <div class="live-ticker">
      <div class="ticker-content" id="tickerContent">
        <div class="ticker-item">Partnership: <span id="tickerPartnership">0</span> runs (<span id="tickerPartnershipBalls">0</span> balls)</div>
        <div class="ticker-item">Run Rate: <span id="tickerRunRate">0.00</span></div>
        <div class="ticker-item">Last 5 Overs: <span id="tickerLast5">0/0</span></div>
        <div class="ticker-item">Required Rate: <span id="tickerRequiredRate">0.00</span></div>
      </div>
    </div>
    
    <!-- Enhanced Scoreboard -->
    <div class="scorebox">
      <div class="scorebox-main">
        <div class="team-score">
          <span id="battingTeamName">Team A</span>
          <span class="score-large"><span id="runs">0</span>/<span id="wickets">0</span></span>
        </div>
        <div class="score-details">
          <div>Overs: <strong id="overs">0.0</strong></div>
          <div>Run Rate: <strong id="runRate">0.00</strong></div>
        </div>
      </div>
    </div>
    
    <!-- Match Info Bar -->
    <div class="match-info-bar">
      <div class="match-format" id="formatDisplay"></div>
      <div class="match-status">
        <span id="inningsNumber">1st Innings</span>
        <span class="divider">|</span>
        <span id="roleText"></span>
      </div>
      <div class="match-time">
        <span id="currentTime">14:30</span>
        <span class="divider">|</span>
        <span id="matchDate">23 Jul 2023</span>
      </div>
    </div>
    
    <!-- Over Progress -->
    <div class="over-progress">
      <div class="over-title">Current Over</div>
      <div class="balls-container" id="ballsContainer">
        <!-- Balls will be added dynamically -->
      </div>
      <div class="over-number">Over <span id="currentOverNumber">1</span></div>
    </div>
    
    <!-- Match Timeline -->
    <div class="timeline-container">
      <h4>Match Timeline</h4>
      <div class="timeline" id="matchTimeline">
        <!-- Timeline items will be added here -->
      </div>
    </div>
    
    <!-- Enhanced Player Comparison -->
    <div class="comparison-container">
      <h4>Current Battle</h4>
      <div class="comparison-box">
        <div class="player-comparison batter-comparison">
          <div class="comparison-header">Batter</div>
          <div class="comparison-name" id="comparisonBatterName">-</div>
          <div class="comparison-stats">
            <div>Runs: <span id="comparisonBatterRuns">0</span></div>
            <div>Balls: <span id="comparisonBatterBalls">0</span></div>
            <div>SR: <span id="comparisonBatterSR">0.00</span></div>
            <div>4s/6s: <span id="comparisonBatterBoundaries">0/0</span></div>
          </div>
        </div>
        <div class="vs-circle">VS</div>
        <div class="player-comparison bowler-comparison">
          <div class="comparison-header">Bowler</div>
          <div class="comparison-name" id="comparisonBowlerName">-</div>
          <div class="comparison-stats">
            <div>Overs: <span id="comparisonBowlerOvers">0.0</span></div>
            <div>Wkts: <span id="comparisonBowlerWickets">0</span></div>
            <div>ER: <span id="comparisonBowlerER">0.00</span></div>
            <div>Runs: <span id="comparisonBowlerRuns">0</span></div>
          </div>
        </div>
      </div>
    </div>
    
    <div id="statusIndicators">
      <span id="powerplayIndicator" class="powerplay-indicator" style="display: none;">Powerplay</span>
      <span id="deadOverIndicator" class="dead-over" style="display: none;">Dead Over</span>
      <span id="freeHitIndicator" class="free-hit-indicator" style="display: none;">Free Hit</span>
    </div>
    
    <div id="result">Initializing game...</div>
    
    <div class="card-btns" id="cardButtons">
      <button class="btn" data-value="0">0</button>
      <button class="btn" data-value="1">1</button>
      <button class="btn" data-value="2">2</button>
      <button class="btn" data-value="3">3</button>
      <button class="btn" data-value="4">4</button>
      <button class="btn" data-value="5">5</button>
      <button class="btn" data-value="6">6</button>
    </div>

    <div class="over-summary-container">
      <h4>Over Summary</h4>
      <div id="overSummaryList"></div>
    </div>

    <button class="show-teams-btn" id="showTeamsBtn">Show Teams</button>

    <div id="topControls">
      <button id="saveBtn">💾 Save & Exit</button>
      <button id="exitBtn">🚪 Exit Without Saving</button>
      <button id="resetPlaysBtn">🔄 Reset Plays</button>
    </div>
    <div id="connectionStatus" class="online">
      Opponent: Online
    </div>
    
    <div id="loading-spinner" class="loading-spinner"></div>
  </div>
  
  <!-- Mini scorecard that stays visible when scrolling -->
  <div class="mini-scorecard" id="miniScorecard" style="display: none;">
    <span id="miniScore">0/0</span> (<span id="miniOvers">0.0</span>)
  </div>
  
  <div id="selectionModal" class="selection-modal">
    <h3 id="selectionTitle">Select Next Batter</h3>
    <div id="selectionList" class="selection-list"></div>
    <button id="confirmSelection">Confirm Selection</button>
  </div>

  <div id="teamsModal" class="teams-modal">
    <button class="close-teams" id="closeTeamsBtn">×</button>
    <div class="teams-container" id="teamsSlider">
      <div class="team-slide" id="team1Slide">
        <h3 id="modalTeam1Name">Team 1</h3>
        <ul id="modalTeam1Players"></ul>
      </div>
      <div class="team-slide" id="team2Slide">
        <h3 id="modalTeam2Name">Team 2</h3>
        <ul id="modalTeam2Players"></ul>
      </div>
    </div>
    <div class="teams-nav">
      <button class="team-nav-btn" id="prevTeamBtn" disabled>Previous</button>
      <button class="team-nav-btn" id="nextTeamBtn">Next</button>
    </div>
    <div class="team-nav-indicator">
      <div class="team-nav-dot active" data-index="0"></div>
      <div class="team-nav-dot" data-index="1"></div>
    </div>
  </div>

  <!-- Enhanced Innings Summary Popup with stats slides -->
  <div id="summaryPopup" class="summary-popup">
    <h3 id="summaryTitle">First Innings Summary</h3>
    <div class="summary-content">
      <div class="summary-row">
        <span class="summary-label">Total Runs:</span>
        <span class="summary-value" id="summaryTotalRuns">0</span>
      </div>
      <div class="summary-row">
        <span class="summary-label">Wickets:</span>
        <span class="summary-value" id="summaryWickets">0</span>
      </div>
      <div class="summary-row">
        <span class="summary-label">Overs:</span>
        <span class="summary-value" id="summaryOvers">0.0</span>
      </div>
      <div class="summary-row">
        <span class="summary-label">Run Rate:</span>
        <span class="summary-value" id="summaryRunRate">0.00</span>
      </div>
      <div class="summary-highlight" id="summaryHighlight"></div>
      
      <!-- Stats slides container -->
      <div class="teams-container" id="statsSlider" style="height: 200px; margin: 10px 0;">
        <!-- Batters stats slide -->
        <div class="stats-slide">
          <h4>Batting Stats</h4>
          <table class="stats-table" id="battersStatsTable">
            <thead>
              <tr>
                <th>Batter</th>
                <th>Runs</th>
                <th>Balls</th>
                <th>SR</th>
                <th>4s/6s</th>
              </tr>
            </thead>
            <tbody id="battersStatsBody"></tbody>
          </table>
        </div>
        
        <!-- Bowlers stats slide -->
        <div class="stats-slide">
          <h4>Bowling Stats</h4>
          <table class="stats-table" id="bowlersStatsTable">
            <thead>
              <tr>
                <th>Bowler</th>
                <th>Overs</th>
                <th>Wkts</th>
                <th>Runs</th>
                <th>ER</th>
              </tr>
            </thead>
            <tbody id="bowlersStatsBody"></tbody>
          </table>
        </div>
      </div>
      
      <!-- Stats navigation -->
      <div class="teams-nav">
        <button class="team-nav-btn" id="prevStatsBtn" disabled>Previous</button>
        <button class="team-nav-btn" id="nextStatsBtn">Next</button>
      </div>
      <div class="team-nav-indicator">
        <div class="team-nav-dot active" data-index="0"></div>
        <div class="team-nav-dot" data-index="1"></div>
      </div>
      
      <!-- Target display for second innings -->
      <div class="summary-row" id="targetDisplay" style="display: none;">
        <span class="summary-label">Target:</span>
        <span class="summary-value" id="targetValue">0</span>
      </div>
      
      <!-- Player of the match -->
      <div class="summary-row" id="pomDisplay" style="display: none;">
        <span class="summary-label">Player of the Match:</span>
        <span class="summary-value" id="pomValue">-</span>
      </div>
      
      <!-- Awards section -->
      <div class="awards-container" id="awardsContainer" style="display: none;">
        <!-- Awards will be added dynamically -->
      </div>
    </div>
    <button id="startSecondInningsBtn">🏏 Start Second Innings</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, get, push, child } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCN6aZMwlsZe7JJaovU0WA3UQygWr4jYmA",
      authDomain: "handicricket-85a06.firebaseapp.com",
      projectId: "handicricket-85a06",
      storageBucket: "handicricket-85a06.appspot.com",
      messagingSenderId: "599182538558",
      appId: "1:599182538558:web:3e965753ab05f8f1e3de6f",
      measurementId: "G-HSV9H4LEJQ"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Get URL parameters
    const params = new URLSearchParams(window.location.search);
    const roomId = params.get('room');
    const player = params.get('player');
    const isSpectator = player === 'spectator';

    if (!roomId || (!player && !isSpectator)) {
      alert('Invalid room or player');
      window.location.href = 'index.html';
    }

    // DOM elements
    const team1NameEl = document.getElementById('team1Name');
    const team2NameEl = document.getElementById('team2Name');
    const battingTeamNameEl = document.getElementById('battingTeamName');
    const runsEl = document.getElementById('runs');
    const wicketsEl = document.getElementById('wickets');
    const oversEl = document.getElementById('overs');
    const runRateEl = document.getElementById('runRate');
    const formatDisplayEl = document.getElementById('formatDisplay');
    const inningsNumberEl = document.getElementById('inningsNumber');
    const roleTextEl = document.getElementById('roleText');
    const currentTimeEl = document.getElementById('currentTime');
    const matchDateEl = document.getElementById('matchDate');
    const ballsContainerEl = document.getElementById('ballsContainer');
    const currentOverNumberEl = document.getElementById('currentOverNumber');
    const matchTimelineEl = document.getElementById('matchTimeline');
    const comparisonBatterNameEl = document.getElementById('comparisonBatterName');
    const comparisonBatterRunsEl = document.getElementById('comparisonBatterRuns');
    const comparisonBatterBallsEl = document.getElementById('comparisonBatterBalls');
    const comparisonBatterSREl = document.getElementById('comparisonBatterSR');
    const comparisonBatterBoundariesEl = document.getElementById('comparisonBatterBoundaries');
    const comparisonBowlerNameEl = document.getElementById('comparisonBowlerName');
    const comparisonBowlerOversEl = document.getElementById('comparisonBowlerOvers');
    const comparisonBowlerWicketsEl = document.getElementById('comparisonBowlerWickets');
    const comparisonBowlerEREl = document.getElementById('comparisonBowlerER');
    const comparisonBowlerRunsEl = document.getElementById('comparisonBowlerRuns');
    const powerplayIndicatorEl = document.getElementById('powerplayIndicator');
    const deadOverIndicatorEl = document.getElementById('deadOverIndicator');
    const freeHitIndicatorEl = document.getElementById('freeHitIndicator');
    const resultEl = document.getElementById('result');
    const cardButtonsEl = document.getElementById('cardButtons');
    const overSummaryListEl = document.getElementById('overSummaryList');
    const showTeamsBtnEl = document.getElementById('showTeamsBtn');
    const saveBtnEl = document.getElementById('saveBtn');
    const exitBtnEl = document.getElementById('exitBtn');
    const resetPlaysBtnEl = document.getElementById('resetPlaysBtn');
    const connectionStatusEl = document.getElementById('connectionStatus');
    const loadingSpinnerEl = document.getElementById('loading-spinner');
    const miniScorecardEl = document.getElementById('miniScorecard');
    const miniScoreEl = document.getElementById('miniScore');
    const miniOversEl = document.getElementById('miniOvers');
    const selectionModalEl = document.getElementById('selectionModal');
    const selectionTitleEl = document.getElementById('selectionTitle');
    const selectionListEl = document.getElementById('selectionList');
    const confirmSelectionEl = document.getElementById('confirmSelection');
    const teamsModalEl = document.getElementById('teamsModal');
    const closeTeamsBtnEl = document.getElementById('closeTeamsBtn');
    const modalTeam1NameEl = document.getElementById('modalTeam1Name');
    const modalTeam1PlayersEl = document.getElementById('modalTeam1Players');
    const modalTeam2NameEl = document.getElementById('modalTeam2Name');
    const modalTeam2PlayersEl = document.getElementById('modalTeam2Players');
    const prevTeamBtnEl = document.getElementById('prevTeamBtn');
    const nextTeamBtnEl = document.getElementById('nextTeamBtn');
    const summaryPopupEl = document.getElementById('summaryPopup');
    const summaryTitleEl = document.getElementById('summaryTitle');
    const summaryTotalRunsEl = document.getElementById('summaryTotalRuns');
    const summaryWicketsEl = document.getElementById('summaryWickets');
    const summaryOversEl = document.getElementById('summaryOvers');
    const summaryRunRateEl = document.getElementById('summaryRunRate');
    const summaryHighlightEl = document.getElementById('summaryHighlight');
    const targetDisplayEl = document.getElementById('targetDisplay');
    const targetValueEl = document.getElementById('targetValue');
    const pomDisplayEl = document.getElementById('pomDisplay');
    const pomValueEl = document.getElementById('pomValue');
    const awardsContainerEl = document.getElementById('awardsContainer');
    const startSecondInningsBtnEl = document.getElementById('startSecondInningsBtn');
    const battersStatsBodyEl = document.getElementById('battersStatsBody');
    const bowlersStatsBodyEl = document.getElementById('bowlersStatsBody');
    const prevStatsBtnEl = document.getElementById('prevStatsBtn');
    const nextStatsBtnEl = document.getElementById('nextStatsBtn');
    const tickerPartnershipEl = document.getElementById('tickerPartnership');
    const tickerPartnershipBallsEl = document.getElementById('tickerPartnershipBalls');
    const tickerRunRateEl = document.getElementById('tickerRunRate');
    const tickerLast5El = document.getElementById('tickerLast5');
    const tickerRequiredRateEl = document.getElementById('tickerRequiredRate');

    // Firebase references
    const roomRef = ref(db, `rooms/${roomId}`);
    const gameRef = ref(db, `rooms/${roomId}/game`);
    const playerRef = ref(db, `rooms/${roomId}/${player}`);
    const opponent = player === 'player1' ? 'player2' : 'player1';
    const opponentRef = ref(db, `rooms/${roomId}/${opponent}`);
    const teamsRef = ref(db, `rooms/${roomId}/teams`);
    const tossRef = ref(db, `rooms/${roomId}/toss`);
    const savedMatchesRef = ref(db, 'savedMatches');

    // Game state variables
    let gameState = {
      firstInnings: {
        totalRuns: 0,
        totalWickets: 0,
        balls: 0,
        batterStats: {},
        bowlerStats: {},
        currentBatter: null,
        currentBowler: null,
        batters: [],
        bowlers: [],
        overs: [],
        extras: {
          wides: 0,
          noballs: 0,
          byes: 0,
          legbyes: 0
        },
        partnership: {
          runs: 0,
          balls: 0,
          batters: []
        }
      },
      secondInnings: {
        totalRuns: 0,
        totalWickets: 0,
        balls: 0,
        batterStats: {},
        bowlerStats: {},
        currentBatter: null,
        currentBowler: null,
        batters: [],
        bowlers: [],
        overs: [],
        extras: {
          wides: 0,
          noballs: 0,
          byes: 0,
          legbyes: 0
        },
        partnership: {
          runs: 0,
          balls: 0,
          batters: []
        }
      },
      currentInnings: 1, // 1 for first innings, 2 for second
      currentOver: 0,
      currentBall: 0,
      isPowerplay: false,
      isDeadOver: false,
      isFreeHit: false,
      isMatchOver: false,
      winner: null,
      winningMargin: null,
      playerOfTheMatch: null,
      team1Name: '',
      team2Name: '',
      team1Players: [],
      team2Players: [],
      battingFirst: null,
      format: '5',
      maxOvers: 5,
      maxWickets: 11,
      powerplayOvers: 2,
      deadOverOvers: 0,
      tossWinner: null,
      tossChoice: null,
      currentDateTime: new Date().toISOString()
    };

    // Player state
    let playerState = {
      role: null, // 'batting' or 'bowling'
      selectedCard: null,
      isReady: false,
      username: localStorage.getItem('hc_username') || 'Player',
      teamName: localStorage.getItem('hc_team') || 'Team'
    };

    // UI state
    let uiState = {
      selectedPlayer: null,
      currentStatsSlide: 0,
      currentTeamSlide: 0
    };

    // Initialize the game
    async function initializeGame() {
      loadingSpinnerEl.style.display = 'block';
      resultEl.textContent = 'Loading match data...';

      try {
        // Load room data
        const roomSnapshot = await get(roomRef);
        if (!roomSnapshot.exists()) {
          throw new Error('Room not found');
        }
        const roomData = roomSnapshot.val();

        // Load teams data
        const teamsSnapshot = await get(teamsRef);
        if (!teamsSnapshot.exists()) {
          throw new Error('Teams not found');
        }
        const teamsData = teamsSnapshot.val();

        // Load toss data
        const tossSnapshot = await get(tossRef);
        const tossData = tossSnapshot.exists() ? tossSnapshot.val() : {};

        // Set game state from room data
        gameState.team1Name = roomData.player1?.team || 'Team A';
        gameState.team2Name = roomData.player2?.team || 'Team B';
        gameState.format = roomData.player1?.format || '5';
        gameState.tossWinner = tossData.winner;
        gameState.tossChoice = tossData.battingChoice;
        gameState.battingFirst = tossData.battingFirst;

        // Set format-specific rules
        setFormatRules(gameState.format);

        // Set team players
        gameState.team1Players = teamsData.player1?.players || [];
        gameState.team2Players = teamsData.player2?.players || [];

        // Determine batting and bowling teams based on innings
        if (gameState.currentInnings === 1) {
          gameState.battingTeam = gameState.battingFirst === 'player1' ? gameState.team1Name : gameState.team2Name;
          gameState.bowlingTeam = gameState.battingFirst === 'player1' ? gameState.team2Name : gameState.team1Name;
        } else {
          gameState.battingTeam = gameState.battingFirst === 'player1' ? gameState.team2Name : gameState.team1Name;
          gameState.bowlingTeam = gameState.battingFirst === 'player1' ? gameState.team1Name : gameState.team2Name;
        }

        // Set player role
        if (!isSpectator) {
          if ((gameState.currentInnings === 1 && gameState.battingFirst === player) || 
              (gameState.currentInnings === 2 && gameState.battingFirst !== player)) {
            playerState.role = 'batting';
          } else {
            playerState.role = 'bowling';
          }
        }

        // Update UI with initial data
        updateUI();

        // Set current date and time
        const now = new Date();
        currentTimeEl.textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        matchDateEl.textContent = now.toLocaleDateString([], { day: 'numeric', month: 'short', year: 'numeric' });

        // Set player online status
        if (!isSpectator) {
          await set(playerRef, {
            connected: true,
            username: playerState.username,
            team: playerState.teamName,
            role: playerState.role
          });
        }

        // Initialize Firebase listeners
        initializeListeners();

        loadingSpinnerEl.style.display = 'none';
        resultEl.textContent = 'Match ready!';

        // If spectator, disable all buttons
        if (isSpectator) {
          document.querySelectorAll('.card-btns button').forEach(btn => {
            btn.disabled = true;
          });
          document.querySelectorAll('#topControls button').forEach(btn => {
            btn.disabled = true;
          });
          resultEl.textContent = 'Spectating match...';
        }

      } catch (error) {
        console.error('Error initializing game:', error);
        resultEl.textContent = 'Error loading match data';
        resultEl.classList.add('error');
        loadingSpinnerEl.style.display = 'none';
      }
    }

    // Set format-specific rules
    function setFormatRules(format) {
      switch(format) {
        case '5':
          gameState.maxOvers = 5;
          gameState.maxWickets = 11;
          gameState.powerplayOvers = 2;
          gameState.deadOverOvers = 0;
          formatDisplayEl.textContent = 'T5 (5 Overs)';
          break;
        case '10':
          gameState.maxOvers = 10;
          gameState.maxWickets = 11;
          gameState.powerplayOvers = 3;
          gameState.deadOverOvers = 0;
          formatDisplayEl.textContent = 'T10 (10 Overs)';
          break;
        case '20':
          gameState.maxOvers = 20;
          gameState.maxWickets = 11;
          gameState.powerplayOvers = 6;
          gameState.deadOverOvers = 0;
          formatDisplayEl.textContent = 'T20 (20 Overs)';
          break;
        case '50':
          gameState.maxOvers = 50;
          gameState.maxWickets = 11;
          gameState.powerplayOvers = 10;
          gameState.deadOverOvers = 20;
          formatDisplayEl.textContent = 'ODI (50 Overs)';
          break;
        default:
          gameState.maxOvers = 5;
          gameState.maxWickets = 11;
          gameState.powerplayOvers = 2;
          gameState.deadOverOvers = 0;
          formatDisplayEl.textContent = 'T5 (5 Overs)';
      }
    }

    // Initialize Firebase listeners
    function initializeListeners() {
      // Listen for game state changes
      onValue(gameRef, (snapshot) => {
        if (snapshot.exists()) {
          const gameData = snapshot.val();
          updateGameState(gameData);
          updateUI();
        }
      });

      // Listen for opponent connection status
      if (!isSpectator) {
        onValue(opponentRef, (snapshot) => {
          if (snapshot.exists() && snapshot.val().connected) {
            connectionStatusEl.textContent = 'Opponent: Online';
            connectionStatusEl.className = 'online';
          } else {
            connectionStatusEl.textContent = 'Opponent: Offline';
            connectionStatusEl.className = 'offline';
          }
        });
      }
    }

    // Update game state from Firebase data
    function updateGameState(gameData) {
      gameState.firstInnings = gameData.firstInnings || gameState.firstInnings;
      gameState.secondInnings = gameData.secondInnings || gameState.secondInnings;
      gameState.currentInnings = gameData.currentInnings || gameState.currentInnings;
      gameState.currentOver = gameData.currentOver || gameState.currentOver;
      gameState.currentBall = gameData.currentBall || gameState.currentBall;
      gameState.isPowerplay = gameData.isPowerplay || gameState.isPowerplay;
      gameState.isDeadOver = gameData.isDeadOver || gameState.isDeadOver;
      gameState.isFreeHit = gameData.isFreeHit || gameState.isFreeHit;
      gameState.isMatchOver = gameData.isMatchOver || gameState.isMatchOver;
      gameState.winner = gameData.winner || gameState.winner;
      gameState.winningMargin = gameData.winningMargin || gameState.winningMargin;
      gameState.playerOfTheMatch = gameData.playerOfTheMatch || gameState.playerOfTheMatch;
    }

    // Update UI based on game state
    function updateUI() {
      const currentInnings = gameState.currentInnings === 1 ? gameState.firstInnings : gameState.secondInnings;
      
      // Update scoreboard
      team1NameEl.textContent = gameState.team1Name;
      team2NameEl.textContent = gameState.team2Name;
      battingTeamNameEl.textContent = gameState.battingTeam;
      runsEl.textContent = currentInnings.totalRuns;
      wicketsEl.textContent = currentInnings.totalWickets;
      
      // Calculate overs
      const overs = Math.floor(currentInnings.balls / 6);
      const balls = currentInnings.balls % 6;
      oversEl.textContent = `${overs}.${balls}`;
      
      // Calculate run rate
      const runRate = currentInnings.balls > 0 ? 
        (currentInnings.totalRuns / (currentInnings.balls / 6)).toFixed(2) : '0.00';
      runRateEl.textContent = runRate;
      
      // Update innings number
      inningsNumberEl.textContent = gameState.currentInnings === 1 ? '1st Innings' : '2nd Innings';
      
      // Update role text
      if (!isSpectator) {
        roleTextEl.textContent = playerState.role === 'batting' ? 'Batting' : 'Bowling';
      } else {
        roleTextEl.textContent = 'Spectator';
      }
      
      // Update over progress
      updateOverProgress();
      
      // Update player comparison
      updatePlayerComparison();
      
      // Update powerplay/dead over indicators
      updateSpecialOverIndicators();
      
      // Update mini scorecard
      miniScoreEl.textContent = `${currentInnings.totalRuns}/${currentInnings.totalWickets}`;
      miniOversEl.textContent = `${overs}.${balls}`;
      miniScorecardEl.style.display = 'block';
      
      // Update ticker
      updateTicker();
      
      // Check if innings is complete
      checkInningsComplete();
    }

    // Update over progress display
    function updateOverProgress() {
      ballsContainerEl.innerHTML = '';
      const currentInnings = gameState.currentInnings === 1 ? gameState.firstInnings : gameState.secondInnings;
      
      // Add balls for current over
      for (let i = 0; i < 6; i++) {
        const ballEl = document.createElement('div');
        ballEl.className = 'ball empty';
        
        // Check if ball has been bowled
        const currentOverIndex = Math.floor(currentInnings.balls / 6);
        if (currentOverIndex === gameState.currentOver && i < gameState.currentBall) {
          const ballData = currentInnings.overs[gameState.currentOver]?.balls[i];
          if (ballData) {
            switch(ballData.type) {
              case 'dot':
                ballEl.className = 'ball dot';
                ballEl.textContent = '•';
                break;
              case 'run':
                ballEl.className = 'ball run';
                ballEl.textContent = ballData.runs;
                break;
              case 'wicket':
                ballEl.className = 'ball wicket';
                ballEl.textContent = 'W';
                break;
              case 'wide':
                ballEl.className = 'ball wide';
                ballEl.textContent = 'Wd';
                break;
              case 'noball':
                ballEl.className = 'ball noball';
                ballEl.textContent = 'Nb';
                break;
              default:
                ballEl.className = 'ball empty';
            }
          }
        }
        
        ballsContainerEl.appendChild(ballEl);
      }
      
      // Update over number
      currentOverNumberEl.textContent = gameState.currentOver + 1;
    }

    // Update player comparison
    function updatePlayerComparison() {
      const currentInnings = gameState.currentInnings === 1 ? gameState.firstInnings : gameState.secondInnings;
      
      if (currentInnings.currentBatter) {
        const batterStats = currentInnings.batterStats[currentInnings.currentBatter] || { runs: 0, balls: 0, fours: 0, sixes: 0 };
        comparisonBatterNameEl.textContent = currentInnings.currentBatter;
        comparisonBatterRunsEl.textContent = batterStats.runs;
        comparisonBatterBallsEl.textContent = batterStats.balls;
        comparisonBatterSREl.textContent = batterStats.balls > 0 ? 
          ((batterStats.runs / batterStats.balls) * 100).toFixed(2) : '0.00';
        comparisonBatterBoundariesEl.textContent = `${batterStats.fours}/${batterStats.sixes}`;
        
        // Highlight batter if they're on strike
        comparisonBatterNameEl.classList.toggle('highlight', true);
      } else {
        comparisonBatterNameEl.textContent = '-';
        comparisonBatterRunsEl.textContent = '0';
        comparisonBatterBallsEl.textContent = '0';
        comparisonBatterSREl.textContent = '0.00';
        comparisonBatterBoundariesEl.textContent = '0/0';
        comparisonBatterNameEl.classList.remove('highlight');
      }
      
      if (currentInnings.currentBowler) {
        const bowlerStats = currentInnings.bowlerStats[currentInnings.currentBowler] || { runs: 0, balls: 0, wickets: 0 };
        comparisonBowlerNameEl.textContent = currentInnings.currentBowler;
        comparisonBowlerOversEl.textContent = (bowlerStats.balls / 6).toFixed(1);
        comparisonBowlerWicketsEl.textContent = bowlerStats.wickets;
        comparisonBowlerRunsEl.textContent = bowlerStats.runs;
        comparisonBowlerEREl.textContent = bowlerStats.balls > 0 ? 
          (bowlerStats.runs / (bowlerStats.balls / 6)).toFixed(2) : '0.00';
        
        // Highlight bowler if they're bowling
        comparisonBowlerNameEl.classList.toggle('highlight', true);
      } else {
        comparisonBowlerNameEl.textContent = '-';
        comparisonBowlerOversEl.textContent = '0.0';
        comparisonBowlerWicketsEl.textContent = '0';
        comparisonBowlerRunsEl.textContent = '0';
        comparisonBowlerEREl.textContent = '0.00';
        comparisonBowlerNameEl.classList.remove('highlight');
      }
    }

    // Update powerplay/dead over indicators
    function updateSpecialOverIndicators() {
      if (gameState.isPowerplay) {
        powerplayIndicatorEl.style.display = 'inline-block';
      } else {
        powerplayIndicatorEl.style.display = 'none';
      }
      
      if (gameState.isDeadOver) {
        deadOverIndicatorEl.style.display = 'inline-block';
      } else {
        deadOverIndicatorEl.style.display = 'none';
      }
      
      if (gameState.isFreeHit) {
        freeHitIndicatorEl.style.display = 'inline-block';
      } else {
        freeHitIndicatorEl.style.display = 'none';
      }
    }

    // Update live ticker
    function updateTicker() {
      const currentInnings = gameState.currentInnings === 1 ? gameState.firstInnings : gameState.secondInnings;
      
      // Update partnership
      tickerPartnershipEl.textContent = currentInnings.partnership.runs;
      tickerPartnershipBallsEl.textContent = currentInnings.partnership.balls;
      
      // Update run rate
      const runRate = currentInnings.balls > 0 ? 
        (currentInnings.totalRuns / (currentInnings.balls / 6)).toFixed(2) : '0.00';
      tickerRunRateEl.textContent = runRate;
      
      // Update last 5 overs
      const last5Overs = getLastNOvers(5);
      tickerLast5El.textContent = `${last5Overs.runs}/${last5Overs.wickets}`;
      
      // Update required rate (for second innings)
      if (gameState.currentInnings === 2) {
        const remainingRuns = (gameState.firstInnings.totalRuns + 1) - currentInnings.totalRuns;
        const remainingBalls = (gameState.maxOvers * 6) - currentInnings.balls;
        const requiredRate = remainingBalls > 0 ? 
          (remainingRuns / (remainingBalls / 6)).toFixed(2) : '0.00';
        tickerRequiredRateEl.textContent = requiredRate;
      } else {
        tickerRequiredRateEl.textContent = '0.00';
      }
    }

    // Get stats for last N overs
    function getLastNOvers(n) {
      const currentInnings = gameState.currentInnings === 1 ? gameState.firstInnings : gameState.secondInnings;
      const overs = currentInnings.overs.slice(-n);
      
      let runs = 0;
      let wickets = 0;
      
      overs.forEach(over => {
        over.balls.forEach(ball => {
          if (ball.type === 'run') {
            runs += ball.runs;
          } else if (ball.type === 'wicket') {
            wickets += 1;
          } else if (ball.type === 'wide' || ball.type === 'noball') {
            runs += 1;
          }
        });
      });
      
      return { runs, wickets };
    }

    // Check if innings is complete
    function checkInningsComplete() {
      const currentInnings = gameState.currentInnings === 1 ? gameState.firstInnings : gameState.secondInnings;
      
      // Check if all wickets are gone or all overs are bowled
      if (currentInnings.totalWickets >= gameState.maxWickets || 
          currentInnings.balls >= gameState.maxOvers * 6) {
        
        // Show innings summary
        showInningsSummary();
        
        // If second innings is complete, end the match
        if (gameState.currentInnings === 2) {
          endMatch();
        }
      }
    }

    // Show innings summary
    function showInningsSummary() {
      const currentInnings = gameState.currentInnings === 1 ? gameState.firstInnings : gameState.secondInnings;
      
      // Set summary title
      summaryTitleEl.textContent = gameState.currentInnings === 1 ? 
        'First Innings Summary' : 'Second Innings Summary';
      
      // Set summary stats
      summaryTotalRunsEl.textContent = currentInnings.totalRuns;
      summaryWicketsEl.textContent = currentInnings.totalWickets;
      
      const overs = Math.floor(currentInnings.balls / 6);
      const balls = currentInnings.balls % 6;
      summaryOversEl.textContent = `${overs}.${balls}`;
      
      const runRate = currentInnings.balls > 0 ? 
        (currentInnings.totalRuns / (currentInnings.balls / 6)).toFixed(2) : '0.00';
      summaryRunRateEl.textContent = runRate;
      
      // Set highlight message
      if (gameState.currentInnings === 1) {
        summaryHighlightEl.textContent = `Target: ${currentInnings.totalRuns + 1} runs`;
        targetDisplayEl.style.display = 'flex';
        targetValueEl.textContent = currentInnings.totalRuns + 1;
      } else {
        // Determine match result
        if (currentInnings.totalRuns > gameState.firstInnings.totalRuns) {
          summaryHighlightEl.textContent = `${gameState.battingTeam} won by ${gameState.maxWickets - currentInnings.totalWickets} wickets`;
        } else if (currentInnings.totalRuns < gameState.firstInnings.totalRuns) {
          summaryHighlightEl.textContent = `${gameState.bowlingTeam} won by ${gameState.firstInnings.totalRuns - currentInnings.totalRuns} runs`;
        } else {
          summaryHighlightEl.textContent = 'Match tied!';
        }
        
        // Show player of the match
        pomDisplayEl.style.display = 'flex';
        pomValueEl.textContent = gameState.playerOfTheMatch || '-';
        
        // Show awards
        awardsContainerEl.style.display = 'flex';
        awardsContainerEl.innerHTML = '';
        
        // Top scorer
        const topScorer = getTopScorer();
        if (topScorer) {
          const awardEl = document.createElement('div');
          awardEl.className = 'award-badge';
          awardEl.textContent = `Top Scorer: ${topScorer.name} (${topScorer.runs})`;
          awardsContainerEl.appendChild(awardEl);
        }
        
        // Best bowler
        const bestBowler = getBestBowler();
        if (bestBowler) {
          const awardEl = document.createElement('div');
          awardEl.className = 'award-badge';
          awardEl.textContent = `Best Bowler: ${bestBowler.name} (${bestBowler.wickets}/${bestBowler.runs})`;
          awardsContainerEl.appendChild(awardEl);
        }
      }
      
      // Populate batting stats
      battersStatsBodyEl.innerHTML = '';
      const batters = Object.entries(currentInnings.batterStats)
        .map(([name, stats]) => ({ name, ...stats }))
        .sort((a, b) => b.runs - a.runs);
      
      batters.forEach(batter => {
        const row = document.createElement('tr');
        const strikeRate = batter.balls > 0 ? ((batter.runs / batter.balls) * 100).toFixed(2) : '0.00';
        
        row.innerHTML = `
          <td>${batter.name}</td>
          <td>${batter.runs}</td>
          <td>${batter.balls}</td>
          <td>${strikeRate}</td>
          <td>${batter.fours}/${batter.sixes}</td>
        `;
        battersStatsBodyEl.appendChild(row);
      });
      
      // Populate bowling stats
      bowlersStatsBodyEl.innerHTML = '';
      const bowlers = Object.entries(currentInnings.bowlerStats)
        .map(([name, stats]) => ({ name, ...stats }))
        .sort((a, b) => b.wickets - a.wickets || a.runs - b.runs);
      
      bowlers.forEach(bowler => {
        const row = document.createElement('tr');
        const economyRate = bowler.balls > 0 ? (bowler.runs / (bowler.balls / 6)).toFixed(2) : '0.00';
        
        row.innerHTML = `
          <td>${bowler.name}</td>
          <td>${(bowler.balls / 6).toFixed(1)}</td>
          <td>${bowler.wickets}</td>
          <td>${bowler.runs}</td>
          <td>${economyRate}</td>
        `;
        bowlersStatsBodyEl.appendChild(row);
      });
      
      // Show summary popup
      summaryPopupEl.style.display = 'block';
      
      // Update button text based on innings
      if (gameState.currentInnings === 1) {
        startSecondInningsBtnEl.textContent = '🏏 Start Second Innings';
        startSecondInningsBtnEl.style.display = 'block';
      } else {
        startSecondInningsBtnEl.textContent = '🏆 View Match Summary';
        startSecondInningsBtnEl.style.display = 'block';
      }
    }

    // Get top scorer
    function getTopScorer() {
      let topScorer = null;
      
      // Check both innings
      [gameState.firstInnings, gameState.secondInnings].forEach(innings => {
        Object.entries(innings.batterStats).forEach(([name, stats]) => {
          if (!topScorer || stats.runs > topScorer.runs) {
            topScorer = { name, ...stats };
          }
        });
      });
      
      return topScorer;
    }

    // Get best bowler
    function getBestBowler() {
      let bestBowler = null;
      
      // Check both innings
      [gameState.firstInnings, gameState.secondInnings].forEach(innings => {
        Object.entries(innings.bowlerStats).forEach(([name, stats]) => {
          if (!bestBowler || 
              stats.wickets > bestBowler.wickets || 
              (stats.wickets === bestBowler.wickets && stats.runs < bestBowler.runs)) {
            bestBowler = { name, ...stats };
          }
        });
      });
      
      return bestBowler;
    }

    // End match and save results
    async function endMatch() {
      // Determine winner
      if (gameState.secondInnings.totalRuns > gameState.firstInnings.totalRuns) {
        gameState.winner = gameState.battingFirst === 'player1' ? 'player2' : 'player1';
        gameState.winningMargin = `${gameState.maxWickets - gameState.secondInnings.totalWickets} wickets`;
      } else if (gameState.secondInnings.totalRuns < gameState.firstInnings.totalRuns) {
        gameState.winner = gameState.battingFirst;
        gameState.winningMargin = `${gameState.firstInnings.totalRuns - gameState.secondInnings.totalRuns} runs`;
      } else {
        gameState.winner = 'tie';
        gameState.winningMargin = 'Match tied';
      }
      
      // Determine player of the match
      gameState.playerOfTheMatch = determinePlayerOfTheMatch();
      
      // Save match to Firebase
      const matchId = `${roomId}_${new Date().getTime()}`;
      await set(child(savedMatchesRef, matchId), gameState);
      
      // Update game state
      gameState.isMatchOver = true;
      await update(gameRef, {
        isMatchOver: true,
        winner: gameState.winner,
        winningMargin: gameState.winningMargin,
        playerOfTheMatch: gameState.playerOfTheMatch
      });
    }

    // Determine player of the match
    function determinePlayerOfTheMatch() {
      // Get top performers from both innings
      const topScorer = getTopScorer();
      const bestBowler = getBestBowler();
      
      // Simple logic: choose the player with the most impactful performance
      if (topScorer && bestBowler) {
        // If someone scored a century or took 5 wickets, they get it
        if (topScorer.runs >= 100) return topScorer.name;
        if (bestBowler.wickets >= 5) return bestBowler.name;
        
        // Otherwise, choose the one with the better relative performance
        const batterImpact = topScorer.runs / gameState.firstInnings.totalRuns;
        const bowlerImpact = bestBowler.wickets / gameState.maxWickets;
        
        return batterImpact > bowlerImpact ? topScorer.name : bestBowler.name;
      } else if (topScorer) {
        return topScorer.name;
      } else if (bestBowler) {
        return bestBowler.name;
      }
      
      return null;
    }

    // Event listeners
    document.querySelectorAll('.card-btns button').forEach(button => {
      button.addEventListener('click', () => {
        if (isSpectator) return;
        
        const value = parseInt(button.dataset.value);
        playerState.selectedCard = value;
        playerState.isReady = true;
        
        // Highlight selected button
        document.querySelectorAll('.card-btns button').forEach(btn => {
          btn.classList.remove('selected');
        });
        button.classList.add('selected');
        
        resultEl.textContent = `Selected: ${value}`;
        
        // Send selection to Firebase
        updatePlayerSelection();
      });
    });

    // Update player selection in Firebase
    async function updatePlayerSelection() {
      if (isSpectator) return;
      
      try {
        await update(playerRef, {
          selectedCard: playerState.selectedCard,
          isReady: playerState.isReady
        });
      } catch (error) {
        console.error('Error updating player selection:', error);
        resultEl.textContent = 'Error submitting selection';
        resultEl.classList.add('error');
      }
    }

    // Show teams modal
    showTeamsBtnEl.addEventListener('click', () => {
      modalTeam1NameEl.textContent = gameState.team1Name;
      modalTeam2NameEl.textContent = gameState.team2Name;
      
      // Populate team 1 players
      modalTeam1PlayersEl.innerHTML = '';
      gameState.team1Players.forEach(player => {
        const li = document.createElement('li');
        li.textContent = player;
        modalTeam1PlayersEl.appendChild(li);
      });
      
      // Populate team 2 players
      modalTeam2PlayersEl.innerHTML = '';
      gameState.team2Players.forEach(player => {
        const li = document.createElement('li');
        li.textContent = player;
        modalTeam2PlayersEl.appendChild(li);
      });
      
      // Show modal
      teamsModalEl.style.display = 'flex';
      uiState.currentTeamSlide = 0;
      updateTeamNav();
    });

    // Close teams modal
    closeTeamsBtnEl.addEventListener('click', () => {
      teamsModalEl.style.display = 'none';
    });

    // Team navigation
    prevTeamBtnEl.addEventListener('click', () => {
      if (uiState.currentTeamSlide > 0) {
        uiState.currentTeamSlide--;
        updateTeamNav();
      }
    });

    nextTeamBtnEl.addEventListener('click', () => {
      if (uiState.currentTeamSlide < 1) {
        uiState.currentTeamSlide++;
        updateTeamNav();
      }
    });

    // Update team navigation
    function updateTeamNav() {
      // Update slider position
      document.getElementById('teamsSlider').scrollTo({
        left: uiState.currentTeamSlide * document.getElementById('teamsSlider').offsetWidth,
        behavior: 'smooth'
      });
      
      // Update button states
      prevTeamBtnEl.disabled = uiState.currentTeamSlide === 0;
      nextTeamBtnEl.disabled = uiState.currentTeamSlide === 1;
      
      // Update dot indicators
      document.querySelectorAll('.team-nav-dot').forEach((dot, index) => {
        dot.classList.toggle('active', index === uiState.currentTeamSlide);
      });
    }

    // Stats navigation
    prevStatsBtnEl.addEventListener('click', () => {
      if (uiState.currentStatsSlide > 0) {
        uiState.currentStatsSlide--;
        updateStatsNav();
      }
    });

    nextStatsBtnEl.addEventListener('click', () => {
      if (uiState.currentStatsSlide < 1) {
        uiState.currentStatsSlide++;
        updateStatsNav();
      }
    });

    // Update stats navigation
    function updateStatsNav() {
      // Update slider position
      document.getElementById('statsSlider').scrollTo({
        left: uiState.currentStatsSlide * document.getElementById('statsSlider').offsetWidth,
        behavior: 'smooth'
      });
      
      // Update button states
      prevStatsBtnEl.disabled = uiState.currentStatsSlide === 0;
      nextStatsBtnEl.disabled = uiState.currentStatsSlide === 1;
      
      // Update dot indicators
      document.querySelectorAll('.team-nav-indicator .team-nav-dot').forEach((dot, index) => {
        dot.classList.toggle('active', index === uiState.currentStatsSlide);
      });
    }

    // Start second innings
    startSecondInningsBtnEl.addEventListener('click', async () => {
      if (gameState.currentInnings === 1) {
        // Start second innings
        gameState.currentInnings = 2;
        gameState.battingTeam = gameState.battingFirst === 'player1' ? gameState.team2Name : gameState.team1Name;
        gameState.bowlingTeam = gameState.battingFirst === 'player1' ? gameState.team1Name : gameState.team2Name;
        
        // Update player roles
        if (!isSpectator) {
          playerState.role = gameState.battingFirst === player ? 'bowling' : 'batting';
          await update(playerRef, { role: playerState.role });
        }
        
        // Update game state in Firebase
        await update(gameRef, {
          currentInnings: 2,
          secondInnings: {
            totalRuns: 0,
            totalWickets: 0,
            balls: 0,
            batterStats: {},
            bowlerStats: {},
            currentBatter: null,
            currentBowler: null,
            batters: [],
            bowlers: [],
            overs: [],
            extras: {
              wides: 0,
              noballs: 0,
              byes: 0,
              legbyes: 0
            },
            partnership: {
              runs: 0,
              balls: 0,
              batters: []
            }
          },
          currentOver: 0,
          currentBall: 0,
          isPowerplay: false,
          isDeadOver: false,
          isFreeHit: false
        });
        
        // Close summary popup
        summaryPopupEl.style.display = 'none';
        
        // Show batter selection modal if batting
        if (!isSpectator && playerState.role === 'batting') {
          showBatterSelectionModal();
        }
      } else {
        // Go to match summary
        const matchId = `${roomId}_${new Date(gameState.currentDateTime).getTime()}`;
        window.location.href = `match_summary.html?id=${matchId}`;
      }
    });

    // Show batter selection modal
    function showBatterSelectionModal() {
      const currentInnings = gameState.currentInnings === 1 ? gameState.firstInnings : gameState.secondInnings;
      const availablePlayers = gameState.battingTeam === gameState.team1Name ? 
        gameState.team1Players.filter(p => !currentInnings.batters.includes(p)) :
        gameState.team2Players.filter(p => !currentInnings.batters.includes(p));
      
      selectionTitleEl.textContent = 'Select Next Batter';
      selectionListEl.innerHTML = '';
      
      availablePlayers.forEach(player => {
        const li = document.createElement('li');
        li.className = 'batter-item';
        li.textContent = player;
        li.addEventListener('click', () => {
          document.querySelectorAll('.batter-item').forEach(item => {
            item.classList.remove('selected');
          });
          li.classList.add('selected');
          uiState.selectedPlayer = player;
        });
        selectionListEl.appendChild(li);
      });
      
      selectionModalEl.style.display = 'block';
    }

    // Confirm batter selection
    confirmSelectionEl.addEventListener('click', async () => {
      if (!uiState.selectedPlayer) {
        resultEl.textContent = 'Please select a batter';
        resultEl.classList.add('error');
        return;
      }
      
      const currentInnings = gameState.currentInnings === 1 ? 'firstInnings' : 'secondInnings';
      
      try {
        // Update game state in Firebase
        await update(gameRef, {
          [`${currentInnings}.currentBatter`]: uiState.selectedPlayer,
          [`${currentInnings}.batters`]: [...gameState[currentInnings].batters, uiState.selectedPlayer],
          [`${currentInnings}.batterStats`]: {
            ...gameState[currentInnings].batterStats,
            [uiState.selectedPlayer]: {
              runs: 0,
              balls: 0,
              fours: 0,
              sixes: 0
            }
          },
          [`${currentInnings}.partnership.batters`]: [
            uiState.selectedPlayer,
            gameState[currentInnings].currentBatter || uiState.selectedPlayer
          ]
        });
        
        // Close modal
        selectionModalEl.style.display = 'none';
        resultEl.textContent = 'Batter selected';
        resultEl.classList.remove('error');
      } catch (error) {
        console.error('Error selecting batter:', error);
        resultEl.textContent = 'Error selecting batter';
        resultEl.classList.add('error');
      }
    });

    // Save and exit
    saveBtnEl.addEventListener('click', async () => {
      if (isSpectator) return;
      
      try {
        // Save current game state
        const matchId = `${roomId}_${new Date(gameState.currentDateTime).getTime()}`;
        await set(child(savedMatchesRef, matchId), gameState);
        
        // Redirect to home
        window.location.href = 'index.html';
      } catch (error) {
        console.error('Error saving match:', error);
        resultEl.textContent = 'Error saving match';
        resultEl.classList.add('error');
      }
    });

    // Exit without saving
    exitBtnEl.addEventListener('click', () => {
      if (confirm('Are you sure you want to exit without saving?')) {
        window.location.href = 'index.html';
      }
    });

    // Reset plays
    resetPlaysBtnEl.addEventListener('click', () => {
      if (isSpectator) return;
      
      if (confirm('Reset last play? This can only be done 3 times per match.')) {
        // Implement reset logic here
        resultEl.textContent = 'Last play reset';
      }
    });

    // Initialize the game when page loads
    window.addEventListener('DOMContentLoaded', initializeGame);
  </script>
</body>
</html>