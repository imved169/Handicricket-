<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Match Summary - HandiCricket</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      background: #061e3e;
      color: white;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      margin: 0;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: rgba(0, 0, 0, 0.4);
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      border: 1px solid rgba(255,255,255,0.1);
    }

    h1 {
      color: #ffeb3b;
      text-align: center;
      margin-bottom: 20px;
      text-shadow: 0 0 5px rgba(255, 235, 59, 0.5);
    }

    .match-header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 15px;
      border-bottom: 2px solid rgba(255,255,255,0.1);
    }

    .match-result {
      font-size: 24px;
      font-weight: bold;
      color: #ffeb3b;
      margin-bottom: 10px;
    }

    .match-teams {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .team-box {
      background: rgba(30, 136, 229, 0.2);
      padding: 15px;
      border-radius: 8px;
      min-width: 200px;
      text-align: center;
      border-left: 3px solid #1e88e5;
    }

    .team-name {
      font-weight: bold;
      margin-bottom: 5px;
    }

    .team-score {
      font-size: 18px;
    }

    .summary-section {
      margin-bottom: 30px;
      background: rgba(13, 42, 82, 0.7);
      padding: 15px;
      border-radius: 8px;
    }

    .summary-section h2 {
      color: #ffeb3b;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding-bottom: 5px;
      margin-bottom: 15px;
    }

    .innings-summary {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .innings-box {
      flex: 1;
      min-width: 250px;
      background: rgba(30, 136, 229, 0.1);
      padding: 15px;
      border-radius: 8px;
      border-left: 3px solid #4CAF50;
    }

    .innings-box.bowling {
      border-left-color: #F44336;
    }

    .innings-title {
      font-weight: bold;
      margin-bottom: 10px;
      color: #ffeb3b;
    }

    .innings-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .stat-item {
      display: flex;
      justify-content: space-between;
    }

    .stat-label {
      color: #aaa;
    }

    .stat-value {
      font-weight: bold;
    }

    .player-stats {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }

    .player-stats-section {
      flex: 1;
      min-width: 300px;
      overflow-x: auto;
    }

    .player-stats-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 14px;
    }

    .player-stats-table th {
      background: rgba(30, 136, 229, 0.5);
      padding: 8px;
      text-align: left;
      white-space: nowrap;
    }

    .player-stats-table td {
      padding: 8px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      white-space: nowrap;
    }

    .player-stats-table tr:nth-child(even) {
      background: rgba(30, 136, 229, 0.1);
    }

    .awards-section {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-top: 20px;
    }

    .award-card {
      background: rgba(255, 215, 0, 0.1);
      border: 1px solid gold;
      padding: 15px;
      border-radius: 8px;
      min-width: 200px;
    }

    .award-title {
      font-weight: bold;
      color: gold;
      margin-bottom: 5px;
    }

    .award-winner {
      font-size: 18px;
    }

    .back-button {
      display: block;
      width: 100%;
      padding: 12px;
      background: #1e88e5;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 20px;
      text-align: center;
      transition: all 0.3s;
    }

    .back-button:hover {
      background: #1565c0;
      transform: translateY(-2px);
    }

    .highlight {
      background: rgba(255, 235, 59, 0.2);
      padding: 3px 6px;
      border-radius: 4px;
    }

    @media (max-width: 768px) {
      .innings-summary, .player-stats {
        flex-direction: column;
      }
      
      .team-box, .innings-box {
        min-width: 100%;
      }
      
      .player-stats-table {
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="match-header">
      <h1>Match Summary</h1>
      <div class="match-result" id="matchResult">Match Result</div>
      <div class="match-teams">
        <div class="team-box" id="team1Box">
          <div class="team-name" id="team1Name">Team 1</div>
          <div class="team-score" id="team1Score">0/0 (0.0)</div>
        </div>
        <div class="team-box" id="team2Box">
          <div class="team-name" id="team2Name">Team 2</div>
          <div class="team-score" id="team2Score">0/0 (0.0)</div>
        </div>
      </div>
    </div>

    <div class="summary-section">
      <h2>Match Summary</h2>
      <div class="innings-summary">
        <div class="innings-box">
          <div class="innings-title">First Innings</div>
          <div class="innings-stats" id="firstInningsStats">
            <!-- Filled by JavaScript -->
          </div>
        </div>
        <div class="innings-box">
          <div class="innings-title">Second Innings</div>
          <div class="innings-stats" id="secondInningsStats">
            <!-- Filled by JavaScript -->
          </div>
        </div>
      </div>
    </div>

    <div class="summary-section">
      <h2>Player Awards</h2>
      <div class="awards-section" id="awardsContainer">
        <!-- Filled by JavaScript -->
      </div>
    </div>

    <div class="summary-section">
      <h2>Batting Performances</h2>
      <div class="player-stats">
        <div class="player-stats-section">
          <h3 id="team1BattingTitle">Team 1 Batting</h3>
          <table class="player-stats-table" id="team1BattingTable">
            <thead>
              <tr>
                <th>Player</th>
                <th>Runs</th>
                <th>Balls</th>
                <th>SR</th>
              </tr>
            </thead>
            <tbody>
              <!-- Filled by JavaScript -->
            </tbody>
          </table>
        </div>
        <div class="player-stats-section">
          <h3 id="team2BattingTitle">Team 2 Batting</h3>
          <table class="player-stats-table" id="team2BattingTable">
            <thead>
              <tr>
                <th>Player</th>
                <th>Runs</th>
                <th>Balls</th>
                <th>SR</th>
              </tr>
            </thead>
            <tbody>
              <!-- Filled by JavaScript -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="summary-section">
      <h2>Bowling Performances</h2>
      <div class="player-stats">
        <div class="player-stats-section">
          <h3 id="team1BowlingTitle">Team 1 Bowling</h3>
          <table class="player-stats-table" id="team1BowlingTable">
            <thead>
              <tr>
                <th>Player</th>
                <th>Overs</th>
                <th>Wkts</th>
                <th>ER</th>
              </tr>
            </thead>
            <tbody>
              <!-- Filled by JavaScript -->
            </tbody>
          </table>
        </div>
        <div class="player-stats-section">
          <h3 id="team2BowlingTitle">Team 2 Bowling</h3>
          <table class="player-stats-table" id="team2BowlingTable">
            <thead>
              <tr>
                <th>Player</th>
                <th>Overs</th>
                <th>Wkts</th>
                <th>ER</th>
              </tr>
            </thead>
            <tbody>
              <!-- Filled by JavaScript -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <button class="back-button" id="backButton">Back to Home</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCN6aZMwlsZe7JJaovU0WA3UQygWr4jYmA",
      authDomain: "handicricket-85a06.firebaseapp.com",
      projectId: "handicricket-85a06",
      storageBucket: "handicricket-85a06.appspot.com",
      messagingSenderId: "599182538558",
      appId: "1:599182538558:web:3e965753ab05f8f1e3de6f",
      measurementId: "G-HSV9H4LEJQ"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Get match ID from URL
    const params = new URLSearchParams(window.location.search);
    const matchId = params.get('id');

    // DOM elements
    const matchResultEl = document.getElementById('matchResult');
    const team1NameEl = document.getElementById('team1Name');
    const team2NameEl = document.getElementById('team2Name');
    const team1ScoreEl = document.getElementById('team1Score');
    const team2ScoreEl = document.getElementById('team2Score');
    const firstInningsStatsEl = document.getElementById('firstInningsStats');
    const secondInningsStatsEl = document.getElementById('secondInningsStats');
    const awardsContainerEl = document.getElementById('awardsContainer');
    const backButton = document.getElementById('backButton');
    
    // Team batting tables
    const team1BattingTitle = document.getElementById('team1BattingTitle');
    const team2BattingTitle = document.getElementById('team2BattingTitle');
    const team1BattingTable = document.getElementById('team1BattingTable').querySelector('tbody');
    const team2BattingTable = document.getElementById('team2BattingTable').querySelector('tbody');
    
    // Team bowling tables
    const team1BowlingTitle = document.getElementById('team1BowlingTitle');
    const team2BowlingTitle = document.getElementById('team2BowlingTitle');
    const team1BowlingTable = document.getElementById('team1BowlingTable').querySelector('tbody');
    const team2BowlingTable = document.getElementById('team2BowlingTable').querySelector('tbody');

    // Load match data
    async function loadMatchData() {
      if (!matchId) {
        console.error("No match ID provided");
        return;
      }

      try {
        const snapshot = await get(ref(db, `savedMatches/${matchId}`));
        if (snapshot.exists()) {
          const matchData = snapshot.val();
          displayMatchData(matchData);
        } else {
          console.error("No match data found");
          matchResultEl.textContent = "Match data not found";
        }
      } catch (error) {
        console.error("Error loading match data:", error);
        matchResultEl.textContent = "Error loading match data";
      }
    }

    // Display match data
    function displayMatchData(matchData) {
      // Set team names and scores
      team1NameEl.textContent = matchData.team1Name || "Team 1";
      team2NameEl.textContent = matchData.team2Name || "Team 2";
      
      // Update batting titles with team names
      team1BattingTitle.textContent = `${matchData.team1Name || "Team 1"} Batting`;
      team2BattingTitle.textContent = `${matchData.team2Name || "Team 2"} Batting`;
      team1BowlingTitle.textContent = `${matchData.team1Name || "Team 1"} Bowling`;
      team2BowlingTitle.textContent = `${matchData.team2Name || "Team 2"} Bowling`;

      // Display match result
      if (matchData.winner) {
        const winnerName = matchData.winner === "player1" ? matchData.team1Name : matchData.team2Name;
        matchResultEl.textContent = `${winnerName} won by ${matchData.winningMargin}`;
      } else {
        matchResultEl.textContent = "Match completed";
      }

      // First innings stats
      if (matchData.firstInnings) {
        team1ScoreEl.textContent = `${matchData.firstInnings.totalRuns}/${matchData.firstInnings.totalWickets} (${formatOvers(matchData.firstInnings.balls)})`;
        
        firstInningsStatsEl.innerHTML = `
          <div class="stat-item">
            <span class="stat-label">Runs:</span>
            <span class="stat-value">${matchData.firstInnings.totalRuns}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Wickets:</span>
            <span class="stat-value">${matchData.firstInnings.totalWickets}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Overs:</span>
            <span class="stat-value">${formatOvers(matchData.firstInnings.balls)}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Run Rate:</span>
            <span class="stat-value">${calculateRunRate(matchData.firstInnings.totalRuns, matchData.firstInnings.balls)}</span>
          </div>
        `;
      }

      // Second innings stats
      if (matchData.secondInnings) {
        team2ScoreEl.textContent = `${matchData.secondInnings.totalRuns}/${matchData.secondInnings.totalWickets} (${formatOvers(matchData.secondInnings.balls)})`;
        
        secondInningsStatsEl.innerHTML = `
          <div class="stat-item">
            <span class="stat-label">Runs:</span>
            <span class="stat-value">${matchData.secondInnings.totalRuns}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Wickets:</span>
            <span class="stat-value">${matchData.secondInnings.totalWickets}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Overs:</span>
            <span class="stat-value">${formatOvers(matchData.secondInnings.balls)}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Run Rate:</span>
            <span class="stat-value">${calculateRunRate(matchData.secondInnings.totalRuns, matchData.secondInnings.balls)}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Target:</span>
            <span class="stat-value">${matchData.firstInnings.totalRuns + 1}</span>
          </div>
        `;
      }

      // Player of the match
      if (matchData.playerOfTheMatch) {
        awardsContainerEl.innerHTML = `
          <div class="award-card">
            <div class="award-title">Player of the Match</div>
            <div class="award-winner">${matchData.playerOfTheMatch}</div>
          </div>
        `;
      }

      // Batting performances
      if (matchData.firstInnings?.batterStats) {
        populateBattingTable(matchData.firstInnings.batterStats, team1BattingTable);
      }
      if (matchData.secondInnings?.batterStats) {
        populateBattingTable(matchData.secondInnings.batterStats, team2BattingTable);
      }

      // Bowling performances
      if (matchData.firstInnings?.bowlerStats) {
        populateBowlingTable(matchData.firstInnings.bowlerStats, team1BowlingTable);
      }
      if (matchData.secondInnings?.bowlerStats) {
        populateBowlingTable(matchData.secondInnings.bowlerStats, team2BowlingTable);
      }
    }

    // Format overs (balls to overs.balls)
    function formatOvers(balls) {
      return `${Math.floor(balls / 6)}.${balls % 6}`;
    }

    // Calculate run rate
    function calculateRunRate(runs, balls) {
      const overs = balls / 6;
      return overs > 0 ? (runs / overs).toFixed(2) : "0.00";
    }

    // Populate batting table
    function populateBattingTable(stats, tableEl) {
      tableEl.innerHTML = '';
      
      // Convert stats object to array and sort by runs descending
      const players = Object.entries(stats)
        .map(([name, stats]) => ({ name, ...stats }))
        .sort((a, b) => b.runs - a.runs);
      
      players.forEach(player => {
        const row = document.createElement('tr');
        const strikeRate = player.balls > 0 ? ((player.runs / player.balls) * 100).toFixed(2) : "0.00";
        
        row.innerHTML = `
          <td>${player.name}</td>
          <td>${player.runs}</td>
          <td>${player.balls}</td>
          <td>${strikeRate}</td>
        `;
        
        tableEl.appendChild(row);
      });
    }

    // Populate bowling table
    function populateBowlingTable(stats, tableEl) {
      tableEl.innerHTML = '';
      
      // Convert stats object to array and sort by wickets descending
      const players = Object.entries(stats)
        .map(([name, stats]) => ({ name, ...stats }))
        .sort((a, b) => b.wickets - a.wickets);
      
      players.forEach(player => {
        const row = document.createElement('tr');
        const economyRate = player.overs > 0 ? (player.runs / player.overs).toFixed(2) : "0.00";
        
        row.innerHTML = `
          <td>${player.name}</td>
          <td>${player.overs.toFixed(1)}</td>
          <td>${player.wickets}</td>
          <td>${economyRate}</td>
        `;
        
        tableEl.appendChild(row);
      });
    }

    // Back button handler
    backButton.addEventListener('click', () => {
      window.location.href = 'index.html';
    });

    // Initialize the page
    loadMatchData();
  </script>
</body>
</html>