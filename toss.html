<!DOCTYPE html>
<html>
<head>
  <title>Toss</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, set, get, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD2diKlvhJmrxH_2UoT5F06fE4hQz_wfgY",
      authDomain: "handicricket-a8ac4.firebaseapp.com",
      databaseURL: "https://handicricket-a8ac4-default-rtdb.firebaseio.com",
      projectId: "handicricket-a8ac4",
      storageBucket: "handicricket-a8ac4.appspot.com",
      messagingSenderId: "193512430134",
      appId: "1:193512430134:web:e6e9fc2e4cc2502f95b1f0"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const roomId = localStorage.getItem("roomId");
    const myTeam = localStorage.getItem("myTeam");

    const tossCallRef = ref(db, `rooms/${roomId}/tossCall`);
    const tossResultRef = ref(db, `rooms/${roomId}/tossResult`);
    const tossWinnerRef = ref(db, `rooms/${roomId}/tossWinner`);
    const tossChoiceRef = ref(db, `rooms/${roomId}/tossChoice`);

    // Step 1: Call toss
    window.callToss = function (call) {
      set(tossCallRef, {
        team: myTeam,
        call: call
      });

      const result = Math.random() < 0.5 ? "Heads" : "Tails";
      set(tossResultRef, result);

      // Get actual winner
      if (call === result) {
        set(tossWinnerRef, myTeam);
      } else {
        const otherTeam = myTeam === "TeamA" ? "TeamB" : "TeamA";
        set(tossWinnerRef, otherTeam);
      }
    };

    // Step 2: Select batting or bowling if toss is won
    window.chooseBatBowl = function (choice) {
      set(tossChoiceRef, choice);
    };

    // Redirect once everything is ready
    onValue(tossResultRef, (snapshot) => {
      const result = snapshot.val();
      if (result) {
        document.getElementById("tossResult").textContent = `Toss result: ${result}`;
      }
    });

    onValue(tossWinnerRef, (snapshot) => {
      const winner = snapshot.val();
      if (winner === myTeam) {
        document.getElementById("batbowlChoice").style.display = "block";
      }
    });

    onValue(tossChoiceRef, (snapshot) => {
      const choice = snapshot.val();
      if (choice) {
        window.location.href = "game_first_innings.html";
      }
    });
  </script>
</head>
<body>
  <h1>Toss</h1>

  <div>
    <p>Call the toss:</p>
    <button onclick="callToss('Heads')">Heads</button>
    <button onclick="callToss('Tails')">Tails</button>
  </div>

  <h2 id="tossResult"></h2>

  <div id="batbowlChoice" style="display: none;">
    <p>You won the toss! Choose to:</p>
    <button onclick="chooseBatBowl('bat')">Bat First</button>
    <button onclick="chooseBatBowl('bowl')">Bowl First</button>
  </div>
</body>
</html>
