<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HandiCricket - Match</title>
  <style>
    :root {
      --primary: #1e88e5;
      --primary-dark: #1565c0;
      --secondary: #4CAF50;
      --secondary-dark: #2E7D32;
      --danger: #f44336;
      --danger-dark: #d32f2f;
      --warning: #FF9800;
      --warning-dark: #F57C00;
      --info: #2196F3;
      --dark: #061e3e;
      --darker: #0a2a4a;
      --light: #ffffff;
      --lighter: #f5f5f5;
      --gray: #cccccc;
      --dark-gray: #666666;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: linear-gradient(135deg, var(--dark), var(--darker));
      color: var(--light);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .container {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      margin-bottom: 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .match-info {
      text-align: center;
    }

    .match-title {
      color: #ffeb3b;
      font-size: 1.5rem;
      margin-bottom: 5px;
      text-shadow: 0 0 5px rgba(255, 235, 59, 0.5);
    }

    .match-format {
      color: var(--gray);
      font-size: 0.9rem;
    }

    .scoreboard {
      display: flex;
      justify-content: space-between;
      background: rgba(0, 0, 0, 0.4);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .team-score {
      flex: 1;
      padding: 10px;
      text-align: center;
    }

    .team-name {
      font-weight: bold;
      font-size: 1.2rem;
      margin-bottom: 5px;
    }

    .team-runs {
      font-size: 1.5rem;
      font-weight: bold;
    }

    .team-wickets {
      color: var(--gray);
      font-size: 0.9rem;
    }

    .team-overs {
      color: var(--gray);
      font-size: 0.9rem;
    }

    .vs {
      display: flex;
      align-items: center;
      padding: 0 15px;
      font-weight: bold;
      color: #ffeb3b;
    }

    .match-status {
      text-align: center;
      padding: 10px;
      background: rgba(255, 235, 59, 0.1);
      border-radius: 5px;
      margin-bottom: 20px;
      border-left: 3px solid #ffeb3b;
    }

    .innings-info {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .innings-box {
      flex: 1;
      padding: 10px;
      background: rgba(13, 42, 82, 0.5);
      border-radius: 8px;
      margin: 0 5px;
      text-align: center;
    }

    .innings-box h3 {
      color: #ffeb3b;
      margin-bottom: 5px;
    }

    .current-over {
      background: rgba(30, 136, 229, 0.2);
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 20px;
    }

    .over-title {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .over-progress {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
    }

    .ball {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      background: rgba(255, 255, 255, 0.1);
    }

    .ball.dot {
      background: var(--dark-gray);
    }

    .ball.run {
      background: var(--secondary);
    }

    .ball.wicket {
      background: var(--danger);
    }

    .ball.noball {
      background: var(--warning);
    }

    .ball.wide {
      background: var(--info);
    }

    .game-area {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .player-selection {
      display: none;
      background: rgba(0, 0, 0, 0.4);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .player-selection.active {
      display: block;
    }

    .selection-title {
      color: #ffeb3b;
      margin-bottom: 10px;
    }

    .player-options {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
    }

    .player-btn {
      padding: 8px 12px;
      border: none;
      border-radius: 5px;
      background: rgba(30, 136, 229, 0.3);
      color: white;
      cursor: pointer;
    }

    .player-btn.selected {
      background: var(--primary);
    }

    .player-btn.captain {
      border-left: 3px solid gold;
    }

    .player-btn.vice-captain {
      border-left: 3px solid silver;
    }

    .confirm-btn {
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      background: var(--secondary);
      color: white;
      cursor: pointer;
    }

    .cards-container {
      display: flex;
      justify-content: center;
      gap: 15px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    .card {
      width: 60px;
      height: 90px;
      background: white;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: bold;
      color: var(--dark);
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 3px 6px rgba(0,0,0,0.3);
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 10px rgba(0,0,0,0.4);
    }

    .card.selected {
      transform: translateY(-5px);
      box-shadow: 0 0 10px 3px rgba(255, 235, 59, 0.7);
    }

    .card.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .action-buttons {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 20px;
    }

    .action-btn {
      padding: 12px 25px;
      border: none;
      border-radius: 8px;
      background: var(--primary);
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }

    .action-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
    }

    .action-btn:disabled {
      background: var(--dark-gray);
      cursor: not-allowed;
      transform: none;
    }

    .action-btn.secondary {
      background: var(--secondary);
    }

    .action-btn.secondary:hover {
      background: var(--secondary-dark);
    }

    .action-btn.danger {
      background: var(--danger);
    }

    .action-btn.danger:hover {
      background: var(--danger-dark);
    }

    .players-panel {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }

    .batters-panel, .bowlers-panel {
      flex: 1;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      padding: 15px;
    }

    .panel-title {
      color: #ffeb3b;
      margin-bottom: 10px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding-bottom: 5px;
    }

    .player-list {
      list-style: none;
    }

    .player-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .player-name {
      font-weight: bold;
    }

    .player-stats {
      color: var(--gray);
      font-size: 0.9rem;
    }

    .player-item.active {
      background: rgba(30, 136, 229, 0.2);
    }

    .player-item.out {
      opacity: 0.6;
      text-decoration: line-through;
    }

    .wicket-bar {
      height: 5px;
      background: rgba(255,255,255,0.1);
      margin-top: 3px;
      border-radius: 3px;
      overflow: hidden;
    }

    .wicket-progress {
      height: 100%;
      background: var(--danger);
      width: 0%;
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }

    .modal.active {
      opacity: 1;
      pointer-events: all;
    }

    .modal-content {
      background: linear-gradient(145deg, var(--dark), var(--darker));
      border-radius: 10px;
      padding: 20px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      border: 1px solid rgba(255,255,255,0.1);
    }

    .modal-title {
      color: #ffeb3b;
      margin-bottom: 15px;
      text-align: center;
    }

    .modal-body {
      margin-bottom: 20px;
    }

    .modal-actions {
      display: flex;
      justify-content: center;
      gap: 10px;
    }

    .modal-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      background: var(--primary);
      color: white;
      cursor: pointer;
    }

    .modal-btn.secondary {
      background: var(--dark-gray);
    }

    .teams-modal {
      text-align: center;
    }

    .teams-container {
      display: flex;
      justify-content: space-between;
      margin: 20px 0;
    }

    .team-modal {
      flex: 1;
      margin: 0 10px;
    }

    .team-modal h3 {
      color: #ffeb3b;
      margin-bottom: 10px;
    }

    .team-players {
      list-style: none;
    }

    .team-player {
      padding: 5px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .team-player.captain::after {
      content: " (C)";
      color: gold;
    }

    .team-player.vice-captain::after {
      content: " (VC)";
      color: silver;
    }

    .result-modal {
      text-align: center;
    }

    .result-title {
      color: #ffeb3b;
      font-size: 1.5rem;
      margin-bottom: 15px;
    }

    .result-details {
      margin-bottom: 20px;
    }

    .result-stats {
      display: flex;
      justify-content: space-between;
      margin: 15px 0;
    }

    .result-stat {
      flex: 1;
      padding: 10px;
    }

    .result-stat h4 {
      color: #ffeb3b;
      margin-bottom: 5px;
    }

    .loading-spinner {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 3px solid var(--primary);
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
      .header, .scoreboard, .innings-info, .players-panel {
        flex-direction: column;
      }

      .team-score, .innings-box, .batters-panel, .bowlers-panel {
        margin-bottom: 10px;
      }

      .vs {
        padding: 10px 0;
      }

      .cards-container {
        gap: 10px;
      }

      .card {
        width: 50px;
        height: 75px;
        font-size: 20px;
      }

      .teams-container {
        flex-direction: column;
      }

      .team-modal {
        margin-bottom: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="match-info">
        <h1 class="match-title" id="matchTitle">Match Title</h1>
        <div class="match-format" id="matchFormat">Format</div>
      </div>
      <button class="action-btn" id="showTeamsBtn">Show Teams</button>
    </div>

    <div class="scoreboard">
      <div class="team-score">
        <div class="team-name" id="team1Name">Team A</div>
        <div class="team-runs" id="team1Runs">0/0</div>
        <div class="team-overs" id="team1Overs">(0.0)</div>
      </div>
      <div class="vs">VS</div>
      <div class="team-score">
        <div class="team-name" id="team2Name">Team B</div>
        <div class="team-runs" id="team2Runs">0/0</div>
        <div class="team-overs" id="team2Overs">(0.0)</div>
      </div>
    </div>

    <div class="match-status" id="matchStatus">
      Match about to begin
    </div>

    <div class="innings-info">
      <div class="innings-box">
        <h3 id="innings1Title">1st Innings</h3>
        <div id="innings1Score">-</div>
      </div>
      <div class="innings-box" id="innings2Box" style="display: none;">
        <h3 id="innings2Title">2nd Innings</h3>
        <div id="innings2Score">-</div>
      </div>
      <div class="innings-box">
        <h3>Current</h3>
        <div id="currentInningsScore">-</div>
      </div>
    </div>

    <div class="current-over">
      <div class="over-title">
        <span>Current Over</span>
        <span id="overNumber">Over 0.0</span>
      </div>
      <div class="over-progress" id="overProgress"></div>
    </div>

    <div class="game-area">
      <div class="player-selection" id="batterSelection">
        <h3 class="selection-title">Select Batter</h3>
        <div class="player-options" id="batterOptions"></div>
        <button class="confirm-btn" id="confirmBatterBtn">Confirm</button>
      </div>

      <div class="player-selection" id="bowlerSelection">
        <h3 class="selection-title">Select Bowler</h3>
        <div class="player-options" id="bowlerOptions"></div>
        <button class="confirm-btn" id="confirmBowlerBtn">Confirm</button>
      </div>

      <div class="cards-container" id="cardsContainer">
        <!-- Cards will be added dynamically -->
      </div>

      <div class="action-buttons">
        <button class="action-btn" id="playBtn" disabled>Play</button>
        <button class="action-btn secondary" id="undoBtn" disabled>Undo</button>
        <button class="action-btn danger" id="endInningsBtn" style="display: none;">End Innings</button>
      </div>
    </div>

    <div class="players-panel">
      <div class="batters-panel">
        <h3 class="panel-title">Batting</h3>
        <ul class="player-list" id="battersList"></ul>
      </div>
      <div class="bowlers-panel">
        <h3 class="panel-title">Bowling</h3>
        <ul class="player-list" id="bowlersList"></ul>
      </div>
    </div>
  </div>

  <!-- Teams Modal -->
  <div class="modal" id="teamsModal">
    <div class="modal-content teams-modal">
      <h2 class="modal-title">Teams</h2>
      <div class="modal-body">
        <div class="teams-container">
          <div class="team-modal">
            <h3 id="modalTeam1Name">Team A</h3>
            <ul class="team-players" id="modalTeam1Players"></ul>
          </div>
          <div class="team-modal">
            <h3 id="modalTeam2Name">Team B</h3>
            <ul class="team-players" id="modalTeam2Players"></ul>
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="modal-btn" id="closeTeamsModal">Close</button>
      </div>
    </div>
  </div>

  <!-- Innings Summary Modal -->
  <div class="modal" id="inningsSummaryModal">
    <div class="modal-content">
      <h2 class="modal-title" id="inningsSummaryTitle">Innings Summary</h2>
      <div class="modal-body" id="inningsSummaryContent">
        <div class="loading-spinner"></div>
      </div>
      <div class="modal-actions">
        <button class="modal-btn" id="continueInningsBtn">Continue</button>
      </div>
    </div>
  </div>

  <!-- Match Result Modal -->
  <div class="modal" id="resultModal">
    <div class="modal-content result-modal">
      <h2 class="modal-title">Match Result</h2>
      <div class="modal-body">
        <h3 class="result-title" id="resultTitle">Match Completed</h3>
        <div class="result-details" id="resultDetails"></div>
        
        <div class="result-stats">
          <div class="result-stat">
            <h4>1st Innings</h4>
            <div id="resultInnings1"></div>
          </div>
          <div class="result-stat">
            <h4>2nd Innings</h4>
            <div id="resultInnings2"></div>
          </div>
        </div>
        
        <div id="playerOfMatch"></div>
      </div>
      <div class="modal-actions">
        <button class="modal-btn" id="saveMatchBtn">Save Match Data</button>
        <button class="modal-btn secondary" id="closeResultModal">Close</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getDatabase, ref, onValue, update, set, get } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCN6aZMwlsZe7JJaovU0WA3UQygWr4jYmA",
      authDomain: "handicricket-85a06.firebaseapp.com",
      projectId: "handicricket-85a06",
      storageBucket: "handicricket-85a06.appspot.com",
      messagingSenderId: "599182538558",
      appId: "1:599182538558:web:3e965753ab05f8f1e3de6f",
      measurementId: "G-HSV9H4LEJQ"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Get URL parameters
    const params = new URLSearchParams(window.location.search);
    const roomId = params.get('room');
    const playerRole = params.get('player');
    const isSpectator = playerRole === 'spectator';

    if (!roomId || (!isSpectator && !playerRole)) {
      alert('Invalid room or player');
      window.location.href = 'index.html';
    }

    // DOM elements
    const matchTitle = document.getElementById('matchTitle');
    const matchFormat = document.getElementById('matchFormat');
    const team1Name = document.getElementById('team1Name');
    const team2Name = document.getElementById('team2Name');
    const team1Runs = document.getElementById('team1Runs');
    const team2Runs = document.getElementById('team2Runs');
    const team1Overs = document.getElementById('team1Overs');
    const team2Overs = document.getElementById('team2Overs');
    const matchStatus = document.getElementById('matchStatus');
    const innings1Title = document.getElementById('innings1Title');
    const innings2Title = document.getElementById('innings2Title');
    const innings1Score = document.getElementById('innings1Score');
    const innings2Score = document.getElementById('innings2Score');
    const innings2Box = document.getElementById('innings2Box');
    const currentInningsScore = document.getElementById('currentInningsScore');
    const overNumber = document.getElementById('overNumber');
    const overProgress = document.getElementById('overProgress');
    const batterSelection = document.getElementById('batterSelection');
    const bowlerSelection = document.getElementById('bowlerSelection');
    const batterOptions = document.getElementById('batterOptions');
    const bowlerOptions = document.getElementById('bowlerOptions');
    const confirmBatterBtn = document.getElementById('confirmBatterBtn');
    const confirmBowlerBtn = document.getElementById('confirmBowlerBtn');
    const cardsContainer = document.getElementById('cardsContainer');
    const playBtn = document.getElementById('playBtn');
    const undoBtn = document.getElementById('undoBtn');
    const endInningsBtn = document.getElementById('endInningsBtn');
    const battersList = document.getElementById('battersList');
    const bowlersList = document.getElementById('bowlersList');
    const showTeamsBtn = document.getElementById('showTeamsBtn');
    const teamsModal = document.getElementById('teamsModal');
    const modalTeam1Name = document.getElementById('modalTeam1Name');
    const modalTeam2Name = document.getElementById('modalTeam2Name');
    const modalTeam1Players = document.getElementById('modalTeam1Players');
    const modalTeam2Players = document.getElementById('modalTeam2Players');
    const closeTeamsModal = document.getElementById('closeTeamsModal');
    const inningsSummaryModal = document.getElementById('inningsSummaryModal');
    const inningsSummaryTitle = document.getElementById('inningsSummaryTitle');
    const inningsSummaryContent = document.getElementById('inningsSummaryContent');
    const continueInningsBtn = document.getElementById('continueInningsBtn');
    const resultModal = document.getElementById('resultModal');
    const resultTitle = document.getElementById('resultTitle');
    const resultDetails = document.getElementById('resultDetails');
    const resultInnings1 = document.getElementById('resultInnings1');
    const resultInnings2 = document.getElementById('resultInnings2');
    const playerOfMatch = document.getElementById('playerOfMatch');
    const saveMatchBtn = document.getElementById('saveMatchBtn');
    const closeResultModal = document.getElementById('closeResultModal');

    // Game state
    let gameState = {
      roomId: roomId,
      playerRole: playerRole,
      isSpectator: isSpectator,
      matchData: null,
      currentInnings: null,
      selectedBatter: null,
      selectedBowler: null,
      selectedCard: null,
      currentOver: [],
      batterCards: [],
      bowlerCards: [],
      batters: [],
      bowlers: [],
      team1: null,
      team2: null,
      powerplay: false,
      deadOver: false,
      matchComplete: false
    };

    // Initialize the game
    function initGame() {
      // Set up event listeners
      setupEventListeners();
      
      // Connect to Firebase room
      connectToRoom();
    }

    // Set up event listeners
    function setupEventListeners() {
      // Card selection
      document.addEventListener('click', (e) => {
        if (e.target.classList.contains('card') && !e.target.classList.contains('disabled')) {
          selectCard(e.target);
        }
      });

      // Play button
      playBtn.addEventListener('click', playBall);

      // Undo button
      undoBtn.addEventListener('click', undoLastBall);

      // End innings button
      endInningsBtn.addEventListener('click', endInnings);

      // Confirm batter selection
      confirmBatterBtn.addEventListener('click', () => confirmPlayerSelection('batter'));

      // Confirm bowler selection
      confirmBowlerBtn.addEventListener('click', () => confirmPlayerSelection('bowler'));

      // Teams modal
      showTeamsBtn.addEventListener('click', showTeamsModal);
      closeTeamsModal.addEventListener('click', () => teamsModal.classList.remove('active'));

      // Innings summary modal
      continueInningsBtn.addEventListener('click', () => {
        inningsSummaryModal.classList.remove('active');
        if (gameState.currentInnings === 1) {
          startSecondInnings();
        } else if (gameState.matchComplete) {
          showMatchResult();
        }
      });

      // Result modal
      saveMatchBtn.addEventListener('click', saveMatchData);
      closeResultModal.addEventListener('click', () => {
        resultModal.classList.remove('active');
        window.location.href = 'index.html';
      });
    }

    // Connect to Firebase room
    function connectToRoom() {
      const roomRef = ref(db, `rooms/${roomId}`);
      
      onValue(roomRef, (snapshot) => {
        if (!snapshot.exists()) {
          alert('Room not found');
          window.location.href = 'index.html';
          return;
        }

        const roomData = snapshot.val();
        gameState.matchData = roomData;
        
        // Update UI with match info
        updateMatchInfo(roomData);
        
        // Initialize or update game state
        if (roomData.gameState) {
          updateGameState(roomData.gameState);
        } else if (roomData.teams && roomData.teams.player1 && roomData.teams.player2) {
          // Initialize game state if not already initialized
          initializeGameState(roomData);
        }
      });
    }

    // Update match info in UI
    function updateMatchInfo(roomData) {
      // Set team names
      team1Name.textContent = roomData.player1?.team || 'Team A';
      team2Name.textContent = roomData.player2?.team || 'Team B';
      
      // Set modal team names
      modalTeam1Name.textContent = roomData.player1?.team || 'Team A';
      modalTeam2Name.textContent = roomData.player2?.team || 'Team B';
      
      // Set match title
      matchTitle.textContent = `${roomData.player1?.team || 'Team A'} vs ${roomData.player2?.team || 'Team B'}`;
      
      // Set match format
      const format = roomData.player1?.format || '5';
      const formatNames = {
        '5': 'T5 (5 Overs)',
        '10': 'T10 (10 Overs)',
        '20': 'T20 (20 Overs)',
        '50': 'ODI (50 Overs)',
        'test': 'Test Match'
      };
      matchFormat.textContent = formatNames[format] || format;
    }

    // Initialize game state
    function initializeGameState(roomData) {
      if (gameState.currentInnings) return; // Already initialized
      
      // Determine batting and bowling teams based on toss
      const tossData = roomData.toss;
      if (!tossData || !tossData.battingFirst) {
        matchStatus.textContent = 'Waiting for toss...';
        return;
      }
      
      const battingFirst = tossData.battingFirst;
      const bowlingFirst = battingFirst === 'player1' ? 'player2' : 'player1';
      
      // Set up teams
      gameState.team1 = {
        role: 'player1',
        name: roomData.player1.team,
        players: roomData.teams.player1.players,
        captain: roomData.teams.player1.captain,
        viceCaptain: roomData.teams.player1.viceCaptain,
        batting: battingFirst === 'player1',
        bowling: bowlingFirst === 'player1'
      };
      
      gameState.team2 = {
        role: 'player2',
        name: roomData.player2.team,
        players: roomData.teams.player2.players,
        captain: roomData.teams.player2.captain,
        viceCaptain: roomData.teams.player2.viceCaptain,
        batting: battingFirst === 'player2',
        bowling: bowlingFirst === 'player2'
      };
      
      // Initialize first innings
      gameState.currentInnings = 1;
      const battingTeam = battingFirst === 'player1' ? gameState.team1 : gameState.team2;
      const bowlingTeam = bowlingFirst === 'player1' ? gameState.team1 : gameState.team2;
      
      // Initialize players
      initializePlayers(battingTeam, bowlingTeam);
      
      // Update UI
      updateInningsInfo();
      updateScoreboard();
      updatePlayersPanel();
      
      // Set powerplay status based on format
      checkPowerplay();
      
      // Start the game
      if (!isSpectator) {
        startGame();
      } else {
        matchStatus.textContent = 'Spectating the match';
      }
      
      // Save initial game state to Firebase
      saveGameState();
    }

    // Update game state from Firebase
    function updateGameState(firebaseGameState) {
      gameState.currentInnings = firebaseGameState.currentInnings;
      gameState.currentOver = firebaseGameState.currentOver || [];
      gameState.batters = firebaseGameState.batters || [];
      gameState.bowlers = firebaseGameState.bowlers || [];
      gameState.selectedBatter = firebaseGameState.selectedBatter;
      gameState.selectedBowler = firebaseGameState.selectedBowler;
      gameState.powerplay = firebaseGameState.powerplay || false;
      gameState.deadOver = firebaseGameState.deadOver || false;
      gameState.matchComplete = firebaseGameState.matchComplete || false;
      
      // Update UI
      updateInningsInfo();
      updateScoreboard();
      updateOverProgress();
      updatePlayersPanel();
      
      // Check if we need to show batter/bowler selection
      if (!isSpectator && !gameState.matchComplete) {
        if (!gameState.selectedBatter && gameState.currentInnings) {
          showBatterSelection();
        } else if (!gameState.selectedBowler && gameState.currentInnings) {
          showBowlerSelection();
        } else {
          setupCards();
        }
      }
      
      // Check if we need to show innings summary or match result
      if (firebaseGameState.showInningsSummary) {
        showInningsSummary(firebaseGameState.inningsSummary);
      } else if (firebaseGameState.showMatchResult) {
        showMatchResult(firebaseGameState.matchResult);
      }
    }

    // Initialize players for the innings
    function initializePlayers(battingTeam, bowlingTeam) {
      // Batters (all players start with full wicket bar)
      gameState.batters = battingTeam.players.map(player => ({
        name: player,
        runs: 0,
        balls: 0,
        fours: 0,
        sixes: 0,
        wicket: 1.0,
        out: false,
        active: false,
        isCaptain: player === battingTeam.captain,
        isViceCaptain: player === battingTeam.viceCaptain
      }));
      
      // Bowlers (all players start with 0 overs bowled)
      gameState.bowlers = bowlingTeam.players.map(player => ({
        name: player,
        overs: 0,
        maidens: 0,
        runsConceded: 0,
        wickets: 0,
        balls: 0,
        active: false,
        isCaptain: player === bowlingTeam.captain,
        isViceCaptain: player === bowlingTeam.viceCaptain
      }));
      
      // Set team references
      if (battingTeam.role === 'player1') {
        gameState.team1 = battingTeam;
        gameState.team2 = bowlingTeam;
      } else {
        gameState.team1 = bowlingTeam;
        gameState.team2 = battingTeam;
      }
    }

    // Start the game
    function startGame() {
      if (isSpectator) return;
      
      // Show batter selection if no batter is selected
      if (!gameState.selectedBatter) {
        showBatterSelection();
      }
      
      // Update match status
      updateMatchStatus();
    }

    // Show batter selection
    function showBatterSelection() {
      if (isSpectator) return;
      
      // Filter out batters who are already out
      const availableBatters = gameState.batters.filter(batter => !batter.out);
      
      // Populate batter options
      batterOptions.innerHTML = '';
      availableBatters.forEach(batter => {
        const btn = document.createElement('button');
        btn.className = 'player-btn';
        btn.textContent = batter.name;
        if (batter.isCaptain) btn.classList.add('captain');
        if (batter.isViceCaptain) btn.classList.add('vice-captain');
        btn.addEventListener('click', () => selectPlayer(batter.name, 'batter'));
        batterOptions.appendChild(btn);
      });
      
      // Show batter selection
      batterSelection.classList.add('active');
      bowlerSelection.classList.remove('active');
    }

    // Show bowler selection
    function showBowlerSelection() {
      if (isSpectator) return;
      
      // Filter bowlers who haven't exceeded over limit
      const availableBowlers = gameState.bowlers.filter(bowler => {
        if (gameState.matchData.player1.format === 'test') return true; // No limit in test
        
        const format = gameState.matchData.player1.format;
        const overLimit = format === '5' ? 1 : 
                         format === '10' ? 2 : 
                         format === '20' ? 4 : 
                         format === '50' ? 10 : 4; // Default to T20 limit
        
        return bowler.overs < overLimit;
      });
      
      // Populate bowler options
      bowlerOptions.innerHTML = '';
      availableBowlers.forEach(bowler => {
        const btn = document.createElement('button');
        btn.className = 'player-btn';
        btn.textContent = bowler.name;
        if (bowler.isCaptain) btn.classList.add('captain');
        if (bowler.isViceCaptain) btn.classList.add('vice-captain');
        btn.addEventListener('click', () => selectPlayer(bowler.name, 'bowler'));
        bowlerOptions.appendChild(btn);
      });
      
      // Show bowler selection
      bowlerSelection.classList.add('active');
      batterSelection.classList.remove('active');
    }

    // Select a player (batter or bowler)
    function selectPlayer(playerName, type) {
      // Remove selected class from all buttons
      const buttons = type === 'batter' 
        ? document.querySelectorAll('#batterOptions .player-btn')
        : document.querySelectorAll('#bowlerOptions .player-btn');
      
      buttons.forEach(btn => btn.classList.remove('selected'));
      
      // Add selected class to clicked button
      const selectedBtn = Array.from(buttons).find(btn => btn.textContent === playerName);
      if (selectedBtn) selectedBtn.classList.add('selected');
      
      // Store selection
      if (type === 'batter') {
        gameState.selectedBatter = playerName;
      } else {
        gameState.selectedBowler = playerName;
      }
    }

    // Confirm player selection
    function confirmPlayerSelection(type) {
      if (type === 'batter' && !gameState.selectedBatter) {
        alert('Please select a batter');
        return;
      }
      
      if (type === 'bowler' && !gameState.selectedBowler) {
        alert('Please select a bowler');
        return;
      }
      
      // Update player active status
      if (type === 'batter') {
        gameState.batters.forEach(batter => {
          batter.active = batter.name === gameState.selectedBatter;
        });
      } else {
        gameState.bowlers.forEach(bowler => {
          bowler.active = bowler.name === gameState.selectedBowler;
        });
      }
      
      // Hide selection UI
      batterSelection.classList.remove('active');
      bowlerSelection.classList.remove('active');
      
      // Setup cards for gameplay
      setupCards();
      
      // Update UI
      updatePlayersPanel();
      
      // Save game state
      saveGameState();
    }

    // Setup cards for gameplay
    function setupCards() {
      if (isSpectator) return;
      
      // Clear existing cards
      cardsContainer.innerHTML = '';
      
      // Create cards (0-6)
      for (let i = 0; i <= 6; i++) {
        const card = document.createElement('div');
        card.className = 'card';
        card.textContent = i;
        card.dataset.value = i;
        cardsContainer.appendChild(card);
      }
      
      // Enable play button if both batter and bowler are selected
      playBtn.disabled = !(gameState.selectedBatter && gameState.selectedBowler);
    }

    // Select a card
    function selectCard(cardElement) {
      if (isSpectator) return;
      
      // Deselect all cards
      document.querySelectorAll('.card').forEach(card => {
        card.classList.remove('selected');
      });
      
      // Select clicked card
      cardElement.classList.add('selected');
      gameState.selectedCard = parseInt(cardElement.dataset.value);
      
      // Enable play button if both batter and bowler are selected
      playBtn.disabled = !(gameState.selectedBatter && gameState.selectedBowler && gameState.selectedCard !== null);
    }

    // Play a ball
    function playBall() {
      if (isSpectator) return;
      
      // Disable buttons during processing
      playBtn.disabled = true;
      undoBtn.disabled = true;
      
      // Get batter and bowler
      const batter = gameState.batters.find(b => b.name === gameState.selectedBatter);
      const bowler = gameState.bowlers.find(b => b.name === gameState.selectedBowler);
      
      if (!batter || !bowler) {
        alert('Player not found');
        return;
      }
      
      // Generate bowler's card (random for now, could be selected by bowler in multiplayer)
      const bowlerCard = Math.floor(Math.random() * 7); // 0-6
      
      // Process the ball based on game rules
      processBall(batter, bowler, gameState.selectedCard, bowlerCard);
      
      // Clear selection
      gameState.selectedCard = null;
      document.querySelectorAll('.card').forEach(card => {
        card.classList.remove('selected');
      });
      
      // Save game state
      saveGameState();
    }

    // Process a ball based on game rules
    function processBall(batter, bowler, batterCard, bowlerCard) {
      let runs = 0;
      let isWicket = false;
      let isNoBall = false;
      let isWide = false;
      let description = '';
      
      const format = gameState.matchData.player1.format;
      const isTest = format === 'test';
      const isOdi = format === '50';
      
      // Check for dead over in ODI (non-powerplay)
      const isDeadOver = isOdi && gameState.deadOver && !gameState.powerplay;
      
      // Rules implementation
      if (batterCard === 0 && bowlerCard === 0) {
        // Both 0
        if (isDeadOver) {
          // In dead over, both 0 is a dot ball
          description = 'Dot ball';
        } else {
          // Otherwise, it's a no ball
          isNoBall = true;
          runs = 1;
          description = 'No ball';
        }
      } else if (batterCard === 0 && bowlerCard > 0) {
        // Batter 0, bowler 1-6
        if (isDeadOver) {
          // In dead over, batter 0 and bowler 1-6 is a no ball
          isNoBall = true;
          runs = 1;
          description = 'No ball';
        } else {
          // Otherwise, dot ball
          description = 'Dot ball';
        }
      } else if (batterCard > 0 && bowlerCard === 0) {
        // Batter 1-6, bowler 0
        if (isTest) {
          // In test, batter scores runs
          runs = batterCard;
          description = `${runs} run${runs > 1 ? 's' : ''}`;
        } else {
          // In limited overs, dot ball
          description = 'Dot ball';
        }
      } else {
        // Both 1-6
        if (batterCard === bowlerCard) {
          // Wicket
          isWicket = true;
          
          // Calculate wicket value based on format and powerplay
          let wicketValue = 1.0; // Default to full wicket
          
          if (!isTest) {
            if (gameState.powerplay) {
              wicketValue = isOdi ? 0.25 : 0.5;
            } else {
              wicketValue = isOdi ? 0.5 : 1.0;
            }
          }
          
          // Apply wicket
          batter.wicket -= wicketValue;
          batter.wicket = Math.max(0, batter.wicket); // Ensure not negative
          
          if (batter.wicket <= 0) {
            batter.out = true;
            description = 'Wicket!';
          } else {
            description = `Partial wicket (${(wicketValue * 100).toFixed(0)}%)`;
          }
        } else {
          // Batter scores runs
          runs = batterCard;
          description = `${runs} run${runs > 1 ? 's' : ''}`;
        }
      }
      
      // Update player stats
      batter.balls += 1;
      bowler.balls += 1;
      
      if (runs > 0) {
        batter.runs += runs;
        bowler.runsConceded += runs;
        
        if (runs === 4) {
          batter.fours += 1;
        } else if (runs === 6) {
          batter.sixes += 1;
        }
      }
      
      if (isWicket) {
        bowler.wickets += 1;
      }
      
      // Update current over
      const ballResult = {
        batter: batter.name,
        bowler: bowler.name,
        batterCard,
        bowlerCard,
        runs,
        isWicket,
        isNoBall,
        isWide,
        description
      };
      
      gameState.currentOver.push(ballResult);
      
      // Update UI
      updateOverProgress();
      updateScoreboard();
      updatePlayersPanel();
      
      // Check for end of over (6 balls)
      if (gameState.currentOver.length >= 6) {
        endOver();
      }
      
      // Check for end of innings
      checkInningsEnd();
      
      // Update match status
      updateMatchStatus();
    }

    // Update over progress in UI
    function updateOverProgress() {
      overProgress.innerHTML = '';
      
      gameState.currentOver.forEach((ball, index) => {
        const ballEl = document.createElement('div');
        ballEl.className = 'ball';
        
        if (ball.isWicket) {
          ballEl.className += ' wicket';
          ballEl.textContent = 'W';
        } else if (ball.isNoBall) {
          ballEl.className += ' noball';
          ballEl.textContent = 'NB';
        } else if (ball.isWide) {
          ballEl.className += ' wide';
          ballEl.textContent = 'WD';
        } else if (ball.runs > 0) {
          ballEl.className += ' run';
          ballEl.textContent = ball.runs;
        } else {
          ballEl.className += ' dot';
          ballEl.textContent = 'â€¢';
        }
        
        overProgress.appendChild(ballEl);
      });
      
      // Update over number
      const totalBalls = (gameState.currentInnings === 1 ? gameState.team1.balls : gameState.team2.balls) || 0;
      const completedOvers = Math.floor(totalBalls / 6);
      const currentBall = totalBalls % 6;
      overNumber.textContent = `Over ${completedOvers}.${currentBall}`;
    }

    // End the current over
    function endOver() {
      // Update bowler's overs
      const bowlerName = gameState.currentOver[0].bowler;
      const bowler = gameState.bowlers.find(b => b.name === bowlerName);
      
      if (bowler) {
        bowler.overs += 1;
        
        // Check for maiden over (no runs conceded)
        const runsInOver = gameState.currentOver.reduce((sum, ball) => sum + ball.runs, 0);
        if (runsInOver === 0) {
          bowler.maidens += 1;
        }
      }
      
      // Reset current over
      gameState.currentOver = [];
      
      // Check for powerplay end
      checkPowerplay();
      
      // In ODI, check for dead over selection (non-powerplay)
      if (gameState.matchData.player1.format === '50' && !gameState.powerplay) {
        // For simplicity, we'll randomly decide if this is a dead over
        // In a real game, the bowling team would choose
        gameState.deadOver = Math.random() < 0.2; // 20% chance of dead over
      } else {
        gameState.deadOver = false;
      }
      
      // Need to select new bowler for next over
      gameState.selectedBowler = null;
      
      // Update UI
      updatePlayersPanel();
      
      if (!isSpectator) {
        showBowlerSelection();
      }
    }

    // Check powerplay status
    function checkPowerplay() {
      const format = gameState.matchData.player1.format;
      const totalBalls = (gameState.currentInnings === 1 ? gameState.team1.balls : gameState.team2.balls) || 0;
      
      if (format === 'test') {
        gameState.powerplay = false;
        return;
      }
      
      // Determine powerplay based on format
      let powerplayEnd = 0;
      
      switch (format) {
        case '5':
          powerplayEnd = 2 * 6; // First 2 overs
          break;
        case '10':
          powerplayEnd = 3 * 6; // First 3 overs
          break;
        case '20':
          powerplayEnd = 6 * 6; // First 6 overs
          break;
        case '50':
          // ODI has multiple powerplays: 1-10, 21-30, 41-42
          const overNumber = Math.floor(totalBalls / 6);
          gameState.powerplay = (overNumber < 10) || 
                               (overNumber >= 20 && overNumber < 30) || 
                               (overNumber >= 40 && overNumber < 42);
          return;
        default:
          powerplayEnd = 6 * 6; // Default to T20 rules
      }
      
      gameState.powerplay = totalBalls < powerplayEnd;
    }

    // Check if innings should end
    function checkInningsEnd() {
      const format = gameState.matchData.player1.format;
      const isTest = format === 'test';
      
      // Check all out (10 wickets)
      const battingTeam = gameState.currentInnings === 1 ? gameState.team1 : gameState.team2;
      const wicketsLost = gameState.batters.filter(b => b.out).length;
      
      if (wicketsLost >= 10) {
        endInnings();
        return;
      }
      
      // Check overs completed (not in test)
      if (!isTest) {
        const totalBalls = battingTeam.balls || 0;
        const totalOvers = format === '5' ? 5 : 
                          format === '10' ? 10 : 
                          format === '20' ? 20 : 
                          format === '50' ? 50 : 20; // Default to T20
        
        if (totalBalls >= totalOvers * 6) {
          endInnings();
          return;
        }
      }
      
      // In test, check if all days/overs completed (simplified for this example)
      // In a full implementation, we'd track days and sessions
    }

    // End current innings
    function endInnings() {
      const battingTeam = gameState.currentInnings === 1 ? gameState.team1 : gameState.team2;
      const bowlingTeam = gameState.currentInnings === 1 ? gameState.team2 : gameState.team1;
      
      // Calculate innings total
      const totalRuns = gameState.batters.reduce((sum, batter) => sum + batter.runs, 0);
      const totalWickets = gameState.batters.filter(b => b.out).length;
      const totalBalls = battingTeam.balls || 0;
      
      // Update team totals
      battingTeam.runs = totalRuns;
      battingTeam.wickets = totalWickets;
      battingTeam.balls = totalBalls;
      
      // Prepare innings summary
      const inningsSummary = {
        innings: gameState.currentInnings,
        battingTeam: battingTeam.name,
        bowlingTeam: bowlingTeam.name,
        totalRuns,
        totalWickets,
        totalOvers: `${Math.floor(totalBalls / 6)}.${totalBalls % 6}`,
        runRate: (totalRuns / (totalBalls / 6)).toFixed(2),
        topBatters: [...gameState.batters].sort((a, b) => b.runs - a.runs).slice(0, 3),
        topBowlers: [...gameState.bowlers].sort((a, b) => b.wickets - a.wickets).slice(0, 3)
      };
      
      // Show innings summary
      showInningsSummary(inningsSummary);
      
      // Update game state
      if (gameState.currentInnings === 1) {
        gameState.currentInnings = 2;
        
        // Swap batting and bowling teams for second innings
        gameState.team1.batting = !gameState.team1.batting;
        gameState.team1.bowling = !gameState.team1.bowling;
        gameState.team2.batting = !gameState.team2.batting;
        gameState.team2.bowling = !gameState.team2.bowling;
      } else {
        gameState.matchComplete = true;
      }
      
      // Reset current over and selections
      gameState.currentOver = [];
      gameState.selectedBatter = null;
      gameState.selectedBowler = null;
      
      // Save game state
      saveGameState();
    }

    // Start second innings
    function startSecondInnings() {
      const battingTeam = gameState.currentInnings === 1 ? gameState.team1 : gameState.team2;
      const bowlingTeam = gameState.currentInnings === 1 ? gameState.team2 : gameState.team1;
      
      // Initialize players for second innings
      initializePlayers(battingTeam, bowlingTeam);
      
      // Update UI
      updateInningsInfo();
      updateScoreboard();
      updatePlayersPanel();
      
      // Start the game
      if (!isSpectator) {
        startGame();
      }
      
      // Save game state
      saveGameState();
    }

    // Show innings summary
    function showInningsSummary(summary) {
      inningsSummaryTitle.textContent = `${summary.innings === 1 ? 'First' : 'Second'} Innings Summary`;
      
      let content = `
        <p><strong>${summary.battingTeam}</strong>: ${summary.totalRuns}/${summary.totalWickets} (${summary.totalOvers})</p>
        <p>Run Rate: ${summary.runRate}</p>
        
        <h4>Top Batters:</h4>
        <ul>
      `;
      
      summary.topBatters.forEach(batter => {
        content += `<li>${batter.name}: ${batter.runs} (${batter.balls}) ${batter.out ? '' : '*'}</li>`;
      });
      
      content += `
        </ul>
        
        <h4>Top Bowlers:</h4>
        <ul>
      `;
      
      summary.topBowlers.forEach(bowler => {
        const overs = `${Math.floor(bowler.balls / 6)}.${bowler.balls % 6}`;
        content += `<li>${bowler.name}: ${bowler.wickets}/${bowler.runsConceded} (${overs})</li>`;
      });
      
      content += `</ul>`;
      
      if (summary.innings === 1) {
        content += `<p><strong>Target:</strong> ${summary.totalRuns + 1} runs to win</p>`;
      }
      
      inningsSummaryContent.innerHTML = content;
      
      // Show modal
      inningsSummaryModal.classList.add('active');
      
      // Update game state to show summary
      update(ref(db, `rooms/${roomId}/gameState`), {
        showInningsSummary: true,
        inningsSummary: summary
      });
    }

    // Show match result
    function showMatchResult(result) {
      if (result) {
        // Use provided result data
        resultTitle.textContent = result.title;
        resultDetails.innerHTML = result.details;
        resultInnings1.innerHTML = result.innings1;
        resultInnings2.innerHTML = result.innings2;
        playerOfMatch.innerHTML = result.playerOfMatch;
      } else {
        // Calculate result
        const team1 = gameState.team1;
        const team2 = gameState.team2;
        
        const firstInningsRuns = team1.batting ? team1.runs : team2.runs;
        const secondInningsRuns = team1.batting ? team2.runs : team1.runs;
        
        let title, details;
        
        if (secondInningsRuns > firstInningsRuns) {
          // Team batting second won
          const winningTeam = team1.batting ? team2.name : team1.name;
          const margin = secondInningsRuns - firstInningsRuns;
          title = `${winningTeam} won by ${margin} run${margin > 1 ? 's' : ''}`;
          details = `${winningTeam} chased down the target of ${firstInningsRuns + 1} runs`;
        } else if (secondInningsRuns === firstInningsRuns) {
          // Tie
          title = 'Match Tied';
          details = 'Both teams scored the same number of runs';
        } else {
          // Team batting first won
          const winningTeam = team1.batting ? team1.name : team2.name;
          const margin = firstInningsRuns - secondInningsRuns;
          title = `${winningTeam} won by ${margin} run${margin > 1 ? 's' : ''}`;
          details = `${winningTeam} defended their total of ${firstInningsRuns} runs`;
        }
        
        // Determine player of the match (simplified - highest scorer)
        const allBatters = [...gameState.batters];
        const topScorer = allBatters.sort((a, b) => b.runs - a.runs)[0];
        
        // Set result content
        resultTitle.textContent = title;
        resultDetails.innerHTML = details;
        
        resultInnings1.innerHTML = `
          <p><strong>${team1.batting ? team1.name : team2.name}</strong>: ${firstInningsRuns}/${team1.batting ? team1.wickets : team2.wickets}</p>
        `;
        
        resultInnings2.innerHTML = `
          <p><strong>${team1.batting ? team2.name : team1.name}</strong>: ${secondInningsRuns}/${team1.batting ? team2.wickets : team1.wickets}</p>
        `;
        
        playerOfMatch.innerHTML = `
          <h4>Player of the Match:</h4>
          <p>${topScorer.name} (${topScorer.runs} runs)</p>
        `;
        
        // Store result in game state
        result = {
          title,
          details,
          innings1: `${team1.batting ? team1.name : team2.name}: ${firstInningsRuns}/${team1.batting ? team1.wickets : team2.wickets}`,
          innings2: `${team1.batting ? team2.name : team1.name}: ${secondInningsRuns}/${team1.batting ? team2.wickets : team1.wickets}`,
          playerOfMatch: `${topScorer.name} (${topScorer.runs} runs)`
        };
      }
      
      // Show modal
      resultModal.classList.add('active');
      
      // Update game state to show result
      update(ref(db, `rooms/${roomId}/gameState`), {
        showMatchResult: true,
        matchResult: result
      });
    }

    // Save match data to Firebase
    function saveMatchData() {
      const team1 = gameState.team1;
      const team2 = gameState.team2;
      
      // Prepare match data for saving
      const matchData = {
        timestamp: Date.now(),
        format: gameState.matchData.player1.format,
        player1: {
          team: team1.name,
          totalRuns: team1.batting ? team1.runs : team2.runs,
          totalWickets: team1.batting ? team1.wickets : team2.wickets,
          balls: team1.batting ? team1.balls : team2.balls
        },
        player2: {
          team: team2.name,
          totalRuns: team2.batting ? team2.runs : team1.runs,
          totalWickets: team2.batting ? team2.wickets : team1.wickets,
          balls: team2.batting ? team2.balls : team1.balls
        },
        toss: gameState.matchData.toss,
        winner: determineWinner(),
        winningMargin: calculateWinningMargin(),
        playerOfTheMatch: determinePlayerOfMatch(),
        player1Stats: preparePlayerStats(team1),
        player2Stats: preparePlayerStats(team2)
      };
      
      // Save to completed matches
      const newMatchRef = ref(db, `completedMatches/${roomId}`);
      set(newMatchRef, matchData)
        .then(() => {
          // Redirect to match summary
          window.location.href = `match_summary.html?id=${roomId}`;
        })
        .catch(error => {
          console.error("Error saving match:", error);
          alert("Failed to save match data. Please try again.");
        });
    }

    // Determine match winner
    function determineWinner() {
      const team1 = gameState.team1;
      const team2 = gameState.team2;
      
      const firstInningsRuns = team1.batting ? team1.runs : team2.runs;
      const secondInningsRuns = team1.batting ? team2.runs : team1.runs;
      
      if (secondInningsRuns > firstInningsRuns) {
        return team1.batting ? 'player2' : 'player1';
      } else if (firstInningsRuns > secondInningsRuns) {
        return team1.batting ? 'player1' : 'player2';
      }
      
      return null; // Tie
    }

    // Calculate winning margin
    function calculateWinningMargin() {
      const team1 = gameState.team1;
      const team2 = gameState.team2;
      
      const firstInningsRuns = team1.batting ? team1.runs : team2.runs;
      const secondInningsRuns = team1.batting ? team2.runs : team1.runs;
      
      if (secondInningsRuns > firstInningsRuns) {
        return `${secondInningsRuns - firstInningsRuns} runs`;
      } else if (firstInningsRuns > secondInningsRuns) {
        return `${firstInningsRuns - secondInningsRuns} runs`;
      }
      
      return 'Match Tied';
    }

    // Determine player of the match
    function determinePlayerOfMatch() {
      const allBatters = [...gameState.batters];
      const topScorer = allBatters.sort((a, b) => b.runs - a.runs)[0];
      return topScorer.name;
    }

    // Prepare player stats for saving
    function preparePlayerStats(team) {
      const stats = {};
      
      // Add batters' stats
      gameState.batters.forEach(batter => {
        if (team.batting) {
          stats[batter.name] = {
            runs: batter.runs,
            balls: batter.balls,
            fours: batter.fours,
            sixes: batter.sixes,
            out: batter.out
          };
        }
      });
      
      // Add bowlers' stats
      gameState.bowlers.forEach(bowler => {
        if (team.bowling) {
          stats[bowler.name] = {
            overs: bowler.overs + (bowler.balls % 6) / 10,
            maidens: bowler.maidens,
            runsConceded: bowler.runsConceded,
            wickets: bowler.wickets
          };
        }
      });
      
      return stats;
    }

    // Undo last ball
    function undoLastBall() {
      if (gameState.currentOver.length === 0) return;
      
      const lastBall = gameState.currentOver.pop();
      
      // Update batter stats
      const batter = gameState.batters.find(b => b.name === lastBall.batter);
      if (batter) {
        batter.balls -= 1;
        batter.runs -= lastBall.runs;
        
        if (lastBall.runs === 4) {
          batter.fours -= 1;
        } else if (lastBall.runs === 6) {
          batter.sixes -= 1;
        }
        
        if (lastBall.isWicket) {
          // Calculate wicket value based on format and powerplay
          const format = gameState.matchData.player1.format;
          const isOdi = format === '50';
          let wicketValue = 1.0;
          
          if (format !== 'test') {
            if (gameState.powerplay) {
              wicketValue = isOdi ? 0.25 : 0.5;
            } else {
              wicketValue = isOdi ? 0.5 : 1.0;
            }
          }
          
          batter.wicket += wicketValue;
          batter.wicket = Math.min(1.0, batter.wicket); // Cap at 1.0
          
          if (batter.wicket > 0) {
            batter.out = false;
          }
        }
      }
      
      // Update bowler stats
      const bowler = gameState.bowlers.find(b => b.name === lastBall.bowler);
      if (bowler) {
        bowler.balls -= 1;
        bowler.runsConceded -= lastBall.runs;
        
        if (lastBall.isWicket) {
          bowler.wickets -= 1;
        }
      }
      
      // Update team balls
      const battingTeam = gameState.currentInnings === 1 ? gameState.team1 : gameState.team2;
      if (battingTeam) {
        battingTeam.balls -= 1;
      }
      
      // Update UI
      updateOverProgress();
      updateScoreboard();
      updatePlayersPanel();
      
      // Save game state
      saveGameState();
    }

    // Update scoreboard
    function updateScoreboard() {
      const team1 = gameState.team1;
      const team2 = gameState.team2;
      
      if (!team1 || !team2) return;
      
      // Update team names
      team1Name.textContent = team1.name;
      team2Name.textContent = team2.name;
      
      // Update scores based on current innings
      if (gameState.currentInnings === 1) {
        // First innings
        team1Runs.textContent = team1.batting ? `${team1.runs}/${team1.wickets}` : '-';
        team2Runs.textContent = team2.batting ? `${team2.runs}/${team2.wickets}` : '-';
        
        team1Overs.textContent = team1.batting ? `(${formatOvers(team1.balls)})` : '';
        team2Overs.textContent = team2.batting ? `(${formatOvers(team2.balls)})` : '';
      } else {
        // Second innings
        team1Runs.textContent = team1.batting ? `${team1.runs}/${team1.wickets}` : `${gameState.team1.runs}/${gameState.team1.wickets}`;
        team2Runs.textContent = team2.batting ? `${team2.runs}/${team2.wickets}` : `${gameState.team2.runs}/${gameState.team2.wickets}`;
        
        team1Overs.textContent = team1.batting ? `(${formatOvers(team1.balls)})` : `(${formatOvers(gameState.team1.balls)})`;
        team2Overs.textContent = team2.batting ? `(${formatOvers(team2.balls)})` : `(${formatOvers(gameState.team2.balls)})`;
      }
      
      // Update innings info
      updateInningsInfo();
    }

    // Format overs (balls to overs.balls)
    function formatOvers(balls) {
      return `${Math.floor(balls / 6)}.${balls % 6}`;
    }

    // Update innings info
    function updateInningsInfo() {
      if (!gameState.team1 || !gameState.team2) return;
      
      // First innings
      if (gameState.team1.batting) {
        innings1Title.textContent = `${gameState.team1.name} 1st Innings`;
        innings1Score.textContent = gameState.team1.runs !== undefined ? 
          `${gameState.team1.runs}/${gameState.team1.wickets} (${formatOvers(gameState.team1.balls)})` : '-';
      } else {
        innings1Title.textContent = `${gameState.team2.name} 1st Innings`;
        innings1Score.textContent = gameState.team2.runs !== undefined ? 
          `${gameState.team2.runs}/${gameState.team2.wickets} (${formatOvers(gameState.team2.balls)})` : '-';
      }
      
      // Second innings (if started)
      if (gameState.currentInnings === 2) {
        innings2Box.style.display = 'block';
        
        if (gameState.team1.batting) {
          innings2Title.textContent = `${gameState.team1.name} 2nd Innings`;
          innings2Score.textContent = gameState.team1.runs !== undefined ? 
            `${gameState.team1.runs}/${gameState.team1.wickets} (${formatOvers(gameState.team1.balls)})` : '-';
        } else {
          innings2Title.textContent = `${gameState.team2.name} 2nd Innings`;
          innings2Score.textContent = gameState.team2.runs !== undefined ? 
            `${gameState.team2.runs}/${gameState.team2.wickets} (${formatOvers(gameState.team2.balls)})` : '-';
        }
      }
      
      // Current innings
      if (gameState.currentInnings === 1) {
        currentInningsScore.textContent = gameState.team1.batting ? 
          `${gameState.team1.runs}/${gameState.team1.wickets} (${formatOvers(gameState.team1.balls)})` : 
          `${gameState.team2.runs}/${gameState.team2.wickets} (${formatOvers(gameState.team2.balls)})`;
      } else {
        currentInningsScore.textContent = gameState.team1.batting ? 
          `${gameState.team1.runs}/${gameState.team1.wickets} (${formatOvers(gameState.team1.balls)})` : 
          `${gameState.team2.runs}/${gameState.team2.wickets} (${formatOvers(gameState.team2.balls)})`;
      }
    }

    // Update players panel
    function updatePlayersPanel() {
      // Batters
      battersList.innerHTML = '';
      gameState.batters.forEach(batter => {
        const li = document.createElement('li');
        li.className = 'player-item';
        if (batter.active) li.classList.add('active');
        if (batter.out) li.classList.add('out');
        
        const stats = `${batter.runs} (${batter.balls})`;
        
        li.innerHTML = `
          <div>
            <span class="player-name">${batter.name}</span>
            ${batter.isCaptain ? ' (C)' : ''}
            ${batter.isViceCaptain ? ' (VC)' : ''}
            <div class="wicket-bar">
              <div class="wicket-progress" style="width: ${(1 - batter.wicket) * 100}%"></div>
            </div>
          </div>
          <span class="player-stats">${stats}</span>
        `;
        
        battersList.appendChild(li);
      });
      
      // Bowlers
      bowlersList.innerHTML = '';
      gameState.bowlers.forEach(bowler => {
        const li = document.createElement('li');
        li.className = 'player-item';
        if (bowler.active) li.classList.add('active');
        
        const overs = `${Math.floor(bowler.balls / 6)}.${bowler.balls % 6}`;
        const stats = `${bowler.wickets}/${bowler.runsConceded} (${overs})`;
        
        li.innerHTML = `
          <div>
            <span class="player-name">${bowler.name}</span>
            ${bowler.isCaptain ? ' (C)' : ''}
            ${bowler.isViceCaptain ? ' (VC)' : ''}
          </div>
          <span class="player-stats">${stats}</span>
        `;
        
        bowlersList.appendChild(li);
      });
    }

    // Update match status
    function updateMatchStatus() {
      if (!gameState.team1 || !gameState.team2) return;
      
      let status = '';
      
      if (gameState.matchComplete) {
        status = 'Match completed';
      } else if (gameState.currentInnings === 1) {
        const battingTeam = gameState.team1.batting ? gameState.team1 : gameState.team2;
        status = `${battingTeam.name} batting - ${battingTeam.runs}/${battingTeam.wickets} (${formatOvers(battingTeam.balls)})`;
        
        if (gameState.powerplay) {
          status += ' - Powerplay';
        } else if (gameState.deadOver) {
          status += ' - Dead Over';
        }
      } else if (gameState.currentInnings === 2) {
        const battingTeam = gameState.team1.batting ? gameState.team1 : gameState.team2;
        const target = (gameState.team1.batting ? gameState.team2.runs : gameState.team1.runs) + 1;
        status = `${battingTeam.name} batting - ${battingTeam.runs}/${battingTeam.wickets} (${formatOvers(battingTeam.balls)}), Target: ${target}`;
        
        if (gameState.powerplay) {
          status += ' - Powerplay';
        } else if (gameState.deadOver) {
          status += ' - Dead Over';
        }
      }
      
      matchStatus.textContent = status;
    }

    // Show teams modal
    function showTeamsModal() {
      if (!gameState.team1 || !gameState.team2) return;
      
      // Team 1 players
      modalTeam1Players.innerHTML = '';
      gameState.team1.players.forEach(player => {
        const li = document.createElement('li');
        li.className = 'team-player';
        if (player === gameState.team1.captain) li.classList.add('captain');
        if (player === gameState.team1.viceCaptain) li.classList.add('vice-captain');
        li.textContent = player;
        modalTeam1Players.appendChild(li);
      });
      
      // Team 2 players
      modalTeam2Players.innerHTML = '';
      gameState.team2.players.forEach(player => {
        const li = document.createElement('li');
        li.className = 'team-player';
        if (player === gameState.team2.captain) li.classList.add('captain');
        if (player === gameState.team2.viceCaptain) li.classList.add('vice-captain');
        li.textContent = player;
        modalTeam2Players.appendChild(li);
      });
      
      // Show modal
      teamsModal.classList.add('active');
    }

    // Save game state to Firebase
    function saveGameState() {
      if (!gameState.team1 || !gameState.team2) return;
      
      const gameStateData = {
        currentInnings: gameState.currentInnings,
        team1: gameState.team1,
        team2: gameState.team2,
        batters: gameState.batters,
        bowlers: gameState.bowlers,
        selectedBatter: gameState.selectedBatter,
        selectedBowler: gameState.selectedBowler,
        currentOver: gameState.currentOver,
        powerplay: gameState.powerplay,
        deadOver: gameState.deadOver,
        matchComplete: gameState.matchComplete
      };
      
      update(ref(db, `rooms/${roomId}`), {
        gameState: gameStateData
      }).catch(error => {
        console.error("Error saving game state:", error);
      });
    }

    // Initialize the game
    initGame();
  </script>
</body>
</html>