<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>HandiCricket - First Innings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    body { 
      background: #061e3e url('https://images.unsplash.com/photo-1608096299210-db7e38487075?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2000&q=80') no-repeat center center fixed;
      background-size: cover;
      color: white; 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      text-align: center; 
      padding: 8px;
      margin: 0;
      overflow-x: hidden;
      position: relative;
    }
    
    body::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(6, 30, 62, 0.85);
      z-index: -1;
    }
    
    /* Stadium effects */
    .stadium-effects {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: -1;
      overflow: hidden;
    }
    
    .crowd {
      position: absolute;
      bottom: 0;
      width: 100%;
      height: 100px;
      background: url('https://i.imgur.com/JQJQZQK.png') repeat-x;
      background-size: contain;
      opacity: 0.3;
      animation: crowdMove 20s linear infinite;
    }
    
    @keyframes crowdMove {
      0% { background-position: 0 0; }
      100% { background-position: -1000px 0; }
    }
    
    .pitch {
      position: absolute;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      width: 80%;
      height: 300px;
      background: linear-gradient(to bottom, #2a5c2a, #1e3e1e);
      border-radius: 50% 50% 0 0;
      box-shadow: 0 0 50px rgba(0,0,0,0.5);
    }
    
    h1 { 
      margin: 8px 0 12px;
      color: #ffeb3b;
      text-shadow: 0 0 5px rgba(255, 235, 59, 0.5);
      font-size: 1.5rem;
    }
    
    .container {
      max-width: 100%;
      width: 100%;
      margin: 0 auto;
      background: rgba(0, 0, 0, 0.4);
      border-radius: 10px;
      padding: 8px;
      box-sizing: border-box;
      backdrop-filter: blur(5px);
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    
    /* Enhanced Scoreboard */
    .scorebox-main {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px;
      background: rgba(13, 42, 82, 0.8);
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }

    .team-score {
      display: flex;
      flex-direction: column;
    }

    .score-large {
      font-size: 1.8rem;
      font-weight: bold;
      color: #ffeb3b;
    }

    .score-details {
      text-align: right;
      font-size: 0.85rem;
    }

    /* Live score ticker */
    .live-ticker {
      background: linear-gradient(90deg, #1e88e5, #0d47a1);
      color: white;
      padding: 6px;
      border-radius: 4px;
      margin: 6px 0;
      font-size: 0.8rem;
      white-space: nowrap;
      overflow: hidden;
      position: relative;
    }
    
    .ticker-content {
      display: inline-block;
      padding-left: 100%;
      animation: ticker 20s linear infinite;
    }
    
    @keyframes ticker {
      0% { transform: translateX(0); }
      100% { transform: translateX(-100%); }
    }
    
    .ticker-item {
      display: inline-block;
      margin-right: 30px;
    }
    
    .ticker-item span {
      margin: 0 5px;
      color: #ffeb3b;
      font-weight: bold;
    }

    /* Match Info Bar */
    .match-info-bar {
      display: flex;
      justify-content: center;
      align-items: center;
      background: rgba(13, 42, 82, 0.5);
      padding: 6px 8px;
      border-radius: 6px;
      margin: 4px 0 8px 0;
      font-size: 0.75rem;
      gap: 6px;
      flex-wrap: wrap;
    }

    .match-info-item {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 45%;
    }

    .divider {
      color: #666;
      flex-shrink: 0;
    }

    /* Over Progress */
    .over-progress {
      background: rgba(13, 42, 82, 0.5);
      padding: 6px;
      border-radius: 6px;
      margin: 6px 0;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .over-title {
      font-size: 0.75rem;
      color: #aaa;
      margin-bottom: 4px;
    }

    .balls-container {
      display: flex;
      gap: 4px;
    }

    .ball {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: bold;
      transition: transform 0.2s;
    }

    .ball.dot {
      background: #333;
      color: white;
    }

    .ball.run {
      background: #4CAF50;
      color: white;
    }

    .ball.wicket {
      background: #F44336;
      color: white;
    }

    .ball.wide {
      background: #FF9800;
      color: white;
    }

    .ball.noball {
      background: #9C27B0;
      color: white;
    }

    .ball.empty {
      background: rgba(255,255,255,0.1);
    }

    .over-number {
      text-align: right;
      font-size: 0.75rem;
      margin-top: 4px;
      color: #aaa;
    }

    /* Timeline Styles */
    .timeline-container {
      background: rgba(13, 42, 82, 0.7);
      border-radius: 8px;
      margin: 8px 0;
      padding: 6px;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .timeline-container h4 {
      margin: 0 0 6px 0;
      font-size: 0.85rem;
    }

    .timeline {
      display: flex;
      overflow-x: auto;
      gap: 6px;
      padding-bottom: 4px;
    }

    .timeline-item {
      min-width: 70px;
      padding: 4px;
      border-radius: 4px;
      background: rgba(30, 136, 229, 0.2);
      font-size: 0.7rem;
      text-align: center;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .timeline-item.wicket {
      background: rgba(244, 67, 54, 0.2);
      border-left: 2px solid #F44336;
    }

    .timeline-item.boundary {
      background: rgba(255, 193, 7, 0.2);
      border-left: 2px solid #FFC107;
    }

    .timeline-item.milestone {
      background: rgba(76, 175, 80, 0.2);
      border-left: 2px solid #4CAF50;
    }

    .timeline-over {
      font-weight: bold;
      margin-bottom: 2px;
    }

    .timeline-event {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Player Comparison Styles - Enhanced */
    .comparison-container {
      background: rgba(13, 42, 82, 0.7);
      border-radius: 8px;
      margin: 8px 0;
      padding: 6px;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .comparison-container h4 {
      margin: 0 0 6px 0;
      font-size: 0.85rem;
    }

    .comparison-box {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .player-comparison {
      flex: 1;
      padding: 6px;
      border-radius: 6px;
      text-align: center;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .batter-comparison {
      background: rgba(76, 175, 80, 0.1);
      border-left: 3px solid #4CAF50;
    }

    .bowler-comparison {
      background: rgba(244, 67, 54, 0.1);
      border-left: 3px solid #F44336;
    }

    .comparison-header {
      font-size: 0.65rem;
      text-transform: uppercase;
      color: #aaa;
      margin-bottom: 4px;
    }

    .comparison-name {
      font-weight: bold;
      margin: 4px 0;
      font-size: 0.85rem;
    }
    
    .comparison-name.highlight {
      animation: highlightPlayer 2s infinite;
    }
    
    @keyframes highlightPlayer {
      0% { text-shadow: 0 0 5px rgba(255,255,255,0.5); }
      50% { text-shadow: 0 0 15px gold; }
      100% { text-shadow: 0 0 5px rgba(255,255,255,0.5); }
    }

    .comparison-stats {
      font-size: 0.75rem;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
    }

    .comparison-stats div {
      flex: 1;
      min-width: 50%;
      margin: 2px 0;
    }

    .vs-circle {
      width: 30px;
      height: 30px;
      background: #1e88e5;
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 0.65rem;
      border: 2px solid white;
    }

    /* Animations */
    @keyframes scoreIncrease {
      0% { transform: scale(1); color: white; }
      50% { transform: scale(1.3); color: #4CAF50; }
      100% { transform: scale(1); color: white; }
    }

    @keyframes wicketFlash {
      0% { background-color: rgba(244, 67, 54, 0); }
      50% { background-color: rgba(244, 67, 54, 0.3); }
      100% { background-color: rgba(244, 67, 54, 0); }
    }

    @keyframes boundary {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); color: #FFC107; }
      100% { transform: scale(1); }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes ballTrail {
      0% { transform: translateX(0) translateY(0); opacity: 1; }
      100% { transform: translateX(100px) translateY(-50px); opacity: 0; }
    }
    
    @keyframes stumpFall {
      0% { transform: rotate(0); }
      100% { transform: rotate(-45deg); }
    }
    
    @keyframes screenShake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      50% { transform: translateX(5px); }
      75% { transform: translateX(-5px); }
    }
    
    @keyframes ripple {
      0% { transform: scale(0.5); opacity: 1; }
      100% { transform: scale(3); opacity: 0; }
    }

    .score-change {
      animation: scoreIncrease 0.8s ease-in-out;
    }

    .wicket-flash {
      animation: wicketFlash 1.5s ease-in-out;
    }

    .boundary-flash {
      animation: boundary 1s ease-in-out;
    }
    
    .screen-shake {
      animation: screenShake 0.5s ease-in-out;
    }

    /* Card Buttons */
    .card-btns { 
      margin: 10px auto;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 6px;
      position: relative;
    }
    
    .card-btns button { 
      width: 50px;
      height: 50px;
      font-size: 18px;
      border-radius: 8px;
      border: none;
      background: linear-gradient(145deg, #1e88e5, #1565c0);
      color: white;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
    }
    
    .card-btns button::after {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: rgba(255,255,255,0.1);
      transform: rotate(45deg);
      transition: all 0.3s;
      opacity: 0;
    }
    
    .card-btns button:hover::after {
      opacity: 1;
      top: -30%;
      left: -30%;
    }
    
    .card-btns button:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 8px rgba(0, 0, 0, 0.3);
    }
    
    .card-btns button:active {
      transform: translateY(1px);
    }
    
    .card-btns button:disabled { 
      background: #607d8b;
      color: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .card-btns button.selected {
      background: #4caf50;
      border: 2px solid #ffeb3b;
      transform: scale(1.05);
    }
    
    /* Status Indicators */
    #statusIndicators {
      margin: 6px 0;
      display: flex;
      justify-content: center;
      gap: 6px;
      flex-wrap: wrap;
    }
    
    .free-hit-indicator,
    .powerplay-indicator,
    .dead-over {
      padding: 3px 6px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
      margin: 0 2px;
      display: inline-block;
    }
    
    .free-hit-indicator {
      background: #4CAF50;
      color: white;
      animation: pulse 1.5s infinite;
    }
    
    .powerplay-indicator {
      background: #ffeb3b;
      color: #000;
      animation: pulse 2s infinite;
    }
    
    .dead-over {
      background: #f44336;
      color: white;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    /* Result Display */
    #result {
      font-size: 15px;
      margin: 8px 0;
      padding: 6px;
      min-height: 45px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.5);
      border-radius: 6px;
      border-left: 3px solid #1e88e5;
    }
    
    #result.error {
      color: #ff4444;
      background: rgba(255, 0, 0, 0.1);
      padding: 6px;
      border-radius: 4px;
      border-left: 3px solid #ff4444;
    }
    
    /* Connection Status */
    #connectionStatus {
      padding: 6px;
      border-radius: 6px;
      text-align: center;
      margin: 8px auto;
      max-width: 250px;
      font-weight: bold;
      font-size: 13px;
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .online { 
      background: #4CAF50;
      color: white;
    }
    
    .offline { 
      background: #F44336;
      color: white;
    }
    
    /* Selection Modal */
    .selection-modal { 
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 350px;
      background: linear-gradient(145deg, #123456, #0a1f3a);
      padding: 10px;
      border-radius: 12px;
      margin-bottom: 12px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.1);
      z-index: 100;
      display: none;
    }
    
    .selection-list { 
      max-height: 50vh;
      overflow-y: auto;
      margin: 6px 0;
      padding-right: 4px;
    }
    
    .player-item, .batter-item {
      padding: 6px;
      margin: 3px 0;
      background: rgba(30, 136, 229, 0.2);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      border-left: 3px solid transparent;
      font-size: 13px;
    }
    
    .player-item:hover, .batter-item:hover {
      background: rgba(30, 136, 229, 0.4);
      transform: translateX(5px);
    }
    
    .player-item.selected, .batter-item.selected {
      background: rgba(13, 71, 161, 0.6);
      border-left: 3px solid #ffeb3b;
    }
    
    /* Top Controls */
    #topControls {
      display: flex;
      justify-content: center;
      gap: 6px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    
    #topControls button {
      padding: 6px 10px;
      border: none;
      border-radius: 6px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    #saveBtn { 
      background: #FF9800;
      color: white;
    }
    
    #saveBtn:hover {
      background: #F57C00;
    }
    
    #exitBtn { 
      background: #f44336;
      color: white;
    }
    
    #exitBtn:hover {
      background: #d32f2f;
    }
    
    #resetPlaysBtn { 
      background: #9c27b0;
      color: white;
    }
    
    #resetPlaysBtn:hover {
      background: #7b1fa2;
    }
    
    /* Teams Modal */
    .teams-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 1000;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .teams-container {
      width: 90%;
      max-width: 320px;
      height: 65vh;
      display: flex;
      overflow: hidden;
      position: relative;
      scroll-snap-type: x mandatory;
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
    }

    .team-slide {
      min-width: 100%;
      height: 100%;
      padding: 8px;
      background: rgba(13, 42, 82, 0.9);
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      overflow-y: auto;
      scroll-snap-align: start;
      flex-shrink: 0;
      box-sizing: border-box;
    }

    .team-slide h3 {
      text-align: center;
      margin-bottom: 6px;
      color: #ffeb3b;
      border-bottom: 2px solid #1e88e5;
      padding-bottom: 3px;
      font-size: 0.95rem;
      position: sticky;
      top: 0;
      background: rgba(13, 42, 82, 0.9);
      z-index: 1;
    }

    .team-slide ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .team-slide li {
      padding: 6px 8px;
      margin: 3px 0;
      background: rgba(30, 136, 229, 0.2);
      border-radius: 6px;
      border-left: 2px solid #1e88e5;
      transition: all 0.3s;
      font-size: 13px;
      word-break: break-word;
      overflow-wrap: break-word;
    }

    .team-slide li:hover {
      background: rgba(30, 136, 229, 0.4);
      transform: translateX(5px);
    }

    .close-teams {
      position: absolute;
      top: 12px;
      right: 12px;
      background: #f44336;
      color: white;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      font-size: 16px;
      cursor: pointer;
      z-index: 1001;
      transition: all 0.2s;
    }
    
    .close-teams:hover {
      transform: scale(1.1);
    }

    .teams-nav {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-top: 12px;
    }

    .team-nav-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 5px;
      background: #1e88e5;
      color: white;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.2s;
    }
    
    .team-nav-btn:hover {
      background: #1565c0;
    }

    .team-nav-btn:disabled {
      background: #666;
      cursor: not-allowed;
    }

    .team-nav-indicator {
      display: flex;
      gap: 6px;
      margin-top: 8px;
    }

    .team-nav-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #555;
      cursor: pointer;
      transition: all 0.2s;
    }

    .team-nav-dot.active {
      background: #1e88e5;
      transform: scale(1.2);
    }

    .show-teams-btn {
      padding: 8px 16px;
      font-size: 13px;
      border: none;
      border-radius: 8px;
      background: linear-gradient(135deg, #9c27b0, #7b1fa2);
      color: white;
      cursor: pointer;
      margin: 12px auto;
      display: block;
      transition: all 0.3s;
    }

    .show-teams-btn:hover {
      background: linear-gradient(135deg, #7b1fa2, #6a1b9a);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    /* Team Names Display */
    .team-names-compact {
      margin-bottom: 8px;
      font-size: 13px;
      background: rgba(13, 42, 82, 0.5);
      padding: 6px;
      border-radius: 6px;
      text-align: center;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .team-name-line {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
      gap: 4px;
    }

    .team-label {
      color: #aaa;
      font-size: 11px;
    }

    .team-divider {
      color: #666;
      margin: 0 4px;
    }

    /* Over Summary */
    .over-summary-container {
      margin: 8px 0;
      padding: 6px;
      background: rgba(13, 42, 82, 0.5);
      border-radius: 6px;
      max-height: 100px;
      overflow-y: auto;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .over-summary-item {
      padding: 3px;
      margin: 3px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      font-size: 12px;
    }

    /* Spectator Mode */
    .spectator-mode {
      background: #9c27b0;
      padding: 3px 6px;
      border-radius: 15px;
      margin-bottom: 6px;
      display: inline-block;
      font-size: 11px;
      animation: pulse 2s infinite;
    }

    /* Milestone Notifications */
    .milestone-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 15px;
      z-index: 1001;
      animation: fadeInOut 3s forwards;
      box-shadow: 0 4px 15px rgba(0,0,0,0.5);
      border: 1px solid rgba(255,255,255,0.2);
      max-width: 250px;
    }
    
    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateY(5px); }
      10% { opacity: 1; transform: translateY(0); }
      90% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(5px); }
    }
    
    .milestone-notification.batting {
      border-left: 4px solid #4CAF50;
    }
    
    .milestone-notification.error {
      border-left: 4px solid #F44336;
    }
    
    .milestone-notification.info {
      border-left: 4px solid #FFC107;
    }
    
    .milestone-notification.winner {
      border-left: 4px solid #9C27B0;
      font-size: 18px;
      background: linear-gradient(135deg, rgba(0,0,0,0.9), rgba(70,0,100,0.9));
    }
    
    /* Confetti */
    .confetti {
      position: fixed;
      width: 8px;
      height: 8px;
      background-color: #f00;
      animation: confetti-fall 5s linear forwards;
      z-index: 1000;
    }
    
    @keyframes confetti-fall {
      0% {
        transform: translateY(-100vh) rotate(0deg);
        opacity: 1;
      }
      100% {
        transform: translateY(100vh) rotate(360deg);
        opacity: 0;
      }
    }
    
    /* Loading Spinner */
    .loading-spinner {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 3px solid #1e88e5;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 12px auto;
      display: none;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Reset Notification */
    .reset-notification {
      position: fixed;
      top: 20%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.9);
      color: white;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 13px;
      z-index: 1001;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      display: flex;
      flex-direction: column;
      gap: 6px;
      width: 80%;
      max-width: 280px;
      border: 1px solid rgba(255,255,255,0.2);
    }
    
    .reset-notification-buttons {
      display: flex;
      justify-content: center;
      gap: 6px;
    }
    
    .reset-notification button {
      padding: 4px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      font-size: 11px;
      transition: all 0.2s;
    }
    
    .reset-accept {
      background: #4CAF50;
      color: white;
    }
    
    .reset-accept:hover {
      background: #388E3C;
    }
    
    .reset-decline {
      background: #f44336;
      color: white;
    }
    
    .reset-decline:hover {
      background: #d32f2f;
    }
    
    /* Innings Summary Popup - Updated to match image */
    .summary-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(145deg, #123456, #0a1f3a);
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.1);
      z-index: 1001;
      text-align: center;
      color: white;
      max-width: 320px;
      width: 90%;
      display: none;
    }
    
    .summary-popup h3 {
      margin-top: 0;
      color: #ffeb3b;
      font-size: 1.2rem;
      border-bottom: 2px solid #1e88e5;
      padding-bottom: 6px;
      margin-bottom: 12px;
    }
    
    .summary-content {
      text-align: left;
      margin-bottom: 12px;
    }
    
    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
      font-size: 13px;
    }
    
    .summary-label {
      color: #aaa;
    }
    
    .summary-value {
      font-weight: bold;
    }
    
    .summary-highlight {
      background: rgba(255, 235, 59, 0.2);
      padding: 4px;
      border-radius: 4px;
      margin: 8px 0;
      font-weight: bold;
      text-align: center;
      border-left: 3px solid #ffeb3b;
    }
    
    .summary-countdown {
      font-size: 22px;
      font-weight: bold;
      margin: 8px 0;
      color: #4CAF50;
    }
    
    .summary-popup button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 15px;
      cursor: pointer;
      margin-top: 8px;
      transition: all 0.3s;
      width: 100%;
    }
    
    .summary-popup button:hover {
      background: #388E3C;
      transform: scale(1.05);
    }
    
    /* Match graphics */
    .match-graphics {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 999;
    }
    
    .ball-trail {
      position: absolute;
      width: 10px;
      height: 10px;
      background: white;
      border-radius: 50%;
      z-index: 1000;
      animation: ballTrail 0.5s forwards;
    }
    
    .stump {
      position: absolute;
      width: 5px;
      height: 30px;
      background: #8B4513;
      bottom: 50px;
      transform-origin: bottom center;
    }
    
    .stump.left {
      left: calc(50% - 15px);
    }
    
    .stump.middle {
      left: 50%;
      transform: translateX(-50%);
    }
    
    .stump.right {
      left: calc(50% + 10px);
    }
    
    .stump.bail {
      width: 20px;
      height: 5px;
      background: #D2B48C;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
    }
    
    .ripple-effect {
      position: absolute;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: rgba(255,255,255,0.5);
      animation: ripple 1s forwards;
      z-index: 999;
    }
    
    /* Mini scorecard */
    .mini-scorecard {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: rgba(0,0,0,0.7);
      padding: 8px;
      border-radius: 6px;
      font-size: 12px;
      z-index: 100;
      border: 1px solid rgba(255,255,255,0.2);
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    
    .mini-scorecard .score {
      font-weight: bold;
      color: #ffeb3b;
    }
    
    /* Match awards */
    .awards-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
      justify-content: center;
    }
    
    .award-badge {
      background: rgba(255,215,0,0.2);
      border: 1px solid gold;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
    }
    
    /* Stats charts */
    .stats-chart {
      width: 100%;
      height: 100px;
      margin: 10px 0;
      background: rgba(255,255,255,0.1);
      border-radius: 4px;
      position: relative;
      overflow: hidden;
    }
    
    .chart-bar {
      position: absolute;
      bottom: 0;
      background: #1e88e5;
      width: 20px;
      transition: height 0.5s;
    }
    
    /* Umpire signals */
    .umpire-signal {
      position: fixed;
      bottom: 20%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 10px;
      border-radius: 50%;
      font-size: 24px;
      z-index: 1001;
      animation: fadeInOut 2s forwards;
    }
    
    /* Weather effects */
    .weather-rain {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url('https://i.imgur.com/JQJQZQK.png');
      opacity: 0.3;
      z-index: 999;
      pointer-events: none;
      animation: rain 0.5s linear infinite;
    }
    
    @keyframes rain {
      0% { background-position: 0 0; }
      100% { background-position: 0 100px; }
    }
    
    /* Stats slides */
    .stats-slide {
      min-width: 100%;
      height: 100%;
      padding: 8px;
      background: rgba(13, 42, 82, 0.9);
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      overflow-y: auto;
      scroll-snap-align: start;
      flex-shrink: 0;
      box-sizing: border-box;
    }
    
    .stats-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-top: 8px;
    }
    
    .stats-table th, .stats-table td {
      padding: 4px;
      text-align: left;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .stats-table th {
      position: sticky;
      top: 0;
      background: rgba(13, 42, 82, 0.9);
      color: #ffeb3b;
    }
    
    .stats-table tr:nth-child(even) {
      background: rgba(30, 136, 229, 0.1);
    }
    
    .stats-table tr:hover {
      background: rgba(30, 136, 229, 0.2);
    }
    
    /* Commentary styles */
    .commentary-item {
      padding: 6px;
      margin: 4px 0;
      background: rgba(30, 136, 229, 0.1);
      border-radius: 4px;
      font-size: 12px;
      border-left: 3px solid #1e88e5;
    }
    
    .commentary-over {
      font-weight: bold;
      color: #ffeb3b;
      margin-bottom: 2px;
    }
    
    .commentary-text {
      font-style: italic;
    }
    
    /* Responsive Styles */
    @media (max-width: 768px) {
      .card-btns button {
        width: 45px;
        height: 45px;
        font-size: 16px;
      }
      
      .selection-modal {
        width: 95%;
        max-height: 60vh;
      }
      
      .teams-container {
        width: 95%;
        max-width: 350px;
        height: 55%;
      }
      
      .team-slide {
        min-width: 100%;
      }
    }
    
    @media (max-width: 480px) {
      body {
        padding: 6px;
      }
      
      .container {
        padding: 8px;
      }
      
      h1 {
        font-size: 1.3rem;
        margin: 6px 0 10px;
      }
      
      .card-btns button {
        width: 40px;
        height: 40px;
        font-size: 15px;
      }
      
      .selection-modal {
        padding: 8px;
      }
      
      .player-item, .batter-item {
        padding: 5px;
        font-size: 12px;
      }
      
      #topControls button {
        padding: 5px 8px;
        font-size: 10px;
      }
      
      .team-slide h3 {
        font-size: 0.9rem;
      }
      
      .team-slide li {
        font-size: 11px;
        padding: 5px 6px;
      }
      
      .team-names {
        flex-direction: column;
        gap: 4px;
      }
      
      .teams-container {
        height: 70vh;
        max-width: 300px;
      }

      .score-large {
        font-size: 1.5rem;
      }
      
      .match-info-bar {
        font-size: 0.7rem;
      }
    }
</style>
</head>
<body>
  <div class="stadium-effects">
    <div class="crowd"></div>
    <div class="pitch"></div>
  </div>
  
  <div class="match-graphics" id="matchGraphics"></div>
  
  <div class="container">
    <div class="team-names-compact">
      <div class="team-name-line">
        <span class="team-label">Batting:</span>
        <span id="team1Name">Team A</span>
        <span class="team-divider">|</span>
        <span class="team-label">Bowling:</span>
        <span id="team2Name">Team B</span>
      </div>
    </div>
    
    <!-- Live score ticker -->
    <div class="live-ticker">
      <div class="ticker-content" id="tickerContent">
        <div class="ticker-item">Partnership: <span id="tickerPartnership">0</span> runs (<span id="tickerPartnershipBalls">0</span> balls)</div>
        <div class="ticker-item">Run Rate: <span id="tickerRunRate">0.00</span></div>
        <div class="ticker-item">Last 5 Overs: <span id="tickerLast5">0/0</span></div>
        <div class="ticker-item">Required Rate: <span id="tickerRequiredRate">0.00</span></div>
      </div>
    </div>
    
    <!-- Enhanced Scoreboard -->
    <div class="scorebox">
      <div class="scorebox-main">
        <div class="team-score">
          <span id="battingTeamName">Team A</span>
          <span class="score-large"><span id="runs">0</span>/<span id="wickets">0</span></span>
        </div>
        <div class="score-details">
          <div>Overs: <strong id="overs">0.0</strong></div>
          <div>Run Rate: <strong id="runRate">0.00</strong></div>
        </div>
      </div>
    </div>
    
    <!-- Match Info Bar -->
    <div class="match-info-bar">
      <div class="match-format" id="formatDisplay"></div>
      <div class="match-status">
        <span id="inningsNumber">1st Innings</span>
        <span class="divider">|</span>
        <span id="roleText"></span>
      </div>
      <div class="match-time">
        <span id="currentTime">14:30</span>
        <span class="divider">|</span>
        <span id="matchDate">23 Jul 2023</span>
      </div>
    </div>
    
    <!-- Over Progress -->
    <div class="over-progress">
      <div class="over-title">Current Over</div>
      <div class="balls-container" id="ballsContainer">
        <!-- Balls will be added dynamically -->
      </div>
      <div class="over-number">Over <span id="currentOverNumber">1</span></div>
    </div>
    
    <!-- Match Timeline -->
    <div class="timeline-container">
      <h4>Match Timeline</h4>
      <div class="timeline" id="matchTimeline">
        <!-- Timeline items will be added here -->
      </div>
    </div>
    
    <!-- Enhanced Player Comparison -->
    <div class="comparison-container">
      <h4>Current Battle</h4>
      <div class="comparison-box">
        <div class="player-comparison batter-comparison">
          <div class="comparison-header">Batter</div>
          <div class="comparison-name" id="comparisonBatterName">-</div>
          <div class="comparison-stats">
            <div>Runs: <span id="comparisonBatterRuns">0</span></div>
            <div>Balls: <span id="comparisonBatterBalls">0</span></div>
            <div>SR: <span id="comparisonBatterSR">0.00</span></div>
            <div>4s/6s: <span id="comparisonBatterBoundaries">0/0</span></div>
          </div>
        </div>
        <div class="vs-circle">VS</div>
        <div class="player-comparison bowler-comparison">
          <div class="comparison-header">Bowler</div>
          <div class="comparison-name" id="comparisonBowlerName">-</div>
          <div class="comparison-stats">
            <div>Overs: <span id="comparisonBowlerOvers">0.0</span></div>
            <div>Wkts: <span id="comparisonBowlerWickets">0</span></div>
            <div>ER: <span id="comparisonBowlerER">0.00</span></div>
            <div>Runs: <span id="comparisonBowlerRuns">0</span></div>
          </div>
        </div>
      </div>
    </div>
    
    <div id="statusIndicators">
      <span id="powerplayIndicator" class="powerplay-indicator" style="display: none;">Powerplay</span>
      <span id="deadOverIndicator" class="dead-over" style="display: none;">Dead Over</span>
      <span id="freeHitIndicator" class="free-hit-indicator" style="display: none;">Free Hit</span>
    </div>
    
    <div id="result">Initializing game...</div>
    
    <div class="card-btns" id="cardButtons">
      <button class="btn" data-value="0">0</button>
      <button class="btn" data-value="1">1</button>
      <button class="btn" data-value="2">2</button>
      <button class="btn" data-value="3">3</button>
      <button class="btn" data-value="4">4</button>
      <button class="btn" data-value="5">5</button>
      <button class="btn" data-value="6">6</button>
    </div>

    <div class="over-summary-container">
      <h4>Over Summary</h4>
      <div id="overSummaryList"></div>
    </div>

    <button class="show-teams-btn" id="showTeamsBtn">Show Teams</button>

    <div id="topControls">
      <button id="saveBtn">💾 Save & Exit</button>
      <button id="exitBtn">🚪 Exit Without Saving</button>
      <button id="resetPlaysBtn">🔄 Reset Plays</button>
    </div>
    <div id="connectionStatus" class="online">
      Opponent: Online
    </div>
    
    <div id="loading-spinner" class="loading-spinner"></div>
  </div>
  
  <!-- Mini scorecard that stays visible when scrolling -->
  <div class="mini-scorecard" id="miniScorecard" style="display: none;">
    <span id="miniScore">0/0</span> (<span id="miniOvers">0.0</span>)
  </div>
  
  <div id="selectionModal" class="selection-modal">
    <h3 id="selectionTitle">Select Next Batter</h3>
    <div id="selectionList" class="selection-list"></div>
    <button id="confirmSelection">Confirm Selection</button>
  </div>

  <div id="teamsModal" class="teams-modal">
    <button class="close-teams" id="closeTeamsBtn">×</button>
    <div class="teams-container" id="teamsSlider">
      <div class="team-slide" id="team1Slide">
        <h3 id="modalTeam1Name">Team 1</h3>
        <ul id="modalTeam1Players"></ul>
      </div>
      <div class="team-slide" id="team2Slide">
        <h3 id="modalTeam2Name">Team 2</h3>
        <ul id="modalTeam2Players"></ul>
      </div>
    </div>
    <div class="teams-nav">
      <button class="team-nav-btn" id="prevTeamBtn" disabled>Previous</button>
      <button class="team-nav-btn" id="nextTeamBtn">Next</button>
    </div>
    <div class="team-nav-indicator">
      <div class="team-nav-dot active" data-index="0"></div>
      <div class="team-nav-dot" data-index="1"></div>
    </div>
  </div>

  <!-- Enhanced Innings Summary Popup with stats slides -->
  <div id="summaryPopup" class="summary-popup">
    <h3 id="summaryTitle">First Innings Summary</h3>
    <div class="summary-content">
      <div class="summary-row">
        <span class="summary-label">Total Runs:</span>
        <span class="summary-value" id="summaryTotalRuns">0</span>
      </div>
      <div class="summary-row">
        <span class="summary-label">Wickets:</span>
        <span class="summary-value" id="summaryWickets">0</span>
      </div>
      <div class="summary-row">
        <span class="summary-label">Overs:</span>
        <span class="summary-value" id="summaryOvers">0.0</span>
      </div>
      <div class="summary-row">
        <span class="summary-label">Run Rate:</span>
        <span class="summary-value" id="summaryRunRate">0.00</span>
      </div>
      <div class="summary-highlight" id="summaryHighlight"></div>
      
      <!-- Stats slides container -->
      <div class="teams-container" id="statsSlider" style="height: 200px; margin: 10px 0;">
        <!-- Batters stats slide -->
        <div class="stats-slide">
          <h4>Batting Stats</h4>
          <table class="stats-table" id="battersStatsTable">
            <thead>
              <tr>
                <th>Batter</th>
                <th>Runs</th>
                <th>Balls</th>
                <th>SR</th>
                <th>4s/6s</th>
              </tr>
            </thead>
            <tbody id="battersStatsBody"></tbody>
          </table>
        </div>
        
        <!-- Bowlers stats slide -->
        <div class="stats-slide">
          <h4>Bowling Stats</h4>
          <table class="stats-table" id="bowlersStatsTable">
            <thead>
              <tr>
                <th>Bowler</th>
                <th>Overs</th>
                <th>Wkts</th>
                <th>Runs</th>
                <th>ER</th>
              </tr>
            </thead>
            <tbody id="bowlersStatsBody"></tbody>
          </table>
        </div>
      </div>
      
      <!-- Stats navigation -->
      <div class="teams-nav">
        <button class="team-nav-btn" id="prevStatsBtn" disabled>Previous</button>
        <button class="team-nav-btn" id="nextStatsBtn">Next</button>
      </div>
      <div class="team-nav-indicator">
        <div class="team-nav-dot active" data-index="0"></div>
        <div class="team-nav-dot" data-index="1"></div>
      </div>
      
      <!-- Target display for second innings -->
      <div class="summary-row" id="targetDisplay" style="display: none;">
        <span class="summary-label">Target:</span>
        <span class="summary-value" id="targetValue">0</span>
      </div>
      
      <!-- Player of the match -->
      <div class="summary-row" id="pomDisplay" style="display: none;">
        <span class="summary-label">Player of the Match:</span>
        <span class="summary-value" id="pomValue">-</span>
      </div>
      
      <!-- Awards section -->
      <div class="awards-container" id="awardsContainer" style="display: none;">
        <!-- Awards will be added dynamically -->
      </div>
    </div>
    <button id="startSecondInningsBtn">🏏 Start Second Innings</button>
  </div>

  <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
import { 
  getDatabase, 
  ref, 
  onValue, 
  set, 
  get, 
  update, 
  push, 
  remove, 
  child 
} from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

// Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyCN6aZMwlsZe7JJaovU0WA3UQygWr4jYmA",
  authDomain: "handicricket-85a06.firebaseapp.com",
  projectId: "handicricket-85a06",
  storageBucket: "handicricket-85a06.appspot.com",
  messagingSenderId: "599182538558",
  appId: "1:599182538558:web:3e965753ab05f8f1e3de6f",
  measurementId: "G-HSV9H4LEJQ"
};

// Game Constants
const FORMAT_RULES = {
  "5": { 
    name: "5 Overs", 
    totalOvers: 5, 
    totalWickets: 10,
    powerplayOvers: 2, 
    powerplayWicketValue: 0.5,
    regularWicketValue: 1.0,
    deadOvers: []
  },
  "10": { 
    name: "10 Overs", 
    totalOvers: 10, 
    totalWickets: 10,
    powerplayOvers: 3, 
    powerplayWicketValue: 0.5,
    regularWicketValue: 1.0,
    deadOvers: []
  },
  "20": { 
    name: "T20", 
    totalOvers: 20, 
    totalWickets: 10,
    powerplayOvers: 6, 
    powerplayWicketValue: 0.5,
    regularWicketValue: 1.0,
    deadOvers: []
  },
  "50": { 
    name: "ODI", 
    totalOvers: 50, 
    totalWickets: 10,
    powerplayOvers: [1,10, 21,30, 41,42], 
    powerplayWicketValue: 0.25,
    regularWicketValue: 0.5,
    deadOvers: [11,20, 31,40]
  }
};

const COMMENTARY_PHRASES = {
  boundary: [
    "Cracked away to the boundary!",
    "What a shot! That races to the rope",
    "Timed to perfection, that's four runs"
  ],
  six: [
    "That's gone all the way! What a hit!",
    "Maximum! Clears the ropes with ease",
    "Launched into the stands! Six runs"
  ],
  wicket: [
    "That's a wicket! The bowler strikes",
    "Edged and taken! The fielders celebrate",
    "Clean bowled! That's a beauty"
  ],
  dotBall: [
    "Good line and length, defended solidly",
    "Dot ball, pressure building",
    "Play and a miss, good delivery"
  ],
  single: [
    "Tucked away for a comfortable single",
    "Quick run taken, good cricket",
    "Pushed into the gap for one"
  ],
  double: [
    "Well run, they come back for two",
    "Good placement, two runs added",
    "Comfortable two runs there"
  ],
  triple: [
    "Great running! Three taken",
    "They push hard and get three",
    "Excellent fielding keeps it to three"
  ],
  noBall: [
    "Oh dear, that's a no ball! Free hit coming up",
    "Overstepping! The umpire calls it a no ball",
    "That's a front foot no ball, extra delivery"
  ],
  freeHit: [
    "Free hit coming up! Big opportunity",
    "Batter can't be dismissed here",
    "Chance to swing freely on this free hit"
  ],
  powerplay: [
    "Powerplay restrictions in place",
    "Fielding restrictions apply now",
    "Only two fielders allowed outside the circle"
  ],
  milestone: [
    "That's a well-played half century",
    "Raises the bat for a fine fifty",
    "Magnificent century! What an innings"
  ],
  partnership: [
    "This partnership is building nicely",
    "Good understanding between these two",
    "They're rotating the strike well"
  ],
  runRate: [
    "The required rate is climbing now",
    "They're keeping up with the required rate",
    "The pressure is on with this run rate"
  ]
};

class CricketGame {
  constructor() {
    // DOM Elements
    this.elements = {
      result: document.getElementById("result"),
      scoreboard: document.querySelector(".scorebox"),
      buttons: document.querySelectorAll(".btn"),
      roleText: document.getElementById("roleText"),
      selectionModal: document.getElementById("selectionModal"),
      selectionTitle: document.getElementById("selectionTitle"),
      selectionList: document.getElementById("selectionList"),
      confirmSelection: document.getElementById("confirmSelection"),
      team1NameEl: document.getElementById("modalTeam1Name"),
      team2NameEl: document.getElementById("modalTeam2Name"),
      team1PlayersEl: document.getElementById("modalTeam1Players"),
      team2PlayersEl: document.getElementById("modalTeam2Players"),
      formatDisplay: document.getElementById("formatDisplay"),
      saveBtn: document.getElementById("saveBtn"),
      exitBtn: document.getElementById("exitBtn"),
      resetPlaysBtn: document.getElementById("resetPlaysBtn"),
      connectionStatus: document.getElementById("connectionStatus"),
      loadingSpinner: document.getElementById("loading-spinner"),
      powerplayIndicator: document.getElementById("powerplayIndicator"),
      deadOverIndicator: document.getElementById("deadOverIndicator"),
      freeHitIndicator: document.getElementById("freeHitIndicator"),
      showTeamsBtn: document.getElementById("showTeamsBtn"),
      teamsModal: document.getElementById("teamsModal"),
      closeTeamsBtn: document.getElementById("closeTeamsBtn"),
      teamsSlider: document.getElementById("teamsSlider"),
      overSummaryList: document.getElementById("overSummaryList"),
      team1NameDisplay: document.getElementById("team1Name"),
      team2NameDisplay: document.getElementById("team2Name"),
      battingTeamName: document.getElementById("battingTeamName"),
      summaryPopup: document.getElementById("summaryPopup"),
      startSecondInningsBtn: document.getElementById("startSecondInningsBtn"),
      matchGraphics: document.getElementById("matchGraphics"),
      miniScorecard: document.getElementById("miniScorecard"),
      runsDisplay: document.getElementById("runs"),
      wicketsDisplay: document.getElementById("wickets"),
      oversDisplay: document.getElementById("overs"),
      runRateDisplay: document.getElementById("runRate"),
      ballsContainer: document.getElementById("ballsContainer"),
      currentOverNumber: document.getElementById("currentOverNumber")
    };

    // Game State
    this.state = {
      runs: 0,
      wickets: 0,
      legalBalls: 0,
      freeHit: false,
      freeHitNextBall: false,
      currentBatter: null,
      currentBowler: null,
      isBatting: false,
      isPowerplay: false,
      isDeadOver: false,
      gameInProgress: true,
      lastOverRuns: 0,
      lastOverWickets: 0,
      lastWicketScore: 0,
      ballByBall: {},
      fallOfWickets: [],
      batterStats: {},
      bowlerStats: {},
      batterWickets: {},
      bowlerOvers: {},
      zerosThisOver: { player1: 0, player2: 0 },
      batterPenalties: {},
      lastBatterRuns: {},
      overSummaries: [],
      firstInningsCompleted: false,
      firstInningsData: null,
      target: 0,
      chasingTeam: null,
      secondInningsStarted: false,
      partnershipRuns: 0,
      partnershipBalls: 0,
      last5Runs: 0,
      last5Wickets: 0,
      last5Balls: 0,
      lastBoundaryTime: 0,
      selectedCardValue: null,
      isProcessingSelection: false,
      batterSelected: false,
      bowlerSelected: false,
      isResetting: false,
      resetCount: 0,
      MAX_RESETS: 5,
      isSpectator: false
    };

    // Teams Data
    this.teams = {
      team1Players: [],
      team2Players: [],
      team1Name: "Team A",
      team2Name: "Team B"
    };

    // Firebase References
    this.firebase = {
      app: null,
      db: null,
      roomRef: null,
      playerRef: null,
      opponentRef: null,
      playsRef: null,
      batterRef: null,
      bowlerRef: null,
      teamsRef: null,
      spectatorsRef: null,
      matchStatsRef: null,
      liveStateRef: null,
      overSummariesRef: null,
      resultRef: null,
      resetRequestRef: null,
      firstInningsRef: null,
      firstInningsCompletedRef: null,
      secondInningsStartedRef: null
    };

    // URL Parameters
    this.params = new URLSearchParams(window.location.search);
    this.roomId = this.params.get('room');
    this.playerRole = this.params.get('player') || 'player1';
    this.opponentRole = this.playerRole === "player1" ? "player2" : "player1";

    // Initialize the game
    this.init();
  }

  // Initialize the game
  async init() {
    try {
      this.showLoading("Initializing game...");
      
      // Initialize Firebase
      await this.initFirebase();
      
      // Check URL parameters
      this.validateParameters();
      
      // Setup game
      await this.setupGame();
      
      // Initialize UI
      this.initUI();
      
      // Setup event listeners
      this.setupEventListeners();
      
      // Start the game
      this.startGame();
      
    } catch (error) {
      this.handleInitError(error);
    }
  }

  // Initialize Firebase
  async initFirebase() {
    try {
      this.firebase.app = initializeApp(firebaseConfig);
      this.firebase.db = getDatabase(this.firebase.app);
      
      // Set up Firebase references
      this.setupFirebaseReferences();
      
    } catch (error) {
      console.error("Firebase initialization failed:", error);
      throw new Error("Failed to connect to game server. Please check your internet connection.");
    }
  }

  // Setup Firebase references
  setupFirebaseReferences() {
    this.firebase.roomRef = ref(this.firebase.db, `rooms/${this.roomId}`);
    this.firebase.playerRef = ref(this.firebase.db, `rooms/${this.roomId}/${this.playerRole}`);
    this.firebase.opponentRef = ref(this.firebase.db, `rooms/${this.roomId}/${this.opponentRole}`);
    this.firebase.playsRef = ref(this.firebase.db, `rooms/${this.roomId}/currentPlays`);
    this.firebase.batterRef = ref(this.firebase.db, `rooms/${this.roomId}/currentBatter`);
    this.firebase.bowlerRef = ref(this.firebase.db, `rooms/${this.roomId}/currentBowler`);
    this.firebase.teamsRef = ref(this.firebase.db, `rooms/${this.roomId}/teams`);
    this.firebase.spectatorsRef = ref(this.firebase.db, `rooms/${this.roomId}/spectators`);
    this.firebase.matchStatsRef = ref(this.firebase.db, `rooms/${this.roomId}/matchStats`);
    this.firebase.liveStateRef = ref(this.firebase.db, `rooms/${this.roomId}/liveState`);
    this.firebase.overSummariesRef = ref(this.firebase.db, `rooms/${this.roomId}/overSummaries`);
    this.firebase.resultRef = ref(this.firebase.db, `rooms/${this.roomId}/result`);
    this.firebase.resetRequestRef = ref(this.firebase.db, `rooms/${this.roomId}/resetRequest`);
    this.firebase.firstInningsRef = ref(this.firebase.db, `rooms/${this.roomId}/firstInnings`);
    this.firebase.firstInningsCompletedRef = ref(this.firebase.db, `rooms/${this.roomId}/firstInningsCompleted`);
    this.firebase.secondInningsStartedRef = ref(this.firebase.db, `rooms/${this.roomId}/secondInningsStarted`);
  }

  // Validate URL parameters
  validateParameters() {
    if (!this.roomId) {
      throw new Error("Missing required room parameter in URL.");
    }
    
    // Check if spectator mode
    this.state.isSpectator = this.playerRole === "spectator";
  }

  // Setup game data
  async setupGame() {
    // Set player online status
    await set(this.firebase.playerRef, true);
    
    // Load room data
    const roomSnap = await get(this.firebase.roomRef);
    if (!roomSnap.exists()) {
      throw new Error(`Room ${this.roomId} not found.`);
    }
    
    const roomData = roomSnap.val();
    
    // Load teams
    await this.loadTeams(roomData);
    
    // Set game format
    this.setGameFormat(roomData);
    
    // Initialize player stats
    this.initPlayerStats();
    
    // Mark game as started if not already
    if (!roomData.gameStarted) {
      await update(this.firebase.roomRef, { gameStarted: true });
    }
  }

  // Load teams data
  async loadTeams(roomData) {
    if (!roomData.teams?.player1 || !roomData.teams?.player2) {
      throw new Error("Both teams must be submitted before starting.");
    }
    
    // Load Team 1
    if (roomData.teams.player1?.players) {
      this.teams.team1Name = roomData.teams.player1.name || "Team A";
      this.teams.team1Players = roomData.teams.player1.players;
      this.elements.team1NameDisplay.textContent = this.teams.team1Name;
      this.elements.battingTeamName.textContent = this.teams.team1Name;
    }
    
    // Load Team 2
    if (roomData.teams.player2?.players) {
      this.teams.team2Name = roomData.teams.player2.name || "Team B";
      this.teams.team2Players = roomData.teams.player2.players;
      this.elements.team2NameDisplay.textContent = this.teams.team2Name;
    }
    
    // Validate we have players
    if (this.teams.team1Players.length === 0 || this.teams.team2Players.length === 0) {
      throw new Error("Both teams must have at least 1 player.");
    }
  }

  // Set game format
  setGameFormat(roomData) {
    const format = roomData.player1?.format || "5";
    this.currentFormat = FORMAT_RULES[format];
    this.elements.formatDisplay.textContent = this.currentFormat.name;
  }

  // Initialize player stats
  initPlayerStats() {
    // Initialize batter stats
    this.teams.team1Players.forEach(player => {
      this.state.batterStats[player] = this.state.batterStats[player] || { 
        runs: 0, balls: 0, fours: 0, sixes: 0,
        centuryNotified: false, fiftyNotified: false
      };
      this.state.batterWickets[player] = this.state.batterWickets[player] || 0;
      this.state.batterPenalties[player] = this.state.batterPenalties[player] || 0;
      this.state.lastBatterRuns[player] = 0;
    });
    
    this.teams.team2Players.forEach(player => {
      this.state.batterStats[player] = this.state.batterStats[player] || { 
        runs: 0, balls: 0, fours: 0, sixes: 0,
        centuryNotified: false, fiftyNotified: false
      };
      this.state.batterWickets[player] = this.state.batterWickets[player] || 0;
      this.state.batterPenalties[player] = this.state.batterPenalties[player] || 0;
      this.state.lastBatterRuns[player] = 0;
    });
    
    // Initialize bowler stats
    this.teams.team1Players.forEach(player => {
      this.state.bowlerStats[player] = this.state.bowlerStats[player] || { 
        wickets: 0, runs: 0, overs: 0, balls: 0 
      };
    });
    
    this.teams.team2Players.forEach(player => {
      this.state.bowlerStats[player] = this.state.bowlerStats[player] || { 
        wickets: 0, runs: 0, overs: 0, balls: 0 
      };
    });
  }

  // Initialize UI
  initUI() {
    // Show mini scorecard
    this.elements.miniScorecard.style.display = 'block';
    
    // Setup teams modal
    this.setupTeamsModal();
    
    // Setup stats slider
    this.setupStatsSlider();
  }

  // Setup event listeners
  setupEventListeners() {
    // Card buttons
    this.setupCardButtons();
    
    // Selection modal
    this.setupSelectionModal();
    
    // Connection monitoring
    this.setupConnectionMonitoring();
    
    // Firebase listeners
    this.setupFirebaseListeners();
    
    // Control buttons
    this.elements.saveBtn.addEventListener("click", () => this.saveGameState());
    this.elements.exitBtn.addEventListener("click", () => this.exitGame());
    this.elements.resetPlaysBtn.addEventListener("click", () => this.requestReset());
    this.elements.startSecondInningsBtn.addEventListener('click', () => this.startSecondInnings());
  }

  // Start the game
  startGame() {
    // Set player role
    this.setupRole();
    
    // Update all displays
    this.updateAllDisplays();
    
    // Hide loading spinner
    this.hideLoading();
    
    this.showNotification("Game ready!", 'info');
  }

  // Setup player role
  async setupRole() {
    // Get toss and batting first info
    const roomSnap = await get(this.firebase.roomRef);
    const roomData = roomSnap.val();
    
    this.tossWinner = roomData.toss?.winner || roomData.tossWinner;
    this.battingFirst = roomData.toss?.battingFirst || roomData.battingFirst;
    
    // Set role definitively
    this.state.isBatting = (this.playerRole === this.battingFirst);
    this.elements.roleText.textContent = this.state.isBatting ? "You are Batting" : "You are Bowling";
    
    // Atomically clear all Firebase selections
    await Promise.all([
      set(this.firebase.batterRef, null),
      set(this.firebase.bowlerRef, null),
      update(this.firebase.playsRef, { 
        player1: null, 
        player2: null 
      })
    ]);
    
    // Show appropriate selection UI
    if (this.state.isBatting) {
      if (!this.state.isSpectator) await this.showBatterSelection();
    } else {
      if (!this.state.isSpectator) await this.showBowlerSelection();
    }
  }

  // Show batter selection modal
  async showBatterSelection() {
    this.disableButtons();
    this.resetSelectionModal();
    
    try {
      this.showLoading("Loading batters...");
      
      const currentPlayers = this.playerRole === "player1" ? 
        this.teams.team1Players : this.teams.team2Players;
      
      const availableBatters = currentPlayers.filter(p => {
        const wicketsUsed = Math.min(1.0, this.state.batterWickets[p] || 0);
        return wicketsUsed < 1.0;
      });

      if (availableBatters.length === 0) {
        this.showNotification("All batters are out!", 'error');
        this.enableButtons();
        return;
      }

      this.elements.selectionTitle.textContent = "Select Next Batter";
      this.elements.selectionList.innerHTML = "";
      
      availableBatters.forEach(player => {
        const stats = this.state.batterStats[player] || { runs: 0, balls: 0, fours: 0, sixes: 0 };
        const wicketsUsed = Math.min(1.0, this.state.batterWickets[player] || 0).toFixed(1);
        
        const batterEl = document.createElement("div");
        batterEl.className = "batter-item";
        batterEl.dataset.name = player;
        batterEl.innerHTML = `
          <div>${player}</div>
          <div>${stats.runs} runs (${wicketsUsed} wickets used)</div>
        `;
        
        batterEl.addEventListener("click", function() {
          document.querySelectorAll(".batter-item").forEach(el => el.classList.remove("selected"));
          this.classList.add("selected");
        });
        
        this.elements.selectionList.appendChild(batterEl);
      });

      // Show modal
      this.elements.selectionModal.style.display = "block";
      this.elements.result.textContent = "Select your next batter...";
    } catch (error) {
      console.error("Batter selection error:", error);
      this.showNotification("Error loading batters", 'error');
      this.enableButtons();
    }
  }

  // Show bowler selection modal
  async showBowlerSelection() {
    this.disableButtons();
    this.resetSelectionModal();

    try {
      this.showLoading("Loading bowlers...");
      
      const currentPlayers = this.playerRole === "player1" ? 
        this.teams.team1Players : this.teams.team2Players;
      
      const maxOversPerBowler = Math.ceil(this.currentFormat.totalOvers / 5);
      const availableBowlers = currentPlayers.filter(p => 
        (this.state.bowlerOvers[p] || 0) < maxOversPerBowler
      );
      
      if (availableBowlers.length === 0) {
        this.showNotification("All bowlers have bowled their maximum overs!", 'error');
        this.enableButtons();
        return;
      }

      this.elements.selectionTitle.textContent = "Select Next Bowler";
      this.elements.selectionList.innerHTML = "";
      
      availableBowlers.forEach(player => {
        const oversBowled = this.state.bowlerOvers[player] || 0;
        const stats = this.state.bowlerStats[player] || { wickets: 0, runs: 0, overs: 0 };
        
        const playerEl = document.createElement("div");
        playerEl.className = "player-item";
        playerEl.dataset.name = player;
        playerEl.innerHTML = `
          <div>${player}</div>
          <div>${oversBowled.toFixed(1)} overs, ${stats.wickets} wickets, ER: ${
            stats.overs > 0 ? (stats.runs / stats.overs).toFixed(2) : '0.00'
          }</div>
        `;
        
        playerEl.addEventListener("click", function() {
          document.querySelectorAll(".player-item").forEach(el => el.classList.remove("selected"));
          this.classList.add("selected");
        });
        
        this.elements.selectionList.appendChild(playerEl);
      });

      // Show modal
      this.elements.selectionModal.style.display = "block";
      this.elements.result.textContent = "Select your next bowler...";
    } catch (error) {
      console.error("Bowler selection error:", error);
      this.showNotification("Error loading bowlers", 'error');
      this.enableButtons();
    }
  }

  // Setup selection modal
  setupSelectionModal() {
    this.elements.confirmSelection.addEventListener("click", async () => {
      if (this.state.isProcessingSelection || this.state.isSpectator) return;
      this.state.isProcessingSelection = true;
      
      try {
        const selected = document.querySelector(".batter-item.selected, .player-item.selected");
        if (!selected) {
          this.showNotification("Please select a player", 'error');
          return;
        }

        const playerName = selected.dataset.name;
        this.resetSelectionModal();

        if (this.elements.selectionTitle.textContent.includes("Batter")) {
          await set(this.firebase.batterRef, playerName);
          this.state.batterSelected = true;
          this.state.currentBatter = playerName;
          this.elements.result.textContent = `${playerName} selected as batter`;
          this.showNotification(`${playerName} comes in to bat`, 'info');
        } else {
          await set(this.firebase.bowlerRef, playerName);
          this.state.bowlerSelected = true;
          this.state.currentBowler = playerName;
          this.elements.result.textContent = `${playerName} selected as bowler`;
          this.showNotification(`${playerName} comes in to bowl`, 'info');
        }

        this.updateButtonStates();
      } catch (error) {
        console.error("Error confirming selection:", error);
        this.showNotification("Failed to confirm selection", 'error');
      } finally {
        this.state.isProcessingSelection = false;
      }
    });
  }

  // Setup card buttons
  setupCardButtons() {
    this.elements.buttons.forEach(btn => {
      btn.addEventListener("click", async () => {
        if (btn.disabled || this.state.isProcessingSelection || this.state.isSpectator) return;
        
        const cardValue = parseInt(btn.dataset.value);
        this.state.selectedCardValue = cardValue;
        this.state.isProcessingSelection = true;

        // Immediate visual feedback
        this.disableButtons();
        this.highlightSelectedCard(cardValue);
        
        // Show simple selection message
        this.elements.result.textContent = `${this.state.isBatting ? 'Batting' : 'Bowling'} selection: ${cardValue}`;

        try {
          await update(this.firebase.playsRef, {
            [this.playerRole]: cardValue
          });
        } catch (error) {
          console.error("Selection failed:", error);
          this.elements.result.textContent = "Selection failed, please try again";
          this.enableButtons();
          this.clearCardSelection();
        } finally {
          this.state.isProcessingSelection = false;
        }
      });
    });
  }

  // Setup connection monitoring
  setupConnectionMonitoring() {
    // Monitor opponent connection
    onValue(this.firebase.opponentRef, (snap) => {
      if (snap.exists() && snap.val()) {
        this.elements.connectionStatus.textContent = "Opponent: Online";
        this.elements.connectionStatus.className = "online";
        this.updateButtonStates();
      } else {
        this.elements.connectionStatus.textContent = "Opponent: Offline";
        this.elements.connectionStatus.className = "offline";
        this.elements.result.textContent = "Waiting for opponent to connect...";
        this.disableButtons();
      }
    });

    // Handle disconnect
    window.addEventListener('beforeunload', () => {
      set(this.firebase.playerRef, false);
    });
  }

  // Setup Firebase listeners
  setupFirebaseListeners() {
    // Listen for plays reset
    onValue(this.firebase.playsRef, (snap) => {
      if (this.state.isResetting) return;
      
      if (!snap.exists() || (snap.val().player1 === null && snap.val().player2 === null)) {
        // Plays have been reset by opponent
        this.clearCardSelection();
        this.enableButtons();
      }
    });

    // Listen for batter changes
    onValue(this.firebase.batterRef, (snap) => {
      if (!snap.exists()) {
        this.state.currentBatter = null;
        this.state.batterSelected = false;
        if (this.state.isBatting && !this.state.isResetting && !this.state.isSpectator) {
          this.showBatterSelection();
        }
      } else if (snap.val()) {
        this.state.currentBatter = snap.val();
        this.state.batterSelected = true;
        this.updateButtonStates();
        this.updateAllDisplays();
      }
    });

    // Listen for bowler changes
    onValue(this.firebase.bowlerRef, (snap) => {
      if (!snap.exists()) {
        this.state.currentBowler = null;
        this.state.bowlerSelected = false;
        if (!this.state.isBatting && !this.state.isResetting && !this.state.isSpectator) {
          this.showBowlerSelection();
        }
      } else if (snap.val()) {
        this.state.currentBowler = snap.val();
        this.state.bowlerSelected = true;
        this.updateButtonStates();
        this.updateAllDisplays();
      }
    });

    // Listen for both plays to be submitted
    onValue(this.firebase.playsRef, (snap) => {
      if (snap.exists() && 
          typeof snap.val().player1 !== 'undefined' && 
          typeof snap.val().player2 !== 'undefined') {
        this.handleResult();
      }
    });

    // Listen for first innings completion
    onValue(this.firebase.firstInningsCompletedRef, (snap) => {
      if (snap.exists() && snap.val()) {
        this.state.firstInningsCompleted = true;
        this.handleFirstInningsCompletion();
      }
    });

    // Listen for second innings start
    onValue(this.firebase.secondInningsStartedRef, (snap) => {
      if (snap.exists() && snap.val()) {
        this.state.secondInningsStarted = true;
        this.elements.inningsNumber.textContent = "2nd Innings";
      }
    });
  }

  // Handle first innings completion
  async handleFirstInningsCompletion() {
    const firstInningsSnap = await get(this.firebase.firstInningsRef);
    if (firstInningsSnap.exists()) {
      this.state.firstInningsData = firstInningsSnap.val();
      this.state.target = this.state.firstInningsData.totalRuns + 1;
      this.state.chasingTeam = this.battingFirst === "player1" ? "player2" : "player1";
      
      // Update UI
      this.elements.targetDisplay.style.display = 'block';
      this.elements.targetValue.textContent = this.state.target;
      
      // Check if second innings already started
      const secondInningsSnap = await get(this.firebase.secondInningsStartedRef);
      if (secondInningsSnap.exists() && secondInningsSnap.val()) {
        this.state.secondInningsStarted = true;
        this.elements.inningsNumber.textContent = "2nd Innings";
        
        // Set up for second innings
        this.state.isBatting = (this.playerRole === this.state.chasingTeam);
        this.elements.roleText.textContent = this.state.isBatting ? "You are Batting" : "You are Bowling";
        this.elements.battingTeamName.textContent = this.state.isBatting ? 
          this.teams.team1Name : this.teams.team2Name;
      } else {
        // Show summary popup to start second innings
        this.showSummaryPopup();
      }
    }
  }

  // Setup teams modal
  setupTeamsModal() {
    let currentSlide = 0;
    const slideCount = document.querySelectorAll('.team-slide').length;

    const updateSlider = () => {
      this.elements.teamsSlider.scrollTo({
        left: currentSlide * this.elements.teamsSlider.offsetWidth,
        behavior: 'smooth'
      });
      
      // Update button states
      this.elements.prevTeamBtn.disabled = currentSlide === 0;
      this.elements.nextTeamBtn.disabled = currentSlide === slideCount - 1;
      
      // Update dots
      document.querySelectorAll('.team-nav-dot').forEach((dot, index) => {
        dot.classList.toggle('active', index === currentSlide);
      });
    };

    // Show modal
    this.elements.showTeamsBtn.addEventListener('click', () => {
      this.elements.teamsModal.style.display = 'flex';
      currentSlide = 0;
      updateSlider();
    });

    // Close modal
    this.elements.closeTeamsBtn.addEventListener('click', () => {
      this.elements.teamsModal.style.display = 'none';
    });

    // Previous button
    this.elements.prevTeamBtn.addEventListener('click', () => {
      if (currentSlide > 0) {
        currentSlide--;
        updateSlider();
      }
    });

    // Next button
    this.elements.nextTeamBtn.addEventListener('click', () => {
      if (currentSlide < slideCount - 1) {
        currentSlide++;
        updateSlider();
      }
    });

    // Dot navigation
    document.querySelectorAll('.team-nav-dot').forEach(dot => {
      dot.addEventListener('click', () => {
        currentSlide = parseInt(dot.dataset.index);
        updateSlider();
      });
    });
  }

  // Setup stats slider
  setupStatsSlider() {
    let currentSlide = 0;
    const slideCount = document.querySelectorAll('#statsSlider .stats-slide').length;

    const updateSlider = () => {
      this.elements.statsSlider.scrollTo({
        left: currentSlide * this.elements.statsSlider.offsetWidth,
        behavior: 'smooth'
      });
      
      // Update button states
      this.elements.prevStatsBtn.disabled = currentSlide === 0;
      this.elements.nextStatsBtn.disabled = currentSlide === slideCount - 1;
      
      // Update dots
      document.querySelectorAll('.team-nav-indicator .team-nav-dot').forEach((dot, index) => {
        dot.classList.toggle('active', index === currentSlide);
      });
    };

    // Previous button
    this.elements.prevStatsBtn.addEventListener('click', () => {
      if (currentSlide > 0) {
        currentSlide--;
        updateSlider();
      }
    });

    // Next button
    this.elements.nextStatsBtn.addEventListener('click', () => {
      if (currentSlide < slideCount - 1) {
        currentSlide++;
        updateSlider();
      }
    });

    // Dot navigation
    document.querySelectorAll('.team-nav-indicator .team-nav-dot').forEach(dot => {
      dot.addEventListener('click', () => {
        currentSlide = parseInt(dot.dataset.index);
        updateSlider();
      });
    });
  }

  // Handle the result of a ball
  async handleResult() {
    try {
      // Clear selection state
      this.state.selectedCardValue = null;
      this.state.isProcessingSelection = false;
      
      const playsSnap = await get(this.firebase.playsRef);
      if (!playsSnap.exists()) return;
      
      const plays = playsSnap.val();
      if (!plays || typeof plays.player1 === 'undefined' || typeof plays.player2 === 'undefined') return;

      const card1 = plays.player1;
      const card2 = plays.player2;
      const batterCard = this.battingFirst === "player1" ? card1 : card2;
      const bowlerCard = this.battingFirst === "player1" ? card2 : card1;

      let outcome = "";
      let isLegalBall = false;
      let isWicket = false;
      let isPlayerOut = false;
      let runsScored = 0;
      let boundary = false;
      let isSix = false;
      let commentaryText = "";

      // Track zeros for both players
      if (batterCard === 0) this.state.zerosThisOver[this.battingFirst]++;
      if (bowlerCard === 0) this.state.zerosThisOver[this.opponentRole]++;

      // Handle free hit for next ball
      if (this.state.freeHitNextBall) {
        this.state.freeHit = true;
        this.state.freeHitNextBall = false;
        this.updateFreeHitDisplay();
      }

      // Check powerplay and dead over status
      this.checkPowerplay();
      this.checkDeadOver();

      // 1. Check for no ball (both 0)
      if (batterCard === 0 && bowlerCard === 0) {
        outcome = "NO BALL! +1 run (Free Hit next ball)";
        this.state.runs += 1;
        this.state.freeHitNextBall = true;
        isLegalBall = false;
        
        commentaryText = this.getRandomCommentary('noBall');
        this.showNotification(commentaryText, 'error');
        this.addToTimeline("NB", 'error');
        this.createUmpireSignal("👆");
      } 
      // 2. Handle free hit balls
      else if (this.state.freeHit) {
        if (batterCard === bowlerCard && batterCard > 0) {
          outcome = "Wicket on Free Hit (not out)";
          isWicket = false;
          
          commentaryText = this.getRandomCommentary('freeHit');
          this.showNotification(`${commentaryText} - ${this.state.currentBatter} survives`, 'info');
          this.createUmpireSignal("👈");
        } else {
          runsScored = batterCard;
          this.state.runs += batterCard;
          this.state.batterStats[this.state.currentBatter].runs += runsScored;
          outcome = `${batterCard} Run(s)! (Free Hit)`;
          if (batterCard === 4 || batterCard === 6) boundary = true;
          if (batterCard === 6) isSix = true;
          
          commentaryText = this.getRandomCommentary('freeHit');
          this.showNotification(`${this.state.currentBatter} scores ${batterCard} on free hit - ${commentaryText}`, 'info');
          this.addToTimeline(`${batterCard} FH`, 'info');
          if (batterCard === 4) this.createUmpireSignal("👈");
          if (batterCard === 6) this.createUmpireSignal("↖️");
        }
        this.state.freeHit = false;
        this.updateFreeHitDisplay();
        isLegalBall = true;
      }
      // 3. Handle wickets (same number > 0)
      else if (batterCard === bowlerCard && batterCard > 0) {
        const wicketValue = this.getWicketValue();
        const currentWickets = this.state.batterWickets[this.state.currentBatter] || 0;

        if (currentWickets < 1.0) {
          const actualWicketValue = Math.min(wicketValue, 1.0 - currentWickets);
          this.state.batterWickets[this.state.currentBatter] = currentWickets + actualWicketValue;
          this.state.wickets += actualWicketValue;
          isWicket = true;

          if (this.state.batterWickets[this.state.currentBatter] >= 1.0) {
            isPlayerOut = true;
            outcome = "WICKET! (Out)";
            this.state.fallOfWickets.push({
              score: this.state.runs,
              over: `${Math.floor(this.state.legalBalls / 6)}.${(this.state.legalBalls % 6) + 1}`,
              batter: this.state.currentBatter,
              bowler: this.state.currentBowler
            });
            
            commentaryText = this.getRandomCommentary('wicket');
            this.showNotification(`WICKET! ${commentaryText} - ${this.state.currentBowler} gets ${this.state.currentBatter} out!`, 'wicket');
            this.addToTimeline(`W ${this.state.currentBatter}`, 'wicket');
            this.createWicketAnimation();
            this.createUmpireSignal("☝️");
          } else {
            const remain = (1.0 - this.state.batterWickets[this.state.currentBatter]).toFixed(2).replace(/\.00$/, '');
            outcome = `WICKET! (${remain} left for this batter)`;
            
            commentaryText = this.getRandomCommentary('wicket');
            this.showNotification(`${commentaryText} - ${this.state.currentBatter} loses ${actualWicketValue} wicket points`, 'wicket');
            this.addToTimeline(`W ${actualWicketValue}`, 'wicket');
          }
        } else {
          outcome = "Batter already out!";
          this.showNotification(`${this.state.currentBatter} is already out!`, 'error');
        }
        
        isLegalBall = true;
      }
      // 4. Handle batter playing 0 with penalty
      else if (batterCard === 0 && bowlerCard > 0) {
        if (this.state.zerosThisOver[this.battingFirst] > 3) {
          const penaltyRuns = 5;
          this.state.runs -= penaltyRuns;
          this.state.batterPenalties[this.state.currentBatter] = 
            (this.state.batterPenalties[this.state.currentBatter] || 0) + penaltyRuns;
          outcome = "4th 0 in over! -5 runs";
          
          commentaryText = this.getRandomCommentary('dotBall');
          this.showNotification(`4th dot ball in over! Penalty of 5 runs - ${commentaryText}`, 'error');
          this.addToTimeline("-5", 'error');
          
          this.checkBatterMilestones(true);
        } else {
          runsScored = bowlerCard;
          this.state.runs += bowlerCard;
          this.state.batterStats[this.state.currentBatter].runs += runsScored;
          outcome = `Batter played 0. Runs = ${bowlerCard}`;
          if (bowlerCard === 4 || bowlerCard === 6) boundary = true;
          if (bowlerCard === 6) isSix = true;
          
          commentaryText = this.getRandomCommentary('dotBall');
          this.showNotification(`${this.state.currentBatter} plays defensive, ${bowlerCard} runs conceded - ${commentaryText}`, 'info');
          this.addToTimeline(`${bowlerCard}`, 'info');
        }
        isLegalBall = true;
      }
      // 5. Handle bowler playing 0
      else if (bowlerCard === 0 && batterCard > 0) {
        if (this.state.zerosThisOver[this.opponentRole] > 3) {
          outcome = "4th 0 in over! No ball";
          this.state.runs += 1;
          this.state.freeHitNextBall = true;
          
          commentaryText = this.getRandomCommentary('noBall');
          this.showNotification(`4th dot ball from bowler! ${commentaryText}`, 'error');
          this.addToTimeline("NB", 'error');
          this.createUmpireSignal("👆");
        } else {
          outcome = "DOT BALL!";
          
          commentaryText = this.getRandomCommentary('dotBall');
          this.showNotification(`${this.state.currentBowler} bowls a dot ball to ${this.state.currentBatter} - ${commentaryText}`, 'info');
          this.addToTimeline("•", 'info');
        }
        isLegalBall = true;
      }
      // 6. Normal runs
      else {
        runsScored = batterCard;
        this.state.runs += batterCard;
        this.state.batterStats[this.state.currentBatter].runs += batterCard;
        outcome = `${batterCard} Run(s)!`;
        if (batterCard === 4 || batterCard === 6) boundary = true;
        if (batterCard === 6) isSix = true;
        
        if (batterCard === 1) {
          commentaryText = this.getRandomCommentary('single');
        } else if (batterCard === 2) {
          commentaryText = this.getRandomCommentary('double');
        } else if (batterCard === 3) {
          commentaryText = this.getRandomCommentary('triple');
        } else if (batterCard === 4) {
          commentaryText = this.getRandomCommentary('boundary');
        } else if (batterCard === 6) {
          commentaryText = this.getRandomCommentary('six');
        }
        
        this.showNotification(`${batterCard} runs! ${commentaryText}`, 'info');
        this.addToTimeline(`${batterCard}`, boundary ? 'boundary' : '');
        
        if (boundary) {
          this.createBoundaryEffect(isSix);
          if (batterCard === 4) this.createUmpireSignal("👈");
          if (batterCard === 6) this.createUmpireSignal("↖️");
        }
        
        isLegalBall = true;
      }

      // Update batter stats
      if (this.state.currentBatter && runsScored > 0) {
        this.state.batterStats[this.state.currentBatter].balls += 1;
        if (batterCard === 4) this.state.batterStats[this.state.currentBatter].fours += 1;
        if (batterCard === 6) this.state.batterStats[this.state.currentBatter].sixes += 1;
        this.checkBatterMilestones();
      }
      
      // Update bowler stats
      if (this.state.currentBowler) {
        this.state.bowlerStats[this.state.currentBowler] = 
          this.state.bowlerStats[this.state.currentBowler] || { wickets: 0, runs: 0, overs: 0, balls: 0 };
        if (isWicket) this.state.bowlerStats[this.state.currentBowler].wickets += 1;
        this.state.bowlerStats[this.state.currentBowler].runs += runsScored;
        this.state.bowlerStats[this.state.currentBowler].balls += 1;
        
        // Update overs count (0.1 per ball)
        this.state.bowlerStats[this.state.currentBowler].overs = 
          Math.floor(this.state.bowlerStats[this.state.currentBowler].balls / 6) + 
          (this.state.bowlerStats[this.state.currentBowler].balls % 6) / 10;
      }

      // Record ball in ball-by-ball
      this.state.ballByBall[this.state.legalBalls] = {
        runs: runsScored,
        wicket: isWicket || isPlayerOut,
        batter: this.state.currentBatter,
        bowler: this.state.currentBowler,
        timestamp: Date.now(),
        outcome: outcome,
        penalty: (batterCard === 0 && bowlerCard > 0 && this.state.zerosThisOver[this.battingFirst] > 3) ? 5 : 0,
        commentary: commentaryText
      };

      // Record last wicket score for partnership
      if (isWicket) {
        this.state.lastWicketScore = this.state.runs;
      }

      // Handle legal balls
      if (isLegalBall) {
        this.state.legalBalls++;
        this.updateOverSummary();
        
        if (this.state.currentBowler) {
          this.state.bowlerOvers[this.state.currentBowler] = 
            (this.state.bowlerOvers[this.state.currentBowler] || 0) + (1/6);
          if (this.state.legalBalls % 6 === 0) {
            this.state.bowlerOvers[this.state.currentBowler] = 
              Math.round(this.state.bowlerOvers[this.state.currentBowler] * 10) / 10;
            this.state.zerosThisOver = { player1: 0, player2: 0 };
          }
        }
      }

      // Update all displays
      this.updateAllDisplays();
      
      // Update UI animations
      this.elements.result.textContent = `${outcome}\n${commentaryText}`;
      if (boundary) {
        this.elements.result.classList.add("boundary-animation");
        this.elements.runsDisplay.classList.add("boundary-flash");
      }
      if (isWicket) {
        this.elements.result.classList.add("wicket-animation");
        this.elements.wicketsDisplay.classList.add("score-change");
        this.elements.scoreboard.classList.add("wicket-flash");
      }
      if (runsScored > 0) {
        this.elements.runsDisplay.classList.add("score-change");
      }
      
      // Remove animation classes after they complete
      setTimeout(() => {
        this.elements.result.classList.remove("boundary-animation", "wicket-animation");
        this.elements.runsDisplay.classList.remove("score-change", "boundary-flash");
        this.elements.wicketsDisplay.classList.remove("score-change");
        this.elements.scoreboard.classList.remove("wicket-flash");
      }, 2000);

      // Check for innings end conditions
      if (this.state.wickets >= this.currentFormat.totalWickets || 
          this.state.legalBalls >= this.currentFormat.totalOvers * 6) {
        if (this.state.secondInningsStarted) {
          await this.endMatch(false); // Second innings ended without reaching target
        } else {
          this.endInning(); // First innings ended
        }
        return;
      }

      // Check for second innings win conditions
      if (this.state.secondInningsStarted) {
        // Check if chasing team has won
        if (this.state.runs >= this.state.target) {
          await this.endMatch(true);
          return;
        }
        
        // Check if chasing team has been bowled out
        if (this.state.wickets >= this.currentFormat.totalWickets) {
          await this.endMatch(false);
          return;
        }
        
        // Check if overs completed without reaching target
        if (this.state.legalBalls >= this.currentFormat.totalOvers * 6) {
          await this.endMatch(false);
          return;
        }
      }

      // Prepare for next ball
      setTimeout(async () => {
        try {
          await set(this.firebase.playsRef, {});
          this.enableButtons();
          this.clearCardSelection();
          
          if (isPlayerOut && this.playerRole === this.battingFirst) {
            this.state.batterSelected = false;
            await this.showBatterSelection();
          } else if (isLegalBall && this.state.legalBalls % 6 === 0) {
            this.state.bowlerSelected = false;
            if (this.playerRole === (this.battingFirst === "player1" ? "player2" : "player1")) {
              await this.showBowlerSelection();
            } else {
              this.elements.result.textContent = "Waiting for opponent to select bowler...";
            }
          } else {
            this.updateButtonStates();
          }
        } catch (error) {
          console.error("Error in post-ball processing:", error);
          this.elements.result.textContent = "Error processing next ball state";
          this.enableButtons();
          this.clearCardSelection();
        }
      }, 1500);
    } catch (error) {
      console.error("Error processing ball outcome:", error);
      this.elements.result.textContent = "Error processing ball outcome";
      this.enableButtons();
      this.clearCardSelection();
    }
  }

  // Check powerplay status
  checkPowerplay() {
    const currentOver = Math.floor(this.state.legalBalls / 6);
    
    if (Array.isArray(this.currentFormat.powerplayOvers)) {
      // ODI has specific powerplay overs
      this.state.isPowerplay = this.currentFormat.powerplayOvers.some(pp => {
        if (Array.isArray(pp)) {
          return currentOver >= pp[0] && currentOver <= pp[1];
        }
        return currentOver === pp;
      });
    } else {
      // Other formats have continuous powerplay overs
      this.state.isPowerplay = currentOver < this.currentFormat.powerplayOvers;
    }

    // Update UI
    this.elements.powerplayIndicator.style.display = this.state.isPowerplay ? "inline-block" : "none";
  }

  // Check dead over status
  checkDeadOver() {
    if (!this.currentFormat.deadOvers || this.currentFormat.deadOvers.length === 0) {
      this.state.isDeadOver = false;
      this.elements.deadOverIndicator.style.display = "none";
      return;
    }

    const currentOver = Math.floor(this.state.legalBalls / 6);
    this.state.isDeadOver = this.currentFormat.deadOvers.some(dead => {
      if (Array.isArray(dead)) {
        return currentOver >= dead[0] && currentOver <= dead[1];
      }
      return currentOver === dead;
    });

    // Update UI
    this.elements.deadOverIndicator.style.display = this.state.isDeadOver ? "inline-block" : "none";
  }

  // Update free hit display
  updateFreeHitDisplay() {
    this.elements.freeHitIndicator.style.display = this.state.freeHit ? "inline-block" : "none";
  }

  // Get wicket value based on format and powerplay status
  getWicketValue() {
    if (this.currentFormat.name === "ODI") {
      return this.state.isPowerplay ? 0.25 : 0.5;
    }
    
    return this.state.isPowerplay ? 0.5 : 1.0;
  }

  // Format wickets to max 1.0 per batter
  formatWickets(value) {
    const maxWickets = this.currentFormat.totalWickets;
    const formattedValue = Math.min(value, maxWickets)
      .toFixed(2)
      .replace(/\.00$/, '');
    
    // For display purposes, show integer if it's a whole number
    return formattedValue.includes('.') ? formattedValue : parseInt(formattedValue);
  }

  // Update scoreboard with fractional wickets
  updateScoreboard() {
    const wicketsDisplay = this.formatWickets(this.state.wickets);
    
    this.elements.runsDisplay.textContent = this.state.runs;
    this.elements.wicketsDisplay.textContent = wicketsDisplay;
    this.elements.oversDisplay.textContent = 
      `${Math.floor(this.state.legalBalls/6)}.${this.state.legalBalls%6}`;
    
    // Update mini scorecard
    this.elements.miniScore.textContent = `${this.state.runs}/${wicketsDisplay}`;
    this.elements.miniOvers.textContent = `${Math.floor(this.state.legalBalls/6)}.${this.state.legalBalls%6}`;
  }

  // Update player stats display
  updatePlayerStats() {
    // Update run rate
    const completedOvers = Math.floor(this.state.legalBalls / 6) + (this.state.legalBalls % 6) / 10;
    const rr = completedOvers > 0 ? (this.state.runs / completedOvers).toFixed(2) : '0.00';
    this.elements.runRateDisplay.textContent = rr;
    
    // Update required rate if chasing
    if (this.state.secondInningsStarted) {
      const remainingBalls = this.currentFormat.totalOvers * 6 - this.state.legalBalls;
      const runsNeeded = this.state.target - this.state.runs - 1;
      const requiredRR = remainingBalls > 0 ? (runsNeeded / (remainingBalls / 6)).toFixed(2) : '0.00';
    }
  }

  // Update over progress display
  updateOverProgress() {
    this.elements.ballsContainer.innerHTML = '';
    
    const ballsThisOver = this.state.legalBalls % 6;
    for (let i = 0; i < 6; i++) {
      const ballEl = document.createElement('div');
      ballEl.className = 'ball';
      
      if (i < ballsThisOver) {
        const ballData = this.state.ballByBall[this.state.legalBalls - ballsThisOver + i];
        if (ballData) {
          if (ballData.wicket) {
            ballEl.className += ' wicket';
            ballEl.textContent = 'W';
          } else if (ballData.runs > 0) {
            ballEl.className += ' run';
            ballEl.textContent = ballData.runs;
          } else {
            ballEl.className += ' dot';
            ballEl.textContent = '•';
          }
        }
      } else {
        ballEl.className += ' empty';
      }
      
      this.elements.ballsContainer.appendChild(ballEl);
    }
    
    this.elements.currentOverNumber.textContent = Math.floor(this.state.legalBalls / 6) + 1;
  }

  // Update partnership info
  updatePartnership() {
    this.state.partnershipRuns = this.state.runs - this.state.lastWicketScore;
    this.state.partnershipBalls = 0;
    
    // Count balls since last wicket
    for (let i = this.state.legalBalls - 1; i >= 0; i--) {
      if (this.state.ballByBall[i]?.wicket) break;
      this.state.partnershipBalls++;
    }
    
    // Add contextual commentary for partnerships
    if (this.state.partnershipRuns >= 50 && this.state.partnershipRuns % 10 === 0) {
      const randomComment = this.getRandomCommentary('partnership');
      this.showNotification(
        `Partnership now ${this.state.partnershipRuns} runs from ${this.state.partnershipBalls} balls - ${randomComment}`, 
        'info'
      );
    }
  }

  // Update last 5 overs stats
  updateLast5Overs() {
    this.state.last5Runs = 0;
    this.state.last5Wickets = 0;
    this.state.last5Balls = 0;
    
    const startBall = Math.max(0, this.state.legalBalls - 30); // 5 overs = 30 balls
    for (let i = startBall; i < this.state.legalBalls; i++) {
      if (this.state.ballByBall[i]) {
        this.state.last5Runs += this.state.ballByBall[i].runs;
        if (this.state.ballByBall[i].wicket) this.state.last5Wickets++;
        this.state.last5Balls++;
      }
    }
    
    // Add expert analysis
    if (this.state.legalBalls % 30 === 0 && this.state.legalBalls > 0) { // Every 5 overs
      const rrLast5 = (this.state.last5Runs / 5).toFixed(1);
      const randomComment = this.getRandomCommentary('runRate');
      this.showNotification(
        `Last 5 overs: ${this.state.last5Runs} runs, ${this.state.last5Wickets} wickets (RR: ${rrLast5}) - ${randomComment}`, 
        'info'
      );
    }
  }

  // Update current time
  updateCurrentTime() {
    const now = new Date();
    document.getElementById('currentTime').textContent = now.toLocaleTimeString([], { 
      hour: '2-digit', 
      minute: '2-digit' 
    });
    document.getElementById('matchDate').textContent = now.toLocaleDateString([], { 
      day: 'numeric', 
      month: 'short', 
      year: 'numeric' 
    });
  }

  // Update player comparison
  updatePlayerComparison() {
    if (this.state.currentBatter) {
      const batter = this.state.batterStats[this.state.currentBatter] || { runs: 0, balls: 0, fours: 0, sixes: 0 };
      const sr = batter.balls > 0 ? ((batter.runs / batter.balls) * 100).toFixed(2) : '0.00';
      
      document.getElementById('comparisonBatterName').textContent = this.state.currentBatter;
      document.getElementById('comparisonBatterRuns').textContent = batter.runs;
      document.getElementById('comparisonBatterBalls').textContent = batter.balls;
      document.getElementById('comparisonBatterSR').textContent = sr;
      document.getElementById('comparisonBatterBoundaries').textContent = `${batter.fours}/${batter.sixes}`;
      
      // Highlight player if performing well
      const batterEl = document.getElementById('comparisonBatterName');
      if (batter.runs >= 30 || sr > 150) {
        batterEl.classList.add('highlight');
      } else {
        batterEl.classList.remove('highlight');
      }
    }
    
    if (this.state.currentBowler) {
      const bowler = this.state.bowlerStats[this.state.currentBowler] || { wickets: 0, runs: 0, overs: 0, balls: 0 };
      const er = bowler.overs > 0 ? (bowler.runs / bowler.overs).toFixed(2) : '0.00';
      
      document.getElementById('comparisonBowlerName').textContent = this.state.currentBowler;
      document.getElementById('comparisonBowlerWickets').textContent = bowler.wickets;
      document.getElementById('comparisonBowlerOvers').textContent = bowler.overs.toFixed(1);
      document.getElementById('comparisonBowlerER').textContent = er;
      document.getElementById('comparisonBowlerRuns').textContent = bowler.runs;
      
      // Highlight bowler if performing well
      const bowlerEl = document.getElementById('comparisonBowlerName');
      if (bowler.wickets >= 2 || parseFloat(er) < 6) {
        bowlerEl.classList.add('highlight');
      } else {
        bowlerEl.classList.remove('highlight');
      }
    }
  }

  // Update over summary
  updateOverSummary() {
    const currentOver = Math.floor(this.state.legalBalls / 6);
    if (currentOver > 0 && currentOver > this.state.overSummaries.length) {
      const runsThisOver = this.state.runs - this.state.lastOverRuns;
      const wicketsThisOver = this.state.wickets - this.state.lastOverWickets;
      const summary = `Over ${currentOver}: ${runsThisOver} runs, ${wicketsThisOver} wickets`;
      this.state.overSummaries.push(summary);
      
      // Update Firebase for spectators
      set(ref(this.firebase.db, `${this.firebase.overSummariesRef.path}/over${currentOver}`), summary);
      
      // Update UI
      const summaryItem = document.createElement("div");
      summaryItem.className = "over-summary-item";
      summaryItem.textContent = summary;
      this.elements.overSummaryList.appendChild(summaryItem);
      
      // Scroll to bottom
      this.elements.overSummaryList.scrollTop = this.elements.overSummaryList.scrollHeight;
      
      // Update last over stats
      this.state.lastOverRuns = this.state.runs;
      this.state.lastOverWickets = this.state.wickets;
    }
  }

  // Update all displays
  updateAllDisplays() {
    this.updateScoreboard();
    this.updatePlayerStats();
    this.updateOverProgress();
    this.updatePartnership();
    this.updateLast5Overs();
    this.updateCurrentTime();
    this.updatePlayerComparison();
  }

  // Add to timeline
  addToTimeline(event, type = '') {
    const timeline = document.getElementById('matchTimeline');
    const currentOver = Math.floor(this.state.legalBalls / 6);
    const currentBall = (this.state.legalBalls % 6) + 1; // Show balls as 1-6 instead of 0-5
    
    const timelineItem = document.createElement('div');
    timelineItem.className = `timeline-item ${type}`;
    timelineItem.innerHTML = `
      <div class="timeline-over">${currentOver}.${currentBall}</div>
      <div class="timeline-event">${event}</div>
    `;
    
    timeline.insertBefore(timelineItem, timeline.firstChild);
    
    // Limit timeline to 20 items
    if (timeline.children.length > 20) {
      timeline.removeChild(timeline.lastChild);
    }
  }

  // Check batter milestones
  checkBatterMilestones(isPenalty = false) {
    if (!this.state.currentBatter) return;

    const batter = this.state.batterStats[this.state.currentBatter];
    const netRuns = batter.runs - (this.state.batterPenalties[this.state.currentBatter] || 0);
    
    // Check milestones in descending order
    const milestones = [50, 100, 150, 200, 250, 300, 350, 400];
    for (let i = milestones.length - 1; i >= 0; i--) {
      const milestone = milestones[i];
      
      // Check if crossed milestone (either direction)
      if ((!isPenalty && netRuns >= milestone && this.state.lastBatterRuns[this.state.currentBatter] < milestone) ||
          (isPenalty && netRuns < milestone && this.state.lastBatterRuns[this.state.currentBatter] >= milestone)) {
        
        // Only notify if this is a new achievement
        if (netRuns >= milestone && !batter[`milestone${milestone}Notified`]) {
          const randomComment = this.getRandomCommentary('milestone');
          this.showNotification(
            `${this.state.currentBatter} reaches ${milestone} runs! (Net: ${netRuns}) - ${randomComment}`, 
            'batting'
          );
          batter[`milestone${milestone}Notified`] = true;
          
          if (milestone >= 100) {
            this.createConfetti();
            this.createUmpireSignal("💯");
          }
        }
        // Handle losing a milestone due to penalty
        else if (isPenalty && netRuns < milestone && batter[`milestone${milestone}Notified`]) {
          this.showNotification(
            `${this.state.currentBatter} falls below ${milestone} runs after penalty (Net: ${netRuns})`, 
            'error'
          );
          batter[`milestone${milestone}Notified`] = false;
        }
        break;
      }
    }
    
    // Special handling for 50 and 100
    if (netRuns >= 50 && !batter.fiftyNotified) {
      const randomComment = this.getRandomCommentary('milestone');
      this.showNotification(
        `${this.state.currentBatter} scores a half-century! (Net: ${netRuns}) - ${randomComment}`, 
        'batting'
      );
      batter.fiftyNotified = true;
      this.createConfetti();
      this.createUmpireSignal("5️⃣0️⃣");
    }
    else if (netRuns < 50 && batter.fiftyNotified) {
      this.showNotification(
        `${this.state.currentBatter} loses half-century after penalty (Net: ${netRuns})`, 
        'error'
      );
      batter.fiftyNotified = false;
    }
    
    if (netRuns >= 100 && !batter.centuryNotified) {
      const randomComment = this.getRandomCommentary('milestone');
      this.showNotification(
        `${this.state.currentBatter} scores a century! 💯 (Net: ${netRuns}) - ${randomComment}`, 
        'batting'
      );
      batter.centuryNotified = true;
      this.createConfetti();
      this.createUmpireSignal("💯");
    }
    else if (netRuns < 100 && batter.centuryNotified) {
      this.showNotification(
        `${this.state.currentBatter} loses century after penalty (Net: ${netRuns})`, 
        'error'
      );
      batter.centuryNotified = false;
    }

    // Update last run count
    this.state.lastBatterRuns[this.state.currentBatter] = netRuns;
  }

  // Get random commentary
  getRandomCommentary(type) {
    const phrases = COMMENTARY_PHRASES[type] || ["Good cricket!"];
    return phrases[Math.floor(Math.random() * phrases.length)];
  }

  // Show notification
  showNotification(message, type = 'info') {
    const notif = document.createElement('div');
    notif.className = `milestone-notification ${type}`;
    notif.textContent = message;
    document.body.appendChild(notif);
    
    setTimeout(() => {
      notif.style.opacity = '0';
      setTimeout(() => notif.remove(), 500);
    }, 2500);
  }

  // Create confetti effect
  createConfetti() {
    const colors = ['#f00', '#0f0', '#00f', '#ff0', '#f0f', '#0ff'];
    for (let i = 0; i < 150; i++) {
      const confetti = document.createElement('div');
      confetti.className = 'confetti';
      confetti.style.left = `${Math.random() * 100}%`;
      confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
      confetti.style.width = `${Math.random() * 10 + 5}px`;
      confetti.style.height = `${Math.random() * 10 + 5}px`;
      confetti.style.animationDuration = `${Math.random() * 3 + 2}s`;
      confetti.style.animationDelay = `${Math.random() * 0.5}s`;
      document.body.appendChild(confetti);
      setTimeout(() => confetti.remove(), 5000);
    }
  }

  // Create ball trail animation
  createBallTrail() {
    const ball = document.createElement('div');
    ball.className = 'ball-trail';
    this.elements.matchGraphics.appendChild(ball);
    
    // Position randomly for variety
    const startX = Math.random() * 50 + 25;
    const startY = Math.random() * 50 + 25;
    
    ball.style.left = `${startX}%`;
    ball.style.top = `${startY}%`;
    
    setTimeout(() => {
      ball.remove();
    }, 500);
  }

  // Create wicket animation
  createWicketAnimation() {
    // Create stumps
    const stumpLeft = document.createElement('div');
    stumpLeft.className = 'stump left';
    this.elements.matchGraphics.appendChild(stumpLeft);
    
    const stumpMiddle = document.createElement('div');
    stumpMiddle.className = 'stump middle';
    this.elements.matchGraphics.appendChild(stumpMiddle);
    
    const stumpRight = document.createElement('div');
    stumpRight.className = 'stump right';
    this.elements.matchGraphics.appendChild(stumpRight);
    
    const bail = document.createElement('div');
    bail.className = 'stump bail';
    this.elements.matchGraphics.appendChild(bail);
    
    // Animate stumps falling
    setTimeout(() => {
      stumpLeft.style.animation = 'stumpFall 0.5s forwards';
      stumpMiddle.style.animation = 'stumpFall 0.5s forwards 0.1s';
      stumpRight.style.animation = 'stumpFall 0.5s forwards 0.2s';
      bail.style.transform = 'translateY(-20px) rotate(10deg)';
      bail.style.opacity = '0';
      
      // Remove after animation
      setTimeout(() => {
        stumpLeft.remove();
        stumpMiddle.remove();
        stumpRight.remove();
        bail.remove();
      }, 1000);
    }, 100);
  }

  // Create boundary effect
  createBoundaryEffect(isSix = false) {
    // Screen shake
    document.body.classList.add('screen-shake');
    setTimeout(() => {
      document.body.classList.remove('screen-shake');
    }, 500);
    
    // Ripple effect
    const ripple = document.createElement('div');
    ripple.className = 'ripple-effect';
    this.elements.matchGraphics.appendChild(ripple);
    
    // Position randomly in the graphics container
    ripple.style.left = `${Math.random() * 80 + 10}%`;
    ripple.style.top = `${Math.random() * 80 + 10}%`;
    
    setTimeout(() => {
      ripple.remove();
    }, 1000);
    
    // Additional effects for sixes
    if (isSix) {
      this.createBallTrail();
      setTimeout(() => {
        const randomComment = this.getRandomCommentary('six');
        this.showNotification(`SIX! ${randomComment}`, 'info');
      }, 300);
    }
  }

  // Create umpire signal
  createUmpireSignal(signal) {
    const umpire = document.createElement('div');
    umpire.className = 'umpire-signal';
    umpire.textContent = signal;
    document.body.appendChild(umpire);
    
    setTimeout(() => {
      umpire.remove();
    }, 2000);
  }

  // End current inning
  async endInning() {
    this.disableButtons();

    // Save first innings data
    this.state.firstInningsData = {
      totalRuns: this.state.runs,
      totalWickets: this.state.wickets,
      balls: this.state.legalBalls,
      batterStats: this.state.batterStats,
      bowlerStats: this.state.bowlerStats,
      ballByBall: this.state.ballByBall,
      fallOfWickets: this.state.fallOfWickets,
      overSummaries: this.state.overSummaries,
      team1Name: this.teams.team1Name,
      team2Name: this.teams.team2Name,
      format: this.currentFormat.name,
      timestamp: Date.now()
    };

    // Set target (runs + 1)
    this.state.target = this.state.runs + 1;
    this.state.chasingTeam = this.battingFirst === "player1" ? "player2" : "player1";

    // Update UI
    this.elements.targetDisplay.style.display = 'block';
    this.elements.targetValue.textContent = this.state.target;
    document.getElementById('summaryTitle').textContent = "First Innings Summary";
    document.getElementById('startSecondInningsBtn').textContent = "🏏 Start Second Innings";
    document.getElementById('startSecondInningsBtn').style.display = 'block';
    
    // Show summary popup
    this.showSummaryPopup();

    this.elements.result.textContent = `First innings ended! Target is ${this.state.target}`;
    this.showNotification("First innings completed! Target set.", 'info');
    
    // Mark first innings as completed
    this.state.firstInningsCompleted = true;
    await set(this.firebase.firstInningsCompletedRef, true);
    await set(this.firebase.firstInningsRef, this.state.firstInningsData);
  }

  // Show summary popup
  showSummaryPopup() {
    this.elements.summaryPopup.style.display = 'block';
    
    // Update summary data
    this.elements.summaryTotalRuns.textContent = this.state.runs;
    this.elements.summaryWickets.textContent = this.state.wickets;
    this.elements.summaryOvers.textContent = 
      `${Math.floor(this.state.legalBalls/6)}.${this.state.legalBalls%6}`;
    
    const completedOvers = Math.floor(this.state.legalBalls / 6) + (this.state.legalBalls % 6) / 10;
    const rr = completedOvers > 0 ? (this.state.runs / completedOvers).toFixed(2) : '0.00';
    this.elements.summaryRunRate.textContent = rr;
    
    // Set highlight based on performance
    if (this.state.runs >= 200) {
      this.elements.summaryHighlight.textContent = "Excellent Batting Performance!";
    } else if (this.state.runs >= 150) {
      this.elements.summaryHighlight.textContent = "Good Total Posted!";
    } else if (this.state.runs <= 100) {
      this.elements.summaryHighlight.textContent = "Bowlers Dominated This Innings";
    } else {
      this.elements.summaryHighlight.textContent = "Competitive Total";
    }
  }

  // Start second innings
  async startSecondInnings() {
    try {
      // Reset game state for second innings
      this.state.runs = 0;
      this.state.wickets = 0;
      this.state.legalBalls = 0;
      this.state.lastOverRuns = 0;
      this.state.lastOverWickets = 0;
      this.state.lastWicketScore = 0;
      this.state.ballByBall = {};
      this.state.fallOfWickets = [];
      this.state.overSummaries = [];
      this.state.zerosThisOver = { player1: 0, player2: 0 };
      this.state.freeHit = false;
      this.state.freeHitNextBall = false;
      
      // Reverse roles - chasing team bats second
      this.battingFirst = this.state.chasingTeam;
      this.state.isBatting = (this.playerRole === this.battingFirst);
      
      // Update UI
      this.elements.battingTeamName.textContent = this.battingFirst === "player1" ? 
        this.teams.team1Name : this.teams.team2Name;
      this.elements.roleText.textContent = this.state.isBatting ? "You are Batting" : "You are Bowling";
      document.getElementById('inningsNumber').textContent = "2nd Innings";
      
      // Reset player stats for second innings
      this.initPlayerStats();
      
      // Update target display
      this.elements.targetDisplay.style.display = 'block';
      this.elements.targetValue.textContent = this.state.target;
      
      // Hide summary popup
      this.elements.summaryPopup.style.display = 'none';
      
      // Mark second innings as started
      this.state.secondInningsStarted = true;
      await set(this.firebase.secondInningsStartedRef, true);
      
      // Start the innings
      await this.setupRole();
      
      this.showNotification("Second innings started! Target: " + this.state.target, 'info');
    } catch (error) {
      console.error("Error starting second innings:", error);
      this.showNotification("Failed to start second innings", 'error');
    }
  }

  // End match
  async endMatch(chasingTeamWon) {
    this.disableButtons();
    
    // Correct winner determination
    const winner = chasingTeamWon ? this.state.chasingTeam : 
      (this.battingFirst === "player1" ? "player2" : "player1");
    const winnerName = winner === "player1" ? this.teams.team1Name : this.teams.team2Name;
    
    // Update result
    const winningMargin = chasingTeamWon 
      ? `${this.currentFormat.totalWickets - this.state.wickets} wickets` 
      : `${this.state.target - this.state.runs - 1} runs`;
    
    this.elements.result.innerHTML = `<strong>${winnerName} won by ${winningMargin}</strong>`;
    
    // Determine player of the match
    let pom = this.determinePlayerOfMatch();
    
    // Show match summary with both innings data
    this.showMatchSummary(winnerName, winningMargin, pom);
    
    // Create confetti for winner
    this.createConfetti();
    
    // Save match result
    await set(this.firebase.resultRef, {
      winner: winner,
      winningMargin: winningMargin,
      firstInnings: this.state.firstInningsData,
      secondInnings: {
        totalRuns: this.state.runs,
        totalWickets: this.state.wickets,
        balls: this.state.legalBalls,
        batterStats: this.state.batterStats,
        bowlerStats: this.state.bowlerStats
      },
      playerOfTheMatch: pom,
      timestamp: Date.now()
    });
  }

  // Determine player of the match
  determinePlayerOfMatch() {
    let pom = null;
    let pomStats = null;
    
    // Check batters first
    for (const player in this.state.batterStats) {
      const stats = this.state.batterStats[player];
      if (!pom || stats.runs > pomStats.runs) {
        pom = player;
        pomStats = { ...stats, type: 'batting' };
      }
    }
    
    // Check bowlers
    for (const player in this.state.bowlerStats) {
      const stats = this.state.bowlerStats[player];
      if (!pom || 
          (stats.wickets > (pomStats.wickets || 0)) || 
          (stats.wickets === pomStats.wickets && stats.runs/stats.overs < (pomStats.runs/pomStats.overs || Infinity))) {
        pom = player;
        pomStats = { ...stats, type: 'bowling' };
      }
    }
    
    return pom;
  }

  // Show match summary
  showMatchSummary(winnerName, winningMargin, pom) {
    document.getElementById('summaryTitle').textContent = "Match Result";
    document.getElementById('summaryHighlight').textContent = `${winnerName} won the match by ${winningMargin}!`;
    document.getElementById('startSecondInningsBtn').style.display = 'none';
    
    // Calculate run rates
    const firstInningsRR = (this.state.firstInningsData.totalRuns / (this.state.firstInningsData.balls / 6)).toFixed(2);
    const secondInningsRR = (this.state.runs / (this.state.legalBalls / 6)).toFixed(2);
    
    // Update stats tables
    this.updateStatsTables();
    
    // Update summary content
    const summaryContent = document.querySelector('.summary-content');
    summaryContent.innerHTML = `
      <div class="summary-row">
        <span class="summary-label">First Innings:</span>
        <span class="summary-value">${this.state.firstInningsData.totalRuns}/${this.state.firstInningsData.totalWickets} (${Math.floor(this.state.firstInningsData.balls/6)}.${this.state.firstInningsData.balls%6} overs, RR: ${firstInningsRR})</span>
      </div>
      <div class="summary-row">
        <span class="summary-label">Second Innings:</span>
        <span class="summary-value">${this.state.runs}/${this.state.wickets} (${Math.floor(this.state.legalBalls/6)}.${this.state.legalBalls%6} overs, RR: ${secondInningsRR})</span>
      </div>
      <div class="summary-highlight">${winnerName} won by ${winningMargin}</div>
    `;
    
    // Show player of the match
    if (pom) {
      document.getElementById('pomDisplay').style.display = 'flex';
      document.getElementById('pomValue').textContent = pom;
      
      // Add awards
      this.showAwards();
    }
    
    // Add save match button
    const saveMatchBtn = document.createElement('button');
    saveMatchBtn.textContent = '💾 Save Match Data';
    saveMatchBtn.style.marginTop = '10px';
    saveMatchBtn.style.width = '100%';
    saveMatchBtn.addEventListener('click', () => this.saveMatchData());
    summaryContent.appendChild(saveMatchBtn);
    
    // Show popup
    this.elements.summaryPopup.style.display = 'block';
  }

  // Update stats tables
  updateStatsTables() {
    // Update batters stats
    const battersStatsBody = document.getElementById('battersStatsBody');
    battersStatsBody.innerHTML = '';
    const battingTeam = this.battingFirst === "player1" ? this.teams.team1Players : this.teams.team2Players;
    
    battingTeam.forEach(player => {
      const stats = this.state.batterStats[player] || { runs: 0, balls: 0, fours: 0, sixes: 0 };
      const sr = stats.balls > 0 ? ((stats.runs / stats.balls) * 100).toFixed(2) : '0.00';
      
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${player}</td>
        <td>${stats.runs}</td>
        <td>${stats.balls}</td>
        <td>${sr}</td>
        <td>${stats.fours}/${stats.sixes}</td>
      `;
      battersStatsBody.appendChild(row);
    });
    
    // Update bowlers stats
    const bowlersStatsBody = document.getElementById('bowlersStatsBody');
    bowlersStatsBody.innerHTML = '';
    const bowlingTeam = this.battingFirst === "player1" ? this.teams.team2Players : this.teams.team1Players;
    
    bowlingTeam.forEach(player => {
      const stats = this.state.bowlerStats[player] || { wickets: 0, runs: 0, overs: 0 };
      const er = stats.overs > 0 ? (stats.runs / stats.overs).toFixed(2) : '0.00';
      
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${player}</td>
        <td>${stats.overs.toFixed(1)}</td>
        <td>${stats.wickets}</td>
        <td>${stats.runs}</td>
        <td>${er}</td>
      `;
      bowlersStatsBody.appendChild(row);
    });
  }

  // Show awards
  showAwards() {
    const awardsContainer = document.getElementById('awardsContainer');
    awardsContainer.style.display = 'flex';
    awardsContainer.innerHTML = '';
    
    // Batting awards
    let topScorer = null;
    let topScore = 0;
    for (const player in this.state.batterStats) {
      if (this.state.batterStats[player].runs > topScore) {
        topScorer = player;
        topScore = this.state.batterStats[player].runs;
      }
    }
    
    if (topScorer) {
      const award = document.createElement('div');
      award.className = 'award-badge';
      award.textContent = `🏆 Top Scorer: ${topScorer} (${topScore} runs)`;
      awardsContainer.appendChild(award);
    }
    
    // Bowling awards
    let topWicketTaker = null;
    let topWickets = 0;
    let bestEconomy = null;
    let bestER = Infinity;
    
    for (const player in this.state.bowlerStats) {
      const stats = this.state.bowlerStats[player];
      if (stats.wickets > topWickets) {
        topWicketTaker = player;
        topWickets = stats.wickets;
      }
      
      const er = stats.overs > 0 ? stats.runs / stats.overs : Infinity;
      if (er < bestER) {
        bestEconomy = player;
        bestER = er;
      }
    }
    
    if (topWicketTaker) {
      const award = document.createElement('div');
      award.className = 'award-badge';
      award.textContent = `🎯 Most Wickets: ${topWicketTaker} (${topWickets} wkts)`;
      awardsContainer.appendChild(award);
    }
    
    if (bestEconomy) {
      const award = document.createElement('div');
      award.className = 'award-badge';
      award.textContent = `💰 Best Economy: ${bestEconomy} (${bestER.toFixed(2)})`;
      awardsContainer.appendChild(award);
    }
  }

  // Save match data
  async saveMatchData() {
    try {
      this.showLoading("Saving match data...");
      
      const matchData = {
        firstInnings: this.state.firstInningsData,
        secondInnings: {
          totalRuns: this.state.runs,
          totalWickets: this.state.wickets,
          balls: this.state.legalBalls,
          batterStats: this.state.batterStats,
          bowlerStats: this.state.bowlerStats,
          fallOfWickets: this.state.fallOfWickets,
          overSummaries: this.state.overSummaries
        },
        winner: this.state.chasingTeamWon ? this.state.chasingTeam : 
          (this.battingFirst === "player1" ? "player2" : "player1"),
        winningMargin: this.state.chasingTeamWon 
          ? `${this.currentFormat.totalWickets - this.state.wickets} wickets` 
          : `${this.state.target - this.state.runs - 1} runs`,
        playerOfTheMatch: this.determinePlayerOfMatch(),
        timestamp: Date.now()
      };
      
      // Save to Firebase
      await set(ref(this.firebase.db, `savedMatches/${this.roomId}`), matchData);
      
      this.showNotification("Match data saved successfully!", 'info');
      this.elements.result.textContent = "Match data saved";
    } catch (error) {
      console.error("Error saving match data:", error);
      this.showNotification("Failed to save match data", 'error');
      this.elements.result.textContent = "Error saving match data";
    }
  }

  // Save game state
  async saveGameState() {
    try {
      this.elements.result.textContent = "Saving game...";
      this.disableButtons();
      
      const gameState = {
        room: this.roomId,
        player1: this.playerRole === "player1" ? this.playerRole : this.opponentRole,
        player2: this.playerRole === "player2" ? this.playerRole : this.opponentRole,
        tossWinner: this.tossWinner,
        battingFirst: this.battingFirst,
        team1Score: this.state.runs,
        team1Wickets: Math.floor(this.state.wickets),
        currentBatter: this.state.currentBatter,
        currentBowler: this.state.currentBowler,
        batterStats: this.state.batterStats,
        bowlerStats: this.state.bowlerStats,
        legalBalls: this.state.legalBalls,
        timestamp: Date.now()
      };
      
      await set(ref(this.firebase.db, `savedGames/${this.roomId}`), gameState);
      this.elements.result.textContent = "Game saved successfully!";
      setTimeout(() => window.location.href = "index.html", 2000);
    } catch (error) {
      console.error("Error saving game:", error);
      this.elements.result.textContent = "Error saving game. Please try again.";
      this.enableButtons();
    }
  }

  // Exit game
  async exitGame() {
    if (confirm("Exit without saving?")) {
      await this.resetGame();
      window.location.href = "index.html";
    }
  }

  // Reset game state
  async resetGame() {
    try {
      await set(this.firebase.playerRef, false);
      await update(this.firebase.playsRef, {
        player1: null,
        player2: null
      });
      this.clearCardSelection();
    } catch (error) {
      console.error("Error resetting game:", error);
    }
  }

  // Request reset
  async requestReset() {
    if (this.state.resetCount >= this.state.MAX_RESETS || this.state.isSpectator) {
      this.showNotification(`Maximum resets (${this.state.MAX_RESETS}) reached for this innings`, 'error');
      return;
    }

    try {
      this.state.isResetting = true;
      this.disableButtons();
      this.state.resetCount++;
      
      // Reset both players' selections in Firebase
      await update(ref(this.firebase.db, `rooms/${this.roomId}`), {
        'currentPlays/player1': null,
        'currentPlays/player2': null
      });

      // Clear local selections
      this.clearCardSelection();
      
      // Clear reset request
      await set(this.firebase.resetRequestRef, null);
      
      this.showNotification("Plays have been reset", 'info');
      
      // Re-enable buttons based on current game state
      if (this.state.isBatting) {
        if (!this.state.batterSelected) {
          await this.showBatterSelection();
        } else {
          this.enableButtons();
        }
      } else {
        if (!this.state.bowlerSelected) {
          await this.showBowlerSelection();
        } else {
          this.enableButtons();
        }
      }
    } catch (error) {
      console.error("Error resetting plays:", error);
      this.showNotification("Failed to reset plays", 'error');
      this.enableButtons();
    } finally {
      this.state.isResetting = false;
    }
  }

  // Reset selection modal
  resetSelectionModal() {
    this.elements.selectionModal.style.display = "none";
    this.elements.selectionList.innerHTML = '';
  }

  // Enable/disable card buttons
  updateButtonStates() {
    const canPlay = (this.state.isBatting && this.state.batterSelected) || 
                   (!this.state.isBatting && this.state.bowlerSelected);
    this.elements.buttons.forEach(btn => {
      btn.disabled = !canPlay || this.state.isSpectator;
    });
  }

  // Disable all card buttons
  disableButtons() {
    this.elements.buttons.forEach(btn => {
      btn.disabled = true;
    });
  }

  // Enable all card buttons
  enableButtons() {
    if (this.state.isResetting || this.state.isSpectator) return;
    
    const canPlay = (this.state.isBatting && this.state.batterSelected) || 
                   (!this.state.isBatting && this.state.bowlerSelected);
    this.elements.buttons.forEach(btn => {
      btn.disabled = !canPlay;
    });
    
    if (canPlay) {
      this.elements.result.textContent = this.state.isBatting ? 
        "Select your shot" : "Select your delivery";
    }
  }

  // Clear card selection highlights
  clearCardSelection() {
    this.elements.buttons.forEach(btn => {
      btn.classList.remove("selected");
    });
    this.state.selectedCardValue = null;
    this.state.isProcessingSelection = false;
  }

  // Highlight selected card
  highlightSelectedCard(value) {
    this.elements.buttons.forEach(btn => {
      const val = parseInt(btn.dataset.value);
      btn.classList.toggle("selected", val === value);
    });
  }

  // Show loading spinner
  showLoading(message) {
    this.elements.result.textContent = message;
    this.elements.loadingSpinner.style.display = "block";
  }

  // Hide loading spinner
  hideLoading() {
    this.elements.loadingSpinner.style.display = "none";
  }

  // Handle initialization error
  handleInitError(error) {
    console.error("Initialization failed:", error);
    this.elements.result.innerHTML = `
      Fatal error: ${error.message}<br>
      Please refresh or check console for details.
    `;
    this.elements.result.className = "error";
    this.hideLoading();
  }
}

// Start the game when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
  new CricketGame();
});
</script>
</body>
</html>