<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HandiCricket - First Innings</title>
  <style>
    :root {
      --primary: #061e3e;
      --secondary: #0a2a4a;
      --accent: #ffeb3b;
      --text: #ffffff;
      --text-secondary: #aaaaaa;
      --green: #4CAF50;
      --red: #f44336;
      --orange: #FF9800;
      --purple: #9C27B0;
      --blue: #2196F3;
    }

    body {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: var(--text);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 10px;
      flex: 1;
    }

    /* Compact Header */
    .header {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      margin-bottom: 10px;
      padding: 8px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 6px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      font-size: 14px;
    }

    .match-info {
      color: var(--text-secondary);
      text-align: center;
    }

    .match-info.left {
      text-align: left;
    }

    .match-info.right {
      text-align: right;
    }

    /* Compact Scoreboard */
    .scoreboard {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      background: rgba(13, 42, 82, 0.7);
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      align-items: center;
    }

    .team-score {
      text-align: center;
      padding: 5px;
    }

    .team-name {
      font-weight: bold;
      font-size: 16px;
      margin-bottom: 3px;
      color: var(--accent);
    }

    .score {
      font-size: 20px;
      font-weight: bold;
    }

    .overs {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .match-status {
      text-align: center;
      padding: 0 10px;
    }

    .innings-info {
      font-size: 14px;
      margin-bottom: 3px;
    }

    .run-rate {
      font-size: 12px;
      color: var(--text-secondary);
    }

    /* Compact Game Area */
    .game-area {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }

    .player-comparison {
      background: rgba(13, 42, 82, 0.5);
      padding: 10px;
      border-radius: 6px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .player-comparison h3 {
      margin: 0 0 8px 0;
      font-size: 14px;
      color: var(--accent);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding-bottom: 3px;
    }

    .players-container {
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }

    .player-card {
      flex: 1;
      background: rgba(30, 136, 229, 0.2);
      padding: 8px;
      border-radius: 5px;
      text-align: center;
      font-size: 13px;
    }

    .player-name {
      font-weight: bold;
      margin-bottom: 3px;
    }

    .player-role {
      font-size: 11px;
      color: var(--text-secondary);
      margin-bottom: 5px;
    }

    .player-stats {
      font-size: 12px;
    }

    .player-stats div {
      margin: 2px 0;
    }

    .vs-separator {
      display: flex;
      align-items: center;
      font-weight: bold;
      color: var(--accent);
      font-size: 12px;
    }

    .over-progress {
      background: rgba(13, 42, 82, 0.5);
      padding: 10px;
      border-radius: 6px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .over-progress h3 {
      margin: 0 0 8px 0;
      font-size: 14px;
      color: var(--accent);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding-bottom: 3px;
    }

    .balls-container {
      display: flex;
      gap: 5px;
      margin: 8px 0;
    }

    .ball {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 11px;
      background: rgba(255,255,255,0.1);
    }

    .ball.dot {
      background: rgba(30, 136, 229, 0.7);
    }

    .ball.run {
      background: rgba(76, 175, 80, 0.7);
    }

    .ball.wicket {
      background: rgba(244, 67, 54, 0.7);
    }

    .ball.wide {
      background: rgba(255, 152, 0, 0.7);
    }

    .ball.noball {
      background: rgba(156, 39, 176, 0.7);
    }

    .ball.freehit {
      background: rgba(255, 235, 59, 0.7);
      color: black;
    }

    .over-info {
      font-size: 12px;
      margin-bottom: 3px;
    }

    .partnership-info {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .match-timeline {
      grid-column: span 2;
      background: rgba(13, 42, 82, 0.5);
      padding: 10px;
      border-radius: 6px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      max-height: 150px;
      overflow-y: auto;
    }

    .match-timeline h3 {
      margin: 0 0 8px 0;
      font-size: 14px;
      color: var(--accent);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding-bottom: 3px;
    }

    .timeline-event {
      padding: 3px 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      font-size: 12px;
    }

    .timeline-event.wicket {
      color: var(--red);
    }

    .timeline-event.boundary {
      color: var(--green);
    }

    .timeline-event.milestone {
      color: var(--accent);
    }

    .timeline-event.powerplay {
      color: var(--purple);
    }

    .timeline-event.other {
      color: var(--text-secondary);
    }

    /* Compact Controls */
    .controls {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 10px;
    }

    .card-selection {
      display: flex;
      justify-content: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .card-btn {
      width: 40px;
      height: 56px;
      border-radius: 6px;
      border: none;
      background: linear-gradient(145deg, #1e88e5, #1565c0);
      color: white;
      font-size: 20px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .card-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }

    .card-btn:active {
      transform: translateY(1px);
    }

    .card-btn.selected {
      background: linear-gradient(145deg, var(--accent), #fbc02d);
      color: black;
    }

    .card-btn[disabled] {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .action-buttons {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 5px;
    }

    .action-btn {
      padding: 8px 15px;
      border-radius: 5px;
      border: none;
      background: linear-gradient(145deg, var(--green), #2E7D32);
      color: white;
      font-size: 12px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }

    .action-btn.timeout {
      background: linear-gradient(145deg, var(--orange), #E65100);
    }

    .action-btn.reset {
      background: linear-gradient(145deg, var(--red), #d32f2f);
    }

    .action-btn.teams {
      background: linear-gradient(145deg, var(--purple), #7B1FA2);
    }

    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .action-btn:active {
      transform: translateY(1px);
    }

    /* Notification */
    .notification {
      position: fixed;
      top: 15px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 10px 20px;
      border-radius: 6px;
      z-index: 100;
      display: none;
      animation: fadeIn 0.3s;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      text-align: center;
      max-width: 90%;
      font-size: 14px;
    }

    @keyframes fadeIn {
      from { opacity: 0; top: 0; }
      to { opacity: 1; top: 15px; }
    }

    .notification.wicket {
      background: rgba(244, 67, 54, 0.9);
    }

    .notification.boundary {
      background: rgba(76, 175, 80, 0.9);
    }

    .notification.milestone {
      background: rgba(255, 193, 7, 0.9);
      color: black;
    }

    .notification.timeout {
      background: rgba(255, 152, 0, 0.9);
    }

    .notification-title {
      font-weight: bold;
      margin-bottom: 3px;
      font-size: 16px;
    }

    .notification-desc {
      font-size: 12px;
    }

    /* Timeout Timer */
    .timeout-timer {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.9);
      color: var(--accent);
      padding: 20px 30px;
      border-radius: 10px;
      z-index: 1000;
      display: none;
      font-size: 24px;
      font-weight: bold;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }

    /* Innings Break */
    .innings-break {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.9);
      color: white;
      padding: 20px 30px;
      border-radius: 10px;
      z-index: 1000;
      display: none;
      text-align: center;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }

    .break-title {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 10px;
      color: var(--accent);
    }

    .break-timer {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .break-message {
      font-size: 16px;
      color: var(--text-secondary);
    }

    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: linear-gradient(145deg, #123456, #0a1f3a);
      border-radius: 10px;
      padding: 15px;
      width: 90%;
      max-width: 450px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 5px 20px rgba(0,0,0,0.5);
      border: 1px solid rgba(255,255,255,0.1);
      animation: modalFadeIn 0.3s;
    }

    @keyframes modalFadeIn {
      from { opacity: 0; transform: translateY(-15px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .modal-title {
      margin: 0;
      color: var(--accent);
      font-size: 16px;
    }

    .close-modal {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 20px;
      cursor: pointer;
    }

    .player-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .player-item {
      padding: 8px;
      margin: 3px 0;
      background: rgba(30, 136, 229, 0.2);
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
    }

    .player-item:hover {
      background: rgba(30, 136, 229, 0.4);
    }

    .player-item.selected {
      background: rgba(76, 175, 80, 0.4);
      border-left: 3px solid var(--green);
    }

    .player-name {
      font-weight: bold;
    }

    .player-stats {
      font-size: 11px;
      color: var(--text-secondary);
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 10px;
    }

    .modal-btn {
      padding: 6px 12px;
      border-radius: 5px;
      border: none;
      background: linear-gradient(145deg, #1e88e5, #1565c0);
      color: white;
      font-size: 12px;
      cursor: pointer;
    }

    .modal-btn.cancel {
      background: linear-gradient(145deg, var(--red), #d32f2f);
    }

    /* Innings summary modal */
    .summary-stats {
      margin: 10px 0;
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      font-size: 14px;
    }

    .stat-label {
      color: var(--text-secondary);
    }

    .stat-value {
      font-weight: bold;
    }

    /* Teams modal */
    .teams-container {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .team-column {
      flex: 1;
    }

    .team-title {
      font-weight: bold;
      color: var(--accent);
      margin-bottom: 8px;
      padding-bottom: 3px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      font-size: 14px;
    }

    /* Responsive styles */
    @media (max-width: 768px) {
      .header {
        grid-template-columns: 1fr;
        text-align: center;
        gap: 5px;
      }

      .match-info.left, .match-info.right {
        text-align: center;
      }

      .scoreboard {
        grid-template-columns: 1fr;
        gap: 8px;
      }

      .game-area {
        grid-template-columns: 1fr;
      }

      .card-btn {
        width: 35px;
        height: 50px;
        font-size: 18px;
      }

      .action-btn {
        padding: 6px 12px;
        font-size: 11px;
      }
    }

    /* Animation for ball hit */
    @keyframes ballHit {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }

    .ball-hit {
      animation: ballHit 0.3s;
    }

    /* Animation for wicket */
    @keyframes wicketFall {
      0% { transform: rotate(0); }
      25% { transform: rotate(10deg); }
      50% { transform: rotate(-10deg); }
      75% { transform: rotate(5deg); }
      100% { transform: rotate(0); }
    }

    .wicket-fall {
      animation: wicketFall 0.5s;
    }

    /* Disabled state */
    .disabled {
      opacity: 0.5;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="match-info left">
        <div id="matchFormat">T20 Match</div>
        <div id="matchDate"></div>
      </div>
      <div id="inningsInfo">1st Innings</div>
      <div class="match-info right">
        <div id="matchStatus">In Progress</div>
        <div id="powerplayStatus"></div>
      </div>
    </div>

    <div class="scoreboard">
      <div class="team-score">
        <div class="team-name" id="battingTeamName">Batting Team</div>
        <div class="score" id="battingScore">0/0</div>
        <div class="overs" id="battingOvers">0.0 overs</div>
      </div>
      <div class="match-status">
        <div class="innings-info" id="inningsStatus">First Innings</div>
        <div class="run-rate" id="runRate">RR: 0.00</div>
      </div>
      <div class="team-score">
        <div class="team-name" id="bowlingTeamName">Bowling Team</div>
        <div class="score" id="bowlingOvers">0.0 overs</div>
      </div>
    </div>

    <div class="game-area">
      <div class="player-comparison">
        <h3>Current Players</h3>
        <div class="players-container">
          <div class="player-card">
            <div class="player-name" id="currentBatter">Batter</div>
            <div class="player-role">Batting</div>
            <div class="player-stats">
              <div>Runs: <span id="batterRuns">0</span></div>
              <div>Balls: <span id="batterBalls">0</span></div>
              <div>SR: <span id="batterSR">0.00</span></div>
              <div>Dots: <span id="batterDots">0</span></div>
            </div>
          </div>
          <div class="vs-separator">VS</div>
          <div class="player-card">
            <div class="player-name" id="currentBowler">Bowler</div>
            <div class="player-role">Bowling</div>
            <div class="player-stats">
              <div>Overs: <span id="bowlerOvers">0</span></div>
              <div>Wkts: <span id="bowlerWickets">0</span></div>
              <div>ER: <span id="bowlerER">0.00</span></div>
              <div>NB/Wd: <span id="bowlerExtras">0</span></div>
            </div>
          </div>
        </div>
      </div>

      <div class="over-progress">
        <h3>Current Over</h3>
        <div class="balls-container" id="ballsContainer">
          <!-- Balls will be added here dynamically -->
        </div>
        <div class="over-info" id="overInfo">Over 0.0</div>
        <div class="partnership-info" id="partnershipInfo">Partnership: 0 (0 balls)</div>
      </div>

      <div class="match-timeline">
        <h3>Match Timeline</h3>
        <div id="timelineEvents">
          <!-- Timeline events will be added here -->
        </div>
      </div>
    </div>

    <div class="controls">
      <div class="card-selection" id="cardSelection">
        <button class="card-btn" data-value="0">0</button>
        <button class="card-btn" data-value="1">1</button>
        <button class="card-btn" data-value="2">2</button>
        <button class="card-btn" data-value="3">3</button>
        <button class="card-btn" data-value="4">4</button>
        <button class="card-btn" data-value="5">5</button>
        <button class="card-btn" data-value="6">6</button>
      </div>
      <div class="action-buttons">
        <button class="action-btn" id="submitBtn">Submit</button>
        <button class="action-btn timeout" id="timeoutBtn">Timeout</button>
        <button class="action-btn reset" id="resetBtn">Reset</button>
        <button class="action-btn teams" id="teamsBtn">Teams</button>
      </div>
    </div>
  </div>

  <!-- Notification -->
  <div class="notification" id="notification">
    <div class="notification-title" id="notificationTitle">Notification</div>
    <div class="notification-desc" id="notificationDesc">Description</div>
  </div>

  <!-- Timeout Timer -->
  <div class="timeout-timer" id="timeoutTimer">
    Timeout: <span id="timeoutCountdown">60</span>s
  </div>

  <!-- Innings Break -->
  <div class="innings-break" id="inningsBreak">
    <div class="break-title">Innings Break</div>
    <div class="break-timer" id="breakTimer">1:30</div>
    <div class="break-message">Second innings will begin shortly</div>
  </div>

  <!-- Player Selection Modal -->
  <div class="modal" id="playerModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="playerModalTitle">Select Player</h3>
        <button class="close-modal" id="closePlayerModal">&times;</button>
      </div>
      <ul class="player-list" id="playerModalList">
        <!-- Players will be added here -->
      </ul>
      <div class="modal-actions">
        <button class="modal-btn cancel" id="cancelPlayerSelect">Cancel</button>
        <button class="modal-btn" id="confirmPlayerSelect" disabled>Select</button>
      </div>
    </div>
  </div>

  <!-- Innings Summary Modal -->
  <div class="modal" id="summaryModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Innings Summary</h3>
        <button class="close-modal" id="closeSummaryModal">&times;</button>
      </div>
      <div class="summary-stats" id="summaryStats">
        <!-- Summary stats will be added here -->
      </div>
      <div class="modal-actions">
        <button class="modal-btn" id="continueBtn">Continue</button>
      </div>
    </div>
  </div>

  <!-- Teams Modal -->
  <div class="modal" id="teamsModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Teams</h3>
        <button class="close-modal" id="closeTeamsModal">&times;</button>
      </div>
      <div class="teams-container">
        <div class="team-column">
          <div class="team-title" id="team1Title">Team 1</div>
          <ul class="player-list" id="team1Players">
            <!-- Team 1 players will be added here -->
          </ul>
        </div>
        <div class="team-column">
          <div class="team-title" id="team2Title">Team 2</div>
          <ul class="player-list" id="team2Players">
            <!-- Team 2 players will be added here -->
          </ul>
        </div>
      </div>
      <div class="modal-actions">
        <button class="modal-btn" id="closeTeamsBtn">Close</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, get, push } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCN6aZMwlsZe7JJaovU0WA3UQygWr4jYmA",
      authDomain: "handicricket-85a06.firebaseapp.com",
      projectId: "handicricket-85a06",
      storageBucket: "handicricket-85a06.appspot.com",
      messagingSenderId: "599182538558",
      appId: "1:599182538558:web:3e965753ab05f8f1e3de6f",
      measurementId: "G-HSV9H4LEJQ"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Get URL parameters
    const params = new URLSearchParams(window.location.search);
    const roomId = params.get('room');
    const playerRole = params.get('player');
    const isSpectator = playerRole === 'spectator';

    if (!roomId || (!isSpectator && !playerRole)) {
      alert('Invalid room or player');
      window.location.href = 'index.html';
    }

    // Firebase references
    const roomRef = ref(db, `rooms/${roomId}`);
    const matchRef = ref(db, `matches/${roomId}`);
    const playerRef = ref(db, `rooms/${roomId}/${playerRole}`);
    const teamsRef = ref(db, `rooms/${roomId}/teams`);
    const tossRef = ref(db, `rooms/${roomId}/toss`);
    const firstInningsRef = ref(db, `matches/${roomId}/firstInnings`);
    const secondInningsRef = ref(db, `matches/${roomId}/secondInnings`);
    const timeoutRef = ref(db, `matches/${roomId}/timeout`);
    const inningsBreakRef = ref(db, `matches/${roomId}/inningsBreak`);

    // Game state
    let gameState = {
      battingTeam: null,
      bowlingTeam: null,
      currentBatter: null,
      currentBowler: null,
      batterStats: {},
      bowlerStats: {},
      totalRuns: 0,
      totalWickets: 0,
      balls: 0,
      overs: 0,
      currentOver: [],
      innings: 1,
      powerplay: true,
      freeHit: false,
      selectedCard: null,
      batterCards: [],
      bowlerCards: [],
      consecutiveZeros: { batter: 0, bowler: 0 },
      matchFormat: null,
      maxOvers: null,
      powerplayOvers: null,
      players: {
        player1: [],
        player2: []
      },
      captains: {
        player1: null,
        player2: null
      },
      viceCaptains: {
        player1: null,
        player2: null
      },
      teamNames: {
        player1: null,
        player2: null
      },
      tossWinner: null,
      battingFirst: null,
      battingChoice: null,
      matchStarted: false,
      inningsCompleted: false,
      matchCompleted: false,
      winner: null,
      winningMargin: null,
      playerOfTheMatch: null,
      timeoutActive: false,
      inningsBreakActive: false,
      processingBall: false
    };

    // DOM elements
    const elements = {
      matchFormat: document.getElementById('matchFormat'),
      matchDate: document.getElementById('matchDate'),
      inningsInfo: document.getElementById('inningsInfo'),
      matchStatus: document.getElementById('matchStatus'),
      powerplayStatus: document.getElementById('powerplayStatus'),
      battingTeamName: document.getElementById('battingTeamName'),
      battingScore: document.getElementById('battingScore'),
      battingOvers: document.getElementById('battingOvers'),
      inningsStatus: document.getElementById('inningsStatus'),
      runRate: document.getElementById('runRate'),
      bowlingTeamName: document.getElementById('bowlingTeamName'),
      bowlingOvers: document.getElementById('bowlingOvers'),
      currentBatter: document.getElementById('currentBatter'),
      batterRuns: document.getElementById('batterRuns'),
      batterBalls: document.getElementById('batterBalls'),
      batterSR: document.getElementById('batterSR'),
      batterDots: document.getElementById('batterDots'),
      currentBowler: document.getElementById('currentBowler'),
      bowlerOvers: document.getElementById('bowlerOvers'),
      bowlerWickets: document.getElementById('bowlerWickets'),
      bowlerER: document.getElementById('bowlerER'),
      bowlerExtras: document.getElementById('bowlerExtras'),
      ballsContainer: document.getElementById('ballsContainer'),
      overInfo: document.getElementById('overInfo'),
      partnershipInfo: document.getElementById('partnershipInfo'),
      timelineEvents: document.getElementById('timelineEvents'),
      cardSelection: document.getElementById('cardSelection'),
      submitBtn: document.getElementById('submitBtn'),
      timeoutBtn: document.getElementById('timeoutBtn'),
      resetBtn: document.getElementById('resetBtn'),
      teamsBtn: document.getElementById('teamsBtn'),
      notification: document.getElementById('notification'),
      notificationTitle: document.getElementById('notificationTitle'),
      notificationDesc: document.getElementById('notificationDesc'),
      timeoutTimer: document.getElementById('timeoutTimer'),
      timeoutCountdown: document.getElementById('timeoutCountdown'),
      inningsBreak: document.getElementById('inningsBreak'),
      breakTimer: document.getElementById('breakTimer'),
      playerModal: document.getElementById('playerModal'),
      playerModalTitle: document.getElementById('playerModalTitle'),
      playerModalList: document.getElementById('playerModalList'),
      closePlayerModal: document.getElementById('closePlayerModal'),
      cancelPlayerSelect: document.getElementById('cancelPlayerSelect'),
      confirmPlayerSelect: document.getElementById('confirmPlayerSelect'),
      summaryModal: document.getElementById('summaryModal'),
      summaryStats: document.getElementById('summaryStats'),
      closeSummaryModal: document.getElementById('closeSummaryModal'),
      continueBtn: document.getElementById('continueBtn'),
      teamsModal: document.getElementById('teamsModal'),
      team1Title: document.getElementById('team1Title'),
      team1Players: document.getElementById('team1Players'),
      team2Title: document.getElementById('team2Title'),
      team2Players: document.getElementById('team2Players'),
      closeTeamsModal: document.getElementById('closeTeamsModal'),
      closeTeamsBtn: document.getElementById('closeTeamsBtn')
    };

    // Initialize the game
    async function initGame() {
      // Set current date
      const now = new Date();
      elements.matchDate.textContent = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();

      // Load room data
      const roomSnap = await get(roomRef);
      if (!roomSnap.exists()) {
        alert('Room not found');
        window.location.href = 'index.html';
        return;
      }

      const roomData = roomSnap.val();

      // Load teams data
      const teamsSnap = await get(teamsRef);
      if (teamsSnap.exists()) {
        const teamsData = teamsSnap.val();
        gameState.players.player1 = teamsData.player1?.players || [];
        gameState.players.player2 = teamsData.player2?.players || [];
        gameState.captains.player1 = teamsData.player1?.captain || null;
        gameState.captains.player2 = teamsData.player2?.captain || null;
        gameState.viceCaptains.player1 = teamsData.player1?.viceCaptain || null;
        gameState.viceCaptains.player2 = teamsData.player2?.viceCaptain || null;
        gameState.teamNames.player1 = teamsData.player1?.name || 'Team A';
        gameState.teamNames.player2 = teamsData.player2?.name || 'Team B';
      }

      // Load toss data
      const tossSnap = await get(tossRef);
      if (tossSnap.exists()) {
        const tossData = tossSnap.val();
        gameState.tossWinner = tossData.winner;
        gameState.battingFirst = tossData.battingFirst;
        gameState.battingChoice = tossData.battingChoice;
      }

      // Determine batting and bowling teams
      if (gameState.battingFirst === 'player1') {
        gameState.battingTeam = 'player1';
        gameState.bowlingTeam = 'player2';
      } else {
        gameState.battingTeam = 'player2';
        gameState.bowlingTeam = 'player1';
      }

      // Set match format
      gameState.matchFormat = roomData.player1?.format || '20';
      gameState.maxOvers = parseInt(gameState.matchFormat);
      gameState.powerplayOvers = calculatePowerplayOvers(gameState.matchFormat);

      // Update UI with format info
      const formatNames = {
        '5': 'T5 (5 Overs)',
        '10': 'T10 (10 Overs)',
        '20': 'T20 (20 Overs)',
        '50': 'ODI (50 Overs)'
      };
      elements.matchFormat.textContent = formatNames[gameState.matchFormat] || gameState.matchFormat;

      // Initialize match in Firebase if not already done
      const matchSnap = await get(matchRef);
      if (!matchSnap.exists()) {
        await set(matchRef, {
          team1Name: gameState.teamNames.player1,
          team2Name: gameState.teamNames.player2,
          format: gameState.matchFormat,
          tossWinner: gameState.tossWinner,
          battingFirst: gameState.battingFirst,
          battingChoice: gameState.battingChoice,
          matchStarted: true,
          firstInnings: {
            battingTeam: gameState.battingTeam,
            bowlingTeam: gameState.bowlingTeam,
            totalRuns: 0,
            totalWickets: 0,
            balls: 0,
            batterStats: {},
            bowlerStats: {},
            extras: {
              wides: 0,
              noballs: 0,
              byes: 0,
              legbyes: 0
            }
          }
        });
      }

      // Set player online status
      if (!isSpectator) {
        set(playerRef, {
          connected: true,
          lastActive: Date.now()
        });
      }

      // Update UI
      updateTeamNames();
      updatePowerplayStatus();

      // Start the game
      if (isSpectator) {
        setupSpectatorMode();
      } else {
        setupPlayerMode();
      }

      // Load existing match data
      loadMatchData();

      // Listen for timeout and innings break
      onValue(timeoutRef, (snap) => {
        if (snap.exists() && snap.val().active) {
          startTimeout(snap.val().duration);
        }
      });

      onValue(inningsBreakRef, (snap) => {
        if (snap.exists() && snap.val().active) {
          startInningsBreak(snap.val().duration);
        }
      });
    }

    function calculatePowerplayOvers(format) {
      switch (format) {
        case '5': return 2;
        case '10': return 3;
        case '20': return 6;
        case '50': return 10;
        default: return 6;
      }
    }

    function updateTeamNames() {
      elements.battingTeamName.textContent = gameState.battingTeam === 'player1' ? 
        gameState.teamNames.player1 : gameState.teamNames.player2;
      elements.bowlingTeamName.textContent = gameState.bowlingTeam === 'player1' ? 
        gameState.teamNames.player1 : gameState.teamNames.player2;
    }

    function updatePowerplayStatus() {
      const powerplayEndOver = gameState.powerplayOvers;
      if (gameState.overs < powerplayEndOver) {
        gameState.powerplay = true;
        elements.powerplayStatus.textContent = `Powerplay (ends ${powerplayEndOver} overs)`;
      } else {
        gameState.powerplay = false;
        elements.powerplayStatus.textContent = '';
      }
    }

    function setupSpectatorMode() {
      // Disable controls for spectators
      elements.cardSelection.querySelectorAll('.card-btn').forEach(btn => {
        btn.disabled = true;
      });
      elements.submitBtn.disabled = true;
      elements.resetBtn.disabled = true;
      elements.timeoutBtn.disabled = true;

      // Update status
      elements.matchStatus.textContent = 'Spectator Mode';
    }

    function setupPlayerMode() {
      // Set up event listeners
      setupEventListeners();

      // Check if we need to select players
      checkPlayerSelection();
    }

    function setupEventListeners() {
      // Card selection
      elements.cardSelection.querySelectorAll('.card-btn').forEach(btn => {
        btn.addEventListener('click', () => selectCard(parseInt(btn.dataset.value)));
      });

      // Submit button
      elements.submitBtn.addEventListener('click', submitCards);

      // Timeout button
      elements.timeoutBtn.addEventListener('click', startTimeoutRequest);

      // Reset button
      elements.resetBtn.addEventListener('click', resetSelection);

      // Teams button
      elements.teamsBtn.addEventListener('click', showTeams);

      // Modal buttons
      elements.closePlayerModal.addEventListener('click', () => elements.playerModal.style.display = 'none');
      elements.cancelPlayerSelect.addEventListener('click', () => elements.playerModal.style.display = 'none');
      elements.confirmPlayerSelect.addEventListener('click', confirmPlayerSelection);
      elements.closeSummaryModal.addEventListener('click', () => elements.summaryModal.style.display = 'none');
      elements.closeTeamsModal.addEventListener('click', () => elements.teamsModal.style.display = 'none');
      elements.closeTeamsBtn.addEventListener('click', () => elements.teamsModal.style.display = 'none');
      elements.continueBtn.addEventListener('click', continueToNextInnings);
    }

    function selectCard(value) {
      if (gameState.processingBall || gameState.timeoutActive || gameState.inningsBreakActive) return;
      
      // Clear previous selection
      elements.cardSelection.querySelectorAll('.card-btn').forEach(btn => {
        btn.classList.remove('selected');
      });

      // Set new selection
      gameState.selectedCard = value;
      const selectedBtn = elements.cardSelection.querySelector(`.card-btn[data-value="${value}"]`);
      selectedBtn.classList.add('selected');
    }

    async function submitCards() {
      if (gameState.processingBall || gameState.timeoutActive || gameState.inningsBreakActive) return;
      
      if (gameState.selectedCard === null) {
        showNotification('Error', 'Please select a card first');
        return;
      }

      // Disable controls while processing
      setProcessingState(true);

      // Add card to current player's array
      if (playerRole === gameState.battingTeam) {
        gameState.batterCards.push(gameState.selectedCard);
      } else {
        gameState.bowlerCards.push(gameState.selectedCard);
      }

      // If both players have submitted, process the ball
      if (gameState.batterCards.length > 0 && gameState.bowlerCards.length > 0) {
        await processBall();
      } else {
        // Wait for other player
        showNotification('Waiting', 'Waiting for opponent to submit their card');
        resetSelection();
        setProcessingState(false);
      }
    }

    function setProcessingState(processing) {
      gameState.processingBall = processing;
      document.getElementById('container').classList.toggle('disabled', processing);
    }

    function startTimeoutRequest() {
      if (gameState.timeoutActive || gameState.inningsBreakActive) return;
      
      // Set timeout in Firebase (60 seconds)
      set(timeoutRef, {
        active: true,
        duration: 60,
        timestamp: Date.now()
      });
    }

    function startTimeout(duration) {
      gameState.timeoutActive = true;
      elements.timeoutCountdown.textContent = duration;
      elements.timeoutTimer.style.display = 'block';
      
      showNotification('Timeout', 'Game paused for timeout');
      setProcessingState(true);

      // Start countdown
      let remaining = duration;
      const timer = setInterval(() => {
        remaining--;
        elements.timeoutCountdown.textContent = remaining;
        
        if (remaining <= 0) {
          clearInterval(timer);
          endTimeout();
        }
      }, 1000);
    }

    function endTimeout() {
      gameState.timeoutActive = false;
      elements.timeoutTimer.style.display = 'none';
      setProcessingState(false);
      update(timeoutRef, { active: false });
    }

    function startInningsBreak(duration = 90) {
      gameState.inningsBreakActive = true;
      elements.breakTimer.textContent = formatTime(duration);
      elements.inningsBreak.style.display = 'flex';
      setProcessingState(true);

      // Start countdown
      let remaining = duration;
      const timer = setInterval(() => {
        remaining--;
        elements.breakTimer.textContent = formatTime(remaining);
        
        if (remaining <= 0) {
          clearInterval(timer);
          endInningsBreak();
        }
      }, 1000);
    }

    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
    }

    function endInningsBreak() {
      gameState.inningsBreakActive = false;
      elements.inningsBreak.style.display = 'none';
      setProcessingState(false);
      update(inningsBreakRef, { active: false });
    }

    function resetSelection() {
      gameState.selectedCard = null;
      elements.cardSelection.querySelectorAll('.card-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
    }

    async function processBall() {
      const batterCard = gameState.batterCards[0];
      const bowlerCard = gameState.bowlerCards[0];
      
      // Clear the cards
      gameState.batterCards = [];
      gameState.bowlerCards = [];

      // Determine the outcome
      let runs = 0;
      let isWicket = false;
      let isWide = false;
      let isNoBall = false;
      let isFreeHit = gameState.freeHit;
      let commentary = '';

      // Reset free hit flag unless another no ball is bowled
      gameState.freeHit = false;

      // Both players selected 0 - no ball + free hit
      if (batterCard === 0 && bowlerCard === 0) {
        runs = 1;
        isNoBall = true;
        gameState.freeHit = true;
        commentary = 'No ball! Free hit coming up';
      }
      // Bowler selected 0 - batter's card is runs (unless multiple dots)
      else if (bowlerCard === 0) {
        // Check for 4th consecutive 0 from batter
        if (gameState.consecutiveZeros.batter >= 3) {
          runs = -5;
          commentary = 'Penalty! -5 runs for too many dot balls';
          gameState.consecutiveZeros.batter = 0;
        } else {
          runs = batterCard;
          commentary = `${runs} run${runs === 1 ? '' : 's'} scored`;
          if (batterCard === 0) {
            gameState.consecutiveZeros.batter++;
          } else {
            gameState.consecutiveZeros.batter = 0;
          }
        }
      }
      // Batter selected 0 - dot ball (unless multiple dots)
      else if (batterCard === 0) {
        // Check for 4th consecutive 0 from bowler
        if (gameState.consecutiveZeros.bowler >= 3) {
          runs = 1;
          isNoBall = true;
          gameState.freeHit = true;
          commentary = 'No ball! Free hit for too many dots';
          gameState.consecutiveZeros.bowler = 0;
        } else {
          runs = 0;
          commentary = 'Dot ball';
          gameState.consecutiveZeros.bowler++;
        }
      }
      // Both selected same number > 0 - wicket
      else if (batterCard === bowlerCard) {
        isWicket = true;
        commentary = 'Wicket!';
        gameState.consecutiveZeros.batter = 0;
        gameState.consecutiveZeros.bowler = 0;
      }
      // Different numbers > 0 - bowler's card is runs
      else {
        runs = bowlerCard;
        commentary = `${runs} run${runs === 1 ? '' : 's'} scored`;
        gameState.consecutiveZeros.batter = 0;
        gameState.consecutiveZeros.bowler = 0;
      }

      // Process the outcome
      if (isNoBall) {
        addBallToOver('nb', runs);
        updateScore(runs, false, true);
        addTimelineEvent('other', `No ball +${runs}`);
      } else if (isWide) {
        addBallToOver('wd', runs);
        updateScore(runs, false, false);
        addTimelineEvent('other', `Wide +${runs}`);
      } else if (isWicket) {
        addBallToOver('w', 0);
        processWicket();
        addTimelineEvent('wicket', 'Wicket!');
      } else {
        const ballType = runs === 0 ? 'dot' : 'run';
        addBallToOver(ballType, runs);
        updateScore(runs, true, false);
        
        if (runs === 4) {
          addTimelineEvent('boundary', 'Four runs!');
        } else if (runs === 6) {
          addTimelineEvent('boundary', 'Six runs!');
        } else if (runs > 0) {
          addTimelineEvent('other', `${runs} run${runs === 1 ? '' : 's'}`);
        } else {
          addTimelineEvent('other', 'Dot ball');
        }
      }

      // Show notification
      if (commentary) {
        showNotification(isWicket ? 'Wicket!' : runs > 0 ? 'Runs scored' : 'Dot ball', commentary);
      }

      // Reset selection for next ball
      resetSelection();

      // Save match state
      await saveMatchState();

      // Re-enable controls
      setProcessingState(false);
    }

    function addBallToOver(type, runs) {
      // Don't count wides/noballs as balls except for the extra runs
      if (type === 'wd' || type === 'nb') {
        gameState.totalRuns += runs;
      } else {
        gameState.balls++;
        gameState.currentOver.push({ type, runs });
        updateOverProgress();
      }
    }

    function updateOverProgress() {
      elements.ballsContainer.innerHTML = '';
      
      gameState.currentOver.forEach((ball, index) => {
        const ballEl = document.createElement('div');
        ballEl.className = `ball ${ball.type}`;
        
        if (ball.type === 'run') {
          ballEl.textContent = ball.runs;
        } else if (ball.type === 'w') {
          ballEl.textContent = 'W';
        } else if (ball.type === 'wd') {
          ballEl.textContent = 'Wd';
        } else if (ball.type === 'nb') {
          ballEl.textContent = 'Nb';
        } else {
          ballEl.textContent = '•';
        }
        
        elements.ballsContainer.appendChild(ballEl);
      });

      // Update over info
      const overNumber = Math.floor(gameState.balls / 6);
      const ballNumber = gameState.balls % 6;
      elements.overInfo.textContent = `Over ${overNumber}.${ballNumber}`;

      // Update partnership info
      updatePartnershipInfo();

      // Check if over is complete
      if (ballNumber === 0 && gameState.balls > 0) {
        gameState.overs = overNumber;
        gameState.currentOver = [];
        updatePowerplayStatus();
        
        // Change bowler after over
        setTimeout(() => {
          showBowlerSelection();
        }, 1000);
      }
    }

    function updatePartnershipInfo() {
      // Calculate current partnership
      let partnershipRuns = 0;
      let partnershipBalls = 0;
      let lastWicketBall = 0;
      
      // Find the last wicket
      const timelineEvents = elements.timelineEvents.querySelectorAll('.timeline-event.wicket');
      if (timelineEvents.length > 0) {
        const lastWicketText = timelineEvents[0].textContent;
        const match = lastWicketText.match(/Over (\d+)\.(\d+)/);
        if (match) {
          lastWicketBall = parseInt(match[1]) * 6 + parseInt(match[2]);
        }
      }
      
      // Count runs and balls since last wicket
      for (let i = lastWicketBall; i < gameState.balls; i++) {
        const overIndex = Math.floor(i / 6);
        const ballIndex = i % 6;
        // This is simplified - in a real implementation you'd need to track all balls
        partnershipBalls++;
      }
      
      // This is simplified - in a real implementation you'd track partnership runs properly
      partnershipRuns = gameState.totalRuns - (gameState.firstInnings?.totalRuns || 0);
      
      elements.partnershipInfo.textContent = `Partnership: ${partnershipRuns} (${partnershipBalls} balls)`;
    }

    function updateScore(runs, isLegalBall, isExtra) {
      if (!isLegalBall) {
        // Extras don't count towards batter's score
        gameState.totalRuns += runs;
      } else {
        // Update batter stats
        if (!gameState.batterStats[gameState.currentBatter]) {
          gameState.batterStats[gameState.currentBatter] = {
            runs: 0,
            balls: 0,
            fours: 0,
            sixes: 0,
            dots: 0,
            dismissal: null
          };
        }
        
        const batter = gameState.batterStats[gameState.currentBatter];
        batter.runs += runs;
        batter.balls++;
        
        if (runs === 0) batter.dots++;
        if (runs === 4) batter.fours++;
        if (runs === 6) batter.sixes++;
        
        // Update bowler stats (only for legal balls)
        if (!gameState.bowlerStats[gameState.currentBowler]) {
          gameState.bowlerStats[gameState.currentBowler] = {
            runs: 0,
            balls: 0,
            wickets: 0,
            maidens: 0,
            noballs: 0,
            wides: 0
          };
        }
        
        const bowler = gameState.bowlerStats[gameState.currentBowler];
        bowler.runs += runs;
        if (isLegalBall) bowler.balls++;
        
        // Update total runs
        gameState.totalRuns += runs;
      }
      
      // Update UI
      updateScoreboard();
      updatePlayerStats();
    }

    function processWicket() {
      gameState.totalWickets++;
      
      // Update bowler stats
      if (!gameState.bowlerStats[gameState.currentBowler]) {
        gameState.bowlerStats[gameState.currentBowler] = {
          runs: 0,
          balls: 0,
          wickets: 0,
          maidens: 0,
          noballs: 0,
          wides: 0
        };
      }
      
      gameState.bowlerStats[gameState.currentBowler].wickets++;
      
      // Record dismissal in batter's stats
      if (gameState.batterStats[gameState.currentBatter]) {
        gameState.batterStats[gameState.currentBatter].dismissal = {
          bowler: gameState.currentBowler,
          ball: gameState.balls
        };
      }
      
      // Select new batter
      setTimeout(() => {
        showBatterSelection();
      }, 1000);
    }

    function updateScoreboard() {
      elements.battingScore.textContent = `${gameState.totalRuns}/${gameState.totalWickets}`;
      
      const overs = Math.floor(gameState.balls / 6);
      const balls = gameState.balls % 6;
      elements.battingOvers.textContent = `${overs}.${balls} overs`;
      
      const runRate = gameState.balls > 0 ? 
        (gameState.totalRuns / (gameState.balls / 6)).toFixed(2) : 0;
      elements.runRate.textContent = `RR: ${runRate}`;
      
      elements.bowlingOvers.textContent = `${overs}.${balls} overs`;
    }

    function updatePlayerStats() {
      // Update batter stats
      if (gameState.currentBatter && gameState.batterStats[gameState.currentBatter]) {
        const batter = gameState.batterStats[gameState.currentBatter];
        elements.batterRuns.textContent = batter.runs;
        elements.batterBalls.textContent = batter.balls;
        elements.batterDots.textContent = batter.dots;
        
        const strikeRate = batter.balls > 0 ? 
          ((batter.runs / batter.balls) * 100).toFixed(2) : 0;
        elements.batterSR.textContent = strikeRate;
      }
      
      // Update bowler stats
      if (gameState.currentBowler && gameState.bowlerStats[gameState.currentBowler]) {
        const bowler = gameState.bowlerStats[gameState.currentBowler];
        const overs = Math.floor(bowler.balls / 6) + (bowler.balls % 6) / 10;
        elements.bowlerOvers.textContent = overs.toFixed(1);
        elements.bowlerWickets.textContent = bowler.wickets;
        elements.bowlerExtras.textContent = `${bowler.noballs}/${bowler.wides}`;
        
        const economyRate = bowler.balls > 0 ? 
          (bowler.runs / (bowler.balls / 6)).toFixed(2) : 0;
        elements.bowlerER.textContent = economyRate;
      }
    }

    function addTimelineEvent(type, text) {
      const eventEl = document.createElement('div');
      eventEl.className = `timeline-event ${type}`;
      eventEl.textContent = `Over ${Math.floor(gameState.balls / 6)}.${gameState.balls % 6}: ${text}`;
      elements.timelineEvents.insertBefore(eventEl, elements.timelineEvents.firstChild);
    }

    function showNotification(title, message) {
      elements.notificationTitle.textContent = title;
      elements.notificationDesc.textContent = message;
      
      // Set notification class based on type
      elements.notification.className = 'notification';
      if (title.includes('Wicket')) {
        elements.notification.classList.add('wicket');
      } else if (title.includes('Runs') && (message.includes('4') || message.includes('6'))) {
        elements.notification.classList.add('boundary');
      } else if (title.includes('Milestone')) {
        elements.notification.classList.add('milestone');
      } else if (title.includes('Timeout')) {
        elements.notification.classList.add('timeout');
      }
      
      // Show and auto-hide notification
      elements.notification.style.display = 'block';
      setTimeout(() => {
        elements.notification.style.display = 'none';
      }, 3000);
    }

    function showBatterSelection() {
      // Get available players (all players minus current batters)
      const allPlayers = gameState.players[gameState.battingTeam];
      const currentPlayers = Object.keys(gameState.batterStats);
      const availablePlayers = allPlayers.filter(p => !currentPlayers.includes(p));
      
      // If no players left, innings is over
      if (availablePlayers.length === 0 || gameState.totalWickets >= 10) {
        endInnings();
        return;
      }
      
      // Show player selection modal
      elements.playerModalTitle.textContent = 'Select Next Batter';
      elements.playerModalList.innerHTML = '';
      
      availablePlayers.forEach(player => {
        const li = document.createElement('li');
        li.className = 'player-item';
        li.dataset.player = player;
        
        const nameSpan = document.createElement('span');
        nameSpan.className = 'player-name';
        nameSpan.textContent = player;
        
        // Highlight captain/vice-captain
        if (player === gameState.captains[gameState.battingTeam]) {
          const badge = document.createElement('span');
          badge.className = 'captain-badge';
          badge.textContent = ' (C)';
          nameSpan.appendChild(badge);
        } else if (player === gameState.viceCaptains[gameState.battingTeam]) {
          const badge = document.createElement('span');
          badge.className = 'vice-badge';
          badge.textContent = ' (VC)';
          nameSpan.appendChild(badge);
        }
        
        li.appendChild(nameSpan);
        li.addEventListener('click', () => selectModalPlayer(player));
        elements.playerModalList.appendChild(li);
      });
      
      elements.playerModal.style.display = 'flex';
    }

    function showBowlerSelection() {
      // Get available bowlers (all players minus current bowler if they've bowled too much)
      const allPlayers = gameState.players[gameState.bowlingTeam];
      const currentBowlers = Object.keys(gameState.bowlerStats);
      
      // Filter players who haven't bowled too many overs
      const availablePlayers = allPlayers.filter(player => {
        const bowler = gameState.bowlerStats[player];
        if (!bowler) return true;
        
        const oversBowled = bowler.balls / 6;
        const maxOvers = gameState.maxOvers / 5; // Max 20% of total overs per bowler
        
        return oversBowled < maxOvers;
      });
      
      // Show player selection modal
      elements.playerModalTitle.textContent = 'Select Next Bowler';
      elements.playerModalList.innerHTML = '';
      
      availablePlayers.forEach(player => {
        const li = document.createElement('li');
        li.className = 'player-item';
        li.dataset.player = player;
        
        const nameSpan = document.createElement('span');
        nameSpan.className = 'player-name';
        nameSpan.textContent = player;
        
        // Highlight captain/vice-captain
        if (player === gameState.captains[gameState.bowlingTeam]) {
          const badge = document.createElement('span');
          badge.className = 'captain-badge';
          badge.textContent = ' (C)';
          nameSpan.appendChild(badge);
        } else if (player === gameState.viceCaptains[gameState.bowlingTeam]) {
          const badge = document.createElement('span');
          badge.className = 'vice-badge';
          badge.textContent = ' (VC)';
          nameSpan.appendChild(badge);
        }
        
        // Add bowling stats if available
        const statsSpan = document.createElement('span');
        statsSpan.className = 'player-stats';
        
        if (gameState.bowlerStats[player]) {
          const bowler = gameState.bowlerStats[player];
          const overs = Math.floor(bowler.balls / 6) + (bowler.balls % 6) / 10;
          const economy = bowler.balls > 0 ? (bowler.runs / (bowler.balls / 6)).toFixed(2) : '0.00';
          
          statsSpan.textContent = ` ${overs} overs, ${bowler.wickets} wkts, ER: ${economy}`;
        } else {
          statsSpan.textContent = ' New bowler';
        }
        
        li.appendChild(nameSpan);
        li.appendChild(statsSpan);
        li.addEventListener('click', () => selectModalPlayer(player));
        elements.playerModalList.appendChild(li);
      });
      
      elements.playerModal.style.display = 'flex';
    }

    function selectModalPlayer(player) {
      // Clear previous selection
      elements.playerModalList.querySelectorAll('.player-item').forEach(item => {
        item.classList.remove('selected');
      });
      
      // Set new selection
      const selectedItem = elements.playerModalList.querySelector(`.player-item[data-player="${player}"]`);
      selectedItem.classList.add('selected');
      
      // Enable confirm button
      elements.confirmPlayerSelect.disabled = false;
      elements.confirmPlayerSelect.dataset.player = player;
    }

    function confirmPlayerSelection() {
      const player = elements.confirmPlayerSelect.dataset.player;
      
      if (elements.playerModalTitle.textContent.includes('Batter')) {
        // Set new batter
        gameState.currentBatter = player;
        elements.currentBatter.textContent = player;
        
        // Initialize batter stats if not exists
        if (!gameState.batterStats[player]) {
          gameState.batterStats[player] = {
            runs: 0,
            balls: 0,
            fours: 0,
            sixes: 0,
            dots: 0,
            dismissal: null
          };
        }
      } else {
        // Set new bowler
        gameState.currentBowler = player;
        elements.currentBowler.textContent = player;
        
        // Initialize bowler stats if not exists
        if (!gameState.bowlerStats[player]) {
          gameState.bowlerStats[player] = {
            runs: 0,
            balls: 0,
            wickets: 0,
            maidens: 0,
            noballs: 0,
            wides: 0
          };
        }
      }
      
      // Close modal
      elements.playerModal.style.display = 'none';
      elements.confirmPlayerSelect.disabled = true;
      
      // Update player stats display
      updatePlayerStats();
    }

    function endInnings() {
      gameState.inningsCompleted = true;
      
      // Show innings summary
      showInningsSummary();
      
      // Start innings break if this was first innings
      if (gameState.innings === 1) {
        set(inningsBreakRef, {
          active: true,
          duration: 90,
          timestamp: Date.now()
        });
      }
      
      // Save match state
      saveMatchState();
    }

    function showInningsSummary() {
      elements.summaryStats.innerHTML = '';
      
      // Add basic stats
      addSummaryStat('Total Runs', gameState.totalRuns);
      addSummaryStat('Total Wickets', gameState.totalWickets);
      addSummaryStat('Overs Bowled', `${Math.floor(gameState.balls / 6)}.${gameState.balls % 6}`);
      
      const runRate = gameState.balls > 0 ? 
        (gameState.totalRuns / (gameState.balls / 6)).toFixed(2) : 0;
      addSummaryStat('Run Rate', runRate);
      
      // Add top batters
      const batters = Object.entries(gameState.batterStats)
        .map(([name, stats]) => ({ name, ...stats }))
        .sort((a, b) => b.runs - a.runs);
      
      if (batters.length > 0) {
        addSummaryStat('Top Scorer', `${batters[0].name} - ${batters[0].runs} (${batters[0].balls})`);
      }
      
      // Add top bowlers
      const bowlers = Object.entries(gameState.bowlerStats)
        .map(([name, stats]) => ({ name, ...stats }))
        .sort((a, b) => b.wickets - a.wickets || a.runs - b.runs);
      
      if (bowlers.length > 0) {
        const topBowler = bowlers[0];
        const overs = Math.floor(topBowler.balls / 6) + (topBowler.balls % 6) / 10;
        addSummaryStat('Best Bowler', `${topBowler.name} - ${topBowler.wickets}/${topBowler.runs} (${overs.toFixed(1)} overs)`);
      }
      
      // Show modal
      elements.summaryModal.style.display = 'flex';
    }

    function addSummaryStat(label, value) {
      const statRow = document.createElement('div');
      statRow.className = 'stat-row';
      
      const statLabel = document.createElement('span');
      statLabel.className = 'stat-label';
      statLabel.textContent = label;
      
      const statValue = document.createElement('span');
      statValue.className = 'stat-value';
      statValue.textContent = value;
      
      statRow.appendChild(statLabel);
      statRow.appendChild(statValue);
      elements.summaryStats.appendChild(statRow);
    }

    function continueToNextInnings() {
      elements.summaryModal.style.display = 'none';
      
      // If this was first innings, switch to second innings
      if (gameState.innings === 1) {
        startSecondInnings();
      } else {
        // Match is complete
        endMatch();
      }
    }

    function startSecondInnings() {
      // Swap batting and bowling teams
      [gameState.battingTeam, gameState.bowlingTeam] = [gameState.bowlingTeam, gameState.battingTeam];
      
      // Reset innings-specific state
      gameState.innings = 2;
      gameState.totalRuns = 0;
      gameState.totalWickets = 0;
      gameState.balls = 0;
      gameState.overs = 0;
      gameState.currentOver = [];
      gameState.batterStats = {};
      gameState.bowlerStats = {};
      gameState.powerplay = true;
      gameState.freeHit = false;
      gameState.consecutiveZeros = { batter: 0, bowler: 0 };
      
      // Update UI
      elements.inningsInfo.textContent = '2nd Innings';
      elements.inningsStatus.textContent = 'Second Innings';
      updateTeamNames();
      updatePowerplayStatus();
      updateScoreboard();
      elements.ballsContainer.innerHTML = '';
      elements.overInfo.textContent = 'Over 0.0';
      elements.partnershipInfo.textContent = 'Partnership: 0 (0 balls)';
      elements.timelineEvents.innerHTML = '';
      
      // Initialize second innings in Firebase
      set(secondInningsRef, {
        battingTeam: gameState.battingTeam,
        bowlingTeam: gameState.bowlingTeam,
        totalRuns: 0,
        totalWickets: 0,
        balls: 0,
        batterStats: {},
        bowlerStats: {},
        extras: {
          wides: 0,
          noballs: 0,
          byes: 0,
          legbyes: 0
        }
      });
      
      // Select opening batter
      setTimeout(() => {
        showBatterSelection();
      }, 1000);
    }

    function endMatch() {
      // Determine winner
      const firstInningsRuns = gameState.firstInnings.totalRuns;
      const secondInningsRuns = gameState.totalRuns;
      
      if (secondInningsRuns > firstInningsRuns) {
        gameState.winner = gameState.battingTeam;
        gameState.winningMargin = `${10 - gameState.totalWickets} wickets`;
      } else if (secondInningsRuns < firstInningsRuns) {
        gameState.winner = gameState.bowlingTeam;
        gameState.winningMargin = `${firstInningsRuns - secondInningsRuns} runs`;
      } else {
        gameState.winner = 'tie';
        gameState.winningMargin = 'Match tied';
      }
      
      // Determine player of the match
      determinePlayerOfTheMatch();
      
      // Update match status
      gameState.matchCompleted = true;
      
      // Save match state
      saveMatchState();
      
      // Redirect to match summary
      setTimeout(() => {
        window.location.href = `match_summary.html?id=${roomId}`;
      }, 3000);
    }

    function determinePlayerOfTheMatch() {
      // Combine stats from both innings
      const allBatters = {};
      const allBowlers = {};
      
      // First innings stats
      for (const [player, stats] of Object.entries(gameState.firstInnings.batterStats)) {
        allBatters[player] = { ...stats };
      }
      
      for (const [player, stats] of Object.entries(gameState.firstInnings.bowlerStats)) {
        allBowlers[player] = { ...stats };
      }
      
      // Second innings stats (add to existing)
      for (const [player, stats] of Object.entries(gameState.batterStats)) {
        if (allBatters[player]) {
          allBatters[player].runs += stats.runs;
          allBatters[player].balls += stats.balls;
          allBatters[player].fours += stats.fours;
          allBatters[player].sixes += stats.sixes;
        } else {
          allBatters[player] = { ...stats };
        }
      }
      
      for (const [player, stats] of Object.entries(gameState.bowlerStats)) {
        if (allBowlers[player]) {
          allBowlers[player].runs += stats.runs;
          allBowlers[player].balls += stats.balls;
          allBowlers[player].wickets += stats.wickets;
        } else {
          allBowlers[player] = { ...stats };
        }
      }
      
      // Find top performers
      const topBatters = Object.entries(allBatters)
        .map(([name, stats]) => ({ name, ...stats }))
        .sort((a, b) => b.runs - a.runs);
      
      const topBowlers = Object.entries(allBowlers)
        .map(([name, stats]) => ({ name, ...stats }))
        .sort((a, b) => b.wickets - a.wickets || a.runs - b.runs);
      
      // Simple algorithm to pick player of the match
      if (topBatters.length > 0 && topBowlers.length > 0) {
        const batterScore = topBatters[0].runs + (topBatters[0].sixes * 2);
        const bowlerScore = (topBowlers[0].wickets * 25) - (topBowlers[0].runs / 2);
        
        if (batterScore > bowlerScore) {
          gameState.playerOfTheMatch = topBatters[0].name;
        } else {
          gameState.playerOfTheMatch = topBowlers[0].name;
        }
      } else if (topBatters.length > 0) {
        gameState.playerOfTheMatch = topBatters[0].name;
      } else if (topBowlers.length > 0) {
        gameState.playerOfTheMatch = topBowlers[0].name;
      }
    }

    async function saveMatchState() {
      // Update first innings data
      if (gameState.innings === 1) {
        await update(firstInningsRef, {
          totalRuns: gameState.totalRuns,
          totalWickets: gameState.totalWickets,
          balls: gameState.balls,
          batterStats: gameState.batterStats,
          bowlerStats: gameState.bowlerStats
        });
      }
      // Update second innings data
      else {
        await update(secondInningsRef, {
          totalRuns: gameState.totalRuns,
          totalWickets: gameState.totalWickets,
          balls: gameState.balls,
          batterStats: gameState.batterStats,
          bowlerStats: gameState.bowlerStats
        });
      }
      
      // Update match status
      await update(matchRef, {
        inningsCompleted: gameState.inningsCompleted,
        matchCompleted: gameState.matchCompleted,
        winner: gameState.winner,
        winningMargin: gameState.winningMargin,
        playerOfTheMatch: gameState.playerOfTheMatch
      });
    }

    function loadMatchData() {
      onValue(matchRef, (snap) => {
        if (snap.exists()) {
          const matchData = snap.val();
          
          // Load first innings data
          if (matchData.firstInnings) {
            gameState.firstInnings = matchData.firstInnings;
            
            if (gameState.innings === 1) {
              gameState.totalRuns = matchData.firstInnings.totalRuns || 0;
              gameState.totalWickets = matchData.firstInnings.totalWickets || 0;
              gameState.balls = matchData.firstInnings.balls || 0;
              gameState.overs = Math.floor(gameState.balls / 6);
              gameState.batterStats = matchData.firstInnings.batterStats || {};
              gameState.bowlerStats = matchData.firstInnings.bowlerStats || {};
              
              // Update UI
              updateScoreboard();
              updatePlayerStats();
              
              // Check if we need to select players
              checkPlayerSelection();
            }
          }
          
          // Load second innings data
          if (matchData.secondInnings && gameState.innings === 2) {
            gameState.totalRuns = matchData.secondInnings.totalRuns || 0;
            gameState.totalWickets = matchData.secondInnings.totalWickets || 0;
            gameState.balls = matchData.secondInnings.balls || 0;
            gameState.overs = Math.floor(gameState.balls / 6);
            gameState.batterStats = matchData.secondInnings.batterStats || {};
            gameState.bowlerStats = matchData.secondInnings.bowlerStats || {};
            
            // Update UI
            updateScoreboard();
            updatePlayerStats();
            
            // Check if we need to select players
            checkPlayerSelection();
          }
          
          // Load match status
          if (matchData.matchCompleted) {
            gameState.matchCompleted = true;
            window.location.href = `match_summary.html?id=${roomId}`;
          }
        }
      });
    }

    function checkPlayerSelection() {
      // Check if we need to select a batter
      if (gameState.totalWickets < 10 && !gameState.currentBatter) {
        showBatterSelection();
      }
      
      // Check if we need to select a bowler
      if (gameState.balls % 6 === 0 && gameState.balls > 0 && !gameState.currentBowler) {
        showBowlerSelection();
      }
    }

    function showTeams() {
      // Update team names
      elements.team1Title.textContent = gameState.teamNames.player1;
      elements.team2Title.textContent = gameState.teamNames.player2;
      
      // Clear existing players
      elements.team1Players.innerHTML = '';
      elements.team2Players.innerHTML = '';
      
      // Add team1 players
      gameState.players.player1.forEach(player => {
        const li = document.createElement('li');
        li.textContent = player;
        
        // Highlight captain/vice-captain
        if (player === gameState.captains.player1) {
          li.textContent += ' (C)';
          li.style.color = 'gold';
        } else if (player === gameState.viceCaptains.player1) {
          li.textContent += ' (VC)';
          li.style.color = 'silver';
        }
        
        elements.team1Players.appendChild(li);
      });
      
      // Add team2 players
      gameState.players.player2.forEach(player => {
        const li = document.createElement('li');
        li.textContent = player;
        
        // Highlight captain/vice-captain
        if (player === gameState.captains.player2) {
          li.textContent += ' (C)';
          li.style.color = 'gold';
        } else if (player === gameState.viceCaptains.player2) {
          li.textContent += ' (VC)';
          li.style.color = 'silver';
        }
        
        elements.team2Players.appendChild(li);
      });
      
      // Show modal
      elements.teamsModal.style.display = 'flex';
    }

    // Initialize the game when loaded
    window.addEventListener('DOMContentLoaded', initGame);
  </script>
</body>
</html>