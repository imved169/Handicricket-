<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HandiCricket - Player Auction</title>
  <style>
    body {
      background: linear-gradient(135deg, #061e3e, #0a2a4a);
      color: white;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      text-align: center;
      padding: 20px;
      margin: 0;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    h1 {
      color: #ffeb3b;
      text-shadow: 0 0 10px rgba(255, 235, 59, 0.5);
      margin-bottom: 20px;
    }
    
    h2 {
      color: #1e88e5;
      margin-top: 0;
      border-bottom: 2px solid #1e88e5;
      padding-bottom: 8px;
    }
    
    .section {
      display: none;
      margin-bottom: 30px;
    }
    
    .section.active {
      display: block;
    }
    
    .user-info {
      margin-bottom: 20px;
      padding: 15px;
      background: rgba(13, 42, 82, 0.5);
      border-radius: 10px;
    }
    
    .user-info p {
      margin: 5px 0;
    }
    
    .user-team {
      font-weight: bold;
      color: #ffeb3b;
    }
    
    .budget-display {
      font-size: 24px;
      margin: 15px 0;
      padding: 10px;
      background: rgba(13, 42, 82, 0.5);
      border-radius: 8px;
    }
    
    .budget-amount {
      font-weight: bold;
      color: #4CAF50;
    }
    
    .btn {
      padding: 12px 25px;
      border: none;
      border-radius: 8px;
      background: linear-gradient(145deg, #1e88e5, #1565c0);
      color: white;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      margin: 10px 5px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    }
    
    .btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 10px rgba(0, 0, 0, 0.3);
    }
    
    .btn:active {
      transform: translateY(1px);
    }
    
    .btn-primary {
      background: linear-gradient(145deg, #1e88e5, #1565c0);
    }
    
    .btn-success {
      background: linear-gradient(145deg, #4CAF50, #2E7D32);
    }
    
    .btn-warning {
      background: linear-gradient(145deg, #FF9800, #F57C00);
    }
    
    .btn-danger {
      background: linear-gradient(145deg, #f44336, #d32f2f);
    }
    
    .btn-info {
      background: linear-gradient(145deg, #009688, #00796B);
    }
    
    .btn-back {
      background: linear-gradient(145deg, #607D8B, #455A64);
    }
    
    .player-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    
    .player-card {
      background: rgba(13, 42, 82, 0.5);
      border-radius: 10px;
      padding: 15px;
      cursor: pointer;
      transition: all 0.3s;
      border: 2px solid transparent;
      text-align: left;
    }
    
    .player-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 10px rgba(0, 0, 0, 0.3);
    }
    
    .player-card.selected {
      border-color: #ffeb3b;
      background: rgba(30, 136, 229, 0.3);
    }
    
    .player-card.captain {
      border-color: #ffeb3b;
      background: rgba(255, 235, 59, 0.2);
    }
    
    .player-card h3 {
      margin-top: 0;
      margin-bottom: 5px;
    }
    
    .player-card p {
      margin: 5px 0;
      font-size: 14px;
    }
    
    .player-role {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .role-batter {
      background-color: rgba(76, 175, 80, 0.2);
      color: #4CAF50;
    }
    
    .role-pacer {
      background-color: rgba(244, 67, 54, 0.2);
      color: #f44336;
    }
    
    .role-spinner {
      background-color: rgba(156, 39, 176, 0.2);
      color: #9C27B0;
    }
    
    .role-allrounder {
      background-color: rgba(255, 152, 0, 0.2);
      color: #FF9800;
    }
    
    .role-wicketkeeper {
      background-color: rgba(0, 150, 136, 0.2);
      color: #009688;
    }
    
    .input-group {
      margin-bottom: 20px;
      text-align: left;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      color: #aaa;
    }
    
    input, textarea, select {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #1e88e5;
      border-radius: 8px;
      background: rgba(30, 136, 229, 0.1);
      color: white;
      font-size: 16px;
      box-sizing: border-box;
      margin-bottom: 10px;
    }
    
    textarea {
      min-height: 150px;
      font-family: monospace;
    }
    
    select option {
      background: #061e3e;
    }
    
    .current-player {
      background: rgba(30, 136, 229, 0.3);
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
      border: 2px solid #1e88e5;
    }
    
    .current-player h2 {
      margin-top: 0;
      color: #ffeb3b;
    }
    
    .bid-controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    
    .bid-btn {
      min-width: 80px;
    }
    
    .timer {
      font-size: 24px;
      font-weight: bold;
      color: #ffeb3b;
      margin: 10px 0;
    }
    
    .team-squads {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }
    
    .team-squad {
      background: rgba(13, 42, 82, 0.5);
      border-radius: 10px;
      padding: 15px;
      text-align: left;
    }
    
    .team-squad h3 {
      margin-top: 0;
      color: #ffeb3b;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding-bottom: 8px;
    }
    
    .team-squad ul {
      list-style: none;
      padding: 0;
      margin: 10px 0;
    }
    
    .team-squad li {
      padding: 5px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .rtm-count {
      font-size: 18px;
      color: #FF9800;
      font-weight: bold;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .modal-content {
      background: linear-gradient(135deg, #061e3e, #0a2a4a);
      padding: 30px;
      border-radius: 15px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .close-modal {
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
    }
    
    .admin-controls {
      background: rgba(244, 67, 54, 0.1);
      border-radius: 10px;
      padding: 15px;
      margin: 20px 0;
      border: 1px solid rgba(244, 67, 54, 0.3);
    }
    
    .loading-spinner {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 3px solid #1e88e5;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    .error-message {
      color: #f44336;
      margin: 10px 0;
    }
    
    .success-message {
      color: #4CAF50;
      margin: 10px 0;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }
      
      .player-grid {
        grid-template-columns: 1fr 1fr;
      }
      
      .bid-controls {
        flex-direction: column;
        align-items: center;
      }
      
      .bid-btn {
        width: 100%;
      }
    }
    
    @media (max-width: 480px) {
      .player-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üèè HandiCricket Player Auction</h1>
    
    <div class="user-info">
      <p>Team: <span id="teamDisplay" class="user-team"></span></p>
      <p>Budget: <span id="budgetDisplay" class="budget-amount">‚Çπ150 Cr</span></p>
      <p>RTM Cards: <span id="rtmCount" class="rtm-count">0</span></p>
    </div>
    
    <!-- Retention Section -->
    <div id="retentionSection" class="section active">
      <h2>Player Retention</h2>
      <p>Retain up to 6 players from your previous squad (including 1 captain)</p>
      
      <div class="player-grid" id="retentionPlayerGrid">
        <!-- Player cards will be added here -->
      </div>
      
      <div class="budget-display">
        Retention Cost: <span id="retentionCost">‚Çπ0 Cr</span> | 
        Remaining Budget: <span id="remainingBudget">‚Çπ150 Cr</span>
      </div>
      
      <button id="confirmRetentionBtn" class="btn btn-success">Confirm Retention</button>
      <button id="skipRetentionBtn" class="btn btn-back">Skip Retention</button>
    </div>
    
    <!-- Auction Setup Section -->
    <div id="auctionSetupSection" class="section">
      <h2>Auction Setup</h2>
      
      <div id="adminSetup" style="display: none;">
        <h3>Admin Controls</h3>
        
        <div class="admin-controls">
          <div class="input-group">
            <label>Add Single Player</label>
            <input type="text" id="playerNameInput" placeholder="Player name">
            <select id="playerRoleInput">
              <option value="Batter">Batter</option>
              <option value="Pacer">Pacer</option>
              <option value="Spinner">Spinner</option>
              <option value="All-Rounder">All-Rounder</option>
              <option value="Wicket-Keeper">Wicket-Keeper</option>
            </select>
            <input type="text" id="playerBasePriceInput" placeholder="Base price (e.g., 0.50)" value="0.50">
            <button id="addPlayerBtn" class="btn btn-primary">Add Player</button>
          </div>
          
          <div class="input-group">
            <label>Bulk Add Players (CSV format: Name,Role,BasePrice)</label>
            <textarea id="bulkPlayersInput" placeholder="Yash Dayal,Pacer,0.50
Kagiso Rabada,Pacer,0.50
Harshit Rana,Pacer,0.50"></textarea>
            <button id="bulkAddPlayersBtn" class="btn btn-primary">Bulk Add Players</button>
          </div>
          
          <button id="startAuctionBtn" class="btn btn-success">Start Auction</button>
        </div>
      </div>
      
      <div id="joinRoomSection">
        <div class="input-group">
          <label for="roomCodeInput">Enter Room Code</label>
          <input type="text" id="roomCodeInput" placeholder="4-digit room code" maxlength="4">
        </div>
        <button id="joinRoomBtn" class="btn btn-primary">Join Auction Room</button>
      </div>
      
      <button id="backToRetentionBtn" class="btn btn-back" style="display: none;">Back to Retention</button>
    </div>
    
    <!-- Auction Section -->
    <div id="auctionSection" class="section">
      <div class="current-player" id="currentPlayerCard">
        <h2>Waiting for auction to start...</h2>
        <p id="currentPlayerRole"></p>
        <p id="currentPlayerBasePrice"></p>
      </div>
      
      <div class="timer" id="auctionTimer">30</div>
      
      <div class="bid-controls">
        <button id="bid025Btn" class="btn btn-primary bid-btn">+0.25 Cr</button>
        <button id="bid050Btn" class="btn btn-primary bid-btn">+0.50 Cr</button>
        <button id="bid100Btn" class="btn btn-primary bid-btn">+1.00 Cr</button>
        <button id="bidCustomBtn" class="btn btn-warning bid-btn">Custom Bid</button>
        <button id="passBtn" class="btn btn-danger bid-btn">Pass</button>
        <button id="rtmBtn" class="btn btn-info bid-btn">RTM (0)</button>
      </div>
      
      <div id="adminControls" class="admin-controls" style="display: none;">
        <h3>Admin Controls</h3>
        <button id="nextPlayerBtn" class="btn btn-primary">Next Player</button>
        <button id="autoSellBtn" class="btn btn-success">Auto Sell</button>
        <button id="soldBtn" class="btn btn-warning">Sold</button>
      </div>
      
      <h2>Team Squads</h2>
      <div class="team-squads" id="teamSquadsContainer">
        <!-- Team squads will be added here -->
      </div>
      
      <button id="endAuctionBtn" class="btn btn-danger">End Auction</button>
    </div>
    
    <button id="backToHomeBtn" class="btn btn-back">Back to Home</button>
    
    <div class="error-message" id="errorMessage"></div>
    <div class="success-message" id="successMessage"></div>
  </div>
  
  <!-- Custom Bid Modal -->
  <div class="modal" id="customBidModal">
    <div class="modal-content">
      <button class="close-modal">&times;</button>
      <h2>Place Custom Bid</h2>
      <div class="input-group">
        <label for="customBidAmount">Bid Amount (in Cr)</label>
        <input type="number" id="customBidAmount" step="0.01" min="0.25" placeholder="e.g., 2.75">
      </div>
      <button id="confirmCustomBidBtn" class="btn btn-primary">Place Bid</button>
    </div>
  </div>
  
  <!-- Player Selection Modal -->
  <div class="modal" id="playerSelectionModal">
    <div class="modal-content">
      <button class="close-modal">&times;</button>
      <h2>Select Next Player</h2>
      <div class="player-grid" id="playerSelectionGrid">
        <!-- Player cards will be added here -->
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getDatabase, ref, set, update, get, child, onValue, push } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCN6aZMwlsZe7JJaovU0WA3UQygWr4jYmA",
      authDomain: "handicricket-85a06.firebaseapp.com",
      projectId: "handicricket-85a06",
      storageBucket: "handicricket-85a06.appspot.com",
      messagingSenderId: "599182538558",
      appId: "1:599182538558:web:3e965753ab05f8f1e3de6f",
      measurementId: "G-HSV9H4LEJQ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // DOM elements
    const teamDisplay = document.getElementById('teamDisplay');
    const budgetDisplay = document.getElementById('budgetDisplay');
    const rtmCount = document.getElementById('rtmCount');
    const retentionCost = document.getElementById('retentionCost');
    const remainingBudget = document.getElementById('remainingBudget');
    
    // Sections
    const retentionSection = document.getElementById('retentionSection');
    const auctionSetupSection = document.getElementById('auctionSetupSection');
    const auctionSection = document.getElementById('auctionSection');
    
    // Retention elements
    const retentionPlayerGrid = document.getElementById('retentionPlayerGrid');
    const confirmRetentionBtn = document.getElementById('confirmRetentionBtn');
    const skipRetentionBtn = document.getElementById('skipRetentionBtn');
    
    // Auction setup elements
    const adminSetup = document.getElementById('adminSetup');
    const joinRoomSection = document.getElementById('joinRoomSection');
    const roomCodeInput = document.getElementById('roomCodeInput');
    const joinRoomBtn = document.getElementById('joinRoomBtn');
    const playerNameInput = document.getElementById('playerNameInput');
    const playerRoleInput = document.getElementById('playerRoleInput');
    const playerBasePriceInput = document.getElementById('playerBasePriceInput');
    const addPlayerBtn = document.getElementById('addPlayerBtn');
    const bulkPlayersInput = document.getElementById('bulkPlayersInput');
    const bulkAddPlayersBtn = document.getElementById('bulkAddPlayersBtn');
    const startAuctionBtn = document.getElementById('startAuctionBtn');
    const backToRetentionBtn = document.getElementById('backToRetentionBtn');
    
    // Auction elements
    const currentPlayerCard = document.getElementById('currentPlayerCard');
    const currentPlayerRole = document.getElementById('currentPlayerRole');
    const currentPlayerBasePrice = document.getElementById('currentPlayerBasePrice');
    const auctionTimer = document.getElementById('auctionTimer');
    const bid025Btn = document.getElementById('bid025Btn');
    const bid050Btn = document.getElementById('bid050Btn');
    const bid100Btn = document.getElementById('bid100Btn');
    const bidCustomBtn = document.getElementById('bidCustomBtn');
    const passBtn = document.getElementById('passBtn');
    const rtmBtn = document.getElementById('rtmBtn');
    const adminControls = document.getElementById('adminControls');
    const nextPlayerBtn = document.getElementById('nextPlayerBtn');
    const autoSellBtn = document.getElementById('autoSellBtn');
    const soldBtn = document.getElementById('soldBtn');
    const teamSquadsContainer = document.getElementById('teamSquadsContainer');
    const endAuctionBtn = document.getElementById('endAuctionBtn');
    
    // Modals
    const customBidModal = document.getElementById('customBidModal');
    const customBidAmount = document.getElementById('customBidAmount');
    const confirmCustomBidBtn = document.getElementById('confirmCustomBidBtn');
    const playerSelectionModal = document.getElementById('playerSelectionModal');
    const playerSelectionGrid = document.getElementById('playerSelectionGrid');
    
    // Other buttons
    const backToHomeBtn = document.getElementById('backToHomeBtn');
    const errorMessage = document.getElementById('errorMessage');
    const successMessage = document.getElementById('successMessage');
    
    // Close modals
    document.querySelectorAll('.close-modal').forEach(btn => {
      btn.addEventListener('click', () => {
        customBidModal.style.display = 'none';
        playerSelectionModal.style.display = 'none';
      });
    });
    
    // Global variables
    let currentUser = localStorage.getItem('hc_username');
    let currentTeam = localStorage.getItem('hc_team');
    let isAdmin = false;
    let roomCode = null;
    let auctionRef = null;
    let retentionPlayers = [];
    let selectedPlayers = [];
    let selectedCaptain = null;
    let timerInterval = null;
    let currentTime = 30;
    let currentBid = 0;
    let currentBidder = null;
    let lastBidder = null;
    let currentPlayer = null;
    let playerPool = [];
    let teams = {};
    let rtmCards = 0;
    let budget = 150;
    
    // Check if user is logged in
    if (!currentUser || !currentTeam) {
      alert('Please login first');
      window.location.href = 'index.html';
    }
    
    // Set team name
    teamDisplay.textContent = currentTeam;
    
    // Check if user is admin
    isAdmin = currentUser === 'imved169' && currentTeam === 'Ratnagiri Hunters';
    
    // Load user's previous squad for retention
    const userRef = ref(db, `users/${currentUser}`);
    get(userRef).then(snap => {
      if (snap.exists()) {
        const userData = snap.val();
        if (userData.players && userData.players.length > 0) {
          retentionPlayers = userData.players;
          renderRetentionPlayers();
        } else {
          // No players to retain, skip to auction setup
          showMessage('No players in your previous squad to retain', 'info');
          skipRetentionBtn.click();
        }
      }
    });
    
    // Render retention players
    function renderRetentionPlayers() {
      retentionPlayerGrid.innerHTML = '';
      retentionPlayers.forEach(player => {
        const card = document.createElement('div');
        card.className = 'player-card';
        card.dataset.player = player;
        
        card.innerHTML = `
          <h3>${player}</h3>
          <div>
            <button class="btn btn-primary retain-btn" style="padding: 5px 10px; font-size: 12px; margin-top: 5px;">Retain (‚Çπ2 Cr)</button>
            <button class="btn btn-warning captain-btn" style="padding: 5px 10px; font-size: 12px; margin-top: 5px;">Make Captain (‚Çπ4 Cr)</button>
          </div>
        `;
        
        retentionPlayerGrid.appendChild(card);
      });
      
      // Add event listeners to buttons
      document.querySelectorAll('.retain-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const player = e.target.closest('.player-card').dataset.player;
          togglePlayerRetention(player, false);
        });
      });
      
      document.querySelectorAll('.captain-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const player = e.target.closest('.player-card').dataset.player;
          togglePlayerRetention(player, true);
        });
      });
    }
    
    // Toggle player retention
    function togglePlayerRetention(player, isCaptain) {
      // If making captain, remove from selected players if already there
      if (isCaptain) {
        selectedPlayers = selectedPlayers.filter(p => p !== player);
        selectedCaptain = player;
        
        // Update UI
        document.querySelectorAll('.player-card').forEach(card => {
          if (card.dataset.player === player) {
            card.classList.add('captain');
          } else {
            card.classList.remove('captain');
          }
        });
      } else {
        // If already captain, can't be regular retained
        if (selectedCaptain === player) {
          showMessage('Player is already selected as captain. Remove captaincy first.', 'error');
          return;
        }
        
        // Toggle selection
        const index = selectedPlayers.indexOf(player);
        if (index === -1) {
          if (selectedPlayers.length + (selectedCaptain ? 1 : 0) >= 6) {
            showMessage('Maximum 6 players can be retained', 'error');
            return;
          }
          selectedPlayers.push(player);
        } else {
          selectedPlayers.splice(index, 1);
        }
        
        // Update UI
        document.querySelectorAll('.player-card').forEach(card => {
          if (card.dataset.player === player) {
            card.classList.toggle('selected');
          }
        });
      }
      
      // Calculate retention cost
      const captainCost = selectedCaptain ? 4 : 0;
      const playersCost = selectedPlayers.length * 2;
      const totalCost = captainCost + playersCost;
      
      // Calculate RTM cards
      rtmCards = 6 - (selectedPlayers.length + (selectedCaptain ? 1 : 0));
      
      // Update UI
      retentionCost.textContent = `‚Çπ${totalCost} Cr`;
      remainingBudget.textContent = `‚Çπ${budget - totalCost} Cr`;
      rtmCount.textContent = rtmCards;
      rtmBtn.textContent = `RTM (${rtmCards})`;
    }
    
    // Confirm retention
    confirmRetentionBtn.addEventListener('click', async () => {
      if (selectedPlayers.length === 0 && !selectedCaptain) {
        showMessage('Please select at least one player to retain or skip retention', 'error');
        return;
      }
      
      try {
        // Update user data with retained players
        const updates = {
          retentionCaptain: selectedCaptain,
          retainedPlayers: selectedPlayers,
          rtmCards: rtmCards,
          budget: budget - (selectedCaptain ? 4 : 0) - (selectedPlayers.length * 2)
        };
        
        await update(userRef, updates);
        
        // Update local budget
        budget = budget - (selectedCaptain ? 4 : 0) - (selectedPlayers.length * 2);
        budgetDisplay.textContent = `‚Çπ${budget} Cr`;
        
        // Move to auction setup
        showSection('auctionSetup');
        showMessage('Player retention confirmed!', 'success');
      } catch (error) {
        console.error('Error confirming retention:', error);
        showMessage('Failed to confirm retention. Please try again.', 'error');
      }
    });
    
    // Skip retention
    skipRetentionBtn.addEventListener('click', () => {
      rtmCards = 6;
      rtmCount.textContent = rtmCards;
      rtmBtn.textContent = `RTM (${rtmCards})`;
      showSection('auctionSetup');
    });
    
    // Back to retention
    backToRetentionBtn.addEventListener('click', () => {
      showSection('retention');
    });
    
    // Show appropriate setup UI based on admin status
    if (isAdmin) {
      adminSetup.style.display = 'block';
      joinRoomSection.style.display = 'none';
    } else {
      adminSetup.style.display = 'none';
      joinRoomSection.style.display = 'block';
    }
    
    // Add single player
    addPlayerBtn.addEventListener('click', async () => {
      const name = playerNameInput.value.trim();
      const role = playerRoleInput.value;
      const basePrice = parseFloat(playerBasePriceInput.value);
      
      if (!name || !role || isNaN(basePrice) {
        showMessage('Please fill all fields with valid values', 'error');
        return;
      }
      
      if (!['Batter', 'Pacer', 'Spinner', 'All-Rounder', 'Wicket-Keeper'].includes(role)) {
        showMessage('Invalid player role', 'error');
        return;
      }
      
      if (basePrice <= 0) {
        showMessage('Base price must be positive', 'error');
        return;
      }
      
      try {
        const playerKey = name.toLowerCase().replace(/\s+/g, '_');
        await set(ref(db, `auctionPlayers/${playerKey}`), {
          name: name,
          role: role,
          basePrice: basePrice,
          status: 'pending'
        });
        
        showMessage(`Player ${name} added successfully!`, 'success');
        playerNameInput.value = '';
      } catch (error) {
        console.error('Error adding player:', error);
        showMessage('Failed to add player. Please try again.', 'error');
      }
    });
    
    // Bulk add players
    bulkAddPlayersBtn.addEventListener('click', async () => {
      const playersText = bulkPlayersInput.value.trim();
      if (!playersText) {
        showMessage('Please enter players data', 'error');
        return;
      }
      
      const lines = playersText.split('\n');
      const playersToAdd = [];
      
      for (const line of lines) {
        const parts = line.split(',');
        if (parts.length !== 3) continue;
        
        const name = parts[0].trim();
        const role = parts[1].trim();
        const basePrice = parseFloat(parts[2].trim());
        
        if (!name || !role || isNaN(basePrice)) continue;
        if (!['Batter', 'Pacer', 'Spinner', 'All-Rounder', 'Wicket-Keeper'].includes(role)) continue;
        
        playersToAdd.push({
          name,
          role,
          basePrice
        });
      }
      
      if (playersToAdd.length === 0) {
        showMessage('No valid players found in the input', 'error');
        return;
      }
      
      try {
        const updates = {};
        playersToAdd.forEach(player => {
          const playerKey = player.name.toLowerCase().replace(/\s+/g, '_');
          updates[`auctionPlayers/${playerKey}/name`] = player.name;
          updates[`auctionPlayers/${playerKey}/role`] = player.role;
          updates[`auctionPlayers/${playerKey}/basePrice`] = player.basePrice;
          updates[`auctionPlayers/${playerKey}/status`] = 'pending';
        });
        
        await update(ref(db), updates);
        showMessage(`Added ${playersToAdd.length} players successfully!`, 'success');
        bulkPlayersInput.value = '';
      } catch (error) {
        console.error('Error bulk adding players:', error);
        showMessage('Failed to add players. Please try again.', 'error');
      }
    });
    
    // Join auction room
    joinRoomBtn.addEventListener('click', () => {
      roomCode = roomCodeInput.value.trim();
      if (!roomCode || roomCode.length !== 4 || isNaN(roomCode)) {
        showMessage('Please enter a valid 4-digit room code', 'error');
        return;
      }
      
      joinAuctionRoom(roomCode);
    });
    
    // Start auction
    startAuctionBtn.addEventListener('click', async () => {
      // Generate a random 4-digit room code
      roomCode = Math.floor(1000 + Math.random() * 9000);
      
      try {
        // Create auction room
        auctionRef = ref(db, `auctions/${roomCode}`);
        await set(auctionRef, {
          admin: currentUser,
          status: 'setup',
          teams: {},
          playerPool: {},
          currentPlayer: null,
          currentBid: 0,
          currentBidder: null,
          timer: 30,
          createdAt: Date.now()
        });
        
        // Add admin team
        await update(ref(db, `auctions/${roomCode}/teams/${currentTeam}`), {
          name: currentTeam,
          budget: budget,
          players: [],
          rtmCards: rtmCards
        });
        
        // Show room code to admin
        showMessage(`Auction room created! Room code: ${roomCode}`, 'success');
        
        // Move to auction section
        showSection('auction');
        setupAuctionListeners();
      } catch (error) {
        console.error('Error starting auction:', error);
        showMessage('Failed to start auction. Please try again.', 'error');
      }
    });
    
    // Join auction room
    async function joinAuctionRoom(code) {
      try {
        // Check if room exists
        const roomSnap = await get(ref(db, `auctions/${code}`));
        if (!roomSnap.exists()) {
          showMessage('Room not found. Please check the code.', 'error');
          return;
        }
        
        const roomData = roomSnap.val();
        
        // Check if team already joined
        if (roomData.teams && roomData.teams[currentTeam]) {
          showMessage('Your team has already joined this auction', 'error');
          return;
        }
        
        // Join room
        auctionRef = ref(db, `auctions/${code}`);
        await update(ref(db, `auctions/${code}/teams/${currentTeam}`), {
          name: currentTeam,
          budget: budget,
          players: [],
          rtmCards: rtmCards
        });
        
        roomCode = code;
        showMessage(`Successfully joined auction room ${code}`, 'success');
        
        // Move to auction section
        showSection('auction');
        setupAuctionListeners();
      } catch (error) {
        console.error('Error joining room:', error);
        showMessage('Failed to join room. Please try again.', 'error');
      }
    }
    
    // Set up real-time auction listeners
    function setupAuctionListeners() {
      // Listen for auction state changes
      onValue(auctionRef, (snap) => {
        if (!snap.exists()) return;
        
        const auctionData = snap.val();
        
        // Update UI based on auction state
        if (auctionData.status === 'active') {
          // Update current player
          if (auctionData.currentPlayer) {
            currentPlayer = auctionData.currentPlayer;
            currentPlayerCard.innerHTML = `
              <h2>${currentPlayer.name}</h2>
              <p class="player-role role-${currentPlayer.role.toLowerCase().replace('-', '')}">${currentPlayer.role}</p>
              <p>Base Price: ‚Çπ${currentPlayer.basePrice} Cr</p>
              <p>Current Bid: ‚Çπ${auctionData.currentBid} Cr by ${auctionData.currentBidder || 'None'}</p>
            `;
          }
          
          // Update timer
          currentTime = auctionData.timer || 30;
          auctionTimer.textContent = currentTime;
          
          // Start/stop timer animation
          if (currentTime <= 10) {
            auctionTimer.style.color = '#f44336';
            auctionTimer.style.animation = 'pulse 0.5s infinite';
          } else {
            auctionTimer.style.color = '#ffeb3b';
            auctionTimer.style.animation = 'none';
          }
          
          // Update current bid
          currentBid = auctionData.currentBid || 0;
          currentBidder = auctionData.currentBidder;
          
          // Enable/disable RTM button
          if (auctionData.currentPlayer && auctionData.currentPlayer.rtmEligible && 
              auctionData.currentPlayer.rtmEligible.includes(currentTeam) {
            rtmBtn.disabled = false;
          } else {
            rtmBtn.disabled = true;
          }
        }
        
        // Update player pool for admin selection
        if (isAdmin && auctionData.playerPool) {
          playerPool = Object.values(auctionData.playerPool).filter(p => p.status === 'pending');
          renderPlayerSelection();
        }
        
        // Update teams data
        if (auctionData.teams) {
          teams = auctionData.teams;
          renderTeamSquads();
          
          // Update current team info
          if (teams[currentTeam]) {
            budget = teams[currentTeam].budget;
            rtmCards = teams[currentTeam].rtmCards || 0;
            budgetDisplay.textContent = `‚Çπ${budget} Cr`;
            rtmCount.textContent = rtmCards;
            rtmBtn.textContent = `RTM (${rtmCards})`;
          }
        }
      });
      
      // Show admin controls if admin
      if (isAdmin) {
        adminControls.style.display = 'block';
      }
    }
    
    // Render player selection for admin
    function renderPlayerSelection() {
      playerSelectionGrid.innerHTML = '';
      
      // Group players by role
      const playersByRole = {
        'Batter': [],
        'Pacer': [],
        'Spinner': [],
        'All-Rounder': [],
        'Wicket-Keeper': []
      };
      
      playerPool.forEach(player => {
        if (playersByRole[player.role]) {
          playersByRole[player.role].push(player);
        }
      });
      
      // Render each group
      for (const [role, players] of Object.entries(playersByRole)) {
        if (players.length === 0) continue;
        
        const roleHeader = document.createElement('h3');
        roleHeader.textContent = role;
        roleHeader.style.gridColumn = '1 / -1';
        roleHeader.style.textAlign = 'left';
        roleHeader.style.marginBottom = '5px';
        playerSelectionGrid.appendChild(roleHeader);
        
        players.forEach(player => {
          const card = document.createElement('div');
          card.className = 'player-card';
          card.dataset.playerId = player.id;
          
          card.innerHTML = `
            <h3>${player.name}</h3>
            <p class="player-role role-${player.role.toLowerCase().replace('-', '')}">${player.role}</p>
            <p>Base: ‚Çπ${player.basePrice} Cr</p>
            <button class="btn btn-primary" style="padding: 5px 10px; font-size: 12px; margin-top: 5px;">Select</button>
          `;
          
          card.querySelector('button').addEventListener('click', () => {
            selectPlayerForAuction(player);
          });
          
          playerSelectionGrid.appendChild(card);
        });
      }
    }
    
    // Select player for auction (admin only)
    async function selectPlayerForAuction(player) {
      try {
        // Check if player is already being auctioned
        const auctionSnap = await get(auctionRef);
        if (auctionSnap.exists() && auctionSnap.val().currentPlayer) {
          showMessage('Another player is currently being auctioned', 'error');
          return;
        }
        
        // Update player status to active
        await update(ref(db, `auctions/${roomCode}/playerPool/${player.id}`), {
          status: 'active'
        });
        
        // Set as current player
        await update(auctionRef, {
          currentPlayer: {
            id: player.id,
            name: player.name,
            role: player.role,
            basePrice: player.basePrice,
            rtmEligible: player.rtmEligible || []
          },
          currentBid: player.basePrice,
          currentBidder: null,
          timer: 30,
          status: 'active'
        });
        
        // Close modal
        playerSelectionModal.style.display = 'none';
        showMessage(`Auction started for ${player.name}`, 'success');
      } catch (error) {
        console.error('Error selecting player:', error);
        showMessage('Failed to start auction for player. Please try again.', 'error');
      }
    }
    
    // Render team squads
    function renderTeamSquads() {
      teamSquadsContainer.innerHTML = '';
      
      for (const [teamName, teamData] of Object.entries(teams)) {
        const squadDiv = document.createElement('div');
        squadDiv.className = 'team-squad';
        
        squadDiv.innerHTML = `
          <h3>${teamName} <span style="font-size: 14px; color: #4CAF50;">‚Çπ${teamData.budget} Cr</span></h3>
          <p>Players: ${teamData.players ? teamData.players.length : 0}/25</p>
          <p>RTM Cards: ${teamData.rtmCards || 0}</p>
          <ul>
            ${teamData.players ? teamData.players.map(p => `<li>${p.name} (‚Çπ${p.price} Cr)</li>`).join('') : ''}
          </ul>
        `;
        
        teamSquadsContainer.appendChild(squadDiv);
      }
    }
    
    // Place bid
    async function placeBid(amount) {
      if (!currentPlayer) {
        showMessage('No player is currently being auctioned', 'error');
        return;
      }
      
      if (currentBidder === currentTeam) {
        showMessage('You already have the highest bid', 'error');
        return;
      }
      
      const newBid = currentBid + amount;
      
      if (newBid > budget) {
        showMessage('Bid exceeds your remaining budget', 'error');
        return;
      }
      
      try {
        await update(auctionRef, {
          currentBid: newBid,
          currentBidder: currentTeam,
          timer: 30 // Reset timer
        });
        
        showMessage(`Bid of ‚Çπ${newBid} Cr placed for ${currentPlayer.name}`, 'success');
      } catch (error) {
        console.error('Error placing bid:', error);
        showMessage('Failed to place bid. Please try again.', 'error');
      }
    }
    
    // Place custom bid
    bidCustomBtn.addEventListener('click', () => {
      if (!currentPlayer) {
        showMessage('No player is currently being auctioned', 'error');
        return;
      }
      
      customBidAmount.value = (currentBid + 0.25).toFixed(2);
      customBidAmount.min = (currentBid + 0.25).toFixed(2);
      customBidModal.style.display = 'flex';
    });
    
    confirmCustomBidBtn.addEventListener('click', async () => {
      const amount = parseFloat(customBidAmount.value);
      
      if (isNaN(amount) {
        showMessage('Please enter a valid bid amount', 'error');
        return;
      }
      
      if (amount <= currentBid) {
        showMessage(`Bid must be higher than current bid (‚Çπ${currentBid} Cr)`, 'error');
        return;
      }
      
      if (amount > budget) {
        showMessage('Bid exceeds your remaining budget', 'error');
        return;
      }
      
      customBidModal.style.display = 'none';
      await placeBid(amount - currentBid);
    });
    
    // Quick bid buttons
    bid025Btn.addEventListener('click', () => placeBid(0.25));
    bid050Btn.addEventListener('click', () => placeBid(0.50));
    bid100Btn.addEventListener('click', () => placeBid(1.00));
    
    // Pass on player
    passBtn.addEventListener('click', async () => {
      if (!currentPlayer) {
        showMessage('No player is currently being auctioned', 'error');
        return;
      }
      
      showMessage(`Passed on ${currentPlayer.name}`, 'info');
    });
    
    // Use RTM card
    rtmBtn.addEventListener('click', async () => {
      if (!currentPlayer) {
        showMessage('No player is currently being auctioned', 'error');
        return;
      }
      
      if (rtmCards <= 0) {
        showMessage('No RTM cards remaining', 'error');
        return;
      }
      
      if (currentBidder === currentTeam) {
        showMessage('You already have the highest bid', 'error');
        return;
      }
      
      if (confirm(`Use RTM card to match ‚Çπ${currentBid} Cr bid for ${currentPlayer.name}?`)) {
        try {
          // Update auction state for RTM
          await update(auctionRef, {
            currentBidder: currentTeam,
            timer: 30, // Reset timer
            [`teams/${currentTeam}/rtmCards`]: rtmCards - 1
          });
          
          showMessage(`RTM used! Matching ‚Çπ${currentBid} Cr bid for ${currentPlayer.name}`, 'success');
        } catch (error) {
          console.error('Error using RTM:', error);
          showMessage('Failed to use RTM. Please try again.', 'error');
        }
      }
    });
    
    // Admin controls
    nextPlayerBtn.addEventListener('click', async () => {
      if (!currentPlayer) {
        showMessage('No player is currently being auctioned', 'error');
        return;
      }
      
      if (confirm('Move to next player without selling?')) {
        try {
          // Mark player as unsold
          await update(ref(db, `auctions/${roomCode}/playerPool/${currentPlayer.id}`), {
            status: 'unsold'
          });
          
          // Reset auction state
          await update(auctionRef, {
            currentPlayer: null,
            currentBid: 0,
            currentBidder: null,
            timer: 0,
            status: 'setup'
          });
          
          showMessage(`${currentPlayer.name} marked as unsold`, 'info');
        } catch (error) {
          console.error('Error moving to next player:', error);
          showMessage('Failed to move to next player. Please try again.', 'error');
        }
      }
    });
    
    autoSellBtn.addEventListener('click', async () => {
      if (!currentPlayer) {
        showMessage('No player is currently being auctioned', 'error');
        return;
      }
      
      if (!currentBidder) {
        showMessage('No bids placed for this player', 'error');
        return;
      }
      
      if (confirm(`Sell ${currentPlayer.name} to ${currentBidder} for ‚Çπ${currentBid} Cr?`)) {
        await sellPlayer();
      }
    });
    
    soldBtn.addEventListener('click', async () => {
      if (!currentPlayer) {
        showMessage('No player is currently being auctioned', 'error');
        return;
      }
      
      if (!currentBidder) {
        showMessage('No bids placed for this player', 'error');
        return;
      }
      
      if (confirm(`Confirm sale of ${currentPlayer.name} to ${currentBidder} for ‚Çπ${currentBid} Cr?`)) {
        await sellPlayer();
      }
    });
    
    // Sell player to winning bidder
    async function sellPlayer() {
      try {
        // Update player status to sold
        await update(ref(db, `auctions/${roomCode}/playerPool/${currentPlayer.id}`), {
          status: 'sold'
        });
        
        // Add player to winning team
        const playerData = {
          name: currentPlayer.name,
          role: currentPlayer.role,
          price: currentBid
        };
        
        await update(ref(db, `auctions/${roomCode}/teams/${currentBidder}/players`), [
          ...(teams[currentBidder].players || []),
          playerData
        ]);
        
        // Deduct from team budget
        await update(ref(db, `auctions/${roomCode}/teams/${currentBidder}/budget`), 
          teams[currentBidder].budget - currentBid
        );
        
        // Reset auction state
        await update(auctionRef, {
          currentPlayer: null,
          currentBid: 0,
          currentBidder: null,
          timer: 0,
          status: 'setup'
        });
        
        showMessage(`${currentPlayer.name} sold to ${currentBidder} for ‚Çπ${currentBid} Cr`, 'success');
      } catch (error) {
        console.error('Error selling player:', error);
        showMessage('Failed to sell player. Please try again.', 'error');
      }
    }
    
    // End auction
    endAuctionBtn.addEventListener('click', async () => {
      if (confirm('Are you sure you want to end the auction?')) {
        try {
          // Update auction status
          await update(auctionRef, {
            status: 'completed'
          });
          
          // Save teams' squads to their user profiles
          const auctionSnap = await get(auctionRef);
          const auctionData = auctionSnap.val();
          
          if (auctionData.teams) {
            for (const [teamName, teamData] of Object.entries(auctionData.teams)) {
              const teamUserRef = ref(db, `users/${teamData.admin || ''}`);
              const teamUserSnap = await get(teamUserRef);
              
              if (teamUserSnap.exists()) {
                // Update user with auction purchases
                await update(teamUserRef, {
                  auctionPurchases: teamData.players || [],
                  budget: teamData.budget || 0
                });
              }
            }
          }
          
          showMessage('Auction completed successfully!', 'success');
          setTimeout(() => {
            window.location.href = 'index.html';
          }, 2000);
        } catch (error) {
          console.error('Error ending auction:', error);
          showMessage('Failed to end auction. Please try again.', 'error');
        }
      }
    });
    
    // Open player selection modal (admin only)
    if (isAdmin) {
      nextPlayerBtn.addEventListener('click', () => {
        playerSelectionModal.style.display = 'flex';
      });
    }
    
    // Back to home
    backToHomeBtn.addEventListener('click', () => {
      if (confirm('Are you sure you want to leave the auction?')) {
        window.location.href = 'index.html';
      }
    });
    
    // Show section helper
    function showSection(section) {
      retentionSection.classList.remove('active');
      auctionSetupSection.classList.remove('active');
      auctionSection.classList.remove('active');
      
      if (section === 'retention') {
        retentionSection.classList.add('active');
        backToRetentionBtn.style.display = 'none';
      } else if (section === 'auctionSetup') {
        auctionSetupSection.classList.add('active');
        backToRetentionBtn.style.display = isAdmin ? 'inline-block' : 'none';
      } else if (section === 'auction') {
        auctionSection.classList.add('active');
      }
    }
    
    // Show message helper
    function showMessage(message, type) {
      if (type === 'error') {
        errorMessage.textContent = message;
        successMessage.textContent = '';
      } else if (type === 'success') {
        successMessage.textContent = message;
        errorMessage.textContent = '';
      } else {
        // Info message - use either one
        successMessage.textContent = message;
        errorMessage.textContent = '';
      }
      
      // Clear after 3 seconds
      setTimeout(() => {
        errorMessage.textContent = '';
        successMessage.textContent = '';
      }, 3000);
    }
  </script>
</body>
</html>