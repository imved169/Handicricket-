<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HandiCricket - Auction Room</title>
  <style>
    body {
      background: linear-gradient(135deg, #061e3e, #0a2a4a);
      color: white;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    h1 {
      color: #ffeb3b;
      text-shadow: 0 0 10px rgba(255, 235, 59, 0.5);
      text-align: center;
      margin-bottom: 20px;
    }
    
    .user-info {
      margin-bottom: 20px;
      padding: 15px;
      background: rgba(13, 42, 82, 0.5);
      border-radius: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .user-info p {
      margin: 5px 0;
    }
    
    .user-team {
      font-weight: bold;
      color: #ffeb3b;
    }
    
    .budget-display {
      font-size: 24px;
      color: #4CAF50;
      font-weight: bold;
    }
    
    .rtm-display {
      font-size: 18px;
      color: #FF9800;
      font-weight: bold;
    }
    
    .section {
      margin-bottom: 30px;
      background: rgba(13, 42, 82, 0.5);
      border-radius: 10px;
      padding: 20px;
    }
    
    .section-title {
      color: #1e88e5;
      margin-top: 0;
      border-bottom: 2px solid #1e88e5;
      padding-bottom: 10px;
    }
    
    .grid-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    
    @media (max-width: 900px) {
      .grid-container {
        grid-template-columns: 1fr;
      }
    }
    
    .player-card {
      background: rgba(30, 136, 229, 0.2);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
      border-left: 4px solid;
      position: relative;
    }
    
    .player-card.batter {
      border-color: #FF5722;
    }
    
    .player-card.pacer {
      border-color: #4CAF50;
    }
    
    .player-card.spinner {
      border-color: #9C27B0;
    }
    
    .player-card.allrounder {
      border-color: #FFC107;
    }
    
    .player-card.wicketkeeper {
      border-color: #607D8B;
    }
    
    .player-name {
      font-size: 20px;
      font-weight: bold;
      margin: 0 0 5px 0;
    }
    
    .player-role {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
      margin-right: 8px;
      margin-bottom: 8px;
    }
    
    .batter-role {
      background-color: rgba(255, 87, 34, 0.2);
      color: #FF5722;
    }
    
    .pacer-role {
      background-color: rgba(76, 175, 80, 0.2);
      color: #4CAF50;
    }
    
    .spinner-role {
      background-color: rgba(156, 39, 176, 0.2);
      color: #9C27B0;
    }
    
    .allrounder-role {
      background-color: rgba(255, 193, 7, 0.2);
      color: #FFC107;
    }
    
    .wicketkeeper-role {
      background-color: rgba(96, 125, 139, 0.2);
      color: #607D8B;
    }
    
    .player-stats {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 10px 0;
    }
    
    .stat-item {
      background: rgba(255, 255, 255, 0.1);
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 14px;
    }
    
    .player-price {
      font-weight: bold;
      font-size: 18px;
      color: #ffeb3b;
    }
    
    .current-bid {
      font-size: 24px;
      color: #4CAF50;
      margin: 10px 0;
      text-align: center;
    }
    
    .bidder-info {
      text-align: center;
      margin-bottom: 15px;
      font-size: 18px;
    }
    
    .bid-controls {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .btn {
      padding: 12px;
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    }
    
    .btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 10px rgba(0, 0, 0, 0.3);
    }
    
    .btn:active {
      transform: translateY(1px);
    }
    
    .btn-bid {
      background: linear-gradient(145deg, #4CAF50, #2E7D32);
    }
    
    .btn-pass {
      background: linear-gradient(145deg, #607D8B, #455A64);
    }
    
    .btn-rtm {
      background: linear-gradient(145deg, #FF9800, #F57C00);
    }
    
    .btn-sold {
      background: linear-gradient(145deg, #1e88e5, #1565c0);
    }
    
    .btn-admin {
      background: linear-gradient(145deg, #9C27B0, #7B1FA2);
    }
    
    .btn-danger {
      background: linear-gradient(145deg, #f44336, #d32f2f);
    }
    
    .btn-back {
      background: linear-gradient(145deg, #795548, #5D4037);
    }
    
    .timer {
      font-size: 24px;
      text-align: center;
      margin: 15px 0;
      color: #ffeb3b;
    }
    
    .team-squads {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    
    .team-squad {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      padding: 15px;
    }
    
    .team-name {
      font-weight: bold;
      color: #1e88e5;
      margin-top: 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding-bottom: 5px;
    }
    
    .squad-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .squad-list li {
      padding: 5px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .squad-list li:last-child {
      border-bottom: none;
    }
    
    .player-price-small {
      font-size: 12px;
      color: #aaa;
      float: right;
    }
    
    .admin-controls {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .admin-input-group {
      margin-bottom: 15px;
    }
    
    .admin-input-group label {
      display: block;
      margin-bottom: 5px;
      color: #aaa;
    }
    
    .admin-input-group input, .admin-input-group select {
      width: 100%;
      padding: 10px;
      border: 1px solid #1e88e5;
      border-radius: 5px;
      background: rgba(30, 136, 229, 0.1);
      color: white;
      box-sizing: border-box;
    }
    
    .admin-input-group select option {
      background: #061e3e;
    }
    
    .bulk-input {
      width: 100%;
      height: 100px;
      padding: 10px;
      border: 1px solid #1e88e5;
      border-radius: 5px;
      background: rgba(30, 136, 229, 0.1);
      color: white;
      font-family: inherit;
      resize: vertical;
    }
    
    .player-pool {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }
    
    .player-pool-item {
      background: rgba(255, 255, 255, 0.05);
      padding: 10px;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .player-pool-item:hover {
      background: rgba(30, 136, 229, 0.3);
    }
    
    .player-pool-item.selected {
      background: rgba(255, 235, 59, 0.2);
      border: 1px solid #ffeb3b;
    }
    
    .auction-queue {
      margin-top: 15px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 5px;
      padding: 10px;
      min-height: 50px;
    }
    
    .queue-item {
      display: inline-block;
      background: rgba(30, 136, 229, 0.3);
      padding: 5px 10px;
      border-radius: 15px;
      margin-right: 5px;
      margin-bottom: 5px;
      font-size: 14px;
    }
    
    .retention-section {
      margin-bottom: 30px;
    }
    
    .retention-players {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    
    .retention-player {
      background: rgba(255, 255, 255, 0.05);
      padding: 15px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }
    
    .retention-player:hover {
      background: rgba(30, 136, 229, 0.2);
    }
    
    .retention-player.selected {
      background: rgba(76, 175, 80, 0.2);
      border: 1px solid #4CAF50;
    }
    
    .retention-player.captain {
      background: rgba(255, 235, 59, 0.2);
      border: 1px solid #FFEB3B;
    }
    
    .retention-badge {
      position: absolute;
      top: 5px;
      right: 5px;
      background: #4CAF50;
      color: white;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .captain-badge {
      position: absolute;
      top: 5px;
      left: 5px;
      background: #FFC107;
      color: #000;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .retention-cost {
      margin-top: 20px;
      padding: 10px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 5px;
      text-align: center;
    }
    
    .retention-submit {
      margin-top: 15px;
      text-align: center;
    }
    
    .room-code-display {
      margin: 15px 0;
      padding: 10px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 5px;
      text-align: center;
      font-size: 18px;
    }
    
    .room-code {
      font-weight: bold;
      color: #ffeb3b;
      font-size: 24px;
      letter-spacing: 3px;
    }
    
    .join-room-form {
      margin-top: 20px;
    }
    
    .loading-spinner {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 3px solid #1e88e5;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    .error-message {
      color: #f44336;
      margin: 10px 0;
      text-align: center;
    }
    
    .success-message {
      color: #4CAF50;
      margin: 10px 0;
      text-align: center;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @media (max-width: 600px) {
      .bid-controls {
        grid-template-columns: 1fr 1fr;
      }
      
      .container {
        padding: 15px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üèè IPL 2025 Auction Room</h1>
    
    <div id="userInfo" class="user-info">
      <div>
        <p>Team: <span id="teamDisplay" class="user-team"></span></p>
        <p>Players: <span id="playerCount">0/25</span></p>
      </div>
      <div>
        <p class="budget-display">Budget: ‚Çπ<span id="budgetDisplay">150.00</span> Cr</p>
        <p class="rtm-display">RTM Cards: <span id="rtmDisplay">0</span></p>
      </div>
    </div>
    
    <div id="retentionSection" class="retention-section section" style="display: none;">
      <h2 class="section-title">Player Retention</h2>
      <p>Retain up to 6 players from your previous squad. Captain retention costs ‚Çπ4 Cr, others cost ‚Çπ2 Cr.</p>
      
      <div class="retention-players" id="retentionPlayersList"></div>
      
      <div class="retention-cost">
        <p>Total Retention Cost: ‚Çπ<span id="retentionCost">0.00</span> Cr</p>
        <p>Remaining Budget: ‚Çπ<span id="remainingBudget">150.00</span> Cr</p>
        <p>RTM Cards Earned: <span id="rtmEarned">0</span></p>
      </div>
      
      <div class="retention-submit">
        <button id="submitRetentionBtn" class="btn btn-bid">Submit Retention</button>
      </div>
    </div>
    
    <div id="roomSetupSection" class="section" style="display: none;">
      <h2 class="section-title">Auction Room Setup</h2>
      
      <div id="adminControls" style="display: none;">
        <div class="room-code-display">
          Room Code: <span class="room-code" id="adminRoomCode"></span>
        </div>
        
        <div class="admin-controls">
          <h3>Add Players to Auction Pool</h3>
          
          <div class="admin-input-group">
            <label for="playerName">Player Name</label>
            <input type="text" id="playerName" placeholder="Enter player name">
          </div>
          
          <div class="admin-input-group">
            <label for="playerRole">Player Role</label>
            <select id="playerRole">
              <option value="batter">Batter</option>
              <option value="pacer">Pacer</option>
              <option value="spinner">Spinner</option>
              <option value="allrounder">All-Rounder</option>
              <option value="wicketkeeper">Wicket-Keeper</option>
            </select>
          </div>
          
          <div class="admin-input-group">
            <label for="playerBasePrice">Base Price (in Cr)</label>
            <input type="number" id="playerBasePrice" placeholder="Enter base price" min="0.2" step="0.05" value="0.2">
          </div>
          
          <button id="addPlayerBtn" class="btn btn-admin">Add Player</button>
          
          <div class="admin-input-group" style="margin-top: 20px;">
            <label for="bulkPlayers">Bulk Add Players (Format: Name,Role,BasePrice)</label>
            <textarea id="bulkPlayers" class="bulk-input" placeholder="Virat Kohli,batter,2.00&#10;Jasprit Bumrah,pacer,1.50&#10;..."></textarea>
          </div>
          
          <button id="bulkAddBtn" class="btn btn-admin">Bulk Add Players</button>
        </div>
        
        <div class="admin-controls">
          <h3>Player Pool</h3>
          <div class="player-pool" id="playerPool"></div>
          
          <div style="margin-top: 20px;">
            <button id="selectAllBtn" class="btn btn-admin">Select All</button>
            <button id="clearSelectionBtn" class="btn btn-admin">Clear Selection</button>
          </div>
          
          <div class="auction-queue" id="auctionQueue">
            <p>Auction Queue (drag to reorder):</p>
            <div id="queueItems"></div>
          </div>
          
          <div style="margin-top: 10px;">
            <button id="addToQueueBtn" class="btn btn-admin">Add Selected to Queue</button>
            <button id="clearQueueBtn" class="btn btn-admin">Clear Queue</button>
            <button id="startWithQueueBtn" class="btn btn-admin">Start Auction with Queue</button>
            <button id="startRandomBtn" class="btn btn-admin">Start Random Auction</button>
          </div>
        </div>
      </div>
      
      <div id="joinRoomForm" class="join-room-form">
        <div class="admin-input-group">
          <label for="roomCodeInput">Enter Room Code</label>
          <input type="text" id="roomCodeInput" placeholder="Enter 4-digit room code" maxlength="4">
        </div>
        <button id="joinRoomBtn" class="btn btn-bid">Join Room</button>
        <p class="error-message" id="roomError"></p>
      </div>
    </div>
    
    <div id="auctionSection" class="section" style="display: none;">
      <h2 class="section-title">Live Auction</h2>
      
      <div class="current-bid" id="currentBid">‚Çπ0.00 Cr</div>
      <div class="bidder-info" id="bidderInfo">No bids yet</div>
      
      <div class="timer" id="auctionTimer">30</div>
      
      <div class="player-card" id="currentPlayerCard">
        <h3 class="player-name" id="currentPlayerName">No player selected</h3>
        <div class="player-stats">
          <span class="player-role" id="currentPlayerRole">Role</span>
          <span class="stat-item">Base: ‚Çπ<span id="currentPlayerBasePrice">0.00</span> Cr</span>
        </div>
        <div class="player-price">Current Bid: <span id="currentPlayerPrice">‚Çπ0.00 Cr</span></div>
      </div>
      
      <div class="bid-controls">
        <button class="btn btn-bid" data-increment="0.10">+0.10 Cr</button>
        <button class="btn btn-bid" data-increment="0.25">+0.25 Cr</button>
        <button class="btn btn-bid" data-increment="0.50">+0.50 Cr</button>
        <button class="btn btn-bid" data-increment="1.00">+1.00 Cr</button>
        <button id="passBtn" class="btn btn-pass">Pass</button>
        <button id="rtmBtn" class="btn btn-rtm">Use RTM</button>
        <button id="finalBidBtn" class="btn btn-bid" style="display: none;">Final Bid</button>
        <button id="autoSellBtn" class="btn btn-sold" style="display: none;">Auto Sell</button>
      </div>
      
      <div id="adminAuctionControls" class="admin-controls" style="display: none; margin-top: 20px;">
        <button id="nextPlayerBtn" class="btn btn-admin">Next Player</button>
        <button id="soldBtn" class="btn btn-sold">Sold</button>
        <button id="unsoldBtn" class="btn btn-pass">Unsold</button>
      </div>
    </div>
    
    <div class="section">
      <h2 class="section-title">Team Squads</h2>
      <div class="team-squads" id="teamSquads"></div>
    </div>
    
    <button id="backBtn" class="btn btn-back">Back to Home</button>
    
    <div class="loading-spinner" id="loadingSpinner"></div>
    <p class="error-message" id="errorMessage"></p>
    <p class="success-message" id="successMessage"></p>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getDatabase, ref, set, update, get, child, onValue, push } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCN6aZMwlsZe7JJaovU0WA3UQygWr4jYmA",
      authDomain: "handicricket-85a06.firebaseapp.com",
      projectId: "handicricket-85a06",
      storageBucket: "handicricket-85a06.appspot.com",
      messagingSenderId: "599182538558",
      appId: "1:599182538558:web:3e965753ab05f8f1e3de6f",
      measurementId: "G-HSV9H4LEJQ"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // DOM elements
    const teamDisplay = document.getElementById('teamDisplay');
    const playerCount = document.getElementById('playerCount');
    const budgetDisplay = document.getElementById('budgetDisplay');
    const rtmDisplay = document.getElementById('rtmDisplay');
    const retentionSection = document.getElementById('retentionSection');
    const retentionPlayersList = document.getElementById('retentionPlayersList');
    const retentionCost = document.getElementById('retentionCost');
    const remainingBudget = document.getElementById('remainingBudget');
    const rtmEarned = document.getElementById('rtmEarned');
    const submitRetentionBtn = document.getElementById('submitRetentionBtn');
    const roomSetupSection = document.getElementById('roomSetupSection');
    const adminControls = document.getElementById('adminControls');
    const adminRoomCode = document.getElementById('adminRoomCode');
    const playerNameInput = document.getElementById('playerName');
    const playerRoleSelect = document.getElementById('playerRole');
    const playerBasePriceInput = document.getElementById('playerBasePrice');
    const addPlayerBtn = document.getElementById('addPlayerBtn');
    const bulkPlayersInput = document.getElementById('bulkPlayers');
    const bulkAddBtn = document.getElementById('bulkAddBtn');
    const playerPool = document.getElementById('playerPool');
    const selectAllBtn = document.getElementById('selectAllBtn');
    const clearSelectionBtn = document.getElementById('clearSelectionBtn');
    const auctionQueue = document.getElementById('auctionQueue');
    const queueItems = document.getElementById('queueItems');
    const addToQueueBtn = document.getElementById('addToQueueBtn');
    const clearQueueBtn = document.getElementById('clearQueueBtn');
    const startWithQueueBtn = document.getElementById('startWithQueueBtn');
    const startRandomBtn = document.getElementById('startRandomBtn');
    const joinRoomForm = document.getElementById('joinRoomForm');
    const roomCodeInput = document.getElementById('roomCodeInput');
    const joinRoomBtn = document.getElementById('joinRoomBtn');
    const roomError = document.getElementById('roomError');
    const auctionSection = document.getElementById('auctionSection');
    const currentBid = document.getElementById('currentBid');
    const bidderInfo = document.getElementById('bidderInfo');
    const auctionTimer = document.getElementById('auctionTimer');
    const currentPlayerCard = document.getElementById('currentPlayerCard');
    const currentPlayerName = document.getElementById('currentPlayerName');
    const currentPlayerRole = document.getElementById('currentPlayerRole');
    const currentPlayerBasePrice = document.getElementById('currentPlayerBasePrice');
    const currentPlayerPrice = document.getElementById('currentPlayerPrice');
    const bidButtons = document.querySelectorAll('.btn-bid');
    const passBtn = document.getElementById('passBtn');
    const rtmBtn = document.getElementById('rtmBtn');
    const finalBidBtn = document.getElementById('finalBidBtn');
    const autoSellBtn = document.getElementById('autoSellBtn');
    const adminAuctionControls = document.getElementById('adminAuctionControls');
    const nextPlayerBtn = document.getElementById('nextPlayerBtn');
    const soldBtn = document.getElementById('soldBtn');
    const unsoldBtn = document.getElementById('unsoldBtn');
    const teamSquads = document.getElementById('teamSquads');
    const backBtn = document.getElementById('backBtn');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const errorMessage = document.getElementById('errorMessage');
    const successMessage = document.getElementById('successMessage');

    // Game state
    let currentUser = localStorage.getItem('hc_username');
    let currentTeam = localStorage.getItem('hc_team');
    let isAdmin = false;
    let roomCode = null;
    let selectedPlayers = [];
    let retentionSelections = [];
    let retentionCaptain = null;
    let timerInterval = null;
    let timeLeft = 30;
    let isRTMActive = false;
    let originalBidder = null;
    
    if (!currentUser || !currentTeam) {
      window.location.href = 'index.html';
    }
    
    teamDisplay.textContent = currentTeam;
    
    // Check if user is admin (imved169 or Ratnagiri Hunters)
    isAdmin = currentUser === 'imved169' || currentTeam === 'Ratnagiri Hunters';
    
    // Check if we have retention data to process
    const userRef = ref(db, `users/${currentUser}`);
    get(userRef).then((snap) => {
      if (snap.exists()) {
        const userData = snap.val();
        
        // Check if retention is already done
        if (userData.retentionDone) {
          showRoomSetup();
        } else {
          // Show retention section if we have previous players
          if (userData.players && userData.players.length > 0) {
            showRetentionSection(userData.players);
          } else {
            showRoomSetup();
          }
        }
      } else {
        showRoomSetup();
      }
    });
    
    // Show retention section with players
    function showRetentionSection(players) {
      loadingSpinner.style.display = 'none';
      retentionSection.style.display = 'block';
      
      retentionPlayersList.innerHTML = '';
      players.forEach(player => {
        const playerEl = document.createElement('div');
        playerEl.className = 'retention-player';
        playerEl.dataset.player = player;
        playerEl.innerHTML = `
          <div class="player-name">${player}</div>
          <div class="retention-badge">‚Çπ2 Cr</div>
        `;
        
        playerEl.addEventListener('click', () => {
          if (playerEl.classList.contains('captain')) {
            // Deselect as captain
            playerEl.classList.remove('captain');
            retentionCaptain = null;
            updateRetentionCost();
          } else if (!playerEl.classList.contains('selected') && retentionSelections.length < 6) {
            // Select as regular retention
            playerEl.classList.add('selected');
            retentionSelections.push(player);
            updateRetentionCost();
          } else if (playerEl.classList.contains('selected')) {
            // Deselect from retention
            playerEl.classList.remove('selected');
            retentionSelections = retentionSelections.filter(p => p !== player);
            updateRetentionCost();
          } else if (retentionSelections.length >= 6) {
            showError('Maximum 6 players can be retained');
          }
        });
        
        // Double click to set as captain
        playerEl.addEventListener('dblclick', () => {
          if (!playerEl.classList.contains('selected')) {
            if (retentionSelections.length < 6) {
              playerEl.classList.add('selected');
              retentionSelections.push(player);
            } else {
              showError('Maximum 6 players can be retained');
              return;
            }
          }
          
          // Clear previous captain
          document.querySelectorAll('.retention-player.captain').forEach(el => {
            el.classList.remove('captain');
          });
          
          // Set new captain
          playerEl.classList.add('captain');
          retentionCaptain = player;
          updateRetentionCost();
        });
        
        retentionPlayersList.appendChild(playerEl);
      });
    }
    
    // Update retention cost display
    function updateRetentionCost() {
      let cost = 0;
      if (retentionCaptain) cost += 4;
      cost += (retentionSelections.length - (retentionCaptain ? 1 : 0)) * 2;
      
      retentionCost.textContent = cost.toFixed(2);
      remainingBudget.textContent = (150 - cost).toFixed(2);
      
      // RTM cards = 6 - retained players
      const rtmCards = 6 - retentionSelections.length;
      rtmEarned.textContent = rtmCards;
    }
    
    // Submit retention choices
    submitRetentionBtn.addEventListener('click', async () => {
      if (retentionSelections.length === 0 && !confirm('Are you sure you want to retain 0 players?')) {
        return;
      }
      
      if (retentionSelections.length > 6) {
        showError('Maximum 6 players can be retained');
        return;
      }
      
      try {
        // Update user data with retention info
        await update(userRef, {
          retentionDone: true,
          retainedPlayers: retentionSelections,
          retentionCaptain: retentionCaptain || null,
          rtmCards: 6 - retentionSelections.length,
          budget: 150 - parseFloat(retentionCost.textContent)
        });
        
        showSuccess('Retention submitted successfully!');
        setTimeout(() => {
          showRoomSetup();
        }, 1500);
      } catch (error) {
        console.error('Error submitting retention:', error);
        showError('Failed to submit retention. Please try again.');
      }
    });
    
    // Show room setup section
    function showRoomSetup() {
      retentionSection.style.display = 'none';
      roomSetupSection.style.display = 'block';
      
      if (isAdmin) {
        joinRoomForm.style.display = 'none';
        adminControls.style.display = 'block';
        
        // Generate room code if admin
        roomCode = Math.floor(1000 + Math.random() * 9000);
        adminRoomCode.textContent = roomCode;
        
        // Create room in database
        set(ref(db, `auctionRooms/${roomCode}`), {
          admin: currentUser,
          adminTeam: currentTeam,
          status: 'setup',
          players: {},
          queue: [],
          currentPlayer: null,
          bids: {},
          teams: {}
        });
        
        // Load player pool
        loadPlayerPool();
      } else {
        joinRoomForm.style.display = 'block';
        adminControls.style.display = 'none';
      }
    }
    
    // Load player pool from database
    function loadPlayerPool() {
      const playersRef = ref(db, 'players');
      onValue(playersRef, (snap) => {
        if (snap.exists()) {
          playerPool.innerHTML = '';
          const players = snap.val();
          
          Object.entries(players).forEach(([id, player]) => {
            const playerEl = document.createElement('div');
            playerEl.className = 'player-pool-item';
            playerEl.dataset.id = id;
            playerEl.dataset.name = player.name;
            playerEl.dataset.role = player.role;
            playerEl.dataset.price = player.basePrice || '0.20';
            
            let roleClass = '';
            switch(player.role) {
              case 'batter': roleClass = 'batter-role'; break;
              case 'pacer': roleClass = 'pacer-role'; break;
              case 'spinner': roleClass = 'spinner-role'; break;
              case 'allrounder': roleClass = 'allrounder-role'; break;
              case 'wicketkeeper': roleClass = 'wicketkeeper-role'; break;
            }
            
            playerEl.innerHTML = `
              <div class="player-name">${player.name}</div>
              <div class="player-role ${roleClass}">${player.role}</div>
              <div class="player-price">Base: ‚Çπ${player.basePrice || '0.20'} Cr</div>
            `;
            
            playerEl.addEventListener('click', () => {
              playerEl.classList.toggle('selected');
              
              if (playerEl.classList.contains('selected')) {
                selectedPlayers.push({
                  id,
                  name: player.name,
                  role: player.role,
                  basePrice: player.basePrice || '0.20'
                });
              } else {
                selectedPlayers = selectedPlayers.filter(p => p.id !== id);
              }
            });
            
            playerPool.appendChild(playerEl);
          });
        }
      });
    }
    
    // Add single player to database
    addPlayerBtn.addEventListener('click', async () => {
      const name = playerNameInput.value.trim();
      const role = playerRoleSelect.value;
      const basePrice = parseFloat(playerBasePriceInput.value).toFixed(2);
      
      if (!name) {
        showError('Please enter player name');
        return;
      }
      
      if (isNaN(basePrice) || basePrice < 0.2) {
        showError('Base price must be at least ‚Çπ0.20 Cr');
        return;
      }
      
      try {
        const playerKey = name.toLowerCase().replace(/\s+/g, '_');
        await set(ref(db, `players/${playerKey}`), {
          name,
          role,
          basePrice
        });
        
        playerNameInput.value = '';
        playerBasePriceInput.value = '0.20';
        showSuccess('Player added successfully!');
      } catch (error) {
        console.error('Error adding player:', error);
        showError('Failed to add player. Please try again.');
      }
    });
    
    // Bulk add players
    bulkAddBtn.addEventListener('click', async () => {
      const bulkText = bulkPlayersInput.value.trim();
      if (!bulkText) {
        showError('Please enter player data');
        return;
      }
      
      const lines = bulkText.split('\n');
      const players = [];
      
      for (const line of lines) {
        const [name, role, price] = line.split(',').map(item => item.trim());
        if (name && role && price) {
          const basePrice = parseFloat(price);
          if (!isNaN(basePrice) && basePrice >= 0.2) {
            players.push({
              name,
              role: role.toLowerCase(),
              basePrice: basePrice.toFixed(2)
            });
          }
        }
      }
      
      if (players.length === 0) {
        showError('No valid player data found');
        return;
      }
      
      try {
        const updates = {};
        players.forEach(player => {
          const playerKey = player.name.toLowerCase().replace(/\s+/g, '_');
          updates[`players/${playerKey}/name`] = player.name;
          updates[`players/${playerKey}/role`] = player.role;
          updates[`players/${playerKey}/basePrice`] = player.basePrice;
        });
        
        await update(ref(db), updates);
        bulkPlayersInput.value = '';
        showSuccess(`Added ${players.length} players successfully!`);
      } catch (error) {
        console.error('Error bulk adding players:', error);
        showError('Failed to add players. Please check your data and try again.');
      }
    });
    
    // Select all players
    selectAllBtn.addEventListener('click', () => {
      document.querySelectorAll('.player-pool-item').forEach(el => {
        el.classList.add('selected');
        const id = el.dataset.id;
        const name = el.dataset.name;
        const role = el.dataset.role;
        const price = el.dataset.price;
        
        if (!selectedPlayers.some(p => p.id === id)) {
          selectedPlayers.push({ id, name, role, basePrice: price });
        }
      });
    });
    
    // Clear selection
    clearSelectionBtn.addEventListener('click', () => {
      document.querySelectorAll('.player-pool-item').forEach(el => {
        el.classList.remove('selected');
      });
      selectedPlayers = [];
    });
    
    // Add selected players to queue
    addToQueueBtn.addEventListener('click', async () => {
      if (selectedPlayers.length === 0) {
        showError('No players selected');
        return;
      }
      
      try {
        const updates = {};
        selectedPlayers.forEach(player => {
          updates[`auctionRooms/${roomCode}/queue/${player.id}`] = {
            name: player.name,
            role: player.role,
            basePrice: player.basePrice
          };
        });
        
        await update(ref(db), updates);
        showSuccess(`Added ${selectedPlayers.length} players to queue`);
        selectedPlayers = [];
        document.querySelectorAll('.player-pool-item.selected').forEach(el => {
          el.classList.remove('selected');
        });
      } catch (error) {
        console.error('Error adding to queue:', error);
        showError('Failed to add players to queue');
      }
    });
    
    // Clear queue
    clearQueueBtn.addEventListener('click', async () => {
      if (confirm('Are you sure you want to clear the auction queue?')) {
        try {
          await set(ref(db, `auctionRooms/${roomCode}/queue`), {});
          showSuccess('Queue cleared');
        } catch (error) {
          console.error('Error clearing queue:', error);
          showError('Failed to clear queue');
        }
      }
    });
    
    // Start auction with queue
    startWithQueueBtn.addEventListener('click', async () => {
      try {
        // Check if queue has players
        const queueSnap = await get(ref(db, `auctionRooms/${roomCode}/queue`));
        if (!queueSnap.exists() || Object.keys(queueSnap.val()).length === 0) {
          showError('Queue is empty');
          return;
        }
        
        // Update room status
        await update(ref(db, `auctionRooms/${roomCode}`), {
          status: 'auction'
        });
        
        // Start auction with first player in queue
        const queue = queueSnap.val();
        const firstPlayerId = Object.keys(queue)[0];
        await update(ref(db, `auctionRooms/${roomCode}`), {
          currentPlayer: {
            id: firstPlayerId,
            ...queue[firstPlayerId]
          },
          bids: {}
        });
        
        showAuctionSection();
      } catch (error) {
        console.error('Error starting auction:', error);
        showError('Failed to start auction');
      }
    });
    
    // Start random auction
    startRandomBtn.addEventListener('click', async () => {
      try {
        // Get all players
        const playersSnap = await get(ref(db, 'players'));
        if (!playersSnap.exists()) {
          showError('No players in database');
          return;
        }
        
        const players = playersSnap.val();
        const playerIds = Object.keys(players);
        
        if (playerIds.length === 0) {
          showError('No players in database');
          return;
        }
        
        // Select random player
        const randomId = playerIds[Math.floor(Math.random() * playerIds.length)];
        const player = players[randomId];
        
        // Update room status
        await update(ref(db, `auctionRooms/${roomCode}`), {
          status: 'auction',
          currentPlayer: {
            id: randomId,
            name: player.name,
            role: player.role,
            basePrice: player.basePrice || '0.20'
          },
          bids: {}
        });
        
        showAuctionSection();
      } catch (error) {
        console.error('Error starting random auction:', error);
        showError('Failed to start auction');
      }
    });
    
    // Join room
    joinRoomBtn.addEventListener('click', async () => {
      const code = roomCodeInput.value.trim();
      
      if (!code || code.length !== 4 || isNaN(code)) {
        showError('Please enter a valid 4-digit room code');
        return;
      }
      
      try {
        // Check if room exists
        const roomSnap = await get(ref(db, `auctionRooms/${code}`));
        if (!roomSnap.exists()) {
          showError('Room not found. Please check the code.');
          return;
        }
        
        const roomData = roomSnap.val();
        
        // Add team to room
        await update(ref(db, `auctionRooms/${code}/teams/${currentTeam}`), {
          name: currentTeam,
          owner: currentUser,
          budget: 150,
          players: [],
          rtmCards: 0
        });
        
        roomCode = code;
        showSuccess('Joined room successfully!');
        
        // Monitor room status
        onValue(ref(db, `auctionRooms/${code}/status`), (snap) => {
          if (snap.exists() && snap.val() === 'auction') {
            showAuctionSection();
          }
        });
        
        // Monitor current player
        onValue(ref(db, `auctionRooms/${code}/currentPlayer`), (snap) => {
          if (snap.exists()) {
            updateCurrentPlayer(snap.val());
          }
        });
        
        // Monitor bids
        onValue(ref(db, `auctionRooms/${code}/bids`), (snap) => {
          if (snap.exists()) {
            updateBids(snap.val());
          }
        });
        
        // Monitor teams
        onValue(ref(db, `auctionRooms/${code}/teams`), (snap) => {
          if (snap.exists()) {
            updateTeamSquads(snap.val());
          }
        });
      } catch (error) {
        console.error('Error joining room:', error);
        showError('Failed to join room. Please try again.');
      }
    });
    
    // Show auction section
    function showAuctionSection() {
      roomSetupSection.style.display = 'none';
      auctionSection.style.display = 'block';
      
      if (isAdmin) {
        adminAuctionControls.style.display = 'block';
      } else {
        adminAuctionControls.style.display = 'none';
      }
      
      // Start monitoring auction
      monitorAuction();
    }
    
    // Monitor auction state
    function monitorAuction() {
      // Current player
      onValue(ref(db, `auctionRooms/${roomCode}/currentPlayer`), (snap) => {
        if (snap.exists()) {
          updateCurrentPlayer(snap.val());
        } else {
          currentPlayerName.textContent = 'No player selected';
          currentPlayerRole.textContent = 'Role';
          currentPlayerBasePrice.textContent = '0.00';
          currentPlayerPrice.textContent = '‚Çπ0.00 Cr';
        }
      });
      
      // Bids
      onValue(ref(db, `auctionRooms/${roomCode}/bids`), (snap) => {
        if (snap.exists()) {
          updateBids(snap.val());
        } else {
          currentBid.textContent = '‚Çπ0.00 Cr';
          bidderInfo.textContent = 'No bids yet';
        }
      });
      
      // Timer (admin only)
      if (isAdmin) {
        onValue(ref(db, `auctionRooms/${roomCode}/timer`), (snap) => {
          if (snap.exists()) {
            timeLeft = snap.val();
            auctionTimer.textContent = timeLeft;
            
            if (timeLeft <= 0) {
              // Auto sell if no bids
              const bidsRef = ref(db, `auctionRooms/${roomCode}/bids`);
              get(bidsRef).then((bidSnap) => {
                if (!bidSnap.exists() || Object.keys(bidSnap.val()).length === 0) {
                  autoSellBtn.click();
                }
              });
            }
          }
        });
      }
    }
    
    // Update current player display
    function updateCurrentPlayer(player) {
      currentPlayerName.textContent = player.name;
      currentPlayerBasePrice.textContent = player.basePrice;
      
      let roleClass = '';
      switch(player.role) {
        case 'batter': 
          roleClass = 'batter-role';
          currentPlayerCard.className = 'player-card batter';
          break;
        case 'pacer': 
          roleClass = 'pacer-role';
          currentPlayerCard.className = 'player-card pacer';
          break;
        case 'spinner': 
          roleClass = 'spinner-role';
          currentPlayerCard.className = 'player-card spinner';
          break;
        case 'allrounder': 
          roleClass = 'allrounder-role';
          currentPlayerCard.className = 'player-card allrounder';
          break;
        case 'wicketkeeper': 
          roleClass = 'wicketkeeper-role';
          currentPlayerCard.className = 'player-card wicketkeeper';
          break;
      }
      
      currentPlayerRole.textContent = player.role;
      currentPlayerRole.className = `player-role ${roleClass}`;
    }
    
    // Update bids display
    function updateBids(bids) {
      if (!bids || Object.keys(bids).length === 0) {
        currentBid.textContent = '‚Çπ0.00 Cr';
        currentPlayerPrice.textContent = '‚Çπ0.00 Cr';
        bidderInfo.textContent = 'No bids yet';
        return;
      }
      
      // Find highest bid
      let highestBid = 0;
      let highestBidder = '';
      
      Object.entries(bids).forEach(([team, bid]) => {
        if (bid.amount > highestBid && !bid.isRTM) {
          highestBid = bid.amount;
          highestBidder = team;
        }
      });
      
      if (highestBid > 0) {
        currentBid.textContent = `‚Çπ${highestBid.toFixed(2)} Cr`;
        currentPlayerPrice.textContent = `‚Çπ${highestBid.toFixed(2)} Cr`;
        bidderInfo.textContent = `Highest bidder: ${highestBidder}`;
        
        // Start timer if admin
        if (isAdmin && !timerInterval) {
          startTimer();
        }
      }
    }
    
    // Update team squads display
    function updateTeamSquads(teams) {
      teamSquads.innerHTML = '';
      
      Object.entries(teams).forEach(([teamName, teamData]) => {
        const squadEl = document.createElement('div');
        squadEl.className = 'team-squad';
        
        let playersHtml = '';
        if (teamData.players && teamData.players.length > 0) {
          playersHtml = teamData.players.map(player => `
            <li>${player.name} <span class="player-price-small">‚Çπ${player.price} Cr</span></li>
          `).join('');
        } else {
          playersHtml = '<li>No players yet</li>';
        }
        
        squadEl.innerHTML = `
          <h3 class="team-name">${teamName} (‚Çπ${teamData.budget.toFixed(2)} Cr)</h3>
          <ul class="squad-list">${playersHtml}</ul>
          <p>Players: ${teamData.players ? teamData.players.length : 0}/25</p>
          <p>RTM Cards: ${teamData.rtmCards || 0}</p>
        `;
        
        teamSquads.appendChild(squadEl);
      });
    }
    
    // Start timer (admin only)
    function startTimer() {
      if (timerInterval) clearInterval(timerInterval);
      
      timeLeft = 30;
      auctionTimer.textContent = timeLeft;
      
      if (isAdmin) {
        set(ref(db, `auctionRooms/${roomCode}/timer`), timeLeft);
      }
      
      timerInterval = setInterval(() => {
        timeLeft--;
        auctionTimer.textContent = timeLeft;
        
        if (isAdmin) {
          set(ref(db, `auctionRooms/${roomCode}/timer`), timeLeft);
        }
        
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          timerInterval = null;
        }
      }, 1000);
    }
    
    // Bid button handler
    bidButtons.forEach(btn => {
      btn.addEventListener('click', async () => {
        const increment = parseFloat(btn.dataset.increment);
        
        // Get current highest bid
        const bidsSnap = await get(ref(db, `auctionRooms/${roomCode}/bids`));
        let currentBidAmount = 0;
        
        if (bidsSnap.exists()) {
          const bids = bidsSnap.val();
          Object.values(bids).forEach(bid => {
            if (bid.amount > currentBidAmount && !bid.isRTM) {
              currentBidAmount = bid.amount;
            }
          });
        }
        
        const newBidAmount = currentBidAmount + increment;
        
        // Get team budget
        const teamSnap = await get(ref(db, `auctionRooms/${roomCode}/teams/${currentTeam}`));
        if (!teamSnap.exists()) {
          showError('Team data not found');
          return;
        }
        
        const teamData = teamSnap.val();
        if (newBidAmount > teamData.budget) {
          showError('Not enough budget for this bid');
          return;
        }
        
        // Place bid
        try {
          await set(ref(db, `auctionRooms/${roomCode}/bids/${currentTeam}`), {
            amount: newBidAmount,
            isRTM: false,
            timestamp: Date.now()
          });
          
          // Reset timer
          if (isAdmin) {
            timeLeft = 30;
            set(ref(db, `auctionRooms/${roomCode}/timer`), timeLeft);
          }
        } catch (error) {
          console.error('Error placing bid:', error);
          showError('Failed to place bid. Please try again.');
        }
      });
    });
    
    // Pass button
    passBtn.addEventListener('click', async () => {
      try {
        // Remove team's bid if exists
        await set(ref(db, `auctionRooms/${roomCode}/bids/${currentTeam}`), null);
      } catch (error) {
        console.error('Error passing:', error);
        showError('Failed to pass. Please try again.');
      }
    });
    
    // RTM button
    rtmBtn.addEventListener('click', async () => {
      // Check if player was in our previous squad
      const userSnap = await get(userRef);
      if (!userSnap.exists()) {
        showError('User data not found');
        return;
      }
      
      const userData = userSnap.val();
      const currentPlayerSnap = await get(ref(db, `auctionRooms/${roomCode}/currentPlayer`));
      if (!currentPlayerSnap.exists()) {
        showError('No player currently being auctioned');
        return;
      }
      
      const currentPlayer = currentPlayerSnap.val();
      const wasInSquad = userData.players && userData.players.includes(currentPlayer.name);
      
      if (!wasInSquad) {
        showError('This player was not in your previous squad');
        return;
      }
      
      // Check if we have RTM cards
      const teamSnap = await get(ref(db, `auctionRooms/${roomCode}/teams/${currentTeam}`));
      if (!teamSnap.exists() || !teamSnap.val().rtmCards || teamSnap.val().rtmCards <= 0) {
        showError('No RTM cards remaining');
        return;
      }
      
      // Get current highest bid
      const bidsSnap = await get(ref(db, `auctionRooms/${roomCode}/bids`));
      let highestBid = 0;
      let highestBidder = '';
      
      if (bidsSnap.exists()) {
        const bids = bidsSnap.val();
        Object.entries(bids).forEach(([team, bid]) => {
          if (bid.amount > highestBid && !bid.isRTM) {
            highestBid = bid.amount;
            highestBidder = team;
          }
        });
      }
      
      if (highestBid <= 0) {
        showError('No bids to match with RTM');
        return;
      }
      
      // Confirm RTM usage
      if (!confirm(`Use RTM to match ${highestBidder}'s bid of ‚Çπ${highestBid.toFixed(2)} Cr for ${currentPlayer.name}?`)) {
        return;
      }
      
      try {
        // Activate RTM
        isRTMActive = true;
        originalBidder = highestBidder;
        
        await set(ref(db, `auctionRooms/${roomCode}/bids/${currentTeam}`), {
          amount: highestBid,
          isRTM: true,
          timestamp: Date.now()
        });
        
        // Show final bid button to original bidder
        if (isAdmin) {
          await update(ref(db, `auctionRooms/${roomCode}/bids/${highestBidder}`), {
            canFinalBid: true
          });
        }
        
        // Reset timer
        if (isAdmin) {
          timeLeft = 30;
          set(ref(db, `auctionRooms/${roomCode}/timer`), timeLeft);
        }
      } catch (error) {
        console.error('Error using RTM:', error);
        showError('Failed to use RTM. Please try again.');
      }
    });
    
    // Final bid button (for original bidder to counter RTM)
    finalBidBtn.addEventListener('click', async () => {
      const increment = 0.25; // Standard increment for final bid
      
      // Get current RTM bid amount
      const bidsSnap = await get(ref(db, `auctionRooms/${roomCode}/bids`));
      let rtmBidAmount = 0;
      
      if (bidsSnap.exists()) {
        const bids = bidsSnap.val();
        Object.values(bids).forEach(bid => {
          if (bid.isRTM && bid.amount > rtmBidAmount) {
            rtmBidAmount = bid.amount;
          }
        });
      }
      
      const newBidAmount = rtmBidAmount + increment;
      
      // Get team budget
      const teamSnap = await get(ref(db, `auctionRooms/${roomCode}/teams/${currentTeam}`));
      if (!teamSnap.exists()) {
        showError('Team data not found');
        return;
      }
      
      const teamData = teamSnap.val();
      if (newBidAmount > teamData.budget) {
        showError('Not enough budget for this bid');
        return;
      }
      
      // Place final bid
      try {
        await set(ref(db, `auctionRooms/${roomCode}/bids/${currentTeam}`), {
          amount: newBidAmount,
          isRTM: false,
          isFinalBid: true,
          timestamp: Date.now()
        });
        
        // Reset timer
        if (isAdmin) {
          timeLeft = 30;
          set(ref(db, `auctionRooms/${roomCode}/timer`), timeLeft);
        }
      } catch (error) {
        console.error('Error placing final bid:', error);
        showError('Failed to place final bid. Please try again.');
      }
    });
    
    // Auto sell button (admin only)
    autoSellBtn.addEventListener('click', async () => {
      if (!isAdmin) return;
      
      try {
        // Get current player and bids
        const [playerSnap, bidsSnap] = await Promise.all([
          get(ref(db, `auctionRooms/${roomCode}/currentPlayer`)),
          get(ref(db, `auctionRooms/${roomCode}/bids`))
        ]);
        
        if (!playerSnap.exists()) {
          showError('No player currently being auctioned');
          return;
        }
        
        const player = playerSnap.val();
        let highestBid = 0;
        let highestBidder = '';
        let isRTM = false;
        
        if (bidsSnap.exists()) {
          const bids = bidsSnap.val();
          Object.entries(bids).forEach(([team, bid]) => {
            if (bid.amount > highestBid) {
              highestBid = bid.amount;
              highestBidder = team;
              isRTM = bid.isRTM;
            }
          });
        }
        
        if (highestBid <= 0) {
          // Mark as unsold
          await update(ref(db, `auctionRooms/${roomCode}/unsoldPlayers/${player.id}`), player);
          showSuccess(`${player.name} went unsold`);
        } else {
          // Add player to team
          await update(ref(db, `auctionRooms/${roomCode}/teams/${highestBidder}/players`), [
            ...(teamSnap.val().players || []),
            {
              name: player.name,
              role: player.role,
              price: highestBid.toFixed(2)
            }
          ]);
          
          // Deduct from budget
          await update(ref(db, `auctionRooms/${roomCode}/teams/${highestBidder}`), {
            budget: teamSnap.val().budget - highestBid
          });
          
          // Deduct RTM card if used
          if (isRTM) {
            await update(ref(db, `auctionRooms/${roomCode}/teams/${currentTeam}`), {
              rtmCards: teamSnap.val().rtmCards - 1
            });
          }
          
          showSuccess(`Sold ${player.name} to ${highestBidder} for ‚Çπ${highestBid.toFixed(2)} Cr`);
        }
        
        // Move to next player
        await nextPlayer();
      } catch (error) {
        console.error('Error auto selling:', error);
        showError('Failed to auto sell. Please try again.');
      }
    });
    
    // Next player button (admin only)
    nextPlayerBtn.addEventListener('click', async () => {
      if (!isAdmin) return;
      await nextPlayer();
    });
    
    // Move to next player in queue
    async function nextPlayer() {
      try {
        // Clear current bids
        await set(ref(db, `auctionRooms/${roomCode}/bids`), {});
        
        // Get queue
        const queueSnap = await get(ref(db, `auctionRooms/${roomCode}/queue`));
        if (!queueSnap.exists() || Object.keys(queueSnap.val()).length === 0) {
          showError('No players in queue');
          return;
        }
        
        const queue = queueSnap.val();
        const currentPlayerSnap = await get(ref(db, `auctionRooms/${roomCode}/currentPlayer`));
        
        let nextPlayerId = null;
        
        if (currentPlayerSnap.exists()) {
          // Find next player in queue after current one
          const currentPlayerId = currentPlayerSnap.val().id;
          const queueIds = Object.keys(queue);
          const currentIndex = queueIds.indexOf(currentPlayerId);
          
          if (currentIndex >= 0 && currentIndex < queueIds.length - 1) {
            nextPlayerId = queueIds[currentIndex + 1];
          }
        } else {
          // First player in queue
          nextPlayerId = Object.keys(queue)[0];
        }
        
        if (nextPlayerId) {
          // Set next player
          await update(ref(db, `auctionRooms/${roomCode}`), {
            currentPlayer: {
              id: nextPlayerId,
              ...queue[nextPlayerId]
            }
          });
          
          // Reset timer
          timeLeft = 30;
          set(ref(db, `auctionRooms/${roomCode}/timer`), timeLeft);
        } else {
          // End of queue
          await update(ref(db, `auctionRooms/${roomCode}`), {
            currentPlayer: null,
            status: 'complete'
          });
          
          showSuccess('Auction completed!');
        }
      } catch (error) {
        console.error('Error moving to next player:', error);
        showError('Failed to move to next player');
      }
    }
    
    // Sold button (admin only)
    soldBtn.addEventListener('click', async () => {
      if (!isAdmin) return;
      autoSellBtn.click();
    });
    
    // Unsold button (admin only)
    unsoldBtn.addEventListener('click', async () => {
      if (!isAdmin) return;
      
      try {
        const playerSnap = await get(ref(db, `auctionRooms/${roomCode}/currentPlayer`));
        if (!playerSnap.exists()) {
          showError('No player currently being auctioned');
          return;
        }
        
        const player = playerSnap.val();
        await update(ref(db, `auctionRooms/${roomCode}/unsoldPlayers/${player.id}`), player);
        
        showSuccess(`${player.name} marked as unsold`);
        await nextPlayer();
      } catch (error) {
        console.error('Error marking unsold:', error);
        showError('Failed to mark as unsold');
      }
    });
    
    // Back button
    backBtn.addEventListener('click', () => {
      window.location.href = 'index.html';
    });
    
    // Helper functions
    function showError(message) {
      errorMessage.textContent = message;
      successMessage.textContent = '';
    }
    
    function showSuccess(message) {
      successMessage.textContent = message;
      errorMessage.textContent = '';
    }
    
    // Initialize
    loadingSpinner.style.display = 'none';
  </script>
</body>
</html>