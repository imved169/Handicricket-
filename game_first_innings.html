   <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>HandiCricket - First Innings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    body { 
      background: #061e3e;
      color: white; 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      text-align: center; 
      padding: 8px;
      margin: 0;
      overflow-x: hidden;
      position: relative;
    }
    
    h1 { 
      margin: 8px 0 12px;
      color: #ffeb3b;
      text-shadow: 0 0 5px rgba(255, 235, 59, 0.5);
      font-size: 1.5rem;
    }
    
    .container {
      max-width: 100%;
      width: 100%;
      margin: 0 auto;
      background: rgba(0, 0, 0, 0.4);
      border-radius: 10px;
      padding: 8px;
      box-sizing: border-box;
      backdrop-filter: blur(5px);
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    
    /* Enhanced Scoreboard */
    .scorebox-main {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px;
      background: rgba(13, 42, 82, 0.8);
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }

    .team-score {
      display: flex;
      flex-direction: column;
    }

    .score-large {
      font-size: 1.8rem;
      font-weight: bold;
      color: #ffeb3b;
    }

    .score-details {
      text-align: right;
      font-size: 0.85rem;
    }

    /* Live score ticker */
    .live-ticker {
      background: linear-gradient(90deg, #1e88e5, #0d47a1);
      color: white;
      padding: 6px;
      border-radius: 4px;
      margin: 6px 0;
      font-size: 0.8rem;
      white-space: nowrap;
      overflow: hidden;
      position: relative;
    }
    
    .ticker-content {
      display: inline-block;
      padding-left: 100%;
      animation: ticker 20s linear infinite;
    }
    
    @keyframes ticker {
      0% { transform: translateX(0); }
      100% { transform: translateX(-100%); }
    }
    
    .ticker-item {
      display: inline-block;
      margin-right: 30px;
    }
    
    .ticker-item span {
      margin: 0 5px;
      color: #ffeb3b;
      font-weight: bold;
    }

    /* Match Info Bar */
    .match-info-bar {
      display: flex;
      justify-content: center;
      align-items: center;
      background: rgba(13, 42, 82, 0.5);
      padding: 6px 8px;
      border-radius: 6px;
      margin: 4px 0 8px 0;
      font-size: 0.75rem;
      gap: 6px;
      flex-wrap: wrap;
    }

    .match-info-item {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 45%;
    }

    .divider {
      color: #666;
      flex-shrink: 0;
    }

    /* Over Progress */
    .over-progress {
      background: rgba(13, 42, 82, 0.5);
      padding: 6px;
      border-radius: 6px;
      margin: 6px 0;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .over-title {
      font-size: 0.75rem;
      color: #aaa;
      margin-bottom: 4px;
    }

    .balls-container {
      display: flex;
      gap: 4px;
    }

    .ball {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: bold;
      transition: transform 0.2s;
    }

    .ball.dot {
      background: #333;
      color: white;
    }

    .ball.run {
      background: #4CAF50;
      color: white;
    }

    .ball.wicket {
      background: #F44336;
      color: white;
    }

    .ball.wide {
      background: #FF9800;
      color: white;
    }

    .ball.noball {
      background: #9C27B0;
      color: white;
    }

    .ball.empty {
      background: rgba(255,255,255,0.1);
    }

    .over-number {
      text-align: right;
      font-size: 0.75rem;
      margin-top: 4px;
      color: #aaa;
    }

    /* Timeline Styles - Updated */
    .timeline-container {
      background: rgba(13, 42, 82, 0.7);
      border-radius: 8px;
      margin: 8px 0;
      padding: 6px;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .timeline-container h4 {
      margin: 0 0 6px 0;
      font-size: 0.85rem;
    }

    .timeline {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 6px;
      padding-bottom: 4px;
    }

    .timeline-item {
      padding: 4px;
      border-radius: 4px;
      background: rgba(30, 136, 229, 0.2);
      font-size: 0.7rem;
      text-align: center;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .timeline-item.wicket {
      background: rgba(244, 67, 54, 0.2);
      border-left: 2px solid #F44336;
    }

    .timeline-item.boundary {
      background: rgba(255, 193, 7, 0.2);
      border-left: 2px solid #FFC107;
    }

    .timeline-item.milestone {
      background: rgba(76, 175, 80, 0.2);
      border-left: 2px solid #4CAF50;
    }

    .timeline-over {
      font-weight: bold;
      margin-bottom: 2px;
      color: #ffeb3b;
    }

    .timeline-event {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Player Comparison Styles - Enhanced */
    .comparison-container {
      background: rgba(13, 42, 82, 0.7);
      border-radius: 8px;
      margin: 8px 0;
      padding: 6px;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .comparison-container h4 {
      margin: 0 0 6px 0;
      font-size: 0.85rem;
    }

    .comparison-box {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .player-comparison {
      flex: 1;
      padding: 6px;
      border-radius: 6px;
      text-align: center;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .batter-comparison {
      background: rgba(76, 175, 80, 0.1);
      border-left: 3px solid #4CAF50;
    }

    .bowler-comparison {
      background: rgba(244, 67, 54, 0.1);
      border-left: 3px solid #F44336;
    }

    .comparison-header {
      font-size: 0.65rem;
      text-transform: uppercase;
      color: #aaa;
      margin-bottom: 4px;
    }

    .comparison-name {
      font-weight: bold;
      margin: 4px 0;
      font-size: 0.85rem;
    }
    
    .comparison-name.highlight {
      animation: highlightPlayer 2s infinite;
    }
    
    @keyframes highlightPlayer {
      0% { text-shadow: 0 0 5px rgba(255,255,255,0.5); }
      50% { text-shadow: 0 0 15px gold; }
      100% { text-shadow: 0 0 5px rgba(255,255,255,0.5); }
    }

    .comparison-stats {
      font-size: 0.75rem;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
    }

    .comparison-stats div {
      flex: 1;
      min-width: 50%;
      margin: 2px 0;
    }

    .vs-circle {
      width: 30px;
      height: 30px;
      background: #1e88e5;
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 0.65rem;
      border: 2px solid white;
    }

    /* Animations */
    @keyframes scoreIncrease {
      0% { transform: scale(1); color: white; }
      50% { transform: scale(1.3); color: #4CAF50; }
      100% { transform: scale(1); color: white; }
    }

    @keyframes wicketFlash {
      0% { background-color: rgba(244, 67, 54, 0); }
      50% { background-color: rgba(244, 67, 54, 0.3); }
      100% { background-color: rgba(244, 67, 54, 0); }
    }

    @keyframes boundary {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); color: #FFC107; }
      100% { transform: scale(1); }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes ballTrail {
      0% { transform: translateX(0) translateY(0); opacity: 1; }
      100% { transform: translateX(100px) translateY(-50px); opacity: 0; }
    }
    
    @keyframes stumpFall {
      0% { transform: rotate(0); }
      100% { transform: rotate(-45deg); }
    }
    
    @keyframes screenShake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      50% { transform: translateX(5px); }
      75% { transform: translateX(-5px); }
    }
    
    @keyframes ripple {
      0% { transform: scale(0.5); opacity: 1; }
      100% { transform: scale(3); opacity: 0; }
    }

    .score-change {
      animation: scoreIncrease 0.8s ease-in-out;
    }

    .wicket-flash {
      animation: wicketFlash 1.5s ease-in-out;
    }

    .boundary-flash {
      animation: boundary 1s ease-in-out;
    }
    
    .screen-shake {
      animation: screenShake 0.5s ease-in-out;
    }

    /* Card Buttons */
    .card-btns { 
      margin: 10px auto;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 6px;
      position: relative;
    }
    
    .card-btns button { 
      width: 50px;
      height: 50px;
      font-size: 18px;
      border-radius: 8px;
      border: none;
      background: linear-gradient(145deg, #1e88e5, #1565c0);
      color: white;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
    }
    
    .card-btns button::after {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: rgba(255,255,255,0.1);
      transform: rotate(45deg);
      transition: all 0.3s;
      opacity: 0;
    }
    
    .card-btns button:hover::after {
      opacity: 1;
      top: -30%;
      left: -30%;
    }
    
    .card-btns button:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 8px rgba(0, 0, 0, 0.3);
    }
    
    .card-btns button:active {
      transform: translateY(1px);
    }
    
    .card-btns button:disabled { 
      background: #607d8b;
      color: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .card-btns button.selected {
      background: #4caf50;
      border: 2px solid #ffeb3b;
      transform: scale(1.05);
    }
    
    /* Status Indicators */
    #statusIndicators {
      margin: 6px 0;
      display: flex;
      justify-content: center;
      gap: 6px;
      flex-wrap: wrap;
    }
    
    .free-hit-indicator,
    .powerplay-indicator,
    .dead-over {
      padding: 3px 6px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
      margin: 0 2px;
      display: inline-block;
    }
    
    .free-hit-indicator {
      background: #4CAF50;
      color: white;
      animation: pulse 1.5s infinite;
    }
    
    .powerplay-indicator {
      background: #ffeb3b;
      color: #000;
      animation: pulse 2s infinite;
    }
    
    .dead-over {
      background: #f44336;
      color: white;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    /* Result Display */
    #result {
      font-size: 15px;
      margin: 8px 0;
      padding: 6px;
      min-height: 45px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.5);
      border-radius: 6px;
      border-left: 3px solid #1e88e5;
    }
    
    #result.error {
      color: #ff4444;
      background: rgba(255, 0, 0, 0.1);
      padding: 6px;
      border-radius: 4px;
      border-left: 3px solid #ff4444;
    }
    
    /* Connection Status */
    #connectionStatus {
      padding: 6px;
      border-radius: 6px;
      text-align: center;
      margin: 8px auto;
      max-width: 250px;
      font-weight: bold;
      font-size: 13px;
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .online { 
      background: #4CAF50;
      color: white;
    }
    
    .offline { 
      background: #F44336;
      color: white;
    }
    
    /* Selection Modal */
    .selection-modal { 
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 350px;
      background: linear-gradient(145deg, #123456, #0a1f3a);
      padding: 10px;
      border-radius: 12px;
      margin-bottom: 12px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.1);
      z-index: 100;
      display: none;
    }
    
    .selection-list { 
      max-height: 50vh;
      overflow-y: auto;
      margin: 6px 0;
      padding-right: 4px;
    }
    
    .player-item, .batter-item {
      padding: 6px;
      margin: 3px 0;
      background: rgba(30, 136, 229, 0.2);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      border-left: 3px solid transparent;
      font-size: 13px;
    }
    
    .player-item:hover, .batter-item:hover {
      background: rgba(30, 136, 229, 0.4);
      transform: translateX(5px);
    }
    
    .player-item.selected, .batter-item.selected {
      background: rgba(13, 71, 161, 0.6);
      border-left: 3px solid #ffeb3b;
    }
    
    /* Top Controls */
    #topControls {
      display: flex;
      justify-content: center;
      gap: 6px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    
    #topControls button {
      padding: 6px 10px;
      border: none;
      border-radius: 6px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    #saveBtn { 
      background: #FF9800;
      color: white;
    }
    
    #saveBtn:hover {
      background: #F57C00;
    }
    
    #exitBtn { 
      background: #f44336;
      color: white;
    }
    
    #exitBtn:hover {
      background: #d32f2f;
    }
    
    #resetPlaysBtn { 
      background: #9c27b0;
      color: white;
    }
    
    #resetPlaysBtn:hover {
      background: #7b1fa2;
    }
    
    /* Teams Modal */
    .teams-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 1000;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .teams-container {
      width: 90%;
      max-width: 320px;
      height: 65vh;
      display: flex;
      overflow: hidden;
      position: relative;
      scroll-snap-type: x mandatory;
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
    }

    .team-slide {
      min-width: 100%;
      height: 100%;
      padding: 8px;
      background: rgba(13, 42, 82, 0.9);
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      overflow-y: auto;
      scroll-snap-align: start;
      flex-shrink: 0;
      box-sizing: border-box;
    }

    .team-slide h3 {
      text-align: center;
      margin-bottom: 6px;
      color: #ffeb3b;
      border-bottom: 2px solid #1e88e5;
      padding-bottom: 3px;
      font-size: 0.95rem;
      position: sticky;
      top: 0;
      background: rgba(13, 42, 82, 0.9);
      z-index: 1;
    }

    .team-slide ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .team-slide li {
      padding: 6px 8px;
      margin: 3px 0;
      background: rgba(30, 136, 229, 0.2);
      border-radius: 6px;
      border-left: 2px solid #1e88e5;
      transition: all 0.3s;
      font-size: 13px;
      word-break: break-word;
      overflow-wrap: break-word;
    }

    .team-slide li:hover {
      background: rgba(30, 136, 229, 0.4);
      transform: translateX(5px);
    }

    .close-teams {
      position: absolute;
      top: 12px;
      right: 12px;
      background: #f44336;
      color: white;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      font-size: 16px;
      cursor: pointer;
      z-index: 1001;
      transition: all 0.2s;
    }
    
    .close-teams:hover {
      transform: scale(1.1);
    }

    .teams-nav {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-top: 12px;
    }

    .team-nav-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 5px;
      background: #1e88e5;
      color: white;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.2s;
    }
    
    .team-nav-btn:hover {
      background: #1565c0;
    }

    .team-nav-btn:disabled {
      background: #666;
      cursor: not-allowed;
    }

    .team-nav-indicator {
      display: flex;
      gap: 6px;
      margin-top: 8px;
    }

    .team-nav-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #555;
      cursor: pointer;
      transition: all 0.2s;
    }

    .team-nav-dot.active {
      background: #1e88e5;
      transform: scale(1.2);
    }

    .show-teams-btn {
      padding: 8px 16px;
      font-size: 13px;
      border: none;
      border-radius: 8px;
      background: linear-gradient(135deg, #9c27b0, #7b1fa2);
      color: white;
      cursor: pointer;
      margin: 12px auto;
      display: block;
      transition: all 0.3s;
    }

    .show-teams-btn:hover {
      background: linear-gradient(135deg, #7b1fa2, #6a1b9a);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    /* Team Names Display */
    .team-names-compact {
      margin-bottom: 8px;
      font-size: 13px;
      background: rgba(13, 42, 82, 0.5);
      padding: 6px;
      border-radius: 6px;
      text-align: center;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .team-name-line {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
      gap: 4px;
    }

    .team-label {
      color: #aaa;
      font-size: 11px;
    }

    .team-divider {
      color: #666;
      margin: 0 4px;
    }

    /* Over Summary */
    .over-summary-container {
      margin: 8px 0;
      padding: 6px;
      background: rgba(13, 42, 82, 0.5);
      border-radius: 6px;
      max-height: 100px;
      overflow-y: auto;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .over-summary-item {
      padding: 3px;
      margin: 3px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      font-size: 12px;
    }

    /* Spectator Mode */
    .spectator-mode {
      background: #9c27b0;
      padding: 3px 6px;
      border-radius: 15px;
      margin-bottom: 6px;
      display: inline-block;
      font-size: 11px;
      animation: pulse 2s infinite;
    }

    /* Milestone Notifications */
    .milestone-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 15px;
      z-index: 1001;
      animation: fadeInOut 3s forwards;
      box-shadow: 0 4px 15px rgba(0,0,0,0.5);
      border: 1px solid rgba(255,255,255,0.2);
      max-width: 250px;
    }
    
    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateY(5px); }
      10% { opacity: 1; transform: translateY(0); }
      90% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(5px); }
    }
    
    .milestone-notification.batting {
      border-left: 4px solid #4CAF50;
    }
    
    .milestone-notification.error {
      border-left: 4px solid #F44336;
    }
    
    .milestone-notification.info {
      border-left: 4px solid #FFC107;
    }
    
    .milestone-notification.winner {
      border-left: 4px solid #9C27B0;
      font-size: 18px;
      background: linear-gradient(135deg, rgba(0,0,0,0.9), rgba(70,0,100,0.9));
    }
    
    /* Confetti */
    .confetti {
      position: fixed;
      width: 8px;
      height: 8px;
      background-color: #f00;
      animation: confetti-fall 5s linear forwards;
      z-index: 1000;
    }
    
    @keyframes confetti-fall {
      0% {
        transform: translateY(-100vh) rotate(0deg);
        opacity: 1;
      }
      100% {
        transform: translateY(100vh) rotate(360deg);
        opacity: 0;
      }
    }
    
    /* Loading Spinner */
    .loading-spinner {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 3px solid #1e88e5;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 12px auto;
      display: none;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Reset Notification */
    .reset-notification {
      position: fixed;
      top: 20%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.9);
      color: white;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 13px;
      z-index: 1001;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      display: flex;
      flex-direction: column;
      gap: 6px;
      width: 80%;
      max-width: 280px;
      border: 1px solid rgba(255,255,255,0.2);
    }
    
    .reset-notification-buttons {
      display: flex;
      justify-content: center;
      gap: 6px;
    }
    
    .reset-notification button {
      padding: 4px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      font-size: 11px;
      transition: all 0.2s;
    }
    
    .reset-accept {
      background: #4CAF50;
      color: white;
    }
    
    .reset-accept:hover {
      background: #388E3C;
    }
    
    .reset-decline {
      background: #f44336;
      color: white;
    }
    
    .reset-decline:hover {
      background: #d32f2f;
    }
    
    /* Innings Summary Popup - Updated to match image */
    .summary-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(145deg, #123456, #0a1f3a);
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.1);
      z-index: 1001;
      text-align: center;
      color: white;
      max-width: 320px;
      width: 90%;
      display: none;
    }
    
    .summary-popup h3 {
      margin-top: 0;
      color: #ffeb3b;
      font-size: 1.2rem;
      border-bottom: 2px solid #1e88e5;
      padding-bottom: 6px;
      margin-bottom: 12px;
    }
    
    .summary-content {
      text-align: left;
      margin-bottom: 12px;
    }
    
    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
      font-size: 13px;
    }
    
    .summary-label {
      color: #aaa;
    }
    
    .summary-value {
      font-weight: bold;
    }
    
    .summary-highlight {
      background: rgba(255, 235, 59, 0.2);
      padding: 4px;
      border-radius: 4px;
      margin: 8px 0;
      font-weight: bold;
      text-align: center;
      border-left: 3px solid #ffeb3b;
    }
    
    .summary-countdown {
      font-size: 22px;
      font-weight: bold;
      margin: 8px 0;
      color: #4CAF50;
    }
    
    .summary-popup button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 15px;
      cursor: pointer;
      margin-top: 8px;
      transition: all 0.3s;
      width: 100%;
    }
    
    .summary-popup button:hover {
      background: #388E3C;
      transform: scale(1.05);
    }
    
    /* Match graphics */
    .match-graphics {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 999;
    }
    
    .ball-trail {
      position: absolute;
      width: 10px;
      height: 10px;
      background: white;
      border-radius: 50%;
      z-index: 1000;
      animation: ballTrail 0.5s forwards;
    }
    
    .stump {
      position: absolute;
      width: 5px;
      height: 30px;
      background: #8B4513;
      bottom: 50px;
      transform-origin: bottom center;
    }
    
    .stump.left {
      left: calc(50% - 15px);
    }
    
    .stump.middle {
      left: 50%;
      transform: translateX(-50%);
    }
    
    .stump.right {
      left: calc(50% + 10px);
    }
    
    .stump.bail {
      width: 20px;
      height: 5px;
      background: #D2B48C;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
    }
    
    .ripple-effect {
      position: absolute;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: rgba(255,255,255,0.5);
      animation: ripple 1s forwards;
      z-index: 999;
    }
    
    /* Mini scorecard */
    .mini-scorecard {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: rgba(0,0,0,0.7);
      padding: 8px;
      border-radius: 6px;
      font-size: 12px;
      z-index: 100;
      border: 1px solid rgba(255,255,255,0.2);
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    
    .mini-scorecard .score {
      font-weight: bold;
      color: #ffeb3b;
    }
    
    /* Match awards */
    .awards-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
      justify-content: center;
    }
    
    .award-badge {
      background: rgba(255,215,0,0.2);
      border: 1px solid gold;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
    }
    
    /* Stats charts */
    .stats-chart {
      width: 100%;
      height: 100px;
      margin: 10px 0;
      background: rgba(255,255,255,0.1);
      border-radius: 4px;
      position: relative;
      overflow: hidden;
    }
    
    .chart-bar {
      position: absolute;
      bottom: 0;
      background: #1e88e5;
      width: 20px;
      transition: height 0.5s;
    }
    
    /* Umpire signals */
    .umpire-signal {
      position: fixed;
      bottom: 20%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 10px;
      border-radius: 50%;
      font-size: 24px;
      z-index: 1001;
      animation: fadeInOut 2s forwards;
    }
    
    /* Bowler Milestone Indicators */
    .bowler-milestone {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.9);
      color: white;
      padding: 15px 20px;
      border-radius: 10px;
      font-size: 18px;
      z-index: 1001;
      box-shadow: 0 5px 15px rgba(0,0,0,0.5);
      text-align: center;
      animation: fadeInOut 3s forwards;
      border: 2px solid #1e88e5;
    }
    
    /* Responsive Styles */
    @media (max-width: 768px) {
      .card-btns button {
        width: 45px;
        height: 45px;
        font-size: 16px;
      }
      
      .selection-modal {
        width: 95%;
        max-height: 60vh;
      }
      
      .teams-container {
        width: 95%;
        max-width: 350px;
        height: 55%;
      }
      
      .team-slide {
        min-width: 100%;
      }
    }
    
    @media (max-width: 480px) {
      body {
        padding: 6px;
      }
      
      .container {
        padding: 8px;
      }
      
      h1 {
        font-size: 1.3rem;
        margin: 6px 0 10px;
      }
      
      .card-btns button {
        width: 40px;
        height: 40px;
        font-size: 15px;
      }
      
      .selection-modal {
        padding: 8px;
      }
      
      .player-item, .batter-item {
        padding: 5px;
        font-size: 12px;
      }
      
      #topControls button {
        padding: 5px 8px;
        font-size: 10px;
      }
      
      .team-slide h3 {
        font-size: 0.9rem;
      }
      
      .team-slide li {
        font-size: 11px;
        padding: 5px 6px;
      }
      
      .team-names {
        flex-direction: column;
        gap: 4px;
      }
      
      .teams-container {
        height: 70vh;
        max-width: 300px;
      }

      .score-large {
        font-size: 1.5rem;
      }
      
      .match-info-bar {
        font-size: 0.7rem;
      }
    }
   
    /* Enhanced Summary Popup */
    .summary-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(145deg, #123456, #0a1f3a);
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.1);
      z-index: 1001;
      text-align: center;
      color: white;
      max-width: 320px;
      width: 90%;
      display: none;
    }
    
    .summary-popup h3 {
      margin-top: 0;
      color: #ffeb3b;
      font-size: 1.2rem;
      border-bottom: 2px solid #1e88e5;
      padding-bottom: 6px;
      margin-bottom: 12px;
    }
    
    .summary-slider {
      width: 100%;
      height: 300px;
      overflow: hidden;
      position: relative;
      scroll-snap-type: x mandatory;
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
    }
    
    .summary-slide {
      width: 100%;
      height: 100%;
      padding: 8px;
      scroll-snap-align: start;
      flex-shrink: 0;
      box-sizing: border-box;
      overflow-y: auto;
    }
    
    .summary-slide h4 {
      margin: 8px 0;
      color: #ffeb3b;
      font-size: 1rem;
    }
    
    .summary-stats {
      text-align: left;
      margin-bottom: 12px;
      font-size: 13px;
    }
    
    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
    }
    
    .summary-label {
      color: #aaa;
    }
    
    .summary-value {
      font-weight: bold;
    }
    
    .summary-highlight {
      background: rgba(255, 235, 59, 0.2);
      padding: 4px;
      border-radius: 4px;
      margin: 8px 0;
      font-weight: bold;
      text-align: center;
      border-left: 3px solid #ffeb3b;
    }
    
    .stats-table {
      width: 100%;
      border-collapse: collapse;
      margin: 8px 0;
      font-size: 12px;
    }
    
    .stats-table th {
      background: rgba(30, 136, 229, 0.3);
      padding: 4px;
      text-align: left;
    }
    
    .stats-table td {
      padding: 4px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .stats-table tr:nth-child(even) {
      background: rgba(255,255,255,0.05);
    }
    
    .summary-nav {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-top: 12px;
    }
    
    .summary-nav-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 5px;
      background: #1e88e5;
      color: white;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.2s;
    }
    
    .summary-nav-btn:hover {
      background: #1565c0;
    }
    
    .summary-nav-btn:disabled {
      background: #666;
      cursor: not-allowed;
    }
    
    .summary-nav-indicator {
      display: flex;
      gap: 6px;
      margin-top: 8px;
      justify-content: center;
    }
    
    .summary-nav-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #555;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .summary-nav-dot.active {
      background: #1e88e5;
      transform: scale(1.2);
    }
    
    .award-badge {
      background: rgba(255,215,0,0.2);
      border: 1px solid gold;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      margin: 4px;
      display: inline-block;
    }
    
    .pom-display {
      margin: 10px 0;
      padding: 8px;
      background: rgba(76, 175, 80, 0.2);
      border-radius: 6px;
      border-left: 3px solid #4CAF50;
    }
    
    .pom-stats {
      font-size: 12px;
      margin-top: 4px;
    }
    
    /* Enhanced Timeline */
    .timeline-container {
      position: relative;
    }
    
    .timeline-scroll {
      overflow-x: auto;
      white-space: nowrap;
      padding-bottom: 10px;
      scrollbar-width: thin;
      scrollbar-color: #1e88e5 #061e3e;
    }
    
    .timeline-scroll::-webkit-scrollbar {
      height: 6px;
    }
    
    .timeline-scroll::-webkit-scrollbar-track {
      background: #061e3e;
    }
    
    .timeline-scroll::-webkit-scrollbar-thumb {
      background-color: #1e88e5;
      border-radius: 6px;
    }
    
    .timeline {
      display: inline-flex;
      gap: 6px;
    }
</style>
</head>
<body>
  <div class="match-graphics" id="matchGraphics"></div>
  
  <div class="container">
    <div class="team-names-compact">
      <div class="team-name-line">
        <span class="team-label">Batting:</span>
        <span id="team1Name">Team A</span>
        <span class="team-divider">|</span>
        <span class="team-label">Bowling:</span>
        <span id="team2Name">Team B</span>
      </div>
    </div>
    
    <!-- Live score ticker -->
    <div class="live-ticker">
      <div class="ticker-content" id="tickerContent">
        <div class="ticker-item">Partnership: <span id="tickerPartnership">0</span> runs (<span id="tickerPartnershipBalls">0</span> balls)</div>
        <div class="ticker-item">Run Rate: <span id="tickerRunRate">0.00</span></div>
        <div class="ticker-item">Last 5 Overs: <span id="tickerLast5">0/0</span></div>
        <div class="ticker-item">Required Rate: <span id="tickerRequiredRate">0.00</span></div>
      </div>
    </div>
    
    <!-- Enhanced Scoreboard -->
    <div class="scorebox">
      <div class="scorebox-main">
        <div class="team-score">
          <span id="battingTeamName">Team A</span>
          <span class="score-large"><span id="runs">0</span>/<span id="wickets">0</span></span>
        </div>
        <div class="score-details">
          <div>Overs: <strong id="overs">0.0</strong></div>
          <div>Run Rate: <strong id="runRate">0.00</strong></div>
        </div>
        <div id="runsNeeded" style="font-size: 0.9rem; margin: 5px 0; color: #ffeb3b;"></div>
      </div>
    </div>
    
    <!-- Match Info Bar -->
    <div class="match-info-bar">
      <div class="match-format" id="formatDisplay"></div>
      <div class="match-status">
        <span id="inningsNumber">1st Innings</span>
        <span class="divider">|</span>
        <span id="roleText"></span>
      </div>
      <div class="match-time">
        <span id="currentTime">14:30</span>
        <span class="divider">|</span>
        <span id="matchDate">23 Jul 2023</span>
      </div>
    </div>
    
    <!-- Over Progress -->
    <div class="over-progress">
      <div class="over-title">Current Over</div>
      <div class="balls-container" id="ballsContainer">
        <!-- Balls will be added dynamically -->
      </div>
      <div class="over-number">Over <span id="currentOverNumber">1</span></div>
    </div>
    
    <!-- Match Timeline -->
    <div class="timeline-container">
      <h4>Match Timeline</h4>
      <div class="timeline" id="matchTimeline">
        <!-- Timeline items will be added here -->
      </div>
    </div>
    
    <!-- Enhanced Player Comparison -->
    <div class="comparison-container">
      <h4>Current Battle</h4>
      <div class="comparison-box">
        <div class="player-comparison batter-comparison">
          <div class="comparison-header">Batter</div>
          <div class="comparison-name" id="comparisonBatterName">-</div>
          <div class="comparison-stats">
            <div>Runs: <span id="comparisonBatterRuns">0</span></div>
            <div>Balls: <span id="comparisonBatterBalls">0</span></div>
            <div>SR: <span id="comparisonBatterSR">0.00</span></div>
            <div>4s/6s: <span id="comparisonBatterBoundaries">0/0</span></div>
          </div>
        </div>
        <div class="vs-circle">VS</div>
        <div class="player-comparison bowler-comparison">
          <div class="comparison-header">Bowler</div>
          <div class="comparison-name" id="comparisonBowlerName">-</div>
          <div class="comparison-stats">
            <div>Overs: <span id="comparisonBowlerOvers">0.0</span></div>
            <div>Wkts: <span id="comparisonBowlerWickets">0</span></div>
            <div>ER: <span id="comparisonBowlerER">0.00</span></div>
            <div>Runs: <span id="comparisonBowlerRuns">0</span></div>
          </div>
        </div>
      </div>
    </div>
    
    <div id="statusIndicators">
      <span id="powerplayIndicator" class="powerplay-indicator" style="display: none;">Powerplay</span>
      <span id="deadOverIndicator" class="dead-over" style="display: none;">Dead Over</span>
      <span id="freeHitIndicator" class="free-hit-indicator" style="display: none;">Free Hit</span>
    </div>
    
    <div id="result">Initializing game...</div>
    
    <div class="card-btns" id="cardButtons">
      <button class="btn" data-value="0">0</button>
      <button class="btn" data-value="1">1</button>
      <button class="btn" data-value="2">2</button>
      <button class="btn" data-value="3">3</button>
      <button class="btn" data-value="4">4</button>
      <button class="btn" data-value="5">5</button>
      <button class="btn" data-value="6">6</button>
    </div>

    <div class="over-summary-container">
      <h4>Over Summary</h4>
      <div id="overSummaryList"></div>
    </div>

    <button class="show-teams-btn" id="showTeamsBtn">Show Teams</button>

    <div id="topControls">
      <button id="saveBtn">💾 Save & Exit</button>
      <button id="exitBtn">🚪 Exit Without Saving</button>
      <button id="resetPlaysBtn">🔄 Reset Plays</button>
    </div>
    <div id="connectionStatus" class="online">
      Opponent: Online
    </div>
    
    <div id="loading-spinner" class="loading-spinner"></div>
  </div>
  
  <!-- Mini scorecard that stays visible when scrolling -->
  <div class="mini-scorecard" id="miniScorecard" style="display: none;">
    <span id="miniScore">0/0</span> (<span id="miniOvers">0.0</span>)
  </div>
  
  <div id="selectionModal" class="selection-modal">
    <h3 id="selectionTitle">Select Next Batter</h3>
    <div id="selectionList" class="selection-list"></div>
    <button id="confirmSelection">Confirm Selection</button>
  </div>

  <div id="teamsModal" class="teams-modal">
    <button class="close-teams" id="closeTeamsBtn">×</button>
    <div class="teams-container" id="teamsSlider">
      <div class="team-slide" id="team1Slide">
        <h3 id="modalTeam1Name">Team 1</h3>
        <ul id="modalTeam1Players"></ul>
      </div>
      <div class="team-slide" id="team2Slide">
        <h3 id="modalTeam2Name">Team 2</h3>
        <ul id="modalTeam2Players"></ul>
      </div>
    </div>
    <div class="teams-nav">
      <button class="team-nav-btn" id="prevTeamBtn" disabled>Previous</button>
      <button class="team-nav-btn" id="nextTeamBtn">Next</button>
    </div>
    <div class="team-nav-indicator">
      <div class="team-nav-dot active" data-index="0"></div>
      <div class="team-nav-dot" data-index="1"></div>
    </div>
  </div>

  
  <!-- Enhanced Innings Summary Popup with stats slides -->
  <div id="summaryPopup" class="summary-popup">
    <h3 id="summaryTitle">First Innings Summary</h3>
    
    <div class="summary-slider" id="summarySlider">
      <!-- Slide 1: Basic Summary -->
      <div class="summary-slide">
        <div class="summary-stats">
          <div class="summary-row">
            <span class="summary-label">Total Runs:</span>
            <span class="summary-value" id="summaryTotalRuns">0</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Wickets:</span>
            <span class="summary-value" id="summaryWickets">0</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Overs:</span>
            <span class="summary-value" id="summaryOvers">0.0</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Run Rate:</span>
            <span class="summary-value" id="summaryRunRate">0.00</span>
          </div>
          <div class="summary-highlight" id="summaryHighlight"></div>
          
          <!-- Target display for second innings -->
          <div class="summary-row" id="targetDisplay" style="display: none;">
            <span class="summary-label">Target:</span>
            <span class="summary-value" id="targetValue">0</span>
          </div>
          
          <div class="summary-row" id="runsNeededDisplay" style="display: none;">
            <span class="summary-label">Runs Needed:</span>
            <span class="summary-value" id="runsNeededValue">0</span>
          </div>
        </div>
      </div>
      
      <!-- Slide 2: Batting Stats -->
      <div class="summary-slide">
        <h4>Batting Stats</h4>
        <table class="stats-table" id="battersStatsTable">
          <thead>
            <tr>
              <th>Batter</th>
              <th>Runs</th>
              <th>Balls</th>
              <th>SR</th>
              <th>4s/6s</th>
            </tr>
          </thead>
          <tbody id="battersStatsBody"></tbody>
        </table>
      </div>
      
      <!-- Slide 3: Bowling Stats -->
      <div class="summary-slide">
        <h4>Bowling Stats</h4>
        <table class="stats-table" id="bowlersStatsTable">
          <thead>
            <tr>
              <th>Bowler</th>
              <th>Overs</th>
              <th>Wkts</th>
              <th>Runs</th>
              <th>ER</th>
            </tr>
          </thead>
          <tbody id="bowlersStatsBody"></tbody>
        </table>
      </div>
      
      <!-- Slide 4: Start Second Innings -->
      <div class="summary-slide">
        <div class="summary-highlight">Ready for Second Innings</div>
        <button id="startSecondInningsBtn" class="summary-nav-btn" style="margin-top: 20px; width: 100%;">🏏 Start Second Innings</button>
      </div>
    </div>
    
    <!-- Navigation -->
    <div class="summary-nav">
      <button class="summary-nav-btn" id="prevSummaryBtn" disabled>Previous</button>
      <button class="summary-nav-btn" id="nextSummaryBtn">Next</button>
    </div>
    <div class="summary-nav-indicator">
      <div class="summary-nav-dot active" data-index="0"></div>
      <div class="summary-nav-dot" data-index="1"></div>
      <div class="summary-nav-dot" data-index="2"></div>
      <div class="summary-nav-dot" data-index="3"></div>
    </div>
  </div>

  <!-- Match Result Popup (shown at end of match) -->
  <div id="resultPopup" class="summary-popup" style="display: none;">
    <h3 id="resultTitle">Match Result</h3>
    
    <div class="summary-slider" id="resultSlider">
      <!-- Slide 1: Match Result -->
      <div class="summary-slide">
        <div class="summary-highlight" id="resultHighlight"></div>
        <div class="summary-stats">
          <div class="summary-row">
            <span class="summary-label">First Innings:</span>
            <span class="summary-value" id="firstInningsScore">0/0 (0.0)</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Second Innings:</span>
            <span class="summary-value" id="secondInningsScore">0/0 (0.0)</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Result:</span>
            <span class="summary-value" id="matchResult"></span>
          </div>
        </div>
      </div>
      
      <!-- Slide 2: First Innings Stats -->
      <div class="summary-slide">
        <h4>First Innings Stats</h4>
        <div class="summary-stats">
          <h5>Batting</h5>
          <table class="stats-table" id="firstInningsBattersTable">
            <thead>
              <tr>
                <th>Batter</th>
                <th>Runs</th>
                <th>Balls</th>
                <th>SR</th>
              </tr>
            </thead>
            <tbody id="firstInningsBattersBody"></tbody>
          </table>
          
          <h5>Bowling</h5>
          <table class="stats-table" id="firstInningsBowlersTable">
            <thead>
              <tr>
                <th>Bowler</th>
                <th>Overs</th>
                <th>Wkts</th>
                <th>ER</th>
              </tr>
            </thead>
            <tbody id="firstInningsBowlersBody"></tbody>
          </table>
        </div>
      </div>
      
      <!-- Slide 3: Second Innings Stats -->
      <div class="summary-slide">
        <h4>Second Innings Stats</h4>
        <div class="summary-stats">
          <h5>Batting</h5>
          <table class="stats-table" id="secondInningsBattersTable">
            <thead>
              <tr>
                <th>Batter</th>
                <th>Runs</th>
                <th>Balls</th>
                <th>SR</th>
              </tr>
            </thead>
            <tbody id="secondInningsBattersBody"></tbody>
          </table>
          
          <h5>Bowling</h5>
          <table class="stats-table" id="secondInningsBowlersTable">
            <thead>
              <tr>
                <th>Bowler</th>
                <th>Overs</th>
                <th>Wkts</th>
                <th>ER</th>
              </tr>
            </thead>
            <tbody id="secondInningsBowlersBody"></tbody>
          </table>
        </div>
      </div>
      
      <!-- Slide 4: Awards -->
      <div class="summary-slide">
        <h4>Match Awards</h4>
        <div class="pom-display">
          <div>Player of the Match:</div>
          <div class="summary-value" id="pomName">-</div>
          <div class="pom-stats" id="pomStats"></div>
        </div>
        
        <div class="awards-container" id="awardsContainer">
          <!-- Awards will be added here -->
        </div>
        
        <button id="saveMatchBtn" class="summary-nav-btn" style="margin-top: 20px; width: 100%;">💾 Save Match Data</button>
      </div>
   </div>
    
    <!-- Navigation -->
    <div class="summary-nav">
      <button class="summary-nav-btn" id="prevResultBtn" disabled>Previous</button>
      <button class="summary-nav-btn" id="nextResultBtn">Next</button>
    </div>
    <div class="summary-nav-indicator">
      <div class="summary-nav-dot active" data-index="0"></div>
      <div class="summary-nav-dot" data-index="1"></div>
      <div class="summary-nav-dot" data-index="2"></div>
      <div class="summary-nav-dot" data-index="3"></div>
    </div>
  </div>
        

  
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, get, push } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCN6aZMwlsZe7JJaovU0WA3UQygWr4jYmA",
      authDomain: "handicricket-85a06.firebaseapp.com",
      projectId: "handicricket-85a06",
      storageBucket: "handicricket-85a06.appspot.com",
      messagingSenderId: "599182538558",
      appId: "1:599182538558:web:3e965753ab05f8f1e3de6f",
      measurementId: "G-HSV9H4LEJQ"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Get URL parameters
    const params = new URLSearchParams(window.location.search);
    const roomId = params.get('room');
    const playerRole = params.get('player');
    const isSpectator = playerRole === 'spectator';

    if (!roomId || (!isSpectator && !playerRole)) {
      alert('Invalid room or player');
      window.location.href = 'index.html';
    }

    // Firebase references
    const roomRef = ref(db, `rooms/${roomId}`);
    const matchRef = ref(db, `matches/${roomId}`);
    const playerRef = ref(db, `rooms/${roomId}/${playerRole}`);
    const teamsRef = ref(db, `rooms/${roomId}/teams`);
    const tossRef = ref(db, `rooms/${roomId}/toss`);
    const firstInningsRef = ref(db, `matches/${roomId}/firstInnings`);
    const secondInningsRef = ref(db, `matches/${roomId}/secondInnings`);
    const timeoutRef = ref(db, `matches/${roomId}/timeout`);
    const inningsBreakRef = ref(db, `matches/${roomId}/inningsBreak`);

    // Game state
    let gameState = {
      battingTeam: null,
      bowlingTeam: null,
      currentBatter: null,
      currentBowler: null,
      batterStats: {},
      bowlerStats: {},
      totalRuns: 0,
      totalWickets: 0,
      balls: 0,
      overs: 0,
      currentOver: [],
      innings: 1,
      powerplay: true,
      freeHit: false,
      selectedCard: null,
      batterCards: [],
      bowlerCards: [],
      consecutiveZeros: { batter: 0, bowler: 0 },
      matchFormat: null,
      maxOvers: null,
      powerplayOvers: null,
      players: {
        player1: [],
        player2: []
      },
      captains: {
        player1: null,
        player2: null
      },
      viceCaptains: {
        player1: null,
        player2: null
      },
      teamNames: {
        player1: null,
        player2: null
      },
      tossWinner: null,
      battingFirst: null,
      battingChoice: null,
      matchStarted: false,
      inningsCompleted: false,
      matchCompleted: false,
      winner: null,
      winningMargin: null,
      playerOfTheMatch: null,
      timeoutActive: false,
      inningsBreakActive: false,
      processingBall: false
    };

    // DOM elements
    const elements = {
      matchFormat: document.getElementById('matchFormat'),
      matchDate: document.getElementById('matchDate'),
      inningsInfo: document.getElementById('inningsInfo'),
      matchStatus: document.getElementById('matchStatus'),
      powerplayStatus: document.getElementById('powerplayStatus'),
      battingTeamName: document.getElementById('battingTeamName'),
      battingScore: document.getElementById('battingScore'),
      battingOvers: document.getElementById('battingOvers'),
      inningsStatus: document.getElementById('inningsStatus'),
      runRate: document.getElementById('runRate'),
      bowlingTeamName: document.getElementById('bowlingTeamName'),
      bowlingOvers: document.getElementById('bowlingOvers'),
      currentBatter: document.getElementById('currentBatter'),
      batterRuns: document.getElementById('batterRuns'),
      batterBalls: document.getElementById('batterBalls'),
      batterSR: document.getElementById('batterSR'),
      batterDots: document.getElementById('batterDots'),
      currentBowler: document.getElementById('currentBowler'),
      bowlerOvers: document.getElementById('bowlerOvers'),
      bowlerWickets: document.getElementById('bowlerWickets'),
      bowlerER: document.getElementById('bowlerER'),
      bowlerExtras: document.getElementById('bowlerExtras'),
      ballsContainer: document.getElementById('ballsContainer'),
      overInfo: document.getElementById('overInfo'),
      partnershipInfo: document.getElementById('partnershipInfo'),
      timelineEvents: document.getElementById('timelineEvents'),
      cardSelection: document.getElementById('cardSelection'),
      submitBtn: document.getElementById('submitBtn'),
      timeoutBtn: document.getElementById('timeoutBtn'),
      resetBtn: document.getElementById('resetBtn'),
      teamsBtn: document.getElementById('teamsBtn'),
      notification: document.getElementById('notification'),
      notificationTitle: document.getElementById('notificationTitle'),
      notificationDesc: document.getElementById('notificationDesc'),
      timeoutTimer: document.getElementById('timeoutTimer'),
      timeoutCountdown: document.getElementById('timeoutCountdown'),
      inningsBreak: document.getElementById('inningsBreak'),
      breakTimer: document.getElementById('breakTimer'),
      playerModal: document.getElementById('playerModal'),
      playerModalTitle: document.getElementById('playerModalTitle'),
      playerModalList: document.getElementById('playerModalList'),
      closePlayerModal: document.getElementById('closePlayerModal'),
      cancelPlayerSelect: document.getElementById('cancelPlayerSelect'),
      confirmPlayerSelect: document.getElementById('confirmPlayerSelect'),
      summaryModal: document.getElementById('summaryModal'),
      summaryStats: document.getElementById('summaryStats'),
      closeSummaryModal: document.getElementById('closeSummaryModal'),
      continueBtn: document.getElementById('continueBtn'),
      teamsModal: document.getElementById('teamsModal'),
      team1Title: document.getElementById('team1Title'),
      team1Players: document.getElementById('team1Players'),
      team2Title: document.getElementById('team2Title'),
      team2Players: document.getElementById('team2Players'),
      closeTeamsModal: document.getElementById('closeTeamsModal'),
      closeTeamsBtn: document.getElementById('closeTeamsBtn')
    };

    // Initialize the game
    async function initGame() {
      // Set current date
      const now = new Date();
      elements.matchDate.textContent = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();

      // Load room data
      const roomSnap = await get(roomRef);
      if (!roomSnap.exists()) {
        alert('Room not found');
        window.location.href = 'index.html';
        return;
      }

      const roomData = roomSnap.val();

      // Load teams data
      const teamsSnap = await get(teamsRef);
      if (teamsSnap.exists()) {
        const teamsData = teamsSnap.val();
        gameState.players.player1 = teamsData.player1?.players || [];
        gameState.players.player2 = teamsData.player2?.players || [];
        gameState.captains.player1 = teamsData.player1?.captain || null;
        gameState.captains.player2 = teamsData.player2?.captain || null;
        gameState.viceCaptains.player1 = teamsData.player1?.viceCaptain || null;
        gameState.viceCaptains.player2 = teamsData.player2?.viceCaptain || null;
        gameState.teamNames.player1 = teamsData.player1?.name || 'Team A';
        gameState.teamNames.player2 = teamsData.player2?.name || 'Team B';
      }

      // Load toss data
      const tossSnap = await get(tossRef);
      if (tossSnap.exists()) {
        const tossData = tossSnap.val();
        gameState.tossWinner = tossData.winner;
        gameState.battingFirst = tossData.battingFirst;
        gameState.battingChoice = tossData.battingChoice;
      }

      // Determine batting and bowling teams
      if (gameState.battingFirst === 'player1') {
        gameState.battingTeam = 'player1';
        gameState.bowlingTeam = 'player2';
      } else {
        gameState.battingTeam = 'player2';
        gameState.bowlingTeam = 'player1';
      }

      // Set match format
      gameState.matchFormat = roomData.player1?.format || '20';
      gameState.maxOvers = parseInt(gameState.matchFormat);
      gameState.powerplayOvers = calculatePowerplayOvers(gameState.matchFormat);

      // Update UI with format info
      const formatNames = {
        '5': 'T5 (5 Overs)',
        '10': 'T10 (10 Overs)',
        '20': 'T20 (20 Overs)',
        '50': 'ODI (50 Overs)'
      };
      elements.matchFormat.textContent = formatNames[gameState.matchFormat] || gameState.matchFormat;

      // Initialize match in Firebase if not already done
      const matchSnap = await get(matchRef);
      if (!matchSnap.exists()) {
        await set(matchRef, {
          team1Name: gameState.teamNames.player1,
          team2Name: gameState.teamNames.player2,
          format: gameState.matchFormat,
          tossWinner: gameState.tossWinner,
          battingFirst: gameState.battingFirst,
          battingChoice: gameState.battingChoice,
          matchStarted: true,
          firstInnings: {
            battingTeam: gameState.battingTeam,
            bowlingTeam: gameState.bowlingTeam,
            totalRuns: 0,
            totalWickets: 0,
            balls: 0,
            batterStats: {},
            bowlerStats: {},
            extras: {
              wides: 0,
              noballs: 0,
              byes: 0,
              legbyes: 0
            }
          }
        });
      }

      // Set player online status
      if (!isSpectator) {
        set(playerRef, {
          connected: true,
          lastActive: Date.now()
        });
      }

      // Update UI
      updateTeamNames();
      updatePowerplayStatus();

      // Start the game
      if (isSpectator) {
        setupSpectatorMode();
      } else {
        setupPlayerMode();
      }

      // Load existing match data
      loadMatchData();

      // Listen for timeout and innings break
      onValue(timeoutRef, (snap) => {
        if (snap.exists() && snap.val().active) {
          startTimeout(snap.val().duration);
        }
      });

      onValue(inningsBreakRef, (snap) => {
        if (snap.exists() && snap.val().active) {
          startInningsBreak(snap.val().duration);
        }
      });
    }

    function calculatePowerplayOvers(format) {
      switch (format) {
        case '5': return 2;
        case '10': return 3;
        case '20': return 6;
        case '50': return 10;
        default: return 6;
      }
    }

    function updateTeamNames() {
      elements.battingTeamName.textContent = gameState.battingTeam === 'player1' ? 
        gameState.teamNames.player1 : gameState.teamNames.player2;
      elements.bowlingTeamName.textContent = gameState.bowlingTeam === 'player1' ? 
        gameState.teamNames.player1 : gameState.teamNames.player2;
    }

    function updatePowerplayStatus() {
      const powerplayEndOver = gameState.powerplayOvers;
      if (gameState.overs < powerplayEndOver) {
        gameState.powerplay = true;
        elements.powerplayStatus.textContent = `Powerplay (ends ${powerplayEndOver} overs)`;
      } else {
        gameState.powerplay = false;
        elements.powerplayStatus.textContent = '';
      }
    }

    function setupSpectatorMode() {
      // Disable controls for spectators
      elements.cardSelection.querySelectorAll('.card-btn').forEach(btn => {
        btn.disabled = true;
      });
      elements.submitBtn.disabled = true;
      elements.resetBtn.disabled = true;
      elements.timeoutBtn.disabled = true;

      // Update status
      elements.matchStatus.textContent = 'Spectator Mode';
    }

    function setupPlayerMode() {
      // Set up event listeners
      setupEventListeners();

      // Check if we need to select players
      checkPlayerSelection();
    }

    function setupEventListeners() {
      // Card selection
      elements.cardSelection.querySelectorAll('.card-btn').forEach(btn => {
        btn.addEventListener('click', () => selectCard(parseInt(btn.dataset.value)));
      });

      // Submit button
      elements.submitBtn.addEventListener('click', submitCards);

      // Timeout button
      elements.timeoutBtn.addEventListener('click', startTimeoutRequest);

      // Reset button
      elements.resetBtn.addEventListener('click', resetSelection);

      // Teams button
      elements.teamsBtn.addEventListener('click', showTeams);

      // Modal buttons
      elements.closePlayerModal.addEventListener('click', () => elements.playerModal.style.display = 'none');
      elements.cancelPlayerSelect.addEventListener('click', () => elements.playerModal.style.display = 'none');
      elements.confirmPlayerSelect.addEventListener('click', confirmPlayerSelection);
      elements.closeSummaryModal.addEventListener('click', () => elements.summaryModal.style.display = 'none');
      elements.closeTeamsModal.addEventListener('click', () => elements.teamsModal.style.display = 'none');
      elements.closeTeamsBtn.addEventListener('click', () => elements.teamsModal.style.display = 'none');
      elements.continueBtn.addEventListener('click', continueToNextInnings);
    }

    function selectCard(value) {
      if (gameState.processingBall || gameState.timeoutActive || gameState.inningsBreakActive) return;
      
      // Clear previous selection
      elements.cardSelection.querySelectorAll('.card-btn').forEach(btn => {
        btn.classList.remove('selected');
      });

      // Set new selection
      gameState.selectedCard = value;
      const selectedBtn = elements.cardSelection.querySelector(`.card-btn[data-value="${value}"]`);
      selectedBtn.classList.add('selected');
    }

    async function submitCards() {
      if (gameState.processingBall || gameState.timeoutActive || gameState.inningsBreakActive) return;
      
      if (gameState.selectedCard === null) {
        showNotification('Error', 'Please select a card first');
        return;
      }

      // Disable controls while processing
      setProcessingState(true);

      // Add card to current player's array
      if (playerRole === gameState.battingTeam) {
        gameState.batterCards.push(gameState.selectedCard);
      } else {
        gameState.bowlerCards.push(gameState.selectedCard);
      }

      // If both players have submitted, process the ball
      if (gameState.batterCards.length > 0 && gameState.bowlerCards.length > 0) {
        await processBall();
      } else {
        // Wait for other player
        showNotification('Waiting', 'Waiting for opponent to submit their card');
        resetSelection();
        setProcessingState(false);
      }
    }

    function setProcessingState(processing) {
      gameState.processingBall = processing;
      document.getElementById('container').classList.toggle('disabled', processing);
    }

    function startTimeoutRequest() {
      if (gameState.timeoutActive || gameState.inningsBreakActive) return;
      
      // Set timeout in Firebase (60 seconds)
      set(timeoutRef, {
        active: true,
        duration: 60,
        timestamp: Date.now()
      });
    }

    function startTimeout(duration) {
      gameState.timeoutActive = true;
      elements.timeoutCountdown.textContent = duration;
      elements.timeoutTimer.style.display = 'block';
      
      showNotification('Timeout', 'Game paused for timeout');
      setProcessingState(true);

      // Start countdown
      let remaining = duration;
      const timer = setInterval(() => {
        remaining--;
        elements.timeoutCountdown.textContent = remaining;
        
        if (remaining <= 0) {
          clearInterval(timer);
          endTimeout();
        }
      }, 1000);
    }

    function endTimeout() {
      gameState.timeoutActive = false;
      elements.timeoutTimer.style.display = 'none';
      setProcessingState(false);
      update(timeoutRef, { active: false });
    }

    function startInningsBreak(duration = 90) {
      gameState.inningsBreakActive = true;
      elements.breakTimer.textContent = formatTime(duration);
      elements.inningsBreak.style.display = 'flex';
      setProcessingState(true);

      // Start countdown
      let remaining = duration;
      const timer = setInterval(() => {
        remaining--;
        elements.breakTimer.textContent = formatTime(remaining);
        
        if (remaining <= 0) {
          clearInterval(timer);
          endInningsBreak();
        }
      }, 1000);
    }

    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
    }

    function endInningsBreak() {
      gameState.inningsBreakActive = false;
      elements.inningsBreak.style.display = 'none';
      setProcessingState(false);
      update(inningsBreakRef, { active: false });
    }

    function resetSelection() {
      gameState.selectedCard = null;
      elements.cardSelection.querySelectorAll('.card-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
    }

    async function processBall() {
      const batterCard = gameState.batterCards[0];
      const bowlerCard = gameState.bowlerCards[0];
      
      // Clear the cards
      gameState.batterCards = [];
      gameState.bowlerCards = [];

      // Determine the outcome
      let runs = 0;
      let isWicket = false;
      let isWide = false;
      let isNoBall = false;
      let isFreeHit = gameState.freeHit;
      let commentary = '';

      // Reset free hit flag unless another no ball is bowled
      gameState.freeHit = false;

      // Both players selected 0 - no ball + free hit
      if (batterCard === 0 && bowlerCard === 0) {
        runs = 1;
        isNoBall = true;
        gameState.freeHit = true;
        commentary = 'No ball! Free hit coming up';
      }
      // Bowler selected 0 - batter's card is runs (unless multiple dots)
      else if (bowlerCard === 0) {
        // Check for 4th consecutive 0 from batter
        if (gameState.consecutiveZeros.batter >= 3) {
          runs = -5;
          commentary = 'Penalty! -5 runs for too many dot balls';
          gameState.consecutiveZeros.batter = 0;
        } else {
          runs = batterCard;
          commentary = `${runs} run${runs === 1 ? '' : 's'} scored`;
          if (batterCard === 0) {
            gameState.consecutiveZeros.batter++;
          } else {
            gameState.consecutiveZeros.batter = 0;
          }
        }
      }
      // Batter selected 0 - dot ball (unless multiple dots)
      else if (batterCard === 0) {
        // Check for 4th consecutive 0 from bowler
        if (gameState.consecutiveZeros.bowler >= 3) {
          runs = 1;
          isNoBall = true;
          gameState.freeHit = true;
          commentary = 'No ball! Free hit for too many dots';
          gameState.consecutiveZeros.bowler = 0;
        } else {
          runs = 0;
          commentary = 'Dot ball';
          gameState.consecutiveZeros.bowler++;
        }
      }
      // Both selected same number > 0 - wicket
      else if (batterCard === bowlerCard) {
        isWicket = true;
        commentary = 'Wicket!';
        gameState.consecutiveZeros.batter = 0;
        gameState.consecutiveZeros.bowler = 0;
      }
      // Different numbers > 0 - bowler's card is runs
      else {
        runs = bowlerCard;
        commentary = `${runs} run${runs === 1 ? '' : 's'} scored`;
        gameState.consecutiveZeros.batter = 0;
        gameState.consecutiveZeros.bowler = 0;
      }

      // Process the outcome
      if (isNoBall) {
        addBallToOver('nb', runs);
        updateScore(runs, false, true);
        addTimelineEvent('other', `No ball +${runs}`);
      } else if (isWide) {
        addBallToOver('wd', runs);
        updateScore(runs, false, false);
        addTimelineEvent('other', `Wide +${runs}`);
      } else if (isWicket) {
        addBallToOver('w', 0);
        processWicket();
        addTimelineEvent('wicket', 'Wicket!');
      } else {
        const ballType = runs === 0 ? 'dot' : 'run';
        addBallToOver(ballType, runs);
        updateScore(runs, true, false);
        
        if (runs === 4) {
          addTimelineEvent('boundary', 'Four runs!');
        } else if (runs === 6) {
          addTimelineEvent('boundary', 'Six runs!');
        } else if (runs > 0) {
          addTimelineEvent('other', `${runs} run${runs === 1 ? '' : 's'}`);
        } else {
          addTimelineEvent('other', 'Dot ball');
        }
      }

      // Show notification
      if (commentary) {
        showNotification(isWicket ? 'Wicket!' : runs > 0 ? 'Runs scored' : 'Dot ball', commentary);
      }

      // Reset selection for next ball
      resetSelection();

      // Save match state
      await saveMatchState();

      // Re-enable controls
      setProcessingState(false);
    }

    function addBallToOver(type, runs) {
      // Don't count wides/noballs as balls except for the extra runs
      if (type === 'wd' || type === 'nb') {
        gameState.totalRuns += runs;
      } else {
        gameState.balls++;
        gameState.currentOver.push({ type, runs });
        updateOverProgress();
      }
    }

    function updateOverProgress() {
      elements.ballsContainer.innerHTML = '';
      
      gameState.currentOver.forEach((ball, index) => {
        const ballEl = document.createElement('div');
        ballEl.className = `ball ${ball.type}`;
        
        if (ball.type === 'run') {
          ballEl.textContent = ball.runs;
        } else if (ball.type === 'w') {
          ballEl.textContent = 'W';
        } else if (ball.type === 'wd') {
          ballEl.textContent = 'Wd';
        } else if (ball.type === 'nb') {
          ballEl.textContent = 'Nb';
        } else {
          ballEl.textContent = '•';
        }
        
        elements.ballsContainer.appendChild(ballEl);
      });

      // Update over info
      const overNumber = Math.floor(gameState.balls / 6);
      const ballNumber = gameState.balls % 6;
      elements.overInfo.textContent = `Over ${overNumber}.${ballNumber}`;

      // Update partnership info
      updatePartnershipInfo();

      // Check if over is complete
      if (ballNumber === 0 && gameState.balls > 0) {
        gameState.overs = overNumber;
        gameState.currentOver = [];
        updatePowerplayStatus();
        
        // Change bowler after over
        setTimeout(() => {
          showBowlerSelection();
        }, 1000);
      }
    }

    function updatePartnershipInfo() {
      // Calculate current partnership
      let partnershipRuns = 0;
      let partnershipBalls = 0;
      let lastWicketBall = 0;
      
      // Find the last wicket
      const timelineEvents = elements.timelineEvents.querySelectorAll('.timeline-event.wicket');
      if (timelineEvents.length > 0) {
        const lastWicketText = timelineEvents[0].textContent;
        const match = lastWicketText.match(/Over (\d+)\.(\d+)/);
        if (match) {
          lastWicketBall = parseInt(match[1]) * 6 + parseInt(match[2]);
        }
      }
      
      // Count runs and balls since last wicket
      for (let i = lastWicketBall; i < gameState.balls; i++) {
        const overIndex = Math.floor(i / 6);
        const ballIndex = i % 6;
        // This is simplified - in a real implementation you'd need to track all balls
        partnershipBalls++;
      }
      
      // This is simplified - in a real implementation you'd track partnership runs properly
      partnershipRuns = gameState.totalRuns - (gameState.firstInnings?.totalRuns || 0);
      
      elements.partnershipInfo.textContent = `Partnership: ${partnershipRuns} (${partnershipBalls} balls)`;
    }

    function updateScore(runs, isLegalBall, isExtra) {
      if (!isLegalBall) {
        // Extras don't count towards batter's score
        gameState.totalRuns += runs;
      } else {
        // Update batter stats
        if (!gameState.batterStats[gameState.currentBatter]) {
          gameState.batterStats[gameState.currentBatter] = {
            runs: 0,
            balls: 0,
            fours: 0,
            sixes: 0,
            dots: 0,
            dismissal: null
          };
        }
        
        const batter = gameState.batterStats[gameState.currentBatter];
        batter.runs += runs;
        batter.balls++;
        
        if (runs === 0) batter.dots++;
        if (runs === 4) batter.fours++;
        if (runs === 6) batter.sixes++;
        
        // Update bowler stats (only for legal balls)
        if (!gameState.bowlerStats[gameState.currentBowler]) {
          gameState.bowlerStats[gameState.currentBowler] = {
            runs: 0,
            balls: 0,
            wickets: 0,
            maidens: 0,
            noballs: 0,
            wides: 0
          };
        }
        
        const bowler = gameState.bowlerStats[gameState.currentBowler];
        bowler.runs += runs;
        if (isLegalBall) bowler.balls++;
        
        // Update total runs
        gameState.totalRuns += runs;
      }
      
      // Update UI
      updateScoreboard();
      updatePlayerStats();
    }

    function processWicket() {
      gameState.totalWickets++;
      
      // Update bowler stats
      if (!gameState.bowlerStats[gameState.currentBowler]) {
        gameState.bowlerStats[gameState.currentBowler] = {
          runs: 0,
          balls: 0,
          wickets: 0,
          maidens: 0,
          noballs: 0,
          wides: 0
        };
      }
      
      gameState.bowlerStats[gameState.currentBowler].wickets++;
      
      // Record dismissal in batter's stats
      if (gameState.batterStats[gameState.currentBatter]) {
        gameState.batterStats[gameState.currentBatter].dismissal = {
          bowler: gameState.currentBowler,
          ball: gameState.balls
        };
      }
      
      // Select new batter
      setTimeout(() => {
        showBatterSelection();
      }, 1000);
    }

    function updateScoreboard() {
      elements.battingScore.textContent = `${gameState.totalRuns}/${gameState.totalWickets}`;
      
      const overs = Math.floor(gameState.balls / 6);
      const balls = gameState.balls % 6;
      elements.battingOvers.textContent = `${overs}.${balls} overs`;
      
      const runRate = gameState.balls > 0 ? 
        (gameState.totalRuns / (gameState.balls / 6)).toFixed(2) : 0;
      elements.runRate.textContent = `RR: ${runRate}`;
      
      elements.bowlingOvers.textContent = `${overs}.${balls} overs`;
    }

    function updatePlayerStats() {
      // Update batter stats
      if (gameState.currentBatter && gameState.batterStats[gameState.currentBatter]) {
        const batter = gameState.batterStats[gameState.currentBatter];
        elements.batterRuns.textContent = batter.runs;
        elements.batterBalls.textContent = batter.balls;
        elements.batterDots.textContent = batter.dots;
        
        const strikeRate = batter.balls > 0 ? 
          ((batter.runs / batter.balls) * 100).toFixed(2) : 0;
        elements.batterSR.textContent = strikeRate;
      }
      
      // Update bowler stats
      if (gameState.currentBowler && gameState.bowlerStats[gameState.currentBowler]) {
        const bowler = gameState.bowlerStats[gameState.currentBowler];
        const overs = Math.floor(bowler.balls / 6) + (bowler.balls % 6) / 10;
        elements.bowlerOvers.textContent = overs.toFixed(1);
        elements.bowlerWickets.textContent = bowler.wickets;
        elements.bowlerExtras.textContent = `${bowler.noballs}/${bowler.wides}`;
        
        const economyRate = bowler.balls > 0 ? 
          (bowler.runs / (bowler.balls / 6)).toFixed(2) : 0;
        elements.bowlerER.textContent = economyRate;
      }
    }

    function addTimelineEvent(type, text) {
      const eventEl = document.createElement('div');
      eventEl.className = `timeline-event ${type}`;
      eventEl.textContent = `Over ${Math.floor(gameState.balls / 6)}.${gameState.balls % 6}: ${text}`;
      elements.timelineEvents.insertBefore(eventEl, elements.timelineEvents.firstChild);
    }

    function showNotification(title, message) {
      elements.notificationTitle.textContent = title;
      elements.notificationDesc.textContent = message;
      
      // Set notification class based on type
      elements.notification.className = 'notification';
      if (title.includes('Wicket')) {
        elements.notification.classList.add('wicket');
      } else if (title.includes('Runs') && (message.includes('4') || message.includes('6'))) {
        elements.notification.classList.add('boundary');
      } else if (title.includes('Milestone')) {
        elements.notification.classList.add('milestone');
      } else if (title.includes('Timeout')) {
        elements.notification.classList.add('timeout');
      }
      
      // Show and auto-hide notification
      elements.notification.style.display = 'block';
      setTimeout(() => {
        elements.notification.style.display = 'none';
      }, 3000);
    }

    function showBatterSelection() {
      // Get available players (all players minus current batters)
      const allPlayers = gameState.players[gameState.battingTeam];
      const currentPlayers = Object.keys(gameState.batterStats);
      const availablePlayers = allPlayers.filter(p => !currentPlayers.includes(p));
      
      // If no players left, innings is over
      if (availablePlayers.length === 0 || gameState.totalWickets >= 10) {
        endInnings();
        return;
      }
      
      // Show player selection modal
      elements.playerModalTitle.textContent = 'Select Next Batter';
      elements.playerModalList.innerHTML = '';
      
      availablePlayers.forEach(player => {
        const li = document.createElement('li');
        li.className = 'player-item';
        li.dataset.player = player;
        
        const nameSpan = document.createElement('span');
        nameSpan.className = 'player-name';
        nameSpan.textContent = player;
        
        // Highlight captain/vice-captain
        if (player === gameState.captains[gameState.battingTeam]) {
          const badge = document.createElement('span');
          badge.className = 'captain-badge';
          badge.textContent = ' (C)';
          nameSpan.appendChild(badge);
        } else if (player === gameState.viceCaptains[gameState.battingTeam]) {
          const badge = document.createElement('span');
          badge.className = 'vice-badge';
          badge.textContent = ' (VC)';
          nameSpan.appendChild(badge);
        }
        
        li.appendChild(nameSpan);
        li.addEventListener('click', () => selectModalPlayer(player));
        elements.playerModalList.appendChild(li);
      });
      
      elements.playerModal.style.display = 'flex';
    }

    function showBowlerSelection() {
      // Get available bowlers (all players minus current bowler if they've bowled too much)
      const allPlayers = gameState.players[gameState.bowlingTeam];
      const currentBowlers = Object.keys(gameState.bowlerStats);
      
      // Filter players who haven't bowled too many overs
      const availablePlayers = allPlayers.filter(player => {
        const bowler = gameState.bowlerStats[player];
        if (!bowler) return true;
        
        const oversBowled = bowler.balls / 6;
        const maxOvers = gameState.maxOvers / 5; // Max 20% of total overs per bowler
        
        return oversBowled < maxOvers;
      });
      
      // Show player selection modal
      elements.playerModalTitle.textContent = 'Select Next Bowler';
      elements.playerModalList.innerHTML = '';
      
      availablePlayers.forEach(player => {
        const li = document.createElement('li');
        li.className = 'player-item';
        li.dataset.player = player;
        
        const nameSpan = document.createElement('span');
        nameSpan.className = 'player-name';
        nameSpan.textContent = player;
        
        // Highlight captain/vice-captain
        if (player === gameState.captains[gameState.bowlingTeam]) {
          const badge = document.createElement('span');
          badge.className = 'captain-badge';
          badge.textContent = ' (C)';
          nameSpan.appendChild(badge);
        } else if (player === gameState.viceCaptains[gameState.bowlingTeam]) {
          const badge = document.createElement('span');
          badge.className = 'vice-badge';
          badge.textContent = ' (VC)';
          nameSpan.appendChild(badge);
        }
        
        // Add bowling stats if available
        const statsSpan = document.createElement('span');
        statsSpan.className = 'player-stats';
        
        if (gameState.bowlerStats[player]) {
          const bowler = gameState.bowlerStats[player];
          const overs = Math.floor(bowler.balls / 6) + (bowler.balls % 6) / 10;
          const economy = bowler.balls > 0 ? (bowler.runs / (bowler.balls / 6)).toFixed(2) : '0.00';
          
          statsSpan.textContent = ` ${overs} overs, ${bowler.wickets} wkts, ER: ${economy}`;
        } else {
          statsSpan.textContent = ' New bowler';
        }
        
        li.appendChild(nameSpan);
        li.appendChild(statsSpan);
        li.addEventListener('click', () => selectModalPlayer(player));
        elements.playerModalList.appendChild(li);
      });
      
      elements.playerModal.style.display = 'flex';
    }

    function selectModalPlayer(player) {
      // Clear previous selection
      elements.playerModalList.querySelectorAll('.player-item').forEach(item => {
        item.classList.remove('selected');
      });
      
      // Set new selection
      const selectedItem = elements.playerModalList.querySelector(`.player-item[data-player="${player}"]`);
      selectedItem.classList.add('selected');
      
      // Enable confirm button
      elements.confirmPlayerSelect.disabled = false;
      elements.confirmPlayerSelect.dataset.player = player;
    }

    function confirmPlayerSelection() {
      const player = elements.confirmPlayerSelect.dataset.player;
      
      if (elements.playerModalTitle.textContent.includes('Batter')) {
        // Set new batter
        gameState.currentBatter = player;
        elements.currentBatter.textContent = player;
        
        // Initialize batter stats if not exists
        if (!gameState.batterStats[player]) {
          gameState.batterStats[player] = {
            runs: 0,
            balls: 0,
            fours: 0,
            sixes: 0,
            dots: 0,
            dismissal: null
          };
        }
      } else {
        // Set new bowler
        gameState.currentBowler = player;
        elements.currentBowler.textContent = player;
        
        // Initialize bowler stats if not exists
        if (!gameState.bowlerStats[player]) {
          gameState.bowlerStats[player] = {
            runs: 0,
            balls: 0,
            wickets: 0,
            maidens: 0,
            noballs: 0,
            wides: 0
          };
        }
      }
      
      // Close modal
      elements.playerModal.style.display = 'none';
      elements.confirmPlayerSelect.disabled = true;
      
      // Update player stats display
      updatePlayerStats();
    }

    function endInnings() {
      gameState.inningsCompleted = true;
      
      // Show innings summary
      showInningsSummary();
      
      // Start innings break if this was first innings
      if (gameState.innings === 1) {
        set(inningsBreakRef, {
          active: true,
          duration: 90,
          timestamp: Date.now()
        });
      }
      
      // Save match state
      saveMatchState();
    }

    function showInningsSummary() {
      elements.summaryStats.innerHTML = '';
      
      // Add basic stats
      addSummaryStat('Total Runs', gameState.totalRuns);
      addSummaryStat('Total Wickets', gameState.totalWickets);
      addSummaryStat('Overs Bowled', `${Math.floor(gameState.balls / 6)}.${gameState.balls % 6}`);
      
      const runRate = gameState.balls > 0 ? 
        (gameState.totalRuns / (gameState.balls / 6)).toFixed(2) : 0;
      addSummaryStat('Run Rate', runRate);
      
      // Add top batters
      const batters = Object.entries(gameState.batterStats)
        .map(([name, stats]) => ({ name, ...stats }))
        .sort((a, b) => b.runs - a.runs);
      
      if (batters.length > 0) {
        addSummaryStat('Top Scorer', `${batters[0].name} - ${batters[0].runs} (${batters[0].balls})`);
      }
      
      // Add top bowlers
      const bowlers = Object.entries(gameState.bowlerStats)
        .map(([name, stats]) => ({ name, ...stats }))
        .sort((a, b) => b.wickets - a.wickets || a.runs - b.runs);
      
      if (bowlers.length > 0) {
        const topBowler = bowlers[0];
        const overs = Math.floor(topBowler.balls / 6) + (topBowler.balls % 6) / 10;
        addSummaryStat('Best Bowler', `${topBowler.name} - ${topBowler.wickets}/${topBowler.runs} (${overs.toFixed(1)} overs)`);
      }
      
      // Show modal
      elements.summaryModal.style.display = 'flex';
    }

    function addSummaryStat(label, value) {
      const statRow = document.createElement('div');
      statRow.className = 'stat-row';
      
      const statLabel = document.createElement('span');
      statLabel.className = 'stat-label';
      statLabel.textContent = label;
      
      const statValue = document.createElement('span');
      statValue.className = 'stat-value';
      statValue.textContent = value;
      
      statRow.appendChild(statLabel);
      statRow.appendChild(statValue);
      elements.summaryStats.appendChild(statRow);
    }

    function continueToNextInnings() {
      elements.summaryModal.style.display = 'none';
      
      // If this was first innings, switch to second innings
      if (gameState.innings === 1) {
        startSecondInnings();
      } else {
        // Match is complete
        endMatch();
      }
    }

    function startSecondInnings() {
      // Swap batting and bowling teams
      [gameState.battingTeam, gameState.bowlingTeam] = [gameState.bowlingTeam, gameState.battingTeam];
      
      // Reset innings-specific state
      gameState.innings = 2;
      gameState.totalRuns = 0;
      gameState.totalWickets = 0;
      gameState.balls = 0;
      gameState.overs = 0;
      gameState.currentOver = [];
      gameState.batterStats = {};
      gameState.bowlerStats = {};
      gameState.powerplay = true;
      gameState.freeHit = false;
      gameState.consecutiveZeros = { batter: 0, bowler: 0 };
      
      // Update UI
      elements.inningsInfo.textContent = '2nd Innings';
      elements.inningsStatus.textContent = 'Second Innings';
      updateTeamNames();
      updatePowerplayStatus();
      updateScoreboard();
      elements.ballsContainer.innerHTML = '';
      elements.overInfo.textContent = 'Over 0.0';
      elements.partnershipInfo.textContent = 'Partnership: 0 (0 balls)';
      elements.timelineEvents.innerHTML = '';
      
      // Initialize second innings in Firebase
      set(secondInningsRef, {
        battingTeam: gameState.battingTeam,
        bowlingTeam: gameState.bowlingTeam,
        totalRuns: 0,
        totalWickets: 0,
        balls: 0,
        batterStats: {},
        bowlerStats: {},
        extras: {
          wides: 0,
          noballs: 0,
          byes: 0,
          legbyes: 0
        }
      });
      
      // Select opening batter
      setTimeout(() => {
        showBatterSelection();
      }, 1000);
    }

    function endMatch() {
      // Determine winner
      const firstInningsRuns = gameState.firstInnings.totalRuns;
      const secondInningsRuns = gameState.totalRuns;
      
      if (secondInningsRuns > firstInningsRuns) {
        gameState.winner = gameState.battingTeam;
        gameState.winningMargin = `${10 - gameState.totalWickets} wickets`;
      } else if (secondInningsRuns < firstInningsRuns) {
        gameState.winner = gameState.bowlingTeam;
        gameState.winningMargin = `${firstInningsRuns - secondInningsRuns} runs`;
      } else {
        gameState.winner = 'tie';
        gameState.winningMargin = 'Match tied';
      }
      
      // Determine player of the match
      determinePlayerOfTheMatch();
      
      // Update match status
      gameState.matchCompleted = true;
      
      // Save match state
      saveMatchState();
      
      // Redirect to match summary
      setTimeout(() => {
        window.location.href = `match_summary.html?id=${roomId}`;
      }, 3000);
    }

    function determinePlayerOfTheMatch() {
      // Combine stats from both innings
      const allBatters = {};
      const allBowlers = {};
      
      // First innings stats
      for (const [player, stats] of Object.entries(gameState.firstInnings.batterStats)) {
        allBatters[player] = { ...stats };
      }
      
      for (const [player, stats] of Object.entries(gameState.firstInnings.bowlerStats)) {
        allBowlers[player] = { ...stats };
      }
      
      // Second innings stats (add to existing)
      for (const [player, stats] of Object.entries(gameState.batterStats)) {
        if (allBatters[player]) {
          allBatters[player].runs += stats.runs;
          allBatters[player].balls += stats.balls;
          allBatters[player].fours += stats.fours;
          allBatters[player].sixes += stats.sixes;
        } else {
          allBatters[player] = { ...stats };
        }
      }
      
      for (const [player, stats] of Object.entries(gameState.bowlerStats)) {
        if (allBowlers[player]) {
          allBowlers[player].runs += stats.runs;
          allBowlers[player].balls += stats.balls;
          allBowlers[player].wickets += stats.wickets;
        } else {
          allBowlers[player] = { ...stats };
        }
      }
      
      // Find top performers
      const topBatters = Object.entries(allBatters)
        .map(([name, stats]) => ({ name, ...stats }))
        .sort((a, b) => b.runs - a.runs);
      
      const topBowlers = Object.entries(allBowlers)
        .map(([name, stats]) => ({ name, ...stats }))
        .sort((a, b) => b.wickets - a.wickets || a.runs - b.runs);
      
      // Simple algorithm to pick player of the match
      if (topBatters.length > 0 && topBowlers.length > 0) {
        const batterScore = topBatters[0].runs + (topBatters[0].sixes * 2);
        const bowlerScore = (topBowlers[0].wickets * 25) - (topBowlers[0].runs / 2);
        
        if (batterScore > bowlerScore) {
          gameState.playerOfTheMatch = topBatters[0].name;
        } else {
          gameState.playerOfTheMatch = topBowlers[0].name;
        }
      } else if (topBatters.length > 0) {
        gameState.playerOfTheMatch = topBatters[0].name;
      } else if (topBowlers.length > 0) {
        gameState.playerOfTheMatch = topBowlers[0].name;
      }
    }

    async function saveMatchState() {
      // Update first innings data
      if (gameState.innings === 1) {
        await update(firstInningsRef, {
          totalRuns: gameState.totalRuns,
          totalWickets: gameState.totalWickets,
          balls: gameState.balls,
          batterStats: gameState.batterStats,
          bowlerStats: gameState.bowlerStats
        });
      }
      // Update second innings data
      else {
        await update(secondInningsRef, {
          totalRuns: gameState.totalRuns,
          totalWickets: gameState.totalWickets,
          balls: gameState.balls,
          batterStats: gameState.batterStats,
          bowlerStats: gameState.bowlerStats
        });
      }
      
      // Update match status
      await update(matchRef, {
        inningsCompleted: gameState.inningsCompleted,
        matchCompleted: gameState.matchCompleted,
        winner: gameState.winner,
        winningMargin: gameState.winningMargin,
        playerOfTheMatch: gameState.playerOfTheMatch
      });
    }

    function loadMatchData() {
      onValue(matchRef, (snap) => {
        if (snap.exists()) {
          const matchData = snap.val();
          
          // Load first innings data
          if (matchData.firstInnings) {
            gameState.firstInnings = matchData.firstInnings;
            
            if (gameState.innings === 1) {
              gameState.totalRuns = matchData.firstInnings.totalRuns || 0;
              gameState.totalWickets = matchData.firstInnings.totalWickets || 0;
              gameState.balls = matchData.firstInnings.balls || 0;
              gameState.overs = Math.floor(gameState.balls / 6);
              gameState.batterStats = matchData.firstInnings.batterStats || {};
              gameState.bowlerStats = matchData.firstInnings.bowlerStats || {};
              
              // Update UI
              updateScoreboard();
              updatePlayerStats();
              
              // Check if we need to select players
              checkPlayerSelection();
            }
          }
          
          // Load second innings data
          if (matchData.secondInnings && gameState.innings === 2) {
            gameState.totalRuns = matchData.secondInnings.totalRuns || 0;
            gameState.totalWickets = matchData.secondInnings.totalWickets || 0;
            gameState.balls = matchData.secondInnings.balls || 0;
            gameState.overs = Math.floor(gameState.balls / 6);
            gameState.batterStats = matchData.secondInnings.batterStats || {};
            gameState.bowlerStats = matchData.secondInnings.bowlerStats || {};
            
            // Update UI
            updateScoreboard();
            updatePlayerStats();
            
            // Check if we need to select players
            checkPlayerSelection();
          }
          
          // Load match status
          if (matchData.matchCompleted) {
            gameState.matchCompleted = true;
            window.location.href = `match_summary.html?id=${roomId}`;
          }
        }
      });
    }

    function checkPlayerSelection() {
      // Check if we need to select a batter
      if (gameState.totalWickets < 10 && !gameState.currentBatter) {
        showBatterSelection();
      }
      
      // Check if we need to select a bowler
      if (gameState.balls % 6 === 0 && gameState.balls > 0 && !gameState.currentBowler) {
        showBowlerSelection();
      }
    }

    function showTeams() {
      // Update team names
      elements.team1Title.textContent = gameState.teamNames.player1;
      elements.team2Title.textContent = gameState.teamNames.player2;
      
      // Clear existing players
      elements.team1Players.innerHTML = '';
      elements.team2Players.innerHTML = '';
      
      // Add team1 players
      gameState.players.player1.forEach(player => {
        const li = document.createElement('li');
        li.textContent = player;
        
        // Highlight captain/vice-captain
        if (player === gameState.captains.player1) {
          li.textContent += ' (C)';
          li.style.color = 'gold';
        } else if (player === gameState.viceCaptains.player1) {
          li.textContent += ' (VC)';
          li.style.color = 'silver';
        }
        
        elements.team1Players.appendChild(li);
      });
      
      // Add team2 players
      gameState.players.player2.forEach(player => {
        const li = document.createElement('li');
        li.textContent = player;
        
        // Highlight captain/vice-captain
        if (player === gameState.captains.player2) {
          li.textContent += ' (C)';
          li.style.color = 'gold';
        } else if (player === gameState.viceCaptains.player2) {
          li.textContent += ' (VC)';
          li.style.color = 'silver';
        }
        
        elements.team2Players.appendChild(li);
      });
      
      // Show modal
      elements.teamsModal.style.display = 'flex';
    }

    // Initialize the game when loaded
    window.addEventListener('DOMContentLoaded', initGame);
  </script>
</html>