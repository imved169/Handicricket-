<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HandiCricket</title>
  <style>
    /* Base Styles */
    body { 
      background: #061e3e; 
      color: white; 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      text-align: center; 
      padding: 20px;
      margin: 0;
      overflow-x: hidden;
    }
    
    h1 { 
      margin: 10px 0 20px;
      color: #ffeb3b;
      text-shadow: 0 0 5px rgba(255, 235, 59, 0.5);
    }
    
    /* Card Buttons */
    .card-row { 
      margin: 25px auto;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 12px;
      max-width: 500px;
      position: relative;
    }
    
    button.card { 
      width: 70px;
      height: 70px;
      font-size: 24px;
      border-radius: 12px;
      border: none;
      background: linear-gradient(145deg, #1e88e5, #1565c0);
      color: white;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      transition: all 0.2s;
    }
    
    button.card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
    }
    
    button.card:active {
      transform: translateY(1px);
    }
    
    button.card:disabled { 
      background: #607d8b;
      color: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    /* Scoreboard and Game Info */
    #scoreboard { 
      background: rgba(13, 42, 82, 0.8);
      padding: 15px;
      border-radius: 10px;
      margin: 15px auto;
      max-width: 500px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
      text-align: center;
    }
    
    #scoreboard div {
      padding: 5px;
    }
    
    #scoreboard strong {
      font-size: 1.2em;
      color: #4caf50;
    }
    
    /* Indicators */
    .indicator {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      margin: 0 5px;
      font-weight: bold;
      font-size: 0.8em;
    }
    
    .powerplay {
      background-color: #FFEB3B;
      color: #000;
    }
    
    .freehit {
      background-color: #4CAF50;
      color: white;
    }
    
    .deadover {
      background-color: #F44336;
      color: white;
    }
    
    #status {
      min-height: 60px;
      font-size: 18px;
      margin: 15px 0;
      color: #ffeb3b;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    /* Player Info */
    #playerInfo {
      display: flex;
      justify-content: space-around;
      margin-bottom: 15px;
    }
    
    /* Target Display */
    #targetDisplay {
      background: rgba(13, 42, 82, 0.8);
      padding: 12px;
      border-radius: 10px;
      margin: 15px auto;
      max-width: 500px;
      font-weight: bold;
    }
    
    .required-rate {
      color: #ff9800;
    }
    
    /* Wicket Progress */
    .wicket-progress {
      height: 5px;
      background: #333;
      border-radius: 3px;
      margin-top: 5px;
    }
    
    .wicket-progress-fill {
      height: 100%;
      background: #F44336;
      border-radius: 3px;
      width: 0%;
      transition: width 0.3s;
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
      button.card {
        width: 60px;
        height: 60px;
        font-size: 20px;
      }
      
      #scoreboard {
        grid-template-columns: 1fr 1fr;
      }
    }
    
    @media (max-width: 480px) {
      button.card {
        width: 50px;
        height: 50px;
        font-size: 18px;
      }
      
      #scoreboard {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üèè HandiCricket</h1>
    
    <div id="gameInfo">
      <div>Format: <span id="formatDisplay"></span></div>
      <div>You are: <span id="roleText"></span></div>
    </div>
    
    <div id="scoreboard">
      <div id="playerInfo">
        <div>Batter: <span id="currentBatter">-</span> <span id="batterWickets"></span></div>
        <div>Bowler: <span id="currentBowler">-</span></div>
      </div>
      <div>Runs: <strong id="runs">0</strong></div>
      <div>Wickets: <strong id="wickets">0</strong>/<span id="totalWickets">11</span></div>
      <div>Overs: <strong id="overs">0.0</strong></div>
      <div class="wicket-progress">
        <div id="wicketProgress" class="wicket-progress-fill"></div>
      </div>
    </div>
    
    <div id="targetDisplay" style="display: none;">
      Target: <span id="targetRuns">0</span> | <span id="requiredRate" class="required-rate">RR: 0.00</span>
    </div>
    
    <div id="status">Setting up game...</div>
    
    <div class="card-row" id="cardButtons">
      <button class="card" data-value="0">0</button>
      <button class="card" data-value="1">1</button>
      <button class="card" data-value="2">2</button>
      <button class="card" data-value="3">3</button>
      <button class="card" data-value="4">4</button>
      <button class="card" data-value="5">5</button>
      <button class="card" data-value="6">6</button>
    </div>
    
    <div id="gameControls">
      <button id="startInningsBtn" style="display: none; padding: 10px 20px; margin-top: 15px; background: #4CAF50; color: white; border: none; border-radius: 5px;">
        Start Second Innings
      </button>
    </div>
    
    <div id="indicators" style="margin-top: 15px;">
      <span id="powerplayIndicator" class="indicator powerplay" style="display: none">POWERPLAY</span>
      <span id="freehitIndicator" class="indicator freehit" style="display: none">FREE HIT</span>
      <span id="deadoverIndicator" class="indicator deadover" style="display: none">DEAD OVER</span>
    </div>
  </div>

  <script type="module">
    // Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getDatabase, ref, onValue, set, get, update, push } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-analytics.js";

    // Initialize Firebase with your configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCN6aZMwlsZe7JJaovU0WA3UQygWr4jYmA",
      authDomain: "handicricket-85a06.firebaseapp.com",
      projectId: "handicricket-85a06",
      storageBucket: "handicricket-85a06.appspot.com",
      messagingSenderId: "599182538558",
      appId: "1:599182538558:web:3e965753ab05f8f1e3de6f",
      measurementId: "G-HSV9H4LEJQ"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getDatabase(app);

    // Game state
    const state = {
      room: new URLSearchParams(window.location.search).get('room'),
      player: new URLSearchParams(window.location.search).get('player'),
      opponent: null,
      isBatting: false,
      runs: 0,
      wickets: 0,
      legalBalls: 0,
      target: 0,
      innings: 1,
      freeHit: false,
      freeHitNextBall: false,
      format: null,
      currentBatter: null,
      currentBowler: null,
      batterWickets: {},
      zerosThisOver: { player1: 0, player2: 0 },
      powerplayActive: false,
      deadOverActive: false,
      team1Score: 0,
      team2Score: 0,
      team1Wickets: 0,
      team2Wickets: 0,
      batterStats: {},
      bowlerStats: {},
      fallOfWickets: []
    };

    // Format rules with all requested features
    const formatRules = {
      "5": { 
        name: "5 Overs", 
        totalOvers: 5, 
        totalWickets: 11, 
        powerplayOvers: 2,
        powerplayWicketValue: 0.5,
        regularWicketValue: 1.0,
        maxBowlerOvers: 1,
        deadOvers: [],
        isTest: false
      },
      "10": { 
        name: "10 Overs", 
        totalOvers: 10, 
        totalWickets: 11, 
        powerplayOvers: 3,
        powerplayWicketValue: 0.5,
        regularWicketValue: 1.0,
        maxBowlerOvers: 2,
        deadOvers: [],
        isTest: false
      },
      "20": { 
        name: "T20", 
        totalOvers: 20, 
        totalWickets: 11, 
        powerplayOvers: 6,
        powerplayWicketValue: 0.5,
        regularWicketValue: 1.0,
        maxBowlerOvers: 4,
        deadOvers: [],
        isTest: false
      },
      "50": { 
        name: "ODI", 
        totalOvers: 50, 
        totalWickets: 11, 
        powerplayOvers: [1,10,21,30,41,42],
        powerplayWicketValue: 0.25,
        regularWicketValue: 0.5,
        maxBowlerOvers: 10,
        deadOvers: [11,20,31,40],
        isTest: false
      },
      "test": { 
        name: "Test Match", 
        totalOvers: Infinity, 
        totalWickets: 30, 
        powerplayOvers: 0,
        powerplayWicketValue: 0.33,
        regularWicketValue: 0.33,
        maxBowlerOvers: Infinity,
        deadOvers: [],
        isTest: true,
        maxWicketsPerBatter: 3
      }
    };

    // DOM elements
    const elements = {
      formatDisplay: document.getElementById('formatDisplay'),
      roleText: document.getElementById('roleText'),
      currentBatter: document.getElementById('currentBatter'),
      currentBowler: document.getElementById('currentBowler'),
      batterWickets: document.getElementById('batterWickets'),
      runs: document.getElementById('runs'),
      wickets: document.getElementById('wickets'),
      totalWickets: document.getElementById('totalWickets'),
      overs: document.getElementById('overs'),
      wicketProgress: document.getElementById('wicketProgress'),
      status: document.getElementById('status'),
      targetDisplay: document.getElementById('targetDisplay'),
      targetRuns: document.getElementById('targetRuns'),
      requiredRate: document.getElementById('requiredRate'),
      cardButtons: document.getElementById('cardButtons'),
      startInningsBtn: document.getElementById('startInningsBtn'),
      powerplayIndicator: document.getElementById('powerplayIndicator'),
      freehitIndicator: document.getElementById('freehitIndicator'),
      deadoverIndicator: document.getElementById('deadoverIndicator')
    };

    // Firebase references
    const refs = {
      room: ref(db, `rooms/${state.room}`),
      plays: ref(db, `rooms/${state.room}/plays`),
      batter: ref(db, `rooms/${state.room}/currentBatter`),
      bowler: ref(db, `rooms/${state.room}/currentBowler`),
      score: ref(db, `rooms/${state.room}/score`),
      inningsReady: ref(db, `rooms/${state.room}/inningsReady`),
      matchStats: ref(db, `rooms/${state.room}/matchStats`),
      result: ref(db, `rooms/${state.room}/result`)
    };

    // Initialize game
    async function initGame() {
      state.opponent = state.player === 'player1' ? 'player2' : 'player1';
      
      // Load game data
      const roomData = (await get(refs.room)).val();
      if (!roomData) {
        alert('Invalid room code');
        window.location.href = 'index.html';
        return;
      }

      // Set format
      state.format = formatRules[roomData.format || '5'];
      elements.formatDisplay.textContent = state.format.name;
      elements.totalWickets.textContent = state.format.totalWickets;

      // Set player role
      state.isBatting = (state.innings % 2 === 1) ? 
        (state.player === roomData.battingFirst) : 
        (state.player !== roomData.battingFirst);
      
      elements.roleText.textContent = state.isBatting ? 'Batting' : 'Bowling';

      // Initialize player stats
      initializePlayerStats();

      // Set up listeners
      setupListeners();
      setupEventListeners();
      updateUI();
    }

    // Initialize player stats
    function initializePlayerStats() {
      // Initialize batter stats
      state.batterStats = {};
      state.batterWickets = {};
      
      // Initialize bowler stats
      state.bowlerStats = {};
    }

    // Set up Firebase listeners
    function setupListeners() {
      // Listen for plays
      onValue(refs.plays, async (snap) => {
        const plays = snap.val();
        if (!plays || !plays.player1 || !plays.player2) return;

        const battingPlayer = state.isBatting ? state.player : state.opponent;
        const bowlingPlayer = state.isBatting ? state.opponent : state.player;
        
        const batCard = plays[battingPlayer];
        const bowlCard = plays[bowlingPlayer];

        const outcome = calculateOutcome(batCard, bowlCard, battingPlayer, bowlingPlayer);
        await processOutcome(outcome, battingPlayer, bowlingPlayer);
        
        // Reset plays
        await update(refs.plays, { player1: null, player2: null });
      });

      // Listen for batter changes
      onValue(refs.batter, (snap) => {
        state.currentBatter = snap.val();
        elements.currentBatter.textContent = state.currentBatter || '-';
        updateWicketProgress();
      });

      // Listen for bowler changes
      onValue(refs.bowler, (snap) => {
        state.currentBowler = snap.val();
        elements.currentBowler.textContent = state.currentBowler || '-';
      });

      // Listen for score changes
      onValue(refs.score, (snap) => {
        const score = snap.val();
        if (score) {
          state.runs = score.runs || 0;
          state.wickets = score.wickets || 0;
          state.legalBalls = score.legalBalls || 0;
          state.freeHit = score.freeHit || false;
          state.freeHitNextBall = score.freeHitNextBall || false;
          updateUI();
        }
      });

      // Listen for innings ready
      onValue(refs.inningsReady, (snap) => {
        if (snap.val() && state.innings === 1) {
          elements.startInningsBtn.style.display = 'block';
          elements.status.textContent = 'Opponent is ready for second innings';
        }
      });
    }

    // Calculate outcome based on cards
    function calculateOutcome(bat, bowl, battingPlayer, bowlingPlayer) {
      // Track zeros
      if (bat === 0) state.zerosThisOver[battingPlayer]++;
      if (bowl === 0) state.zerosThisOver[bowlingPlayer]++;

      // Check for 4th zero penalties
      if (state.zerosThisOver[battingPlayer] > 3 && bat === 0 && !state.format.isTest) {
        return {
          runs: -5,
          wicket: false,
          message: "4th zero in over! -5 runs",
          legalBall: true
        };
      }
      
      if (state.zerosThisOver[bowlingPlayer] > 3 && bowl === 0 && !state.format.isTest) {
        return {
          runs: 1,
          wicket: false,
          message: "4th zero in over! No Ball +1 run",
          freeHitNextBall: true,
          legalBall: false
        };
      }

      // No Ball (both 0)
      if (bat === 0 && bowl === 0) {
        if (state.format.isTest) {
          return { 
            runs: 0, 
            wicket: false, 
            message: "No run (Test Match)",
            legalBall: true
          };
        }
        return { 
          runs: 1, 
          wicket: false, 
          message: "NO BALL! +1 run (Free Hit next ball)",
          freeHitNextBall: true,
          legalBall: false
        };
      }

      // Free Hit
      if (state.freeHit) {
        if (bat === bowl && bat > 0) {
          return { 
            runs: 0, 
            wicket: false, 
            message: "Wicket on Free Hit (not out)",
            freeHit: false,
            legalBall: true
          };
        }
        return {
          runs: bat,
          wicket: false,
          message: `${bat} Run(s)! (Free Hit)`,
          freeHit: false,
          legalBall: true
        };
      }

      // Wicket (same number > 0)
      if (bat === bowl && bat > 0) {
        const wicketValue = getWicketValue();
        const isOut = (state.batterWickets[state.currentBatter] || 0) + wicketValue >= 
                     (state.format.isTest ? state.format.maxWicketsPerBatter : 1.0);
        
        return {
          runs: 0,
          wicket: true,
          wicketValue: wicketValue,
          message: isOut ? "WICKET! (Out)" : `WICKET! (${wicketValue.toFixed(2)} added)`,
          isOut: isOut,
          legalBall: true
        };
      }

      // Batter plays 0 (Test match special rule)
      if (bat === 0 && bowl > 0) {
        if (state.format.isTest) {
          return {
            runs: bowl,
            wicket: false,
            message: `${bowl} Run(s) to bowler!`,
            legalBall: true
          };
        }
        return {
          runs: bowl,
          wicket: false,
          message: `Batter played 0. Runs = ${bowl}`,
          legalBall: true
        };
      }

      // Bowler plays 0 (Test match special rule)
      if (bowl === 0 && bat > 0) {
        if (state.format.isTest) {
          return {
            runs: bat,
            wicket: false,
            message: `${bat} Run(s)!`,
            legalBall: true
          };
        }
        return {
          runs: 0,
          wicket: false,
          message: "Dot ball!",
          legalBall: true
        };
      }

      // Normal runs
      return {
        runs: bat,
        wicket: false,
        message: `${bat} Run(s)!`,
        legalBall: true
      };
    }

    // Get wicket value based on format and powerplay status
    function getWicketValue() {
      const currentOver = Math.floor(state.legalBalls / 6);
      let isPowerplay = false;
      
      if (Array.isArray(state.format.powerplayOvers)) {
        for (let i = 0; i < state.format.powerplayOvers.length; i += 2) {
          if (currentOver >= state.format.powerplayOvers[i] - 1 && 
              currentOver <= state.format.powerplayOvers[i+1] - 1) {
            isPowerplay = true;
            break;
          }
        }
      } else if (currentOver < state.format.powerplayOvers) {
        isPowerplay = true;
      }
      
      return isPowerplay ? 
        state.format.powerplayWicketValue : 
        state.format.regularWicketValue;
    }

    // Process outcome and update game state
    async function processOutcome(outcome, battingPlayer, bowlingPlayer) {
      // Update runs
      state.runs += outcome.runs;
      
      // Update wickets if applicable
      if (outcome.wicket) {
        if (!state.batterWickets[state.currentBatter]) {
          state.batterWickets[state.currentBatter] = 0;
        }
        
        state.batterWickets[state.currentBatter] += outcome.wicketValue;
        state.wickets += outcome.wicketValue;
        
        // Check if batter is out
        if (outcome.isOut) {
          state.fallOfWickets.push({
            score: state.runs,
            batter: state.currentBatter,
            over: `${Math.floor(state.legalBalls/6)}.${state.legalBalls%6}`
          });
          
          elements.status.textContent = `${state.currentBatter} is OUT!`;
          await set(refs.batter, null);
        }
      }
      
      // Update ball counts
      if (outcome.legalBall) {
        state.legalBalls++;
        // Reset zero counts at end of over
        if (state.legalBalls % 6 === 0) {
          state.zerosThisOver = { player1: 0, player2: 0 };
        }
      }
      
      // Handle free hit flags
      if (outcome.freeHitNextBall) {
        state.freeHitNextBall = true;
      }
      if (outcome.freeHit !== undefined) {
        state.freeHit = outcome.freeHit;
      }
      
      // Update player stats
      updatePlayerStats(outcome);
      
      // Update UI and Firebase
      updateUI();
      await update(refs.score, {
        runs: state.runs,
        wickets: state.wickets,
        legalBalls: state.legalBalls,
        freeHit: state.freeHit,
        freeHitNextBall: state.freeHitNextBall
      });
      
      // Update match stats
      updateMatchStats();
      
      // Check for game/innings end
      checkGameEnd();
    }

    // Update player stats
    function updatePlayerStats(outcome) {
      // Update batter stats
      if (state.currentBatter) {
        state.batterStats[state.currentBatter] = state.batterStats[state.currentBatter] || { 
          runs: 0, balls: 0, dots: 0, fours: 0, sixes: 0 
        };
        
        state.batterStats[state.currentBatter].runs += outcome.runs;
        if (outcome.legalBall) state.batterStats[state.currentBatter].balls++;
        
        if (outcome.runs === 0 && outcome.legalBall) state.batterStats[state.currentBatter].dots++;
        if (outcome.runs === 4) state.batterStats[state.currentBatter].fours++;
        if (outcome.runs === 6) state.batterStats[state.currentBatter].sixes++;
      }
      
      // Update bowler stats
      if (state.currentBowler) {
        state.bowlerStats[state.currentBowler] = state.bowlerStats[state.currentBowler] || { 
          overs: 0, maidens: 0, runs: 0, wickets: 0, balls: 0 
        };
        
        state.bowlerStats[state.currentBowler].runs += outcome.runs;
        if (outcome.legalBall) state.bowlerStats[state.currentBowler].balls++;
        if (outcome.wicket) state.bowlerStats[state.currentBowler].wickets += outcome.wicketValue;
      }
    }

    // Update match stats in Firebase
    function updateMatchStats() {
      const currentOver = Math.floor(state.legalBalls / 6);
      const balls = state.legalBalls % 6;
      const runRate = state.legalBalls > 0 ? (state.runs / (state.legalBalls / 6)).toFixed(2) : "0.00";
      
      const stats = {
        currentOver: `${currentOver}.${balls}`,
        runRate: runRate,
        isPowerplay: state.powerplayActive,
        isDeadOver: state.deadOverActive,
        freeHit: state.freeHit,
        fallOfWickets: state.fallOfWickets.slice(-5)
      };
      
      set(refs.matchStats, stats);
    }

    // Check powerplay and dead over status
    function checkPowerplayStatus() {
      const currentOver = Math.floor(state.legalBalls / 6) + 1;
      
      state.powerplayActive = false;
      state.deadOverActive = false;
      
      if (Array.isArray(state.format.powerplayOvers)) {
        for (let i = 0; i < state.format.powerplayOvers.length; i += 2) {
          if (currentOver >= state.format.powerplayOvers[i] && 
              currentOver <= state.format.powerplayOvers[i+1]) {
            state.powerplayActive = true;
            break;
          }
        }
      } else {
        state.powerplayActive = currentOver <= state.format.powerplayOvers;
      }
      
      // Check for dead overs (ODI format)
      if (Array.isArray(state.format.deadOvers) && state.format.deadOvers.length > 0) {
        for (let i = 0; i < state.format.deadOvers.length; i += 2) {
          if (currentOver >= state.format.deadOvers[i] && 
              currentOver <= state.format.deadOvers[i+1]) {
            state.deadOverActive = true;
            break;
          }
        }
      }
    }

    // Update UI elements
    function updateUI() {
      elements.runs.textContent = state.runs;
      elements.wickets.textContent = Math.floor(state.wickets);
      
      const overs = Math.floor(state.legalBalls / 6);
      const balls = state.legalBalls % 6;
      elements.overs.textContent = `${overs}.${balls}`;
      
      // Update wicket progress
      updateWicketProgress();
      
      // Update indicators
      checkPowerplayStatus();
      elements.powerplayIndicator.style.display = state.powerplayActive ? 'inline-block' : 'none';
      elements.freehitIndicator.style.display = state.freeHit ? 'inline-block' : 'none';
      elements.deadoverIndicator.style.display = state.deadOverActive ? 'inline-block' : 'none';
      
      // Update target display for second innings
      if (state.innings === 2 && state.target > 0) {
        elements.targetDisplay.style.display = 'block';
        elements.targetRuns.textContent = state.target;
        
        const ballsRemaining = state.format.totalOvers * 6 - state.legalBalls;
        if (ballsRemaining > 0) {
          const requiredRuns = state.target - state.runs;
          const requiredRate = (requiredRuns / (ballsRemaining / 6)).toFixed(2);
          elements.requiredRate.textContent = `RR: ${requiredRate}`;
        }
      }
      
      // Enable/disable cards based on game state
      const cards = document.querySelectorAll('.card');
      cards.forEach(card => {
        card.disabled = !state.currentBatter || !state.currentBowler;
      });
    }

    // Update wicket progress bar
    function updateWicketProgress() {
      if (!state.currentBatter) return;
      
      const currentWickets = state.batterWickets[state.currentBatter] || 0;
      const maxWickets = state.format.isTest ? state.format.maxWicketsPerBatter : 1.0;
      const progress = (currentWickets / maxWickets) * 100;
      
      elements.wicketProgress.style.width = `${progress}%`;
      elements.batterWickets.textContent = `(${currentWickets.toFixed(2)}/${maxWickets})`;
    }

    // Check for game/innings end conditions
    function checkGameEnd() {
      // Check innings end
      if (state.innings === 1 && 
          (state.wickets >= state.format.totalWickets || 
           state.legalBalls >= state.format.totalOvers * 6)) {
        endInnings();
      }
      // Check match end (second innings)
      else if (state.innings === 2) {
        if (state.runs >= state.target) {
          endGame(true);
        } else if (state.wickets >= state.format.totalWickets || 
                  state.legalBalls >= state.format.totalOvers * 6) {
          endGame(false);
        }
      }
    }

    // End current innings
    async function endInnings() {
      // Update team scores
      if (state.innings === 1) {
        state.team1Score = state.runs;
        state.team1Wickets = state.wickets;
      } else {
        state.team2Score = state.runs;
        state.team2Wickets = state.wickets;
      }
      
      state.target = state.runs + 1;
      state.innings = 2;
      state.runs = 0;
      state.wickets = 0;
      state.legalBalls = 0;
      state.freeHit = false;
      state.freeHitNextBall = false;
      state.zerosThisOver = { player1: 0, player2: 0 };
      
      // Update role
      const roomData = (await get(refs.room)).val();
      state.isBatting = state.player !== roomData.battingFirst;
      elements.roleText.textContent = state.isBatting ? 'Batting' : 'Bowling';
      
      // Reset Firebase
      await update(refs.score, {
        runs: 0,
        wickets: 0,
        legalBalls: 0,
        freeHit: false,
        freeHitNextBall: false
      });
      
      await set(refs.batter, null);
      await set(refs.bowler, null);
      
      updateUI();
      elements.status.textContent = `Target: ${state.target}`;
      
      // For Test matches, check follow-on
      if (state.format.isTest && state.innings === 2 && 
          state.team1Score - state.team2Score >= 200) {
        elements.status.textContent += " (Follow-on possible)";
      }
    }

    // End game with result
    async function endGame(isWin) {
      let result;
      
      if (state.format.isTest) {
        if (state.team1Score > state.team2Score) {
          result = `Team 1 wins by ${state.team1Score - state.team2Score} runs`;
        } else if (state.team2Score > state.team1Score) {
          result = `Team 2 wins by ${10 - Math.floor(state.team2Wickets)} wickets`;
        } else {
          result = "Match drawn";
        }
      } else {
        if (isWin) {
          result = `Team ${state.innings === 1 ? 1 : 2} wins by ${state.format.totalWickets - Math.floor(state.wickets)} wickets`;
        } else {
          result = `Team ${state.innings === 1 ? 2 : 1} wins by ${state.target - state.runs} runs`;
        }
      }
      
      elements.status.textContent = `Game Over! ${result}`;
      await set(refs.result, result);
      
      // Disable cards
      const cards = document.querySelectorAll('.card');
      cards.forEach(card => card.disabled = true);
    }

    // Card click handler
    async function handleCardClick(card) {
      const value = parseInt(card.dataset.value);
      await update(refs.plays, { [state.player]: value });
      elements.status.textContent = 'Waiting for opponent...';
    }

    // Start second innings
    async function startSecondInnings() {
      await set(refs.inningsReady, true);
      elements.startInningsBtn.style.display = 'none';
    }

    // Set up event listeners
    function setupEventListeners() {
      document.querySelectorAll('.card').forEach(card => {
        card.addEventListener('click', () => handleCardClick(card));
      });
      
      elements.startInningsBtn.addEventListener('click', startSecondInnings);
    }

    // Initialize the game
    setupEventListeners();
    initGame();
  </script>
</body>
</html>
