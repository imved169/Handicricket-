<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>HandiCricket - First Innings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
  <style>
    body {
      background: #061e3e;
      color: white;
      font-family: sans-serif;
      text-align: center;
      padding: 20px;
    }

    #miniScorecard {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 14px;
      color: #ccc;
    }

    .card-row {
      margin-top: 20px;
    }

    .card {
      font-size: 22px;
      padding: 15px;
      margin: 5px;
      border-radius: 10px;
      border: none;
      background: #1e88e5;
      color: white;
      cursor: pointer;
      transition: 0.3s ease;
    }

    .card:hover {
      background: #1565c0;
      transform: scale(1.05);
    }

    .team-container {
      background: #0d2a52;
      padding: 10px;
      border-radius: 10px;
      min-width: 130px;
    }

    #selectionModal {
      display: none;
      background: rgba(0, 0, 0, 0.8);
      padding: 15px;
      border-radius: 15px;
      margin-bottom: 10px;
    }

    #selectionList button {
      background: #2196f3;
      color: white;
      margin: 5px;
      padding: 8px;
      border: none;
      border-radius: 8px;
    }

    #scoreboard, #currentPlayers {
      margin: 10px 0;
    }

    .online {
      margin-top: 10px;
      color: lightgreen;
    }

    .loading-spinner {
      display: none;
    }

    #topControls button {
      margin: 5px;
      padding: 8px 16px;
      border-radius: 8px;
      border: none;
      background-color: #1976d2;
      color: white;
    }

  </style>
</head>
<body>
  <div id="miniScorecard">
    <div id="miniScore">0/0</div>
    <div id="miniOvers">0.0</div>
  </div>

  <h2>üèè HandiCricket - First Innings</h2>

  <div id="topControls">
    <button id="exitBtn">üö™ Exit</button>
    <button id="resetPlaysBtn">üîÑ Reset</button>
  </div>

  <div id="formatDisplay">Format: T20</div>
  <div id="roleText">Loading role...</div>

  <div id="teamStatus">
    <div id="currentPlayers">
      Batter: <span id="currentBatter">-</span> |
      Bowler: <span id="currentBowler">-</span>
    </div>
    <div id="scoreboard">
      Runs: <strong id="runs">0</strong> |
      Wickets: <strong id="wickets">0</strong> |
      Overs: <strong id="overs">0.0</strong>
    </div>
  </div>

  <div id="status">Initializing game...</div>
  <div id="loading-spinner" class="loading-spinner">‚è≥</div>

  <div class="card-row" id="cardButtons">
    <div id="selectionModal">
      <h3 id="selectionTitle">Select Next Player</h3>
      <div id="selectionList"></div>
      <button id="confirmSelection">Confirm</button>
    </div>

    <button class="card" data-value="0">0</button>
    <button class="card" data-value="1">1</button>
    <button class="card" data-value="2">2</button>
    <button class="card" data-value="3">3</button>
    <button class="card" data-value="4">4</button>
    <button class="card" data-value="5">5</button>
    <button class="card" data-value="6">6</button>
  </div>

  <div id="playingXISection">
    <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 20px;">
      <div class="team-container">
        <h4 id="team1Name">Team 1</h4>
        <ul id="team1Players"></ul>
      </div>
      <div class="team-container">
        <h4 id="team2Name">Team 2</h4>
        <ul id="team2Players"></ul>
      </div>
    </div>
  </div>

  <div id="connectionStatus" class="online">Opponent: Online</div>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="firebase.js"></script>
  <script>
    const db = firebase.database();
    const room = localStorage.getItem("roomCode");
    const roomRef = db.ref("rooms/" + room);

    let isBatting = false;
    let selectedCard = null;
    let runs = 0, wickets = 0, balls = 0;
    const totalOvers = 5;
    const totalWickets = 10;

    const roleText = document.getElementById("roleText");
    const statusDiv = document.getElementById("status");
    const cardButtons = document.querySelectorAll(".card");

    function updateScoreboard() {
      document.getElementById("runs").innerText = runs;
      document.getElementById("wickets").innerText = wickets;
      document.getElementById("overs").innerText = `${Math.floor(balls/6)}.${balls%6}`;
      document.getElementById("miniScore").innerText = `${runs}/${wickets}`;
      document.getElementById("miniOvers").innerText = `${Math.floor(balls/6)}.${balls%6}`;
    }

    function handleResult(playerCard, opponentCard) {
      if (playerCard === opponentCard) {
        statusDiv.innerText = "‚ùå WICKET!";
        wickets++;
      } else {
        statusDiv.innerText = `‚úÖ ${playerCard} runs`;
        runs += playerCard;
      }

      balls++;
      updateScoreboard();

      if (wickets >= totalWickets || balls >= totalOvers * 6) {
        statusDiv.innerText = "üé¨ Innings Over!";
        disableCards();
        roomRef.child("matchStatus").set("completed");
      }

      roomRef.child("plays").remove();
    }

    function disableCards() {
      cardButtons.forEach(btn => btn.disabled = true);
    }

    function enableCards() {
      cardButtons.forEach(btn => btn.disabled = false);
    }

    function setupCardLogic() {
      cardButtons.forEach(btn => {
        btn.addEventListener("click", () => {
          const cardValue = parseInt(btn.dataset.value);
          selectedCard = cardValue;
          roomRef.child("plays/" + localStorage.getItem("player")).set(cardValue);
          disableCards();
        });
      });

      roomRef.child("plays").on("value", snapshot => {
        const plays = snapshot.val();
        if (!plays) return;

        const me = localStorage.getItem("player");
        const opponent = me === "player1" ? "player2" : "player1";

        if (plays[me] != null && plays[opponent] != null) {
          const myCard = plays[me];
          const oppCard = plays[opponent];
          const batterCard = isBatting ? myCard : oppCard;
          const bowlerCard = isBatting ? oppCard : myCard;

          handleResult(batterCard, bowlerCard);
          enableCards();
        }
      });
    }

    function setupRole() {
      roomRef.child("players").once("value", snap => {
        const players = snap.val();
        const me = localStorage.getItem("name");
        if (players.player1 === me) {
          localStorage.setItem("player", "player1");
        } else {
          localStorage.setItem("player", "player2");
        }
        roomRef.child("toss/decision").once("value", decisionSnap => {
          const decision = decisionSnap.val();
          const tossWinner = players.tossWinner;
          const mePlayer = localStorage.getItem("player");
          isBatting = (decision === "bat" && tossWinner === mePlayer) ||
                      (decision === "bowl" && tossWinner !== mePlayer);
          roleText.innerText = isBatting ? "You are Batting" : "You are Bowling";
          enableCards();
        });
      });
    }

    function initGame() {
      setupRole();
      setupCardLogic();
      updateScoreboard();
    }

    document.getElementById("exitBtn").onclick = () => window.location.href = "index.html";
    document.getElementById("resetPlaysBtn").onclick = () => roomRef.child("plays").remove();

    initGame();
  </script>
</body>
</html>
