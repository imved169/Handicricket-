<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HandiCricket - First Innings</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    :root {
      --primary: #1e88e5;
      --primary-dark: #1565c0;
      --secondary: #ffeb3b;
      --secondary-dark: #fbc02d;
      --success: #4CAF50;
      --success-dark: #2E7D32;
      --warning: #FF9800;
      --warning-dark: #F57C00;
      --danger: #f44336;
      --danger-dark: #d32f2f;
      --purple: #9C27B0;
      --purple-dark: #7B1FA2;
      --dark-blue: #061e3e;
      --medium-blue: #0a2a4a;
      --light-blue: #0f3a64;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      background: linear-gradient(135deg, var(--dark-blue), var(--medium-blue));
      color: white;
      font-family: 'Poppins', sans-serif;
      padding: 0;
      margin: 0;
      min-height: 100vh;
      overflow-x: hidden;
    }
    
    /* Header and Score Ticker */
    .header {
      background: rgba(0, 0, 0, 0.5);
      padding: 10px 0;
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .score-ticker {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .match-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--secondary);
    }
    
    .live-score {
      font-size: 20px;
      font-weight: 700;
    }
    
    .current-over {
      font-size: 16px;
      color: #ccc;
    }
    
    .live-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      background-color: var(--danger);
      border-radius: 50%;
      margin-right: 8px;
      animation: pulse 1.5s infinite;
    }
    
    /* Main Game Container */
    .game-container {
      display: flex;
      max-width: 1400px;
      margin: 20px auto;
      padding: 0 20px;
      gap: 20px;
    }
    
    /* Main Game Board */
    .game-board {
      flex: 2;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
    }
    
    .innings-info {
      text-align: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .innings-info h2 {
      color: var(--secondary);
      margin-bottom: 10px;
    }
    
    .target-display {
      font-size: 18px;
      color: #ff9800;
      font-weight: 600;
      margin-top: 10px;
    }
    
    /* Players Section */
    .players-section {
      display: flex;
      justify-content: space-between;
      margin-bottom: 30px;
      gap: 20px;
    }
    
    .player-card {
      flex: 1;
      background: rgba(13, 42, 82, 0.6);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .player-card.active {
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
      border: 2px solid gold;
    }
    
    .player-role {
      font-size: 14px;
      color: #aaa;
      margin-bottom: 5px;
    }
    
    .player-name {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 10px;
      color: var(--secondary);
    }
    
    .player-stats {
      font-size: 14px;
      color: #ccc;
    }
    
    .player-highlight {
      animation: highlight 2s ease;
    }
    
    /* Cards Selection */
    .cards-section {
      margin-bottom: 30px;
    }
    
    .cards-title {
      text-align: center;
      margin-bottom: 20px;
      color: var(--secondary);
    }
    
    .cards-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
    }
    
    .card-btn {
      aspect-ratio: 3/4;
      border: none;
      border-radius: 12px;
      background: linear-gradient(145deg, var(--primary), var(--primary-dark));
      color: white;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      position: relative;
      overflow: hidden;
    }
    
    .card-btn:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
    }
    
    .card-btn:active {
      transform: translateY(2px);
    }
    
    .card-btn.zero {
      background: linear-gradient(145deg, #607D8B, #455A64);
    }
    
    .card-btn.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .card-flip {
      animation: flip 0.6s ease;
    }
    
    .card-boundary {
      animation: boundary 1s ease;
    }
    
    .card-six {
      animation: six 1s ease;
    }
    
    /* Commentary Section */
    .commentary-section {
      background: rgba(13, 42, 82, 0.6);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .commentary-title {
      color: var(--secondary);
      margin-bottom: 15px;
      font-size: 18px;
    }
    
    .commentary-list {
      list-style: none;
    }
    
    .commentary-item {
      padding: 10px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      font-size: 14px;
    }
    
    .commentary-item:last-child {
      border-bottom: none;
    }
    
    .commentary-over {
      font-weight: 600;
      color: var(--secondary);
      margin-right: 8px;
    }
    
    /* Game Controls */
    .game-controls {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 20px;
    }
    
    .control-btn {
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      background: linear-gradient(145deg, var(--primary), var(--primary-dark));
      color: white;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .control-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    
    .control-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .control-btn.declare {
      background: linear-gradient(145deg, var(--warning), var(--warning-dark));
    }
    
    .control-btn.follow-on {
      background: linear-gradient(145deg, var(--purple), var(--purple-dark));
    }
    
    /* Sidebar */
    .game-sidebar {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .sidebar-card {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
    }
    
    .sidebar-title {
      color: var(--secondary);
      margin-bottom: 15px;
      font-size: 18px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding-bottom: 10px;
    }
    
    /* Scorecard */
    .scorecard-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    
    .scorecard-table th,
    .scorecard-table td {
      padding: 8px 5px;
      text-align: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .scorecard-table th {
      color: var(--secondary);
      font-weight: 600;
    }
    
    .scorecard-table tr:last-child td {
      border-bottom: none;
    }
    
    .batsman-active {
      background: rgba(255, 215, 0, 0.1);
    }
    
    .bowler-active {
      background: rgba(30, 136, 229, 0.1);
    }
    
    /* Charts */
    .chart-container {
      position: relative;
      height: 200px;
      width: 100%;
    }
    
    /* Chat Section */
    .chat-messages {
      max-height: 200px;
      overflow-y: auto;
      margin-bottom: 15px;
    }
    
    .chat-message {
      padding: 8px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      font-size: 14px;
    }
    
    .chat-input {
      display: flex;
      gap: 10px;
    }
    
    .chat-input input {
      flex: 1;
      padding: 10px 15px;
      border-radius: 8px;
      border: 1px solid var(--primary);
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }
    
    .chat-input button {
      padding: 10px 15px;
      border: none;
      border-radius: 8px;
      background: var(--primary);
      color: white;
      cursor: pointer;
    }
    
    /* Overlay Modals */
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(5px);
    }
    
    .modal {
      background: linear-gradient(145deg, var(--dark-blue), var(--medium-blue));
      border-radius: 15px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .modal-title {
      color: var(--secondary);
      text-align: center;
      margin-bottom: 20px;
      font-size: 24px;
    }
    
    .modal-content {
      margin-bottom: 25px;
    }
    
    .modal-actions {
      display: flex;
      justify-content: center;
      gap: 15px;
    }
    
    .modal-btn {
      padding: 12px 25px;
      border: none;
      border-radius: 8px;
      background: linear-gradient(145deg, var(--primary), var(--primary-dark));
      color: white;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .modal-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    
    /* Stumps Overlay */
    .stumps-overlay {
      text-align: center;
    }
    
    .stumps-icon {
      font-size: 60px;
      color: var(--secondary);
      margin-bottom: 20px;
    }
    
    .stumps-summary {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      padding: 15px;
      margin: 20px 0;
    }
    
    /* Awards Section */
    .awards-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin: 20px 0;
    }
    
    .award-card {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      padding: 15px;
      text-align: center;
    }
    
    .award-icon {
      font-size: 30px;
      margin-bottom: 10px;
    }
    
    .award-title {
      font-size: 16px;
      color: var(--secondary);
      margin-bottom: 5px;
    }
    
    .award-winner {
      font-size: 18px;
      font-weight: 600;
    }
    
    /* Animations */
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    
    @keyframes highlight {
      0% { background-color: rgba(255, 215, 0, 0.3); }
      100% { background-color: transparent; }
    }
    
    @keyframes flip {
      0% { transform: rotateY(0deg); }
      50% { transform: rotateY(90deg); }
      100% { transform: rotateY(0deg); }
    }
    
    @keyframes boundary {
      0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); }
      70% { box-shadow: 0 0 0 20px rgba(76, 175, 80, 0); }
      100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
    }
    
    @keyframes six {
      0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); }
      70% { box-shadow: 0 0 0 20px rgba(255, 215, 0, 0); }
      100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
      20%, 40%, 60%, 80% { transform: translateX(5px); }
    }
    
    .screen-shake {
      animation: shake 0.5s ease;
    }
    
    /* Responsive Design */
    @media (max-width: 1024px) {
      .game-container {
        flex-direction: column;
      }
      
      .cards-grid {
        grid-template-columns: repeat(4, 1fr);
      }
    }
    
    @media (max-width: 768px) {
      .players-section {
        flex-direction: column;
      }
      
      .cards-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .game-controls {
        flex-wrap: wrap;
      }
      
      .awards-grid {
        grid-template-columns: 1fr;
      }
    }
    
    @media (max-width: 480px) {
      .header {
        padding: 10px;
      }
      
      .score-ticker {
        flex-direction: column;
        gap: 10px;
        text-align: center;
      }
      
      .game-board, .sidebar-card {
        padding: 15px;
      }
      
      .modal {
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <!-- Header with Live Score Ticker -->
  <div class="header">
    <div class="score-ticker">
      <div class="match-title" id="matchTitle">Match Title</div>
      <div class="live-score" id="liveScore">0/0 (0.0 Ov)</div>
      <div class="current-over" id="currentOver">Over: 0.0</div>
    </div>
  </div>

  <!-- Main Game Container -->
  <div class="game-container">
    <!-- Main Game Board -->
    <div class="game-board">
      <!-- Innings Info -->
      <div class="innings-info">
        <h2 id="inningsTitle">First Innings</h2>
        <div id="targetDisplay" class="target-display" style="display: none;">Target: 0 runs</div>
      </div>

      <!-- Players Section -->
      <div class="players-section">
        <div class="player-card" id="batsmanCard">
          <div class="player-role">Batsman</div>
          <div class="player-name" id="batsmanName">Batsman Name</div>
          <div class="player-stats" id="batsmanStats">0 (0)</div>
        </div>

        <div class="player-card" id="bowlerCard">
          <div class="player-role">Bowler</div>
          <div class="player-name" id="bowlerName">Bowler Name</div>
          <div class="player-stats" id="bowlerStats">0-0 (0)</div>
        </div>
      </div>

      <!-- Cards Selection -->
      <div class="cards-section">
        <h3 class="cards-title">Select Your Card</h3>
        <div class="cards-grid" id="cardsGrid">
          <!-- Cards will be generated dynamically -->
        </div>
      </div>

      <!-- Commentary Section -->
      <div class="commentary-section">
        <h3 class="commentary-title">Commentary</h3>
        <ul class="commentary-list" id="commentaryList">
          <li class="commentary-item">Welcome to HandiCricket! The match is about to begin.</li>
        </ul>
      </div>

      <!-- Game Controls -->
      <div class="game-controls">
        <button class="control-btn" id="undoBtn" disabled><i class="fas fa-undo"></i> Undo</button>
        <button class="control-btn declare" id="declareBtn" style="display: none;"><i class="fas fa-flag"></i> Declare</button>
        <button class="control-btn follow-on" id="followOnBtn" style="display: none;"><i class="fas fa-exchange-alt"></i> Follow On</button>
        <button class="control-btn" id="settingsBtn"><i class="fas fa-cog"></i> Settings</button>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="game-sidebar">
      <!-- Scorecard -->
      <div class="sidebar-card">
        <h3 class="sidebar-title">Scorecard</h3>
        <div class="scorecard-container" id="scorecardContainer">
          <!-- Scorecard will be generated dynamically -->
        </div>
      </div>

      <!-- Run Rate Chart -->
      <div class="sidebar-card">
        <h3 class="sidebar-title">Run Rate</h3>
        <div class="chart-container">
          <canvas id="runRateChart"></canvas>
        </div>
      </div>

      <!-- Chat Section -->
      <div class="sidebar-card">
        <h3 class="sidebar-title">Chat</h3>
        <div class="chat-messages" id="chatMessages">
          <div class="chat-message">System: Chat connected</div>
        </div>
        <div class="chat-input">
          <input type="text" id="chatInput" placeholder="Type your message...">
          <button id="chatSendBtn">Send</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Overlay Modals -->
  <!-- Innings Break Overlay -->
  <div class="overlay" id="inningsBreakOverlay" style="display: none;">
    <div class="modal">
      <h2 class="modal-title" id="inningsBreakTitle">Innings Break</h2>
      <div class="modal-content" id="inningsBreakContent">
        <p>First innings completed. The score is <span id="inningsBreakScore">0/0</span>.</p>
        <div id="inningsHighlights"></div>
      </div>
      <div class="modal-actions">
        <button class="modal-btn" id="continueInningsBtn">Continue</button>
      </div>
    </div>
  </div>

  <!-- Stumps Overlay -->
  <div class="overlay" id="stumpsOverlay" style="display: none;">
    <div class="modal stumps-overlay">
      <div class="stumps-icon">üèè</div>
      <h2 class="modal-title">STUMPS - Day <span id="currentDay">1</span></h2>
      <div class="modal-content">
        <p>That's the end of day's play. <span id="stumpsScore">0/0</span> after <span id="stumpsOvers">0</span> overs.</p>
        <div class="stumps-summary" id="stumpsSummary">
          <!-- Stumps summary will be generated dynamically -->
        </div>
      </div>
      <div class="modal-actions">
        <button class="modal-btn" id="continueDayBtn">Continue to Next Day</button>
      </div>
    </div>
  </div>

  <!-- Match Summary Overlay -->
  <div class="overlay" id="matchSummaryOverlay" style="display: none;">
    <div class="modal">
      <h2 class="modal-title">Match Summary</h2>
      <div class="modal-content">
        <div id="matchResult"></div>
        <div class="awards-grid" id="awardsGrid">
          <!-- Awards will be generated dynamically -->
        </div>
        <div id="fullScorecard"></div>
      </div>
      <div class="modal-actions">
        <button class="modal-btn" id="exportPDFBtn">Export PDF</button>
        <button class="modal-btn" id="newMatchBtn">New Match</button>
      </div>
    </div>
  </div>

  <!-- New Batter Selection Overlay -->
  <div class="overlay" id="batterSelectionOverlay" style="display: none;">
    <div class="modal">
      <h2 class="modal-title">Select New Batter</h2>
      <div class="modal-content">
        <p>Wicket! Please select a new batter:</p>
        <div id="availableBatters"></div>
      </div>
      <div class="modal-actions">
        <button class="modal-btn" id="confirmBatterBtn" disabled>Confirm Selection</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, get, push, remove } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCN6aZMwlsZe7JJaovU0WA3UQygWr4jYmA",
      authDomain: "handicricket-85a06.firebaseapp.com",
      projectId: "handicricket-85a06",
      storageBucket: "handicricket-85a06.appbasestorage.app",
      messagingSenderId: "599182538558",
      appId: "1:599182538558:web:3e965753ab05f8f1e3de6f",
      measurementId: "G-HSV9H4LEJQ"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Get URL parameters
    const params = new URLSearchParams(window.location.search);
    const roomId = params.get('room');
    const playerRole = params.get('player'); // player1, player2, or spectator
    const isSpectator = playerRole === 'spectator';

    if (!roomId) {
      alert('Room ID not specified');
      window.location.href = 'index.html';
    }

    // Firebase references
    const roomRef = ref(db, `rooms/${roomId}`);
    const eventsRef = ref(db, `rooms/${roomId}/events`);
    const scoreboardRef = ref(db, `rooms/${roomId}/scoreboard`);
    const chatRef = ref(db, `rooms/${roomId}/chat`);
    const playingXIRef = ref(db, `rooms/${roomId}/teams`);
    const tossRef = ref(db, `rooms/${roomId}/toss`);

    // DOM elements
    const matchTitleEl = document.getElementById('matchTitle');
    const liveScoreEl = document.getElementById('liveScore');
    const currentOverEl = document.getElementById('currentOver');
    const inningsTitleEl = document.getElementById('inningsTitle');
    const targetDisplayEl = document.getElementById('targetDisplay');
    const batsmanNameEl = document.getElementById('batsmanName');
    const batsmanStatsEl = document.getElementById('batsmanStats');
    const bowlerNameEl = document.getElementById('bowlerName');
    const bowlerStatsEl = document.getElementById('bowlerStats');
    const batsmanCardEl = document.getElementById('batsmanCard');
    const bowlerCardEl = document.getElementById('bowlerCard');
    const cardsGridEl = document.getElementById('cardsGrid');
    const commentaryListEl = document.getElementById('commentaryList');
    const scorecardContainerEl = document.getElementById('scorecardContainer');
    const chatMessagesEl = document.getElementById('chatMessages');
    const chatInputEl = document.getElementById('chatInput');
    const chatSendBtn = document.getElementById('chatSendBtn');
    const undoBtn = document.getElementById('undoBtn');
    const declareBtn = document.getElementById('declareBtn');
    const followOnBtn = document.getElementById('followOnBtn');
    const settingsBtn = document.getElementById('settingsBtn');
    const inningsBreakOverlay = document.getElementById('inningsBreakOverlay');
    const inningsBreakTitleEl = document.getElementById('inningsBreakTitle');
    const inningsBreakContentEl = document.getElementById('inningsBreakContent');
    const inningsBreakScoreEl = document.getElementById('inningsBreakScore');
    const inningsHighlightsEl = document.getElementById('inningsHighlights');
    const continueInningsBtn = document.getElementById('continueInningsBtn');
    const stumpsOverlay = document.getElementById('stumpsOverlay');
    const currentDayEl = document.getElementById('currentDay');
    const stumpsScoreEl = document.getElementById('stumpsScore');
    const stumpsSummaryEl = document.getElementById('stumpsSummary');
    const continueDayBtn = document.getElementById('continueDayBtn');
    const matchSummaryOverlay = document.getElementById('matchSummaryOverlay');
    const matchResultEl = document.getElementById('matchResult');
    const awardsGridEl = document.getElementById('awardsGrid');
    const fullScorecardEl = document.getElementById('fullScorecard');
    const exportPDFBtn = document.getElementById('exportPDFBtn');
    const newMatchBtn = document.getElementById('newMatchBtn');
    const batterSelectionOverlay = document.getElementById('batterSelectionOverlay');
    const availableBattersEl = document.getElementById('availableBatters');
    const confirmBatterBtn = document.getElementById('confirmBatterBtn');

    // Game state variables
    let gameState = {
      innings: 1,
      totalRuns: 0,
      wickets: 0,
      ballsBowled: 0,
      overs: 0,
      currentBatsman: null,
      currentBowler: null,
      batsmen: [],
      bowlers: [],
      team1: { name: '', players: [] },
      team2: { name: '', players: [] },
      battingTeam: null,
      bowlingTeam: null,
      target: 0,
      matchFormat: '20',
      testOversPerDay: 90,
      currentDay: 1,
      isTestMatch: false,
      isFreeHit: false,
      lastEvent: null,
      events: [],
      batsmanZeroCount: 0,
      bowlerZeroCount: 0,
      playerLives: 3,
      followOnEnabled: false,
      declared: false
    };

    let runRateChart = null;
    let username = localStorage.getItem('hc_username');
    let selectedNewBatsman = null;

    // Initialize the game
    async function initGame() {
      try {
        // Load room data
        const roomSnapshot = await get(roomRef);
        if (!roomSnapshot.exists()) {
          alert('Room not found');
          window.location.href = 'index.html';
          return;
        }

        const roomData = roomSnapshot.val();
        
        // Set match format
        gameState.matchFormat = roomData.format || '20';
        gameState.isTestMatch = gameState.matchFormat === 'test';
        
        // Set test overs per day (with localStorage fallback)
        if (gameState.isTestMatch) {
          gameState.testOversPerDay = roomData.testOversPerDay || parseInt(localStorage.getItem('hc_testOvers')) || 90;
        }
        
        // Set team data
        if (roomData.teams) {
          gameState.team1 = roomData.teams.player1 || { name: 'Team 1', players: [] };
          gameState.team2 = roomData.teams.player2 || { name: 'Team 2', players: [] };
        } else {
          // Fallback if teams data not available
          gameState.team1 = { name: roomData.team1 || 'Team 1', players: [] };
          gameState.team2 = { name: roomData.team2 || 'Team 2', players: [] };
        }
        
        // Set batting and bowling teams based on toss
        if (roomData.tossWinner) {
          const tossWinner = roomData.tossWinner;
          const battingFirst = roomData.battingFirst;
          
          gameState.battingTeam = battingFirst === 'player1' ? gameState.team1 : gameState.team2;
          gameState.bowlingTeam = battingFirst === 'player1' ? gameState.team2 : gameState.team1;
        } else {
          // Default if toss data not available
          gameState.battingTeam = gameState.team1;
          gameState.bowlingTeam = gameState.team2;
        }
        
        // Update UI
        updateMatchTitle();
        initializeScorecard();
        generateCardButtons();
        
        // Set up real-time listeners
        setupEventListeners();
        setupFirebaseListeners();
        
        // Initialize charts
        initCharts();
        
        // Add welcome commentary
        addCommentary('The match is about to begin!');
        
      } catch (error) {
        console.error('Error initializing game:', error);
        alert('Failed to initialize game. Please try again.');
      }
    }

    // Update match title based on teams and format
    function updateMatchTitle() {
      const formatNames = {
        "5": "T5",
        "10": "T10",
        "20": "T20",
        "50": "ODI",
        "test": "Test Match"
      };
      
      const formatDisplay = formatNames[gameState.matchFormat] || gameState.matchFormat;
      matchTitleEl.textContent = `${gameState.battingTeam.name} vs ${gameState.bowlingTeam.name} - ${formatDisplay}`;
      
      if (gameState.isTestMatch) {
        inningsTitleEl.textContent = `Innings ${gameState.innings} - Day ${gameState.currentDay}`;
      } else {
        inningsTitleEl.textContent = gameState.innings === 1 ? 'First Innings' : 'Second Innings';
      }
      
      // Show target in second innings
      if (gameState.innings === 2) {
        targetDisplayEl.textContent = `Target: ${gameState.target} runs`;
        targetDisplayEl.style.display = 'block';
      }
    }

    // Initialize scorecard
    function initializeScorecard() {
      // Create batting scorecard
      let scorecardHTML = `
        <h4>${gameState.battingTeam.name} Batting</h4>
        <table class="scorecard-table">
          <tr>
            <th>Batter</th>
            <th>R</th>
            <th>B</th>
            <th>4s</th>
            <th>6s</th>
            <th>SR</th>
          </tr>
      `;
      
      gameState.battingTeam.players.forEach(player => {
        scorecardHTML += `
          <tr>
            <td>${player}</td>
            <td>0</td>
            <td>0</td>
            <td>0</td>
            <td>0</td>
            <td>0.00</td>
          </tr>
        `;
      });
      
      scorecardHTML += `
        </table>
        <h4>${gameState.bowlingTeam.name} Bowling</h4>
        <table class="scorecard-table">
          <tr>
            <th>Bowler</th>
            <th>O</th>
            <th>M</th>
            <th>R</th>
            <th>W</th>
            <th>ER</th>
          </tr>
      `;
      
      gameState.bowlingTeam.players.forEach(player => {
        scorecardHTML += `
          <tr>
            <td>${player}</td>
            <td>0</td>
            <td>0</td>
            <td>0</td>
            <td>0</td>
            <td>0.00</td>
          </tr>
        `;
      });
      
      scorecardHTML += `</table>`;
      scorecardContainerEl.innerHTML = scorecardHTML;
      
      // Set initial batsman and bowler
      if (gameState.battingTeam.players.length > 0) {
        gameState.currentBatsman = {
          name: gameState.battingTeam.players[0],
          runs: 0,
          balls: 0,
          fours: 0,
          sixes: 0,
          isOut: false
        };
        batsmanNameEl.textContent = gameState.currentBatsman.name;
        batsmanStatsEl.textContent = `${gameState.currentBatsman.runs} (${gameState.currentBatsman.balls})`;
      }
      
      if (gameState.bowlingTeam.players.length > 0) {
        gameState.currentBowler = {
          name: gameState.bowlingTeam.players[0],
          overs: 0,
          maidens: 0,
          runs: 0,
          wickets: 0,
          ballsInOver: 0
        };
        bowlerNameEl.textContent = gameState.currentBowler.name;
        bowlerStatsEl.textContent = `${gameState.currentBowler.wickets}-${gameState.currentBowler.runs} (${gameState.currentBowler.overs}.${gameState.currentBowler.ballsInOver})`;
      }
    }

    // Generate card buttons
    function generateCardButtons() {
      cardsGridEl.innerHTML = '';
      for (let i = 0; i <= 6; i++) {
        const cardBtn = document.createElement('button');
        cardBtn.className = `card-btn ${i === 0 ? 'zero' : ''}`;
        cardBtn.textContent = i;
        cardBtn.dataset.value = i;
        
        if (isSpectator) {
          cardBtn.disabled = true;
          cardBtn.classList.add('disabled');
        } else {
          cardBtn.addEventListener('click', () => playCard(i));
        }
        
        cardsGridEl.appendChild(cardBtn);
      }
    }

    // Set up event listeners
    function setupEventListeners() {
      chatSendBtn.addEventListener('click', sendChatMessage);
      chatInputEl.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendChatMessage();
      });
      
      undoBtn.addEventListener('click', undoLastBall);
      declareBtn.addEventListener('click', declareInnings);
      followOnBtn.addEventListener('click', enableFollowOn);
      settingsBtn.addEventListener('click', showSettings);
      continueInningsBtn.addEventListener('click', continueToNextInnings);
      continueDayBtn.addEventListener('click', continueToNextDay);
      exportPDFBtn.addEventListener('click', exportSummaryPDF);
      newMatchBtn.addEventListener('click', startNewMatch);
      confirmBatterBtn.addEventListener('click', confirmNewBatsman);
    }

    // Set up Firebase listeners
    function setupFirebaseListeners() {
      // Listen for events
      onValue(eventsRef, (snapshot) => {
        if (snapshot.exists()) {
          const events = snapshot.val();
          gameState.events = Object.values(events);
          
          // Process the latest event if it's new
          if (gameState.events.length > 0) {
            const latestEvent = gameState.events[gameState.events.length - 1];
            if (!gameState.lastEvent || latestEvent.timestamp !== gameState.lastEvent.timestamp) {
              processEvent(latestEvent);
              gameState.lastEvent = latestEvent;
            }
          }
        }
      });
      
      // Listen for scoreboard updates
      onValue(scoreboardRef, (snapshot) => {
        if (snapshot.exists()) {
          const scoreboard = snapshot.val();
          updateScoreboard(scoreboard);
        }
      });
      
      // Listen for chat messages
      onValue(chatRef, (snapshot) => {
        if (snapshot.exists()) {
          const messages = snapshot.val();
          updateChat(messages);
        }
      });
    }

    // Initialize charts
    function initCharts() {
      const ctx = document.getElementById('runRateChart').getContext('2d');
      runRateChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: 'Run Rate',
            data: [],
            borderColor: '#1e88e5',
            backgroundColor: 'rgba(30, 136, 229, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              },
              ticks: {
                color: 'white'
              }
            },
            x: {
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              },
              ticks: {
                color: 'white'
              }
            }
          },
          plugins: {
            legend: {
              labels: {
                color: 'white'
              }
            }
          }
        }
      });
    }

    // Play a card
    async function playCard(cardValue) {
      if (isSpectator) return;
      
      try {
        // Disable buttons during processing
        const cardButtons = document.querySelectorAll('.card-btn');
        cardButtons.forEach(btn => {
          btn.disabled = true;
          btn.classList.add('disabled');
        });
        
        // Create event object
        const event = {
          type: 'ball',
          batsmanCard: cardValue,
          bowlerCard: Math.floor(Math.random() * 7), // Random card for bowler (AI)
          timestamp: Date.now(),
          player: playerRole
        };
        
        // Push event to Firebase
        await push(eventsRef, event);
        
        // Re-enable buttons after a short delay
        setTimeout(() => {
          cardButtons.forEach(btn => {
            btn.disabled = false;
            btn.classList.remove('disabled');
          });
        }, 1000);
        
      } catch (error) {
        console.error('Error playing card:', error);
        alert('Failed to play card. Please try again.');
        
        // Re-enable buttons on error
        const cardButtons = document.querySelectorAll('.card-btn');
        cardButtons.forEach(btn => {
          btn.disabled = false;
          btn.classList.remove('disabled');
        });
      }
    }

    // Process a game event
    function processEvent(event) {
      if (event.type !== 'ball') return;
      
      const batsmanCard = event.batsmanCard;
      const bowlerCard = event.bowlerCard;
      let runs = 0;
      let isWicket = false;
      let isNoBall = false;
      let isFreeHit = gameState.isFreeHit;
      let commentary = '';
      
      // Apply HandiCricket rules
      if (batsmanCard === 0 && bowlerCard === 0) {
        // Both zeros: No-ball (+1 run, Free Hit next ball)
        runs = 1;
        isNoBall = true;
        gameState.isFreeHit = true;
        commentary = `No ball! ${runs} run${runs !== 1 ? 's' : ''} added. Free Hit awarded!`;
        
      } else if (batsmanCard === bowlerCard && batsmanCard !== 0) {
        // Same non-zero cards: Wicket
        isWicket = true;
        commentary = `OUT! ${gameState.currentBatsman.name} is dismissed!`;
        
      } else if (batsmanCard === 0) {
        // Batter zero, bowler non-zero: runs = bowler's card
        runs = bowlerCard;
        commentary = `${runs} run${runs !== 1 ? 's' : ''} scored!`;
        
      } else if (bowlerCard === 0) {
        // Bowler zero, batter non-zero: dot ball
        runs = 0;
        commentary = `Dot ball.`;
        
      } else {
        // Different non-zero cards: runs = batter's card
        runs = batsmanCard;
        commentary = `${runs} run${runs !== 1 ? 's' : ''} scored!`;
      }
      
      // Handle free hit
      if (isFreeHit) {
        if (isWicket) {
          // Wicket on free hit is not out
          isWicket = false;
          commentary = `Wicket on Free Hit! ${gameState.currentBatsman.name} survives!`;
        }
        runs += 1; // +1 run for free hit
        gameState.isFreeHit = false; // Free hit consumed
      }
      
      // Handle zeros count and penalties
      if (batsmanCard === 0) {
        gameState.batsmanZeroCount++;
        if (gameState.batsmanZeroCount >= 4) {
          // Penalty for 4th zero
          runs -= 5;
          commentary = `Penalty! ${gameState.currentBatsman.name} has too many zeros. -5 runs!`;
          gameState.batsmanZeroCount = 0;
        }
      } else {
        gameState.batsmanZeroCount = 0;
      }
      
      if (bowlerCard === 0) {
        gameState.bowlerZeroCount++;
        if (gameState.bowlerZeroCount >= 4) {
          // No-ball for 4th zero
          runs += 1;
          isNoBall = true;
          commentary = `No ball! Bowler has too many zeros. +1 run!`;
          gameState.bowlerZeroCount = 0;
        }
      } else {
        gameState.bowlerZeroCount = 0;
      }
      
      // Update game state
      if (!isNoBall) {
        gameState.ballsBowled++;
        gameState.currentBowler.ballsInOver++;
        
        // Update over count
        if (gameState.currentBowler.ballsInOver >= 6) {
          gameState.currentBowler.ballsInOver = 0;
          gameState.currentBowler.overs++;
          gameState.overs = parseFloat((gameState.overs + 0.1).toFixed(1));
          
          // End of over processing
          endOver();
        }
      }
      
      // Update runs and wickets
      gameState.totalRuns += runs;
      gameState.currentBatsman.runs += runs;
      gameState.currentBatsman.balls++;
      gameState.currentBowler.runs += runs;
      
      // Update boundaries count
      if (runs === 4) {
        gameState.currentBatsman.fours++;
        commentary = `FOUR! ${gameState.currentBatsman.name} finds the boundary!`;
      } else if (runs === 6) {
        gameState.currentBatsman.sixes++;
        commentary = `SIX! ${gameState.currentBatsman.name} with a massive hit!`;
      }
      
      // Handle wicket
      if (isWicket) {
        gameState.wickets++;
        gameState.currentBowler.wickets++;
        gameState.currentBatsman.isOut = true;
        
        // Check if all out
        if (gameState.wickets >= gameState.battingTeam.players.length - 1) {
          endInnings();
        } else {
          // Show batter selection overlay
          showBatterSelection();
        }
      }
      
      // Update UI
      updateLiveScore();
      updatePlayerStats();
      addCommentary(commentary);
      
      // Update Firebase scoreboard
      updateFirebaseScoreboard();
      
      // Check for end of day in Test matches
      if (gameState.isTestMatch && gameState.overs >= gameState.testOversPerDay) {
        endDay();
      }
      
      // Check for milestones
      checkMilestones();
    }

    // Update live score display
    function updateLiveScore() {
      const over = Math.floor(gameState.ballsBowled / 6);
      const ball = gameState.ballsBowled % 6;
      liveScoreEl.textContent = `${gameState.totalRuns}/${gameState.wickets} (${over}.${ball} Ov)`;
      currentOverEl.textContent = `Over: ${over}.${ball}`;
      
      // Update title with live score
      document.title = `${gameState.totalRuns}/${gameState.wickets} - HandiCricket`;
    }

    // Update player stats display
    function updatePlayerStats() {
      batsmanStatsEl.textContent = `${gameState.currentBatsman.runs} (${gameState.currentBatsman.balls})`;
      bowlerStatsEl.textContent = `${gameState.currentBowler.wickets}-${gameState.currentBowler.runs} (${gameState.currentBowler.overs}.${gameState.currentBowler.ballsInOver})`;
    }

    // Add commentary
    function addCommentary(text) {
      const over = Math.floor(gameState.ballsBowled / 6);
      const ball = gameState.ballsBowled % 6;
      
      const commentaryItem = document.createElement('li');
      commentaryItem.className = 'commentary-item';
      commentaryItem.innerHTML = `<span class="commentary-over">${over}.${ball}</span> ${text}`;
      
      commentaryListEl.appendChild(commentaryItem);
      commentaryListEl.scrollTop = commentaryListEl.scrollHeight;
      
      // Try to speak the commentary if TTS is available
      if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.rate = 1.0;
        utterance.pitch = 1.0;
        utterance.volume = 0.8;
        window.speechSynthesis.speak(utterance);
      }
    }

    // Update Firebase scoreboard
    function updateFirebaseScoreboard() {
      const scoreboard = {
        totalRuns: gameState.totalRuns,
        wickets: gameState.wickets,
        overs: gameState.overs,
        currentBatsman: gameState.currentBatsman,
        currentBowler: gameState.currentBowler,
        batsmen: gameState.batsmen,
        bowlers: gameState.bowlers,
        innings: gameState.innings,
        target: gameState.target
      };
      
      set(scoreboardRef, scoreboard);
    }

    // End of over processing
    function endOver() {
      addCommentary(`End of over ${gameState.overs}. Score: ${gameState.totalRuns}/${gameState.wickets}`);
      
      // Update charts
      updateCharts();
      
      // Check for end of innings in limited overs matches
      if (!gameState.isTestMatch) {
        const maxOvers = parseInt(gameState.matchFormat);
        if (gameState.overs >= maxOvers) {
          endInnings();
        }
      }
    }

    // Update charts
    function updateCharts() {
      if (runRateChart) {
        const overNumber = gameState.overs;
        const runRate = gameState.overs > 0 ? (gameState.totalRuns / gameState.overs).toFixed(2) : 0;
        
        runRateChart.data.labels.push(overNumber.toFixed(1));
        runRateChart.data.datasets[0].data.push(parseFloat(runRate));
        runRateChart.update();
      }
    }

    // End of innings processing
    function endInnings() {
      addCommentary(`Innings ended! Final score: ${gameState.totalRuns}/${gameState.wickets}`);
      
      // Calculate target for second innings (if first innings)
      if (gameState.innings === 1) {
        gameState.target = gameState.totalRuns + 1;
        
        // Show innings break overlay
        inningsBreakTitleEl.textContent = 'Innings Break';
        inningsBreakScoreEl.textContent = `${gameState.totalRuns}/${gameState.wickets}`;
        inningsHighlightsEl.innerHTML = generateInningsHighlights();
        inningsBreakOverlay.style.display = 'flex';
      } else {
        // Match completed
        endMatch();
      }
    }

    // Generate innings highlights
    function generateInningsHighlights() {
      // Find top scorer
      let topScorer = { runs: 0 };
      gameState.batsmen.forEach(batsman => {
        if (batsman.runs > topScorer.runs) {
          topScorer = batsman;
        }
      });
      
      // Find best bowler
      let bestBowler = { wickets: 0, runs: Infinity };
      gameState.bowlers.forEach(bowler => {
        const economy = bowler.runs / (bowler.overs + bowler.ballsInOver / 6);
        if (bowler.wickets > bestBowler.wickets || 
            (bowler.wickets === bestBowler.wickets && economy < bestBowler.runs)) {
          bestBowler = {
            name: bowler.name,
            wickets: bowler.wickets,
            runs: bowler.runs,
            economy: economy.toFixed(2)
          };
        }
      });
      
      return `
        <p>Top Scorer: ${topScorer.name} - ${topScorer.runs} runs</p>
        <p>Best Bowler: ${bestBowler.name} - ${bestBowler.wickets}/${bestBowler.runs} (ER: ${bestBowler.economy})</p>
      `;
    }

    // End of day processing (Test matches)
    function endDay() {
      stumpsScoreEl.textContent = `${gameState.totalRuns}/${gameState.wickets}`;
      stumpsOversEl.textContent = gameState.overs.toFixed(1);
      currentDayEl.textContent = gameState.currentDay;
      stumpsSummaryEl.innerHTML = generateStumpsSummary();
      stumpsOverlay.style.display = 'flex';
    }

    // Generate stumps summary
    function generateStumpsSummary() {
      return `
        <p>Day ${gameState.currentDay} comes to a close.</p>
        <p>Run Rate: ${(gameState.totalRuns / gameState.overs).toFixed(2)}</p>
        <p>Required Run Rate: ${(gameState.target > 0 ? ((gameState.target - gameState.totalRuns) / (gameState.testOversPerDay * (5 - gameState.currentDay))).toFixed(2) : 'N/A')}</p>
      `;
    }

    // End of match processing
    function endMatch() {
      // Calculate result
      let resultText = '';
      if (gameState.innings === 2) {
        if (gameState.totalRuns >= gameState.target) {
          const wicketsLeft = 10 - gameState.wickets;
          resultText = `${gameState.battingTeam.name} won by ${wicketsLeft} wicket${wicketsLeft !== 1 ? 's' : ''}!`;
        } else {
          const runsShort = gameState.target - gameState.totalRuns - 1;
          resultText = `${gameState.bowlingTeam.name} won by ${runsShort} run${runsShort !== 1 ? 's' : ''}!`;
        }
      }
      
      // Generate awards
      const awards = computeAwards();
      
      // Show match summary overlay
      matchResultEl.textContent = resultText;
      awardsGridEl.innerHTML = generateAwardsHTML(awards);
      fullScorecardEl.innerHTML = generateFullScorecard();
      matchSummaryOverlay.style.display = 'flex';
    }

    // Compute awards
    function computeAwards() {
      // This would be a more complex function in a real implementation
      return {
        playerOfMatch: gameState.currentBatsman.name,
        topScorer: gameState.currentBatsman.name,
        bestBowler: gameState.currentBowler.name,
        mostSixes: gameState.currentBatsman.name
      };
    }

    // Generate awards HTML
    function generateAwardsHTML(awards) {
      return `
        <div class="award-card">
          <div class="award-icon">üèÜ</div>
          <div class="award-title">Player of the Match</div>
          <div class="award-winner">${awards.playerOfMatch}</div>
        </div>
        <div class="award-card">
          <div class="award-icon">üìä</div>
          <div class="award-title">Top Scorer</div>
          <div class="award-winner">${awards.topScorer}</div>
        </div>
        <div class="award-card">
          <div class="award-icon">üéØ</div>
          <div class="award-title">Best Bowler</div>
          <div class="award-winner">${awards.bestBowler}</div>
        </div>
        <div class="award-card">
          <div class="award-icon">üí•</div>
          <div class="award-title">Most Sixes</div>
          <div class="award-winner">${awards.mostSixes}</div>
        </div>
      `;
    }

    // Generate full scorecard
    function generateFullScorecard() {
      // This would generate a complete scorecard in a real implementation
      return `
        <h4>${gameState.battingTeam.name} ${gameState.totalRuns}/${gameState.wickets} (${gameState.overs} Ov)</h4>
        <p>Full scorecard would be displayed here.</p>
      `;
    }

    // Show batter selection overlay
    function showBatterSelection() {
      availableBattersEl.innerHTML = '';
      
      // Find available batters (not out and not current)
      const availableBatters = gameState.battingTeam.players.filter(player => {
        const isOut = gameState.batsmen.some(b => b.name === player && b.isOut);
        return !isOut && player !== gameState.currentBatsman.name;
      });
      
      if (availableBatters.length === 0) {
        // No available batters (shouldn't happen)
        endInnings();
        return;
      }
      
      // Create selection options
      availableBatters.forEach(batter => {
        const label = document.createElement('label');
        label.innerHTML = `
          <input type="radio" name="newBatter" value="${batter}">
          ${batter}
        `;
        label.addEventListener('change', () => {
          selectedNewBatsman = batter;
          confirmBatterBtn.disabled = false;
        });
        availableBattersEl.appendChild(label);
      });
      
      batterSelectionOverlay.style.display = 'flex';
    }

    // Confirm new batsman selection
    function confirmNewBatsman() {
      if (!selectedNewBatsman) return;
      
      // Set new batsman
      gameState.currentBatsman = {
        name: selectedNewBatsman,
        runs: 0,
        balls: 0,
        fours: 0,
        sixes: 0,
        isOut: false
      };
      
      // Update UI
      batsmanNameEl.textContent = gameState.currentBatsman.name;
      batsmanStatsEl.textContent = `${gameState.currentBatsman.runs} (${gameState.currentBatsman.balls})`;
      
      // Hide overlay
      batterSelectionOverlay.style.display = 'none';
      selectedNewBatsman = null;
      confirmBatterBtn.disabled = true;
      
      addCommentary(`New batter ${gameState.currentBatsman.name} comes to the crease.`);
    }

    // Continue to next innings
    function continueToNextInnings() {
      inningsBreakOverlay.style.display = 'none';
      
      if (gameState.innings === 1) {
        // Switch to second innings
        gameState.innings = 2;
        
        // Swap batting and bowling teams
        const temp = gameState.battingTeam;
        gameState.battingTeam = gameState.bowlingTeam;
        gameState.bowlingTeam = temp;
        
        // Reset score but keep target
        gameState.totalRuns = 0;
        gameState.wickets = 0;
        gameState.ballsBowled = 0;
        gameState.overs = 0;
        gameState.batsmen = [];
        gameState.bowlers = [];
        
        // Update UI
        updateMatchTitle();
        initializeScorecard();
        updateLiveScore();
        
        addCommentary(`Second innings begins. ${gameState.battingTeam.name} needs ${gameState.target} runs to win.`);
      }
    }

    // Continue to next day (Test matches)
    function continueToNextDay() {
      stumpsOverlay.style.display = 'none';
      gameState.currentDay++;
      gameState.overs = 0; // Reset overs for new day
      updateMatchTitle();
      addCommentary(`Day ${gameState.currentDay} begins.`);
    }

    // Declare innings (Test matches)
    function declareInnings() {
      if (!gameState.isTestMatch) return;
      
      gameState.declared = true;
      addCommentary(`${gameState.battingTeam.name} has declared the innings!`);
      endInnings();
    }

    // Enable follow-on (Test matches)
    function enableFollowOn() {
      if (!gameState.isTestMatch) return;
      
      // Check if follow-on is possible (lead of 200+ runs)
      if (gameState.totalRuns >= 200) {
        gameState.followOnEnabled = true;
        addCommentary(`Follow-on has been enforced!`);
        
        // Immediately start next innings
        continueToNextInnings();
      }
    }

    // Undo last ball
    function undoLastBall() {
      // This would be implemented to revert the last event
      addCommentary('Undo feature would be implemented here.');
    }

    // Show settings
    function showSettings() {
      // This would show a settings modal
      alert('Settings would be shown here.');
    }

    // Send chat message
    async function sendChatMessage() {
      const message = chatInputEl.value.trim();
      if (!message) return;
      
      try {
        await push(chatRef, {
          user: username || 'Anonymous',
          message: message,
          timestamp: Date.now()
        });
        
        chatInputEl.value = '';
      } catch (error) {
        console.error('Error sending chat message:', error);
      }
    }

    // Update chat display
    function updateChat(messages) {
      chatMessagesEl.innerHTML = '';
      
      Object.values(messages).forEach(msg => {
        const messageEl = document.createElement('div');
        messageEl.className = 'chat-message';
        messageEl.innerHTML = `<strong>${msg.user}:</strong> ${msg.message}`;
        chatMessagesEl.appendChild(messageEl);
      });
      
      chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
    }

    // Update scoreboard from Firebase
    function updateScoreboard(scoreboard) {
      // This would update the local game state from Firebase
      gameState.totalRuns = scoreboard.totalRuns || 0;
      gameState.wickets = scoreboard.wickets || 0;
      gameState.overs = scoreboard.overs || 0;
      gameState.currentBatsman = scoreboard.currentBatsman || gameState.currentBatsman;
      gameState.currentBowler = scoreboard.currentBowler || gameState.currentBowler;
      gameState.innings = scoreboard.innings || 1;
      gameState.target = scoreboard.target || 0;
      
      updateLiveScore();
      updatePlayerStats();
    }

    // Check for milestones
    function checkMilestones() {
      // Check for 50
      if (gameState.currentBatsman.runs >= 50 && gameState.currentBatsman.runs < 55) {
        showMilestonePopup(`${gameState.currentBatsman.name} scores a FIFTY!`);
      }
      
      // Check for 100
      if (gameState.currentBatsman.runs >= 100 && gameState.currentBatsman.runs < 105) {
        showMilestonePopup(`CENTURY for ${gameState.currentBatsman.name}! What an innings!`);
      }
      
      // Check for 5 wickets
      if (gameState.currentBowler.wickets >= 5) {
        showMilestonePopup(`5-wicket haul for ${gameState.currentBowler.name}! Brilliant bowling!`);
      }
    }

    // Show milestone popup
    function showMilestonePopup(text) {
      const popup = document.createElement('div');
      popup.className = 'milestone-popup';
      popup.textContent = text;
      popup.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.8);
        color: gold;
        font-size: 24px;
        font-weight: bold;
        padding: 20px 40px;
        border-radius: 10px;
        z-index: 2000;
        animation: fadeInOut 3s ease;
      `;
      
      document.body.appendChild(popup);
      
      setTimeout(() => {
        document.body.removeChild(popup);
      }, 3000);
    }

    // Export summary as PDF
    function exportSummaryPDF() {
      // This would use jsPDF to export the match summary
      alert('PDF export would be implemented here.');
    }

    // Start new match
    function startNewMatch() {
      window.location.href = 'index.html';
    }

    // Initialize the game when the page loads
    window.addEventListener('load', initGame);
  </script>
</body>
</html>