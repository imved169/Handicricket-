<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HandiCricket - IPL 2025 Auction</title>
  <style>
    body {
      background: linear-gradient(135deg, #061e3e, #0a2a4a);
      color: white;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      margin: 0;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    h1 {
      color: #ffeb3b;
      text-shadow: 0 0 10px rgba(255, 235, 59, 0.5);
      margin-bottom: 20px;
      text-align: center;
    }
    
    h2 {
      color: #1e88e5;
      margin-top: 30px;
      border-bottom: 2px solid #1e88e5;
      padding-bottom: 8px;
    }
    
    .section {
      display: none;
      margin-bottom: 30px;
    }
    
    .section.active {
      display: block;
    }
    
    .user-info {
      margin-bottom: 20px;
      padding: 15px;
      background: rgba(13, 42, 82, 0.5);
      border-radius: 10px;
      text-align: center;
    }
    
    .user-info p {
      margin: 5px 0;
    }
    
    .user-team {
      font-weight: bold;
      color: #ffeb3b;
    }
    
    .btn {
      padding: 12px 25px;
      border: none;
      border-radius: 8px;
      background: linear-gradient(145deg, #1e88e5, #1565c0);
      color: white;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      margin: 10px 5px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    }
    
    .btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 10px rgba(0, 0, 0, 0.3);
    }
    
    .btn:active {
      transform: translateY(1px);
    }
    
    .btn-primary {
      background: linear-gradient(145deg, #1e88e5, #1565c0);
    }
    
    .btn-success {
      background: linear-gradient(145deg, #4CAF50, #2E7D32);
    }
    
    .btn-danger {
      background: linear-gradient(145deg, #f44336, #d32f2f);
    }
    
    .btn-warning {
      background: linear-gradient(145deg, #FF9800, #F57C00);
    }
    
    .btn-purple {
      background: linear-gradient(145deg, #9C27B0, #7B1FA2);
    }
    
    .btn-gray {
      background: linear-gradient(145deg, #607D8B, #455A64);
    }
    
    .btn-yellow {
      background: linear-gradient(145deg, #FFEB3B, #FBC02D);
      color: #333;
    }
    
    .input-group {
      margin-bottom: 15px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      color: #aaa;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #1e88e5;
      border-radius: 8px;
      background: rgba(30, 136, 229, 0.1);
      color: white;
      font-size: 16px;
      box-sizing: border-box;
    }
    
    select option {
      background: #061e3e;
    }
    
    .card {
      background: rgba(13, 42, 82, 0.5);
      border-radius: 10px;
      padding: 15px;
      margin: 15px 0;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      transition: all 0.3s;
    }
    
    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.3);
    }
    
    .player-card {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin: 20px 0;
    }
    
    .player {
      flex: 1 1 200px;
      padding: 15px;
      background: rgba(13, 42, 82, 0.7);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
      position: relative;
    }
    
    .player.selected {
      border-color: #ffeb3b;
      background: rgba(30, 136, 229, 0.3);
    }
    
    .player.captain {
      border-color: #FFD700;
      background: rgba(255, 215, 0, 0.1);
    }
    
    .player h3 {
      margin-top: 0;
      margin-bottom: 5px;
    }
    
    .player p {
      margin: 5px 0;
      font-size: 14px;
      color: #aaa;
    }
    
    .role-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
      margin-right: 5px;
    }
    
    .batter {
      background-color: #4CAF50;
    }
    
    .pacer {
      background-color: #f44336;
    }
    
    .spinner {
      background-color: #9C27B0;
    }
    
    .all-rounder {
      background-color: #FF9800;
    }
    
    .wicket-keeper {
      background-color: #2196F3;
    }
    
    .auction-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 20px 0;
      justify-content: center;
    }
    
    .bid-btn {
      min-width: 80px;
    }
    
    .current-player {
      background: rgba(30, 136, 229, 0.3);
      border: 2px solid #1e88e5;
      padding: 20px;
      margin: 20px 0;
      border-radius: 10px;
      text-align: center;
    }
    
    .current-player h2 {
      color: #ffeb3b;
      border-bottom: none;
    }
    
    .current-bid {
      font-size: 24px;
      font-weight: bold;
      color: #ffeb3b;
      margin: 10px 0;
    }
    
    .bid-history {
      max-height: 200px;
      overflow-y: auto;
      margin: 15px 0;
      padding: 10px;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
    }
    
    .bid-item {
      padding: 8px;
      margin: 5px 0;
      background: rgba(255,255,255,0.1);
      border-radius: 5px;
    }
    
    .team-info {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin: 20px 0;
    }
    
    .team-card {
      flex: 1 1 300px;
      background: rgba(13, 42, 82, 0.5);
      border-radius: 10px;
      padding: 15px;
    }
    
    .team-card h3 {
      margin-top: 0;
      color: #ffeb3b;
    }
    
    .team-squad {
      list-style: none;
      padding: 0;
      margin: 10px 0;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .team-squad li {
      padding: 5px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px;
      background: rgba(0,0,0,0.7);
      border-left: 4px solid #4CAF50;
      border-radius: 5px;
      color: white;
      z-index: 1000;
      max-width: 300px;
      display: none;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .modal-content {
      background: #0a2a4a;
      padding: 30px;
      border-radius: 10px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .close-modal {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
    }
    
    .loading-spinner {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 3px solid #1e88e5;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    .timer {
      font-size: 24px;
      font-weight: bold;
      color: #ffeb3b;
      text-align: center;
      margin: 15px 0;
    }
    
    .rtm-badge {
      background-color: #9C27B0;
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 12px;
      margin-left: 5px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }
      
      .player {
        flex: 1 1 100%;
      }
      
      .team-card {
        flex: 1 1 100%;
      }
      
      .auction-controls {
        flex-direction: column;
      }
      
      .bid-btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üèè IPL 2025 Auction</h1>
    
    <div class="user-info">
      <p>Team: <span id="teamDisplay" class="user-team"></span></p>
      <p>Budget: <span id="budgetDisplay">‚Çπ150 Cr</span></p>
      <p>RTM Cards: <span id="rtmDisplay">0</span></p>
    </div>
    
    <!-- Retention Section -->
    <div id="retentionSection" class="section active">
      <h2>Player Retention</h2>
      <p>Retain up to 6 players from your previous squad. Captain retention costs ‚Çπ4 Cr, others cost ‚Çπ2 Cr.</p>
      <p>You'll earn RTM (Right-to-Match) cards equal to 6 minus retained players.</p>
      
      <div class="input-group">
        <label>Select Captain (‚Çπ4 Cr)</label>
        <div class="player-card" id="captainSelection"></div>
      </div>
      
      <div class="input-group">
        <label>Select Players to Retain (‚Çπ2 Cr each, max 5 more)</label>
        <div class="player-card" id="playerSelection"></div>
      </div>
      
      <div class="card">
        <h3>Retention Summary</h3>
        <p>Total Retention Cost: <span id="retentionCost">‚Çπ0 Cr</span></p>
        <p>Remaining Budget: <span id="remainingBudget">‚Çπ150 Cr</span></p>
        <p>RTM Cards Earned: <span id="earnedRTM">0</span></p>
        
        <button id="confirmRetentionBtn" class="btn btn-success">Confirm Retention</button>
      </div>
    </div>
    
    <!-- Auction Setup Section (Admin Only) -->
    <div id="setupSection" class="section">
      <h2>Auction Setup</h2>
      <div id="adminSetup" style="display: none;">
        <div class="card">
          <h3>Create Auction Room</h3>
          <button id="createRoomBtn" class="btn btn-primary">Generate Room Code</button>
          <div id="roomCodeDisplay" style="margin-top: 15px; display: none;">
            <p>Share this code with other teams: <strong id="roomCodeSpan"></strong></p>
          </div>
        </div>
        
        <div class="card">
          <h3>Add Players to Auction Pool</h3>
          
          <div class="input-group">
            <label>Add Single Player</label>
            <input type="text" id="playerName" placeholder="Player Name">
            <select id="playerRole">
              <option value="Batter">Batter</option>
              <option value="Pacer">Pacer</option>
              <option value="Spinner">Spinner</option>
              <option value="All-Rounder">All-Rounder</option>
              <option value="Wicket-Keeper">Wicket-Keeper</option>
            </select>
            <input type="number" id="playerBasePrice" placeholder="Base Price (Cr)" step="0.25" min="0.25" value="0.25">
            <button id="addPlayerBtn" class="btn btn-primary">Add Player</button>
          </div>
          
          <div class="input-group">
            <label>Bulk Add Players (CSV format: Name,Role,BasePrice)</label>
            <textarea id="bulkPlayers" rows="10" placeholder="Yash Dayal,Pacer,0.50
Kagiso Rabada,Pacer,0.50
Harshit Rana,Pacer,0.50"></textarea>
            <button id="bulkAddBtn" class="btn btn-primary">Bulk Add Players</button>
          </div>
        </div>
        
        <div class="card">
          <h3>Player Pool</h3>
          <div id="playerPool"></div>
          <button id="startAuctionBtn" class="btn btn-success" style="display: none;">Start Auction</button>
        </div>
      </div>
      
      <div id="nonAdminSetup" style="display: none;">
        <div class="card">
          <h3>Join Auction Room</h3>
          <div class="input-group">
            <label>Enter Room Code</label>
            <input type="text" id="joinRoomCode" placeholder="4-digit code" maxlength="4">
          </div>
          <button id="joinRoomBtn" class="btn btn-primary">Join Room</button>
        </div>
        
        <div id="waitingMessage" style="display: none;">
          <p>Waiting for admin to start the auction...</p>
          <div class="loading-spinner"></div>
        </div>
      </div>
    </div>
    
    <!-- Auction Section -->
    <div id="auctionSection" class="section">
      <h2>Auction in Progress</h2>
      
      <div class="current-player" id="currentPlayerCard">
        <h2 id="currentPlayerName">No player currently</h2>
        <p id="currentPlayerRole"></p>
        <p>Base Price: <span id="currentPlayerPrice">‚Çπ0 Cr</span></p>
        
        <div class="timer" id="auctionTimer">30s</div>
        
        <div class="current-bid" id="currentBidDisplay">No bids yet</div>
        
        <div class="auction-controls" id="auctionControls">
          <button class="btn btn-primary bid-btn" data-increment="0.10">+0.10 Cr</button>
          <button class="btn btn-primary bid-btn" data-increment="0.25">+0.25 Cr</button>
          <button class="btn btn-primary bid-btn" data-increment="0.50">+0.50 Cr</button>
          <button class="btn btn-primary bid-btn" data-increment="1.00">+1.00 Cr</button>
          <button class="btn btn-warning" id="passBtn">Pass</button>
          <button class="btn btn-purple" id="rtmBtn" style="display: none;">Use RTM</button>
        </div>
        
        <div class="bid-history" id="bidHistory"></div>
      </div>
      
      <div id="adminControls" style="display: none;">
        <div class="auction-controls">
          <button class="btn btn-success" id="nextPlayerBtn">Next Player</button>
          <button class="btn btn-danger" id="sellPlayerBtn">Sold</button>
          <button class="btn btn-yellow" id="autoSellBtn">Auto-Sell</button>
        </div>
      </div>
      
      <div class="team-info">
        <div class="team-card">
          <h3>Your Team</h3>
          <p>Budget: <span id="yourBudget">‚Çπ150 Cr</span></p>
          <p>Players: <span id="yourPlayerCount">0</span>/25</p>
          <p>RTM Cards: <span id="yourRTM">0</span></p>
          
          <h4>Your Squad</h4>
          <ul class="team-squad" id="yourSquad"></ul>
        </div>
        
        <div class="team-card">
          <h3>Other Teams</h3>
          <div id="otherTeamsInfo"></div>
        </div>
      </div>
    </div>
    
    <button id="backBtn" class="btn btn-gray">Back to Home</button>
  </div>
  
  <!-- Notification -->
  <div class="notification" id="notification"></div>
  
  <!-- RTM Modal -->
  <div class="modal" id="rtmModal">
    <div class="modal-content">
      <button class="close-modal">&times;</button>
      <h2>Use Right-to-Match (RTM)</h2>
      <p>You can match the current bid for <span id="rtmPlayerName"></span>.</p>
      <p>Current Bid: <span id="rtmCurrentBid"></span></p>
      <p>Your Budget: <span id="rtmYourBudget"></span></p>
      <button id="confirmRTMBtn" class="btn btn-purple">Use RTM Card</button>
      <button id="cancelRTMBtn" class="btn btn-gray">Cancel</button>
    </div>
  </div>
  
  <!-- Final Bid Modal -->
  <div class="modal" id="finalBidModal">
    <div class="modal-content">
      <button class="close-modal">&times;</button>
      <h2>Final Bid Opportunity</h2>
      <p>Another team used RTM for <span id="finalBidPlayerName"></span>.</p>
      <p>You can increase your bid to keep the player.</p>
      <div class="auction-controls">
        <button class="btn btn-primary bid-btn" data-increment="0.10">+0.10 Cr</button>
        <button class="btn btn-primary bid-btn" data-increment="0.25">+0.25 Cr</button>
        <button class="btn btn-primary bid-btn" data-increment="0.50">+0.50 Cr</button>
        <button class="btn btn-primary bid-btn" data-increment="1.00">+1.00 Cr</button>
        <button class="btn btn-gray" id="declineFinalBidBtn">Decline</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getDatabase, ref, set, update, get, child, onValue, push } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCN6aZMwlsZe7JJaovU0WA3UQygWr4jYmA",
      authDomain: "handicricket-85a06.firebaseapp.com",
      projectId: "handicricket-85a06",
      storageBucket: "handicricket-85a06.appspot.com",
      messagingSenderId: "599182538558",
      appId: "1:599182538558:web:3e965753ab05f8f1e3de6f",
      measurementId: "G-HSV9H4LEJQ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // DOM elements
    const teamDisplay = document.getElementById('teamDisplay');
    const budgetDisplay = document.getElementById('budgetDisplay');
    const rtmDisplay = document.getElementById('rtmDisplay');
    
    // Sections
    const retentionSection = document.getElementById('retentionSection');
    const setupSection = document.getElementById('setupSection');
    const auctionSection = document.getElementById('auctionSection');
    
    // Retention elements
    const captainSelection = document.getElementById('captainSelection');
    const playerSelection = document.getElementById('playerSelection');
    const retentionCost = document.getElementById('retentionCost');
    const remainingBudget = document.getElementById('remainingBudget');
    const earnedRTM = document.getElementById('earnedRTM');
    const confirmRetentionBtn = document.getElementById('confirmRetentionBtn');
    
    // Setup elements
    const adminSetup = document.getElementById('adminSetup');
    const nonAdminSetup = document.getElementById('nonAdminSetup');
    const createRoomBtn = document.getElementById('createRoomBtn');
    const roomCodeDisplay = document.getElementById('roomCodeDisplay');
    const roomCodeSpan = document.getElementById('roomCodeSpan');
    const joinRoomCode = document.getElementById('joinRoomCode');
    const joinRoomBtn = document.getElementById('joinRoomBtn');
    const waitingMessage = document.getElementById('waitingMessage');
    const playerName = document.getElementById('playerName');
    const playerRole = document.getElementById('playerRole');
    const playerBasePrice = document.getElementById('playerBasePrice');
    const addPlayerBtn = document.getElementById('addPlayerBtn');
    const bulkPlayers = document.getElementById('bulkPlayers');
    const bulkAddBtn = document.getElementById('bulkAddBtn');
    const playerPool = document.getElementById('playerPool');
    const startAuctionBtn = document.getElementById('startAuctionBtn');
    
    // Auction elements
    const currentPlayerCard = document.getElementById('currentPlayerCard');
    const currentPlayerName = document.getElementById('currentPlayerName');
    const currentPlayerRole = document.getElementById('currentPlayerRole');
    const currentPlayerPrice = document.getElementById('currentPlayerPrice');
    const auctionTimer = document.getElementById('auctionTimer');
    const currentBidDisplay = document.getElementById('currentBidDisplay');
    const bidHistory = document.getElementById('bidHistory');
    const passBtn = document.getElementById('passBtn');
    const rtmBtn = document.getElementById('rtmBtn');
    const adminControls = document.getElementById('adminControls');
    const nextPlayerBtn = document.getElementById('nextPlayerBtn');
    const sellPlayerBtn = document.getElementById('sellPlayerBtn');
    const autoSellBtn = document.getElementById('autoSellBtn');
    const yourBudget = document.getElementById('yourBudget');
    const yourPlayerCount = document.getElementById('yourPlayerCount');
    const yourRTM = document.getElementById('yourRTM');
    const yourSquad = document.getElementById('yourSquad');
    const otherTeamsInfo = document.getElementById('otherTeamsInfo');
    
    // Modals
    const rtmModal = document.getElementById('rtmModal');
    const rtmPlayerName = document.getElementById('rtmPlayerName');
    const rtmCurrentBid = document.getElementById('rtmCurrentBid');
    const rtmYourBudget = document.getElementById('rtmYourBudget');
    const confirmRTMBtn = document.getElementById('confirmRTMBtn');
    const cancelRTMBtn = document.getElementById('cancelRTMBtn');
    const finalBidModal = document.getElementById('finalBidModal');
    const finalBidPlayerName = document.getElementById('finalBidPlayerName');
    const declineFinalBidBtn = document.getElementById('declineFinalBidBtn');
    
    // Notification
    const notification = document.getElementById('notification');
    
    // Back button
    const backBtn = document.getElementById('backBtn');
    
    // Global variables
    let currentUser = localStorage.getItem('hc_username');
    let currentTeam = localStorage.getItem('hc_team');
    let isAdmin = false;
    let roomCode = null;
    let auctionState = null;
    let timerInterval = null;
    let timeLeft = 30;
    let selectedCaptain = null;
    let selectedPlayers = [];
    let retentionCostValue = 0;
    let remainingBudgetValue = 150;
    let rtmCards = 0;
    let currentPlayer = null;
    let currentBid = null;
    let currentBidder = null;
    let yourTeamData = null;
    let otherTeamsData = {};
    let playerPoolData = [];
    let yourSquadData = [];
    let oldSquadData = [];
    
    if (!currentUser || !currentTeam) {
      window.location.href = 'index.html';
    }
    
    // Check if admin (special admin account)
    if (currentUser === 'imved169' && currentTeam === 'Ratnagiri Hunters') {
      isAdmin = true;
    }
    
    // Set team name
    teamDisplay.textContent = currentTeam;
    
    // Load old squad for retention
    const userRef = ref(db, `users/${currentUser}`);
    get(userRef).then((snap) => {
      if (snap.exists()) {
        const userData = snap.val();
        oldSquadData = userData.players || [];
        
        // Display players for retention
        renderRetentionPlayers();
      }
    });
    
    // Render players for retention
    function renderRetentionPlayers() {
      captainSelection.innerHTML = '';
      playerSelection.innerHTML = '';
      
      oldSquadData.forEach(player => {
        const playerEl = document.createElement('div');
        playerEl.className = 'player';
        playerEl.dataset.player = player;
        playerEl.innerHTML = `
          <h3>${player}</h3>
          <button class="btn btn-yellow choose-captain">Choose Captain</button>
        `;
        
        captainSelection.appendChild(playerEl.cloneNode(true));
        
        // For player selection (non-captain)
        const playerEl2 = playerEl.cloneNode(true);
        playerEl2.querySelector('button').remove();
        playerEl2.addEventListener('click', function() {
          if (player === selectedCaptain) return;
          
          if (this.classList.contains('selected')) {
            this.classList.remove('selected');
            selectedPlayers = selectedPlayers.filter(p => p !== player);
          } else if (selectedPlayers.length < 5) {
            this.classList.add('selected');
            selectedPlayers.push(player);
          }
          
          updateRetentionSummary();
        });
        
        playerSelection.appendChild(playerEl2);
      });
      
      // Add captain selection event
      document.querySelectorAll('.choose-captain').forEach(btn => {
        btn.addEventListener('click', function(e) {
          e.stopPropagation();
          const playerEl = this.closest('.player');
          const player = playerEl.dataset.player;
          
          // Remove captain from selected players if they were there
          selectedPlayers = selectedPlayers.filter(p => p !== player);
          
          // Update UI
          document.querySelectorAll('.player').forEach(el => {
            el.classList.remove('captain');
          });
          
          playerEl.classList.add('captain');
          selectedCaptain = player;
          
          // Update player selection UI
          renderRetentionPlayers();
          updateRetentionSummary();
        });
      });
    }
    
    // Update retention summary
    function updateRetentionSummary() {
      retentionCostValue = (selectedCaptain ? 4 : 0) + (selectedPlayers.length * 2);
      remainingBudgetValue = 150 - retentionCostValue;
      rtmCards = 6 - (selectedPlayers.length + (selectedCaptain ? 1 : 0));
      
      retentionCost.textContent = `‚Çπ${retentionCostValue} Cr`;
      remainingBudget.textContent = `‚Çπ${remainingBudgetValue} Cr`;
      earnedRTM.textContent = rtmCards;
    }
    
    // Confirm retention
    confirmRetentionBtn.addEventListener('click', async function() {
      if (selectedPlayers.length + (selectedCaptain ? 1 : 0) > 6) {
        showNotification('You can retain maximum 6 players');
        return;
      }
      
      try {
        // Save retention data to user profile
        await update(userRef, {
          retentionCaptain: selectedCaptain,
          retainedPlayers: selectedPlayers,
          budget: remainingBudgetValue,
          rtmCards: rtmCards
        });
        
        // Update global variables
        yourTeamData = {
          name: currentTeam,
          budget: remainingBudgetValue,
          rtmCards: rtmCards,
          squad: []
        };
        
        // Update UI
        budgetDisplay.textContent = `‚Çπ${remainingBudgetValue} Cr`;
        rtmDisplay.textContent = rtmCards;
        
        // Move to setup section
        retentionSection.classList.remove('active');
        setupSection.classList.add('active');
        
        if (isAdmin) {
          adminSetup.style.display = 'block';
          nonAdminSetup.style.display = 'none';
        } else {
          adminSetup.style.display = 'none';
          nonAdminSetup.style.display = 'block';
        }
        
        showNotification('Retention confirmed!');
      } catch (error) {
        console.error('Error saving retention:', error);
        showNotification('Failed to save retention. Please try again.', 'error');
      }
    });
    
    // Admin: Create room
    createRoomBtn.addEventListener('click', function() {
      roomCode = Math.floor(1000 + Math.random() * 9000);
      roomCodeSpan.textContent = roomCode;
      roomCodeDisplay.style.display = 'block';
      
      // Initialize auction room
      set(ref(db, `auctions/${roomCode}`), {
        admin: currentUser,
        status: 'setup',
        teams: {
          [currentTeam]: yourTeamData
        },
        playerPool: [],
        currentPlayer: null,
        currentBid: null,
        bidHistory: []
      });
      
      showNotification('Auction room created! Share the code with other teams.');
      
      // Listen for changes in the auction room
      setupAuctionListeners();
    });
    
    // Non-admin: Join room
    joinRoomBtn.addEventListener('click', function() {
      const code = joinRoomCode.value.trim();
      
      if (!code || code.length !== 4 || isNaN(code)) {
        showNotification('Please enter a valid 4-digit room code', 'error');
        return;
      }
      
      roomCode = code;
      
      // Check if room exists
      get(ref(db, `auctions/${roomCode}`)).then((snap) => {
        if (!snap.exists()) {
          showNotification('Room not found. Please check the code.', 'error');
          return;
        }
        
        const auctionData = snap.val();
        
        if (auctionData.status !== 'setup') {
          showNotification('Auction has already started', 'error');
          return;
        }
        
        // Join the room
        update(ref(db, `auctions/${roomCode}/teams/${currentTeam}`), yourTeamData)
          .then(() => {
            joinRoomCode.value = '';
            joinRoomBtn.style.display = 'none';
            waitingMessage.style.display = 'block';
            
            showNotification('Joined auction room! Waiting for admin to start...');
            
            // Listen for changes in the auction room
            setupAuctionListeners();
          });
      });
    });
    
    // Admin: Add single player
    addPlayerBtn.addEventListener('click', function() {
      const name = playerName.value.trim();
      const role = playerRole.value;
      const basePrice = parseFloat(playerBasePrice.value);
      
      if (!name) {
        showNotification('Please enter player name', 'error');
        return;
      }
      
      if (isNaN(basePrice) || basePrice < 0.25) {
        showNotification('Base price must be at least ‚Çπ0.25 Cr', 'error');
        return;
      }
      
      const validRoles = ['Batter', 'Pacer', 'Spinner', 'All-Rounder', 'Wicket-Keeper'];
      if (!validRoles.includes(role)) {
        showNotification('Invalid player role', 'error');
        return;
      }
      
      // Add to player pool
      const playerKey = name.toLowerCase().replace(/\s+/g, '_');
      update(ref(db, `auctions/${roomCode}/playerPool/${playerKey}`), {
        name: name,
        role: role,
        basePrice: basePrice,
        status: 'available'
      }).then(() => {
        playerName.value = '';
        playerBasePrice.value = '0.25';
        showNotification('Player added to pool!');
      });
    });
    
    // Admin: Bulk add players
    bulkAddBtn.addEventListener('click', function() {
      const playersText = bulkPlayers.value.trim();
      if (!playersText) {
        showNotification('Please enter players data', 'error');
        return;
      }
      
      const lines = playersText.split('\n');
      const playersToAdd = [];
      const validRoles = ['Batter', 'Pacer', 'Spinner', 'All-Rounder', 'Wicket-Keeper'];
      
      for (const line of lines) {
        const parts = line.split(',');
        if (parts.length !== 3) continue;
        
        const name = parts[0].trim();
        const role = parts[1].trim();
        const basePrice = parseFloat(parts[2].trim());
        
        if (!name || !validRoles.includes(role) || isNaN(basePrice) || basePrice < 0.25) {
          continue;
        }
        
        const playerKey = name.toLowerCase().replace(/\s+/g, '_');
        playersToAdd.push({
          key: playerKey,
          data: {
            name: name,
            role: role,
            basePrice: basePrice,
            status: 'available'
          }
        });
      }
      
      if (playersToAdd.length === 0) {
        showNotification('No valid players found in the input', 'error');
        return;
      }
      
      // Add all players in bulk
      const updates = {};
      playersToAdd.forEach(player => {
        updates[`auctions/${roomCode}/playerPool/${player.key}`] = player.data;
      });
      
      update(ref(db), updates)
        .then(() => {
          bulkPlayers.value = '';
          showNotification(`Added ${playersToAdd.length} players to pool!`);
        });
    });
    
    // Admin: Start auction
    startAuctionBtn.addEventListener('click', function() {
      update(ref(db, `auctions/${roomCode}`), {
        status: 'live',
        currentPlayer: null,
        currentBid: null,
        bidHistory: []
      }).then(() => {
        showNotification('Auction started!');
      });
    });
    
    // Setup auction listeners
    function setupAuctionListeners() {
      const auctionRef = ref(db, `auctions/${roomCode}`);
      
      onValue(auctionRef, (snap) => {
        if (!snap.exists()) {
          showNotification('Auction room has been closed', 'error');
          window.location.reload();
          return;
        }
        
        const data = snap.val();
        auctionState = data.status;
        playerPoolData = data.playerPool ? Object.values(data.playerPool) : [];
        currentPlayer = data.currentPlayer;
        currentBid = data.currentBid;
        currentBidder = data.currentBidder;
        
        // Update player pool display (admin only)
        if (isAdmin && setupSection.classList.contains('active')) {
          renderPlayerPool();
          
          // Show start button if there are players
          startAuctionBtn.style.display = playerPoolData.length > 0 ? 'block' : 'none';
        }
        
        // If auction is live, show auction section
        if (data.status === 'live') {
          setupSection.classList.remove('active');
          auctionSection.classList.add('active');
          
          // Show admin controls if admin
          adminControls.style.display = isAdmin ? 'block' : 'none';
          
          // Update current player display
          updateCurrentPlayerDisplay();
          
          // Update team info
          updateTeamInfo(data.teams);
          
          // Start timer if there's an active player
          if (currentPlayer && !timerInterval) {
            startTimer();
          }
        }
      });
    }
    
    // Render player pool (admin only)
    function renderPlayerPool() {
      playerPool.innerHTML = '';
      
      if (playerPoolData.length === 0) {
        playerPool.innerHTML = '<p>No players in pool yet. Add players above.</p>';
        return;
      }
      
      // Group by role
      const byRole = {
        'Batter': [],
        'Pacer': [],
        'Spinner': [],
        'All-Rounder': [],
        'Wicket-Keeper': []
      };
      
      playerPoolData.forEach(player => {
        byRole[player.role].push(player);
      });
      
      // Render each group
      for (const [role, players] of Object.entries(byRole)) {
        if (players.length === 0) continue;
        
        const roleSection = document.createElement('div');
        roleSection.innerHTML = `<h4>${role}s (${players.length})</h4>`;
        
        const playerList = document.createElement('div');
        playerList.className = 'player-card';
        
        players.forEach(player => {
          const playerEl = document.createElement('div');
          playerEl.className = 'player';
          playerEl.innerHTML = `
            <h3>${player.name}</h3>
            <p><span class="role-badge ${player.role.toLowerCase()}">${player.role}</span></p>
            <p>Base: ‚Çπ${player.basePrice} Cr</p>
          `;
          playerList.appendChild(playerEl);
        });
        
        roleSection.appendChild(playerList);
        playerPool.appendChild(roleSection);
      }
    }
    
    // Update current player display
    function updateCurrentPlayerDisplay() {
      if (!currentPlayer) {
        currentPlayerCard.style.display = 'none';
        return;
      }
      
      currentPlayerCard.style.display = 'block';
      currentPlayerName.textContent = currentPlayer.name;
      currentPlayerRole.textContent = currentPlayer.role;
      currentPlayerRole.className = currentPlayer.role.toLowerCase();
      currentPlayerPrice.textContent = `‚Çπ${currentPlayer.basePrice} Cr`;
      
      // Update current bid display
      if (currentBid) {
        currentBidDisplay.innerHTML = `Current Bid: <strong>‚Çπ${currentBid} Cr</strong> by <strong>${currentBidder}</strong>`;
      } else {
        currentBidDisplay.textContent = 'No bids yet';
      }
      
      // Update bid history
      bidHistory.innerHTML = '';
      if (auctionState.bidHistory && auctionState.bidHistory.length > 0) {
        auctionState.bidHistory.forEach(bid => {
          const bidEl = document.createElement('div');
          bidEl.className = 'bid-item';
          bidEl.textContent = `${bid.team} bid ‚Çπ${bid.amount} Cr`;
          bidHistory.appendChild(bidEl);
        });
      }
      
      // Show RTM button if this player was in your old squad and you have RTM cards
      const wasInOldSquad = oldSquadData.includes(currentPlayer.name);
      const canRTM = wasInOldSquad && yourTeamData.rtmCards > 0;
      rtmBtn.style.display = canRTM ? 'block' : 'none';
    }
    
    // Update team info
    function updateTeamInfo(teams) {
      yourTeamData = teams[currentTeam] || yourTeamData;
      otherTeamsData = {};
      
      for (const [teamName, teamData] of Object.entries(teams)) {
        if (teamName !== currentTeam) {
          otherTeamsData[teamName] = teamData;
        }
      }
      
      // Update your team info
      yourBudget.textContent = `‚Çπ${yourTeamData.budget} Cr`;
      yourPlayerCount.textContent = `${yourTeamData.squad ? yourTeamData.squad.length : 0}/25`;
      yourRTM.textContent = yourTeamData.rtmCards || 0;
      
      // Update your squad
      yourSquad.innerHTML = '';
      if (yourTeamData.squad && yourTeamData.squad.length > 0) {
        yourTeamData.squad.forEach(player => {
          const li = document.createElement('li');
          li.textContent = `${player.name} (‚Çπ${player.price} Cr)`;
          yourSquad.appendChild(li);
        });
      } else {
        yourSquad.innerHTML = '<li>No players yet</li>';
      }
      
      // Update other teams info
      otherTeamsInfo.innerHTML = '';
      
      for (const [teamName, teamData] of Object.entries(otherTeamsData)) {
        const teamEl = document.createElement('div');
        teamEl.className = 'team-card';
        teamEl.innerHTML = `
          <h3>${teamName}</h3>
          <p>Budget: ‚Çπ${teamData.budget} Cr</p>
          <p>Players: ${teamData.squad ? teamData.squad.length : 0}/25</p>
          <p>RTM Cards: ${teamData.rtmCards || 0}</p>
        `;
        otherTeamsInfo.appendChild(teamEl);
      }
    }
    
    // Start timer for current player
    function startTimer() {
      clearInterval(timerInterval);
      timeLeft = 30;
      updateTimerDisplay();
      
      timerInterval = setInterval(() => {
        timeLeft--;
        updateTimerDisplay();
        
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          
          // Auto-sell if admin
          if (isAdmin) {
            sellPlayer();
          }
        }
      }, 1000);
    }
    
    // Update timer display
    function updateTimerDisplay() {
      auctionTimer.textContent = `${timeLeft}s`;
      
      if (timeLeft <= 10) {
        auctionTimer.style.color = '#f44336';
      } else {
        auctionTimer.style.color = '#ffeb3b';
      }
    }
    
    // Place bid
    document.querySelectorAll('.bid-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const increment = parseFloat(this.dataset.increment);
        const newBid = currentBid ? currentBid + increment : currentPlayer.basePrice + increment;
        
        // Check if team can afford this bid
        if (newBid > yourTeamData.budget) {
          showNotification('You don\'t have enough budget for this bid', 'error');
          return;
        }
        
        // Submit bid
        const bidData = {
          team: currentTeam,
          amount: newBid
        };
        
        push(ref(db, `auctions/${roomCode}/bidHistory`), bidData);
        update(ref(db, `auctions/${roomCode}`), {
          currentBid: newBid,
          currentBidder: currentTeam
        });
        
        // Reset timer
        if (timerInterval) {
          startTimer();
        }
      });
    });
    
    // Pass on player
    passBtn.addEventListener('click', function() {
      if (!currentPlayer) return;
      
      // Add to pass history
      push(ref(db, `auctions/${roomCode}/bidHistory`), {
        team: currentTeam,
        action: 'pass'
      });
      
      showNotification(`Passed on ${currentPlayer.name}`);
    });
    
    // Use RTM
    rtmBtn.addEventListener('click', function() {
      if (!currentPlayer || !currentBid) return;
      
      // Check if player was in old squad
      if (!oldSquadData.includes(currentPlayer.name)) {
        showNotification('You can only use RTM on players from your previous squad', 'error');
        return;
      }
      
      // Check if you have RTM cards
      if (yourTeamData.rtmCards <= 0) {
        showNotification('You have no RTM cards left', 'error');
        return;
      }
      
      // Check if you can afford the bid
      if (currentBid > yourTeamData.budget) {
        showNotification('You don\'t have enough budget for this RTM', 'error');
        return;
      }
      
      // Show RTM confirmation modal
      rtmPlayerName.textContent = currentPlayer.name;
      rtmCurrentBid.textContent = `‚Çπ${currentBid} Cr`;
      rtmYourBudget.textContent = `‚Çπ${yourTeamData.budget} Cr`;
      rtmModal.style.display = 'flex';
    });
    
    // Confirm RTM
    confirmRTMBtn.addEventListener('click', function() {
      // Use RTM - this will trigger the original bidder's final bid opportunity
      update(ref(db, `auctions/${roomCode}`), {
        rtmUsed: {
          by: currentTeam,
          forPlayer: currentPlayer.name,
          amount: currentBid
        }
      }).then(() => {
        rtmModal.style.display = 'none';
        showNotification(`Used RTM for ${currentPlayer.name}`);
      });
    });
    
    // Cancel RTM
    cancelRTMBtn.addEventListener('click', function() {
      rtmModal.style.display = 'none';
    });
    
    // Admin: Next player
    nextPlayerBtn.addEventListener('click', function() {
      // Find next available player
      const availablePlayers = playerPoolData.filter(p => p.status === 'available');
      if (availablePlayers.length === 0) {
        showNotification('No more players in pool', 'error');
        return;
      }
      
      // Select first available player
      const nextPlayer = availablePlayers[0];
      
      // Update auction state
      update(ref(db, `auctions/${roomCode}`), {
        currentPlayer: nextPlayer,
        currentBid: null,
        currentBidder: null,
        bidHistory: []
      }).then(() => {
        startTimer();
      });
    });
    
    // Admin: Sell player
    sellPlayerBtn.addEventListener('click', function() {
      sellPlayer();
    });
    
    // Admin: Auto-sell
    autoSellBtn.addEventListener('click', function() {
      // Sell to highest bidder with 10s timer
      timeLeft = 10;
      updateTimerDisplay();
    });
    
    // Sell player to highest bidder
    function sellPlayer() {
      if (!currentPlayer || !currentBidder) {
        // No bids - player goes unsold
        update(ref(db, `auctions/${roomCode}/playerPool/${currentPlayer.name.toLowerCase().replace(/\s+/g, '_')}`), {
          status: 'unsold'
        }).then(() => {
          return update(ref(db, `auctions/${roomCode}`), {
            currentPlayer: null,
            currentBid: null,
            currentBidder: null
          });
        }).then(() => {
          showNotification(`${currentPlayer.name} went unsold`);
          clearInterval(timerInterval);
        });
        return;
      }
      
      // Update winning team's squad and budget
      const winningTeamRef = ref(db, `auctions/${roomCode}/teams/${currentBidder}`);
      get(winningTeamRef).then((snap) => {
        const teamData = snap.val();
        const updatedSquad = [...(teamData.squad || []), {
          name: currentPlayer.name,
          role: currentPlayer.role,
          price: currentBid
        }];
        
        const updatedBudget = teamData.budget - currentBid;
        
        return update(winningTeamRef, {
          squad: updatedSquad,
          budget: updatedBudget
        });
      }).then(() => {
        // Mark player as sold
        return update(ref(db, `auctions/${roomCode}/playerPool/${currentPlayer.name.toLowerCase().replace(/\s+/g, '_')}`), {
          status: 'sold',
          soldTo: currentBidder,
          price: currentBid
        });
      }).then(() => {
        // Clear current player
        return update(ref(db, `auctions/${roomCode}`), {
          currentPlayer: null,
          currentBid: null,
          currentBidder: null
        });
      }).then(() => {
        showNotification(`${currentPlayer.name} sold to ${currentBidder} for ‚Çπ${currentBid} Cr`);
        clearInterval(timerInterval);
      });
    }
    
    // Close modals when clicking X
    document.querySelectorAll('.close-modal').forEach(btn => {
      btn.addEventListener('click', function() {
        this.closest('.modal').style.display = 'none';
      });
    });
    
    // Close modals when clicking outside
    window.addEventListener('click', function(e) {
      if (e.target.classList.contains('modal')) {
        e.target.style.display = 'none';
      }
    });
    
    // Back button
    backBtn.addEventListener('click', function() {
      window.location.href = 'index.html';
    });
    
    // Show notification
    function showNotification(message, type = 'success') {
      notification.textContent = message;
      notification.style.display = 'block';
      notification.style.borderLeftColor = type === 'error' ? '#f44336' : '#4CAF50';
      
      setTimeout(() => {
        notification.style.display = 'none';
      }, 3000);
    }
  </script>
</body>
</html>