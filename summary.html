<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Match Summary</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background: #001F3F;
      color: white;
      text-align: center;
      padding: 2rem;
      max-width: 800px;
      margin: 0 auto;
    }
    .summary-container {
      background: rgba(0, 50, 100, 0.7);
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    .heatmap-container {
      display: grid;
      grid-template-columns: repeat(10, 1fr);
      gap: 2px;
      margin: 20px auto;
      max-width: 600px;
    }
    .heatmap-zone {
      height: 20px;
      border-radius: 2px;
      transition: transform 0.2s;
    }
    .heatmap-zone:hover {
      transform: scale(1.5);
      z-index: 10;
    }
    button {
      padding: 10px 20px;
      margin: 10px;
      background: #0074D9;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1rem;
      transition: background 0.3s;
    }
    button:hover {
      background: #0056b3;
    }
    .xp-meter {
      margin: 20px auto;
      width: 80%;
      background: #333;
      border-radius: 10px;
      height: 20px;
      overflow: hidden;
    }
    .xp-progress {
      height: 100%;
      background: linear-gradient(90deg, #FF851B, #FF4136);
      width: 0%;
      transition: width 1s;
    }
  </style>
</head>
<body>
  <div class="summary-container">
    <h2>🏁 Match Summary</h2>
    <div id="resultText" style="font-size: 1.5rem; margin: 1rem 0;"></div>
    <div id="mvpText" style="font-size: 1.2rem;"></div>
    <button onclick="shareSummary()">📤 Share Result</button>
    <button onclick="showHeatmapLegend()">🛑 Heatmap Legend</button>
  </div>

  <!-- XP Progress Bar -->
  <div class="xp-meter">
    <div id="xpProgress" class="xp-progress"></div>
  </div>
  <div id="xpText" style="font-size: 0.9rem;"></div>

  <!-- Heatmap -->
  <h3>🔥 Shot Distribution Heatmap</h3>
  <div id="heatmap" class="heatmap-container"></div>

  <script type="module">
    import { db, ref, onValue } from './firebase.js';

    const urlParams = new URLSearchParams(window.location.search);
    const matchCode = urlParams.get("match") || localStorage.getItem("roomCode");

    const summaryRef = ref(db, `rooms/${matchCode}/summary`);
    onValue(summaryRef, (snapshot) => {
      const data = snapshot.val();
      if (data) {
        document.getElementById("resultText").innerText = "Result: " + data.result;
        document.getElementById("mvpText").innerText = "MVP: " + data.mvp;
      } else {
        document.getElementById("resultText").innerText = "Summary not found.";
      }
    });

    window.shareSummary = function () {
      const shareURL = `${window.location.origin}/summary.html?match=${matchCode}`;
      navigator.clipboard.writeText(shareURL).then(() => {
        alert("✅ Summary link copied to clipboard:\n" + shareURL);
      });
    };

    window.showHeatmapLegend = function() {
      alert("Heatmap Legend:\n\n🔴 High scoring areas (70-80%)\n🟠 Medium scoring areas (50-70%)\n🟡 Low scoring areas (30-50%)\n🟢 Rarely scored (below 30%)");
    };
  </script>

  <script>
    // Enhanced Heatmap with realistic cricket distribution
    function generateHeatmap() {
      const container = document.getElementById("heatmap");
      container.innerHTML = '';
      
      // Realistic cricket shot distribution data
      const zones = [
        // Off side (right-handed batsman perspective)
        [10, 15, 20, 25, 30, 35, 40, 45, 50, 55],   // Third man to fine leg
        [15, 20, 25, 30, 35, 40, 45, 50, 55, 60],   // Gully to square leg
        [20, 25, 30, 35, 40, 45, 50, 55, 60, 65],   // Point to mid wicket
        [25, 30, 35, 40, 45, 50, 55, 60, 65, 70],   // Cover to mid on
        [30, 35, 40, 45, 50, 55, 60, 65, 70, 75],   // Extra cover to long on
        
        // On side
        [35, 40, 45, 50, 55, 60, 65, 70, 75, 80],   // Fine leg to long off
        [30, 35, 40, 45, 50, 55, 60, 65, 70, 75],   // Square leg to extra cover
        [25, 30, 35, 40, 45, 50, 55, 60, 65, 70],   // Mid wicket to cover
        [20, 25, 30, 35, 40, 45, 50, 55, 60, 65],   // Mid on to point
        [15, 20, 25, 30, 35, 40, 45, 50, 55, 60]     // Long on to third man
      ];
      
      zones.forEach((row, rowIndex) => {
        row.forEach((intensity, colIndex) => {
          const zone = document.createElement("div");
          zone.className = "heatmap-zone";
          
          // More realistic color gradient
          let hue;
          if (intensity > 70) hue = 0;    // Red for high scoring
          else if (intensity > 50) hue = 20;   // Orange
          else if (intensity > 30) hue = 40;   // Yellow
          else hue = 80;   // Green for low scoring
          
          zone.style.background = `hsl(${hue}, 100%, ${100 - intensity/2}%)`;
          
          // Position labels for key zones
          let position = "";
          if (rowIndex === 0 && colIndex === 9) position = "Fine Leg";
          if (rowIndex === 4 && colIndex === 5) position = "Long On";
          if (rowIndex === 5 && colIndex === 5) position = "Long Off";
          if (rowIndex === 2 && colIndex === 2) position = "Point";
          
          zone.title = `${position ? position+": " : ""}${intensity}% of shots`;
          container.appendChild(zone);
        });
      });
    }

    // XP System
    function initializeXP() {
      if (!localStorage.getItem('playerXP')) {
        localStorage.setItem('playerXP', '0');
      }
      updateXPMeter();
    }

    function addXP(points) {
      const currentXP = parseInt(localStorage.getItem('playerXP'));
      const newXP = currentXP + points;
      localStorage.setItem('playerXP', newXP.toString());
      updateXPMeter();
      
      // Check for level up
      const level = Math.floor(newXP / 100);
      if (level > Math.floor(currentXP / 100)) {
        alert(`🎉 Level Up! You've reached Level ${level}`);
      }
    }

    function updateXPMeter() {
      const xp = parseInt(localStorage.getItem('playerXP'));
      const level = Math.floor(xp / 100);
      const currentLevelXP = xp % 100;
      
      document.getElementById('xpProgress').style.width = `${currentLevelXP}%`;
      document.getElementById('xpText').innerText = `Level ${level} | ${currentLevelXP}/100 XP`;
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      generateHeatmap();
      initializeXP();
      addXP(10);  // Add XP for viewing summary
    });
  </script>
</body>
</html>
