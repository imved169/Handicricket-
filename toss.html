<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Toss | HandiCricket</title>
  <style>
    body {
      background: #061e3e;
      color: white;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      text-align: center;
      padding: 20px;
      margin: 0;
    }
    
    .container {
      max-width: 500px;
      margin: 0 auto;
      padding: 20px;
      background: rgba(13, 42, 82, 0.6);
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }
    
    h1 {
      margin: 0 0 20px;
      color: #ffeb3b;
      text-shadow: 0 0 5px rgba(255, 235, 59, 0.5);
    }
    
    .info-box {
      background: rgba(30, 136, 229, 0.2);
      padding: 12px;
      border-radius: 8px;
      margin: 15px 0;
      border-left: 3px solid #1e88e5;
    }
    
    .btn {
      padding: 12px 24px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      background: #1e88e5;
      color: white;
      cursor: pointer;
      margin: 8px;
      transition: all 0.2s;
      font-weight: bold;
    }
    
    .btn:hover {
      background: #1565c0;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    .btn:disabled {
      background: #607d8b;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .btn-primary {
      background: #4CAF50;
    }
    
    .btn-primary:hover {
      background: #388E3C;
    }
    
    .btn-danger {
      background: #f44336;
    }
    
    .btn-danger:hover {
      background: #d32f2f;
    }
    
    .coin {
      width: 100px;
      height: 100px;
      background: linear-gradient(145deg, #FFD700, #FFA500);
      border-radius: 50%;
      margin: 25px auto;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 24px;
      font-weight: bold;
      color: #000;
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
      position: relative;
      overflow: hidden;
    }
    
    .coin.spinning {
      animation: spin 0.5s linear infinite;
    }
    
    @keyframes spin {
      from { transform: rotateY(0deg); }
      to { transform: rotateY(360deg); }
    }
    
    .section {
      margin: 20px 0;
      padding: 15px;
      border-radius: 8px;
      background: rgba(0, 0, 0, 0.1);
    }
    
    .hidden {
      display: none;
    }
    
    .player-badge {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 15px;
      background: #1e88e5;
      font-weight: bold;
      margin: 0 5px;
    }
    
    .winner-badge {
      background: #4CAF50;
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    #toss-result {
      font-size: 18px;
      margin: 20px 0;
      min-height: 60px;
    }
    
    #batting-choice {
      margin-top: 20px;
    }
    
    .status-message {
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }
    
    .status-waiting {
      background: rgba(255, 235, 59, 0.2);
      border-left: 3px solid #FFC107;
    }
    
    .status-success {
      background: rgba(76, 175, 80, 0.2);
      border-left: 3px solid #4CAF50;
    }
    
    .status-error {
      background: rgba(244, 67, 54, 0.2);
      border-left: 3px solid #f44336;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üèè Match Toss</h1>
    
    <div class="info-box">
      <div id="room-info">Room Code: Loading...</div>
      <div id="format-info">Match Format: Loading...</div>
      <div id="player-info">You are: Loading...</div>
    </div>
    
    <!-- Initial waiting state -->
    <div id="waiting-section" class="section">
      <div class="status-message status-waiting">
        Waiting for both players to join...
      </div>
    </div>
    
    <!-- Toss calling section -->
    <div id="call-section" class="section hidden">
      <div id="call-instruction"></div>
      <div id="call-buttons" class="hidden">
        <button id="heads-btn" class="btn">Heads</button>
        <button id="tails-btn" class="btn">Tails</button>
      </div>
      <div id="flip-button" class="hidden">
        <button id="flip-btn" class="btn btn-primary">Flip Coin</button>
      </div>
    </div>
    
    <!-- Coin display -->
    <div id="coin" class="coin hidden">TOSS</div>
    
    <!-- Toss result section -->
    <div id="result-section" class="section hidden">
      <div id="toss-result"></div>
      
      <div id="choice-section" class="hidden">
        <div id="choice-instruction"></div>
        <div id="choice-buttons">
          <button id="bat-btn" class="btn btn-primary">Bat First</button>
          <button id="bowl-btn" class="btn">Bowl First</button>
        </div>
      </div>
      
      <div id="waiting-choice" class="status-message status-waiting hidden">
        Waiting for opponent to choose...
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getDatabase, ref, set, get, update, onValue, off } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCN6aZMwlsZe7JJaovU0WA3UQygWr4jYmA",
      authDomain: "handicricket-85a06.firebaseapp.com",
      projectId: "handicricket-85a06",
      storageBucket: "handicricket-85a06.appspot.com",
      messagingSenderId: "599182538558",
      appId: "1:599182538558:web:3e965753ab05f8f1e3de6f"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Get URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const roomId = urlParams.get('room');
    const playerRole = urlParams.get('player');
    const opponentRole = playerRole === 'player1' ? 'player2' : 'player1';

    // DOM elements
    const elements = {
      roomInfo: document.getElementById('room-info'),
      formatInfo: document.getElementById('format-info'),
      playerInfo: document.getElementById('player-info'),
      waitingSection: document.getElementById('waiting-section'),
      callSection: document.getElementById('call-section'),
      callInstruction: document.getElementById('call-instruction'),
      callButtons: document.getElementById('call-buttons'),
      flipButton: document.getElementById('flip-button'),
      coin: document.getElementById('coin'),
      resultSection: document.getElementById('result-section'),
      tossResult: document.getElementById('toss-result'),
      choiceSection: document.getElementById('choice-section'),
      choiceInstruction: document.getElementById('choice-instruction'),
      waitingChoice: document.getElementById('waiting-choice'),
      headsBtn: document.getElementById('heads-btn'),
      tailsBtn: document.getElementById('tails-btn'),
      flipBtn: document.getElementById('flip-btn'),
      batBtn: document.getElementById('bat-btn'),
      bowlBtn: document.getElementById('bowl-btn')
    };

    // Game state
    const state = {
      tossCompleted: false,
      choiceMade: false,
      format: '5'
    };

    // Initialize the page
    function initPage() {
      // Set basic info
      elements.roomInfo.textContent = `Room Code: ${roomId}`;
      elements.playerInfo.textContent = `You are: ${playerRole.toUpperCase()}`;
      
      // Set up event listeners
      setupEventListeners();
      
      // Initialize Firebase listeners
      setupFirebaseListeners();
      
      // Mark player as ready
      markPlayerReady();
    }

    // Set up event listeners
    function setupEventListeners() {
      // Toss call buttons
      elements.headsBtn.addEventListener('click', () => makeTossCall('heads'));
      elements.tailsBtn.addEventListener('click', () => makeTossCall('tails'));
      
      // Coin flip button
      elements.flipBtn.addEventListener('click', flipCoin);
      
      // Batting choice buttons
      elements.batBtn.addEventListener('click', () => makeBattingChoice('bat'));
      elements.bowlBtn.addEventListener('click', () => makeBattingChoice('bowl'));
    }

    // Set up Firebase listeners
    function setupFirebaseListeners() {
      // Listen for format changes
      const formatRef = ref(db, `rooms/${roomId}/player1/format`);
      onValue(formatRef, (snap) => {
        if (snap.exists()) {
          state.format = snap.val();
          updateFormatDisplay();
        }
      });
      
      // Listen for player readiness
      const player1ReadyRef = ref(db, `rooms/${roomId}/player1/ready`);
      const player2ReadyRef = ref(db, `rooms/${roomId}/player2/ready`);
      
      onValue(player1ReadyRef, (snap) => checkPlayersReady());
      onValue(player2ReadyRef, (snap) => checkPlayersReady());
      
      // Listen for toss state changes
      const tossRef = ref(db, `rooms/${roomId}/toss`);
      onValue(tossRef, (snap) => {
        if (!snap.exists()) return;
        
        const tossData = snap.val();
        
        if (tossData.status === 'called') {
          handleTossCalled(tossData);
        } else if (tossData.status === 'complete' && !state.tossCompleted) {
          state.tossCompleted = true;
          showTossResult(tossData);
        }
      });
      
      // Listen for game start
      const gameStatusRef = ref(db, `rooms/${roomId}/gameStatus`);
      onValue(gameStatusRef, (snap) => {
        if (snap.exists() && snap.val() === 'in-progress' && !state.choiceMade) {
          redirectToGame();
        }
      });
    }

    // Mark player as ready in Firebase
    function markPlayerReady() {
      set(ref(db, `rooms/${roomId}/${playerRole}/ready`), true)
        .catch(error => {
          console.error('Error marking player ready:', error);
          showError('Failed to connect to game server');
        });
    }

    // Check if both players are ready
    async function checkPlayersReady() {
      try {
        const [p1, p2] = await Promise.all([
          get(ref(db, `rooms/${roomId}/player1/ready`)),
          get(ref(db, `rooms/${roomId}/player2/ready`))
        ]);
        
        if (p1.exists() && p1.val() && p2.exists() && p2.val()) {
          // Both players ready - show toss options
          elements.waitingSection.classList.add('hidden');
          elements.callSection.classList.remove('hidden');
          
          // Check current toss state
          const tossSnap = await get(ref(db, `rooms/${roomId}/toss`));
          if (!tossSnap.exists() || tossSnap.val().status === 'waiting') {
            // No toss in progress - show call options for player1
            if (playerRole === 'player1') {
              elements.callInstruction.textContent = 'Call Heads or Tails:';
              elements.callButtons.classList.remove('hidden');
            } else {
              elements.callInstruction.textContent = 'Waiting for Player 1 to call...';
            }
          } else if (tossSnap.val().status === 'called') {
            handleTossCalled(tossSnap.val());
          }
        }
      } catch (error) {
        console.error('Error checking player readiness:', error);
        showError('Failed to check player status');
      }
    }

    // Update format display
    function updateFormatDisplay() {
      const formatNames = {
        '5': '5 Overs',
        '10': '10 Overs',
        '20': 'T20',
        '50': 'ODI',
        'test': 'Test Match'
      };
      elements.formatInfo.textContent = `Match Format: ${formatNames[state.format] || 'Custom'}`;
    }

    // Make a toss call (heads or tails)
    async function makeTossCall(call) {
      if (playerRole !== 'player1') {
        showError('Only Player 1 can call the toss');
        return;
      }
      
      try {
        await update(ref(db, `rooms/${roomId}/toss`), {
          caller: playerRole,
          call: call,
          status: 'called'
        });
        
        elements.callButtons.classList.add('hidden');
        elements.callInstruction.textContent = `You called ${call}. Waiting for opponent to flip...`;
      } catch (error) {
        console.error('Error making toss call:', error);
        showError('Failed to register toss call');
      }
    }

    // Handle when toss has been called
    function handleTossCalled(tossData) {
      if (playerRole === 'player1') {
        elements.callInstruction.textContent = `You called ${tossData.call}. Waiting for opponent to flip...`;
        elements.callButtons.classList.add('hidden');
      } else {
        elements.callInstruction.textContent = `Player 1 called ${tossData.call}. Flip the coin:`;
        elements.flipButton.classList.remove('hidden');
      }
    }

    // Flip the coin and determine result
    async function flipCoin() {
      if (playerRole !== 'player2') {
        showError('Only Player 2 can flip the coin');
        return;
      }
      
      try {
        // Disable flip button during animation
        elements.flipBtn.disabled = true;
        
        // Show spinning coin
        elements.coin.classList.remove('hidden');
        elements.coin.classList.add('spinning');
        elements.coin.textContent = 'FLIPPING...';
        
        // Get current toss data
        const tossSnap = await get(ref(db, `rooms/${roomId}/toss`));
        if (!tossSnap.exists() || tossSnap.val().status !== 'called') {
          throw new Error('Toss not properly called');
        }
        
        const tossData = tossSnap.val();
        
        // Generate random result (50/50 chance)
        const result = Math.random() < 0.5 ? 'heads' : 'tails';
        const winner = (result === tossData.call) ? tossData.caller : opponentRole;
        
        // Update database with result
        await update(ref(db, `rooms/${roomId}`), {
          tossWinner: winner,
          'toss/result': result,
          'toss/winner': winner,
          'toss/status': 'complete',
          'toss/flippedBy': playerRole
        });
        
        // Stop spinning and show result after delay
        setTimeout(() => {
          elements.coin.classList.remove('spinning');
          elements.coin.textContent = result.toUpperCase();
          showTossResult({
            result: result,
            winner: winner,
            call: tossData.call,
            caller: tossData.caller
          });
          elements.flipBtn.disabled = false;
        }, 1500);
      } catch (error) {
        console.error('Error flipping coin:', error);
        showError('Failed to complete toss');
        elements.flipBtn.disabled = false;
        elements.coin.classList.remove('spinning');
      }
    }

    // Show the toss result and next steps
    function showTossResult(tossData) {
      elements.callSection.classList.add('hidden');
      elements.resultSection.classList.remove('hidden');
      
      const resultText = `Toss was <strong>${tossData.result.toUpperCase()}</strong>. ` +
                        `<span class="player-badge ${tossData.winner === playerRole ? 'winner-badge' : ''}">` +
                        `${tossData.winner === playerRole ? 'YOU' : tossData.winner.toUpperCase()}</span> won the toss!`;
      
      elements.tossResult.innerHTML = resultText;
      
      if (tossData.winner === playerRole) {
        // This player won - show batting choice
        elements.choiceSection.classList.remove('hidden');
        elements.waitingChoice.classList.add('hidden');
        elements.choiceInstruction.textContent = 'Choose to bat or bowl first:';
      } else {
        // Opponent won - wait for their choice
        elements.choiceSection.classList.add('hidden');
        elements.waitingChoice.classList.remove('hidden');
      }
    }

    // Make batting/bowling choice
    async function makeBattingChoice(choice) {
      if (state.choiceMade) return;
      state.choiceMade = true;
      
      try {
        // Verify teams are set up
        const teamsSnap = await get(ref(db, `rooms/${roomId}/teams`));
        if (!teamsSnap.exists() || !teamsSnap.val().player1 || !teamsSnap.val().player2) {
          throw new Error('Both teams must be set up before starting');
        }
        
        // Verify teams have 11 players each
        const team1 = teamsSnap.val().player1;
        const team2 = teamsSnap.val().player2;
        
        if (!team1.players || !team2.players || 
            team1.players.length !== 11 || team2.players.length !== 11) {
          throw new Error('Each team must have exactly 11 players');
        }
        
        // Update game state with batting/bowling choices
        await update(ref(db, `rooms/${roomId}`), {
          battingFirst: choice === 'bat' ? playerRole : opponentRole,
          bowlingFirst: choice === 'bowl' ? playerRole : opponentRole,
          gameStatus: 'in-progress',
          tossWinner: playerRole, // Set the toss winner
          'toss/battingFirst': choice === 'bat' ? playerRole : opponentRole,
          'toss/bowlingFirst': choice === 'bowl' ? playerRole : opponentRole
        });
        
        // Redirect to game page
        redirectToGame();
      } catch (error) {
        console.error('Error making batting choice:', error);
        showError(error.message);
        state.choiceMade = false;
        
        // If teams aren't set up, redirect to team selection
        if (error.message.includes('teams must be set up') || 
            error.message.includes('exactly 11 players')) {
          window.location.href = `playing11.html?room=${roomId}&player=${playerRole}`;
        }
      }
    }

    // Redirect to appropriate game page
    function redirectToGame() {
      window.location.href = `game_first_innings.html?room=${roomId}&player=${playerRole}`;
    }

    // Show error message
    function showError(message) {
      const errorEl = document.createElement('div');
      errorEl.className = 'status-message status-error';
      errorEl.textContent = message;
      document.querySelector('.container').prepend(errorEl);
      
      setTimeout(() => errorEl.remove(), 5000);
    }

    // Initialize the page when loaded
    window.addEventListener('DOMContentLoaded', initPage);
  </script>
</body>
</html>
