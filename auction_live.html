<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HandiCricket - Live Auction</title>
  <style>
    body {
      background: linear-gradient(135deg, #061e3e, #0a2a4a);
      color: white;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      text-align: center;
      padding: 20px;
      margin: 0;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    h1 {
      color: #ffeb3b;
      text-shadow: 0 0 10px rgba(255, 235, 59, 0.5);
      margin-bottom: 20px;
    }
    
    .user-info {
      margin-bottom: 20px;
      padding: 15px;
      background: rgba(13, 42, 82, 0.5);
      border-radius: 10px;
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    
    .user-info-item {
      margin: 5px 10px;
    }
    
    .user-team {
      font-weight: bold;
      color: #ffeb3b;
    }
    
    .budget-amount {
      font-weight: bold;
      color: #4CAF50;
    }
    
    .rtm-display {
      display: inline-block;
      padding: 5px 10px;
      background: rgba(255, 152, 0, 0.2);
      border-radius: 20px;
    }
    
    .current-player {
      margin: 20px 0;
      padding: 20px;
      background: rgba(30, 136, 229, 0.2);
      border-radius: 10px;
      border: 2px solid #1e88e5;
    }
    
    .current-player h2 {
      margin-top: 0;
      color: #ffeb3b;
    }
    
    .player-stats {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 15px 0;
    }
    
    .player-stat {
      padding: 10px 15px;
      background: rgba(13, 42, 82, 0.5);
      border-radius: 8px;
    }
    
    .player-stat-value {
      font-weight: bold;
      font-size: 18px;
      color: #ffeb3b;
    }
    
    .bid-section {
      margin: 20px 0;
    }
    
    .current-bid {
      font-size: 24px;
      margin: 10px 0;
    }
    
    .bid-amount {
      font-weight: bold;
      color: #ff9800;
    }
    
    .bidder {
      font-weight: bold;
      color: #1e88e5;
    }
    
    .timer {
      font-size: 36px;
      margin: 15px 0;
      color: #ffeb3b;
    }
    
    .bid-controls {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin: 20px 0;
    }
    
    .btn {
      padding: 12px 25px;
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    }
    
    .btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 10px rgba(0, 0, 0, 0.3);
    }
    
    .btn:active {
      transform: translateY(1px);
    }
    
    .btn-bid {
      background: linear-gradient(145deg, #4CAF50, #2E7D32);
    }
    
    .btn-rtm {
      background: linear-gradient(145deg, #FF9800, #F57C00);
    }
    
    .btn-pass {
      background: linear-gradient(145deg, #607D8B, #455A64);
    }
    
    .btn-sold {
      background: linear-gradient(145deg, #9C27B0, #7B1FA2);
    }
    
    .btn-unsold {
      background: linear-gradient(145deg, #f44336, #d32f2f);
    }
    
    .bid-input {
      padding: 12px;
      border: 1px solid #1e88e5;
      border-radius: 8px;
      background: rgba(30, 136, 229, 0.1);
      color: white;
      font-size: 16px;
      width: 100px;
      text-align: center;
    }
    
    .bid-history {
      max-height: 300px;
      overflow-y: auto;
      margin: 20px 0;
      text-align: left;
    }
    
    .bid-item {
      padding: 10px;
      margin: 5px 0;
      background: rgba(30, 136, 229, 0.2);
      border-radius: 5px;
    }
    
    .bid-item.sold {
      background: rgba(76, 175, 80, 0.2);
    }
    
    .bid-item.rtm {
      background: rgba(255, 152, 0, 0.2);
    }
    
    .bid-item.pass {
      background: rgba(96, 125, 139, 0.2);
    }
    
    .teams-section {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    
    .team-card {
      background: rgba(13, 42, 82, 0.5);
      border-radius: 10px;
      padding: 15px;
      text-align: left;
    }
    
    .team-card h3 {
      margin-top: 0;
      color: #ffeb3b;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding-bottom: 8px;
    }
    
    .team-players {
      max-height: 200px;
      overflow-y: auto;
    }
    
    .team-player {
      padding: 8px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .team-player-price {
      float: right;
      color: #4CAF50;
    }
    
    .team-budget {
      margin-top: 10px;
      font-weight: bold;
    }
    
    .admin-controls {
      margin: 20px 0;
      padding: 15px;
      background: rgba(255, 235, 59, 0.1);
      border-radius: 10px;
      border: 1px solid rgba(255, 235, 59, 0.3);
    }
    
    .error-message {
      color: #f44336;
      margin: 10px 0;
    }
    
    .success-message {
      color: #4CAF50;
      margin: 10px 0;
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }
      
      .bid-controls {
        flex-wrap: wrap;
      }
      
      .teams-section {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üèè Live Auction</h1>
    
    <div class="user-info">
      <div class="user-info-item">
        Room: <span id="roomCodeDisplay" class="user-team"></span>
      </div>
      <div class="user-info-item">
        Team: <span id="teamDisplay" class="user-team"></span>
      </div>
      <div class="user-info-item">
        Budget: <span id="budgetDisplay" class="budget-amount"></span>
      </div>
      <div class="user-info-item">
        RTM: <span id="rtmDisplay" class="rtm-display">0</span>
      </div>
    </div>
    
    <div class="current-player" id="currentPlayerSection" style="display: none;">
      <h2 id="currentPlayerName"></h2>
      <div class="player-stats">
        <div class="player-stat">
          <div>Role</div>
          <div class="player-stat-value" id="playerRole"></div>
        </div>
        <div class="player-stat">
          <div>Country</div>
          <div class="player-stat-value" id="playerCountry"></div>
        </div>
        <div class="player-stat">
          <div>Base Price</div>
          <div class="player-stat-value">‚Çπ2 Cr</div>
        </div>
      </div>
    </div>
    
    <div class="bid-section">
      <div class="timer" id="timer">30</div>
      <div class="current-bid">
        Current Bid: <span class="bid-amount" id="currentBidAmount">‚Çπ0 Cr</span>
        by <span class="bidder" id="currentBidder">None</span>
      </div>
      
      <div class="bid-controls" id="bidControls">
        <input type="number" class="bid-input" id="bidAmount" min="2" max="100" value="2" step="0.5">
        <button id="placeBidBtn" class="btn btn-bid">Place Bid</button>
        <button id="useRtmBtn" class="btn btn-rtm">Use RTM</button>
        <button id="passBtn" class="btn btn-pass">Pass</button>
      </div>
      
      <div class="admin-controls" id="adminControls" style="display: none;">
        <button id="soldBtn" class="btn btn-sold">Sold</button>
        <button id="unsoldBtn" class="btn btn-unsold">Unsold</button>
      </div>
    </div>
    
    <div class="bid-history" id="bidHistory"></div>
    
    <div class="teams-section" id="teamsSection"></div>
    
    <p class="error-message" id="errorMessage"></p>
    <p class="success-message" id="successMessage"></p>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getDatabase, ref, set, update, get, child, onValue, off } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCN6aZMwlsZe7JJaovU0WA3UQygWr4jYmA",
      authDomain: "handicricket-85a06.firebaseapp.com",
      projectId: "handicricket-85a06",
      storageBucket: "handicricket-85a06.appspot.com",
      messagingSenderId: "599182538558",
      appId: "1:599182538558:web:3e965753ab05f8f1e3de6f",
      measurementId: "G-HSV9H4LEJQ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const currentUser = localStorage.getItem('hc_username');
    const currentTeam = localStorage.getItem('hc_team');
    const params = new URLSearchParams(window.location.search);
    const roomCode = params.get('room');
    
    if (!currentUser || !currentTeam || !roomCode) {
      window.location.href = 'index.html';
    }
    
    // DOM elements
    const roomCodeDisplay = document.getElementById('roomCodeDisplay');
    const teamDisplay = document.getElementById('teamDisplay');
    const budgetDisplay = document.getElementById('budgetDisplay');
    const rtmDisplay = document.getElementById('rtmDisplay');
    const currentPlayerSection = document.getElementById('currentPlayerSection');
    const currentPlayerName = document.getElementById('currentPlayerName');
    const playerRole = document.getElementById('playerRole');
    const playerCountry = document.getElementById('playerCountry');
    const timerDisplay = document.getElementById('timer');
    const currentBidAmount = document.getElementById('currentBidAmount');
    const currentBidder = document.getElementById('currentBidder');
    const bidAmountInput = document.getElementById('bidAmount');
    const placeBidBtn = document.getElementById('placeBidBtn');
    const useRtmBtn = document.getElementById('useRtmBtn');
    const passBtn = document.getElementById('passBtn');
    const adminControls = document.getElementById('adminControls');
    const soldBtn = document.getElementById('soldBtn');
    const unsoldBtn = document.getElementById('unsoldBtn');
    const bidHistory = document.getElementById('bidHistory');
    const teamsSection = document.getElementById('teamsSection');
    const errorMessage = document.getElementById('errorMessage');
    const successMessage = document.getElementById('successMessage');
    
    let userData = {};
    let auctionState = {};
    let currentPlayerData = null;
    let countdownInterval = null;
    let isAdmin = false;
    let userTeamData = {};
    
    // Set room info
    roomCodeDisplay.textContent = roomCode;
    teamDisplay.textContent = currentTeam;
    
    // Load user data
    async function loadUserData() {
      try {
        const userRef = ref(db, `users/${currentUser}`);
        const userSnap = await get(userRef);
        
        if (userSnap.exists()) {
          userData = userSnap.val();
          budgetDisplay.textContent = `‚Çπ${userData.auctionBudget || 0} Cr`;
          rtmDisplay.textContent = userData.rtmCards || 0;
        }
      } catch (error) {
        console.error("Error loading user data:", error);
        showError("Failed to load user data");
      }
    }
    
    // Check if user is admin
    async function checkAdminStatus() {
      try {
        const roomRef = ref(db, `auctionRooms/${roomCode}/admin`);
        const adminSnap = await get(roomRef);
        
        if (adminSnap.exists() && adminSnap.val() === currentUser) {
          isAdmin = true;
          adminControls.style.display = 'block';
        }
      } catch (error) {
        console.error("Error checking admin status:", error);
      }
    }
    
    // Load auction state
    function loadAuctionState() {
      const stateRef = ref(db, `auctionState/${roomCode}`);
      
      onValue(stateRef, (snap) => {
        if (snap.exists()) {
          auctionState = snap.val();
          updateAuctionUI();
        }
      });
    }
    
    // Load teams data
    function loadTeamsData() {
      const teamsRef = ref(db, `auctionRooms/${roomCode}/participants`);
      
      onValue(teamsRef, (snap) => {
        if (snap.exists()) {
          const participants = snap.val();
          updateTeamsUI(participants);
          
          // Update our team data if available
          if (participants[currentUser]) {
            userTeamData = participants[currentUser];
            budgetDisplay.textContent = `‚Çπ${userTeamData.budget || 0} Cr`;
            rtmDisplay.textContent = userTeamData.rtmCards || 0;
          }
        }
      });
    }
    
    // Update auction UI
    function updateAuctionUI() {
      // Update current player
      if (auctionState.currentPlayer) {
        loadPlayerDetails(auctionState.currentPlayer);
        currentPlayerSection.style.display = 'block';
      } else {
        currentPlayerSection.style.display = 'none';
      }
      
      // Update current bid
      if (auctionState.currentBid) {
        currentBidAmount.textContent = `‚Çπ${auctionState.currentBid} Cr`;
        currentBidder.textContent = auctionState.currentBidder || 'None';
      }
      
      // Update timer if active
      if (auctionState.timerEndsAt) {
        startCountdown(auctionState.timerEndsAt);
      } else {
        clearInterval(countdownInterval);
        timerDisplay.textContent = '--';
      }
      
      // Update bid history
      updateBidHistory();
    }
    
    // Load player details
    async function loadPlayerDetails(playerId) {
      try {
        const playerRef = ref(db, `players/${playerId}`);
        const playerSnap = await get(playerRef);
        
        if (playerSnap.exists()) {
          currentPlayerData = playerSnap.val();
          currentPlayerName.textContent = currentPlayerData.name;
          playerRole.textContent = currentPlayerData.role.toUpperCase();
          playerCountry.textContent = currentPlayerData.country;
        }
      } catch (error) {
        console.error("Error loading player details:", error);
      }
    }
    
    // Start countdown timer
    function startCountdown(endTime) {
      clearInterval(countdownInterval);
      
      const updateTimer = () => {
        const now = Date.now();
        const remaining = Math.max(0, Math.floor((endTime - now) / 1000));
        
        if (remaining <= 0) {
          timerDisplay.textContent = '0';
          clearInterval(countdownInterval);
        } else {
          timerDisplay.textContent = remaining;
        }
      };
      
      updateTimer();
      countdownInterval = setInterval(updateTimer, 1000);
    }
    
    // Update bid history
    function updateBidHistory() {
      bidHistory.innerHTML = '';
      
      if (!auctionState.bidHistory) return;
      
      Object.entries(auctionState.bidHistory).forEach(([playerId, bids]) => {
        const playerBids = Array.isArray(bids) ? bids : [bids];
        
        playerBids.forEach(bid => {
          const bidItem = document.createElement('div');
          bidItem.className = `bid-item ${bid.status || ''}`;
          
          let bidText = `${bid.playerName} - ‚Çπ${bid.amount} Cr by ${bid.team}`;
          if (bid.status === 'sold') bidText += ' (SOLD)';
          if (bid.status === 'rtm') bidText += ' (RTM)';
          if (bid.status === 'pass') bidText += ' (PASS)';
          
          bidItem.textContent = bidText;
          bidHistory.appendChild(bidItem);
        });
      });
    }
    
    // Update teams UI
    function updateTeamsUI(participants) {
      teamsSection.innerHTML = '';
      
      Object.entries(participants).forEach(([username, team]) => {
        const teamCard = document.createElement('div');
        teamCard.className = 'team-card';
        
        let playersList = '';
        if (team.players) {
          Object.entries(team.players).forEach(([playerName, price]) => {
            playersList += `
              <div class="team-player">
                ${playerName} <span class="team-player-price">‚Çπ${price} Cr</span>
              </div>
            `;
          });
        }
        
        teamCard.innerHTML = `
          <h3>${team.team} ${username === currentUser ? '(You)' : ''}</h3>
          <div class="team-players">
            ${playersList || '<p>No players yet</p>'}
          </div>
          <div class="team-budget">
            Budget Left: ‚Çπ${team.budget || 0} Cr
            ${team.rtmCards ? ` | RTM: ${team.rtmCards}` : ''}
          </div>
        `;
        
        teamsSection.appendChild(teamCard);
      });
    }
    
    // Place bid
    placeBidBtn.addEventListener('click', async () => {
      const bidAmount = parseFloat(bidAmountInput.value);
      
      if (isNaN(bidAmount) || bidAmount < 2) {
        showError("Minimum bid is ‚Çπ2 Cr");
        return;
      }
      
      if (bidAmount > userTeamData.budget) {
        showError("You don't have enough budget");
        return;
      }
      
      if (!auctionState.currentPlayer) {
        showError("No player is currently being auctioned");
        return;
      }
      
      try {
        const bidData = {
          amount: bidAmount,
          team: currentTeam,
          username: currentUser,
          playerId: auctionState.currentPlayer,
          playerName: currentPlayerData.name,
          timestamp: Date.now()
        };
        
        // Add to bid history
        const bidHistoryPath = `auctionState/${roomCode}/bidHistory/${auctionState.currentPlayer}`;
        const bidHistoryRef = ref(db, bidHistoryPath);
        const historySnap = await get(bidHistoryRef);
        
        let newHistory = [];
        if (historySnap.exists()) {
          newHistory = Array.isArray(historySnap.val()) ? historySnap.val() : [historySnap.val()];
        }
        newHistory.push(bidData);
        
        // Update auction state
        await update(ref(db, `auctionState/${roomCode}`), {
          currentBid: bidAmount,
          currentBidder: currentTeam,
          timerEndsAt: Date.now() + 30000, // 30 seconds
          [`bidHistory/${auctionState.currentPlayer}`]: newHistory
        });
        
        showSuccess(`Bid placed for ‚Çπ${bidAmount} Cr`);
      } catch (error) {
        console.error("Error placing bid:", error);
        showError("Failed to place bid. Please try again.");
      }
    });
    
    // Use RTM
    useRtmBtn.addEventListener('click', async () => {
      if (userTeamData.rtmCards <= 0) {
        showError("You don't have any RTM cards left");
        return;
      }
      
      if (!auctionState.currentPlayer) {
        showError("No player is currently being auctioned");
        return;
      }
      
      if (!auctionState.currentBid) {
        showError("No active bid to use RTM on");
        return;
      }
      
      try {
        const bidData = {
          amount: auctionState.currentBid,
          team: currentTeam,
          username: currentUser,
          playerId: auctionState.currentPlayer,
          playerName: currentPlayerData.name,
          status: "rtm",
          timestamp: Date.now()
        };
        
        // Add to bid history
        const bidHistoryPath = `auctionState/${roomCode}/bidHistory/${auctionState.currentPlayer}`;
        const bidHistoryRef = ref(db, bidHistoryPath);
        const historySnap = await get(bidHistoryRef);
        
        let newHistory = [];
        if (historySnap.exists()) {
          newHistory = Array.isArray(historySnap.val()) ? historySnap.val() : [historySnap.val()];
        }
        newHistory.push(bidData);
        
        // Update auction state
        await update(ref(db, `auctionState/${roomCode}`), {
          currentBid: null,
          currentBidder: null,
          timerEndsAt: null,
          [`bidHistory/${auctionState.currentPlayer}`]: newHistory
        });
        
        // Update team data (reduce RTM cards and budget)
        await update(ref(db, `auctionRooms/${roomCode}/participants/${currentUser}`), {
          rtmCards: userTeamData.rtmCards - 1,
          budget: userTeamData.budget - auctionState.currentBid,
          [`players/${currentPlayerData.name}`]: auctionState.currentBid
        };
        
        showSuccess(`Used RTM to buy ${currentPlayerData.name} for ‚Çπ${auctionState.currentBid} Cr`);
      } catch (error) {
        console.error("Error using RTM:", error);
        showError("Failed to use RTM. Please try again.");
      }
    });
    
    // Pass
    passBtn.addEventListener('click', async () => {
      if (!auctionState.currentPlayer) {
        showError("No player is currently being auctioned");
        return;
      }
      
      try {
        const bidData = {
          team: currentTeam,
          username: currentUser,
          playerId: auctionState.currentPlayer,
          playerName: currentPlayerData.name,
          status: "pass",
          timestamp: Date.now()
        };
        
        // Add to bid history
        const bidHistoryPath = `auctionState/${roomCode}/bidHistory/${auctionState.currentPlayer}`;
        const bidHistoryRef = ref(db, bidHistoryPath);
        const historySnap = await get(bidHistoryRef);
        
        let newHistory = [];
        if (historySnap.exists()) {
          newHistory = Array.isArray(historySnap.val()) ? historySnap.val() : [historySnap.val()];
        }
        newHistory.push(bidData);
        
        await update(ref(db, `auctionState/${roomCode}/bidHistory/${auctionState.currentPlayer}`), newHistory;
        
        showSuccess(`Passed on ${currentPlayerData.name}`);
      } catch (error) {
        console.error("Error passing:", error);
        showError("Failed to pass. Please try again.");
      }
    });
    
    // Sold (admin only)
    soldBtn.addEventListener('click', async () => {
      if (!auctionState.currentPlayer) {
        showError("No player is currently being auctioned");
        return;
      }
      
      if (!auctionState.currentBidder) {
        showError("No active bidder to sell to");
        return;
      }
      
      try {
        // Find the winning bidder's username
        const participantsRef = ref(db, `auctionRooms/${roomCode}/participants`);
        const participantsSnap = await get(participantsRef);
        let winnerUsername = null;
        
        if (participantsSnap.exists()) {
          const participants = participantsSnap.val();
          winnerUsername = Object.keys(participants).find(
            username => participants[username].team === auctionState.currentBidder
          );
        }
        
        if (!winnerUsername) {
          showError("Could not find winning bidder");
          return;
        }
        
        // Update bid history
        const bidData = {
          amount: auctionState.currentBid,
          team: auctionState.currentBidder,
          username: winnerUsername,
          playerId: auctionState.currentPlayer,
          playerName: currentPlayerData.name,
          status: "sold",
          timestamp: Date.now()
        };
        
        const bidHistoryPath = `auctionState/${roomCode}/bidHistory/${auctionState.currentPlayer}`;
        const bidHistoryRef = ref(db, bidHistoryPath);
        const historySnap = await get(bidHistoryRef);
        
        let newHistory = [];
        if (historySnap.exists()) {
          newHistory = Array.isArray(historySnap.val()) ? historySnap.val() : [historySnap.val()];
        }
        newHistory.push(bidData);
        
        // Update auction state
        await update(ref(db, `auctionState/${roomCode}`), {
          currentPlayer: null,
          currentBid: null,
          currentBidder: null,
          timerEndsAt: null,
          [`bidHistory/${auctionState.currentPlayer}`]: newHistory,
          [`soldPlayers/${auctionState.currentPlayer}`]: {
            name: currentPlayerData.name,
            team: auctionState.currentBidder,
            price: auctionState.currentBid,
            soldAt: Date.now()
          }
        });
        
        // Update winner's team data
        await update(ref(db, `auctionRooms/${roomCode}/participants/${winnerUsername}`), {
          budget: userTeamData.budget - auctionState.currentBid,
          [`players/${currentPlayerData.name}`]: auctionState.currentBid
        });
        
        showSuccess(`Sold ${currentPlayerData.name} to ${auctionState.currentBidder} for ‚Çπ${auctionState.currentBid} Cr`);
      } catch (error) {
        console.error("Error selling player:", error);
        showError("Failed to sell player. Please try again.");
      }
    });
    
    // Unsold (admin only)
    unsoldBtn.addEventListener('click', async () => {
      if (!auctionState.currentPlayer) {
        showError("No player is currently being auctioned");
        return;
      }
      
      try {
        // Update auction state
        await update(ref(db, `auctionState/${roomCode}`), {
          currentPlayer: null,
          currentBid: null,
          currentBidder: null,
          timerEndsAt: null,
          [`unsoldPlayers/${auctionState.currentPlayer}`]: {
            name: currentPlayerData.name,
            unsoldAt: Date.now()
          }
        });
        
        showSuccess(`Marked ${currentPlayerData.name} as unsold`);
      } catch (error) {
        console.error("Error marking unsold:", error);
        showError("Failed to mark player as unsold. Please try again.");
      }
    });
    
    // Helper functions
    function showError(message) {
      errorMessage.textContent = message;
      successMessage.textContent = '';
    }
    
    function showSuccess(message) {
      successMessage.textContent = message;
      errorMessage.textContent = '';
    }
    
    // Initialize
    loadUserData();
    checkAdminStatus();
    loadAuctionState();
    loadTeamsData();
  </script>
</body>
  </html>
