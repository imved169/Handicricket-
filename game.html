<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HandiCricket - Match</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #1e88e5;
      --primary-dark: #1565c0;
      --secondary: #ffeb3b;
      --secondary-dark: #fbc02d;
      --success: #4CAF50;
      --success-dark: #2E7D32;
      --warning: #FF9800;
      --warning-dark: #F57C00;
      --danger: #f44336;
      --danger-dark: #d32f2f;
      --purple: #9C27B0;
      --purple-dark: #7B1FA2;
      --brown: #795548;
      --brown-dark: #5D4037;
      --teal: #009688;
      --teal-dark: #00796B;
      --dark-blue: #061e3e;
      --medium-blue: #0a2a4a;
      --light-blue: #0f3a64;
      --gray: #607D8B;
      --gray-dark: #455A64;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      background: linear-gradient(135deg, var(--dark-blue), var(--medium-blue));
      color: white;
      font-family: 'Poppins', sans-serif;
      text-align: center;
      padding: 15px;
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    
    .container {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .match-info {
      text-align: left;
      flex: 1;
    }
    
    .match-title {
      color: var(--secondary);
      text-shadow: 0 0 15px rgba(255, 235, 59, 0.6);
      font-size: 1.8rem;
      font-weight: 700;
      letter-spacing: 1px;
      margin-bottom: 5px;
    }
    
    .match-details {
      font-size: 14px;
      color: #ccc;
    }
    
    .room-code {
      background: rgba(13, 42, 82, 0.6);
      padding: 8px 15px;
      border-radius: 10px;
      font-weight: 600;
      color: var(--secondary);
      font-size: 16px;
    }
    
    .scoreboard {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      background: rgba(13, 42, 82, 0.6);
      padding: 20px;
      border-radius: 15px;
      border-left: 4px solid var(--primary);
    }
    
    .team-score {
      flex: 1;
      padding: 0 15px;
    }
    
    .team-name {
      font-weight: 600;
      font-size: 18px;
      margin-bottom: 8px;
      color: var(--secondary);
    }
    
    .score {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 5px;
    }
    
    .overs {
      font-size: 14px;
      color: #ccc;
    }
    
    .vs {
      display: flex;
      align-items: center;
      padding: 0 15px;
      font-weight: bold;
      color: var(--secondary);
      font-size: 20px;
    }
    
    .game-controls {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .control-panel {
      background: rgba(13, 42, 82, 0.6);
      padding: 20px;
      border-radius: 15px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .control-panel h3 {
      margin: 0 0 15px 0;
      color: var(--secondary);
      border-bottom: 2px solid var(--primary);
      padding-bottom: 10px;
      font-size: 1.2rem;
    }
    
    .player-select {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 15px;
    }
    
    .player-select select {
      padding: 12px 15px;
      border-radius: 8px;
      border: 2px solid var(--primary);
      background: rgba(255, 255, 255, 0.9);
      font-size: 14px;
      font-family: 'Poppins', sans-serif;
    }
    
    .card-selection {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-top: 15px;
    }
    
    .card {
      aspect-ratio: 3/4;
      background: white;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: bold;
      color: #333;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 15px rgba(0,0,0,0.3);
    }
    
    .card.selected {
      border: 3px solid var(--secondary);
      box-shadow: 0 0 15px rgba(255, 235, 59, 0.5);
    }
    
    .card.zero {
      background: linear-gradient(145deg, #f0f0f0, #e0e0e0);
    }
    
    .card.one { background: #e3f2fd; }
    .card.two { background: #bbdefb; }
    .card.three { background: #90caf9; }
    .card.four { background: #64b5f6; }
    .card.five { background: #42a5f5; }
    .card.six { background: #2196f3; }
    
    .card.glow {
      animation: glow 1s ease;
    }
    
    .card.shake {
      animation: shake 0.5s ease;
    }
    
    .action-buttons {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 20px;
    }
    
    .btn {
      padding: 14px;
      border: none;
      border-radius: 10px;
      color: white;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      font-family: 'Poppins', sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
    }
    
    .btn:active {
      transform: translateY(1px);
    }
    
    .btn-submit {
      background: linear-gradient(145deg, var(--success), var(--success-dark));
    }
    
    .btn-batting {
      background: linear-gradient(145deg, var(--warning), var(--warning-dark));
    }
    
    .btn-bowling {
      background: linear-gradient(145deg, var(--primary), var(--primary-dark));
    }
    
    .btn-next {
      background: linear-gradient(145deg, var(--purple), var(--purple-dark));
    }
    
    .game-status {
      margin: 20px 0;
      padding: 15px;
      background: rgba(13, 42, 82, 0.6);
      border-radius: 12px;
      font-size: 16px;
      border-left: 4px solid var(--primary);
    }
    
    .commentary {
      margin: 20px 0;
      padding: 15px;
      background: rgba(13, 42, 82, 0.6);
      border-radius: 12px;
      text-align: left;
      max-height: 200px;
      overflow-y: auto;
      font-size: 14px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .commentary-item {
      margin: 8px 0;
      padding: 8px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .commentary-item:last-child {
      border-bottom: none;
    }
    
    .mini-scorecard {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.7);
      padding: 15px;
      border-radius: 10px;
      font-size: 14px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      z-index: 100;
    }
    
    .mini-score {
      font-weight: bold;
      color: var(--secondary);
      font-size: 16px;
    }
    
    .player-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin: 20px 0;
    }
    
    .stats-panel {
      background: rgba(13, 42, 82, 0.6);
      padding: 15px;
      border-radius: 12px;
      text-align: left;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .stats-panel h3 {
      margin: 0 0 12px 0;
      color: var(--secondary);
      border-bottom: 2px solid var(--primary);
      padding-bottom: 8px;
      font-size: 1.1rem;
    }
    
    .stats-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    
    .stats-table th, .stats-table td {
      padding: 8px 5px;
      text-align: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .stats-table th {
      font-weight: 600;
      color: var(--secondary);
    }
    
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(5px);
    }
    
    .modal-content {
      background: linear-gradient(145deg, var(--dark-blue), var(--medium-blue));
      padding: 30px;
      border-radius: 20px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .modal h2 {
      color: var(--secondary);
      margin-bottom: 20px;
      font-size: 1.8rem;
    }
    
    .modal p {
      margin: 10px 0;
      line-height: 1.6;
    }
    
    .modal-actions {
      display: flex;
      gap: 15px;
      margin-top: 25px;
      justify-content: center;
    }
    
    .modal-btn {
      padding: 12px 25px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .modal-btn-primary {
      background: linear-gradient(145deg, var(--success), var(--success-dark));
      color: white;
    }
    
    .modal-btn-secondary {
      background: linear-gradient(145deg, var(--danger), var(--danger-dark));
      color: white;
    }
    
    .innings-break {
      background: rgba(255, 235, 59, 0.2);
      padding: 20px;
      border-radius: 12px;
      margin: 20px 0;
      border: 1px solid rgba(255, 235, 59, 0.3);
    }
    
    @keyframes glow {
      0% { box-shadow: 0 0 5px rgba(255, 235, 59, 0.5); }
      50% { box-shadow: 0 0 20px rgba(255, 235, 59, 0.8); }
      100% { box-shadow: 0 0 5px rgba(255, 235, 59, 0.5); }
    }
    
    @keyframes shake {
      0% { transform: translateX(0); }
      20% { transform: translateX(-10px); }
      40% { transform: translateX(10px); }
      60% { transform: translateX(-10px); }
      80% { transform: translateX(10px); }
      100% { transform: translateX(0); }
    }
    
    @media (max-width: 992px) {
      .game-controls {
        grid-template-columns: 1fr;
      }
      
      .player-stats {
        grid-template-columns: 1fr;
      }
    }
    
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        gap: 15px;
      }
      
      .match-info {
        text-align: center;
      }
      
      .scoreboard {
        flex-direction: column;
        gap: 20px;
      }
      
      .vs {
        padding: 15px 0;
      }
      
      .card-selection {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    
    @media (max-width: 480px) {
      .container {
        padding: 15px;
      }
      
      .card-selection {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .modal-content {
        padding: 20px;
      }
      
      .modal-actions {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="match-info">
        <h1 class="match-title" id="matchTitle">HandiCricket Match</h1>
        <div class="match-details" id="matchDetails">Format: T20 | Innings: 1 of 2</div>
      </div>
      <div class="room-code" id="roomCodeDisplay">Room: 1234</div>
    </div>
    
    <div class="scoreboard">
      <div class="team-score">
        <div class="team-name" id="battingTeamName">Batting Team</div>
        <div class="score" id="battingScore">0/0</div>
        <div class="overs" id="battingOvers">Overs: 0.0</div>
      </div>
      <div class="vs">VS</div>
      <div class="team-score">
        <div class="team-name" id="bowlingTeamName">Bowling Team</div>
        <div class="score" id="bowlingScore">0/0</div>
        <div class="overs" id="bowlingOvers">Overs: 0.0</div>
      </div>
    </div>
    
    <div class="game-status" id="gameStatus">
      <i class="fas fa-info-circle"></i> Waiting for both teams to select players...
    </div>
    
    <div class="game-controls">
      <div class="control-panel">
        <h3><i class="fas fa-user"></i> Batting Control</h3>
        <div class="player-select">
          <label for="batterSelect">Select Batter:</label>
          <select id="batterSelect">
            <option value="">Choose a batter</option>
          </select>
        </div>
        <div id="battingCardSelection">
          <p>Select your batting card:</p>
          <div class="card-selection">
            <div class="card zero" data-value="0">0</div>
            <div class="card one" data-value="1">1</div>
            <div class="card two" data-value="2">2</div>
            <div class="card three" data-value="3">3</div>
            <div class="card four" data-value="4">4</div>
            <div class="card five" data-value="5">5</div>
            <div class="card six" data-value="6">6</div>
          </div>
        </div>
        <div class="action-buttons">
          <button id="submitBatterBtn" class="btn btn-batting" disabled>Submit Batter Selection</button>
          <button id="nextBatterBtn" class="btn btn-next" style="display: none;">Next Batter</button>
        </div>
      </div>
      
      <div class="control-panel">
        <h3><i class="fas fa-baseball-ball"></i> Bowling Control</h3>
        <div class="player-select">
          <label for="bowlerSelect">Select Bowler:</label>
          <select id="bowlerSelect">
            <option value="">Choose a bowler</option>
          </select>
        </div>
        <div id="bowlingCardSelection">
          <p>Select your bowling card:</p>
          <div class="card-selection">
            <div class="card zero" data-value="0">0</div>
            <div class="card one" data-value="1">1</div>
            <div class="card two" data-value="2">2</div>
            <div class="card three" data-value="3">3</div>
            <div class="card four" data-value="4">4</div>
            <div class="card five" data-value="5">5</div>
            <div class="card six" data-value="6">6</div>
          </div>
        </div>
        <div class="action-buttons">
          <button id="submitBowlerBtn" class="btn btn-bowling" disabled>Submit Bowler Selection</button>
          <button id="nextBowlerBtn" class="btn btn-next" style="display: none;">Next Over</button>
        </div>
      </div>
    </div>
    
    <div class="commentary" id="commentaryBox">
      <div class="commentary-item">Welcome to HandiCricket! The match is about to begin.</div>
    </div>
    
    <div class="player-stats">
      <div class="stats-panel">
        <h3><i class="fas fa-bat"></i> Batting Stats</h3>
        <table class="stats-table" id="battingStats">
          <thead>
            <tr>
              <th>Batter</th>
              <th>R</th>
              <th>B</th>
              <th>4s</th>
              <th>6s</th>
              <th>SR</th>
            </tr>
          </thead>
          <tbody>
            <!-- Will be populated dynamically -->
          </tbody>
        </table>
      </div>
      
      <div class="stats-panel">
        <h3><i class="fas fa-baseball-ball"></i> Bowling Stats</h3>
        <table class="stats-table" id="bowlingStats">
          <thead>
            <tr>
              <th>Bowler</th>
              <th>O</th>
              <th>M</th>
              <th>R</th>
              <th>W</th>
              <th>ER</th>
            </tr>
          </thead>
          <tbody>
            <!-- Will be populated dynamically -->
          </tbody>
        </table>
      </div>
    </div>
    
    <div class="innings-break" id="inningsBreak" style="display: none;">
      <h3>Innings Break</h3>
      <p id="inningsSummary">First innings completed. Team X scored Y runs.</p>
      <button id="startSecondInningsBtn" class="btn btn-submit">Start Second Innings</button>
    </div>
    
    <div class="mini-scorecard" id="miniScorecard">
      <div class="mini-score" id="miniScore">0/0 (0.0)</div>
      <div class="mini-details" id="miniDetails">RR: 0.00 | CRR: 0.00</div>
    </div>
  </div>

  <!-- Match Result Modal -->
  <div class="modal" id="resultModal" style="display: none;">
    <div class="modal-content">
      <h2 id="resultTitle">Match Result</h2>
      <div id="resultDetails">
        <p>Team A won by X runs/wickets</p>
        <p>Top Scorer: Player Name (X runs)</p>
        <p>Best Bowler: Player Name (X wickets)</p>
        <p>Player of the Match: Player Name</p>
      </div>
      <div class="modal-actions">
        <button id="viewSummaryBtn" class="modal-btn modal-btn-primary">View Match Summary</button>
        <button id="backToLobbyBtn" class="modal-btn modal-btn-secondary">Back to Lobby</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, get, push } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCN6aZMwlsZe7JJaovU0WA3UQygWr4jYmA",
      authDomain: "handicricket-85a06.firebaseapp.com",
      projectId: "handicricket-85a06",
      storageBucket: "handicricket-85a06.appspot.com",
      messagingSenderId: "599182538558",
      appId: "1:599182538558:web:3e965753ab05f8f1e3de6f",
      measurementId: "G-HSV9H4LEJQ"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Get URL parameters
    const params = new URLSearchParams(window.location.search);
    const roomId = params.get('room');
    const playerRole = params.get('player');
    const teamName = decodeURIComponent(params.get('team') || '');

    if (!roomId || !playerRole) {
      alert('Invalid room or player');
      window.location.href = 'index.html';
    }

    // Firebase references
    const roomRef = ref(db, `rooms/${roomId}`);
    const gameRef = ref(db, `games/${roomId}`);
    const playerRef = ref(db, `rooms/${roomId}/${playerRole}`);
    const opponentRole = playerRole === 'player1' ? 'player2' : 'player1';
    const opponentRef = ref(db, `rooms/${roomId}/${opponentRole}`);

    // Game state
    let gameState = {
      currentInnings: 1,
      battingTeam: '',
      bowlingTeam: '',
      totalRuns: 0,
      wickets: 0,
      ballsBowled: 0,
      currentOver: 0,
      currentBatter: null,
      currentBowler: null,
      batterCard: null,
      bowlerCard: null,
      batterSelected: false,
      bowlerSelected: false,
      freeHit: false,
      powerplay: true,
      inningsCompleted: false,
      matchCompleted: false
    };

    let playerTeam = '';
    let opponentTeam = '';
    let playerPlayers = [];
    let opponentPlayers = [];
    let playerCaptain = '';
    let playerViceCaptain = '';
    let opponentCaptain = '';
    let opponentViceCaptain = '';
    let matchFormat = '';
    let tossWinner = '';
    let battingFirst = '';
    let battingChoice = '';
    let selectedCard = null;
    let batterLife = {};
    let batterStats = {};
    let bowlerStats = {};
    let partnership = { runs: 0, balls: 0 };
    let currentStriker = null;
    let currentNonStriker = null;
    let batterZeroCount = 0;
    let bowlerZeroCount = 0;
    let commentary = [];

    // DOM elements
    const matchTitle = document.getElementById('matchTitle');
    const matchDetails = document.getElementById('matchDetails');
    const roomCodeDisplay = document.getElementById('roomCodeDisplay');
    const battingTeamName = document.getElementById('battingTeamName');
    const battingScore = document.getElementById('battingScore');
    const battingOvers = document.getElementById('battingOvers');
    const bowlingTeamName = document.getElementById('bowlingTeamName');
    const bowlingScore = document.getElementById('bowlingScore');
    const bowlingOvers = document.getElementById('bowlingOvers');
    const gameStatus = document.getElementById('gameStatus');
    const batterSelect = document.getElementById('batterSelect');
    const bowlerSelect = document.getElementById('bowlerSelect');
    const submitBatterBtn = document.getElementById('submitBatterBtn');
    const submitBowlerBtn = document.getElementById('submitBowlerBtn');
    const nextBatterBtn = document.getElementById('nextBatterBtn');
    const nextBowlerBtn = document.getElementById('nextBowlerBtn');
    const commentaryBox = document.getElementById('commentaryBox');
    const battingStats = document.getElementById('battingStats');
    const bowlingStats = document.getElementById('bowlingStats');
    const inningsBreak = document.getElementById('inningsBreak');
    const inningsSummary = document.getElementById('inningsSummary');
    const startSecondInningsBtn = document.getElementById('startSecondInningsBtn');
    const miniScorecard = document.getElementById('miniScorecard');
    const miniScore = document.getElementById('miniScore');
    const miniDetails = document.getElementById('miniDetails');
    const resultModal = document.getElementById('resultModal');
    const resultTitle = document.getElementById('resultTitle');
    const resultDetails = document.getElementById('resultDetails');
    const viewSummaryBtn = document.getElementById('viewSummaryBtn');
    const backToLobbyBtn = document.getElementById('backToLobbyBtn');

    // Set player online status
    set(playerRef, {
      name: teamName,
      connected: true,
      team: teamName
    }).catch(error => {
      console.error('Connection error:', error);
    });

    // Load room data
    onValue(roomRef, (snap) => {
      if (snap.exists()) {
        const room = snap.val();
        
        // Set team names
        playerTeam = playerRole === 'player1' ? room.team1 : room.team2;
        opponentTeam = playerRole === 'player1' ? room.team2 : room.team1;
        
        // Set format
        matchFormat = room.format || '20';
        
        // Set toss info
        if (room.toss) {
          tossWinner = room.toss.winner;
          battingFirst = room.toss.battingFirst;
          battingChoice = room.toss.battingChoice;
          
          // Determine batting and bowling teams for first innings
          if (gameState.currentInnings === 1) {
            gameState.battingTeam = battingFirst;
            gameState.bowlingTeam = battingFirst === 'player1' ? 'player2' : 'player1';
          } else {
            // Second innings roles are reversed
            gameState.battingTeam = battingFirst === 'player1' ? 'player2' : 'player1';
            gameState.bowlingTeam = battingFirst;
          }
          
          // Update UI with team names
          const battingTeamNameValue = gameState.battingTeam === 'player1' ? room.team1 : room.team2;
          const bowlingTeamNameValue = gameState.bowlingTeam === 'player1' ? room.team1 : room.team2;
          
          battingTeamName.textContent = battingTeamNameValue;
          bowlingTeamName.textContent = bowlingTeamNameValue;
          
          matchTitle.textContent = `${battingTeamNameValue} vs ${bowlingTeamNameValue}`;
          matchDetails.textContent = `Format: ${getFormatName(matchFormat)} | Innings: ${gameState.currentInnings} of 2`;
          roomCodeDisplay.textContent = `Room: ${roomId}`;
        }
        
        // Load teams if available
        if (room.teams) {
          if (room.teams.player1) {
            if (playerRole === 'player1') {
              playerPlayers = room.teams.player1.players || [];
              playerCaptain = room.teams.player1.captain || '';
              playerViceCaptain = room.teams.player1.viceCaptain || '';
            } else {
              opponentPlayers = room.teams.player1.players || [];
              opponentCaptain = room.teams.player1.captain || '';
              opponentViceCaptain = room.teams.player1.viceCaptain || '';
            }
          }
          
          if (room.teams.player2) {
            if (playerRole === 'player2') {
              playerPlayers = room.teams.player2.players || [];
              playerCaptain = room.teams.player2.captain || '';
              playerViceCaptain = room.teams.player2.viceCaptain || '';
            } else {
              opponentPlayers = room.teams.player2.players || [];
              opponentCaptain = room.teams.player2.captain || '';
              opponentViceCaptain = room.teams.player2.viceCaptain || '';
            }
          }
          
          // Populate player select dropdowns
          populatePlayerSelects();
        }
        
        // Check if game has started
        if (room.gameStarted && !gameState.matchCompleted) {
          initializeGame();
        }
      }
    });

    // Load game data
    onValue(gameRef, (snap) => {
      if (snap.exists()) {
        const gameData = snap.val();
        
        // Update game state
        gameState = { ...gameState, ...gameData };
        
        // Update UI
        updateScoreboard();
        updatePlayerStats();
        updateMiniScorecard();
        
        // Check if both players have submitted their cards
        if (gameState.batterSelected && gameState.bowlerSelected && !gameState.inningsCompleted) {
          processDelivery();
        }
        
        // Check if innings is completed
        if (gameState.inningsCompleted && !gameState.matchCompleted) {
          showInningsBreak();
        }
        
        // Check if match is completed
        if (gameState.matchCompleted) {
          showMatchResult();
        }
      }
    });

    // Handle opponent disconnect
    onValue(opponentRef, (snap) => {
      if (!snap.exists() || !snap.val().connected) {
        gameStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Opponent disconnected. Waiting for reconnection...';
      }
    });

    // Initialize the game
    function initializeGame() {
      gameStatus.textContent = 'Game started! Select your players and cards.';
      
      // Determine if player is batting or bowling
      const isBatting = (playerRole === gameState.battingTeam);
      const isBowling = (playerRole === gameState.bowlingTeam);
      
      // Show/hide controls based on role
      document.getElementById('battingCardSelection').style.display = isBatting ? 'block' : 'none';
      document.getElementById('bowlingCardSelection').style.display = isBowling ? 'block' : 'none';
      
      // Enable/disable selects based on role
      batterSelect.disabled = !isBatting;
      bowlerSelect.disabled = !isBowling;
      
      // Initialize batter life
      initializeBatterLife();
      
      // Initialize stats
      initializeStats();
    }

    // Populate player select dropdowns
    function populatePlayerSelects() {
      // Clear existing options
      batterSelect.innerHTML = '<option value="">Choose a batter</option>';
      bowlerSelect.innerHTML = '<option value="">Choose a bowler</option>';
      
      // Get available players based on role
      const availableBatters = playerRole === gameState.battingTeam ? playerPlayers : opponentPlayers;
      const availableBowlers = playerRole === gameState.bowlingTeam ? playerPlayers : opponentPlayers;
      
      // Add batters to select
      availableBatters.forEach(player => {
        const option = document.createElement('option');
        option.value = player;
        option.textContent = player;
        batterSelect.appendChild(option);
      });
      
      // Add bowlers to select
      availableBowlers.forEach(player => {
        const option = document.createElement('option');
        option.value = player;
        option.textContent = player;
        bowlerSelect.appendChild(option);
      });
    }

    // Initialize batter life
    function initializeBatterLife() {
      const allPlayers = [...playerPlayers, ...opponentPlayers];
      allPlayers.forEach(player => {
        batterLife[player] = 1.0;
      });
    }

    // Initialize stats
    function initializeStats() {
      const allPlayers = [...playerPlayers, ...opponentPlayers];
      
      // Initialize batter stats
      allPlayers.forEach(player => {
        batterStats[player] = {
          runs: 0,
          balls: 0,
          fours: 0,
          sixes: 0,
          out: false,
          howOut: 'not out'
        };
      });
      
      // Initialize bowler stats
      allPlayers.forEach(player => {
        bowlerStats[player] = {
          overs: 0,
          maidens: 0,
          runs: 0,
          wickets: 0,
          balls: 0
        };
      });
    }

    // Card selection
    document.querySelectorAll('.card').forEach(card => {
      card.addEventListener('click', () => {
        // Remove selected class from all cards
        document.querySelectorAll('.card').forEach(c => c.classList.remove('selected'));
        
        // Add selected class to clicked card
        card.classList.add('selected');
        
        // Store selected value
        selectedCard = parseInt(card.dataset.value);
        
        // Enable submit button based on role
        const isBatting = (playerRole === gameState.battingTeam);
        const isBowling = (playerRole === gameState.bowlingTeam);
        
        if (isBatting && batterSelect.value) {
          submitBatterBtn.disabled = false;
        }
        
        if (isBowling && bowlerSelect.value) {
          submitBowlerBtn.disabled = false;
        }
      });
    });

    // Submit batter selection
    submitBatterBtn.addEventListener('click', () => {
      if (!batterSelect.value || selectedCard === null) {
        alert('Please select a batter and a card');
        return;
      }
      
      const isBatting = (playerRole === gameState.battingTeam);
      
      if (isBatting) {
        // Update game state
        update(gameRef, {
          currentBatter: batterSelect.value,
          batterCard: selectedCard,
          batterSelected: true
        }).then(() => {
          gameStatus.textContent = 'Batter selected. Waiting for bowler...';
          submitBatterBtn.disabled = true;
        }).catch(error => {
          console.error('Error updating batter:', error);
        });
      }
    });

    // Submit bowler selection
    submitBowlerBtn.addEventListener('click', () => {
      if (!bowlerSelect.value || selectedCard === null) {
        alert('Please select a bowler and a card');
        return;
      }
      
      const isBowling = (playerRole === gameState.bowlingTeam);
      
      if (isBowling) {
        // Update game state
        update(gameRef, {
          currentBowler: bowlerSelect.value,
          bowlerCard: selectedCard,
          bowlerSelected: true
        }).then(() => {
          gameStatus.textContent = 'Bowler selected. Waiting for batter...';
          submitBowlerBtn.disabled = true;
        }).catch(error => {
          console.error('Error updating bowler:', error);
        });
      }
    });

    // Process delivery
    function processDelivery() {
      const batterCard = gameState.batterCard;
      const bowlerCard = gameState.bowlerCard;
      let runs = 0;
      let isWicket = false;
      let isNoBall = false;
      let isFreeHit = gameState.freeHit;
      
      // Reset card selections
      selectedCard = null;
      document.querySelectorAll('.card').forEach(c => c.classList.remove('selected'));
      
      // Check for special ball rules
      if (batterCard === 0) {
        batterZeroCount++;
        if (batterZeroCount >= 3) {
          runs = -5; // Penalty for 4th zero in an over
          addCommentary(`${gameState.currentBatter} penalized with -5 runs for too many defensive shots!`);
        }
      } else {
        batterZeroCount = 0;
      }
      
      if (bowlerCard === 0) {
        bowlerZeroCount++;
        if (bowlerZeroCount >= 3) {
          isNoBall = true; // No ball for 4th zero in an over
          addCommentary(`${gameState.currentBowler} bowled a no ball for too many dot balls!`);
        }
      } else {
        bowlerZeroCount = 0;
      }
      
      // Apply format-specific rules
      if (matchFormat === 'test') {
        // Test match rules
        if (batterCard === 0 && bowlerCard === 0) {
          runs = 0; // Dot ball
        } else if (batterCard === 0 && bowlerCard > 0) {
          runs = 0; // Dot ball
        } else if (batterCard > 0 && bowlerCard === 0) {
          runs = batterCard; // Runs scored
        } else if (batterCard > 0 && bowlerCard > 0 && batterCard !== bowlerCard) {
          runs = batterCard; // Runs scored
        } else if (batterCard === bowlerCard) {
          isWicket = true; // Wicket
        }
      } else {
        // Limited overs rules (T20, T10, ODI)
        if (batterCard === bowlerCard && batterCard > 0 && bowlerCard > 0) {
          isWicket = true; // Wicket
        } else if (batterCard !== bowlerCard && batterCard > 0 && bowlerCard > 0) {
          runs = batterCard; // Batter's card = runs
        } else if (batterCard === 0 && bowlerCard > 0) {
          runs = bowlerCard; // Bowler's card = runs
        } else if (bowlerCard === 0 && batterCard > 0) {
          runs = 0; // Dot ball
        } else if (batterCard === 0 && bowlerCard === 0) {
          isNoBall = true; // No ball
          runs = 1; // +1 run for no ball
        }
      }
      
      // Handle free hit - wicket doesn't count
      if (isFreeHit && isWicket) {
        addCommentary(`Free Hit! Wicket doesn't count.`);
        isWicket = false;
        gameState.freeHit = false; // Reset free hit after one ball
      }
      
      // Handle no ball
      if (isNoBall) {
        runs = 1; // +1 run for no ball
        gameState.freeHit = true; // Free hit next ball
        addCommentary(`No Ball! +1 run, Free Hit awarded.`);
        // Ball not counted in over
      } else {
        // Regular ball, increment balls bowled
        gameState.ballsBowled++;
      }
      
      // Update runs
      if (runs > 0) {
        gameState.totalRuns += runs;
        addCommentary(`${runs} run${runs > 1 ? 's' : ''} scored!`);
        
        // Update batter stats
        batterStats[gameState.currentBatter].runs += runs;
        batterStats[gameState.currentBatter].balls++;
        if (runs === 4) {
          batterStats[gameState.currentBatter].fours++;
        } else if (runs === 6) {
          batterStats[gameState.currentBatter].sixes++;
        }
        
        // Update bowler stats
        bowlerStats[gameState.currentBowler].runs += runs;
        if (!isNoBall) {
          bowlerStats[gameState.currentBowler].balls++;
        }
        
        // Update partnership
        partnership.runs += runs;
        partnership.balls++;
      } else if (runs === 0) {
        addCommentary(`Dot ball.`);
        
        // Update batter stats
        batterStats[gameState.currentBatter].balls++;
        
        // Update bowler stats
        if (!isNoBall) {
          bowlerStats[gameState.currentBowler].balls++;
        }
        
        // Update partnership
        partnership.balls++;
      } else if (runs < 0) {
        gameState.totalRuns += runs; // Negative runs (penalty)
        addCommentary(`Penalty! ${runs} runs.`);
      }
      
      // Handle wicket
      if (isWicket) {
        addCommentary(`Wicket! ${gameState.currentBatter} is out.`);
        gameState.wickets++;
        
        // Update batter stats
        batterStats[gameState.currentBatter].out = true;
        batterStats[gameState.currentBatter].howOut = `b ${gameState.currentBowler}`;
        batterStats[gameState.currentBatter].balls++;
        
        // Update bowler stats
        bowlerStats[gameState.currentBowler].wickets++;
        if (!isNoBall) {
          bowlerStats[gameState.currentBowler].balls++;
        }
        
        // Update partnership
        partnership.balls++;
        
        // Check if all out or innings complete
        if (gameState.wickets >= 10) {
          gameState.inningsCompleted = true;
          addCommentary(`All out! Innings completed.`);
        } else {
          // Show next batter button
          nextBatterBtn.style.display = 'block';
          gameStatus.textContent = 'Select next batter';
        }
      }
      
      // Check if over is completed (6 balls)
      if (gameState.ballsBowled % 6 === 0 && !isNoBall) {
        gameState.currentOver++;
        addCommentary(`Over ${gameState.currentOver} completed.`);
        
        // Reset zero counts for new over
        batterZeroCount = 0;
        bowlerZeroCount = 0;
        
        // Show next bowler button
        nextBowlerBtn.style.display = 'block';
        gameStatus.textContent = 'Select next bowler';
      }
      
      // Check if innings is completed based on format
      if (matchFormat === '5' && gameState.currentOver >= 5) {
        gameState.inningsCompleted = true;
        addCommentary(`Innings completed after 5 overs.`);
      } else if (matchFormat === '10' && gameState.currentOver >= 10) {
        gameState.inningsCompleted = true;
        addCommentary(`Innings completed after 10 overs.`);
      } else if (matchFormat === '20' && gameState.currentOver >= 20) {
        gameState.inningsCompleted = true;
        addCommentary(`Innings completed after 20 overs.`);
      } else if (matchFormat === '50' && gameState.currentOver >= 50) {
        gameState.inningsCompleted = true;
        addCommentary(`Innings completed after 50 overs.`);
      }
      
      // Update game state in Firebase
      update(gameRef, {
        totalRuns: gameState.totalRuns,
        wickets: gameState.wickets,
        ballsBowled: gameState.ballsBowled,
        currentOver: gameState.currentOver,
        freeHit: gameState.freeHit,
        inningsCompleted: gameState.inningsCompleted,
        batterSelected: false,
        bowlerSelected: false,
        batterCard: null,
        bowlerCard: null
      }).then(() => {
        // Update UI
        updateScoreboard();
        updatePlayerStats();
        updateMiniScorecard();
      }).catch(error => {
        console.error('Error updating game state:', error);
      });
    }

    // Next batter
    nextBatterBtn.addEventListener('click', () => {
      nextBatterBtn.style.display = 'none';
      batterSelect.value = '';
      submitBatterBtn.disabled = true;
      gameStatus.textContent = 'Select next batter';
    });

    // Next bowler
    nextBowlerBtn.addEventListener('click', () => {
      nextBowlerBtn.style.display = 'none';
      bowlerSelect.value = '';
      submitBowlerBtn.disabled = true;
      gameStatus.textContent = 'Select next bowler';
    });

    // Show innings break
    function showInningsBreak() {
      const target = gameState.totalRuns + 1;
      inningsSummary.textContent = `First innings completed. ${battingTeamName.textContent} scored ${gameState.totalRuns}/${gameState.wickets}. ${bowlingTeamName.textContent} needs ${target} runs to win.`;
      inningsBreak.style.display = 'block';
    }

    // Start second innings
    startSecondInningsBtn.addEventListener('click', () => {
      // Switch roles for second innings
      gameState.currentInnings = 2;
      gameState.battingTeam = gameState.bowlingTeam;
      gameState.bowlingTeam = gameState.battingTeam;
      gameState.totalRuns = 0;
      gameState.wickets = 0;
      gameState.ballsBowled = 0;
      gameState.currentOver = 0;
      gameState.inningsCompleted = false;
      
      // Swap team names in UI
      const tempTeamName = battingTeamName.textContent;
      battingTeamName.textContent = bowlingTeamName.textContent;
      bowlingTeamName.textContent = tempTeamName;
      
      // Update UI
      updateScoreboard();
      inningsBreak.style.display = 'none';
      matchDetails.textContent = `Format: ${getFormatName(matchFormat)} | Innings: ${gameState.currentInnings} of 2`;
      
      // Reset stats for second innings
      initializeStats();
      updatePlayerStats();
      
      // Update game state in Firebase
      update(gameRef, {
        currentInnings: 2,
        battingTeam: gameState.battingTeam,
        bowlingTeam: gameState.bowlingTeam,
        totalRuns: 0,
        wickets: 0,
        ballsBowled: 0,
        currentOver: 0,
        inningsCompleted: false,
        batterSelected: false,
        bowlerSelected: false
      }).then(() => {
        gameStatus.textContent = 'Second innings started! Select your players and cards.';
        
        // Determine if player is batting or bowling
        const isBatting = (playerRole === gameState.battingTeam);
        const isBowling = (playerRole === gameState.bowlingTeam);
        
        // Show/hide controls based on role
        document.getElementById('battingCardSelection').style.display = isBatting ? 'block' : 'none';
        document.getElementById('bowlingCardSelection').style.display = isBowling ? 'block' : 'none';
        
        // Enable/disable selects based on role
        batterSelect.disabled = !isBatting;
        bowlerSelect.disabled = !isBowling;
      }).catch(error => {
        console.error('Error starting second innings:', error);
      });
    });

    // Show match result
    function showMatchResult() {
      // Determine winner
      const firstInningsTotal = 0; // This should be stored from first innings
      const secondInningsTotal = gameState.totalRuns;
      const target = firstInningsTotal + 1;
      
      let resultText = '';
      if (secondInningsTotal >= target) {
        const wicketsLeft = 10 - gameState.wickets;
        resultText = `${battingTeamName.textContent} won by ${wicketsLeft} wickets`;
      } else {
        const runsDifference = target - secondInningsTotal - 1;
        resultText = `${bowlingTeamName.textContent} won by ${runsDifference} runs`;
      }
      
      // Find top performers
      const topScorer = findTopScorer();
      const bestBowler = findBestBowler();
      
      // Update result modal
      resultTitle.textContent = 'Match Result';
      resultDetails.innerHTML = `
        <p>${resultText}</p>
        <p>Top Scorer: ${topScorer.name} (${topScorer.runs} runs)</p>
        <p>Best Bowler: ${bestBowler.name} (${bestBowler.wickets} wickets)</p>
        <p>Player of the Match: ${topScorer.name}</p>
      `;
      
      // Show modal
      resultModal.style.display = 'flex';
    }

    // Find top scorer
    function findTopScorer() {
      let topScorer = { name: '', runs: 0 };
      
      for (const player in batterStats) {
        if (batterStats[player].runs > topScorer.runs) {
          topScorer = { name: player, runs: batterStats[player].runs };
        }
      }
      
      return topScorer;
    }

    // Find best bowler
    function findBestBowler() {
      let bestBowler = { name: '', wickets: 0 };
      
      for (const player in bowlerStats) {
        if (bowlerStats[player].wickets > bestBowler.wickets) {
          bestBowler = { name: player, wickets: bowlerStats[player].wickets };
        }
      }
      
      return bestBowler;
    }

    // Update scoreboard
    function updateScoreboard() {
      battingScore.textContent = `${gameState.totalRuns}/${gameState.wickets}`;
      bowlingScore.textContent = `${gameState.totalRuns}/${gameState.wickets}`;
      
      const overs = Math.floor(gameState.ballsBowled / 6);
      const balls = gameState.ballsBowled % 6;
      
      battingOvers.textContent = `Overs: ${overs}.${balls}`;
      bowlingOvers.textContent = `Overs: ${overs}.${balls}`;
    }

    // Update player stats
    function updatePlayerStats() {
      // Update batting stats
      const battingStatsBody = battingStats.querySelector('tbody');
      battingStatsBody.innerHTML = '';
      
      for (const player in batterStats) {
        const stats = batterStats[player];
        if (stats.balls > 0 || stats.out) {
          const row = document.createElement('tr');
          const strikeRate = stats.balls > 0 ? (stats.runs / stats.balls * 100).toFixed(2) : '0.00';
          
          row.innerHTML = `
            <td>${player} ${currentStriker === player ? '*' : ''}</td>
            <td>${stats.runs}</td>
            <td>${stats.balls}</td>
            <td>${stats.fours}</td>
            <td>${stats.sixes}</td>
            <td>${strikeRate}</td>
          `;
          
          battingStatsBody.appendChild(row);
        }
      }
      
      // Update bowling stats
      const bowlingStatsBody = bowlingStats.querySelector('tbody');
      bowlingStatsBody.innerHTML = '';
      
      for (const player in bowlerStats) {
        const stats = bowlerStats[player];
        if (stats.balls > 0) {
          const overs = Math.floor(stats.balls / 6);
          const balls = stats.balls % 6;
          const economy = stats.balls > 0 ? (stats.runs / stats.balls * 6).toFixed(2) : '0.00';
          
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${player}</td>
            <td>${overs}.${balls}</td>
            <td>${stats.maidens}</td>
            <td>${stats.runs}</td>
            <td>${stats.wickets}</td>
            <td>${economy}</td>
          `;
          
          bowlingStatsBody.appendChild(row);
        }
      }
    }

    // Update mini scorecard
    function updateMiniScorecard() {
      const overs = Math.floor(gameState.ballsBowled / 6);
      const balls = gameState.ballsBowled % 6;
      
      miniScore.textContent = `${gameState.totalRuns}/${gameState.wickets} (${overs}.${balls})`;
      
      const runRate = gameState.ballsBowled > 0 ? (gameState.totalRuns / gameState.ballsBowled * 6).toFixed(2) : '0.00';
      const currentRunRate = partnership.balls > 0 ? (partnership.runs / partnership.balls * 6).toFixed(2) : '0.00';
      
      miniDetails.textContent = `RR: ${runRate} | CRR: ${currentRunRate}`;
    }

    // Add commentary
    function addCommentary(text) {
      const now = new Date();
      const time = now.toLocaleTimeString();
      
      const commentaryItem = document.createElement('div');
      commentaryItem.className = 'commentary-item';
      commentaryItem.innerHTML = `<strong>${time}</strong> - ${text}`;
      
      commentaryBox.appendChild(commentaryItem);
      commentaryBox.scrollTop = commentaryBox.scrollHeight;
      
      // Store commentary
      commentary.push({ time, text });
    }

    // Get format name
    function getFormatName(formatCode) {
      switch (formatCode) {
        case '5': return 'T5';
        case '10': return 'T10';
        case '20': return 'T20';
        case '50': return 'ODI';
        case 'test': return 'Test';
        default: return 'T20';
      }
    }

    // View summary button
    viewSummaryBtn.addEventListener('click', () => {
      // Save match data to Firebase
      const matchData = {
        team1: playerRole === 'player1' ? playerTeam : opponentTeam,
        team2: playerRole === 'player2' ? playerTeam : opponentTeam,
        format: matchFormat,
        date: new Date().toISOString(),
        toss: {
          winner: tossWinner,
          battingFirst: battingFirst,
          battingChoice: battingChoice
        },
        innings1: {
          runs: 0, // This should be from first innings
          wickets: 0,
          overs: 0
        },
        innings2: {
          runs: gameState.totalRuns,
          wickets: gameState.wickets,
          overs: Math.floor(gameState.ballsBowled / 6) + '.' + (gameState.ballsBowled % 6)
        },
        result: resultTitle.textContent,
        topScorer: findTopScorer(),
        bestBowler: findBestBowler(),
        playerOfMatch: findTopScorer().name,
        commentary: commentary
      };
      
      // Save to Firebase
      const matchesRef = ref(db, `matches/${roomId}`);
      set(matchesRef, matchData).then(() => {
        // Redirect to match summary
        window.location.href = `match_summary.html?match=${roomId}`;
      }).catch(error => {
        console.error('Error saving match data:', error);
      });
    });

    // Back to lobby button
    backToLobbyBtn.addEventListener('click', () => {
      window.location.href = 'index.html';
    });

    // Handle page unload
    window.addEventListener('beforeunload', () => {
      set(playerRef, {
        connected: false
      }).catch(error => {
        console.error('Error updating connection status:', error);
      });
    });
  </script>
</body>
</html>