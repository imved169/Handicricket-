<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HandiCricket - IPL 2025 Auction</title>
  <style>
    body {
      background: linear-gradient(135deg, #061e3e, #0a2a4a);
      color: white;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      margin: 0;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    h1 {
      color: #ffeb3b;
      text-shadow: 0 0 10px rgba(255, 235, 59, 0.5);
      margin-bottom: 20px;
      text-align: center;
    }
    
    .section {
      display: none;
      margin-bottom: 20px;
    }
    
    .section.active {
      display: block;
    }
    
    .user-info {
      margin-bottom: 20px;
      padding: 15px;
      background: rgba(13, 42, 82, 0.5);
      border-radius: 10px;
    }
    
    .user-info p {
      margin: 5px 0;
    }
    
    .user-team {
      font-weight: bold;
      color: #ffeb3b;
    }
    
    .budget-display {
      font-size: 24px;
      margin: 15px 0;
      text-align: center;
    }
    
    .budget-amount {
      color: #4CAF50;
      font-weight: bold;
    }
    
    .rtm-display {
      font-size: 18px;
      margin: 10px 0;
      text-align: center;
    }
    
    .rtm-count {
      color: #FF9800;
      font-weight: bold;
    }
    
    .player-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    
    .player-card {
      background: rgba(13, 42, 82, 0.5);
      border-radius: 10px;
      padding: 15px;
      cursor: pointer;
      transition: all 0.3s;
      border: 2px solid transparent;
      position: relative;
    }
    
    .player-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 10px rgba(0, 0, 0, 0.3);
    }
    
    .player-card.selected {
      border-color: #ffeb3b;
      background: rgba(30, 136, 229, 0.3);
    }
    
    .player-card.captain {
      border-color: gold;
      background: rgba(255, 215, 0, 0.2);
    }
    
    .player-card h3 {
      margin-top: 0;
      margin-bottom: 5px;
    }
    
    .player-card p {
      margin: 5px 0;
      font-size: 14px;
      color: #aaa;
    }
    
    .player-role {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .role-batter {
      background-color: rgba(76, 175, 80, 0.2);
      color: #4CAF50;
    }
    
    .role-pacer {
      background-color: rgba(244, 67, 54, 0.2);
      color: #f44336;
    }
    
    .role-spinner {
      background-color: rgba(156, 39, 176, 0.2);
      color: #9C27B0;
    }
    
    .role-allrounder {
      background-color: rgba(255, 152, 0, 0.2);
      color: #FF9800;
    }
    
    .role-wicketkeeper {
      background-color: rgba(0, 150, 136, 0.2);
      color: #009688;
    }
    
    .btn {
      padding: 12px 25px;
      border: none;
      border-radius: 8px;
      background: linear-gradient(145deg, #1e88e5, #1565c0);
      color: white;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      margin: 10px 5px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    }
    
    .btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 10px rgba(0, 0, 0, 0.3);
    }
    
    .btn:active {
      transform: translateY(1px);
    }
    
    .btn-confirm {
      background: linear-gradient(145deg, #4CAF50, #2E7D32);
    }
    
    .btn-back {
      background: linear-gradient(145deg, #607D8B, #455A64);
    }
    
    .btn-danger {
      background: linear-gradient(145deg, #f44336, #d32f2f);
    }
    
    .btn-warning {
      background: linear-gradient(145deg, #FF9800, #F57C00);
    }
    
    .btn-purple {
      background: linear-gradient(145deg, #9C27B0, #7B1FA2);
    }
    
    .btn-gold {
      background: linear-gradient(145deg, #FFD700, #FFC600);
    }
    
    .input-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      color: #aaa;
    }
    
    input, select {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #1e88e5;
      border-radius: 8px;
      background: rgba(30, 136, 229, 0.1);
      color: white;
      font-size: 16px;
      box-sizing: border-box;
    }
    
    select option {
      background: #061e3e;
    }
    
    .auction-controls {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    
    .bid-controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 20px 0;
    }
    
    .bid-btn {
      min-width: 80px;
    }
    
    .current-player {
      background: rgba(30, 136, 229, 0.3);
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
      text-align: center;
      border: 2px solid #1e88e5;
    }
    
    .current-player h2 {
      margin-top: 0;
      color: #ffeb3b;
    }
    
    .player-price {
      font-size: 28px;
      color: #FFD700;
      margin: 10px 0;
    }
    
    .timer {
      font-size: 24px;
      color: #f44336;
      margin: 10px 0;
    }
    
    .sold-to {
      font-size: 20px;
      color: #4CAF50;
      margin: 10px 0;
    }
    
    .team-squad {
      margin: 20px 0;
      background: rgba(13, 42, 82, 0.5);
      border-radius: 10px;
      padding: 15px;
    }
    
    .team-squad h3 {
      margin-top: 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding-bottom: 8px;
    }
    
    .squad-list {
      list-style: none;
      padding: 0;
      margin: 10px 0;
    }
    
    .squad-list li {
      padding: 8px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .squad-list li:last-child {
      border-bottom: none;
    }
    
    .player-cost {
      float: right;
      color: #FFD700;
    }
    
    .admin-controls {
      background: rgba(244, 67, 54, 0.1);
      border-radius: 10px;
      padding: 15px;
      margin: 20px 0;
      border: 1px solid rgba(244, 67, 54, 0.3);
    }
    
    .admin-controls h3 {
      margin-top: 0;
      color: #f44336;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .modal-content {
      background: linear-gradient(135deg, #0a2a4a, #061e3e);
      border-radius: 15px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .modal h2 {
      margin-top: 0;
      color: #ffeb3b;
    }
    
    .close-modal {
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      color: #aaa;
      font-size: 24px;
      cursor: pointer;
    }
    
    .csv-input {
      width: 100%;
      height: 150px;
      padding: 10px;
      border: 1px solid #1e88e5;
      border-radius: 8px;
      background: rgba(30, 136, 229, 0.1);
      color: white;
      font-family: monospace;
      resize: vertical;
    }
    
    .csv-format {
      font-size: 12px;
      color: #aaa;
      margin-top: 5px;
    }
    
    .notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(30, 136, 229, 0.9);
      color: white;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      display: none;
    }
    
    .loading-spinner {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 3px solid #1e88e5;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }
      
      .player-grid {
        grid-template-columns: 1fr 1fr;
      }
      
      .auction-controls {
        flex-direction: column;
        align-items: center;
      }
      
      .bid-controls {
        flex-wrap: wrap;
      }
      
      .bid-btn {
        flex: 1;
        min-width: 60px;
      }
    }
    
    @media (max-width: 480px) {
      .player-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üèè IPL 2025 Auction</h1>
    
    <div class="user-info">
      <p>Team: <span id="teamDisplay" class="user-team"></span></p>
      <p>Status: <span id="statusDisplay">Not Connected</span></p>
      <div id="adminControls" style="display: none;">
        <p>You are the <strong style="color: #f44336;">Auction Admin</strong></p>
      </div>
    </div>
    
    <!-- Retention Section -->
    <div id="retentionSection" class="section active">
      <h2>Player Retention</h2>
      <p>Retain up to 6 players from your previous squad. Captain retention costs ‚Çπ4 Cr, others cost ‚Çπ2 Cr.</p>
      
      <div class="budget-display">
        Initial Budget: <span class="budget-amount">‚Çπ150 Cr</span>
      </div>
      
      <div class="budget-display">
        After Retention: <span class="budget-amount" id="postRetentionBudget">‚Çπ150 Cr</span>
      </div>
      
      <div class="rtm-display">
        RTM Cards Earned: <span class="rtm-count" id="rtmCount">0</span>
      </div>
      
      <div id="retentionPlayerGrid" class="player-grid"></div>
      
      <div style="text-align: center;">
        <button id="confirmRetentionBtn" class="btn btn-confirm">Confirm Retention</button>
        <button id="skipRetentionBtn" class="btn btn-back">Skip Retention</button>
      </div>
    </div>
    
    <!-- Auction Setup Section (Admin Only) -->
    <div id="setupSection" class="section">
      <h2>Auction Setup</h2>
      
      <div class="admin-controls">
        <h3>Admin Controls</h3>
        
        <div class="input-group">
          <label for="roomCodeInput">Room Code</label>
          <input type="text" id="roomCodeInput" placeholder="Enter room code" value="2025">
        </div>
        
        <button id="createRoomBtn" class="btn btn-confirm">Create Auction Room</button>
        
        <div style="margin: 20px 0;">
          <button id="addPlayerBtn" class="btn">Add Single Player</button>
          <button id="bulkAddBtn" class="btn btn-purple">Bulk Add Players</button>
        </div>
        
        <div id="playerPoolSection" style="display: none;">
          <h3>Player Pool</h3>
          <div class="player-grid" id="playerPoolGrid"></div>
        </div>
        
        <div style="text-align: center; margin-top: 20px;">
          <button id="startAuctionBtn" class="btn btn-gold" style="display: none;">Start Auction</button>
        </div>
      </div>
    </div>
    
    <!-- Join Room Section (Non-Admin) -->
    <div id="joinSection" class="section">
      <h2>Join Auction Room</h2>
      
      <div class="input-group">
        <label for="joinRoomCode">Room Code</label>
        <input type="text" id="joinRoomCode" placeholder="Enter room code from admin">
      </div>
      
      <div style="text-align: center;">
        <button id="joinRoomBtn" class="btn btn-confirm">Join Room</button>
        <button id="backToRetentionBtn" class="btn btn-back">Back to Retention</button>
      </div>
    </div>
    
    <!-- Auction Section -->
    <div id="auctionSection" class="section">
      <div id="currentPlayerCard" class="current-player" style="display: none;">
        <h2 id="currentPlayerName">Player Name</h2>
        <p id="currentPlayerRole">Role</p>
        <div class="player-price" id="currentPlayerPrice">Base Price: ‚Çπ0.50 Cr</div>
        <div class="timer" id="auctionTimer">30s</div>
        <div class="sold-to" id="soldToDisplay"></div>
      </div>
      
      <div id="bidControls" class="bid-controls">
        <button class="btn bid-btn" data-increment="0.10">+0.10 Cr</button>
        <button class="btn bid-btn" data-increment="0.25">+0.25 Cr</button>
        <button class="btn bid-btn" data-increment="0.50">+0.50 Cr</button>
        <button class="btn bid-btn" data-increment="1.00">+1.00 Cr</button>
        <button id="passBtn" class="btn btn-danger bid-btn">Pass</button>
        <button id="rtmBtn" class="btn btn-warning bid-btn" style="display: none;">Use RTM</button>
      </div>
      
      <div class="auction-controls">
        <div class="budget-display">
          Remaining Budget: <span class="budget-amount" id="remainingBudget">‚Çπ150 Cr</span>
        </div>
        
        <div class="rtm-display">
          RTM Cards Left: <span class="rtm-count" id="rtmRemaining">0</span>
        </div>
      </div>
      
      <div class="team-squad">
        <h3>Your Squad</h3>
        <ul class="squad-list" id="teamSquadList"></ul>
        <p>Players: <span id="squadCount">0</span>/25</p>
      </div>
      
      <div id="adminAuctionControls" class="admin-controls" style="display: none;">
        <h3>Admin Auction Controls</h3>
        <button id="nextPlayerBtn" class="btn">Next Player</button>
        <button id="autoSellBtn" class="btn btn-danger">Auto Sell</button>
        <button id="soldBtn" class="btn btn-confirm">Sold</button>
      </div>
    </div>
    
    <div style="text-align: center; margin-top: 30px;">
      <button id="backToHomeBtn" class="btn btn-back">Back to Home</button>
    </div>
  </div>
  
  <!-- Add Player Modal -->
  <div id="addPlayerModal" class="modal">
    <div class="modal-content">
      <button class="close-modal">&times;</button>
      <h2>Add Player</h2>
      
      <div class="input-group">
        <label for="playerNameInput">Player Name</label>
        <input type="text" id="playerNameInput" placeholder="Enter player name">
      </div>
      
      <div class="input-group">
        <label for="playerRoleSelect">Role</label>
        <select id="playerRoleSelect">
          <option value="Batter">Batter</option>
          <option value="Pacer">Pacer</option>
          <option value="Spinner">Spinner</option>
          <option value="All-Rounder">All-Rounder</option>
          <option value="Wicket-Keeper">Wicket-Keeper</option>
        </select>
      </div>
      
      <div class="input-group">
        <label for="playerBasePrice">Base Price (in Cr)</label>
        <input type="number" id="playerBasePrice" min="0.20" step="0.10" value="0.50">
      </div>
      
      <button id="confirmAddPlayerBtn" class="btn btn-confirm">Add Player</button>
    </div>
  </div>
  
  <!-- Bulk Add Modal -->
  <div id="bulkAddModal" class="modal">
    <div class="modal-content">
      <button class="close-modal">&times;</button>
      <h2>Bulk Add Players</h2>
      
      <div class="input-group">
        <label for="bulkRoleSelect">Role for all players</label>
        <select id="bulkRoleSelect">
          <option value="Batter">Batter</option>
          <option value="Pacer">Pacer</option>
          <option value="Spinner">Spinner</option>
          <option value="All-Rounder">All-Rounder</option>
          <option value="Wicket-Keeper">Wicket-Keeper</option>
        </select>
      </div>
      
      <div class="input-group">
        <label for="bulkBasePrice">Base Price for all players (in Cr)</label>
        <input type="number" id="bulkBasePrice" min="0.20" step="0.10" value="0.50">
      </div>
      
      <div class="input-group">
        <label for="csvPlayerInput">Player Names (one per line)</label>
        <textarea id="csvPlayerInput" class="csv-input" placeholder="Enter player names, one per line"></textarea>
        <p class="csv-format">Format: One player name per line</p>
      </div>
      
      <button id="confirmBulkAddBtn" class="btn btn-confirm">Add All Players</button>
    </div>
  </div>
  
  <!-- Captain Selection Modal -->
  <div id="captainModal" class="modal">
    <div class="modal-content">
      <button class="close-modal">&times;</button>
      <h2>Select Captain</h2>
      <p>Choose your retained captain (costs ‚Çπ4 Cr):</p>
      
      <div id="captainOptions" style="margin: 20px 0;"></div>
      
      <button id="confirmCaptainBtn" class="btn btn-confirm">Confirm Captain</button>
    </div>
  </div>
  
  <!-- RTM Modal -->
  <div id="rtmModal" class="modal">
    <div class="modal-content">
      <button class="close-modal">&times;</button>
      <h2>Use Right-to-Match (RTM)</h2>
      <p>You can match the current bid for this player using an RTM card.</p>
      <p>Current Bid: <span id="rtmBidAmount" style="color: #FFD700; font-weight: bold;">‚Çπ0.50 Cr</span></p>
      
      <button id="confirmRtmBtn" class="btn btn-confirm">Use RTM</button>
      <button id="cancelRtmBtn" class="btn btn-back">Cancel</button>
    </div>
  </div>
  
  <!-- Notification -->
  <div class="notification" id="notification">
    <span id="notificationText">Notification message</span>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getDatabase, ref, set, update, get, child, onValue, push } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCN6aZMwlsZe7JJaovU0WA3UQygWr4jYmA",
      authDomain: "handicricket-85a06.firebaseapp.com",
      projectId: "handicricket-85a06",
      storageBucket: "handicricket-85a06.appspot.com",
      messagingSenderId: "599182538558",
      appId: "1:599182538558:web:3e965753ab05f8f1e3de6f",
      measurementId: "G-HSV9H4LEJQ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // DOM Elements
    const teamDisplay = document.getElementById('teamDisplay');
    const statusDisplay = document.getElementById('statusDisplay');
    const adminControls = document.getElementById('adminControls');
    
    // Sections
    const retentionSection = document.getElementById('retentionSection');
    const setupSection = document.getElementById('setupSection');
    const joinSection = document.getElementById('joinSection');
    const auctionSection = document.getElementById('auctionSection');
    
    // Retention Elements
    const retentionPlayerGrid = document.getElementById('retentionPlayerGrid');
    const postRetentionBudget = document.getElementById('postRetentionBudget');
    const rtmCount = document.getElementById('rtmCount');
    const confirmRetentionBtn = document.getElementById('confirmRetentionBtn');
    const skipRetentionBtn = document.getElementById('skipRetentionBtn');
    
    // Setup Elements
    const roomCodeInput = document.getElementById('roomCodeInput');
    const createRoomBtn = document.getElementById('createRoomBtn');
    const addPlayerBtn = document.getElementById('addPlayerBtn');
    const bulkAddBtn = document.getElementById('bulkAddBtn');
    const playerPoolSection = document.getElementById('playerPoolSection');
    const playerPoolGrid = document.getElementById('playerPoolGrid');
    const startAuctionBtn = document.getElementById('startAuctionBtn');
    
    // Join Elements
    const joinRoomCode = document.getElementById('joinRoomCode');
    const joinRoomBtn = document.getElementById('joinRoomBtn');
    const backToRetentionBtn = document.getElementById('backToRetentionBtn');
    
    // Auction Elements
    const currentPlayerCard = document.getElementById('currentPlayerCard');
    const currentPlayerName = document.getElementById('currentPlayerName');
    const currentPlayerRole = document.getElementById('currentPlayerRole');
    const currentPlayerPrice = document.getElementById('currentPlayerPrice');
    const auctionTimer = document.getElementById('auctionTimer');
    const soldToDisplay = document.getElementById('soldToDisplay');
    const bidControls = document.getElementById('bidControls');
    const bidButtons = document.querySelectorAll('.bid-btn');
    const passBtn = document.getElementById('passBtn');
    const rtmBtn = document.getElementById('rtmBtn');
    const remainingBudget = document.getElementById('remainingBudget');
    const rtmRemaining = document.getElementById('rtmRemaining');
    const teamSquadList = document.getElementById('teamSquadList');
    const squadCount = document.getElementById('squadCount');
    const adminAuctionControls = document.getElementById('adminAuctionControls');
    const nextPlayerBtn = document.getElementById('nextPlayerBtn');
    const autoSellBtn = document.getElementById('autoSellBtn');
    const soldBtn = document.getElementById('soldBtn');
    
    // Modals
    const addPlayerModal = document.getElementById('addPlayerModal');
    const bulkAddModal = document.getElementById('bulkAddModal');
    const captainModal = document.getElementById('captainModal');
    const rtmModal = document.getElementById('rtmModal');
    const closeModalButtons = document.querySelectorAll('.close-modal');
    const captainOptions = document.getElementById('captainOptions');
    const confirmCaptainBtn = document.getElementById('confirmCaptainBtn');
    const rtmBidAmount = document.getElementById('rtmBidAmount');
    const confirmRtmBtn = document.getElementById('confirmRtmBtn');
    const cancelRtmBtn = document.getElementById('cancelRtmBtn');
    
    // Player Inputs
    const playerNameInput = document.getElementById('playerNameInput');
    const playerRoleSelect = document.getElementById('playerRoleSelect');
    const playerBasePrice = document.getElementById('playerBasePrice');
    const confirmAddPlayerBtn = document.getElementById('confirmAddPlayerBtn');
    const bulkRoleSelect = document.getElementById('bulkRoleSelect');
    const bulkBasePrice = document.getElementById('bulkBasePrice');
    const csvPlayerInput = document.getElementById('csvPlayerInput');
    const confirmBulkAddBtn = document.getElementById('confirmBulkAddBtn');
    
    // Other
    const backToHomeBtn = document.getElementById('backToHomeBtn');
    const notification = document.getElementById('notification');
    const notificationText = document.getElementById('notificationText');
    
    // App State
    let currentUser = localStorage.getItem('hc_username');
    let currentTeam = localStorage.getItem('hc_team');
    let isAdmin = false;
    let roomCode = '';
    let roomRef = null;
    let auctionState = {};
    let retentionPlayers = [];
    let selectedRetentionPlayers = [];
    let selectedCaptain = null;
    let currentBudget = 150;
    let rtmCards = 0;
    let timerInterval = null;
    let timeLeft = 30;
    let currentBid = 0;
    let currentPlayer = null;
    let currentPlayerKey = null;
    let currentPlayerData = null;
    let isRtmAvailable = false;
    
    // Initialize
    if (!currentUser || !currentTeam) {
      window.location.href = 'index.html';
    }
    
    teamDisplay.textContent = currentTeam;
    isAdmin = currentUser === 'imved169' && currentTeam === 'Ratnagiri Hunters';
    
    if (isAdmin) {
      adminControls.style.display = 'block';
      showNotification('You are the Auction Admin with special controls');
    }
    
    // Load previous squad for retention
    loadPreviousSquad();
    
    // Event Listeners
    confirmRetentionBtn.addEventListener('click', confirmRetention);
    skipRetentionBtn.addEventListener('click', skipRetention);
    
    createRoomBtn.addEventListener('click', createRoom);
    addPlayerBtn.addEventListener('click', () => addPlayerModal.style.display = 'flex');
    bulkAddBtn.addEventListener('click', () => bulkAddModal.style.display = 'flex');
    startAuctionBtn.addEventListener('click', startAuction);
    
    joinRoomBtn.addEventListener('click', joinRoom);
    backToRetentionBtn.addEventListener('click', () => {
      joinSection.classList.remove('active');
      retentionSection.classList.add('active');
    });
    
    // Bid controls
    bidButtons.forEach(btn => {
      if (btn.id !== 'passBtn' && btn.id !== 'rtmBtn') {
        btn.addEventListener('click', () => placeBid(parseFloat(btn.dataset.increment)));
      }
    });
    
    passBtn.addEventListener('click', passBid);
    rtmBtn.addEventListener('click', () => rtmModal.style.display = 'flex');
    
    // Admin auction controls
    nextPlayerBtn.addEventListener('click', nextPlayer);
    autoSellBtn.addEventListener('click', autoSell);
    soldBtn.addEventListener('click', sellPlayer);
    
    // Modal controls
    closeModalButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        addPlayerModal.style.display = 'none';
        bulkAddModal.style.display = 'none';
        captainModal.style.display = 'none';
        rtmModal.style.display = 'none';
      });
    });
    
    confirmAddPlayerBtn.addEventListener('click', addSinglePlayer);
    confirmBulkAddBtn.addEventListener('click', bulkAddPlayers);
    confirmCaptainBtn.addEventListener('click', confirmCaptain);
    confirmRtmBtn.addEventListener('click', useRtm);
    cancelRtmBtn.addEventListener('click', () => rtmModal.style.display = 'none');
    
    backToHomeBtn.addEventListener('click', () => window.location.href = 'index.html');
    
    // Click outside modal to close
    window.addEventListener('click', (e) => {
      if (e.target.classList.contains('modal')) {
        addPlayerModal.style.display = 'none';
        bulkAddModal.style.display = 'none';
        captainModal.style.display = 'none';
        rtmModal.style.display = 'none';
      }
    });
    
    // Functions
    function loadPreviousSquad() {
      const userRef = ref(db, `users/${currentUser}`);
      
      onValue(userRef, (snap) => {
        if (snap.exists()) {
          const userData = snap.val();
          retentionPlayers = userData.players || [];
          
          if (retentionPlayers.length > 0) {
            renderRetentionPlayers();
          } else {
            skipRetentionBtn.textContent = 'Proceed to Auction';
          }
        }
      });
    }
    
    function renderRetentionPlayers() {
      retentionPlayerGrid.innerHTML = '';
      
      retentionPlayers.forEach(player => {
        const playerCard = document.createElement('div');
        playerCard.className = 'player-card';
        playerCard.dataset.player = player;
        
        playerCard.innerHTML = `
          <h3>${player}</h3>
          <p>Previous squad member</p>
          <div style="margin-top: 10px;">
            <button class="btn" onclick="selectPlayerForRetention('${player}')">Retain (‚Çπ2 Cr)</button>
            <button class="btn btn-gold" onclick="selectCaptain('${player}')">Make Captain (‚Çπ4 Cr)</button>
          </div>
        `;
        
        retentionPlayerGrid.appendChild(playerCard);
      });
    }
    
    function selectPlayerForRetention(player) {
      if (selectedRetentionPlayers.includes(player)) {
        selectedRetentionPlayers = selectedRetentionPlayers.filter(p => p !== player);
        document.querySelector(`.player-card[data-player="${player}"]`).classList.remove('selected');
        
        // If this player was captain, unset captain
        if (selectedCaptain === player) {
          selectedCaptain = null;
        }
      } else {
        if (selectedRetentionPlayers.length >= 6) {
          showNotification('Maximum 6 players can be retained');
          return;
        }
        
        selectedRetentionPlayers.push(player);
        document.querySelector(`.player-card[data-player="${player}"]`).classList.add('selected');
      }
      
      updateRetentionCalculations();
    }
    
    function selectCaptain(player) {
      if (selectedRetentionPlayers.includes(player)) {
        selectedCaptain = player;
        showNotification(`Selected ${player} as captain (‚Çπ4 Cr)`);
        
        // Show captain modal with confirmation
        captainOptions.innerHTML = `
          <div class="player-card captain" style="pointer-events: none;">
            <h3>${player}</h3>
            <p>Captain (‚Çπ4 Cr)</p>
          </div>
        `;
        
        captainModal.style.display = 'flex';
      } else {
        showNotification('Player must be retained to be captain');
      }
    }
    
    function confirmCaptain() {
      captainModal.style.display = 'none';
      updateRetentionCalculations();
    }
    
    function updateRetentionCalculations() {
      // Calculate costs
      let retentionCost = 0;
      
      // Captain costs 4 Cr if selected
      if (selectedCaptain) {
        retentionCost += 4;
      }
      
      // Other retained players cost 2 Cr each
      const otherPlayers = selectedRetentionPlayers.filter(p => p !== selectedCaptain);
      retentionCost += otherPlayers.length * 2;
      
      // Calculate RTM cards (6 - retained players)
      rtmCards = 6 - selectedRetentionPlayers.length;
      
      // Update UI
      postRetentionBudget.textContent = `‚Çπ${150 - retentionCost} Cr`;
      rtmCount.textContent = rtmCards;
    }
    
    async function confirmRetention() {
      if (selectedRetentionPlayers.length === 0 && !selectedCaptain) {
        showNotification('No players selected for retention');
        return;
      }
      
      if (selectedCaptain && !selectedRetentionPlayers.includes(selectedCaptain)) {
        showNotification('Captain must be one of the retained players');
        return;
      }
      
      // Calculate final retention cost
      const retentionCost = (selectedCaptain ? 4 : 0) + 
                          (selectedRetentionPlayers.filter(p => p !== selectedCaptain).length * 2);
      
      // Update user data in Firebase
      try {
        const userRef = ref(db, `users/${currentUser}`);
        
        await update(userRef, {
          retainedPlayers: selectedRetentionPlayers,
          retentionCaptain: selectedCaptain || null,
          auctionBudget: 150 - retentionCost,
          rtmCards: rtmCards
        });
        
        showNotification('Retention confirmed!');
        
        // Proceed to next section based on admin status
        if (isAdmin) {
          retentionSection.classList.remove('active');
          setupSection.classList.add('active');
        } else {
          retentionSection.classList.remove('active');
          joinSection.classList.add('active');
        }
      } catch (error) {
        console.error('Error confirming retention:', error);
        showNotification('Failed to confirm retention. Please try again.');
      }
    }
    
    function skipRetention() {
      if (isAdmin) {
        retentionSection.classList.remove('active');
        setupSection.classList.add('active');
      } else {
        retentionSection.classList.remove('active');
        joinSection.classList.add('active');
      }
    }
    
    async function createRoom() {
      roomCode = roomCodeInput.value.trim();
      
      if (!roomCode) {
        showNotification('Please enter a room code');
        return;
      }
      
      try {
        // Check if room already exists
        const roomSnap = await get(ref(db, `auctions/${roomCode}`));
        
        if (roomSnap.exists()) {
          showNotification('Room already exists. Use a different code.');
          return;
        }
        
        // Create new room
        roomRef = ref(db, `auctions/${roomCode}`);
        
        await set(roomRef, {
          admin: currentUser,
          status: 'setup',
          teams: {
            [currentTeam]: {
              name: currentTeam,
              budget: 150,
              rtmCards: 0,
              squad: []
            }
          },
          playerPool: {},
          currentPlayer: null,
          auctionState: 'waiting'
        });
        
        statusDisplay.textContent = `Room: ${roomCode} (Admin)`;
        showNotification(`Auction room ${roomCode} created!`);
        
        // Show player pool section
        playerPoolSection.style.display = 'block';
        
        // Listen for room changes
        setupRoomListeners();
      } catch (error) {
        console.error('Error creating room:', error);
        showNotification('Failed to create room. Please try again.');
      }
    }
    
    async function joinRoom() {
      roomCode = joinRoomCode.value.trim();
      
      if (!roomCode) {
        showNotification('Please enter a room code');
        return;
      }
      
      try {
        // Check if room exists
        roomRef = ref(db, `auctions/${roomCode}`);
        const roomSnap = await get(roomRef);
        
        if (!roomSnap.exists()) {
          showNotification('Room not found. Check the code or ask admin.');
          return;
        }
        
        const roomData = roomSnap.val();
        
        // Check if team already joined
        if (roomData.teams && roomData.teams[currentTeam]) {
          showNotification('Your team has already joined this auction');
        } else {
          // Get user's budget and RTM cards
          const userSnap = await get(ref(db, `users/${currentUser}`));
          const userData = userSnap.val();
          
          const budget = userData.auctionBudget || 150;
          const rtm = userData.rtmCards || 0;
          
          // Add team to room
          await update(ref(db, `auctions/${roomCode}/teams`), {
            [currentTeam]: {
              name: currentTeam,
              budget: budget,
              rtmCards: rtm,
              squad: []
            }
          });
          
          showNotification(`Joined auction room ${roomCode}!`);
        }
        
        statusDisplay.textContent = `Room: ${roomCode}`;
        joinSection.classList.remove('active');
        
        if (roomData.status === 'setup') {
          showNotification('Waiting for admin to start auction...');
        } else if (roomData.status === 'auction') {
          auctionSection.classList.add('active');
          updateAuctionUI(roomData);
        }
        
        // Listen for room changes
        setupRoomListeners();
      } catch (error) {
        console.error('Error joining room:', error);
        showNotification('Failed to join room. Please try again.');
      }
    }
    
    function setupRoomListeners() {
      onValue(roomRef, (snap) => {
        if (!snap.exists()) {
          showNotification('Auction room has been closed');
          window.location.reload();
          return;
        }
        
        const roomData = snap.val();
        auctionState = roomData;
        
        if (isAdmin && roomData.status === 'setup') {
          // Update player pool display
          if (roomData.playerPool) {
            renderPlayerPool(Object.entries(roomData.playerPool));
            
            // Show start button if there are players
            if (Object.keys(roomData.playerPool).length > 0) {
              startAuctionBtn.style.display = 'inline-block';
            }
          }
        }
        
        if (roomData.status === 'auction') {
          // Hide other sections, show auction section
          setupSection.classList.remove('active');
          joinSection.classList.remove('active');
          retentionSection.classList.remove('active');
          auctionSection.classList.add('active');
          
          updateAuctionUI(roomData);
        }
      });
    }
    
    function renderPlayerPool(players) {
      playerPoolGrid.innerHTML = '';
      
      players.forEach(([key, player]) => {
        const playerCard = document.createElement('div');
        playerCard.className = 'player-card';
        playerCard.innerHTML = `
          <h3>${player.name}</h3>
          <p><span class="player-role role-${player.role.toLowerCase()}">${player.role}</span></p>
          <p>Base Price: ‚Çπ${player.basePrice} Cr</p>
        `;
        playerPoolGrid.appendChild(playerCard);
      });
    }
    
    async function addSinglePlayer() {
      const name = playerNameInput.value.trim();
      const role = playerRoleSelect.value;
      const basePrice = parseFloat(playerBasePrice.value);
      
      if (!name) {
        showNotification('Please enter player name');
        return;
      }
      
      if (isNaN(basePrice) || basePrice < 0.2) {
        showNotification('Please enter valid base price (min ‚Çπ0.20 Cr)');
        return;
      }
      
      try {
        const playerKey = name.toLowerCase().replace(/\s+/g, '_');
        
        await update(ref(db, `auctions/${roomCode}/playerPool/${playerKey}`), {
          name: name,
          role: role,
          basePrice: basePrice,
          status: 'available'
        });
        
        showNotification(`Added ${name} to player pool`);
        playerNameInput.value = '';
        addPlayerModal.style.display = 'none';
      } catch (error) {
        console.error('Error adding player:', error);
        showNotification('Failed to add player. Please try again.');
      }
    }
    
    async function bulkAddPlayers() {
      const role = bulkRoleSelect.value;
      const basePrice = parseFloat(bulkBasePrice.value);
      const namesText = csvPlayerInput.value.trim();
      
      if (!namesText) {
        showNotification('Please enter player names');
        return;
      }
      
      if (isNaN(basePrice) || basePrice < 0.2) {
        showNotification('Please enter valid base price (min ‚Çπ0.20 Cr)');
        return;
      }
      
      const names = namesText.split('\n')
        .map(name => name.trim())
        .filter(name => name.length > 0);
      
      if (names.length === 0) {
        showNotification('No valid player names found');
        return;
      }
      
      try {
        const updates = {};
        
        names.forEach(name => {
          const playerKey = name.toLowerCase().replace(/\s+/g, '_');
          updates[`${playerKey}/name`] = name;
          updates[`${playerKey}/role`] = role;
          updates[`${playerKey}/basePrice`] = basePrice;
          updates[`${playerKey}/status`] = 'available';
        });
        
        await update(ref(db, `auctions/${roomCode}/playerPool`), updates);
        
        showNotification(`Added ${names.length} players to pool`);
        csvPlayerInput.value = '';
        bulkAddModal.style.display = 'none';
      } catch (error) {
        console.error('Error bulk adding players:', error);
        showNotification('Failed to add players. Please try again.');
      }
    }
    
    async function startAuction() {
      try {
        // Change room status to auction
        await update(roomRef, {
          status: 'auction',
          auctionState: 'waiting'
        });
        
        showNotification('Auction started! Teams can now join.');
      } catch (error) {
        console.error('Error starting auction:', error);
        showNotification('Failed to start auction. Please try again.');
      }
    }
    
    function updateAuctionUI(roomData) {
      // Update team budget and RTM cards
      if (roomData.teams && roomData.teams[currentTeam]) {
        const teamData = roomData.teams[currentTeam];
        remainingBudget.textContent = `‚Çπ${teamData.budget} Cr`;
        rtmRemaining.textContent = teamData.rtmCards || 0;
        
        // Update squad list
        teamSquadList.innerHTML = '';
        if (teamData.squad) {
          squadCount.textContent = teamData.squad.length;
          
          teamData.squad.forEach(player => {
            const li = document.createElement('li');
            li.innerHTML = `
              ${player.name} <span class="player-cost">‚Çπ${player.price} Cr</span>
              <span class="player-role role-${player.role.toLowerCase()}">${player.role}</span>
            `;
            teamSquadList.appendChild(li);
          });
        }
      }
      
      // Update current player display
      if (roomData.currentPlayer) {
        currentPlayerCard.style.display = 'block';
        currentPlayerKey = roomData.currentPlayer;
        currentPlayerData = roomData.playerPool[currentPlayerKey];
        
        currentPlayerName.textContent = currentPlayerData.name;
        currentPlayerRole.textContent = currentPlayerData.role;
        
        if (roomData.auctionState === 'bidding') {
          currentBid = currentPlayerData.currentBid || currentPlayerData.basePrice;
          currentPlayerPrice.textContent = `Current Bid: ‚Çπ${currentBid} Cr`;
          
          // Start timer if admin
          if (isAdmin && !timerInterval) {
            startTimer();
          }
        } else if (roomData.auctionState === 'sold') {
          currentPlayerPrice.textContent = `Sold for: ‚Çπ${currentPlayerData.soldPrice} Cr`;
          soldToDisplay.textContent = `To: ${currentPlayerData.soldTo}`;
          auctionTimer.textContent = 'Sold!';
        } else {
          currentPlayerPrice.textContent = `Base Price: ‚Çπ${currentPlayerData.basePrice} Cr`;
          soldToDisplay.textContent = '';
        }
        
        // Check if RTM is available for this player
        isRtmAvailable = false;
        if (roomData.teams && roomData.teams[currentTeam] && 
            roomData.teams[currentTeam].rtmCards > 0 && 
            retentionPlayers.includes(currentPlayerData.name)) {
          isRtmAvailable = true;
        }
        
        rtmBtn.style.display = isRtmAvailable ? 'inline-block' : 'none';
      } else {
        currentPlayerCard.style.display = 'none';
      }
      
      // Show admin controls if admin
      adminAuctionControls.style.display = isAdmin ? 'block' : 'none';
    }
    
    function startTimer() {
      clearInterval(timerInterval);
      timeLeft = 30;
      auctionTimer.textContent = `${timeLeft}s`;
      
      timerInterval = setInterval(() => {
        timeLeft--;
        auctionTimer.textContent = `${timeLeft}s`;
        
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          if (isAdmin) {
            autoSell();
          }
        }
      }, 1000);
    }
    
    async function nextPlayer() {
      try {
        // Find next available player
        const players = Object.entries(auctionState.playerPool || {})
          .filter(([key, player]) => player.status === 'available');
        
        if (players.length === 0) {
          showNotification('No more players in pool');
          return;
        }
        
        // Select first available player
        const [playerKey, playerData] = players[0];
        
        await update(roomRef, {
          currentPlayer: playerKey,
          auctionState: 'bidding',
          [`playerPool/${playerKey}/currentBid`]: playerData.basePrice,
          [`playerPool/${playerKey}/currentBidder`]: null
        });
        
        showNotification(`${playerData.name} is now up for auction!`);
      } catch (error) {
        console.error('Error moving to next player:', error);
        showNotification('Failed to move to next player. Please try again.');
      }
    }
    
    async function placeBid(increment) {
      if (!currentPlayerKey || !currentPlayerData) {
        showNotification('No player currently up for auction');
        return;
      }
      
      const newBid = currentBid + increment;
      const teamData = auctionState.teams[currentTeam];
      
      // Check if team has enough budget
      if (newBid > teamData.budget) {
        showNotification('Not enough budget for this bid');
        return;
      }
      
      try {
        await update(roomRef, {
          [`playerPool/${currentPlayerKey}/currentBid`]: newBid,
          [`playerPool/${currentPlayerKey}/currentBidder`]: currentTeam
        });
        
        // Reset timer if admin
        if (isAdmin) {
          startTimer();
        }
      } catch (error) {
        console.error('Error placing bid:', error);
        showNotification('Failed to place bid. Please try again.');
      }
    }
    
    async function passBid() {
      showNotification('Passed on current player');
      
      // If admin and no bids, move to next player
      if (isAdmin && (!currentPlayerData.currentBidder || currentPlayerData.currentBidder === null)) {
        await update(roomRef, {
          [`playerPool/${currentPlayerKey}/status`]: 'passed',
          currentPlayer: null,
          auctionState: 'waiting'
        });
        
        showNotification('Player passed with no bids');
      }
    }
    
    async function autoSell() {
      if (!currentPlayerKey || !currentPlayerData) {
        showNotification('No player currently up for auction');
        return;
      }
      
      if (!currentPlayerData.currentBidder) {
        showNotification('No bids to auto sell');
        return;
      }
      
      try {
        await sellPlayerTo(currentPlayerData.currentBidder, currentBid);
      } catch (error) {
        console.error('Error auto selling:', error);
        showNotification('Failed to auto sell. Please try again.');
      }
    }
    
    async function sellPlayer() {
      if (!currentPlayerKey || !currentPlayerData) {
        showNotification('No player currently up for auction');
        return;
      }
      
      try {
        // Admin can manually select buyer and price
        const buyer = prompt('Enter buying team name:');
        const price = parseFloat(prompt('Enter selling price (in Cr):'));
        
        if (!buyer || !price || isNaN(price)) {
          showNotification('Invalid buyer or price');
          return;
        }
        
        await sellPlayerTo(buyer, price);
      } catch (error) {
        console.error('Error selling player:', error);
        showNotification('Failed to sell player. Please try again.');
      }
    }
    
    async function sellPlayerTo(buyer, price) {
      // Update player status
      await update(roomRef, {
        [`playerPool/${currentPlayerKey}/status`]: 'sold',
        [`playerPool/${currentPlayerKey}/soldPrice`]: price,
        [`playerPool/${currentPlayerKey}/soldTo`]: buyer,
        auctionState: 'sold'
      });
      
      // Update buyer's squad and budget
      const buyerRef = ref(db, `auctions/${roomCode}/teams/${buyer}`);
      const buyerSnap = await get(buyerRef);
      const buyerData = buyerSnap.val();
      
      const updatedSquad = [...(buyerData.squad || []), {
        name: currentPlayerData.name,
        role: currentPlayerData.role,
        price: price
      }];
      
      await update(buyerRef, {
        squad: updatedSquad,
        budget: buyerData.budget - price
      });
      
      showNotification(`${currentPlayerData.name} sold to ${buyer} for ‚Çπ${price} Cr!`);
      
      // Clear timer
      clearInterval(timerInterval);
    }
    
    async function useRtm() {
      if (!isRtmAvailable) {
        showNotification('RTM not available for this player');
        return;
      }
      
      // Show RTM confirmation modal
      rtmBidAmount.textContent = `‚Çπ${currentBid} Cr`;
      rtmModal.style.display = 'flex';
    }
    
    async function confirmRtm() {
      try {
        const teamRef = ref(db, `auctions/${roomCode}/teams/${currentTeam}`);
        const teamSnap = await get(teamRef);
        const teamData = teamSnap.val();
        
        // Check if still have RTM cards
        if (teamData.rtmCards <= 0) {
          showNotification('No RTM cards remaining');
          return;
        }
        
        // Check if can afford the bid
        if (currentBid > teamData.budget) {
          showNotification('Not enough budget to use RTM');
          return;
        }
        
        // Use RTM
        await update(teamRef, {
          rtmCards: teamData.rtmCards - 1
        });
        
        // Sell player to this team
        await sellPlayerTo(currentTeam, currentBid);
        
        showNotification(`Used RTM card to acquire ${currentPlayerData.name}!`);
        rtmModal.style.display = 'none';
      } catch (error) {
        console.error('Error using RTM:', error);
        showNotification('Failed to use RTM. Please try again.');
      }
    }
    
    function showNotification(message) {
      notificationText.textContent = message;
      notification.style.display = 'block';
      
      setTimeout(() => {
        notification.style.display = 'none';
      }, 3000);
    }
    
    // Make some functions available globally for HTML onclick handlers
    window.selectPlayerForRetention = selectPlayerForRetention;
    window.selectCaptain = selectCaptain;
  </script>
</body>
</html>