<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Select Playing XI | HandiCricket</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body { 
      background: #071e34; 
      color: white; 
      font-family: 'Segoe UI', sans-serif;
      padding: 20px; 
      display: flex; 
      flex-direction: column; 
      align-items: center;
      min-height: 100vh;
    }
    h1, h2, h3 { 
      color: #90caf9;
      text-align: center;
    }
    .container { 
      background: #123456;
      padding: 25px;
      border-radius: 16px; 
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      max-width: 800px;
      width: 100%;
      transition: transform 0.3s ease;
    }
    .container:hover {
      transform: translateY(-5px);
    }
    #roomCode { 
      margin: 15px 0;
      font-weight: bold; 
      font-size: 18px;
      color: #90caf9;
      text-align: center;
      padding: 10px;
      background: rgba(30, 136, 229, 0.2);
      border-radius: 8px;
      width: 100%;
    }
    #waitingMessage { 
      margin: 20px 0 15px;
      color: #ffeb3b;
      text-align: center;
      font-size: 16px;
      padding: 10px;
      border-radius: 8px;
      background: rgba(255, 235, 59, 0.1);
    }
    .format-selector {
      margin-bottom: 20px;
    }
    select {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border-radius: 8px;
      border: 2px solid #1e88e5;
      font-size: 16px;
      background: rgba(255,255,255,0.1);
      color: white;
      transition: all 0.3s ease;
    }
    select:focus {
      outline: none;
      border-color: #4caf50;
      box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.3);
    }
    .team-selection {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }
    .player-list, .selected-team {
      flex: 1;
      background: rgba(30, 136, 229, 0.1);
      padding: 15px;
      border-radius: 8px;
      height: 400px;
      overflow-y: auto;
      border: 1px solid #1e88e5;
    }
    ul {
      list-style-type: none;
      padding: 0;
      margin: 0;
    }
    li {
      padding: 10px;
      margin: 5px 0;
      background-color: rgba(30, 136, 229, 0.2);
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }
    li:hover {
      background-color: rgba(30, 136, 229, 0.4);
    }
    .selected-team li {
      background-color: rgba(76, 175, 80, 0.3);
    }
    .selected-team li:hover {
      background-color: rgba(76, 175, 80, 0.5);
    }
    button { 
      width: 100%; 
      padding: 14px; 
      margin-top: 20px;
      border-radius: 10px; 
      background: linear-gradient(135deg, #1e88e5, #1565c0);
      color: white; 
      font-size: 16px; 
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    button:hover { 
      background: linear-gradient(135deg, #1565c0, #0d47a1);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    button:disabled {
      background: #95a5a6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    button:active {
      transform: translateY(0);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Select Your Playing XI</h1>
    <div id="roomCode"></div>
    
    <div class="format-selector">
      <h3>Select Match Format:</h3>
      <select id="match-format">
        <option value="5">5 Overs</option>
        <option value="10">10 Overs</option>
        <option value="20" selected>20 Overs (T20)</option>
        <option value="50">50 Overs (ODI)</option>
        <option value="test">Test Match</option>
      </select>
    </div>
    
    <div class="team-selection">
      <div class="player-list">
        <h3>Available Players</h3>
        <ul id="available-players">
          <!-- Will be populated by JS -->
        </ul>
      </div>
      
      <div class="selected-team">
        <h3>Your Team (0/11)</h3>
        <ul id="selected-players"></ul>
      </div>
    </div>
    
    <button id="confirm-team" disabled>Confirm Team</button>
    <div id="waitingMessage"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getDatabase, ref, set, get, onValue } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAGU0Tsj9pwZcgwQjZzTFvGOE032l2b7HI",
      authDomain: "handicricket-d1ab7.firebaseapp.com",
      projectId: "handicricket-d1ab7",
      storageBucket: "handicricket-d1ab7.appspot.com",
      messagingSenderId: "356065986337",
      appId: "1:356065986337:web:399102c5dabfca2b6fe060"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const urlParams = new URLSearchParams(window.location.search);
    const room = urlParams.get('room');
    const player = urlParams.get('player');
    let gameInProgress = true;

    document.getElementById("roomCode").innerText = "Room Code: " + room;

    // Back button handling
    window.addEventListener('beforeunload', (e) => {
      if (gameInProgress) {
        e.preventDefault();
        e.returnValue = 'Are you sure you want to leave? Your progress may be lost.';
        return e.returnValue;
      }
    });

    if (window.history && window.history.pushState) {
      window.history.pushState('forward', null, './');
      window.onpopstate = function() {
        if (confirm("Do you really want to exit? Your progress will be lost!")) {
          window.location.href = "index.html";
        } else {
          window.history.pushState('forward', null, './');
        }
      };
    }

    const availablePlayers = [
      "Rohit Sharma", "Virat Kohli", "MS Dhoni", "Rishabh Pant", 
      "Ravindra Jadeja", "Jasprit Bumrah", "Mohammed Shami",
      "KL Rahul", "Hardik Pandya", "Ravichandran Ashwin", 
      "Shreyas Iyer", "Ishan Kishan", "Suryakumar Yadav", "Yuzvendra Chahal"
    ];
    
    const availablePlayersList = document.getElementById('available-players');
    const selectedPlayersList = document.getElementById('selected-players');
    const confirmBtn = document.getElementById('confirm-team');
    const waitingMessage = document.getElementById('waitingMessage');
    let selectedPlayers = [];
    
    // Populate available players
    function populatePlayers() {
      availablePlayersList.innerHTML = '';
      availablePlayers.forEach(player => {
        if (!selectedPlayers.includes(player)) {
          const li = document.createElement('li');
          li.textContent = player;
          li.addEventListener('click', () => selectPlayer(player, li));
          availablePlayersList.appendChild(li);
        }
      });
    }
    
    function selectPlayer(player, element) {
      if (selectedPlayers.length >= 11) {
        alert('You can only select 11 players!');
        return;
      }
      
      selectedPlayers.push(player);
      element.remove();
      updateSelectedTeam();
      
      if (selectedPlayers.length === 11) {
        confirmBtn.disabled = false;
      }
    }
    
    function updateSelectedTeam() {
      selectedPlayersList.innerHTML = '';
      selectedPlayers.forEach((player, index) => {
        const li = document.createElement('li');
        li.textContent = `${index + 1}. ${player}`;
        li.addEventListener('click', () => deselectPlayer(player, li));
        selectedPlayersList.appendChild(li);
      });
      
      document.querySelector('.selected-team h3').textContent = 
        `Your Team (${selectedPlayers.length}/11)`;
    }
    
    function deselectPlayer(player, element) {
      selectedPlayers = selectedPlayers.filter(p => p !== player);
      element.remove();
      updateSelectedTeam();
      populatePlayers();
      
      confirmBtn.disabled = selectedPlayers.length !== 11;
    }
    
    confirmBtn.addEventListener('click', async () => {
      const format = document.getElementById('match-format').value;
      
      // Validate team selection
      if (selectedPlayers.length !== 11) {
        alert('Please select exactly 11 players!');
        return;
      }
      
      try {
        // Save team to Firebase
        await set(ref(db, `rooms/${room}/${player}/playing11`), {
          players: selectedPlayers,
          format: format
        });
        
        // Show confirmation
        confirmBtn.textContent = 'Team Submitted!';
        confirmBtn.style.background = 'linear-gradient(135deg, #27ae60, #219653)';
        confirmBtn.disabled = true;
        waitingMessage.textContent = "Waiting for opponent...";
        
        // Wait for opponent's team
        const teamsRef = ref(db, `rooms/${room}`);
        onValue(teamsRef, (snapshot) => {
          const roomData = snapshot.val();
          if (!roomData) return;

          const opponent = player === 'player1' ? 'player2' : 'player1';
          if (roomData[opponent]?.playing11) {
            window.location.href = `toss.html?room=${room}&player=${player}`;
          }
        }, { onlyOnce: false });
        
      } catch (error) {
        console.error('Error saving team:', error);
        alert('Error saving team. Please try again.');
        confirmBtn.textContent = 'Confirm Team';
        confirmBtn.style.background = 'linear-gradient(135deg, #1e88e5, #1565c0)';
      }
    });
    
    // Initialize the player lists
    populatePlayers();
  </script>
</body>
</html>
