<!-- Save this as ai_game.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>HandiCricket - AI Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { background: #061e3e; color: white; font-family: sans-serif; text-align: center; padding: 20px; }
    .container { max-width: 500px; margin: auto; padding: 20px; background: rgba(0,0,0,0.2); border-radius: 12px; }
    h2 { color: #ffd700; margin-bottom: 15px; }
    button { padding: 10px 20px; font-size: 16px; margin: 8px; background: #1e88e5; border: none; border-radius: 8px; color: white; cursor: pointer; }
    button:hover { background: #1565c0; }
    .scoreboard { margin: 20px 0; background: #0d2a52; padding: 15px; border-radius: 10px; }
    .ai-thinking { color: #ff9800; font-style: italic; margin-top: 10px; }
    .highlight { color: #ffeb3b; font-weight: bold; }
  </style>
</head>
<body>
  <div class="container">
    <h2>ðŸ¤– HandiCricket: Player vs AI</h2>
    <div id="gameStatus">Initializing...</div>
    <div class="scoreboard" id="scoreBoard">Score: 0/0 (0.0)</div>
    <div id="cardOptions" style="display:none;"></div>
    <div class="ai-thinking" id="aiThinking" style="display:none;">AI is thinking<span id="dots">.</span></div>
    <div id="resultMessage" style="margin-top: 15px;"></div>
  </div>

  <script type="module">
    import { db, ref, set, get, update, onValue } from './firebase.js';
    import { AIOpponent } from './ai.js';

    const urlParams = new URLSearchParams(window.location.search);
    const room = urlParams.get('room');
    const player = urlParams.get('player');
    const format = urlParams.get('format') || '5';
    const difficulty = urlParams.get('difficulty') || 'medium';
    const oversLimit = parseInt(format);

    const opponent = player === 'player1' ? 'player2' : 'player1';
    const ai = new AIOpponent(difficulty);

    let innings = 1;
    let isPlayerBatting = true;
    let firstInningsScore = 0;

    const state = { score: 0, wickets: 0, balls: 0 };
    const gameStatus = document.getElementById("gameStatus");
    const scoreBoard = document.getElementById("scoreBoard");
    const cardOptions = document.getElementById("cardOptions");
    const resultMessage = document.getElementById("resultMessage");
    const aiThinking = document.getElementById("aiThinking");
    const dots = document.getElementById("dots");

    function updateScoreboard() {
      const oversText = `${Math.floor(state.balls / 6)}.${state.balls % 6}`;
      scoreBoard.textContent = `Score: ${state.score}/${state.wickets} (${oversText})`;
    }

    function showCardOptions() {
      cardOptions.innerHTML = "";
      for (let i = 0; i <= 6; i++) {
        const btn = document.createElement("button");
        btn.textContent = i;
        btn.onclick = () => playCard(i);
        cardOptions.appendChild(btn);
      }
      cardOptions.style.display = "block";
    }

    function startDotAnimation() {
      let count = 1;
      dots.textContent = '.';
      return setInterval(() => {
        count = (count % 3) + 1;
        dots.textContent = '.'.repeat(count);
      }, 300);
    }

    function playCard(playerCard) {
      cardOptions.style.display = "none";
      aiThinking.style.display = "block";
      const anim = startDotAnimation();

      setTimeout(() => {
        clearInterval(anim);
        aiThinking.style.display = "none";
        const aiCard = ai.makeDecision({
          runs: state.score,
          wickets: state.wickets,
          ballsLeft: oversLimit * 6 - state.balls,
          target: innings === 2 ? firstInningsScore + 1 : null
        });

        let msg = "";
        if (playerCard === aiCard) {
          state.wickets++;
          msg = `<span class='highlight'>WICKET!</span> You: ${playerCard}, AI: ${aiCard}`;
        } else {
          state.score += playerCard;
          msg = `You scored ${playerCard}. AI played ${aiCard}`;
        }

        state.balls++;
        resultMessage.innerHTML = msg;
        updateScoreboard();

        if (state.wickets >= 10 || state.balls >= oversLimit * 6 || (innings === 2 && state.score > firstInningsScore)) {
          if (innings === 1) {
            firstInningsScore = state.score;
            innings = 2;
            isPlayerBatting = false;
            gameStatus.textContent = `Innings Break. Target: ${firstInningsScore + 1}`;
            resetState();
            setTimeout(() => {
              gameStatus.textContent = "AI is batting now.";
              showAIBatting();
            }, 2000);
          } else {
            endGame();
          }
        } else {
          showCardOptions();
        }
      }, 1500);
    }

    function resetState() {
      state.score = 0;
      state.wickets = 0;
      state.balls = 0;
      resultMessage.innerHTML = "";
      updateScoreboard();
    }

    function showAIBatting() {
      const interval = setInterval(() => {
        const aiBat = ai.makeDecision({
          runs: state.score,
          wickets: state.wickets,
          ballsLeft: oversLimit * 6 - state.balls,
          target: firstInningsScore + 1
        });
        const playerBall = Math.floor(Math.random() * 7);

        let msg = "";
        if (aiBat === playerBall) {
          state.wickets++;
          msg = `<span class='highlight'>WICKET!</span> AI: ${aiBat}, You: ${playerBall}`;
        } else {
          state.score += aiBat;
          msg = `AI scored ${aiBat}. You bowled ${playerBall}`;
        }

        state.balls++;
        resultMessage.innerHTML = msg;
        updateScoreboard();

        if (state.wickets >= 10 || state.balls >= oversLimit * 6 || state.score > firstInningsScore) {
          clearInterval(interval);
          endGame();
        }
      }, 2000);
    }

    function endGame() {
      let result = "";
      if (state.score > firstInningsScore) {
        result = isPlayerBatting ? "You Win!" : "AI Wins!";
      } else if (state.score < firstInningsScore) {
        result = isPlayerBatting ? "AI Wins!" : "You Win!";
      } else {
        result = "Match Drawn!";
      }
      gameStatus.textContent = result;
      resultMessage.innerHTML += `<br><strong>Final Score: ${state.score}/${state.wickets}</strong>`;
      cardOptions.style.display = "none";
    }

    onValue(ref(db, `rooms/${room}/decision`), (snap) => {
      if (!snap.exists()) return;
      const decision = snap.val();
      isPlayerBatting = decision === 'bat';
      gameStatus.textContent = isPlayerBatting ? "You are batting first." : "AI is batting first.";
      if (isPlayerBatting) {
        updateScoreboard();
        showCardOptions();
      } else {
        resetState();
        showAIBatting();
      }
    });
  </script>
</body>
</html>
