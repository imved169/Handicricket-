<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HandiCricket</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h1>üèè HandiCricket</h1>
        <p>The digital cricket card game</p>
        
        <div class="menu">
            <button id="create-game" class="btn">Create Game</button>
            <button id="join-game" class="btn">Join Game</button>
        </div>
        
        <div id="join-form" class="hidden">
            <input type="text" id="game-id" placeholder="Enter Game ID" maxlength="4">
            <button id="confirm-join" class="btn">Join</button>
            <button id="back-btn" class="btn secondary">Back</button>
        </div>
        
        <div id="game-created" class="hidden">
            <p>Your Game ID:</p>
            <div id="game-code" class="game-code"></div>
            <p>Share this with your opponent</p>
            <div class="loader"></div>
            <p id="waiting-text">Waiting for opponent...</p>
        </div>
    </div>

    <script type="module">
        import { db, ref, set, onValue } from './firebase.js';
        
        // Generate 4-letter game ID
        function generateId() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let result = '';
            for (let i = 0; i < 4; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }
        
        // DOM elements
        const createBtn = document.getElementById('create-game');
        const joinBtn = document.getElementById('join-game');
        const joinForm = document.getElementById('join-form');
        const gameCreated = document.getElementById('game-created');
        const gameCode = document.getElementById('game-code');
        const confirmJoin = document.getElementById('confirm-join');
        const backBtn = document.getElementById('back-btn');
        
        // Create new game
        createBtn.addEventListener('click', async () => {
            const gameId = generateId();
            gameCode.textContent = gameId;
            gameCreated.classList.remove('hidden');
            document.querySelector('.menu').classList.add('hidden');
            
            // Save to Firebase
            await set(ref(db, `games/${gameId}`), {
                created: Date.now(),
                status: 'waiting',
                players: { player1: true }
            });
            
            localStorage.setItem('gameId', gameId);
            localStorage.setItem('player', 'player1');
            
            // Wait for player2
            onValue(ref(db, `games/${gameId}/players/player2`), (snapshot) => {
                if (snapshot.exists()) {
                    window.location.href = 'game.html';
                }
            });
        });
        
        // Join existing game
        joinBtn.addEventListener('click', () => {
            joinForm.classList.remove('hidden');
            document.querySelector('.menu').classList.add('hidden');
        });
        
        confirmJoin.addEventListener('click', async () => {
            const gameId = document.getElementById('game-id').value.trim().toUpperCase();
            if (gameId.length === 4) {
                // Check if game exists
                const snapshot = await get(ref(db, `games/${gameId}`));
                if (snapshot.exists()) {
                    localStorage.setItem('gameId', gameId);
                    localStorage.setItem('player', 'player2');
                    
                    // Register player2
                    await set(ref(db, `games/${gameId}/players/player2`), true);
                    window.location.href = 'game.html';
                } else {
                    alert('Game not found');
                }
            } else {
                alert('Please enter a valid 4-character ID');
            }
        });
        
        backBtn.addEventListener('click', () => {
            joinForm.classList.add('hidden');
            document.querySelector('.menu').classList.remove('hidden');
        });
    </script>
</body>
</html>
