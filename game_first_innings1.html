<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HandiCricket - First Innings</title>
  <style>
    :root {
      --primary: #1e88e5;
      --secondary: #1565c0;
      --accent: #ffeb3b;
      --danger: #f44336;
      --success: #4CAF50;
      --warning: #FF9800;
      --dark: #061e3e;
      --light: #f5f5f5;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(rgba(6, 30, 62, 0.9), rgba(6, 30, 62, 0.9)), 
                  url('https://images.unsplash.com/photo-1540747913346-19e32dc3e97e?ixlib=rb-1.2.1&auto=format&fit=crop&w=1200&q=80');
      background-size: cover;
      background-position: center;
      color: white;
      min-height: 100vh;
      padding: 20px;
      overflow-x: hidden;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .match-info {
      text-align: center;
      margin-bottom: 20px;
    }
    
    .teams {
      display: flex;
      justify-content: space-around;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .team {
      flex: 1;
      padding: 10px;
    }
    
    .team-name {
      font-size: 18px;
      font-weight: bold;
      color: var(--accent);
      margin-bottom: 5px;
    }
    
    .scoreboard {
      background: rgba(13, 42, 82, 0.7);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .score {
      font-size: 36px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .details {
      display: flex;
      justify-content: space-around;
      font-size: 14px;
    }
    
    .over-progress {
      display: flex;
      justify-content: center;
      margin: 15px 0;
    }
    
    .ball {
      width: 25px;
      height: 25px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      margin: 0 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
    }
    
    .ball.dot {
      background: var(--primary);
    }
    
    .ball.run {
      background: var(--success);
    }
    
    .ball.wicket {
      background: var(--danger);
    }
    
    .ball.wide {
      background: var(--warning);
    }
    
    .ball.noball {
      background: var(--accent);
      color: #000;
    }
    
    .over-number {
      margin-left: 10px;
      font-weight: bold;
    }
    
    .game-area {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .card-buttons {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    
    .card-btn {
      width: 50px;
      height: 70px;
      margin: 5px;
      border: none;
      border-radius: 8px;
      background: rgba(30, 136, 229, 0.8);
      color: white;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    }
    
    .card-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 10px rgba(0, 0, 0, 0.3);
    }
    
    .card-btn:active {
      transform: translateY(1px);
    }
    
    .card-btn.selected {
      background: var(--accent);
      color: #000;
      transform: translateY(-5px);
      box-shadow: 0 8px 12px rgba(0, 0, 0, 0.3);
    }
    
    .card-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .status {
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      text-align: center;
      font-weight: bold;
    }
    
    .status.powerplay {
      background: rgba(255, 235, 59, 0.2);
      border: 1px solid var(--accent);
    }
    
    .status.dead-over {
      background: rgba(244, 67, 54, 0.2);
      border: 1px solid var(--danger);
    }
    
    .status.free-hit {
      background: rgba(76, 175, 80, 0.2);
      border: 1px solid var(--success);
    }
    
    .commentary {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      padding: 15px;
      margin-top: 20px;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .commentary-item {
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .commentary-item:last-child {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }
    
    .commentary-item.wicket {
      color: var(--danger);
    }
    
    .commentary-item.boundary {
      color: var(--accent);
    }
    
    .commentary-item.milestone {
      color: var(--success);
    }
    
    .action-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }
    
    .action-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      background: var(--primary);
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    
    .action-btn:hover {
      background: var(--secondary);
    }
    
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }
    
    .modal.active {
      opacity: 1;
      pointer-events: all;
    }
    
    .modal-content {
      background: var(--dark);
      border-radius: 10px;
      padding: 20px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      border: 1px solid var(--primary);
    }
    
    .modal-title {
      font-size: 20px;
      margin-bottom: 15px;
      color: var(--accent);
      text-align: center;
    }
    
    .player-list {
      list-style: none;
    }
    
    .player-item {
      padding: 10px;
      margin: 5px 0;
      background: rgba(30, 136, 229, 0.2);
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .player-item:hover {
      background: rgba(30, 136, 229, 0.4);
    }
    
    .player-item.selected {
      background: var(--accent);
      color: #000;
    }
    
    .player-item.out {
      opacity: 0.5;
      text-decoration: line-through;
    }
    
    .close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
    }
    
    .shake {
      animation: shake 0.5s;
    }
    
    @keyframes shake {
      0% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      50% { transform: translateX(10px); }
      75% { transform: translateX(-10px); }
      100% { transform: translateX(0); }
    }
    
    .stumps {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 200;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }
    
    .stumps.active {
      opacity: 1;
    }
    
    .stump {
      position: absolute;
      width: 20px;
      height: 80px;
      background: linear-gradient(to bottom, #8B4513, #A0522D);
      bottom: 0;
    }
    
    .stump-1 {
      left: -30px;
      transform: rotate(-15deg);
      animation: fall-left 1s forwards;
    }
    
    .stump-2 {
      left: 0;
      animation: fall-middle 1s forwards;
    }
    
    .stump-3 {
      left: 30px;
      transform: rotate(15deg);
      animation: fall-right 1s forwards;
    }
    
    .bail {
      position: absolute;
      width: 40px;
      height: 10px;
      background: #fff;
      top: -10px;
      left: -20px;
      animation: bail-fly 1s forwards;
    }
    
    @keyframes fall-left {
      0% { transform: rotate(-15deg); }
      100% { transform: rotate(-70deg) translateY(20px); }
    }
    
    @keyframes fall-middle {
      0% { transform: rotate(0); }
      100% { transform: rotate(-10deg) translateY(20px); }
    }
    
    @keyframes fall-right {
      0% { transform: rotate(15deg); }
      100% { transform: rotate(70deg) translateY(20px); }
    }
    
    @keyframes bail-fly {
      0% { transform: translate(0, 0); }
      100% { transform: translate(30px, -50px) rotate(360deg); }
    }
    
    .confetti {
      position: fixed;
      width: 10px;
      height: 10px;
      background: var(--accent);
      opacity: 0;
      z-index: 200;
    }
    
    .wicket-bar {
      height: 5px;
      background: rgba(255, 255, 255, 0.2);
      margin-top: 5px;
      border-radius: 3px;
      overflow: hidden;
    }
    
    .wicket-progress {
      height: 100%;
      background: var(--danger);
      width: 0%;
      transition: width 0.3s;
    }
    
    .player-stats {
      display: flex;
      justify-content: space-between;
      margin-top: 5px;
      font-size: 12px;
    }
    
    .player-name {
      font-weight: bold;
    }
    
    .player-runs {
      color: var(--accent);
    }
    
    .player-balls {
      color: #aaa;
    }
    
    .player-sr {
      color: var(--success);
    }
    
    .team-modal {
      display: flex;
      flex-direction: column;
    }
    
    .team-slider {
      display: flex;
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      margin-bottom: 15px;
    }
    
    .team-slide {
      min-width: 100%;
      scroll-snap-align: start;
      padding: 10px;
    }
    
    .team-title {
      text-align: center;
      margin-bottom: 10px;
      color: var(--accent);
    }
    
    .team-players {
      list-style: none;
    }
    
    .team-player {
      padding: 8px;
      margin: 5px 0;
      background: rgba(30, 136, 229, 0.2);
      border-radius: 5px;
    }
    
    .dots-counter {
      font-size: 12px;
      color: #aaa;
      margin-top: 3px;
    }
    
    .dots-counter.warning {
      color: var(--warning);
    }
    
    .dots-counter.danger {
      color: var(--danger);
    }
    
    .powerplay-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--accent);
      margin-left: 5px;
    }
    
    .dead-over-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--danger);
      margin-left: 5px;
    }
    
    .freehit-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--success);
      margin-left: 5px;
    }
    
    @media (max-width: 600px) {
      .card-btn {
        width: 40px;
        height: 60px;
        font-size: 20px;
        margin: 3px;
      }
      
      .score {
        font-size: 28px;
      }
      
      .details {
        font-size: 12px;
      }
      
      .ball {
        width: 20px;
        height: 20px;
        font-size: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="room-code">Room: <span id="roomCode"></span></div>
      <div class="format">Format: <span id="formatDisplay"></span></div>
      <button id="teamsBtn">View Teams</button>
    </div>
    
    <div class="match-info">
      <h2 id="inningsTitle">First Innings</h2>
      <div id="matchStatus"></div>
    </div>
    
    <div class="teams">
      <div class="team">
        <div class="team-name" id="battingTeam"></div>
        <div id="batterInfo"></div>
      </div>
      <div class="team">
        <div class="team-name" id="bowlingTeam"></div>
        <div id="bowlerInfo"></div>
      </div>
    </div>
    
    <div class="scoreboard">
      <div class="score" id="scoreDisplay">0/0</div>
      <div class="details">
        <div>Overs: <span id="oversDisplay">0.0</span></div>
        <div>Run Rate: <span id="runRate">0.00</span></div>
        <div>Target: <span id="targetDisplay"></span></div>
      </div>
    </div>
    
    <div class="over-progress">
      <div id="ballsContainer"></div>
      <div class="over-number" id="overNumber">Over 0</div>
    </div>
    
    <div class="status" id="statusIndicator"></div>
    
    <div class="game-area">
      <div class="card-buttons" id="cardButtons">
        <button class="card-btn" data-value="0">0</button>
        <button class="card-btn" data-value="1">1</button>
        <button class="card-btn" data-value="2">2</button>
        <button class="card-btn" data-value="3">3</button>
        <button class="card-btn" data-value="4">4</button>
        <button class="card-btn" data-value="5">5</button>
        <button class="card-btn" data-value="6">6</button>
      </div>
      
      <div id="resultDisplay"></div>
      
      <div class="action-buttons">
        <button id="nextBatterBtn" style="display: none;">Select Next Batter</button>
        <button id="nextBowlerBtn" style="display: none;">Select Next Bowler</button>
      </div>
    </div>
    
    <div class="commentary" id="commentaryContainer"></div>
  </div>
  
  <!-- Modals -->
  <div class="modal" id="batterModal">
    <div class="modal-content">
      <button class="close-btn" id="closeBatterModal">&times;</button>
      <h3 class="modal-title">Select Next Batter</h3>
      <ul class="player-list" id="batterList"></ul>
    </div>
  </div>
  
  <div class="modal" id="bowlerModal">
    <div class="modal-content">
      <button class="close-btn" id="closeBowlerModal">&times;</button>
      <h3 class="modal-title">Select Next Bowler</h3>
      <ul class="player-list" id="bowlerList"></ul>
    </div>
  </div>
  
  <div class="modal" id="teamsModal">
    <div class="modal-content">
      <button class="close-btn" id="closeTeamsModal">&times;</button>
      <h3 class="modal-title">Teams</h3>
      <div class="team-modal">
        <div class="team-slider">
          <div class="team-slide">
            <h4 class="team-title" id="team1ModalTitle"></h4>
            <ul class="team-players" id="team1Players"></ul>
          </div>
          <div class="team-slide">
            <h4 class="team-title" id="team2ModalTitle"></h4>
            <ul class="team-players" id="team2Players"></ul>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Animation elements -->
  <div class="stumps" id="stumpsAnimation">
    <div class="stump stump-1"></div>
    <div class="stump stump-2">
      <div class="bail"></div>
    </div>
    <div class="stump stump-3"></div>
  </div>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getDatabase, ref, onValue, update, get, set } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCN6aZMwlsZe7JJaovU0WA3UQygWr4jYmA",
      authDomain: "handicricket-85a06.firebaseapp.com",
      projectId: "handicricket-85a06",
      storageBucket: "handicricket-85a06.appspot.com",
      messagingSenderId: "599182538558",
      appId: "1:599182538558:web:3e965753ab05f8f1e3de6f",
      measurementId: "G-HSV9H4LEJQ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Get URL parameters
    const params = new URLSearchParams(window.location.search);
    const roomId = params.get('room');
    const playerRole = params.get('player');
    const isSpectator = playerRole === 'spectator';
    
    if (!roomId || (!playerRole && !isSpectator)) {
      alert('Invalid room or player');
      window.location.href = 'index.html';
    }

    // Firebase references
    const roomRef = ref(db, `rooms/${roomId}`);
    const gameRef = ref(db, `rooms/${roomId}/game`);
    const playerRef = ref(db, `rooms/${roomId}/${playerRole}`);
    const opponentRef = ref(db, `rooms/${roomId}/${playerRole === 'player1' ? 'player2' : 'player1'}`);
    const tossRef = ref(db, `rooms/${roomId}/toss`);
    const teamsRef = ref(db, `rooms/${roomId}/teams`);

    // DOM elements
    const roomCodeEl = document.getElementById('roomCode');
    const formatDisplayEl = document.getElementById('formatDisplay');
    const inningsTitleEl = document.getElementById('inningsTitle');
    const matchStatusEl = document.getElementById('matchStatus');
    const battingTeamEl = document.getElementById('battingTeam');
    const bowlingTeamEl = document.getElementById('bowlingTeam');
    const batterInfoEl = document.getElementById('batterInfo');
    const bowlerInfoEl = document.getElementById('bowlerInfo');
    const scoreDisplayEl = document.getElementById('scoreDisplay');
    const oversDisplayEl = document.getElementById('oversDisplay');
    const runRateEl = document.getElementById('runRate');
    const targetDisplayEl = document.getElementById('targetDisplay');
    const ballsContainerEl = document.getElementById('ballsContainer');
    const overNumberEl = document.getElementById('overNumber');
    const statusIndicatorEl = document.getElementById('statusIndicator');
    const cardButtonsEl = document.getElementById('cardButtons');
    const resultDisplayEl = document.getElementById('resultDisplay');
    const nextBatterBtn = document.getElementById('nextBatterBtn');
    const nextBowlerBtn = document.getElementById('nextBowlerBtn');
    const commentaryContainerEl = document.getElementById('commentaryContainer');
    const teamsBtn = document.getElementById('teamsBtn');
    
    // Modal elements
    const batterModal = document.getElementById('batterModal');
    const bowlerModal = document.getElementById('bowlerModal');
    const teamsModal = document.getElementById('teamsModal');
    const batterListEl = document.getElementById('batterList');
    const bowlerListEl = document.getElementById('bowlerList');
    const team1ModalTitle = document.getElementById('team1ModalTitle');
    const team2ModalTitle = document.getElementById('team2ModalTitle');
    const team1PlayersEl = document.getElementById('team1Players');
    const team2PlayersEl = document.getElementById('team2Players');
    
    // Animation elements
    const stumpsAnimation = document.getElementById('stumpsAnimation');
    const containerEl = document.querySelector('.container');

    // Game state
    let gameState = {
      battingTeam: '',
      bowlingTeam: '',
      currentBatter: '',
      currentBowler: '',
      batters: [],
      bowlers: [],
      score: 0,
      wickets: 0,
      balls: 0,
      overs: 0,
      thisOver: [],
      innings: 1,
      format: '5',
      powerplay: false,
      deadOver: false,
      freeHit: false,
      batterDots: 0,
      bowlerDots: 0,
      target: 0,
      toss: {},
      teams: {},
      gameStarted: false,
      currentPlayer: null,
      selectedCard: null,
      isBatting: false,
      isBowling: false
    };

    // Initialize game
    function initGame() {
      roomCodeEl.textContent = roomId;
      
      // Set player online status
      if (!isSpectator) {
        set(playerRef, {
          connected: true,
          ready: false,
          card: null
        });
      }
      
      // Load room data
      onValue(roomRef, (snap) => {
        if (snap.exists()) {
          const room = snap.val();
          
          // Set format
          gameState.format = room.player1?.format || '5';
          formatDisplayEl.textContent = getFormatName(gameState.format);
          
          // Set teams
          gameState.battingTeam = room.toss?.battingFirst === 'player1' ? 
            room.player1?.team : room.player2?.team;
          gameState.bowlingTeam = room.toss?.battingFirst === 'player1' ? 
            room.player2?.team : room.player1?.team;
            
          battingTeamEl.textContent = gameState.battingTeam;
          bowlingTeamEl.textContent = gameState.bowlingTeam;
          
          // Set toss data
          gameState.toss = room.toss || {};
          
          // Set teams data
          if (room.teams) {
            gameState.teams = room.teams;
            updateTeamsModal();
          }
          
          // Check if game started
          gameState.gameStarted = room.gameStarted || false;
        }
      });
      
      // Load game data
      onValue(gameRef, (snap) => {
        if (snap.exists()) {
          const game = snap.val();
          
          // Update game state
          gameState.score = game.score || 0;
          gameState.wickets = game.wickets || 0;
          gameState.balls = game.balls || 0;
          gameState.overs = Math.floor(gameState.balls / 6);
          gameState.thisOver = game.thisOver || [];
          gameState.innings = game.innings || 1;
          gameState.currentBatter = game.currentBatter || '';
          gameState.currentBowler = game.currentBowler || '';
          gameState.batters = game.batters || [];
          gameState.bowlers = game.bowlers || [];
          gameState.powerplay = game.powerplay || false;
          gameState.deadOver = game.deadOver || false;
          gameState.freeHit = game.freeHit || false;
          gameState.batterDots = game.batterDots || 0;
          gameState.bowlerDots = game.bowlerDots || 0;
          gameState.target = game.target || 0;
          
          // Update UI
          updateScoreboard();
          updateOverProgress();
          updateStatusIndicator();
          updatePlayerInfo();
          updateCommentary(game.commentary || []);
          
          // Check if we need to select players
          if (!isSpectator) {
            checkPlayerSelection();
          }
        }
      });
      
      // Handle opponent disconnect
      if (!isSpectator) {
        onValue(opponentRef, (snap) => {
          if (!snap.exists() || !snap.val()?.connected) {
            alert('Opponent disconnected');
            window.location.href = 'index.html';
          }
        });
      }
      
      // Set up card buttons
      setupCardButtons();
      
      // Set up team modal button
      teamsBtn.addEventListener('click', () => {
        teamsModal.classList.add('active');
      });
      
      // Close modals
      document.getElementById('closeBatterModal').addEventListener('click', () => {
        batterModal.classList.remove('active');
      });
      
      document.getElementById('closeBowlerModal').addEventListener('click', () => {
        bowlerModal.classList.remove('active');
      });
      
      document.getElementById('closeTeamsModal').addEventListener('click', () => {
        teamsModal.classList.remove('active');
      });
      
      // Next batter/bowler buttons
      nextBatterBtn.addEventListener('click', () => {
        showBatterModal();
      });
      
      nextBowlerBtn.addEventListener('click', () => {
        showBowlerModal();
      });
    }
    
    // Get format name
    function getFormatName(format) {
      const formats = {
        '5': 'T5 (5 Overs)',
        '10': 'T10 (10 Overs)',
        '20': 'T20 (20 Overs)',
        '50': 'ODI (50 Overs)',
        'test': 'Test Match'
      };
      return formats[format] || format;
    }
    
    // Update scoreboard
    function updateScoreboard() {
      scoreDisplayEl.textContent = `${gameState.score}/${gameState.wickets}`;
      oversDisplayEl.textContent = `${gameState.overs}.${gameState.balls % 6}`;
      
      // Calculate run rate
      const overs = gameState.overs + (gameState.balls % 6) / 6;
      const runRate = overs > 0 ? (gameState.score / overs).toFixed(2) : '0.00';
      runRateEl.textContent = runRate;
      
      // Show target in second innings
      if (gameState.innings === 2) {
        targetDisplayEl.textContent = `Target: ${gameState.target}`;
      } else {
        targetDisplayEl.textContent = '';
      }
      
      // Update innings title
      inningsTitleEl.textContent = gameState.innings === 1 ? 'First Innings' : 'Second Innings';
    }
    
    // Update over progress
    function updateOverProgress() {
      ballsContainerEl.innerHTML = '';
      
      // Add balls for completed overs
      for (let i = 0; i < gameState.overs; i++) {
        for (let j = 0; j < 6; j++) {
          const ball = document.createElement('div');
          ball.className = 'ball';
          ball.textContent = '•';
          ballsContainerEl.appendChild(ball);
        }
      }
      
      // Add balls for current over
      for (let i = 0; i < gameState.thisOver.length; i++) {
        const ball = document.createElement('div');
        const ballEvent = gameState.thisOver[i];
        
        if (ballEvent.type === 'wicket') {
          ball.className = 'ball wicket';
          ball.textContent = 'W';
        } else if (ballEvent.type === 'wide' || ballEvent.type === 'noball') {
          ball.className = ballEvent.type === 'wide' ? 'ball wide' : 'ball noball';
          ball.textContent = ballEvent.type === 'wide' ? 'Wd' : 'Nb';
        } else {
          ball.className = ballEvent.runs === 0 ? 'ball dot' : 'ball run';
          ball.textContent = ballEvent.runs > 0 ? ballEvent.runs : '•';
        }
        
        ballsContainerEl.appendChild(ball);
      }
      
      // Update over number
      overNumberEl.textContent = `Over ${gameState.overs + 1}`;
    }
    
    // Update status indicator
    function updateStatusIndicator() {
      statusIndicatorEl.className = 'status';
      statusIndicatorEl.innerHTML = '';
      
      if (gameState.powerplay) {
        statusIndicatorEl.classList.add('powerplay');
        statusIndicatorEl.textContent = 'Powerplay';
      } else if (gameState.deadOver) {
        statusIndicatorEl.classList.add('dead-over');
        statusIndicatorEl.textContent = 'Dead Over';
      } else if (gameState.freeHit) {
        statusIndicatorEl.classList.add('free-hit');
        statusIndicatorEl.textContent = 'Free Hit';
      }
    }
    
    // Update player info
    function updatePlayerInfo() {
      if (gameState.currentBatter) {
        const batter = gameState.batters.find(b => b.name === gameState.currentBatter);
        if (batter) {
          batterInfoEl.innerHTML = `
            <div class="player-name">${batter.name}</div>
            <div class="player-stats">
              <span class="player-runs">${batter.runs}</span>
              <span class="player-balls">(${batter.balls})</span>
              <span class="player-sr">SR: ${batter.balls > 0 ? ((batter.runs / batter.balls) * 100).toFixed(2) : '0.00'}</span>
            </div>
            <div class="wicket-bar">
              <div class="wicket-progress" style="width: ${batter.wickets * 100}%"></div>
            </div>
            <div class="dots-counter ${batter.dots >= 3 ? 'danger' : batter.dots >= 2 ? 'warning' : ''}">
              Dots: ${batter.dots}/3
            </div>
          `;
        }
      }
      
      if (gameState.currentBowler) {
        const bowler = gameState.bowlers.find(b => b.name === gameState.currentBowler);
        if (bowler) {
          bowlerInfoEl.innerHTML = `
            <div class="player-name">${bowler.name}</div>
            <div class="player-stats">
              <span>${bowler.overs}.${bowler.balls % 6}</span>
              <span>${bowler.runs}/${bowler.wickets}</span>
              <span>ER: ${bowler.overs > 0 ? (bowler.runs / bowler.overs).toFixed(2) : '0.00'}</span>
            </div>
            <div class="dots-counter ${bowler.dots >= 3 ? 'danger' : bowler.dots >= 2 ? 'warning' : ''}">
              Dots: ${bowler.dots}/3
            </div>
          `;
        }
      }
    }
    
    // Update commentary
    function updateCommentary(commentary) {
      commentaryContainerEl.innerHTML = '';
      
      for (const item of commentary) {
        const div = document.createElement('div');
        div.className = `commentary-item ${item.type}`;
        div.innerHTML = `<strong>${item.over}.${item.ball}:</strong> ${item.text}`;
        commentaryContainerEl.appendChild(div);
      }
      
      // Scroll to bottom
      commentaryContainerEl.scrollTop = commentaryContainerEl.scrollHeight;
    }
    
    // Check if player selection is needed
    function checkPlayerSelection() {
      nextBatterBtn.style.display = 'none';
      nextBowlerBtn.style.display = 'none';
      
      if (!gameState.currentBatter && gameState.batters.length < 11) {
        // Need to select batter
        if ((playerRole === 'player1' && gameState.toss.battingFirst === 'player1') || 
            (playerRole === 'player2' && gameState.toss.battingFirst === 'player2')) {
          // We're batting, need to select batter
          showBatterModal();
        }
      } else if (!gameState.currentBowler && gameState.bowlers.length < 11) {
        // Need to select bowler
        if ((playerRole === 'player1' && gameState.toss.battingFirst !== 'player1') || 
            (playerRole === 'player2' && gameState.toss.battingFirst !== 'player2')) {
          // We're bowling, need to select bowler
          showBowlerModal();
        }
      }
    }
    
    // Show batter selection modal
    function showBatterModal() {
      batterListEl.innerHTML = '';
      
      // Get available batters
      const availableBatters = gameState.teams[gameState.toss.battingFirst]?.players || [];
      const currentBatters = gameState.batters.map(b => b.name);
      
      for (const player of availableBatters) {
        if (!currentBatters.includes(player)) {
          const li = document.createElement('li');
          li.className = 'player-item';
          li.textContent = player;
          li.addEventListener('click', () => selectBatter(player));
          batterListEl.appendChild(li);
        }
      }
      
      batterModal.classList.add('active');
    }
    
    // Select batter
    function selectBatter(batter) {
      batterModal.classList.remove('active');
      
      // Add to batters list
      const newBatter = {
        name: batter,
        runs: 0,
        balls: 0,
        dots: 0,
        wickets: 0
      };
      
      update(gameRef, {
        currentBatter: batter,
        batters: [...gameState.batters, newBatter]
      });
    }
    
    // Show bowler selection modal
    function showBowlerModal() {
      bowlerListEl.innerHTML = '';
      
      // Get available bowlers
      const bowlingTeam = gameState.toss.battingFirst === 'player1' ? 'player2' : 'player1';
      const availableBowlers = gameState.teams[bowlingTeam]?.players || [];
      const currentBowlers = gameState.bowlers.map(b => b.name);
      
      for (const player of availableBowlers) {
        if (!currentBowlers.includes(player)) {
          const li = document.createElement('li');
          li.className = 'player-item';
          li.textContent = player;
          li.addEventListener('click', () => selectBowler(player));
          bowlerListEl.appendChild(li);
        }
      }
      
      bowlerModal.classList.add('active');
    }
    
    // Select bowler
    function selectBowler(bowler) {
      bowlerModal.classList.remove('active');
      
      // Add to bowlers list
      const newBowler = {
        name: bowler,
        overs: 0,
        balls: 0,
        runs: 0,
        wickets: 0,
        dots: 0
      };
      
      update(gameRef, {
        currentBowler: bowler,
        bowlers: [...gameState.bowlers, newBowler]
      });
    }
    
    // Update teams modal
    function updateTeamsModal() {
      team1ModalTitle.textContent = gameState.teams.player1?.name || 'Team 1';
      team2ModalTitle.textContent = gameState.teams.player2?.name || 'Team 2';
      
      team1PlayersEl.innerHTML = '';
      team2PlayersEl.innerHTML = '';
      
      // Add player1 team
      if (gameState.teams.player1?.players) {
        for (const player of gameState.teams.player1.players) {
          const li = document.createElement('li');
          li.className = 'team-player';
          li.textContent = player;
          team1PlayersEl.appendChild(li);
        }
      }
      
      // Add player2 team
      if (gameState.teams.player2?.players) {
        for (const player of gameState.teams.player2.players) {
          const li = document.createElement('li');
          li.className = 'team-player';
          li.textContent = player;
          team2PlayersEl.appendChild(li);
        }
      }
    }
    
    // Setup card buttons
    function setupCardButtons() {
      if (isSpectator) {
        cardButtonsEl.style.display = 'none';
        return;
      }
      
      const cardButtons = cardButtonsEl.querySelectorAll('.card-btn');
      
      cardButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          // Deselect all buttons
          cardButtons.forEach(b => b.classList.remove('selected'));
          
          // Select this button
          btn.classList.add('selected');
          gameState.selectedCard = parseInt(btn.dataset.value);
          
          // Update player card in Firebase
          update(playerRef, {
            card: gameState.selectedCard,
            ready: true
          });
        });
      });
    }
    
    // Play wicket animation
    function playWicketAnimation() {
      containerEl.classList.add('shake');
      stumpsAnimation.classList.add('active');
      
      setTimeout(() => {
        containerEl.classList.remove('shake');
        stumpsAnimation.classList.remove('active');
      }, 1000);
      
      // Create confetti
      createConfetti();
    }
    
    // Create confetti
    function createConfetti() {
      for (let i = 0; i < 50; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = `${Math.random() * 100}%`;
        confetti.style.top = `${Math.random() * 100}%`;
        confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
        confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
        document.body.appendChild(confetti);
        
        // Animate
        setTimeout(() => {
          confetti.style.opacity = '1';
          confetti.style.transform = `translate(${Math.random() * 200 - 100}px, ${Math.random() * 200 + 100}px) rotate(${Math.random() * 360}deg)`;
          
          setTimeout(() => {
            confetti.style.opacity = '0';
            setTimeout(() => confetti.remove(), 1000);
          }, 1000);
        }, 0);
      }
    }
    
    // Initialize the game
    initGame();
  </script>
</body>
</html>