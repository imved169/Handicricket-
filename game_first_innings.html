<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HandiCricket - First Innings</title>
  <style>
    :root {
      --primary: #1e88e5;
      --secondary: #ffeb3b;
      --danger: #f44336;
      --success: #4CAF50;
      --warning: #FF9800;
      --dark: #061e3e;
      --light: #f8f9fa;
      --powerplay: rgba(255, 235, 59, 0.2);
      --dead-over: rgba(255, 152, 0, 0.2);
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #061e3e, #0a2a4a);
      color: white;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .container {
      display: flex;
      flex-direction: column;
      height: 100%;
      padding: 10px;
    }
    
    /* Header Section */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      margin-bottom: 10px;
    }
    
    .match-info {
      text-align: center;
    }
    
    .match-title {
      font-size: 1.2rem;
      color: var(--secondary);
      margin-bottom: 5px;
    }
    
    .teams {
      display: flex;
      gap: 10px;
      font-size: 0.9rem;
    }
    
    .vs {
      color: var(--secondary);
    }
    
    .score-display {
      font-size: 1.1rem;
      font-weight: bold;
    }
    
    .powerplay-indicator {
      background: var(--powerplay);
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      display: inline-block;
      margin-top: 5px;
    }
    
    .dead-over-indicator {
      background: var(--dead-over);
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      display: inline-block;
      margin-top: 5px;
    }
    
    /* Game Area */
    .game-area {
      display: flex;
      flex: 1;
      gap: 10px;
    }
    
    /* Cricket Ground Visualization */
    .cricket-ground {
      flex: 2;
      background-image: url('1000012316.jpg');
      background-size: cover;
      background-position: center;
      border-radius: 8px;
      position: relative;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .pitch {
      width: 80%;
      height: 20%;
      background: linear-gradient(to bottom, #8B4513, #A0522D);
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .crease {
      position: absolute;
      width: 100%;
      height: 2px;
      background: white;
    }
    
    .crease.top {
      top: 10%;
    }
    
    .crease.bottom {
      bottom: 10%;
    }
    
    .stumps {
      position: absolute;
      width: 20px;
      height: 60px;
      background: linear-gradient(to bottom, #8B4513, #A0522D);
      display: flex;
      justify-content: space-between;
      padding: 0 5px;
    }
    
    .stump {
      width: 2px;
      height: 100%;
      background: white;
    }
    
    .bails {
      position: absolute;
      width: 22px;
      height: 4px;
      background: white;
      top: -4px;
    }
    
    .batsman {
      position: absolute;
      width: 30px;
      height: 60px;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 50%;
      left: 30%;
      bottom: 15%;
      transition: all 0.3s;
    }
    
    .bowler {
      position: absolute;
      width: 30px;
      height: 60px;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 50%;
      right: 30%;
      top: 15%;
      transition: all 0.3s;
    }
    
    .ball {
      position: absolute;
      width: 10px;
      height: 10px;
      background: red;
      border-radius: 50%;
      transition: all 0.5s cubic-bezier(0.17, 0.67, 0.83, 0.67);
      z-index: 10;
    }
    
    /* Controls Panel */
    .controls-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      padding: 10px;
    }
    
    .innings-info {
      background: rgba(13, 42, 82, 0.5);
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    
    .current-players {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    
    .player-card {
      background: rgba(30, 136, 229, 0.2);
      padding: 8px;
      border-radius: 6px;
      width: 48%;
    }
    
    .player-name {
      font-weight: bold;
      margin-bottom: 5px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .player-stats {
      font-size: 0.8rem;
      color: #aaa;
    }
    
    .wicket-bar {
      height: 5px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 3px;
      margin-top: 5px;
      overflow: hidden;
    }
    
    .wicket-progress {
      height: 100%;
      background: var(--danger);
      width: 100%;
      transition: width 0.3s;
    }
    
    .over-progress {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    
    .ball-indicator {
      width: 15px;
      height: 15px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 0.6rem;
    }
    
    .ball-indicator.wicket {
      background: var(--danger);
    }
    
    .ball-indicator.run {
      background: var(--success);
    }
    
    .ball-indicator.dot {
      background: var(--warning);
    }
    
    .ball-indicator.noball {
      background: var(--primary);
    }
    
    .ball-indicator.freehit {
      background: var(--secondary);
      color: black;
    }
    
    .controls {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-bottom: 10px;
    }
    
    .control-btn {
      aspect-ratio: 1;
      border-radius: 8px;
      border: none;
      background: rgba(30, 136, 229, 0.5);
      color: white;
      font-size: 1.2rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .control-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }
    
    .control-btn:active {
      transform: translateY(0);
    }
    
    .control-btn.zero {
      background: var(--warning);
    }
    
    .control-btn.selected {
      box-shadow: 0 0 0 3px var(--secondary);
    }
    
    .action-btns {
      display: flex;
      gap: 8px;
      margin-top: auto;
    }
    
    .action-btn {
      flex: 1;
      padding: 10px;
      border-radius: 8px;
      border: none;
      background: var(--primary);
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .action-btn:hover {
      opacity: 0.9;
      transform: translateY(-2px);
    }
    
    .action-btn:disabled {
      background: #666;
      cursor: not-allowed;
      transform: none;
    }
    
    .action-btn.submit {
      background: var(--success);
    }
    
    .action-btn.reset {
      background: var(--danger);
    }
    
    /* Teams Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 100;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }
    
    .modal.active {
      opacity: 1;
      pointer-events: all;
    }
    
    .modal-content {
      background: linear-gradient(135deg, #0a2a4a, #061e3e);
      border-radius: 12px;
      padding: 20px;
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .modal-title {
      color: var(--secondary);
      font-size: 1.2rem;
    }
    
    .close-modal {
      background: none;
      border: none;
      color: white;
      font-size: 1.5rem;
      cursor: pointer;
    }
    
    .team-modal {
      margin-bottom: 15px;
    }
    
    .team-name {
      font-weight: bold;
      color: var(--secondary);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .team-name .badge {
      font-size: 0.7rem;
      padding: 2px 5px;
      border-radius: 10px;
      background: var(--secondary);
      color: black;
    }
    
    .players-list {
      list-style: none;
    }
    
    .player-item {
      padding: 8px 10px;
      margin-bottom: 5px;
      background: rgba(30, 136, 229, 0.2);
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
    }
    
    .player-item.captain {
      border-left: 3px solid gold;
    }
    
    .player-item.vice-captain {
      border-left: 3px solid silver;
    }
    
    .player-role {
      font-size: 0.8rem;
      color: #aaa;
    }
    
    /* Batter/Bowler Selection */
    .selection-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 15px;
    }
    
    .selection-list {
      max-height: 200px;
      overflow-y: auto;
      background: rgba(13, 42, 82, 0.5);
      border-radius: 8px;
      padding: 5px;
    }
    
    .selection-item {
      padding: 8px;
      margin-bottom: 5px;
      background: rgba(30, 136, 229, 0.2);
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .selection-item:hover {
      background: rgba(30, 136, 229, 0.4);
    }
    
    .selection-item.selected {
      background: var(--primary);
    }
    
    /* Innings Summary Modal */
    .summary-stats {
      margin: 15px 0;
    }
    
    .stat-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .stat-label {
      color: #aaa;
    }
    
    .stat-value {
      font-weight: bold;
    }
    
    .batter-stats, .bowler-stats {
      margin-top: 15px;
    }
    
    .stats-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 0.9rem;
    }
    
    .stats-table th {
      background: rgba(30, 136, 229, 0.5);
      padding: 8px;
      text-align: left;
    }
    
    .stats-table td {
      padding: 8px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .stats-table tr:nth-child(even) {
      background: rgba(30, 136, 229, 0.1);
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .game-area {
        flex-direction: column;
      }
      
      .cricket-ground {
        min-height: 200px;
      }
      
      .controls-panel {
        min-height: 300px;
      }
      
      .selection-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <div class="container">
    <!-- Header Section -->
    <div class="header">
      <div class="match-info">
        <div class="match-title" id="matchTitle">Match Title</div>
        <div class="teams">
          <span id="team1Name">Team A</span>
          <span class="vs">vs</span>
          <span id="team2Name">Team B</span>
        </div>
        <div id="powerplayIndicator" class="powerplay-indicator" style="display: none;">Powerplay</div>
        <div id="deadOverIndicator" class="dead-over-indicator" style="display: none;">Dead Over</div>
      </div>
      <div class="score-display" id="scoreDisplay">0/0 (0.0)</div>
    </div>
    
    <!-- Game Area -->
    <div class="game-area">
      <!-- Cricket Ground Visualization -->
      <div class="cricket-ground">
        <div class="pitch">
          <div class="crease top"></div>
          <div class="stumps">
            <div class="stump"></div>
            <div class="stump"></div>
            <div class="stump"></div>
            <div class="bails"></div>
          </div>
          <div class="crease bottom"></div>
          <div class="batsman"></div>
          <div class="bowler"></div>
          <div class="ball" id="ball" style="display: none;"></div>
        </div>
      </div>
      
      <!-- Controls Panel -->
      <div class="controls-panel">
        <div class="innings-info">
          <div class="current-players">
            <div class="player-card">
              <div class="player-name" id="batterName">Batter</div>
              <div class="player-stats" id="batterStats">Runs: 0 | Balls: 0 | SR: 0</div>
              <div class="wicket-bar">
                <div class="wicket-progress" id="batterWickets" style="width: 100%;"></div>
              </div>
            </div>
            <div class="player-card">
              <div class="player-name" id="bowlerName">Bowler</div>
              <div class="player-stats" id="bowlerStats">Overs: 0 | Wkts: 0 | ER: 0</div>
              <div class="wicket-bar">
                <div class="wicket-progress" id="bowlerWickets" style="width: 0%;"></div>
              </div>
            </div>
          </div>
          
          <div class="over-progress" id="overProgress">
            <!-- Ball indicators will be added dynamically -->
          </div>
        </div>
        
        <div class="controls" id="controls">
          <!-- Control buttons will be added dynamically -->
        </div>
        
        <div class="action-btns">
          <button class="action-btn" id="teamsBtn">Teams</button>
          <button class="action-btn" id="submitBtn" disabled>Submit</button>
          <button class="action-btn reset" id="resetBtn">Reset</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Teams Modal -->
  <div class="modal" id="teamsModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Teams</h3>
        <button class="close-modal" id="closeTeamsModal">&times;</button>
      </div>
      <div class="team-modal">
        <h4 class="team-name" id="modalTeam1Name">Team A <span class="badge" id="team1BattingBadge" style="display: none;">Batting</span></h4>
        <ul class="players-list" id="team1Players">
          <!-- Players will be added dynamically -->
        </ul>
      </div>
      <div class="team-modal">
        <h4 class="team-name" id="modalTeam2Name">Team B <span class="badge" id="team2BattingBadge" style="display: none;">Bowling</span></h4>
        <ul class="players-list" id="team2Players">
          <!-- Players will be added dynamically -->
        </ul>
      </div>
    </div>
  </div>
  
  <!-- Batter Selection Modal -->
  <div class="modal" id="batterModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Select Batter</h3>
        <button class="close-modal" id="closeBatterModal">&times;</button>
      </div>
      <div class="selection-grid">
        <div>
          <h4>Available Batters</h4>
          <div class="selection-list" id="availableBatters">
            <!-- Batters will be added dynamically -->
          </div>
        </div>
        <div>
          <h4>Dismissed Batters</h4>
          <div class="selection-list" id="dismissedBatters">
            <!-- Dismissed batters will be added dynamically -->
          </div>
        </div>
      </div>
      <button class="action-btn submit" id="selectBatterBtn" disabled>Select Batter</button>
    </div>
  </div>
  
  <!-- Bowler Selection Modal -->
  <div class="modal" id="bowlerModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Select Bowler</h3>
        <button class="close-modal" id="closeBowlerModal">&times;</button>
      </div>
      <div class="selection-list" id="availableBowlers">
        <!-- Bowlers will be added dynamically -->
      </div>
      <button class="action-btn submit" id="selectBowlerBtn" disabled>Select Bowler</button>
    </div>
  </div>
  
  <!-- Innings Summary Modal -->
  <div class="modal" id="summaryModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="summaryTitle">Innings Summary</h3>
        <button class="close-modal" id="closeSummaryModal">&times;</button>
      </div>
      
      <div class="summary-stats">
        <div class="stat-row">
          <span class="stat-label">Total Runs:</span>
          <span class="stat-value" id="summaryRuns">0</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Wickets:</span>
          <span class="stat-value" id="summaryWickets">0</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Overs:</span>
          <span class="stat-value" id="summaryOvers">0.0</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Run Rate:</span>
          <span class="stat-value" id="summaryRunRate">0.00</span>
        </div>
        <div class="stat-row" id="targetRow" style="display: none;">
          <span class="stat-label">Target:</span>
          <span class="stat-value" id="summaryTarget">0</span>
        </div>
      </div>
      
      <div class="batter-stats">
        <h4>Batting Performances</h4>
        <table class="stats-table" id="batterStatsTable">
          <thead>
            <tr>
              <th>Batter</th>
              <th>Runs</th>
              <th>Balls</th>
              <th>SR</th>
            </tr>
          </thead>
          <tbody>
            <!-- Batter stats will be added dynamically -->
          </tbody>
        </table>
      </div>
      
      <div class="bowler-stats">
        <h4>Bowling Performances</h4>
        <table class="stats-table" id="bowlerStatsTable">
          <thead>
            <tr>
              <th>Bowler</th>
              <th>Overs</th>
              <th>Wkts</th>
              <th>ER</th>
            </tr>
          </thead>
          <tbody>
            <!-- Bowler stats will be added dynamically -->
          </tbody>
        </table>
      </div>
      
      <button class="action-btn submit" id="continueBtn">Continue</button>
    </div>
  </div>
  
  <!-- Match Result Modal -->
  <div class="modal" id="resultModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="resultTitle">Match Result</h3>
        <button class="close-modal" id="closeResultModal">&times;</button>
      </div>
      
      <div class="summary-stats">
        <div class="stat-row">
          <span class="stat-label">Winner:</span>
          <span class="stat-value" id="winnerName">Team A</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Winning Margin:</span>
          <span class="stat-value" id="winningMargin">by 10 runs</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Player of the Match:</span>
          <span class="stat-value" id="playerOfMatch">Player Name</span>
        </div>
      </div>
      
      <div class="batter-stats">
        <h4>Match Summary</h4>
        <div id="firstInningsSummary" style="margin-bottom: 15px;">
          <h5>First Innings</h5>
          <div class="stat-row">
            <span class="stat-label">Runs:</span>
            <span class="stat-value" id="firstInningsRuns">0</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Wickets:</span>
            <span class="stat-value" id="firstInningsWickets">0</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Overs:</span>
            <span class="stat-value" id="firstInningsOvers">0.0</span>
          </div>
        </div>
        
        <div id="secondInningsSummary">
          <h5>Second Innings</h5>
          <div class="stat-row">
            <span class="stat-label">Runs:</span>
            <span class="stat-value" id="secondInningsRuns">0</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Wickets:</span>
            <span class="stat-value" id="secondInningsWickets">0</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Overs:</span>
            <span class="stat-value" id="secondInningsOvers">0.0</span>
          </div>
        </div>
      </div>
      
      <button class="action-btn submit" id="saveMatchBtn">Save Match Data</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, get } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCN6aZMwlsZe7JJaovU0WA3UQygWr4jYmA",
      authDomain: "handicricket-85a06.firebaseapp.com",
      projectId: "handicricket-85a06",
      storageBucket: "handicricket-85a06.appspot.com",
      messagingSenderId: "599182538558",
      appId: "1:599182538558:web:3e965753ab05f8f1e3de6f",
      measurementId: "G-HSV9H4LEJQ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Get URL parameters
    const params = new URLSearchParams(window.location.search);
    const roomId = params.get('room');
    const playerRole = params.get('player');
    const isSpectator = playerRole === 'spectator';
    const opponentRole = playerRole === 'player1' ? 'player2' : 'player1';

    if (!roomId || (!isSpectator && !playerRole)) {
      alert('Invalid room or player');
      window.location.href = 'index.html';
    }

    // Firebase references
    const roomRef = ref(db, `rooms/${roomId}`);
    const gameRef = ref(db, `rooms/${roomId}/game`);
    const firstInningsRef = ref(db, `rooms/${roomId}/game/firstInnings`);
    const secondInningsRef = ref(db, `rooms/${roomId}/game/secondInnings`);
    const tossRef = ref(db, `rooms/${roomId}/toss`);
    const teamsRef = ref(db, `rooms/${roomId}/teams`);

    // DOM elements
    const matchTitle = document.getElementById('matchTitle');
    const team1Name = document.getElementById('team1Name');
    const team2Name = document.getElementById('team2Name');
    const scoreDisplay = document.getElementById('scoreDisplay');
    const powerplayIndicator = document.getElementById('powerplayIndicator');
    const deadOverIndicator = document.getElementById('deadOverIndicator');
    const batterName = document.getElementById('batterName');
    const batterStats = document.getElementById('batterStats');
    const batterWickets = document.getElementById('batterWickets');
    const bowlerName = document.getElementById('bowlerName');
    const bowlerStats = document.getElementById('bowlerStats');
    const bowlerWickets = document.getElementById('bowlerWickets');
    const overProgress = document.getElementById('overProgress');
    const controls = document.getElementById('controls');
    const submitBtn = document.getElementById('submitBtn');
    const resetBtn = document.getElementById('resetBtn');
    const teamsBtn = document.getElementById('teamsBtn');

    // Modal elements
    const teamsModal = document.getElementById('teamsModal');
    const closeTeamsModal = document.getElementById('closeTeamsModal');
    const modalTeam1Name = document.getElementById('modalTeam1Name');
    const modalTeam2Name = document.getElementById('modalTeam2Name');
    const team1Players = document.getElementById('team1Players');
    const team2Players = document.getElementById('team2Players');
    const team1BattingBadge = document.getElementById('team1BattingBadge');
    const team2BattingBadge = document.getElementById('team2BattingBadge');

    const batterModal = document.getElementById('batterModal');
    const closeBatterModal = document.getElementById('closeBatterModal');
    const availableBatters = document.getElementById('availableBatters');
    const dismissedBatters = document.getElementById('dismissedBatters');
    const selectBatterBtn = document.getElementById('selectBatterBtn');

    const bowlerModal = document.getElementById('bowlerModal');
    const closeBowlerModal = document.getElementById('closeBowlerModal');
    const availableBowlers = document.getElementById('availableBowlers');
    const selectBowlerBtn = document.getElementById('selectBowlerBtn');

    const summaryModal = document.getElementById('summaryModal');
    const closeSummaryModal = document.getElementById('closeSummaryModal');
    const summaryTitle = document.getElementById('summaryTitle');
    const summaryRuns = document.getElementById('summaryRuns');
    const summaryWickets = document.getElementById('summaryWickets');
    const summaryOvers = document.getElementById('summaryOvers');
    const summaryRunRate = document.getElementById('summaryRunRate');
    const targetRow = document.getElementById('targetRow');
    const summaryTarget = document.getElementById('summaryTarget');
    const batterStatsTable = document.getElementById('batterStatsTable').querySelector('tbody');
    const bowlerStatsTable = document.getElementById('bowlerStatsTable').querySelector('tbody');
    const continueBtn = document.getElementById('continueBtn');

    const resultModal = document.getElementById('resultModal');
    const closeResultModal = document.getElementById('closeResultModal');
    const resultTitle = document.getElementById('resultTitle');
    const winnerName = document.getElementById('winnerName');
    const winningMargin = document.getElementById('winningMargin');
    const playerOfMatch = document.getElementById('playerOfMatch');
    const firstInningsRuns = document.getElementById('firstInningsRuns');
    const firstInningsWickets = document.getElementById('firstInningsWickets');
    const firstInningsOvers = document.getElementById('firstInningsOvers');
    const secondInningsRuns = document.getElementById('secondInningsRuns');
    const secondInningsWickets = document.getElementById('secondInningsWickets');
    const secondInningsOvers = document.getElementById('secondInningsOvers');
    const saveMatchBtn = document.getElementById('saveMatchBtn');

    // Game state
    let gameState = {
      currentInnings: 'firstInnings',
      battingTeam: '',
      bowlingTeam: '',
      currentBatter: null,
      currentBowler: null,
      selectedCard: null,
      batterCard: null,
      bowlerCard: null,
      ballsBowled: 0,
      oversBowled: 0,
      totalRuns: 0,
      totalWickets: 0,
      batterStats: {},
      bowlerStats: {},
      currentOver: [],
      isPowerplay: false,
      isDeadOver: false,
      freeHit: false,
      batterDots: 0,
      bowlerDots: 0,
      format: '20', // Default to T20
      maxOvers: 20,
      bowlerOverLimit: 4,
      powerplayOvers: [1, 6], // Start and end over of powerplay
      deadOvers: [], // Array of dead overs (for ODI)
      selectedDeadOvers: [], // Bowler-selected dead overs
      followOnTarget: 0, // For Test matches
      inningsCompleted: false,
      matchCompleted: false,
      winner: null,
      winningMargin: null,
      playerOfTheMatch: null
    };

    // Initialize the game
    async function initGame() {
      // Load room data
      const roomSnap = await get(roomRef);
      if (!roomSnap.exists()) {
        alert('Room not found');
        window.location.href = 'index.html';
        return;
      }

      const roomData = roomSnap.val();
      
      // Set team names
      team1Name.textContent = roomData.player1?.team || 'Team A';
      team2Name.textContent = roomData.player2?.team || 'Team B';
      modalTeam1Name.textContent = roomData.player1?.team || 'Team A';
      modalTeam2Name.textContent = roomData.player2?.team || 'Team B';
      
      // Set match title
      matchTitle.textContent = `${roomData.player1?.team || 'Team A'} vs ${roomData.player2?.team || 'Team B'}`;
      
      // Set format
      gameState.format = roomData.player1?.format || '20';
      setFormatRules();
      
      // Load toss data to determine batting/bowling teams
      const tossSnap = await get(tossRef);
      if (tossSnap.exists()) {
        const tossData = tossSnap.val();
        gameState.battingTeam = tossData.battingFirst === 'player1' ? 'player1' : 'player2';
        gameState.bowlingTeam = tossData.battingFirst === 'player1' ? 'player2' : 'player1';
        
        // Update UI to show batting/bowling teams
        if (gameState.battingTeam === 'player1') {
          team1BattingBadge.style.display = 'inline-block';
          team2BattingBadge.textContent = 'Bowling';
          team2BattingBadge.style.display = 'inline-block';
        } else {
          team2BattingBadge.style.display = 'inline-block';
          team1BattingBadge.textContent = 'Bowling';
          team1BattingBadge.style.display = 'inline-block';
        }
      }
      
      // Load teams data
      const teamsSnap = await get(teamsRef);
      if (teamsSnap.exists()) {
        const teamsData = teamsSnap.val();
        
        // Populate teams modal
        populateTeamsModal(teamsData);
        
        // Initialize batter and bowler stats
        if (teamsData.player1) {
          teamsData.player1.players.forEach(player => {
            gameState.batterStats[player] = {
              runs: 0,
              balls: 0,
              dots: 0,
              fours: 0,
              sixes: 0,
              wickets: 0,
              isOut: false,
              isBatting: false
            };
          });
        }
        
        if (teamsData.player2) {
          teamsData.player2.players.forEach(player => {
            gameState.bowlerStats[player] = {
              overs: 0,
              balls: 0,
              maidens: 0,
              runs: 0,
              wickets: 0,
              dots: 0,
              isBowling: false,
              deadOvers: 0
            };
          });
        }
      }
      
      // Load game data if it exists
      const gameSnap = await get(gameRef);
      if (gameSnap.exists()) {
        const gameData = gameSnap.val();
        
        // Update game state
        if (gameData.currentInnings) gameState.currentInnings = gameData.currentInnings;
        if (gameData.battingTeam) gameState.battingTeam = gameData.battingTeam;
        if (gameState.bowlingTeam) gameState.bowlingTeam = gameState.bowlingTeam;
        
        // Load innings data
        if (gameState.currentInnings === 'firstInnings' && gameData.firstInnings) {
          loadInningsData(gameData.firstInnings, 'firstInnings');
        } else if (gameState.currentInnings === 'secondInnings' && gameData.secondInnings) {
          loadInningsData(gameData.secondInnings, 'secondInnings');
        }
        
        // Check if match is completed
        if (gameData.matchCompleted) {
          gameState.matchCompleted = true;
          showMatchResult();
          return;
        }
      }
      
      // Initialize UI
      updateScoreDisplay();
      createControlButtons();
      
      // Set up real-time listeners
      setupGameListeners();
      
      // Show batter selection modal if needed
      if (!gameState.currentBatter && !isSpectator) {
        showBatterSelection();
      }
      
      // Show bowler selection modal if needed
      if (!gameState.currentBowler && !isSpectator) {
        showBowlerSelection();
      }
      
      // Check powerplay status
      checkPowerplay();
    }

    // Set format-specific rules
    function setFormatRules() {
      switch (gameState.format) {
        case '5':
          gameState.maxOvers = 5;
          gameState.bowlerOverLimit = 1;
          gameState.powerplayOvers = [1, 2];
          break;
        case '10':
          gameState.maxOvers = 10;
          gameState.bowlerOverLimit = 2;
          gameState.powerplayOvers = [1, 3];
          break;
        case '20':
          gameState.maxOvers = 20;
          gameState.bowlerOverLimit = 4;
          gameState.powerplayOvers = [1, 6];
          break;
        case '50':
          gameState.maxOvers = 50;
          gameState.bowlerOverLimit = 10;
          gameState.powerplayOvers = [1, 10];
          // For ODI, dead overs are selected by bowling team
          break;
        case 'test':
          gameState.maxOvers = 0; // Unlimited for test
          gameState.bowlerOverLimit = 0; // Unlimited for test
          gameState.powerplayOvers = [0, 0]; // No powerplay in test
          break;
        default:
          gameState.maxOvers = 20;
          gameState.bowlerOverLimit = 4;
          gameState.powerplayOvers = [1, 6];
      }
    }

    // Load innings data from Firebase
    function loadInningsData(inningsData, inningsType) {
      gameState.currentInnings = inningsType;
      gameState.currentBatter = inningsData.currentBatter || null;
      gameState.currentBowler = inningsData.currentBowler || null;
      gameState.ballsBowled = inningsData.ballsBowled || 0;
      gameState.oversBowled = inningsData.oversBowled || 0;
      gameState.totalRuns = inningsData.totalRuns || 0;
      gameState.totalWickets = inningsData.totalWickets || 0;
      gameState.batterStats = inningsData.batterStats || {};
      gameState.bowlerStats = inningsData.bowlerStats || {};
      gameState.currentOver = inningsData.currentOver || [];
      gameState.isPowerplay = inningsData.isPowerplay || false;
      gameState.isDeadOver = inningsData.isDeadOver || false;
      gameState.freeHit = inningsData.freeHit || false;
      gameState.batterDots = inningsData.batterDots || 0;
      gameState.bowlerDots = inningsData.bowlerDots || 0;
      gameState.selectedDeadOvers = inningsData.selectedDeadOvers || [];
      gameState.followOnTarget = inningsData.followOnTarget || 0;
      gameState.inningsCompleted = inningsData.inningsCompleted || false;
      
      // Update UI
      updateScoreDisplay();
      updateOverProgress();
      updatePlayerStats();
      
      // Check if innings is completed
      if (gameState.inningsCompleted && inningsType === 'firstInnings') {
        showInningsSummary();
      }
    }

    // Set up real-time game listeners
    function setupGameListeners() {
      // Listen for game state changes
      onValue(gameRef, (snap) => {
        if (snap.exists()) {
          const gameData = snap.val();
          
          // Update current innings
          if (gameData.currentInnings && gameData.currentInnings !== gameState.currentInnings) {
            gameState.currentInnings = gameData.currentInnings;
            if (gameState.currentInnings === 'secondInnings' && gameData.firstInnings) {
              loadInningsData(gameData.firstInnings, 'firstInnings');
            }
          }
          
          // Update current innings data
          if (gameState.currentInnings === 'firstInnings' && gameData.firstInnings) {
            updateInningsState(gameData.firstInnings, 'firstInnings');
          } else if (gameState.currentInnings === 'secondInnings' && gameData.secondInnings) {
            updateInningsState(gameData.secondInnings, 'secondInnings');
          }
          
          // Check if match is completed
          if (gameData.matchCompleted) {
            gameState.matchCompleted = true;
            showMatchResult();
          }
        }
      });
      
      // Listen for batter selection
      onValue(ref(db, `rooms/${roomId}/game/${gameState.currentInnings}/currentBatter`), (snap) => {
        if (snap.exists() && snap.val() !== gameState.currentBatter) {
          gameState.currentBatter = snap.val();
          updatePlayerStats();
        }
      });
      
      // Listen for bowler selection
      onValue(ref(db, `rooms/${roomId}/game/${gameState.currentInnings}/currentBowler`), (snap) => {
        if (snap.exists() && snap.val() !== gameState.currentBowler) {
          gameState.currentBowler = snap.val();
          updatePlayerStats();
        }
      });
    }

    // Update innings state from Firebase data
    function updateInningsState(inningsData, inningsType) {
      gameState.currentBatter = inningsData.currentBatter || gameState.currentBatter;
      gameState.currentBowler = inningsData.currentBowler || gameState.currentBowler;
      gameState.ballsBowled = inningsData.ballsBowled || gameState.ballsBowled;
      gameState.oversBowled = inningsData.oversBowled || gameState.oversBowled;
      gameState.totalRuns = inningsData.totalRuns || gameState.totalRuns;
      gameState.totalWickets = inningsData.totalWickets || gameState.totalWickets;
      gameState.currentOver = inningsData.currentOver || gameState.currentOver;
      gameState.isPowerplay = inningsData.isPowerplay || gameState.isPowerplay;
      gameState.isDeadOver = inningsData.isDeadOver || gameState.isDeadOver;
      gameState.freeHit = inningsData.freeHit || gameState.freeHit;
      gameState.batterDots = inningsData.batterDots || gameState.batterDots;
      gameState.bowlerDots = inningsData.bowlerDots || gameState.bowlerDots;
      gameState.inningsCompleted = inningsData.inningsCompleted || gameState.inningsCompleted;
      
      // Update UI
      updateScoreDisplay();
      updateOverProgress();
      updatePlayerStats();
      checkPowerplay();
      
      // Check if innings is completed
      if (gameState.inningsCompleted && inningsType === 'firstInnings' && !isSpectator) {
        showInningsSummary();
      }
    }

    // Populate teams modal with player lists
    function populateTeamsModal(teamsData) {
      team1Players.innerHTML = '';
      team2Players.innerHTML = '';
      
      if (teamsData.player1) {
        teamsData.player1.players.forEach(player => {
          const li = document.createElement('li');
          li.className = 'player-item';
          if (player === teamsData.player1.captain) li.classList.add('captain');
          if (player === teamsData.player1.viceCaptain) li.classList.add('vice-captain');
          
          li.innerHTML = `
            ${player}
            <span class="player-role">
              ${player === teamsData.player1.captain ? 'Captain' : 
                player === teamsData.player1.viceCaptain ? 'Vice Captain' : ''}
            </span>
          `;
          team1Players.appendChild(li);
        });
      }
      
      if (teamsData.player2) {
        teamsData.player2.players.forEach(player => {
          const li = document.createElement('li');
          li.className = 'player-item';
          if (player === teamsData.player2.captain) li.classList.add('captain');
          if (player === teamsData.player2.viceCaptain) li.classList.add('vice-captain');
          
          li.innerHTML = `
            ${player}
            <span class="player-role">
              ${player === teamsData.player2.captain ? 'Captain' : 
                player === teamsData.player2.viceCaptain ? 'Vice Captain' : ''}
            </span>
          `;
          team2Players.appendChild(li);
        });
      }
    }

    // Update score display
    function updateScoreDisplay() {
      const battingTeamName = gameState.battingTeam === 'player1' ? 
        team1Name.textContent : team2Name.textContent;
      
      scoreDisplay.textContent = `${gameState.totalRuns}/${gameState.totalWickets} (${formatOvers(gameState.ballsBowled)})`;
      
      // Update batter and bowler stats
      if (gameState.currentBatter) {
        const batter = gameState.batterStats[gameState.currentBatter];
        batterName.textContent = gameState.currentBatter;
        batterStats.textContent = `Runs: ${batter.runs} | Balls: ${batter.balls} | SR: ${calculateStrikeRate(batter.runs, batter.balls)}`;
        batterWickets.style.width = `${(1 - batter.wickets) * 100}%`;
      }
      
      if (gameState.currentBowler) {
        const bowler = gameState.bowlerStats[gameState.currentBowler];
        bowlerName.textContent = gameState.currentBowler;
        bowlerStats.textContent = `Overs: ${formatOvers(bowler.balls)} | Wkts: ${bowler.wickets} | ER: ${calculateEconomyRate(bowler.runs, bowler.balls)}`;
        bowlerWickets.style.width = `${(bowler.wickets / gameState.totalWickets || 0) * 100}%`;
      }
    }

    // Format overs (balls to overs.balls)
    function formatOvers(balls) {
      return `${Math.floor(balls / 6)}.${balls % 6}`;
    }

    // Calculate strike rate
    function calculateStrikeRate(runs, balls) {
      return balls > 0 ? ((runs / balls) * 100).toFixed(2) : '0.00';
    }

    // Calculate economy rate
    function calculateEconomyRate(runs, balls) {
      const overs = balls / 6;
      return overs > 0 ? (runs / overs).toFixed(2) : '0.00';
    }

    // Update over progress display
    function updateOverProgress() {
      overProgress.innerHTML = '';
      
      for (let i = 0; i < 6; i++) {
        const ball = document.createElement('div');
        ball.className = 'ball-indicator';
        
        if (i < gameState.currentOver.length) {
          const ballData = gameState.currentOver[i];
          ball.textContent = ballData.runs;
          
          if (ballData.isWicket) {
            ball.classList.add('wicket');
          } else if (ballData.runs > 0) {
            ball.classList.add('run');
          } else if (ballData.isNoBall) {
            ball.classList.add('noball');
          } else if (ballData.isFreeHit) {
            ball.classList.add('freehit');
          } else {
            ball.classList.add('dot');
          }
        }
        
        overProgress.appendChild(ball);
      }
    }

    // Create control buttons (0-6)
    function createControlButtons() {
      controls.innerHTML = '';
      
      for (let i = 0; i <= 6; i++) {
        const btn = document.createElement('button');
        btn.className = `control-btn ${i === 0 ? 'zero' : ''}`;
        btn.textContent = i;
        btn.dataset.value = i;
        
        btn.addEventListener('click', () => {
          if (isSpectator) return;
          
          // Deselect previous button
          document.querySelectorAll('.control-btn').forEach(b => b.classList.remove('selected'));
          
          // Select this button
          btn.classList.add('selected');
          gameState.selectedCard = i;
          submitBtn.disabled = false;
        });
        
        controls.appendChild(btn);
      }
    }

    // Check if current over is in powerplay
    function checkPowerplay() {
      if (gameState.format === 'test') {
        gameState.isPowerplay = false;
        powerplayIndicator.style.display = 'none';
        return;
      }
      
      const currentOver = Math.floor(gameState.ballsBowled / 6) + 1;
      gameState.isPowerplay = currentOver >= gameState.powerplayOvers[0] && 
                              currentOver <= gameState.powerplayOvers[1];
      
      if (gameState.isPowerplay) {
        powerplayIndicator.style.display = 'inline-block';
      } else {
        powerplayIndicator.style.display = 'none';
      }
      
      // Check for dead over (ODI only)
      if (gameState.format === '50') {
        gameState.isDeadOver = gameState.selectedDeadOvers.includes(currentOver);
        deadOverIndicator.style.display = gameState.isDeadOver ? 'inline-block' : 'none';
      } else {
        gameState.isDeadOver = false;
        deadOverIndicator.style.display = 'none';
      }
    }

    // Show batter selection modal
    function showBatterSelection() {
      availableBatters.innerHTML = '';
      dismissedBatters.innerHTML = '';
      
      // Get batting team players
      get(teamsRef).then((snap) => {
        if (snap.exists()) {
          const teamsData = snap.val();
          const battingTeam = gameState.battingTeam === 'player1' ? teamsData.player1 : teamsData.player2;
          
          battingTeam.players.forEach(player => {
            const batter = gameState.batterStats[player];
            
            if (!batter.isOut) {
              const item = document.createElement('div');
              item.className = 'selection-item';
              item.textContent = player;
              item.dataset.player = player;
              
              item.addEventListener('click', () => {
                document.querySelectorAll('#availableBatters .selection-item').forEach(i => i.classList.remove('selected'));
                item.classList.add('selected');
                gameState.batterCard = null;
                selectBatterBtn.disabled = false;
              });
              
              availableBatters.appendChild(item);
            } else {
              const item = document.createElement('div');
              item.className = 'selection-item';
              item.textContent = `${player} - ${batter.runs} (${batter.balls})`;
              dismissedBatters.appendChild(item);
            }
          });
          
          batterModal.classList.add('active');
        }
      });
    }

    // Show bowler selection modal
    function showBowlerSelection() {
      availableBowlers.innerHTML = '';
      
      // Get bowling team players
      get(teamsRef).then((snap) => {
        if (snap.exists()) {
          const teamsData = snap.val();
          const bowlingTeam = gameState.bowlingTeam === 'player1' ? teamsData.player1 : teamsData.player2;
          
          bowlingTeam.players.forEach(player => {
            const bowler = gameState.bowlerStats[player];
            const oversBowled = Math.floor(bowler.balls / 6);
            const ballsBowled = bowler.balls % 6;
            const oversLeft = gameState.bowlerOverLimit - oversBowled - (ballsBowled > 0 ? 1 : 0);
            
            // Only show bowlers who haven't reached their over limit (except in test)
            if (gameState.format === 'test' || oversLeft > 0) {
              const item = document.createElement('div');
              item.className = 'selection-item';
              item.textContent = `${player} (${formatOvers(bowler.balls)} - ${bowler.wickets}/${bowler.runs})`;
              item.dataset.player = player;
              
              item.addEventListener('click', () => {
                document.querySelectorAll('#availableBowlers .selection-item').forEach(i => i.classList.remove('selected'));
                item.classList.add('selected');
                gameState.bowlerCard = null;
                selectBowlerBtn.disabled = false;
              });
              
              availableBowlers.appendChild(item);
            }
          });
          
          bowlerModal.classList.add('active');
        }
      });
    }

    // Submit selected batter
    selectBatterBtn.addEventListener('click', () => {
      const selected = document.querySelector('#availableBatters .selection-item.selected');
      if (selected) {
        gameState.currentBatter = selected.dataset.player;
        gameState.batterStats[gameState.currentBatter].isBatting = true;
        
        // Update in Firebase
        update(ref(db, `rooms/${roomId}/game/${gameState.currentInnings}`), {
          currentBatter: gameState.currentBatter,
          [`batterStats/${gameState.currentBatter}/isBatting`]: true
        });
        
        batterModal.classList.remove('active');
        updatePlayerStats();
      }
    });

    // Submit selected bowler
    selectBowlerBtn.addEventListener('click', () => {
      const selected = document.querySelector('#availableBowlers .selection-item.selected');
      if (selected) {
        gameState.currentBowler = selected.dataset.player;
        gameState.bowlerStats[gameState.currentBowler].isBowling = true;
        
        // Update in Firebase
        update(ref(db, `rooms/${roomId}/game/${gameState.currentInnings}`), {
          currentBowler: gameState.currentBowler,
          [`bowlerStats/${gameState.currentBowler}/isBowling`]: true
        });
        
        bowlerModal.classList.remove('active');
        updatePlayerStats();
      }
    });

    // Submit ball outcome
    submitBtn.addEventListener('click', () => {
      if (isSpectator || !gameState.selectedCard !== null || !gameState.currentBatter || !gameState.currentBowler) return;
      
      const batterCard = gameState.selectedCard;
      const bowlerCard = gameState.selectedCard; // In multiplayer, this would come from opponent
      
      // Process ball outcome
      processBallOutcome(batterCard, bowlerCard);
      
      // Reset selection
      gameState.selectedCard = null;
      document.querySelectorAll('.control-btn').forEach(b => b.classList.remove('selected'));
      submitBtn.disabled = true;
    });

    // Process ball outcome based on rules
    function processBallOutcome(batterCard, bowlerCard) {
      let runs = 0;
      let isWicket = false;
      let isNoBall = false;
      let isFreeHit = false;
      let wicketValue = 0;
      
      // Check for no-ball (both 0 except in Test)
      if (batterCard === 0 && bowlerCard === 0 && gameState.format !== 'test') {
        isNoBall = true;
        runs = 1; // No ball +1 run
        isFreeHit = true; // Next ball is free hit
      }
      // Check for dead over rules (ODI only)
      else if (gameState.isDeadOver && gameState.format === '50') {
        if (batterCard === 0 && bowlerCard !== 0) {
          // Dot ball in dead over
          runs = 0;
        } else if (batterCard !== 0 && bowlerCard !== 0 && batterCard !== bowlerCard) {
          // Normal scoring
          runs = batterCard;
        } else if (batterCard !== 0 && bowlerCard === 0) {
          // Dot ball in dead over
          runs = 0;
        } else if (batterCard === bowlerCard) {
          // Wicket
          isWicket = true;
          runs = 0;
        }
      }
      // Normal rules
      else {
        if (batterCard === 0 && bowlerCard !== 0) {
          // Bowler's card is added to score
          runs = bowlerCard;
        } else if (batterCard !== 0 && bowlerCard === 0) {
          // Dot ball (no runs)
          runs = 0;
        } else if (batterCard !== 0 && bowlerCard !== 0) {
          if (batterCard === bowlerCard) {
            // Wicket
            isWicket = true;
            runs = 0;
          } else {
            // Batter's card is added to score
            runs = batterCard;
          }
        }
      }
      
      // Handle free hit - can't get out except run out
      if (gameState.freeHit && isWicket) {
        isWicket = false;
        runs = batterCard; // Score runs instead
      }
      
      // Calculate wicket value based on format and powerplay
      if (isWicket) {
        if (gameState.format === 'test') {
          wicketValue = 0.333; // 1/3 for test
        } else if (gameState.isPowerplay) {
          if (gameState.format === '50') {
            wicketValue = 0.25; // 1/4 for ODI powerplay
          } else {
            wicketValue = 0.5; // 1/2 for T20/T10/T5 powerplay
          }
        } else {
          if (gameState.format === '50') {
            wicketValue = 0.5; // 1/2 for ODI non-powerplay
          } else {
            wicketValue = 1; // Full wicket for T20/T10/T5 non-powerplay
          }
        }
      }
      
      // Update game state
      updateGameState(runs, isWicket, wicketValue, isNoBall, isFreeHit, batterCard, bowlerCard);
      
      // Save to Firebase
      saveGameState();
    }

    // Update game state after each ball
    function updateGameState(runs, isWicket, wicketValue, isNoBall, isFreeHit, batterCard, bowlerCard) {
      // Update ball count (unless it's a no-ball)
      if (!isNoBall) {
        gameState.ballsBowled++;
        gameState.bowlerStats[gameState.currentBowler].balls++;
      }
      
      // Update runs
      gameState.totalRuns += runs;
      gameState.batterStats[gameState.currentBatter].runs += runs;
      gameState.bowlerStats[gameState.currentBowler].runs += runs;
      
      // Update balls faced (unless it's a no-ball)
      if (!isNoBall) {
        gameState.batterStats[gameState.currentBatter].balls++;
      }
      
      // Update dots count
      if (runs === 0) {
        gameState.batterStats[gameState.currentBatter].dots++;
        gameState.bowlerStats[gameState.currentBowler].dots++;
        gameState.batterDots++;
        gameState.bowlerDots++;
      } else {
        gameState.batterDots = 0;
        gameState.bowlerDots = 0;
      }
      
      // Update fours/sixes
      if (runs === 4) {
        gameState.batterStats[gameState.currentBatter].fours++;
      } else if (runs === 6) {
        gameState.batterStats[gameState.currentBatter].sixes++;
      }
      
      // Update wickets
      if (isWicket) {
        gameState.totalWickets++;
        gameState.batterStats[gameState.currentBatter].wickets += wicketValue;
        gameState.bowlerStats[gameState.currentBowler].wickets += wicketValue;
        
        // Check if batter is out (wickets >= 1)
        if (gameState.batterStats[gameState.currentBatter].wickets >= 1) {
          gameState.batterStats[gameState.currentBatter].isOut = true;
          gameState.batterStats[gameState.currentBatter].isBatting = false;
          
          // Check if all out (10 wickets in limited overs, or all batters out in test)
          const battingTeam = gameState.battingTeam === 'player1' ? 'player1' : 'player2';
          get(teamsRef).then((snap) => {
            if (snap.exists()) {
              const teamsData = snap.val();
              const battingTeamPlayers = teamsData[battingTeam].players;
              
              let outCount = 0;
              battingTeamPlayers.forEach(player => {
                if (gameState.batterStats[player].isOut) outCount++;
              });
              
              // In limited overs, 10 wickets means all out
              // In test, when all but one batter is out, innings ends
              if ((gameState.format !== 'test' && gameState.totalWickets >= 10) || 
                  (gameState.format === 'test' && outCount >= battingTeamPlayers.length - 1)) {
                endInnings();
                return;
              }
              
              // Select new batter
              showBatterSelection();
            }
          });
        }
      }
      
      // Check for over completion (6 balls, unless no-ball which doesn't count)
      if (!isNoBall && gameState.ballsBowled % 6 === 0) {
        gameState.oversBowled = gameState.ballsBowled / 6;
        
        // Check for maiden over (no runs in the over)
        if (runs === 0 && gameState.currentOver.every(b => b.runs === 0)) {
          gameState.bowlerStats[gameState.currentBowler].maidens++;
        }
        
        // Select new bowler for next over
        showBowlerSelection();
      }
      
      // Check for innings completion (limited overs only)
      if (gameState.format !== 'test' && gameState.oversBowled >= gameState.maxOvers) {
        endInnings();
        return;
      }
      
      // Update current over
      gameState.currentOver.push({
        runs: runs,
        isWicket: isWicket,
        isNoBall: isNoBall,
        isFreeHit: isFreeHit,
        batterCard: batterCard,
        bowlerCard: bowlerCard
      });
      
      // Reset current over if it's complete (6 balls)
      if (gameState.currentOver.length >= 6) {
        gameState.currentOver = [];
      }
      
      // Set free hit for next ball if this was a no-ball
      gameState.freeHit = isNoBall;
      
      // Check powerplay status
      checkPowerplay();
      
      // Update UI
      updateScoreDisplay();
      updateOverProgress();
      updatePlayerStats();
    }

    // Save game state to Firebase
    function saveGameState() {
      const updates = {
        currentInnings: gameState.currentInnings,
        battingTeam: gameState.battingTeam,
        bowlingTeam: gameState.bowlingTeam,
        currentBatter: gameState.currentBatter,
        currentBowler: gameState.currentBowler,
        ballsBowled: gameState.ballsBowled,
        oversBowled: gameState.oversBowled,
        totalRuns: gameState.totalRuns,
        totalWickets: gameState.totalWickets,
        currentOver: gameState.currentOver,
        isPowerplay: gameState.isPowerplay,
        isDeadOver: gameState.isDeadOver,
        freeHit: gameState.freeHit,
        batterDots: gameState.batterDots,
        bowlerDots: gameState.bowlerDots,
        inningsCompleted: gameState.inningsCompleted,
        [`batterStats/${gameState.currentBatter}`]: gameState.batterStats[gameState.currentBatter],
        [`bowlerStats/${gameState.currentBowler}`]: gameState.bowlerStats[gameState.currentBowler]
      };
      
      if (gameState.format === '50') {
        updates.selectedDeadOvers = gameState.selectedDeadOvers;
      }
      
      if (gameState.format === 'test') {
        updates.followOnTarget = gameState.followOnTarget;
      }
      
      update(ref(db, `rooms/${roomId}/game/${gameState.currentInnings}`), updates);
    }

    // End current innings
    function endInnings() {
      gameState.inningsCompleted = true;
      
      // Calculate follow-on target for test matches
      if (gameState.format === 'test' && gameState.currentInnings === 'firstInnings') {
        gameState.followOnTarget = Math.floor(gameState.totalRuns * 0.75);
      }
      
      // Update in Firebase
      update(ref(db, `rooms/${roomId}/game/${gameState.currentInnings}`), {
        inningsCompleted: true,
        followOnTarget: gameState.followOnTarget || null
      });
      
      // Show innings summary
      showInningsSummary();
    }

    // Show innings summary modal
    function showInningsSummary() {
      summaryTitle.textContent = `${gameState.currentInnings === 'firstInnings' ? 'First' : 'Second'} Innings Summary`;
      summaryRuns.textContent = gameState.totalRuns;
      summaryWickets.textContent = gameState.totalWickets;
      summaryOvers.textContent = formatOvers(gameState.ballsBowled);
      summaryRunRate.textContent = calculateEconomyRate(gameState.totalRuns, gameState.ballsBowled);
      
      // Show target for second innings
      if (gameState.currentInnings === 'firstInnings') {
        targetRow.style.display = 'none';
      } else {
        targetRow.style.display = 'flex';
        summaryTarget.textContent = gameState.firstInningsTotal + 1;
      }
      
      // Populate batter stats
      batterStatsTable.innerHTML = '';
      Object.entries(gameState.batterStats).forEach(([name, stats]) => {
        if (stats.balls > 0 || stats.isOut) {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${name} ${stats.isOut ? '' : ''}</td>
            <td>${stats.runs}</td>
            <td>${stats.balls}</td>
            <td>${calculateStrikeRate(stats.runs, stats.balls)}</td>
          `;
          batterStatsTable.appendChild(tr);
        }
      });
      
      // Populate bowler stats
      bowlerStatsTable.innerHTML = '';
      Object.entries(gameState.bowlerStats).forEach(([name, stats]) => {
        if (stats.balls > 0) {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${name}</td>
            <td>${formatOvers(stats.balls)}</td>
            <td>${stats.wickets}</td>
            <td>${calculateEconomyRate(stats.runs, stats.balls)}</td>
          `;
          bowlerStatsTable.appendChild(tr);
        }
      });
      
      summaryModal.classList.add('active');
    }

    // Continue to next innings or match result
    continueBtn.addEventListener('click', () => {
      summaryModal.classList.remove('active');
      
      if (gameState.currentInnings === 'firstInnings') {
        // Start second innings
        startSecondInnings();
      } else {
        // Match completed - show result
        calculateMatchResult();
        showMatchResult();
      }
    });

    // Start second innings
    function startSecondInnings() {
      // Swap batting and bowling teams
      gameState.battingTeam = gameState.battingTeam === 'player1' ? 'player2' : 'player1';
      gameState.bowlingTeam = gameState.bowlingTeam === 'player1' ? 'player2' : 'player1';
      
      // Reset innings-specific stats
      gameState.currentInnings = 'secondInnings';
      gameState.currentBatter = null;
      gameState.currentBowler = null;
      gameState.ballsBowled = 0;
      gameState.oversBowled = 0;
      gameState.totalRuns = 0;
      gameState.totalWickets = 0;
      gameState.currentOver = [];
      gameState.isPowerplay = false;
      gameState.isDeadOver = false;
      gameState.freeHit = false;
      gameState.batterDots = 0;
      gameState.bowlerDots = 0;
      gameState.inningsCompleted = false;
      
      // Reset batter stats (keeping first innings stats)
      get(teamsRef).then((snap) => {
        if (snap.exists()) {
          const teamsData = snap.val();
          const battingTeam = gameState.battingTeam === 'player1' ? teamsData.player1 : teamsData.player2;
          
          battingTeam.players.forEach(player => {
            gameState.batterStats[player] = {
              runs: 0,
              balls: 0,
              dots: 0,
              fours: 0,
              sixes: 0,
              wickets: 0,
              isOut: false,
              isBatting: false
            };
          });
        }
      });
      
      // Save to Firebase
      update(ref(db, `rooms/${roomId}/game`), {
        currentInnings: 'secondInnings',
        battingTeam: gameState.battingTeam,
        bowlingTeam: gameState.bowlingTeam,
        secondInnings: {
          currentBatter: null,
          currentBowler: null,
          ballsBowled: 0,
          oversBowled: 0,
          totalRuns: 0,
          totalWickets: 0,
          currentOver: [],
          isPowerplay: false,
          isDeadOver: false,
          freeHit: false,
          batterDots: 0,
          bowlerDots: 0,
          inningsCompleted: false,
          batterStats: {},
          bowlerStats: {}
        }
      });
      
      // Show batter selection
      showBatterSelection();
    }

    // Calculate match result
    function calculateMatchResult() {
      // Get first innings total
      get(firstInningsRef).then((firstSnap) => {
        if (firstSnap.exists()) {
          const firstInnings = firstSnap.val();
          gameState.firstInningsTotal = firstInnings.totalRuns;
          
          // Determine winner
          if (gameState.totalRuns > firstInnings.totalRuns) {
            // Batting team (second innings) won
            gameState.winner = gameState.battingTeam;
            gameState.winningMargin = `by ${10 - gameState.totalWickets} wickets`;
          } else if (gameState.totalRuns < firstInnings.totalRuns) {
            // Bowling team (first innings batting team) won
            gameState.winner = gameState.bowlingTeam;
            gameState.winningMargin = `by ${firstInnings.totalRuns - gameState.totalRuns} runs`;
          } else {
            // Tie
            gameState.winner = 'tie';
            gameState.winningMargin = 'Match tied';
          }
          
          // Determine player of the match (highest scorer or best bowler)
          let maxRuns = 0;
          let potm = '';
          
          // Check first innings batters
          Object.entries(firstInnings.batterStats).forEach(([name, stats]) => {
            if (stats.runs > maxRuns) {
              maxRuns = stats.runs;
              potm = name;
            }
          });
          
          // Check second innings batters
          Object.entries(gameState.batterStats).forEach(([name, stats]) => {
            if (stats.runs > maxRuns) {
              maxRuns = stats.runs;
              potm = name;
            }
          });
          
          // Check bowlers (if no batter scored significantly)
          if (maxRuns < 30) {
            let maxWickets = 0;
            let bestBowler = '';
            
            // Check first innings bowlers
            Object.entries(firstInnings.bowlerStats).forEach(([name, stats]) => {
              if (stats.wickets > maxWickets) {
                maxWickets = stats.wickets;
                bestBowler = name;
              }
            });
            
            // Check second innings bowlers
            Object.entries(gameState.bowlerStats).forEach(([name, stats]) => {
              if (stats.wickets > maxWickets) {
                maxWickets = stats.wickets;
                bestBowler = name;
              }
            });
            
            if (bestBowler) potm = bestBowler;
          }
          
          gameState.playerOfTheMatch = potm;
          
          // Mark match as completed in Firebase
          update(ref(db, `rooms/${roomId}/game`), {
            matchCompleted: true,
            winner: gameState.winner,
            winningMargin: gameState.winningMargin,
            playerOfTheMatch: gameState.playerOfTheMatch
          });
          
          // Save match data to completed matches
          saveMatchData();
        }
      });
    }

    // Show match result modal
    function showMatchResult() {
      if (gameState.winner === 'tie') {
        resultTitle.textContent = 'Match Tied!';
        winnerName.textContent = 'Match tied';
        winningMargin.textContent = 'Both teams scored the same runs';
      } else {
        const winnerTeam = gameState.winner === 'player1' ? team1Name.textContent : team2Name.textContent;
        resultTitle.textContent = `${winnerTeam} Won!`;
        winnerName.textContent = winnerTeam;
        winningMargin.textContent = gameState.winningMargin;
      }
      
      playerOfMatch.textContent = gameState.playerOfTheMatch || 'Not determined';
      
      // Get first innings data
      get(firstInningsRef).then((firstSnap) => {
        if (firstSnap.exists()) {
          const firstInnings = firstSnap.val();
          
          firstInningsRuns.textContent = firstInnings.totalRuns;
          firstInningsWickets.textContent = firstInnings.totalWickets;
          firstInningsOvers.textContent = formatOvers(firstInnings.ballsBowled);
          
          secondInningsRuns.textContent = gameState.totalRuns;
          secondInningsWickets.textContent = gameState.totalWickets;
          secondInningsOvers.textContent = formatOvers(gameState.ballsBowled);
        }
        
        resultModal.classList.add('active');
      });
    }

    // Save match data to completed matches
    function saveMatchData() {
      // Get all match data
      get(gameRef).then((gameSnap) => {
        if (gameSnap.exists()) {
          const gameData = gameSnap.val();
          
          // Get teams data
          get(teamsRef).then((teamsSnap) => {
            if (teamsSnap.exists()) {
              const teamsData = teamsSnap.val();
              
              // Get toss data
              get(tossRef).then((tossSnap) => {
                const tossData = tossSnap.exists() ? tossSnap.val() : {};
                
                // Prepare match data for saving
                const matchData = {
                  team1Name: teamsData.player1.name,
                  team2Name: teamsData.player2.name,
                  format: gameState.format,
                  timestamp: Date.now(),
                  winner: gameData.winner,
                  winningMargin: gameData.winningMargin,
                  playerOfTheMatch: gameData.playerOfTheMatch,
                  firstInnings: {
                    battingTeam: gameData.firstInnings.battingTeam,
                    totalRuns: gameData.firstInnings.totalRuns,
                    totalWickets: gameData.firstInnings.totalWickets,
                    balls: gameData.firstInnings.ballsBowled,
                    batterStats: gameData.firstInnings.batterStats,
                    bowlerStats: gameData.firstInnings.bowlerStats
                  },
                  secondInnings: {
                    battingTeam: gameData.secondInnings.battingTeam,
                    totalRuns: gameData.secondInnings.totalRuns,
                    totalWickets: gameData.secondInnings.totalWickets,
                    balls: gameData.secondInnings.ballsBowled,
                    batterStats: gameData.secondInnings.batterStats,
                    bowlerStats: gameData.secondInnings.bowlerStats
                  },
                  player1Stats: {},
                  player2Stats: {}
                };
                
                // Add player stats for leaderboard
                if (gameData.firstInnings.battingTeam === 'player1') {
                  matchData.player1Stats = gameData.firstInnings.batterStats;
                  matchData.player2Stats = gameData.firstInnings.bowlerStats;
                } else {
                  matchData.player1Stats = gameData.firstInnings.bowlerStats;
                  matchData.player2Stats = gameData.firstInnings.batterStats;
                }
                
                // Add second innings stats
                if (gameData.secondInnings.battingTeam === 'player1') {
                  Object.entries(gameData.secondInnings.batterStats).forEach(([player, stats]) => {
                    if (!matchData.player1Stats[player]) matchData.player1Stats[player] = {};
                    Object.entries(stats).forEach(([key, value]) => {
                      if (key !== 'isBatting' && key !== 'isOut') {
                        matchData.player1Stats[player][key] = (matchData.player1Stats[player][key] || 0) + value;
                      }
                    });
                  });
                  
                  Object.entries(gameData.secondInnings.bowlerStats).forEach(([player, stats]) => {
                    if (!matchData.player2Stats[player]) matchData.player2Stats[player] = {};
                    Object.entries(stats).forEach(([key, value]) => {
                      if (key !== 'isBowling') {
                        matchData.player2Stats[player][key] = (matchData.player2Stats[player][key] || 0) + value;
                      }
                    });
                  });
                } else {
                  Object.entries(gameData.secondInnings.batterStats).forEach(([player, stats]) => {
                    if (!matchData.player2Stats[player]) matchData.player2Stats[player] = {};
                    Object.entries(stats).forEach(([key, value]) => {
                      if (key !== 'isBatting' && key !== 'isOut') {
                        matchData.player2Stats[player][key] = (matchData.player2Stats[player][key] || 0) + value;
                      }
                    });
                  });
                  
                  Object.entries(gameData.secondInnings.bowlerStats).forEach(([player, stats]) => {
                    if (!matchData.player1Stats[player]) matchData.player1Stats[player] = {};
                    Object.entries(stats).forEach(([key, value]) => {
                      if (key !== 'isBowling') {
                        matchData.player1Stats[player][key] = (matchData.player1Stats[player][key] || 0) + value;
                      }
                    });
                  });
                }
                
                // Save to completed matches
                const newMatchRef = ref(db, `completedMatches/${roomId}`);
                set(newMatchRef, matchData).then(() => {
                  // Remove room data
                  remove(roomRef).then(() => {
                    console.log('Match data saved and room cleared');
                  });
                });
              });
            }
          });
        }
      });
    }

    // Save match button click
    saveMatchBtn.addEventListener('click', () => {
      saveMatchData();
      window.location.href = `match_summary.html?id=${roomId}`;
    });

    // Modal close buttons
    closeTeamsModal.addEventListener('click', () => teamsModal.classList.remove('active'));
    closeBatterModal.addEventListener('click', () => batterModal.classList.remove('active'));
    closeBowlerModal.addEventListener('click', () => bowlerModal.classList.remove('active'));
    closeSummaryModal.addEventListener('click', () => summaryModal.classList.remove('active'));
    closeResultModal.addEventListener('click', () => resultModal.classList.remove('active'));

    // Teams button click
    teamsBtn.addEventListener('click', () => teamsModal.classList.add('active'));

    // Reset button click
    resetBtn.addEventListener('click', () => {
      gameState.selectedCard = null;
      document.querySelectorAll('.control-btn').forEach(b => b.classList.remove('selected'));
      submitBtn.disabled = true;
    });

    // Initialize the game
    initGame();
  </script>
</body>
</html>