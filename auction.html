<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HandiCricket - Auction</title>
  <style>
    body {
      background: linear-gradient(135deg, #061e3e, #0a2a4a);
      color: white;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      margin: 0;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    h1 {
      color: #ffeb3b;
      text-shadow: 0 0 10px rgba(255, 235, 59, 0.5);
      margin-bottom: 20px;
      text-align: center;
    }
    
    .section {
      display: none;
      margin-bottom: 30px;
    }
    
    .section.active {
      display: block;
    }
    
    .user-info {
      margin-bottom: 20px;
      padding: 15px;
      background: rgba(13, 42, 82, 0.5);
      border-radius: 10px;
    }
    
    .user-info p {
      margin: 5px 0;
    }
    
    .user-team {
      font-weight: bold;
      color: #ffeb3b;
    }
    
    .btn {
      padding: 12px 25px;
      border: none;
      border-radius: 8px;
      background: linear-gradient(145deg, #1e88e5, #1565c0);
      color: white;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      margin: 10px 5px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    }
    
    .btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 10px rgba(0, 0, 0, 0.3);
    }
    
    .btn:active {
      transform: translateY(1px);
    }
    
    .btn-primary {
      background: linear-gradient(145deg, #1e88e5, #1565c0);
    }
    
    .btn-success {
      background: linear-gradient(145deg, #4CAF50, #2E7D32);
    }
    
    .btn-warning {
      background: linear-gradient(145deg, #FF9800, #F57C00);
    }
    
    .btn-danger {
      background: linear-gradient(145deg, #f44336, #d32f2f);
    }
    
    .btn-purple {
      background: linear-gradient(145deg, #9C27B0, #7B1FA2);
    }
    
    .btn-teal {
      background: linear-gradient(145deg, #009688, #00796B);
    }
    
    .btn-back {
      background: linear-gradient(145deg, #607D8B, #455A64);
    }
    
    .btn-small {
      padding: 8px 15px;
      font-size: 14px;
    }
    
    .card {
      background: rgba(13, 42, 82, 0.5);
      border-radius: 10px;
      padding: 15px;
      margin: 15px 0;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .card-header {
      font-weight: bold;
      color: #ffeb3b;
      margin-bottom: 10px;
      font-size: 18px;
    }
    
    .player-card {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin: 20px 0;
    }
    
    .player-item {
      flex: 1 0 200px;
      padding: 15px;
      background: rgba(30, 136, 229, 0.2);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      border: 2px solid transparent;
      position: relative;
    }
    
    .player-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 10px rgba(0, 0, 0, 0.3);
    }
    
    .player-item.selected {
      border-color: #ffeb3b;
      background: rgba(30, 136, 229, 0.4);
    }
    
    .player-item.captain {
      border-color: gold;
      background: rgba(255, 215, 0, 0.2);
    }
    
    .player-item h3 {
      margin-top: 0;
      margin-bottom: 5px;
      color: #ffeb3b;
    }
    
    .player-item p {
      margin: 5px 0;
      font-size: 14px;
    }
    
    .player-item .role {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .role-batter {
      background-color: #4CAF50;
    }
    
    .role-pacer {
      background-color: #f44336;
    }
    
    .role-spinner {
      background-color: #9C27B0;
    }
    
    .role-allrounder {
      background-color: #FF9800;
    }
    
    .role-wicketkeeper {
      background-color: #607D8B;
    }
    
    .retention-cost {
      position: absolute;
      top: 10px;
      right: 10px;
      font-weight: bold;
      color: white;
      background: rgba(0,0,0,0.5);
      padding: 2px 6px;
      border-radius: 4px;
    }
    
    .bid-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 15px 0;
    }
    
    .bid-btn {
      flex: 1;
      min-width: 100px;
    }
    
    .current-player {
      background: rgba(255, 235, 59, 0.2);
      border: 2px solid #ffeb3b;
    }
    
    .current-player h3 {
      color: white;
    }
    
    .auction-timer {
      font-size: 24px;
      font-weight: bold;
      text-align: center;
      margin: 15px 0;
      color: #ffeb3b;
    }
    
    .team-info {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin: 20px 0;
    }
    
    .team-card {
      flex: 1;
      min-width: 250px;
      background: rgba(13, 42, 82, 0.5);
      border-radius: 10px;
      padding: 15px;
    }
    
    .team-card h3 {
      margin-top: 0;
      color: #ffeb3b;
      border-bottom: 1px solid #1e88e5;
      padding-bottom: 8px;
    }
    
    .team-card p {
      margin: 5px 0;
    }
    
    .budget-display {
      font-size: 18px;
      font-weight: bold;
      color: #4CAF50;
    }
    
    .rtm-display {
      font-size: 18px;
      font-weight: bold;
      color: #FF9800;
    }
    
    .players-list {
      max-height: 200px;
      overflow-y: auto;
      margin-top: 10px;
    }
    
    .players-list li {
      padding: 5px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .admin-controls {
      background: rgba(255, 0, 0, 0.1);
      border: 1px solid rgba(255, 0, 0, 0.3);
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
    }
    
    .admin-controls h3 {
      color: #f44336;
      margin-top: 0;
    }
    
    .input-group {
      margin-bottom: 15px;
    }
    
    .input-group label {
      display: block;
      margin-bottom: 5px;
      color: #aaa;
    }
    
    .input-group input, .input-group select, .input-group textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #1e88e5;
      border-radius: 8px;
      background: rgba(30, 136, 229, 0.1);
      color: white;
      font-size: 16px;
      box-sizing: border-box;
    }
    
    .input-group textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .modal-content {
      background: linear-gradient(135deg, #061e3e, #0a2a4a);
      padding: 30px;
      border-radius: 15px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .modal-header {
      font-size: 24px;
      color: #ffeb3b;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .close-modal {
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      color: #aaa;
      font-size: 24px;
      cursor: pointer;
    }
    
    .notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 15px;
      border-radius: 8px;
      max-width: 300px;
      display: none;
      z-index: 1000;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    
    .loading-spinner {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 3px solid #1e88e5;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    .error-message {
      color: #f44336;
      margin: 10px 0;
    }
    
    .success-message {
      color: #4CAF50;
      margin: 10px 0;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }
      
      .player-item {
        flex: 1 0 100%;
      }
      
      .team-card {
        min-width: 100%;
      }
      
      .bid-btn {
        min-width: 80px;
        padding: 10px;
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üèè HandiCricket Auction</h1>
    
    <div class="user-info">
      <p>Team: <span id="teamDisplay" class="user-team"></span></p>
      <p>Budget: <span id="budgetDisplay" class="budget-display">‚Çπ150 Cr</span></p>
      <p>RTM Cards: <span id="rtmDisplay" class="rtm-display">0</span></p>
    </div>
    
    <!-- Retention Section -->
    <div id="retentionSection" class="section active">
      <div class="card">
        <div class="card-header">Player Retention</div>
        <p>Retain up to 6 players from your previous squad. Captain retention costs ‚Çπ4 Cr, others cost ‚Çπ2 Cr.</p>
        <p>You will earn RTM (Right-to-Match) cards equal to 6 minus the number of players retained.</p>
        
        <div id="retentionPlayerList" class="player-card"></div>
        
        <div class="input-group">
          <button id="selectCaptainBtn" class="btn btn-warning">Select Captain</button>
          <button id="confirmRetentionBtn" class="btn btn-success">Confirm Retention</button>
          <button id="skipRetentionBtn" class="btn btn-back">Skip Retention</button>
        </div>
      </div>
    </div>
    
    <!-- Room Setup Section -->
    <div id="roomSetupSection" class="section">
      <div class="card">
        <div class="card-header">Auction Room Setup</div>
        
        <div id="adminControls" class="admin-controls" style="display: none;">
          <h3>Admin Controls</h3>
          <div class="input-group">
            <label for="roomCodeInput">Room Code (4 digits)</label>
            <input type="text" id="roomCodeInput" placeholder="Enter 4-digit code" maxlength="4">
          </div>
          
          <div class="input-group">
            <button id="createRoomBtn" class="btn btn-success">Create Auction Room</button>
          </div>
          
          <div class="input-group">
            <label>Add Players to Auction Pool</label>
            <select id="playerRoleInput">
              <option value="Batter">Batter</option>
              <option value="Pacer">Pacer</option>
              <option value="Spinner">Spinner</option>
              <option value="All-Rounder">All-Rounder</option>
              <option value="Wicket-Keeper">Wicket-Keeper</option>
            </select>
            <input type="text" id="playerNameInput" placeholder="Player name">
            <button id="addPlayerBtn" class="btn btn-primary btn-small">Add Player</button>
          </div>
          
          <div class="input-group">
            <label>Bulk Add Players (CSV format: Name,Role)</label>
            <textarea id="bulkPlayersInput" placeholder="Virat Kohli,Batter&#10;Jasprit Bumrah,Pacer&#10;Rashid Khan,Spinner"></textarea>
            <button id="bulkAddBtn" class="btn btn-primary">Bulk Add Players</button>
          </div>
          
          <div class="input-group">
            <button id="startAuctionBtn" class="btn btn-success">Start Auction</button>
          </div>
        </div>
        
        <div id="joinRoomSection">
          <div class="input-group">
            <label for="joinRoomCodeInput">Enter Room Code</label>
            <input type="text" id="joinRoomCodeInput" placeholder="Enter 4-digit code" maxlength="4">
          </div>
          <div class="input-group">
            <button id="joinRoomBtn" class="btn btn-primary">Join Room</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Auction Section -->
    <div id="auctionSection" class="section">
      <div class="card">
        <div class="card-header">Auction in Progress</div>
        
        <div id="currentPlayerCard" class="player-item current-player" style="display: none;">
          <h3 id="currentPlayerName">Player Name</h3>
          <p>Role: <span id="currentPlayerRole" class="role role-batter">Batter</span></p>
          <p>Base Price: <span id="currentPlayerPrice">‚Çπ2 Cr</span></p>
          <p>Current Bid: <span id="currentBidAmount">‚Çπ0 Cr</span> by <span id="currentBidTeam">None</span></p>
          
          <div class="auction-timer" id="auctionTimer">30</div>
          
          <div class="bid-controls">
            <button class="btn btn-primary bid-btn" data-increment="0.10">+‚Çπ0.10 Cr</button>
            <button class="btn btn-primary bid-btn" data-increment="0.25">+‚Çπ0.25 Cr</button>
            <button class="btn btn-primary bid-btn" data-increment="0.50">+‚Çπ0.50 Cr</button>
            <button class="btn btn-primary bid-btn" data-increment="1.00">+‚Çπ1.00 Cr</button>
            <button id="passBtn" class="btn btn-back bid-btn">Pass</button>
            <button id="rtmBtn" class="btn btn-purple bid-btn">Use RTM (0)</button>
          </div>
        </div>
        
        <div id="waitingForAdmin" style="text-align: center; padding: 20px;">
          <p>Waiting for admin to start the auction...</p>
          <div class="loading-spinner"></div>
        </div>
      </div>
      
      <div id="adminAuctionControls" class="admin-controls" style="display: none;">
        <h3>Admin Auction Controls</h3>
        <div class="input-group">
          <button id="nextPlayerBtn" class="btn btn-primary">Next Player</button>
          <button id="autoSellBtn" class="btn btn-success">Auto Sell</button>
          <button id="soldBtn" class="btn btn-warning">Sold!</button>
        </div>
      </div>
      
      <div class="team-info">
        <div class="team-card">
          <h3>Your Squad</h3>
          <p>Budget: <span id="yourBudget" class="budget-display">‚Çπ150 Cr</span></p>
          <p>Players: <span id="yourPlayerCount">0/25</span></p>
          <p>RTM Cards: <span id="yourRtmCount" class="rtm-display">0</span></p>
          <div class="players-list">
            <ul id="yourSquadList"></ul>
          </div>
        </div>
        
        <div class="team-card">
          <h3>Auction Pool</h3>
          <div class="players-list">
            <ul id="auctionPoolList"></ul>
          </div>
        </div>
      </div>
    </div>
    
    <div class="input-group" style="text-align: center;">
      <button id="backBtn" class="btn btn-back">Back to Home</button>
    </div>
  </div>
  
  <!-- Captain Selection Modal -->
  <div id="captainModal" class="modal">
    <div class="modal-content">
      <button class="close-modal">&times;</button>
      <div class="modal-header">Select Captain</div>
      <p>Select your retained captain (costs ‚Çπ4 Cr):</p>
      <div id="captainSelectionList" class="player-card"></div>
    </div>
  </div>
  
  <!-- Player Selection Modal -->
  <div id="playerModal" class="modal">
    <div class="modal-content">
      <button class="close-modal">&times;</button>
      <div class="modal-header">Select Next Player</div>
      <div class="input-group">
        <select id="filterRole">
          <option value="All">All Roles</option>
          <option value="Batter">Batters</option>
          <option value="Pacer">Pacers</option>
          <option value="Spinner">Spinners</option>
          <option value="All-Rounder">All-Rounders</option>
          <option value="Wicket-Keeper">Wicket-Keepers</option>
        </select>
      </div>
      <div id="playerSelectionList" class="player-card"></div>
    </div>
  </div>
  
  <!-- Notification -->
  <div id="notification" class="notification"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getDatabase, ref, set, update, get, child, onValue, push } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCN6aZMwlsZe7JJaovU0WA3UQygWr4jYmA",
      authDomain: "handicricket-85a06.firebaseapp.com",
      projectId: "handicricket-85a06",
      storageBucket: "handicricket-85a06.appspot.com",
      messagingSenderId: "599182538558",
      appId: "1:599182538558:web:3e965753ab05f8f1e3de6f",
      measurementId: "G-HSV9H4LEJQ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // DOM elements
    const teamDisplay = document.getElementById('teamDisplay');
    const budgetDisplay = document.getElementById('budgetDisplay');
    const rtmDisplay = document.getElementById('rtmDisplay');
    
    // Sections
    const retentionSection = document.getElementById('retentionSection');
    const roomSetupSection = document.getElementById('roomSetupSection');
    const auctionSection = document.getElementById('auctionSection');
    
    // Retention elements
    const retentionPlayerList = document.getElementById('retentionPlayerList');
    const selectCaptainBtn = document.getElementById('selectCaptainBtn');
    const confirmRetentionBtn = document.getElementById('confirmRetentionBtn');
    const skipRetentionBtn = document.getElementById('skipRetentionBtn');
    
    // Room setup elements
    const adminControls = document.getElementById('adminControls');
    const roomCodeInput = document.getElementById('roomCodeInput');
    const createRoomBtn = document.getElementById('createRoomBtn');
    const joinRoomSection = document.getElementById('joinRoomSection');
    const joinRoomCodeInput = document.getElementById('joinRoomCodeInput');
    const joinRoomBtn = document.getElementById('joinRoomBtn');
    const playerRoleInput = document.getElementById('playerRoleInput');
    const playerNameInput = document.getElementById('playerNameInput');
    const addPlayerBtn = document.getElementById('addPlayerBtn');
    const bulkPlayersInput = document.getElementById('bulkPlayersInput');
    const bulkAddBtn = document.getElementById('bulkAddBtn');
    const startAuctionBtn = document.getElementById('startAuctionBtn');
    
    // Auction elements
    const currentPlayerCard = document.getElementById('currentPlayerCard');
    const currentPlayerName = document.getElementById('currentPlayerName');
    const currentPlayerRole = document.getElementById('currentPlayerRole');
    const currentPlayerPrice = document.getElementById('currentPlayerPrice');
    const currentBidAmount = document.getElementById('currentBidAmount');
    const currentBidTeam = document.getElementById('currentBidTeam');
    const auctionTimer = document.getElementById('auctionTimer');
    const passBtn = document.getElementById('passBtn');
    const rtmBtn = document.getElementById('rtmBtn');
    const waitingForAdmin = document.getElementById('waitingForAdmin');
    const adminAuctionControls = document.getElementById('adminAuctionControls');
    const nextPlayerBtn = document.getElementById('nextPlayerBtn');
    const autoSellBtn = document.getElementById('autoSellBtn');
    const soldBtn = document.getElementById('soldBtn');
    const yourBudget = document.getElementById('yourBudget');
    const yourPlayerCount = document.getElementById('yourPlayerCount');
    const yourRtmCount = document.getElementById('yourRtmCount');
    const yourSquadList = document.getElementById('yourSquadList');
    const auctionPoolList = document.getElementById('auctionPoolList');
    
    // Modals
    const captainModal = document.getElementById('captainModal');
    const captainSelectionList = document.getElementById('captainSelectionList');
    const playerModal = document.getElementById('playerModal');
    const filterRole = document.getElementById('filterRole');
    const playerSelectionList = document.getElementById('playerSelectionList');
    const closeModalBtns = document.querySelectorAll('.close-modal');
    
    // Notification
    const notification = document.getElementById('notification');
    
    // Back button
    const backBtn = document.getElementById('backBtn');
    
    // Current user and team
    let currentUser = localStorage.getItem('hc_username');
    let currentTeam = localStorage.getItem('hc_team');
    let isAdmin = false;
    let roomCode = null;
    let retentionDone = false;
    
    // Auction state
    let selectedPlayers = [];
    let retainedCaptain = null;
    let budget = 150;
    let rtmCards = 0;
    let auctionPlayers = [];
    let currentAuctionPlayer = null;
    let currentBid = 0;
    let currentBidder = null;
    let timerInterval = null;
    let timeLeft = 30;
    
    // Initialize
    if (!currentUser || !currentTeam) {
      alert('Please login first');
      window.location.href = 'index.html';
    }
    
    teamDisplay.textContent = currentTeam;
    budgetDisplay.textContent = `‚Çπ${budget} Cr`;
    rtmDisplay.textContent = rtmCards;
    
    // Check if user is admin
    isAdmin = currentUser === 'imved169' || currentTeam === 'Ratnagiri Hunters';
    
    // Load previous squad for retention
    loadPreviousSquad();
    
    // Event listeners
    selectCaptainBtn.addEventListener('click', openCaptainModal);
    confirmRetentionBtn.addEventListener('click', confirmRetention);
    skipRetentionBtn.addEventListener('click', skipRetention);
    
    createRoomBtn.addEventListener('click', createRoom);
    joinRoomBtn.addEventListener('click', joinRoom);
    addPlayerBtn.addEventListener('click', addPlayerToPool);
    bulkAddBtn.addEventListener('click', bulkAddPlayers);
    startAuctionBtn.addEventListener('click', startAuction);
    
    document.querySelectorAll('.bid-btn').forEach(btn => {
      if (btn.id !== 'passBtn' && btn.id !== 'rtmBtn') {
        btn.addEventListener('click', () => placeBid(parseFloat(btn.dataset.increment)));
      }
    });
    passBtn.addEventListener('click', passBid);
    rtmBtn.addEventListener('click', useRtm);
    
    nextPlayerBtn.addEventListener('click', openPlayerModal);
    autoSellBtn.addEventListener('click', autoSellPlayer);
    soldBtn.addEventListener('click', sellPlayer);
    
    closeModalBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.modal').forEach(modal => {
          modal.style.display = 'none';
        });
      });
    });
    
    backBtn.addEventListener('click', () => {
      window.location.href = 'index.html';
    });
    
    // Window click handler for modals
    window.addEventListener('click', (e) => {
      if (e.target.classList.contains('modal')) {
        e.target.style.display = 'none';
      }
    });
    
    // Functions
    function loadPreviousSquad() {
      const userRef = ref(db, `users/${currentUser}`);
      onValue(userRef, (snap) => {
        if (snap.exists()) {
          const userData = snap.val();
          const players = userData.players || [];
          
          retentionPlayerList.innerHTML = '';
          
          if (players.length === 0) {
            retentionPlayerList.innerHTML = '<p>No players in your previous squad. You can skip retention.</p>';
            return;
          }
          
          players.forEach(player => {
            const playerItem = document.createElement('div');
            playerItem.className = 'player-item';
            playerItem.dataset.player = player;
            
            playerItem.innerHTML = `
              <h3>${player}</h3>
              <div class="retention-cost">‚Çπ2 Cr</div>
            `;
            
            playerItem.addEventListener('click', () => {
              if (playerItem.classList.contains('captain')) {
                playerItem.classList.remove('captain');
                retainedCaptain = null;
              } else if (playerItem.classList.contains('selected')) {
                playerItem.classList.remove('selected');
                selectedPlayers = selectedPlayers.filter(p => p !== player);
              } else if (selectedPlayers.length < 6) {
                playerItem.classList.add('selected');
                selectedPlayers.push(player);
              }
            });
            
            retentionPlayerList.appendChild(playerItem);
          });
        }
      });
    }
    
    function openCaptainModal() {
      if (selectedPlayers.length === 0) {
        showNotification('Please select at least one player to retain as captain');
        return;
      }
      
      captainSelectionList.innerHTML = '';
      
      selectedPlayers.forEach(player => {
        const playerItem = document.createElement('div');
        playerItem.className = 'player-item';
        playerItem.dataset.player = player;
        
        playerItem.innerHTML = `
          <h3>${player}</h3>
          <div class="retention-cost">‚Çπ4 Cr</div>
        `;
        
        playerItem.addEventListener('click', () => {
          document.querySelectorAll('#captainSelectionList .player-item').forEach(item => {
            item.classList.remove('captain');
          });
          playerItem.classList.add('captain');
          retainedCaptain = player;
        });
        
        captainSelectionList.appendChild(playerItem);
      });
      
      captainModal.style.display = 'flex';
    }
    
    function confirmRetention() {
      if (selectedPlayers.length === 0 && !retainedCaptain) {
        showNotification('Please select at least one player to retain or skip retention');
        return;
      }
      
      // Calculate retention cost
      let retentionCost = 0;
      if (retainedCaptain) {
        retentionCost += 4;
        retentionCost += (selectedPlayers.length - 1) * 2;
      } else {
        retentionCost = selectedPlayers.length * 2;
      }
      
      // Calculate RTM cards
      rtmCards = 6 - selectedPlayers.length;
      
      // Update budget
      budget -= retentionCost;
      budgetDisplay.textContent = `‚Çπ${budget} Cr`;
      rtmDisplay.textContent = rtmCards;
      
      // Save retention to Firebase
      const userRef = ref(db, `users/${currentUser}`);
      update(userRef, {
        retainedPlayers: selectedPlayers,
        retentionCaptain: retainedCaptain,
        budget: budget,
        rtmCards: rtmCards
      });
      
      showNotification(`Retention successful! Cost: ‚Çπ${retentionCost} Cr. You have ${rtmCards} RTM cards.`);
      retentionDone = true;
      
      // Move to room setup section
      retentionSection.classList.remove('active');
      roomSetupSection.classList.add('active');
      
      // Show admin controls if admin
      if (isAdmin) {
        adminControls.style.display = 'block';
        joinRoomSection.style.display = 'none';
      } else {
        adminControls.style.display = 'none';
        joinRoomSection.style.display = 'block';
      }
    }
    
    function skipRetention() {
      retentionDone = true;
      
      // Move to room setup section
      retentionSection.classList.remove('active');
      roomSetupSection.classList.add('active');
      
      // Show admin controls if admin
      if (isAdmin) {
        adminControls.style.display = 'block';
        joinRoomSection.style.display = 'none';
      } else {
        adminControls.style.display = 'none';
        joinRoomSection.style.display = 'block';
      }
    }
    
    function createRoom() {
      const code = roomCodeInput.value.trim();
      
      if (!code || code.length !== 4 || isNaN(code)) {
        showNotification('Please enter a valid 4-digit room code');
        return;
      }
      
      roomCode = code;
      
      // Create room in Firebase
      const roomRef = ref(db, `auctionRooms/${roomCode}`);
      set(roomRef, {
        admin: currentUser,
        adminTeam: currentTeam,
        status: 'setup',
        players: {},
        teams: {
          [currentTeam]: {
            budget: budget,
            rtmCards: rtmCards,
            squad: []
          }
        },
        currentPlayer: null,
        currentBid: 0,
        currentBidder: null
      });
      
      showNotification(`Room ${roomCode} created successfully! Share this code with other teams.`);
      
      // Listen for room updates
      setupRoomListeners();
    }
    
    function joinRoom() {
      const code = joinRoomCodeInput.value.trim();
      
      if (!code || code.length !== 4 || isNaN(code)) {
        showNotification('Please enter a valid 4-digit room code');
        return;
      }
      
      roomCode = code;
      
      // Check if room exists
      const roomRef = ref(db, `auctionRooms/${roomCode}`);
      get(roomRef).then((snap) => {
        if (!snap.exists()) {
          showNotification('Room not found. Please check the code.');
          return;
        }
        
        const roomData = snap.val();
        
        if (roomData.status !== 'setup') {
          showNotification('Auction has already started in this room');
          return;
        }
        
        // Join room
        update(ref(db, `auctionRooms/${roomCode}/teams`), {
          [currentTeam]: {
            budget: budget,
            rtmCards: rtmCards,
            squad: []
          }
        });
        
        showNotification(`Joined room ${roomCode} successfully!`);
        
        // Listen for room updates
        setupRoomListeners();
      }).catch(error => {
        console.error('Error joining room:', error);
        showNotification('Failed to join room. Please try again.');
      });
    }
    
    function setupRoomListeners() {
      const roomRef = ref(db, `auctionRooms/${roomCode}`);
      
      onValue(roomRef, (snap) => {
        if (!snap.exists()) {
          showNotification('Room has been closed by admin');
          return;
        }
        
        const roomData = snap.val();
        
        // Update auction status
        if (roomData.status === 'auction') {
          roomSetupSection.classList.remove('active');
          auctionSection.classList.add('active');
          
          if (isAdmin) {
            adminAuctionControls.style.display = 'block';
          } else {
            adminAuctionControls.style.display = 'none';
          }
        }
        
        // Update current player and bid
        if (roomData.currentPlayer) {
          currentPlayerCard.style.display = 'block';
          waitingForAdmin.style.display = 'none';
          
          currentAuctionPlayer = roomData.currentPlayer;
          currentPlayerName.textContent = currentAuctionPlayer.name;
          currentPlayerRole.textContent = currentAuctionPlayer.role;
          currentPlayerRole.className = `role role-${currentAuctionPlayer.role.toLowerCase().replace(' ', '').replace('-', '')}`;
          currentPlayerPrice.textContent = `‚Çπ${currentAuctionPlayer.basePrice} Cr`;
          
          currentBid = roomData.currentBid || 0;
          currentBidder = roomData.currentBidder || null;
          
          currentBidAmount.textContent = `‚Çπ${currentBid} Cr`;
          currentBidTeam.textContent = currentBidder || 'None';
          
          // Start timer if admin
          if (isAdmin && roomData.timerRunning) {
            startTimer();
          }
        } else {
          currentPlayerCard.style.display = 'none';
          waitingForAdmin.style.display = 'block';
        }
        
        // Update auction pool
        if (roomData.players) {
          auctionPlayers = Object.values(roomData.players);
          updateAuctionPoolList();
        }
        
        // Update team info
        if (roomData.teams && roomData.teams[currentTeam]) {
          const teamData = roomData.teams[currentTeam];
          yourBudget.textContent = `‚Çπ${teamData.budget} Cr`;
          yourPlayerCount.textContent = `${teamData.squad ? teamData.squad.length : 0}/25`;
          yourRtmCount.textContent = teamData.rtmCards || 0;
          
          // Update squad list
          yourSquadList.innerHTML = '';
          if (teamData.squad) {
            teamData.squad.forEach(player => {
              const li = document.createElement('li');
              li.textContent = `${player.name} (‚Çπ${player.price} Cr)`;
              yourSquadList.appendChild(li);
            });
          }
        }
      });
    }
    
    function addPlayerToPool() {
      const name = playerNameInput.value.trim();
      const role = playerRoleInput.value;
      
      if (!name) {
        showNotification('Please enter player name');
        return;
      }
      
      const basePrice = role === 'Wicket-Keeper' || role === 'All-Rounder' ? 2 : 1.5;
      
      const playerRef = ref(db, `auctionRooms/${roomCode}/players/${name.toLowerCase().replace(/\s+/g, '_')}`);
      set(playerRef, {
        name: name,
        role: role,
        basePrice: basePrice
      });
      
      playerNameInput.value = '';
      showNotification(`Added ${name} (${role}) to auction pool`);
    }
    
    function bulkAddPlayers() {
      const input = bulkPlayersInput.value.trim();
      
      if (!input) {
        showNotification('Please enter players in CSV format');
        return;
      }
      
      const lines = input.split('\n');
      let addedCount = 0;
      
      lines.forEach(line => {
        const [name, role] = line.split(',').map(item => item.trim());
        
        if (name && role) {
          const validRoles = ['Batter', 'Pacer', 'Spinner', 'All-Rounder', 'Wicket-Keeper'];
          
          if (validRoles.includes(role)) {
            const basePrice = role === 'Wicket-Keeper' || role === 'All-Rounder' ? 2 : 1.5;
            
            const playerRef = ref(db, `auctionRooms/${roomCode}/players/${name.toLowerCase().replace(/\s+/g, '_')}`);
            set(playerRef, {
              name: name,
              role: role,
              basePrice: basePrice
            });
            
            addedCount++;
          }
        }
      });
      
      bulkPlayersInput.value = '';
      showNotification(`Added ${addedCount} players to auction pool`);
    }
    
    function startAuction() {
      // Change room status to auction
      update(ref(db, `auctionRooms/${roomCode}`), {
        status: 'auction'
      });
      
      showNotification('Auction started! Teams can now begin bidding.');
    }
    
    function openPlayerModal() {
      playerSelectionList.innerHTML = '';
      
      const filteredPlayers = filterRole.value === 'All' 
        ? auctionPlayers 
        : auctionPlayers.filter(p => p.role === filterRole.value);
      
      if (filteredPlayers.length === 0) {
        playerSelectionList.innerHTML = '<p>No players available in this category</p>';
        return;
      }
      
      filteredPlayers.forEach(player => {
        const playerItem = document.createElement('div');
        playerItem.className = 'player-item';
        playerItem.dataset.player = JSON.stringify(player);
        
        playerItem.innerHTML = `
          <h3>${player.name}</h3>
          <p>Role: <span class="role role-${player.role.toLowerCase().replace(' ', '').replace('-', '')}">${player.role}</span></p>
          <p>Base Price: ‚Çπ${player.basePrice} Cr</p>
        `;
        
        playerItem.addEventListener('click', () => {
          selectPlayerForAuction(player);
          playerModal.style.display = 'none';
        });
        
        playerSelectionList.appendChild(playerItem);
      });
      
      playerModal.style.display = 'flex';
    }
    
    filterRole.addEventListener('change', openPlayerModal);
    
    function selectPlayerForAuction(player) {
      // Set current player in room
      update(ref(db, `auctionRooms/${roomCode}`), {
        currentPlayer: player,
        currentBid: player.basePrice,
        currentBidder: null,
        timerRunning: true
      });
      
      // Remove player from pool
      const playerRef = ref(db, `auctionRooms/${roomCode}/players/${player.name.toLowerCase().replace(/\s+/g, '_')}`);
      set(playerRef, null);
      
      // Start timer
      startTimer();
    }
    
    function startTimer() {
      clearInterval(timerInterval);
      timeLeft = 30;
      auctionTimer.textContent = timeLeft;
      
      timerInterval = setInterval(() => {
        timeLeft--;
        auctionTimer.textContent = timeLeft;
        
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          autoSellPlayer();
        }
      }, 1000);
    }
    
    function placeBid(increment) {
      if (!currentAuctionPlayer) return;
      
      const newBid = currentBid + increment;
      
      // Check if team has enough budget
      const teamRef = ref(db, `auctionRooms/${roomCode}/teams/${currentTeam}`);
      get(teamRef).then((snap) => {
        if (snap.exists()) {
          const teamData = snap.val();
          
          if (newBid > teamData.budget) {
            showNotification('Not enough budget for this bid');
            return;
          }
          
          // Place bid
          update(ref(db, `auctionRooms/${roomCode}`), {
            currentBid: newBid,
            currentBidder: currentTeam,
            timerRunning: true
          });
          
          // Reset timer
          startTimer();
        }
      });
    }
    
    function passBid() {
      showNotification('You passed on this player');
    }
    
    function useRtm() {
      if (!currentAuctionPlayer || !currentBidder || currentBidder === currentTeam) {
        showNotification('Cannot use RTM now');
        return;
      }
      
      // Check if player was in previous squad
      const userRef = ref(db, `users/${currentUser}`);
      get(userRef).then((snap) => {
        if (snap.exists()) {
          const userData = snap.val();
          const previousPlayers = userData.players || [];
          
          if (!previousPlayers.includes(currentAuctionPlayer.name)) {
            showNotification('This player was not in your previous squad');
            return;
          }
          
          // Check if you have RTM cards
          const roomTeamRef = ref(db, `auctionRooms/${roomCode}/teams/${currentTeam}`);
          get(roomTeamRef).then((teamSnap) => {
            if (teamSnap.exists()) {
              const teamData = teamSnap.val();
              
              if (teamData.rtmCards <= 0) {
                showNotification('No RTM cards remaining');
                return;
              }
              
              // Use RTM
              update(ref(db, `auctionRooms/${roomCode}`), {
                currentBidder: currentTeam,
                timerRunning: false
              });
              
              update(roomTeamRef, {
                rtmCards: teamData.rtmCards - 1
              });
              
              showNotification(`Used RTM card to match ${currentBidder}'s bid of ‚Çπ${currentBid} Cr`);
            }
          });
        }
      });
    }
    
    function autoSellPlayer() {
      if (!currentAuctionPlayer || !currentBidder) {
        // No bids - remove player
        update(ref(db, `auctionRooms/${roomCode}`), {
          currentPlayer: null,
          currentBid: 0,
          currentBidder: null,
          timerRunning: false
        });
        return;
      }
      
      // Add player to winning team's squad
      const teamRef = ref(db, `auctionRooms/${roomCode}/teams/${currentBidder}`);
      get(teamRef).then((snap) => {
        if (snap.exists()) {
          const teamData = snap.val();
          const newSquad = teamData.squad || [];
          
          newSquad.push({
            name: currentAuctionPlayer.name,
            role: currentAuctionPlayer.role,
            price: currentBid
          });
          
          // Update team
          update(teamRef, {
            squad: newSquad,
            budget: teamData.budget - currentBid
          });
          
          // Clear current player
          update(ref(db, `auctionRooms/${roomCode}`), {
            currentPlayer: null,
            currentBid: 0,
            currentBidder: null,
            timerRunning: false
          });
          
          showNotification(`${currentAuctionPlayer.name} sold to ${currentBidder} for ‚Çπ${currentBid} Cr`);
        }
      });
    }
    
    function sellPlayer() {
      if (!currentAuctionPlayer || !currentBidder) {
        showNotification('No bid to sell');
        return;
      }
      
      autoSellPlayer();
    }
    
    function updateAuctionPoolList() {
      auctionPoolList.innerHTML = '';
      
      auctionPlayers.forEach(player => {
        const li = document.createElement('li');
        li.innerHTML = `${player.name} (<span class="role role-${player.role.toLowerCase().replace(' ', '').replace('-', '')}">${player.role}</span>) - ‚Çπ${player.basePrice} Cr`;
        auctionPoolList.appendChild(li);
      });
    }
    
    function showNotification(message) {
      notification.textContent = message;
      notification.style.display = 'block';
      
      setTimeout(() => {
        notification.style.display = 'none';
      }, 3000);
    }
  </script>
</body>
</html>