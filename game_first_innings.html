<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HandiCricket - First Innings</title>
  <style>
    :root {
      --primary: #1e88e5;
      --secondary: #1565c0;
      --accent: #ffeb3b;
      --danger: #f44336;
      --success: #4CAF50;
      --warning: #FF9800;
      --dark: #061e3e;
      --light: #f5f5f5;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(rgba(6, 30, 62, 0.9), rgba(6, 30, 62, 0.9)), 
                  url('https://images.unsplash.com/photo-1540747913346-19e32dc3e97e?ixlib=rb-1.2.1&auto=format&fit=crop&w=1200&q=80');
      background-size: cover;
      background-position: center;
      color: white;
      min-height: 100vh;
      padding: 20px;
      overflow-x: hidden;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .match-info {
      text-align: center;
      margin-bottom: 20px;
    }
    
    .scoreboard {
      display: flex;
      justify-content: space-between;
      background: rgba(13, 42, 82, 0.7);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
    }
    
    .score-section {
      flex: 1;
    }
    
    .score {
      font-size: 28px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .team-name {
      font-weight: bold;
      color: var(--accent);
    }
    
    .stats-section {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }
    
    .stat-item {
      margin-bottom: 5px;
    }
    
    .over-progress {
      display: flex;
      margin-bottom: 15px;
    }
    
    .balls-container {
      display: flex;
    }
    
    .ball {
      width: 25px;
      height: 25px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      margin-right: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
    }
    
    .ball.dot {
      background: var(--primary);
    }
    
    .ball.run {
      background: var(--success);
    }
    
    .ball.wicket {
      background: var(--danger);
    }
    
    .ball.wide {
      background: var(--warning);
    }
    
    .ball.noball {
      background: var(--accent);
      color: #000;
    }
    
    .over-number {
      margin-left: 10px;
      font-weight: bold;
    }
    
    .match-details {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
      font-size: 14px;
    }
    
    .player-battle {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
    }
    
    .player-card {
      flex: 1;
      background: rgba(30, 136, 229, 0.2);
      border-radius: 8px;
      padding: 10px;
      margin: 0 5px;
    }
    
    .player-name {
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .player-stats {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
    }
    
    .wicket-bar {
      height: 5px;
      background: rgba(255, 255, 255, 0.2);
      margin: 5px 0;
      border-radius: 3px;
      overflow: hidden;
    }
    
    .wicket-progress {
      height: 100%;
      background: var(--danger);
      width: 0%;
      transition: width 0.3s;
    }
    
    .dots-counter {
      font-size: 12px;
      color: #aaa;
      margin-top: 3px;
    }
    
    .dots-counter.warning {
      color: var(--warning);
    }
    
    .dots-counter.danger {
      color: var(--danger);
    }
    
    .game-controls {
      margin-top: 20px;
    }
    
    .card-buttons {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }
    
    .card-btn {
      width: 50px;
      height: 70px;
      margin: 5px;
      border: none;
      border-radius: 8px;
      background: rgba(30, 136, 229, 0.8);
      color: white;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    }
    
    .card-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 10px rgba(0, 0, 0, 0.3);
    }
    
    .card-btn:active {
      transform: translateY(1px);
    }
    
    .card-btn.selected {
      background: var(--accent);
      color: #000;
      transform: translateY(-5px);
      box-shadow: 0 8px 12px rgba(0, 0, 0, 0.3);
    }
    
    .card-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .result-display {
      text-align: center;
      margin: 10px 0;
      min-height: 24px;
      font-weight: bold;
    }
    
    .status-indicators {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .status-indicator {
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .status-indicator.powerplay {
      background: rgba(255, 235, 59, 0.2);
      border: 1px solid var(--accent);
    }
    
    .status-indicator.dead-over {
      background: rgba(244, 67, 54, 0.2);
      border: 1px solid var(--danger);
    }
    
    .status-indicator.freehit {
      background: rgba(76, 175, 80, 0.2);
      border: 1px solid var(--success);
    }
    
    .action-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }
    
    .action-btn {
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      background: var(--primary);
      color: white;
      font-weight: bold;
      cursor: pointer;
      font-size: 14px;
    }
    
    .action-btn:hover {
      background: var(--secondary);
    }
    
    .action-btn.secondary {
      background: rgba(255, 255, 255, 0.1);
    }
    
    .action-btn.danger {
      background: var(--danger);
    }
    
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }
    
    .modal.active {
      opacity: 1;
      pointer-events: all;
    }
    
    .modal-content {
      background: var(--dark);
      border-radius: 10px;
      padding: 20px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      border: 1px solid var(--primary);
    }
    
    .modal-title {
      font-size: 20px;
      margin-bottom: 15px;
      color: var(--accent);
      text-align: center;
    }
    
    .player-list {
      list-style: none;
    }
    
    .player-item {
      padding: 10px;
      margin: 5px 0;
      background: rgba(30, 136, 229, 0.2);
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .player-item:hover {
      background: rgba(30, 136, 229, 0.4);
    }
    
    .player-item.selected {
      background: var(--accent);
      color: #000;
    }
    
    .player-item.out {
      opacity: 0.5;
      text-decoration: line-through;
    }
    
    .close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
    }
    
    .stumps {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 200;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }
    
    .stumps.active {
      opacity: 1;
    }
    
    .stump {
      position: absolute;
      width: 20px;
      height: 80px;
      background: linear-gradient(to bottom, #8B4513, #A0522D);
      bottom: 0;
    }
    
    .stump-1 {
      left: -30px;
      transform: rotate(-15deg);
      animation: fall-left 1s forwards;
    }
    
    .stump-2 {
      left: 0;
      animation: fall-middle 1s forwards;
    }
    
    .stump-3 {
      left: 30px;
      transform: rotate(15deg);
      animation: fall-right 1s forwards;
    }
    
    .bail {
      position: absolute;
      width: 40px;
      height: 10px;
      background: #fff;
      top: -10px;
      left: -20px;
      animation: bail-fly 1s forwards;
    }
    
    @keyframes fall-left {
      0% { transform: rotate(-15deg); }
      100% { transform: rotate(-70deg) translateY(20px); }
    }
    
    @keyframes fall-middle {
      0% { transform: rotate(0); }
      100% { transform: rotate(-10deg) translateY(20px); }
    }
    
    @keyframes fall-right {
      0% { transform: rotate(15deg); }
      100% { transform: rotate(70deg) translateY(20px); }
    }
    
    @keyframes bail-fly {
      0% { transform: translate(0, 0); }
      100% { transform: translate(30px, -50px) rotate(360deg); }
    }
    
    .shake {
      animation: shake 0.5s;
    }
    
    @keyframes shake {
      0% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      50% { transform: translateX(10px); }
      75% { transform: translateX(-10px); }
      100% { transform: translateX(0); }
    }
    
    .confetti {
      position: fixed;
      width: 10px;
      height: 10px;
      background: var(--accent);
      opacity: 0;
      z-index: 200;
    }
    
    .team-modal {
      display: flex;
      flex-direction: column;
    }
    
    .team-slider {
      display: flex;
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      margin-bottom: 15px;
    }
    
    .team-slide {
      min-width: 100%;
      scroll-snap-align: start;
      padding: 10px;
    }
    
    .team-title {
      text-align: center;
      margin-bottom: 10px;
      color: var(--accent);
    }
    
    .team-players {
      list-style: none;
    }
    
    .team-player {
      padding: 8px;
      margin: 5px 0;
      background: rgba(30, 136, 229, 0.2);
      border-radius: 5px;
    }
    
    .stats-table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
      font-size: 14px;
    }
    
    .stats-table th {
      background: rgba(30, 136, 229, 0.5);
      padding: 8px;
      text-align: left;
    }
    
    .stats-table td {
      padding: 8px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .stats-table tr:nth-child(even) {
      background: rgba(30, 136, 229, 0.1);
    }
    
    .stats-container {
      margin-top: 20px;
    }
    
    .stats-section-title {
      color: var(--accent);
      margin: 15px 0 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding-bottom: 5px;
    }
    
    .next-innings-btn {
      display: block;
      width: 100%;
      padding: 12px;
      background: var(--success);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 20px;
      text-align: center;
      transition: all 0.3s;
    }
    
    .next-innings-btn:hover {
      background: #388e3c;
    }
    
    .next-innings-btn:disabled {
      background: rgba(76, 175, 80, 0.5);
      cursor: not-allowed;
    }
    
    .target-info {
      background: rgba(255, 235, 59, 0.1);
      border-radius: 8px;
      padding: 10px;
      margin: 10px 0;
      text-align: center;
    }
    
    .target-value {
      font-size: 18px;
      font-weight: bold;
      color: var(--accent);
    }
    
    /* New styles for additional match info */
    .match-extra-info {
      display: flex;
      justify-content: space-between;
      margin: 15px 0;
      font-size: 14px;
    }
    
    .match-timeline {
      background: rgba(13, 42, 82, 0.7);
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 15px;
    }
    
    .timeline-item {
      padding: 5px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .timeline-item:last-child {
      border-bottom: none;
    }
    
    .partnership-info {
      background: rgba(30, 136, 229, 0.2);
      border-radius: 8px;
      padding: 10px;
      margin: 10px 0;
      text-align: center;
    }
    
    .recent-overs {
      background: rgba(76, 175, 80, 0.2);
      border-radius: 8px;
      padding: 10px;
      margin: 10px 0;
      text-align: center;
    }
    
    .player-role-indicator {
      position: absolute;
      top: 5px;
      right: 5px;
      font-size: 10px;
      background: var(--accent);
      color: #000;
      padding: 2px 5px;
      border-radius: 10px;
    }
    
    .player-card {
      position: relative;
    }
    
    .battle-stats {
      display: flex;
      justify-content: space-between;
      margin: 10px 0;
    }
    
    .battle-stat {
      flex: 1;
      text-align: center;
      padding: 5px;
      background: rgba(30, 136, 229, 0.2);
      border-radius: 5px;
      margin: 0 3px;
    }
    
    .battle-stat-title {
      font-size: 12px;
      color: #aaa;
    }
    
    .battle-stat-value {
      font-weight: bold;
    }
    
    .opponent-status {
      text-align: right;
      font-size: 12px;
      color: #4CAF50;
      margin-top: 5px;
    }
    
    @media (max-width: 600px) {
      .card-btn {
        width: 40px;
        height: 60px;
        font-size: 20px;
        margin: 3px;
      }
      
      .score {
        font-size: 24px;
      }
      
      .player-card {
        padding: 8px;
      }
      
      .ball {
        width: 20px;
        height: 20px;
        font-size: 10px;
      }
      
      .action-btn {
        padding: 6px 12px;
        font-size: 12px;
      }
      
      .battle-stats {
        flex-wrap: wrap;
      }
      
      .battle-stat {
        flex: 0 0 calc(50% - 6px);
        margin-bottom: 5px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="room-code">Room: <span id="roomCode"></span></div>
      <div class="format">Format: <span id="formatDisplay"></span></div>
      <button class="action-btn secondary" id="teamsBtn">View Teams</button>
    </div>
    
    <div class="match-info">
      <h2 id="inningsTitle">First Innings</h2>
      <div id="matchStatus"></div>
    </div>
    
    <div class="scoreboard">
      <div class="score-section">
        <div class="team-name" id="battingTeam"></div>
        <div class="score" id="scoreDisplay">0/0</div>
      </div>
      <div class="stats-section">
        <div class="stat-item">Overs: <span id="oversDisplay">0.0</span></div>
        <div class="stat-item">Run Rate: <span id="runRate">0.00</span></div>
        <div class="stat-item" id="targetDisplay"></div>
      </div>
    </div>
    
    <div class="match-extra-info">
      <div id="matchTime"></div>
      <div id="playerRoleIndicator"></div>
    </div>
    
    <div class="over-progress">
      <div class="balls-container" id="ballsContainer"></div>
      <div class="over-number" id="overNumber">Over 0</div>
    </div>
    
    <div class="match-timeline">
      <div class="timeline-item" id="currentBattle">
        <strong>Current Battle:</strong> <span id="battleInfo">Select players to start</span>
      </div>
      <div class="timeline-item" id="lastEvent">
        <strong>Last Event:</strong> <span id="lastEventInfo">-</span>
      </div>
    </div>
    
    <div class="partnership-info">
      <div><strong>PARTNERSHIP</strong></div>
      <div><span id="partnershipRuns">0</span> runs (<span id="partnershipBalls">0</span> balls)</div>
    </div>
    
    <div class="recent-overs">
      <div><strong>LAST 5 OVERS</strong></div>
      <div><span id="recentRuns">0</span> / <span id="recentWickets">0</span> (RR: <span id="recentRR">0.00</span>)</div>
    </div>
    
    <div class="player-battle">
      <div class="player-card">
        <div class="player-role-indicator" id="batterRoleIndicator">BAT</div>
        <div class="player-name" id="batterName">-</div>
        <div class="player-stats">
          <span class="player-runs" id="batterRuns">0</span>
          <span class="player-balls" id="batterBalls">(0)</span>
          <span class="player-sr" id="batterSR">SR: 0.00</span>
        </div>
        <div class="wicket-bar">
          <div class="wicket-progress" id="batterWickets"></div>
        </div>
        <div class="dots-counter" id="batterDotsCounter">Dots: 0/3</div>
      </div>
      
      <div class="player-card">
        <div class="player-role-indicator" id="bowlerRoleIndicator">BOWL</div>
        <div class="player-name" id="bowlerName">-</div>
        <div class="player-stats">
          <span id="bowlerOvers">0.0</span>
          <span id="bowlerFigures">0/0</span>
          <span id="bowlerER">ER: 0.00</span>
        </div>
        <div class="dots-counter" id="bowlerDotsCounter">Dots: 0/3</div>
      </div>
    </div>
    
    <div class="battle-stats">
      <div class="battle-stat">
        <div class="battle-stat-title">Runs</div>
        <div class="battle-stat-value" id="battleRuns">0</div>
      </div>
      <div class="battle-stat">
        <div class="battle-stat-title">Balls</div>
        <div class="battle-stat-value" id="battleBalls">0</div>
      </div>
      <div class="battle-stat">
        <div class="battle-stat-title">4s</div>
        <div class="battle-stat-value" id="battleFours">0</div>
      </div>
      <div class="battle-stat">
        <div class="battle-stat-title">6s</div>
        <div class="battle-stat-value" id="battleSixes">0</div>
      </div>
      <div class="battle-stat">
        <div class="battle-stat-title">Extras</div>
        <div class="battle-stat-value" id="battleExtras">0</div>
      </div>
    </div>
    
    <div class="game-controls">
      <div class="status-indicators" id="statusIndicators"></div>
      
      <div class="result-display" id="resultDisplay"></div>
      
      <div class="card-buttons" id="cardButtons">
        <button class="card-btn" data-value="0">0</button>
        <button class="card-btn" data-value="1">1</button>
        <button class="card-btn" data-value="2">2</button>
        <button class="card-btn" data-value="3">3</button>
        <button class="card-btn" data-value="4">4</button>
        <button class="card-btn" data-value="5">5</button>
        <button class="card-btn" data-value="6">6</button>
      </div>
      
      <div class="action-buttons">
        <button class="action-btn" id="nextBatterBtn" style="display: none;">Next Batter</button>
        <button class="action-btn" id="nextBowlerBtn" style="display: none;">Next Bowler</button>
        <button class="action-btn secondary" id="resetBtn">Reset Play</button>
        <button class="action-btn secondary" id="timeoutBtn">Timeout</button>
        <button class="action-btn secondary" id="saveBtn">Save Game</button>
        <button class="action-btn danger" id="leaveBtn">Leave Game</button>
      </div>
    </div>
    
    <div class="target-info" id="targetInfo" style="display: none;">
      <div>Target: <span class="target-value" id="targetValue">0</span></div>
      <div>Required: <span id="requiredRuns">0</span> runs in <span id="remainingBalls">0</span> balls</div>
      <div>Req. RR: <span id="requiredRR">0.00</span></div>
    </div>
    
    <div class="opponent-status" id="opponentStatus">Opponent: Online</div>
  </div>
  
  <!-- Modals -->
  <div class="modal" id="batterModal">
    <div class="modal-content">
      <button class="close-btn" id="closeBatterModal">&times;</button>
      <h3 class="modal-title">Select Batter</h3>
      <ul class="player-list" id="batterList"></ul>
    </div>
  </div>
  
  <div class="modal" id="bowlerModal">
    <div class="modal-content">
      <button class="close-btn" id="closeBowlerModal">&times;</button>
      <h3 class="modal-title">Select Bowler</h3>
      <ul class="player-list" id="bowlerList"></ul>
    </div>
  </div>
  
  <div class="modal" id="teamsModal">
    <div class="modal-content">
      <button class="close-btn" id="closeTeamsModal">&times;</button>
      <h3 class="modal-title">Teams</h3>
      <div class="team-modal">
        <div class="team-slider">
          <div class="team-slide">
            <h4 class="team-title" id="team1ModalTitle"></h4>
            <ul class="team-players" id="team1Players"></ul>
          </div>
          <div class="team-slide">
            <h4 class="team-title" id="team2ModalTitle"></h4>
            <ul class="team-players" id="team2Players"></ul>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="modal" id="statsModal">
    <div class="modal-content">
      <button class="close-btn" id="closeStatsModal">&times;</button>
      <h3 class="modal-title" id="statsModalTitle">Innings Statistics</h3>
      <div class="stats-container" id="statsContainer"></div>
      <button class="next-innings-btn" id="nextInningsBtn" disabled>Start Second Innings</button>
    </div>
  </div>
  
  <div class="modal" id="matchResultModal">
    <div class="modal-content">
      <button class="close-btn" id="closeMatchResultModal">&times;</button>
      <h3 class="modal-title" id="matchResultTitle">Match Result</h3>
      <div id="matchResultContent"></div>
      <button class="next-innings-btn" id="saveMatchBtn">Save Match Data</button>
    </div>
  </div>
  
  <!-- Animation elements -->
  <div class="stumps" id="stumpsAnimation">
    <div class="stump stump-1"></div>
    <div class="stump stump-2">
      <div class="bail"></div>
    </div>
    <div class="stump stump-3"></div>
  </div>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getDatabase, ref, onValue, update, get, set, push } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCN6aZMwlsZe7JJaovU0WA3UQygWr4jYmA",
      authDomain: "handicricket-85a06.firebaseapp.com",
      projectId: "handicricket-85a06",
      storageBucket: "handicricket-85a06.appspot.com",
      messagingSenderId: "599182538558",
      appId: "1:599182538558:web:3e965753ab05f8f1e3de6f",
      measurementId: "G-HSV9H4LEJQ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Get URL parameters
    const params = new URLSearchParams(window.location.search);
    const roomId = params.get('room');
    const playerRole = params.get('player');
    const isSpectator = playerRole === 'spectator';
    
    if (!roomId || (!playerRole && !isSpectator)) {
      alert('Invalid room or player');
      window.location.href = 'index.html';
    }

    // Firebase references
    const roomRef = ref(db, `rooms/${roomId}`);
    const gameRef = ref(db, `rooms/${roomId}/game`);
    const playerRef = ref(db, `rooms/${roomId}/${playerRole}`);
    const opponentRef = ref(db, `rooms/${roomId}/${playerRole === 'player1' ? 'player2' : 'player1'}`);
    const tossRef = ref(db, `rooms/${roomId}/toss`);
    const teamsRef = ref(db, `rooms/${roomId}/teams`);
    const matchDataRef = ref(db, `savedMatches`);

    // DOM elements
    const roomCodeEl = document.getElementById('roomCode');
    const formatDisplayEl = document.getElementById('formatDisplay');
    const inningsTitleEl = document.getElementById('inningsTitle');
    const matchStatusEl = document.getElementById('matchStatus');
    const battingTeamEl = document.getElementById('battingTeam');
    const bowlingTeamEl = document.getElementById('bowlingTeam');
    const scoreDisplayEl = document.getElementById('scoreDisplay');
    const oversDisplayEl = document.getElementById('oversDisplay');
    const runRateEl = document.getElementById('runRate');
    const targetDisplayEl = document.getElementById('targetDisplay');
    const ballsContainerEl = document.getElementById('ballsContainer');
    const overNumberEl = document.getElementById('overNumber');
    const matchFormatEl = document.getElementById('matchFormat');
    const currentTimeEl = document.getElementById('currentTime');
    const batterNameEl = document.getElementById('batterName');
    const batterRunsEl = document.getElementById('batterRuns');
    const batterBallsEl = document.getElementById('batterBalls');
    const batterSREl = document.getElementById('batterSR');
    const batterWicketsEl = document.getElementById('batterWickets');
    const batterDotsCounterEl = document.getElementById('batterDotsCounter');
    const bowlerNameEl = document.getElementById('bowlerName');
    const bowlerOversEl = document.getElementById('bowlerOvers');
    const bowlerFiguresEl = document.getElementById('bowlerFigures');
    const bowlerEREl = document.getElementById('bowlerER');
    const bowlerDotsCounterEl = document.getElementById('bowlerDotsCounter');
    const resultDisplayEl = document.getElementById('resultDisplay');
    const statusIndicatorsEl = document.getElementById('statusIndicators');
    const cardButtonsEl = document.getElementById('cardButtons');
    const nextBatterBtn = document.getElementById('nextBatterBtn');
    const nextBowlerBtn = document.getElementById('nextBowlerBtn');
    const resetBtn = document.getElementById('resetBtn');
    const timeoutBtn = document.getElementById('timeoutBtn');
    const saveBtn = document.getElementById('saveBtn');
    const leaveBtn = document.getElementById('leaveBtn');
    const targetInfoEl = document.getElementById('targetInfo');
    const targetValueEl = document.getElementById('targetValue');
    const requiredRunsEl = document.getElementById('requiredRuns');
    const remainingBallsEl = document.getElementById('remainingBalls');
    const requiredRREl = document.getElementById('requiredRR');
    
    // New DOM elements for additional info
    const playerRoleIndicatorEl = document.getElementById('playerRoleIndicator');
    const matchTimeEl = document.getElementById('matchTime');
    const battleInfoEl = document.getElementById('battleInfo');
    const lastEventInfoEl = document.getElementById('lastEventInfo');
    const partnershipRunsEl = document.getElementById('partnershipRuns');
    const partnershipBallsEl = document.getElementById('partnershipBalls');
    const recentRunsEl = document.getElementById('recentRuns');
    const recentWicketsEl = document.getElementById('recentWickets');
    const recentRREl = document.getElementById('recentRR');
    const batterRoleIndicatorEl = document.getElementById('batterRoleIndicator');
    const bowlerRoleIndicatorEl = document.getElementById('bowlerRoleIndicator');
    const battleRunsEl = document.getElementById('battleRuns');
    const battleBallsEl = document.getElementById('battleBalls');
    const battleFoursEl = document.getElementById('battleFours');
    const battleSixesEl = document.getElementById('battleSixes');
    const battleExtrasEl = document.getElementById('battleExtras');
    const opponentStatusEl = document.getElementById('opponentStatus');
    
    // Modal elements
    const batterModal = document.getElementById('batterModal');
    const bowlerModal = document.getElementById('bowlerModal');
    const teamsModal = document.getElementById('teamsModal');
    const statsModal = document.getElementById('statsModal');
    const matchResultModal = document.getElementById('matchResultModal');
    const batterListEl = document.getElementById('batterList');
    const bowlerListEl = document.getElementById('bowlerList');
    const team1ModalTitle = document.getElementById('team1ModalTitle');
    const team2ModalTitle = document.getElementById('team2ModalTitle');
    const team1PlayersEl = document.getElementById('team1Players');
    const team2PlayersEl = document.getElementById('team2Players');
    const statsModalTitle = document.getElementById('statsModalTitle');
    const statsContainerEl = document.getElementById('statsContainer');
    const nextInningsBtn = document.getElementById('nextInningsBtn');
    const matchResultTitle = document.getElementById('matchResultTitle');
    const matchResultContent = document.getElementById('matchResultContent');
    const saveMatchBtn = document.getElementById('saveMatchBtn');
    
    // Close buttons
    document.getElementById('closeBatterModal').addEventListener('click', () => batterModal.classList.remove('active'));
    document.getElementById('closeBowlerModal').addEventListener('click', () => bowlerModal.classList.remove('active'));
    document.getElementById('closeTeamsModal').addEventListener('click', () => teamsModal.classList.remove('active'));
    document.getElementById('closeStatsModal').addEventListener('click', () => statsModal.classList.remove('active'));
    document.getElementById('closeMatchResultModal').addEventListener('click', () => matchResultModal.classList.remove('active'));
    
    // Animation elements
    const stumpsAnimation = document.getElementById('stumpsAnimation');
    const containerEl = document.querySelector('.container');

    // Game state
    let gameState = {
      battingTeam: '',
      bowlingTeam: '',
      currentBatter: '',
      currentBowler: '',
      batters: [],
      bowlers: [],
      score: 0,
      wickets: 0,
      balls: 0,
      overs: 0,
      thisOver: [],
      innings: 1,
      format: '5',
      powerplay: false,
      deadOver: false,
      freeHit: false,
      batterDots: 0,
      bowlerDots: 0,
      target: 0,
      toss: {},
      teams: {},
      gameStarted: false,
      currentPlayer: null,
      selectedCard: null,
      isBatting: false,
      isBowling: false,
      commentary: [],
      matchId: null,
      playerOfMatch: null,
      matchResult: null,
      winner: null,
      winningMargin: null,
      partnershipRuns: 0,
      partnershipBalls: 0,
      recentOvers: [],
      battleRuns: 0,
      battleBalls: 0,
      battleFours: 0,
      battleSixes: 0,
      battleExtras: 0,
      lastEvent: null
    };

    // Initialize game
    function initGame() {
      roomCodeEl.textContent = roomId;
      
      // Set player online status
      if (!isSpectator) {
        set(playerRef, {
          connected: true,
          ready: false,
          card: null
        });
      }
      
      // Set current time
      updateTime();
      setInterval(updateTime, 60000);
      
      // Load room data
      onValue(roomRef, (snap) => {
        if (snap.exists()) {
          const room = snap.val();
          
          // Set format
          gameState.format = room.player1?.format || '5';
          formatDisplayEl.textContent = getFormatName(gameState.format);
          matchFormatEl.textContent = `${getFormatName(gameState.format)} Match`;
          
          // Set teams
          gameState.battingTeam = room.toss?.battingFirst === 'player1' ? 
            room.player1?.team : room.player2?.team;
          gameState.bowlingTeam = room.toss?.battingFirst === 'player1' ? 
            room.player2?.team : room.player1?.team;
            
          battingTeamEl.textContent = gameState.battingTeam;
          bowlingTeamEl.textContent = gameState.bowlingTeam;
          
          // Set toss data
          gameState.toss = room.toss || {};
          
          // Set teams data
          if (room.teams) {
            gameState.teams = room.teams;
            updateTeamsModal();
          }
          
          // Check if game started
          gameState.gameStarted = room.gameStarted || false;
          
          // Set player roles
          if (playerRole === 'player1' || playerRole === 'player2') {
            gameState.isBatting = (playerRole === 'player1' && gameState.toss.battingFirst === 'player1') || 
                                 (playerRole === 'player2' && gameState.toss.battingFirst === 'player2');
            gameState.isBowling = !gameState.isBatting;
            
            // Update role indicator
            playerRoleIndicatorEl.textContent = gameState.isBatting ? 'You are Batting' : 'You are Bowling';
          }
          
          // Show player selection modals if needed
          if (!isSpectator && gameState.gameStarted) {
            checkPlayerSelection();
          }
        }
      });
      
      // Load game data
      onValue(gameRef, (snap) => {
        if (snap.exists()) {
          const game = snap.val();
          
          // Update game state
          gameState.score = game.score || 0;
          gameState.wickets = game.wickets || 0;
          gameState.balls = game.balls || 0;
          gameState.overs = Math.floor(gameState.balls / 6);
          gameState.thisOver = game.thisOver || [];
          gameState.innings = game.innings || 1;
          gameState.currentBatter = game.currentBatter || '';
          gameState.currentBowler = game.currentBowler || '';
          gameState.batters = game.batters || [];
          gameState.bowlers = game.bowlers || [];
          gameState.powerplay = game.powerplay || false;
          gameState.deadOver = game.deadOver || false;
          gameState.freeHit = game.freeHit || false;
          gameState.batterDots = game.batterDots || 0;
          gameState.bowlerDots = game.bowlerDots || 0;
          gameState.target = game.target || 0;
          gameState.commentary = game.commentary || [];
          gameState.matchId = game.matchId || null;
          gameState.playerOfMatch = game.playerOfMatch || null;
          gameState.matchResult = game.matchResult || null;
          gameState.winner = game.winner || null;
          gameState.winningMargin = game.winningMargin || null;
          gameState.partnershipRuns = game.partnershipRuns || 0;
          gameState.partnershipBalls = game.partnershipBalls || 0;
          gameState.recentOvers = game.recentOvers || [];
          gameState.battleRuns = game.battleRuns || 0;
          gameState.battleBalls = game.battleBalls || 0;
          gameState.battleFours = game.battleFours || 0;
          gameState.battleSixes = game.battleSixes || 0;
          gameState.battleExtras = game.battleExtras || 0;
          gameState.lastEvent = game.lastEvent || null;
          
          // Update UI
          updateScoreboard();
          updateOverProgress();
          updateStatusIndicator();
          updatePlayerInfo();
          updateCommentary();
          updateAdditionalInfo();
          
          // Check if we need to select players
          if (!isSpectator) {
            checkPlayerSelection();
          }
          
          // Check if innings is complete
          checkInningsComplete();
          
          // Check if match is complete
          checkMatchComplete();
        }
      });
      
      // Handle opponent disconnect
      if (!isSpectator) {
        onValue(opponentRef, (snap) => {
          if (!snap.exists() || !snap.val()?.connected) {
            opponentStatusEl.textContent = 'Opponent: Offline';
            opponentStatusEl.style.color = '#f44336';
          } else {
            opponentStatusEl.textContent = 'Opponent: Online';
            opponentStatusEl.style.color = '#4CAF50';
          }
        });
      }
      
      // Set up card buttons
      setupCardButtons();
      
      // Set up action buttons
      setupActionButtons();
      
      // Show player selection modals if needed
      setTimeout(() => {
        if (!isSpectator && gameState.gameStarted) {
          checkPlayerSelection();
        }
      }, 1000);
    }
    
    // Update current time
    function updateTime() {
      const now = new Date();
      currentTimeEl.textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      matchTimeEl.textContent = `${now.toLocaleDateString()} ${now.toLocaleTimeString()}`;
    }
    
    // Get format name
    function getFormatName(format) {
      const formats = {
        '5': 'T5 (5 Overs)',
        '10': 'T10 (10 Overs)',
        '20': 'T20 (20 Overs)',
        '50': 'ODI (50 Overs)',
        'test': 'Test Match'
      };
      return formats[format] || format;
    }
    
    // Update scoreboard
    function updateScoreboard() {
      scoreDisplayEl.textContent = `${gameState.score}/${gameState.wickets}`;
      oversDisplayEl.textContent = `${gameState.overs}.${gameState.balls % 6}`;
      
      // Calculate run rate
      const overs = gameState.overs + (gameState.balls % 6) / 6;
      const runRate = overs > 0 ? (gameState.score / overs).toFixed(2) : '0.00';
      runRateEl.textContent = runRate;
      
      // Show target in second innings
      if (gameState.innings === 2) {
        targetDisplayEl.textContent = `Target: ${gameState.target}`;
        targetInfoEl.style.display = 'block';
        targetValueEl.textContent = gameState.target;
        
        const remainingRuns = gameState.target - gameState.score - 1;
        const remainingBalls = getTotalBalls() - gameState.balls;
        const requiredRR = remainingRuns > 0 ? (remainingRuns / (remainingBalls / 6)).toFixed(2) : '0.00';
        
        requiredRunsEl.textContent = remainingRuns > 0 ? remainingRuns : 0;
        remainingBallsEl.textContent = remainingBalls;
        requiredRREl.textContent = requiredRR;
      } else {
        targetDisplayEl.textContent = '';
        targetInfoEl.style.display = 'none';
      }
      
      // Update innings title
      inningsTitleEl.textContent = gameState.innings === 1 ? 'First Innings' : 'Second Innings';
    }
    
    // Update additional match info
    function updateAdditionalInfo() {
      // Update partnership info
      partnershipRunsEl.textContent = gameState.partnershipRuns;
      partnershipBallsEl.textContent = gameState.partnershipBalls;
      
      // Update recent overs
      const recentRuns = gameState.recentOvers.reduce((sum, over) => sum + over.runs, 0);
      const recentWickets = gameState.recentOvers.reduce((sum, over) => sum + over.wickets, 0);
      const recentRR = gameState.recentOvers.length > 0 ? 
        (recentRuns / gameState.recentOvers.length).toFixed(2) : '0.00';
      
      recentRunsEl.textContent = recentRuns;
      recentWicketsEl.textContent = recentWickets;
      recentRREl.textContent = recentRR;
      
      // Update battle stats
      battleRunsEl.textContent = gameState.battleRuns;
      battleBallsEl.textContent = gameState.battleBalls;
      battleFoursEl.textContent = gameState.battleFours;
      battleSixesEl.textContent = gameState.battleSixes;
      battleExtrasEl.textContent = gameState.battleExtras;
      
      // Update current battle info
      if (gameState.currentBatter && gameState.currentBowler) {
        battleInfoEl.textContent = `${gameState.currentBatter} vs ${gameState.currentBowler}`;
      } else {
        battleInfoEl.textContent = 'Select players to start';
      }
      
      // Update last event
      if (gameState.lastEvent) {
        lastEventInfoEl.textContent = gameState.lastEvent;
      } else {
        lastEventInfoEl.textContent = '-';
      }
    }
    
    // Get total balls based on format
    function getTotalBalls() {
      switch(gameState.format) {
        case '5': return 30;
        case '10': return 60;
        case '20': return 120;
        case '50': return 300;
        case 'test': return Infinity;
        default: return 30;
      }
    }
    
    // Update over progress
    function updateOverProgress() {
      ballsContainerEl.innerHTML = '';
      
      // Add balls for completed overs
      for (let i = 0; i < gameState.overs; i++) {
        for (let j = 0; j < 6; j++) {
          const ball = document.createElement('div');
          ball.className = 'ball';
          ball.textContent = '•';
          ballsContainerEl.appendChild(ball);
        }
      }
      
      // Add balls for current over
      for (let i = 0; i < gameState.thisOver.length; i++) {
        const ball = document.createElement('div');
        const ballEvent = gameState.thisOver[i];
        
        if (ballEvent.type === 'wicket') {
          ball.className = 'ball wicket';
          ball.textContent = 'W';
        } else if (ballEvent.type === 'wide' || ballEvent.type === 'noball') {
          ball.className = ballEvent.type === 'wide' ? 'ball wide' : 'ball noball';
          ball.textContent = ballEvent.type === 'wide' ? 'Wd' : 'Nb';
        } else {
          ball.className = ballEvent.runs === 0 ? 'ball dot' : 'ball run';
          ball.textContent = ballEvent.runs > 0 ? ballEvent.runs : '•';
        }
        
        ballsContainerEl.appendChild(ball);
      }
      
      // Update over number
      overNumberEl.textContent = `Over ${gameState.overs + 1}`;
    }
    
    // Update status indicator
    function updateStatusIndicator() {
      statusIndicatorsEl.innerHTML = '';
      
      if (gameState.powerplay) {
        const indicator = document.createElement('div');
        indicator.className = 'status-indicator powerplay';
        indicator.textContent = 'Powerplay';
        statusIndicatorsEl.appendChild(indicator);
      }
      
      if (gameState.deadOver) {
        const indicator = document.createElement('div');
        indicator.className = 'status-indicator dead-over';
        indicator.textContent = 'Dead Over';
        statusIndicatorsEl.appendChild(indicator);
      }
      
      if (gameState.freeHit) {
        const indicator = document.createElement('div');
        indicator.className = 'status-indicator freehit';
        indicator.textContent = 'Free Hit';
        statusIndicatorsEl.appendChild(indicator);
      }
    }
    
    // Update player info
    function updatePlayerInfo() {
      if (gameState.currentBatter) {
        const batter = gameState.batters.find(b => b.name === gameState.currentBatter);
        if (batter) {
          batterNameEl.textContent = batter.name;
          batterRunsEl.textContent = batter.runs;
          batterBallsEl.textContent = `(${batter.balls})`;
          batterSREl.textContent = `SR: ${batter.balls > 0 ? ((batter.runs / batter.balls) * 100).toFixed(2) : '0.00'}`;
          batterWicketsEl.style.width = `${batter.wickets * 100}%`;
          
          // Update dots counter
          batterDotsCounterEl.textContent = `Dots: ${batter.dots}/3`;
          batterDotsCounterEl.className = `dots-counter ${batter.dots >= 3 ? 'danger' : batter.dots >= 2 ? 'warning' : ''}`;
        }
      }
      
      if (gameState.currentBowler) {
        const bowler = gameState.bowlers.find(b => b.name === gameState.currentBowler);
        if (bowler) {
          bowlerNameEl.textContent = bowler.name;
          bowlerOversEl.textContent = `${bowler.overs}.${bowler.balls % 6}`;
          bowlerFiguresEl.textContent = `${bowler.wickets}/${bowler.runs}`;
          bowlerEREl.textContent = `ER: ${bowler.overs > 0 ? (bowler.runs / bowler.overs).toFixed(2) : '0.00'}`;
          
          // Update dots counter
          bowlerDotsCounterEl.textContent = `Dots: ${bowler.dots}/3`;
          bowlerDotsCounterEl.className = `dots-counter ${bowler.dots >= 3 ? 'danger' : bowler.dots >= 2 ? 'warning' : ''}`;
        }
      }
    }
    
    // Update commentary
    function updateCommentary() {
      // In a real implementation, this would display commentary items
      // For now, we'll just show the last commentary item in the result display
      if (gameState.commentary.length > 0) {
        const lastComment = gameState.commentary[gameState.commentary.length - 1];
        resultDisplayEl.textContent = lastComment.text;
      }
    }
    
    // Check if player selection is needed
    function checkPlayerSelection() {
      nextBatterBtn.style.display = 'none';
      nextBowlerBtn.style.display = 'none';
      
      if (!gameState.currentBatter && gameState.batters.length < 11) {
        // Need to select batter
        if (gameState.isBatting) {
          nextBatterBtn.style.display = 'block';
          showBatterModal();
        }
      } else if (!gameState.currentBowler && gameState.bowlers.length < 11) {
        // Need to select bowler
        if (gameState.isBowling) {
          nextBowlerBtn.style.display = 'block';
          showBowlerModal();
        }
      }
    }
    
    // Show batter selection modal
    function showBatterModal() {
      batterListEl.innerHTML = '';
      
      // Get available batters
      const battingTeam = gameState.toss.battingFirst === 'player1' ? 'player1' : 'player2';
      const availableBatters = gameState.teams[battingTeam]?.players || [];
      const currentBatters = gameState.batters.map(b => b.name);
      
      for (const player of availableBatters) {
        if (!currentBatters.includes(player)) {
          const li = document.createElement('li');
          li.className = 'player-item';
          li.textContent = player;
          li.addEventListener('click', () => selectBatter(player));
          batterListEl.appendChild(li);
        }
      }
      
      batterModal.classList.add('active');
    }
    
    // Select batter
    function selectBatter(batter) {
      batterModal.classList.remove('active');
      
      // Add to batters list
      const newBatter = {
        name: batter,
        runs: 0,
        balls: 0,
        dots: 0,
        wickets: 0
      };
      
      update(gameRef, {
        currentBatter: batter,
        batters: [...gameState.batters, newBatter],
        lastEvent: `${batter} comes in to bat`,
        commentary: [...gameState.commentary, {
          text: `${batter} comes in to bat`,
          time: new Date().toLocaleTimeString()
        }]
      });
    }
    
    // Show bowler selection modal
    function showBowlerModal() {
      bowlerListEl.innerHTML = '';
      
      // Get available bowlers
      const bowlingTeam = gameState.toss.battingFirst === 'player1' ? 'player2' : 'player1';
      const availableBowlers = gameState.teams[bowlingTeam]?.players || [];
      const currentBowlers = gameState.bowlers.map(b => b.name);
      
      for (const player of availableBowlers) {
        if (!currentBowlers.includes(player)) {
          const li = document.createElement('li');
          li.className = 'player-item';
          li.textContent = player;
          li.addEventListener('click', () => selectBowler(player));
          bowlerListEl.appendChild(li);
        }
      }
      
      bowlerModal.classList.add('active');
    }
    
    // Select bowler
    function selectBowler(bowler) {
      bowlerModal.classList.remove('active');
      
      // Add to bowlers list
      const newBowler = {
        name: bowler,
        overs: 0,
        balls: 0,
        runs: 0,
        wickets: 0,
        dots: 0
      };
      
      update(gameRef, {
        currentBowler: bowler,
        bowlers: [...gameState.bowlers, newBowler],
        lastEvent: `${bowler} comes in to bowl`,
        commentary: [...gameState.commentary, {
          text: `${bowler} comes in to bowl`,
          time: new Date().toLocaleTimeString()
        }]
      });
    }
    
    // Update teams modal
    function updateTeamsModal() {
      team1ModalTitle.textContent = gameState.teams.player1?.name || 'Team 1';
      team2ModalTitle.textContent = gameState.teams.player2?.name || 'Team 2';
      
      team1PlayersEl.innerHTML = '';
      team2PlayersEl.innerHTML = '';
      
      // Add player1 team
      if (gameState.teams.player1?.players) {
        for (const player of gameState.teams.player1.players) {
          const li = document.createElement('li');
          li.className = 'team-player';
          li.textContent = player;
          team1PlayersEl.appendChild(li);
        }
      }
      
      // Add player2 team
      if (gameState.teams.player2?.players) {
        for (const player of gameState.teams.player2.players) {
          const li = document.createElement('li');
          li.className = 'team-player';
          li.textContent = player;
          team2PlayersEl.appendChild(li);
        }
      }
    }
    
    // Setup card buttons
    function setupCardButtons() {
      if (isSpectator) {
        cardButtonsEl.style.display = 'none';
        return;
      }
      
      const cardButtons = cardButtonsEl.querySelectorAll('.card-btn');
      
      cardButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          // Deselect all buttons
          cardButtons.forEach(b => b.classList.remove('selected'));
          
          // Select this button
          btn.classList.add('selected');
          gameState.selectedCard = parseInt(btn.dataset.value);
          
          // Update player card in Firebase
          update(playerRef, {
            card: gameState.selectedCard,
            ready: true
          });
        });
      });
    }
    
    // Setup action buttons
    function setupActionButtons() {
      // Teams button
      document.getElementById('teamsBtn').addEventListener('click', () => {
        teamsModal.classList.add('active');
      });
      
      // Next batter button
      nextBatterBtn.addEventListener('click', () => {
        showBatterModal();
      });
      
      // Next bowler button
      nextBowlerBtn.addEventListener('click', () => {
        showBowlerModal();
      });
      
      // Reset button
      resetBtn.addEventListener('click', () => {
        if (confirm('Request reset? Your opponent must accept.')) {
          update(playerRef, {
            card: null,
            ready: false,
            resetRequest: true
          });
        }
      });
      
      // Timeout button
      timeoutBtn.addEventListener('click', () => {
        if (confirm('Call a 2-minute timeout?')) {
          update(gameRef, {
            timeout: true,
            timeoutTime: Date.now()
          });
          alert('Timeout called. Game will resume in 2 minutes.');
        }
      });
      
      // Save button
      saveBtn.addEventListener('click', () => {
        if (confirm('Save game at current state?')) {
          saveGameState();
        }
      });
      
      // Leave button
      leaveBtn.addEventListener('click', () => {
        if (confirm('Leave the game?')) {
          window.location.href = 'index.html';
        }
      });
      
      // Next innings button
      nextInningsBtn.addEventListener('click', () => {
        if (confirm('Start second innings?')) {
          startSecondInnings();
        }
      });
      
      // Save match button
      saveMatchBtn.addEventListener('click', () => {
        saveMatchData();
      });
    }
    
    // Save game state
    function saveGameState() {
      // In a real implementation, this would save the game state
      alert('Game state saved!');
    }
    
    // Check if innings is complete
    function checkInningsComplete() {
      const totalBalls = getTotalBalls();
      const allOut = gameState.wickets >= (gameState.format === 'test' ? 33 : 11);
      const ballsCompleted = gameState.balls >= totalBalls && gameState.format !== 'test';
      
      if ((allOut || ballsCompleted) && gameState.innings === 1) {
        showInningsStats();
      }
    }
    
    // Check if match is complete
    function checkMatchComplete() {
      if (gameState.innings === 2) {
        const totalBalls = getTotalBalls();
        const allOut = gameState.wickets >= (gameState.format === 'test' ? 33 : 11);
        const ballsCompleted = gameState.balls >= totalBalls && gameState.format !== 'test';
        const targetReached = gameState.score >= gameState.target && gameState.target > 0;
        
        if (allOut || ballsCompleted || targetReached) {
          determineMatchResult();
          showMatchResult();
        }
      }
    }
    
    // Determine match result
    function determineMatchResult() {
      if (gameState.score >= gameState.target) {
        // Batting team won
        gameState.winner = gameState.battingTeam;
        gameState.winningMargin = `${gameState.wickets < (gameState.format === 'test' ? 33 : 10) ? 
          `${(gameState.format === 'test' ? 33 : 11) - gameState.wickets} wickets` : 
          'by runs'}`;
      } else {
        // Bowling team won
        gameState.winner = gameState.bowlingTeam;
        gameState.winningMargin = `${gameState.target - gameState.score - 1} runs`;
      }
      
      // Determine player of the match (simplified - in real app would use stats)
      const allBatters = [...gameState.batters];
      if (gameState.innings === 2) {
        const secondInningsBatters = gameState.batters.filter(b => b.innings === 2);
        allBatters.push(...secondInningsBatters);
      }
      
      const topScorer = allBatters.sort((a, b) => b.runs - a.runs)[0];
      gameState.playerOfMatch = topScorer?.name || 'None';
      
      // Update game state
      update(gameRef, {
        matchResult: `${gameState.winner} won by ${gameState.winningMargin}`,
        winner: gameState.toss.battingFirst === 'player1' ? 
          (gameState.winner === gameState.battingTeam ? 'player1' : 'player2') :
          (gameState.winner === gameState.battingTeam ? 'player2' : 'player1'),
        winningMargin: gameState.winningMargin,
        playerOfMatch: gameState.playerOfMatch
      });
    }
    
    // Show innings stats
    function showInningsStats() {
      statsModalTitle.textContent = `${gameState.battingTeam} Innings - ${gameState.score}/${gameState.wickets}`;
      statsContainerEl.innerHTML = '';
      
      // Batting stats
      const battingSection = document.createElement('div');
      battingSection.innerHTML = `
        <div class="stats-section-title">Batting</div>
        <table class="stats-table">
          <thead>
            <tr>
              <th>Batter</th>
              <th>Runs</th>
              <th>Balls</th>
              <th>SR</th>
            </tr>
          </thead>
          <tbody id="battingStatsBody"></tbody>
        </table>
      `;
      statsContainerEl.appendChild(battingSection);
      
      const battingStatsBody = document.getElementById('battingStatsBody');
      gameState.batters.forEach(batter => {
        const row = document.createElement('tr');
        const strikeRate = batter.balls > 0 ? ((batter.runs / batter.balls) * 100).toFixed(2) : '0.00';
        row.innerHTML = `
          <td>${batter.name}</td>
          <td>${batter.runs}</td>
          <td>${batter.balls}</td>
          <td>${strikeRate}</td>
        `;
        battingStatsBody.appendChild(row);
      });
      
      // Bowling stats
      const bowlingSection = document.createElement('div');
      bowlingSection.innerHTML = `
        <div class="stats-section-title">Bowling</div>
        <table class="stats-table">
          <thead>
            <tr>
              <th>Bowler</th>
              <th>Overs</th>
              <th>Runs</th>
              <th>Wkts</th>
              <th>ER</th>
            </tr>
          </thead>
          <tbody id="bowlingStatsBody"></tbody>
        </table>
      `;
      statsContainerEl.appendChild(bowlingSection);
      
      const bowlingStatsBody = document.getElementById('bowlingStatsBody');
      gameState.bowlers.forEach(bowler => {
        const row = document.createElement('tr');
        const economy = bowler.overs > 0 ? (bowler.runs / bowler.overs).toFixed(2) : '0.00';
        row.innerHTML = `
          <td>${bowler.name}</td>
          <td>${bowler.overs}.${bowler.balls % 6}</td>
          <td>${bowler.runs}</td>
          <td>${bowler.wickets}</td>
          <td>${economy}</td>
        `;
        bowlingStatsBody.appendChild(row);
      });
      
      // Enable next innings button if both players are ready
      if (!isSpectator) {
        nextInningsBtn.disabled = false;
      }
      
      statsModal.classList.add('active');
    }
    
    // Start second innings
    function startSecondInnings() {
      // Swap batting and bowling teams
      const newBattingTeam = gameState.bowlingTeam;
      const newBowlingTeam = gameState.battingTeam;
      const target = gameState.score + 1;
      
      // Reset game state for second innings
      update(gameRef, {
        battingTeam: newBattingTeam,
        bowlingTeam: newBowlingTeam,
        innings: 2,
        score: 0,
        wickets: 0,
        balls: 0,
        overs: 0,
        thisOver: [],
        currentBatter: '',
        currentBowler: '',
        batters: [],
        bowlers: [],
        batterDots: 0,
        bowlerDots: 0,
        powerplay: false,
        deadOver: false,
        freeHit: false,
        target: target,
        commentary: [],
        partnershipRuns: 0,
        partnershipBalls: 0,
        recentOvers: [],
        battleRuns: 0,
        battleBalls: 0,
        battleFours: 0,
        battleSixes: 0,
        battleExtras: 0,
        lastEvent: null
      });
      
      statsModal.classList.remove('active');
    }
    
    // Show match result
    function showMatchResult() {
      matchResultTitle.textContent = gameState.matchResult;
      
      matchResultContent.innerHTML = `
        <div style="text-align: center; margin-bottom: 20px;">
          <h3>${gameState.winner} won by ${gameState.winningMargin}</h3>
          <p>Player of the Match: ${gameState.playerOfMatch}</p>
        </div>
        
        <div class="stats-section-title">${gameState.battingTeam} 1st Innings</div>
        <p>${gameState.score}/${gameState.wickets} in ${gameState.overs}.${gameState.balls % 6} overs</p>
        
        <div class="stats-section-title">${gameState.bowlingTeam} 2nd Innings</div>
        <p>${gameState.score}/${gameState.wickets} in ${gameState.overs}.${gameState.balls % 6} overs</p>
      `;
      
      matchResultModal.classList.add('active');
    }
    
    // Save match data
    function saveMatchData() {
      const matchData = {
        team1Name: gameState.toss.battingFirst === 'player1' ? gameState.battingTeam : gameState.bowlingTeam,
        team2Name: gameState.toss.battingFirst === 'player1' ? gameState.bowlingTeam : gameState.battingTeam,
        winner: gameState.winner,
        winningMargin: gameState.winningMargin,
        playerOfMatch: gameState.playerOfMatch,
        format: getFormatName(gameState.format),
        timestamp: Date.now(),
        firstInnings: {
          team: gameState.battingTeam,
          totalRuns: gameState.score,
          totalWickets: gameState.wickets,
          overs: `${gameState.overs}.${gameState.balls % 6}`,
          batterStats: {},
          bowlerStats: {}
        },
        secondInnings: {
          team: gameState.bowlingTeam,
          totalRuns: gameState.score,
          totalWickets: gameState.wickets,
          overs: `${gameState.overs}.${gameState.balls % 6}`,
          batterStats: {},
          bowlerStats: {}
        }
      };
      
      // Add batter and bowler stats
      gameState.batters.forEach(batter => {
        matchData.firstInnings.batterStats[batter.name] = {
          runs: batter.runs,
          balls: batter.balls,
          fours: batter.fours || 0,
          sixes: batter.sixes || 0,
          out: batter.out || false
        };
      });
      
      gameState.bowlers.forEach(bowler => {
        matchData.firstInnings.bowlerStats[bowler.name] = {
          overs: bowler.overs + (bowler.balls % 6) / 10,
          runs: bowler.runs,
          wickets: bowler.wickets,
          economy: bowler.overs > 0 ? (bowler.runs / bowler.overs).toFixed(2) : '0.00'
        };
      });
      
      // Push to Firebase
      const newMatchRef = push(matchDataRef);
      set(newMatchRef, matchData)
        .then(() => {
          alert('Match data saved successfully!');
          window.location.href = `match_summary.html?id=${newMatchRef.key}`;
        })
        .catch(error => {
          console.error('Error saving match data:', error);
          alert('Error saving match data');
        });
    }
    
    // Play wicket animation
    function playWicketAnimation() {
      containerEl.classList.add('shake');
      stumpsAnimation.classList.add('active');
      
      setTimeout(() => {
        containerEl.classList.remove('shake');
        stumpsAnimation.classList.remove('active');
      }, 1000);
      
      // Create confetti
      createConfetti();
    }
    
    // Create confetti
    function createConfetti() {
      for (let i = 0; i < 50; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = `${Math.random() * 100}%`;
        confetti.style.top = `${Math.random() * 100}%`;
        confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
        confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
        document.body.appendChild(confetti);
        
        // Animate
        setTimeout(() => {
          confetti.style.opacity = '1';
          confetti.style.transform = `translate(${Math.random() * 200 - 100}px, ${Math.random() * 200 + 100}px) rotate(${Math.random() * 360}deg)`;
          
          setTimeout(() => {
            confetti.style.opacity = '0';
            setTimeout(() => confetti.remove(), 1000);
          }, 1000);
        }, 0);
      }
    }
    
    // Initialize the game
    initGame();
  </script>
</body>
</html>