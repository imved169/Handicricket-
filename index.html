<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HandiCricket</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h1>üèè HandiCricket</h1>
        <p>The digital cricket card game</p>
        
        <div class="menu">
            <input type="text" id="team-name" placeholder="Enter Team Name" maxlength="20">
            <select id="game-format">
                <option value="5">5 Overs</option>
                <option value="10">10 Overs</option>
                <option value="20" selected>T20 (20 Overs)</option>
                <option value="50">ODI (50 Overs)</option>
                <option value="test">Test Match</option>
            </select>
            <button id="create-game" class="btn">Create Game</button>
            <button id="join-game" class="btn">Join Game</button>
        </div>
        
        <div id="join-form" class="hidden">
            <input type="text" id="game-id" placeholder="Enter Game ID" maxlength="4">
            <input type="text" id="player-name" placeholder="Your Name" maxlength="20">
            <button id="confirm-join" class="btn">Join</button>
            <button id="back-btn" class="btn secondary">Back</button>
        </div>
        
        <div id="game-created" class="hidden">
            <p>Your Game ID:</p>
            <div id="game-code" class="game-code"></div>
            <p>Share this with your opponent</p>
            <div class="loader"></div>
            <p id="waiting-text">Waiting for opponent...</p>
            <div id="connection-status" class="hidden">Opponent: <span>Offline</span></div>
        </div>
    </div>

    <script type="module">
        import { db, ref, set, get, onValue } from './firebase.js';
        
        function generateId() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let result = '';
            for (let i = 0; i < 4; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }
        
        const createBtn = document.getElementById('create-game');
        const joinBtn = document.getElementById('join-game');
        const joinForm = document.getElementById('join-form');
        const gameCreated = document.getElementById('game-created');
        const gameCode = document.getElementById('game-code');
        const confirmJoin = document.getElementById('confirm-join');
        const backBtn = document.getElementById('back-btn');
        const connectionStatus = document.getElementById('connection-status');
        
        createBtn.addEventListener('click', async () => {
            const teamName = document.getElementById('team-name').value.trim();
            const format = document.getElementById('game-format').value;
            
            if (!teamName) {
                alert('Please enter your team name');
                return;
            }
            
            const gameId = generateId();
            gameCode.textContent = gameId;
            gameCreated.classList.remove('hidden');
            document.querySelector('.menu').classList.add('hidden');
            
            await set(ref(db, `games/${gameId}`), {
                created: Date.now(),
                status: 'waiting',
                format: format,
                teams: {
                    player1: {
                        name: teamName,
                        players: []
                    }
                }
            });
            
            localStorage.setItem('gameId', gameId);
            localStorage.setItem('player', 'player1');
            localStorage.setItem('teamName', teamName);
            localStorage.setItem('format', format);
            
            // Monitor opponent connection
            onValue(ref(db, `games/${gameId}/teams/player2`), (snapshot) => {
                if (snapshot.exists()) {
                    connectionStatus.classList.remove('hidden');
                    connectionStatus.querySelector('span').textContent = 'Online';
                    connectionStatus.querySelector('span').className = 'online';
                    setTimeout(() => {
                        window.location.href = 'playing11.html';
                    }, 1000);
                }
            });
        });
        
        joinBtn.addEventListener('click', () => {
            joinForm.classList.remove('hidden');
            document.querySelector('.menu').classList.add('hidden');
        });
        
        confirmJoin.addEventListener('click', async () => {
            const gameId = document.getElementById('game-id').value.trim().toUpperCase();
            const playerName = document.getElementById('player-name').value.trim();
            
            if (gameId.length !== 4) {
                alert('Please enter a valid 4-character ID');
                return;
            }
            
            if (!playerName) {
                alert('Please enter your name');
                return;
            }
            
            const snapshot = await get(ref(db, `games/${gameId}`));
            if (snapshot.exists()) {
                localStorage.setItem('gameId', gameId);
                localStorage.setItem('player', 'player2');
                localStorage.setItem('teamName', playerName);
                
                await set(ref(db, `games/${gameId}/teams/player2`), {
                    name: playerName,
                    players: []
                });
                
                window.location.href = 'playing11.html';
            } else {
                alert('Game not found');
            }
        });
        
        backBtn.addEventListener('click', () => {
            joinForm.classList.add('hidden');
            document.querySelector('.menu').classList.remove('hidden');
        });
    </script>
</body>
</html>
