<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HandiCricket - First Innings</title>
  <style>
    :root {
      --primary: #1e88e5;
      --secondary: #ffeb3b;
      --success: #4CAF50;
      --danger: #f44336;
      --warning: #FF9800;
      --info: #9C27B0;
      --dark: #061e3e;
      --light: #f5f5f5;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      background: linear-gradient(135deg, #0a1f3a, #123456);
      color: white;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      padding: 10px;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .header h1 {
      color: var(--secondary);
      font-size: 1.3rem;
      text-shadow: 0 0 5px rgba(255, 235, 59, 0.3);
    }
    
    .teams-display {
      display: flex;
      justify-content: space-between;
      background: rgba(13, 42, 82, 0.7);
      padding: 8px;
      border-radius: 8px;
      margin-bottom: 8px;
      font-size: 0.9rem;
    }
    
    .team {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .team-label {
      font-size: 0.7rem;
      color: #aaa;
      margin-bottom: 3px;
    }
    
    .scoreboard {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .score {
      font-size: 2rem;
      font-weight: bold;
      color: var(--secondary);
    }
    
    .score-details {
      text-align: right;
      font-size: 0.9rem;
    }
    
    .match-info {
      display: flex;
      justify-content: space-between;
      background: rgba(13, 42, 82, 0.5);
      padding: 6px;
      border-radius: 6px;
      margin-bottom: 8px;
      font-size: 0.8rem;
    }
    
    .over-display {
      background: rgba(13, 42, 82, 0.7);
      padding: 8px;
      border-radius: 6px;
      margin-bottom: 8px;
    }
    
    .balls-container {
      display: flex;
      justify-content: center;
      gap: 5px;
      margin: 5px 0;
    }
    
    .ball {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: bold;
    }
    
    .ball.dot { background: #333; color: white; }
    .ball.run { background: var(--success); color: white; }
    .ball.wicket { background: var(--danger); color: white; }
    .ball.wide { background: var(--warning); color: white; }
    .ball.noball { background: var(--info); color: white; }
    .ball.empty { background: rgba(255,255,255,0.1); }
    
    .player-comparison {
      display: flex;
      justify-content: space-between;
      background: rgba(13, 42, 82, 0.7);
      padding: 8px;
      border-radius: 6px;
      margin-bottom: 8px;
    }
    
    .player-box {
      flex: 1;
      padding: 5px;
      border-radius: 4px;
      text-align: center;
    }
    
    .batter { 
      background: rgba(76, 175, 80, 0.1);
      border-left: 2px solid var(--success);
    }
    
    .bowler { 
      background: rgba(244, 67, 54, 0.1);
      border-left: 2px solid var(--danger);
    }
    
    .vs-circle {
      width: 30px;
      height: 30px;
      background: var(--primary);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 0.7rem;
      margin: 0 5px;
    }
    
    .player-name {
      font-weight: bold;
      margin: 3px 0;
      font-size: 0.9rem;
    }
    
    .player-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 3px;
      font-size: 0.7rem;
    }
    
    .card-buttons {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 5px;
      margin-bottom: 8px;
    }
    
    .card-btn {
      aspect-ratio: 1;
      border: none;
      border-radius: 6px;
      background: linear-gradient(145deg, var(--primary), #1565c0);
      color: white;
      font-size: 1.2rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .card-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 3px 5px rgba(0,0,0,0.2);
    }
    
    .card-btn:disabled {
      background: #666;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .card-btn.selected {
      background: var(--success);
      border: 2px solid var(--secondary);
      transform: scale(1.05);
    }
    
    .status-indicators {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    
    .indicator {
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: bold;
    }
    
    .powerplay { background: var(--secondary); color: #000; }
    .freehit { background: var(--success); color: white; }
    .deadover { background: var(--danger); color: white; }
    
    .result-display {
      min-height: 40px;
      padding: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 6px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
    }
    
    .controls {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    
    .control-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      font-size: 0.8rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .save-btn { background: var(--warning); color: white; }
    .exit-btn { background: var(--danger); color: white; }
    .reset-btn { background: var(--info); color: white; }
    .teams-btn { background: var(--primary); color: white; }
    
    .commentary-box {
      flex: 1;
      background: rgba(13, 42, 82, 0.7);
      border-radius: 6px;
      padding: 8px;
      overflow-y: auto;
      font-size: 0.8rem;
    }
    
    .commentary-item {
      padding: 5px 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      animation: fadeIn 0.3s ease-in;
    }
    
    .commentary-item:last-child {
      border-bottom: none;
    }
    
    .commentary-time {
      color: #aaa;
      font-size: 0.7rem;
      margin-right: 5px;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Modal styles */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .modal-content {
      background: linear-gradient(145deg, #123456, #0a1f3a);
      width: 90%;
      max-width: 350px;
      max-height: 80vh;
      border-radius: 10px;
      padding: 15px;
      overflow-y: auto;
    }
    
    .modal-title {
      color: var(--secondary);
      margin-bottom: 10px;
      text-align: center;
    }
    
    .player-list {
      list-style: none;
    }
    
    .player-item {
      padding: 8px;
      margin: 5px 0;
      background: rgba(30, 136, 229, 0.2);
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .player-item:hover {
      background: rgba(30, 136, 229, 0.4);
      transform: translateX(5px);
    }
    
    .player-item.selected {
      background: rgba(13, 71, 161, 0.6);
      border-left: 3px solid var(--secondary);
    }
    
    .modal-btn {
      width: 100%;
      padding: 8px;
      margin-top: 10px;
      background: var(--success);
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    
    /* Animations */
    @keyframes scoreIncrease {
      0% { transform: scale(1); color: white; }
      50% { transform: scale(1.3); color: var(--success); }
      100% { transform: scale(1); color: white; }
    }
    
    @keyframes boundary {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); color: var(--secondary); }
      100% { transform: scale(1); }
    }
    
    .score-change { animation: scoreIncrease 0.8s ease-in-out; }
    .boundary-flash { animation: boundary 1s ease-in-out; }
  </style>
</head>
<body>
  <div class="header">
    <h1>üèè HandiCricket</h1>
    <div id="connectionStatus" class="online">Opponent: Online</div>
  </div>
  
  <div class="teams-display">
    <div class="team">
      <div class="team-label">Batting</div>
      <div id="team1Name">Team A</div>
    </div>
    <div class="team">
      <div class="team-label">Bowling</div>
      <div id="team2Name">Team B</div>
    </div>
  </div>
  
  <div class="scoreboard">
    <div>
      <div id="battingTeamName">Team A</div>
      <div class="score"><span id="runs">0</span>/<span id="wickets">0</span></div>
    </div>
    <div class="score-details">
      <div>Overs: <span id="overs">0.0</span></div>
      <div>RR: <span id="runRate">0.00</span></div>
    </div>
  </div>
  
  <div class="match-info">
    <div id="formatDisplay">T20 Match</div>
    <div id="inningsNumber">1st Innings</div>
    <div id="roleText">You are Batting</div>
  </div>
  
  <div class="over-display">
    <div>Over <span id="currentOverNumber">1</span></div>
    <div class="balls-container" id="ballsContainer"></div>
  </div>
  
  <div class="player-comparison">
    <div class="player-box batter">
      <div class="player-name" id="comparisonBatterName">-</div>
      <div class="player-stats">
        <div>Runs: <span id="comparisonBatterRuns">0</span></div>
        <div>Balls: <span id="comparisonBatterBalls">0</span></div>
        <div>SR: <span id="comparisonBatterSR">0.00</span></div>
        <div>4s/6s: <span id="comparisonBatterBoundaries">0/0</span></div>
      </div>
    </div>
    <div class="vs-circle">VS</div>
    <div class="player-box bowler">
      <div class="player-name" id="comparisonBowlerName">-</div>
      <div class="player-stats">
        <div>Overs: <span id="comparisonBowlerOvers">0.0</span></div>
        <div>Wkts: <span id="comparisonBowlerWickets">0</span></div>
        <div>ER: <span id="comparisonBowlerER">0.00</span></div>
        <div>Runs: <span id="comparisonBowlerRuns">0</span></div>
      </div>
    </div>
  </div>
  
  <div class="status-indicators">
    <div id="powerplayIndicator" class="indicator powerplay" style="display: none;">Powerplay</div>
    <div id="freeHitIndicator" class="indicator freehit" style="display: none;">Free Hit</div>
    <div id="deadOverIndicator" class="indicator deadover" style="display: none;">Dead Over</div>
  </div>
  
  <div class="result-display" id="result">Initializing game...</div>
  
  <div class="card-buttons" id="cardButtons">
    <button class="card-btn" data-value="0">0</button>
    <button class="card-btn" data-value="1">1</button>
    <button class="card-btn" data-value="2">2</button>
    <button class="card-btn" data-value="3">3</button>
    <button class="card-btn" data-value="4">4</button>
    <button class="card-btn" data-value="5">5</button>
    <button class="card-btn" data-value="6">6</button>
  </div>
  
  <div class="controls">
    <button class="control-btn save-btn" id="saveBtn">üíæ Save</button>
    <button class="control-btn exit-btn" id="exitBtn">üö™ Exit</button>
    <button class="control-btn reset-btn" id="resetPlaysBtn">üîÑ Reset</button>
    <button class="control-btn teams-btn" id="showTeamsBtn">üë• Teams</button>
  </div>
  
  <div class="commentary-box" id="commentaryBox"></div>
  
  <!-- Selection Modal -->
  <div id="selectionModal" class="modal">
    <div class="modal-content">
      <h3 class="modal-title" id="selectionTitle">Select Next Batter</h3>
      <div id="selectionList" class="player-list"></div>
      <button class="modal-btn" id="confirmSelection">Confirm</button>
    </div>
  </div>
  
  <!-- Teams Modal -->
  <div id="teamsModal" class="modal">
    <div class="modal-content">
      <h3 class="modal-title" id="modalTeam1Name">Team 1</h3>
      <ul id="modalTeam1Players" class="player-list"></ul>
      <h3 class="modal-title" id="modalTeam2Name">Team 2</h3>
      <ul id="modalTeam2Players" class="player-list"></ul>
      <button class="modal-btn" id="closeTeamsBtn">Close</button>
    </div>
  </div>
  
  <!-- Innings Summary Modal -->
  <div id="summaryModal" class="modal">
    <div class="modal-content">
      <h3 class="modal-title">First Innings Summary</h3>
      <div class="summary-content">
        <div>Total Runs: <span id="summaryTotalRuns">0</span></div>
        <div>Wickets: <span id="summaryWickets">0</span></div>
        <div>Overs: <span id="summaryOvers">0.0</span></div>
        <div>Run Rate: <span id="summaryRunRate">0.00</span></div>
      </div>
      <div id="summaryHighlight" style="margin: 10px 0; padding: 5px; background: rgba(255,255,255,0.1); border-radius: 4px;"></div>
      <div style="margin: 10px 0;">Second innings starting in <span id="summaryCountdown">30</span>s</div>
      <button class="modal-btn" id="startSecondInningsNowBtn">Start Now</button>
    </div>
  </div>

  <script type="module">
    // Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getDatabase, ref, onValue, set, get, update, push, remove, child } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCN6aZMwlsZe7JJaovU0WA3UQygWr4jYmA",
      authDomain: "handicricket-85a06.firebaseapp.com",
      projectId: "handicricket-85a06",
      storageBucket: "handicricket-85a06.appspot.com",
      messagingSenderId: "599182538558",
      appId: "1:599182538558:web:3e965753ab05f8f1e3de6f",
      measurementId: "G-HSV9H4LEJQ"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Get URL parameters
    const params = new URLSearchParams(window.location.search);
    const room = params.get('room');
    const player = params.get('player');
    const opponent = player === "player1" ? "player2" : "player1";

    // Firebase references
    const roomRef = ref(db, `rooms/${room}`);
    const playerRef = ref(db, `rooms/${room}/${player}`);
    const opponentRef = ref(db, `rooms/${room}/${opponent}`);
    const playsRef = ref(db, `rooms/${room}/currentPlays`);
    const batterRef = ref(db, `rooms/${room}/currentBatter`);
    const bowlerRef = ref(db, `rooms/${room}/currentBowler`);
    const teamsRef = ref(db, `rooms/${room}/teams`);
    const tossRef = ref(db, `rooms/${room}/toss`);
    const matchStatsRef = ref(db, `rooms/${room}/matchStats`);
    const resetRequestRef = ref(db, `rooms/${room}/resetRequest`);

    // Game state variables
    let runs = 0, wickets = 0;
    let legalBalls = 0;
    let freeHit = false;
    let currentBatter = null;
    let currentBowler = null;
    let isBatting = false;
    let currentFormat = {};
    let isPowerplay = false;
    let isDeadOver = false;
    let team1Players = [];
    let team2Players = [];
    let batterStats = {};
    let bowlerStats = {};
    let batterWickets = {};
    let batterPenalties = {};
    let lastBatterRuns = {};
    let ballByBall = {};
    let fallOfWickets = [];
    let tossWinner = null;
    let battingFirst = null;
    let selectedCardValue = null;
    let isProcessingSelection = false;
    let isResetting = false;
    let commentaryPaused = false;

    // DOM elements
    const resultEl = document.getElementById("result");
    const connectionStatus = document.getElementById("connectionStatus");
    const team1NameEl = document.getElementById("team1Name");
    const team2NameEl = document.getElementById("team2Name");
    const battingTeamName = document.getElementById("battingTeamName");
    const formatDisplay = document.getElementById("formatDisplay");
    const inningsNumber = document.getElementById("inningsNumber");
    const roleText = document.getElementById("roleText");
    const runsEl = document.getElementById("runs");
    const wicketsEl = document.getElementById("wickets");
    const oversEl = document.getElementById("overs");
    const runRateEl = document.getElementById("runRate");
    const ballsContainer = document.getElementById("ballsContainer");
    const currentOverNumber = document.getElementById("currentOverNumber");
    const comparisonBatterName = document.getElementById("comparisonBatterName");
    const comparisonBatterRuns = document.getElementById("comparisonBatterRuns");
    const comparisonBatterBalls = document.getElementById("comparisonBatterBalls");
    const comparisonBatterSR = document.getElementById("comparisonBatterSR");
    const comparisonBatterBoundaries = document.getElementById("comparisonBatterBoundaries");
    const comparisonBowlerName = document.getElementById("comparisonBowlerName");
    const comparisonBowlerOvers = document.getElementById("comparisonBowlerOvers");
    const comparisonBowlerWickets = document.getElementById("comparisonBowlerWickets");
    const comparisonBowlerER = document.getElementById("comparisonBowlerER");
    const comparisonBowlerRuns = document.getElementById("comparisonBowlerRuns");
    const powerplayIndicator = document.getElementById("powerplayIndicator");
    const freeHitIndicator = document.getElementById("freeHitIndicator");
    const deadOverIndicator = document.getElementById("deadOverIndicator");
    const cardButtons = document.getElementById("cardButtons");
    const buttons = document.querySelectorAll(".card-btn");
    const saveBtn = document.getElementById("saveBtn");
    const exitBtn = document.getElementById("exitBtn");
    const resetPlaysBtn = document.getElementById("resetPlaysBtn");
    const showTeamsBtn = document.getElementById("showTeamsBtn");
    const commentaryBox = document.getElementById("commentaryBox");
    const selectionModal = document.getElementById("selectionModal");
    const selectionTitle = document.getElementById("selectionTitle");
    const selectionList = document.getElementById("selectionList");
    const confirmSelection = document.getElementById("confirmSelection");
    const teamsModal = document.getElementById("teamsModal");
    const modalTeam1Name = document.getElementById("modalTeam1Name");
    const modalTeam2Name = document.getElementById("modalTeam2Name");
    const modalTeam1Players = document.getElementById("modalTeam1Players");
    const modalTeam2Players = document.getElementById("modalTeam2Players");
    const closeTeamsBtn = document.getElementById("closeTeamsBtn");
    const summaryModal = document.getElementById("summaryModal");
    const summaryTotalRuns = document.getElementById("summaryTotalRuns");
    const summaryWickets = document.getElementById("summaryWickets");
    const summaryOvers = document.getElementById("summaryOvers");
    const summaryRunRate = document.getElementById("summaryRunRate");
    const summaryHighlight = document.getElementById("summaryHighlight");
    const summaryCountdown = document.getElementById("summaryCountdown");
    const startSecondInningsNowBtn = document.getElementById("startSecondInningsNowBtn");

    // Format rules
    const formatRules = {
      "5": { 
        name: "T5 (5 Overs)", 
        totalOvers: 5, 
        totalWickets: 11, 
        powerplayOvers: 2
      },
      "10": { 
        name: "T10 (10 Overs)", 
        totalOvers: 10, 
        totalWickets: 11, 
        powerplayOvers: 3
      },
      "20": { 
        name: "T20 (20 Overs)", 
        totalOvers: 20, 
        totalWickets: 11, 
        powerplayOvers: 6
      },
      "50": { 
        name: "ODI (50 Overs)", 
        totalOvers: 50, 
        totalWickets: 11, 
        powerplayOvers: 10
      }
    };

    // Initialize the game
    async function initGame() {
      try {
        // Set player online status
        await set(playerRef, { connected: true });
        
        // Load room data
        const roomSnap = await get(roomRef);
        if (!roomSnap.exists()) throw new Error("Room not found");
        
        const roomData = roomSnap.val();
        
        // Get toss and batting first info
        tossWinner = roomData.toss?.winner;
        battingFirst = roomData.toss?.battingFirst;
        
        // Load teams
        if (roomData.teams) {
          team1Players = roomData.teams.player1?.players || [];
          team2Players = roomData.teams.player2?.players || [];
          
          team1NameEl.textContent = roomData.teams.player1?.name || "Team A";
          team2NameEl.textContent = roomData.teams.player2?.name || "Team B";
          battingTeamName.textContent = battingFirst === "player1" ? 
            roomData.teams.player1?.name || "Team A" : 
            roomData.teams.player2?.name || "Team B";
            
          // Initialize player stats
          initializePlayerStats();
        }
        
        // Set game format
        const format = roomData.player1?.format || "20";
        currentFormat = formatRules[format];
        formatDisplay.textContent = currentFormat.name;
        
        // Set up UI
        setupConnectionMonitoring();
        setupRole();
        setupSelectionModal();
        setupCardButtons();
        setupTeamsModal();
        setupControlButtons();
        
        // Set up Firebase listeners
        setupFirebaseListeners();
        
        // Initial UI update
        updateAllDisplays();
        resultEl.textContent = "Game ready!";
        
      } catch (error) {
        console.error("Initialization failed:", error);
        resultEl.innerHTML = `Error: ${error.message}<br>
                           <button onclick="location.reload()" style="margin-top:10px; padding: 8px 15px; background: #1e88e5; color: white; border: none; border-radius: 5px; cursor: pointer;">
                             Retry
                           </button>`;
      }
    }

    // Initialize player stats
    function initializePlayerStats() {
      // Initialize batter stats
      team1Players.forEach(player => {
        batterStats[player] = { runs: 0, balls: 0, fours: 0, sixes: 0 };
        batterWickets[player] = 0;
        batterPenalties[player] = 0;
        lastBatterRuns[player] = 0;
      });
      
      team2Players.forEach(player => {
        batterStats[player] = { runs: 0, balls: 0, fours: 0, sixes: 0 };
        batterWickets[player] = 0;
        batterPenalties[player] = 0;
        lastBatterRuns[player] = 0;
      });
      
      // Initialize bowler stats
      team1Players.forEach(player => {
        bowlerStats[player] = { wickets: 0, runs: 0, overs: 0 };
      });
      
      team2Players.forEach(player => {
        bowlerStats[player] = { wickets: 0, runs: 0, overs: 0 };
      });
    }

    // Set up player role (batting/bowling)
    async function setupRole() {
      isBatting = (player === battingFirst);
      roleText.textContent = isBatting ? "You are Batting" : "You are Bowling";
      
      // Clear selections
      await set(batterRef, null);
      await set(bowlerRef, null);
      
      // Show appropriate selection UI
      if (isBatting) {
        await showBatterSelection();
      } else {
        await showBowlerSelection();
      }
    }

    // Show batter selection modal
    async function showBatterSelection() {
      disableButtons();
      
      const currentPlayers = isBatting ? 
        (player === "player1" ? team1Players : team2Players) : 
        (player === "player1" ? team2Players : team1Players);
      
      const availableBatters = currentPlayers.filter(p => batterWickets[p] < 1);
      
      if (availableBatters.length === 0) {
        addCommentary("All batters are out!", "error");
        return;
      }
      
      selectionTitle.textContent = "Select Next Batter";
      selectionList.innerHTML = "";
      
      availableBatters.forEach(player => {
        const stats = batterStats[player] || { runs: 0, balls: 0 };
        const sr = stats.balls > 0 ? ((stats.runs / stats.balls) * 100).toFixed(2) : "0.00";
        
        const playerEl = document.createElement("li");
        playerEl.className = "player-item";
        playerEl.dataset.name = player;
        playerEl.innerHTML = `
          <div>${player}</div>
          <div>${stats.runs} runs (SR: ${sr})</div>
        `;
        
        playerEl.addEventListener("click", function() {
          document.querySelectorAll(".player-item").forEach(el => el.classList.remove("selected"));
          this.classList.add("selected");
        });
        
        selectionList.appendChild(playerEl);
      });
      
      showModal(selectionModal);
    }

    // Show bowler selection modal
    async function showBowlerSelection() {
      disableButtons();
      
      const currentPlayers = isBatting ? 
        (player === "player1" ? team2Players : team1Players) : 
        (player === "player1" ? team1Players : team2Players);
      
      const maxOversPerBowler = Math.ceil(currentFormat.totalOvers / 5);
      const availableBowlers = currentPlayers.filter(p => (bowlerStats[p]?.overs || 0) < maxOversPerBowler);
      
      if (availableBowlers.length === 0) {
        addCommentary("All bowlers have bowled maximum overs!", "error");
        return;
      }
      
      selectionTitle.textContent = "Select Next Bowler";
      selectionList.innerHTML = "";
      
      availableBowlers.forEach(player => {
        const stats = bowlerStats[player] || { wickets: 0, runs: 0, overs: 0 };
        const er = stats.overs > 0 ? (stats.runs / stats.overs).toFixed(2) : "0.00";
        
        const playerEl = document.createElement("li");
        playerEl.className = "player-item";
        playerEl.dataset.name = player;
        playerEl.innerHTML = `
          <div>${player}</div>
          <div>${stats.overs.toFixed(1)} overs, ${stats.wickets} wkts (ER: ${er})</div>
        `;
        
        playerEl.addEventListener("click", function() {
          document.querySelectorAll(".player-item").forEach(el => el.classList.remove("selected"));
          this.classList.add("selected");
        });
        
        selectionList.appendChild(playerEl);
      });
      
      showModal(selectionModal);
    }

    // Set up selection modal
    function setupSelectionModal() {
      confirmSelection.addEventListener("click", async () => {
        const selected = document.querySelector(".player-item.selected");
        if (!selected) {
          addCommentary("Please select a player", "error");
          return;
        }
        
        const playerName = selected.dataset.name;
        hideModal(selectionModal);
        
        if (selectionTitle.textContent.includes("Batter")) {
          await set(batterRef, playerName);
          addCommentary(`${playerName} comes in to bat`, "info");
        } else {
          await set(bowlerRef, playerName);
          addCommentary(`${playerName} comes in to bowl`, "info");
        }
        
        updateButtonStates();
      });
    }

    // Set up card buttons
    function setupCardButtons() {
      buttons.forEach(btn => {
        btn.addEventListener("click", async function() {
          if (btn.disabled || isProcessingSelection) return;
          
          const cardValue = parseInt(btn.dataset.value);
          selectedCardValue = cardValue;
          isProcessingSelection = true;
          
          // Visual feedback
          disableButtons();
          highlightSelectedCard(cardValue);
          resultEl.textContent = `Selected: ${cardValue}`;
          
          try {
            await update(playsRef, {
              [player]: cardValue
            });
          } catch (error) {
            console.error("Selection failed:", error);
            resultEl.textContent = "Selection failed, please try again";
            enableButtons();
            clearCardSelection();
          } finally {
            isProcessingSelection = false;
          }
        });
      });
    }

    // Set up teams modal
    function setupTeamsModal() {
      showTeamsBtn.addEventListener("click", () => {
        modalTeam1Name.textContent = team1NameEl.textContent;
        modalTeam2Name.textContent = team2NameEl.textContent;
        
        modalTeam1Players.innerHTML = team1Players.map(p => `
          <li class="player-item">${p}</li>
        `).join("");
        
        modalTeam2Players.innerHTML = team2Players.map(p => `
          <li class="player-item">${p}</li>
        `).join("");
        
        showModal(teamsModal);
      });
      
      closeTeamsBtn.addEventListener("click", () => {
        hideModal(teamsModal);
      });
    }

    // Set up control buttons
    function setupControlButtons() {
      saveBtn.addEventListener("click", saveGameState);
      
      exitBtn.addEventListener("click", async () => {
        if (confirm("Exit without saving?")) {
          await set(playerRef, { connected: false });
          window.location.href = "index.html";
        }
      });
      
      resetPlaysBtn.addEventListener("click", async () => {
        if (confirm("Reset current plays?")) {
          await resetPlays();
        }
      });
    }

    // Set up connection monitoring
    function setupConnectionMonitoring() {
      onValue(opponentRef, (snap) => {
        if (snap.exists() && snap.val()?.connected) {
          connectionStatus.textContent = "Opponent: Online";
          connectionStatus.className = "online";
          updateButtonStates();
        } else {
          connectionStatus.textContent = "Opponent: Offline";
          connectionStatus.className = "offline";
          resultEl.textContent = "Waiting for opponent...";
          disableButtons();
        }
      });
    }

    // Set up Firebase listeners
    function setupFirebaseListeners() {
      // Listen for plays
      onValue(playsRef, (snap) => {
        if (snap.exists() && snap.val().player1 !== undefined && snap.val().player2 !== undefined) {
          handleResult(snap.val());
        }
      });
      
      // Listen for batter changes
      onValue(batterRef, (snap) => {
        if (snap.exists()) {
          currentBatter = snap.val();
          updateAllDisplays();
        } else {
          currentBatter = null;
          if (isBatting) showBatterSelection();
        }
      });
      
      // Listen for bowler changes
      onValue(bowlerRef, (snap) => {
        if (snap.exists()) {
          currentBowler = snap.val();
          updateAllDisplays();
        } else {
          currentBowler = null;
          if (!isBatting) showBowlerSelection();
        }
      });
      
      // Listen for reset requests
      onValue(resetRequestRef, (snap) => {
        if (snap.exists() && snap.val().requested && snap.val().by !== player) {
          showResetConfirmation(snap.val().by);
        }
      });
    }

    // Handle ball result
    async function handleResult(plays) {
      const card1 = plays.player1;
      const card2 = plays.player2;
      const batterCard = isBatting ? (player === "player1" ? card1 : card2) : (player === "player1" ? card2 : card1);
      const bowlerCard = isBatting ? (player === "player1" ? card2 : card1) : (player === "player1" ? card1 : card2);
      
      let outcome = "";
      let runsScored = 0;
      let isWicket = false;
      let isPlayerOut = false;
      let boundary = false;
      
      // Check powerplay status
      isPowerplay = Math.floor(legalBalls / 6) < currentFormat.powerplayOvers;
      powerplayIndicator.style.display = isPowerplay ? "block" : "none";
      
      // 1. Check for no ball (both 0)
      if (batterCard === 0 && bowlerCard === 0) {
        outcome = "NO BALL! +1 run (Free Hit next ball)";
        runs += 1;
        freeHit = true;
        addCommentary("No ball! Free hit coming up...", "error");
      } 
      // 2. Handle free hit balls
      else if (freeHit) {
        if (batterCard === bowlerCard && batterCard > 0) {
          outcome = "Wicket on Free Hit (not out)";
          isWicket = false;
          addCommentary(`Wicket on free hit! ${currentBatter} survives`, "info");
        } else {
          runsScored = batterCard;
          runs += batterCard;
          batterStats[currentBatter].runs += runsScored;
          outcome = `${batterCard} Run(s)! (Free Hit)`;
          if (batterCard === 4 || batterCard === 6) boundary = true;
          addCommentary(`${currentBatter} scores ${batterCard} on free hit`, "info");
        }
        freeHit = false;
        freeHitIndicator.style.display = "none";
      }
      // 3. Handle wickets (same number > 0)
      else if (batterCard === bowlerCard && batterCard > 0) {
        const wicketValue = isPowerplay ? 0.5 : 1.0;
        batterWickets[currentBatter] += wicketValue;
        wickets += wicketValue;
        isWicket = true;
        
        if (batterWickets[currentBatter] >= 1.0) {
          isPlayerOut = true;
          outcome = "WICKET! (Out)";
          fallOfWickets.push({
            score: runs,
            over: `${Math.floor(legalBalls / 6)}.${(legalBalls % 6) + 1}`,
            batter: currentBatter
          });
          addCommentary(`WICKET! ${currentBowler} gets ${currentBatter} out!`, "wicket");
        } else {
          const remain = (1.0 - batterWickets[currentBatter]).toFixed(1);
          outcome = `WICKET! (${remain} left for this batter)`;
          addCommentary(`Close call! ${currentBatter} loses ${wicketValue} wicket points`, "wicket");
        }
      }
      // 4. Normal runs
      else {
        runsScored = batterCard;
        runs += batterCard;
        batterStats[currentBatter].runs += batterCard;
        outcome = `${batterCard} Run(s)!`;
        if (batterCard === 4 || batterCard === 6) boundary = true;
        
        const boundaryType = batterCard === 6 ? 'SIX' : 'FOUR';
        addCommentary(`${boundaryType}! ${currentBatter} hits ${batterCard} runs off ${currentBowler}`, boundary ? "boundary" : "");
      }
      
      // Update batter stats
      if (currentBatter && runsScored > 0) {
        batterStats[currentBatter].balls += 1;
        if (batterCard === 4) batterStats[currentBatter].fours += 1;
        if (batterCard === 6) batterStats[currentBatter].sixes += 1;
        checkBatterMilestones();
      }
      
      // Update bowler stats
      if (currentBowler) {
        bowlerStats[currentBowler].runs += runsScored;
        if (isWicket) bowlerStats[currentBowler].wickets += 1;
      }
      
      // Record ball
      ballByBall[legalBalls] = {
        runs: runsScored,
        wicket: isWicket,
        batter: currentBatter,
        bowler: currentBowler,
        outcome: outcome
      };
      
      // Handle legal balls
      if (!(batterCard === 0 && bowlerCard === 0)) {
        legalBalls++;
        
        if (currentBowler) {
          bowlerStats[currentBowler].overs = Math.floor(legalBalls / 6) + ((legalBalls % 6) / 10);
        }
      }
      
      // Update UI
      updateAllDisplays();
      resultEl.textContent = outcome;
      
      // Add animations
      if (boundary) {
        runsEl.classList.add("boundary-flash");
      }
      if (isWicket) {
        wicketsEl.classList.add("score-change");
      }
      if (runsScored > 0) {
        runsEl.classList.add("score-change");
      }
      
      setTimeout(() => {
        runsEl.classList.remove("boundary-flash", "score-change");
        wicketsEl.classList.remove("score-change");
      }, 1000);
      
      // Check for innings end
      if (wickets >= currentFormat.totalWickets || legalBalls >= currentFormat.totalOvers * 6) {
        endInning();
        return;
      }
      
      // Prepare for next ball
      setTimeout(async () => {
        await set(playsRef, {});
        clearCardSelection();
        
        if (isPlayerOut && isBatting) {
          await set(batterRef, null);
        } else if (legalBalls % 6 === 0 && !isBatting) {
          await set(bowlerRef, null);
        } else {
          enableButtons();
        }
      }, 1500);
    }

    // Check batter milestones
    function checkBatterMilestones() {
      if (!currentBatter) return;
      
      const batter = batterStats[currentBatter];
      const netRuns = batter.runs - (batterPenalties[currentBatter] || 0);
      
      // Check for 50
      if (netRuns >= 50 && !batter.fiftyNotified) {
        addCommentary(`${currentBatter} scores a half-century!`, "milestone");
        batter.fiftyNotified = true;
      }
      
      // Check for 100
      if (netRuns >= 100 && !batter.centuryNotified) {
        addCommentary(`${currentBatter} scores a century! üíØ`, "milestone");
        batter.centuryNotified = true;
      }
      
      lastBatterRuns[currentBatter] = netRuns;
    }

    // Update all displays
    function updateAllDisplays() {
      // Update scoreboard
      runsEl.textContent = runs;
      wicketsEl.textContent = Math.floor(wickets);
      
      // Update overs and run rate
      const completedOvers = Math.floor(legalBalls / 6) + ((legalBalls % 6) / 10);
      oversEl.textContent = completedOvers.toFixed(1);
      runRateEl.textContent = completedOvers > 0 ? (runs / completedOvers).toFixed(2) : "0.00";
      
      // Update current over display
      currentOverNumber.textContent = Math.floor(legalBalls / 6) + 1;
      updateBallsDisplay();
      
      // Update player comparison
      updatePlayerComparison();
      
      // Update button states
      updateButtonStates();
    }

    // Update balls display
    function updateBallsDisplay() {
      ballsContainer.innerHTML = "";
      const ballsThisOver = legalBalls % 6;
      
      for (let i = 0; i < 6; i++) {
        const ballEl = document.createElement("div");
        ballEl.className = "ball";
        
        if (i < ballsThisOver) {
          const ballData = ballByBall[legalBalls - ballsThisOver + i];
          if (ballData) {
            if (ballData.wicket) {
              ballEl.className += " wicket";
              ballEl.textContent = "W";
            } else if (ballData.runs > 0) {
              ballEl.className += " run";
              ballEl.textContent = ballData.runs;
            } else {
              ballEl.className += " dot";
              ballEl.textContent = "‚Ä¢";
            }
          }
        } else {
          ballEl.className += " empty";
        }
        
        ballsContainer.appendChild(ballEl);
      }
    }

    // Update player comparison
    function updatePlayerComparison() {
      if (currentBatter) {
        const batter = batterStats[currentBatter] || { runs: 0, balls: 0, fours: 0, sixes: 0 };
        const sr = batter.balls > 0 ? ((batter.runs / batter.balls) * 100).toFixed(2) : "0.00";
        
        comparisonBatterName.textContent = currentBatter;
        comparisonBatterRuns.textContent = batter.runs;
        comparisonBatterBalls.textContent = batter.balls;
        comparisonBatterSR.textContent = sr;
        comparisonBatterBoundaries.textContent = `${batter.fours}/${batter.sixes}`;
      }
      
      if (currentBowler) {
        const bowler = bowlerStats[currentBowler] || { wickets: 0, runs: 0, overs: 0 };
        const er = bowler.overs > 0 ? (bowler.runs / bowler.overs).toFixed(2) : "0.00";
        
        comparisonBowlerName.textContent = currentBowler;
        comparisonBowlerWickets.textContent = bowler.wickets;
        comparisonBowlerOvers.textContent = bowler.overs.toFixed(1);
        comparisonBowlerER.textContent = er;
        comparisonBowlerRuns.textContent = bowler.runs;
      }
    }

    // End current inning
    async function endInning() {
      disableButtons();
      
      // Prepare innings summary
      const completedOvers = Math.floor(legalBalls / 6) + ((legalBalls % 6) / 10);
      const runRate = completedOvers > 0 ? (runs / completedOvers).toFixed(2) : "0.00";
      
      summaryTotalRuns.textContent = runs;
      summaryWickets.textContent = Math.floor(wickets);
      summaryOvers.textContent = completedOvers.toFixed(1);
      summaryRunRate.textContent = runRate;
      
      if (runs >= 200) {
        summaryHighlight.textContent = "Excellent Batting Performance!";
      } else if (runs >= 150) {
        summaryHighlight.textContent = "Good Total Posted!";
      } else if (runs <= 100) {
        summaryHighlight.textContent = "Bowlers Dominated This Innings";
      } else {
        summaryHighlight.textContent = "Competitive Total";
      }
      
      // Show summary modal
      showModal(summaryModal);
      
      // Start countdown
      let timeLeft = 30;
      summaryCountdown.textContent = timeLeft;
      
      const countdownInterval = setInterval(() => {
        timeLeft--;
        summaryCountdown.textContent = timeLeft;
        
        if (timeLeft <= 0) {
          clearInterval(countdownInterval);
          saveFirstInningsAndRedirect();
        }
      }, 1000);
      
      startSecondInningsNowBtn.addEventListener("click", () => {
        clearInterval(countdownInterval);
        saveFirstInningsAndRedirect();
      }, { once: true });
    }

    // Save first innings data and redirect
    async function saveFirstInningsAndRedirect() {
      try {
        // Prepare first innings data
        const firstInningsData = {
          totalRuns: runs,
          totalWickets: Math.floor(wickets),
          balls: legalBalls,
          batterStats: batterStats,
          bowlerStats: bowlerStats,
          fallOfWickets: fallOfWickets,
          team1Name: team1NameEl.textContent,
          team2Name: team2NameEl.textContent,
          format: currentFormat.name,
          timestamp: Date.now()
        };
        
        // Save to localStorage for second innings
        localStorage.setItem("handiCricketFirstInnings", JSON.stringify(firstInningsData));
        
        // Clean up Firebase for second innings
        await Promise.all([
          set(playsRef, {}),
          set(batterRef, null),
          set(bowlerRef, null)
        ]);
        
        // Redirect to second innings
        window.location.href = `game_second_innings.html?room=${room}&player=${player}`;
      } catch (error) {
        console.error("Error saving first innings:", error);
        addCommentary("Failed to save first innings data", "error");
      }
    }

    // Save game state
    async function saveGameState() {
      try {
        resultEl.textContent = "Saving game...";
        disableButtons();
        
        const gameState = {
          runs: runs,
          wickets: Math.floor(wickets),
          legalBalls: legalBalls,
          batterStats: batterStats,
          bowlerStats: bowlerStats,
          currentBatter: currentBatter,
          currentBowler: currentBowler,
          timestamp: Date.now()
        };
        
        await set(ref(db, `rooms/${room}/savedState`), gameState);
        resultEl.textContent = "Game saved successfully!";
        setTimeout(() => window.location.href = "index.html", 2000);
      } catch (error) {
        console.error("Error saving game:", error);
        resultEl.textContent = "Error saving game. Please try again.";
        enableButtons();
      }
    }

    // Reset plays
    async function resetPlays() {
      try {
        await set(playsRef, {});
        clearCardSelection();
        enableButtons();
        addCommentary("Plays have been reset", "info");
      } catch (error) {
        console.error("Error resetting plays:", error);
        addCommentary("Failed to reset plays", "error");
      }
    }

    // Show reset confirmation
    function showResetConfirmation(requestedBy) {
      if (confirm(`${requestedBy === "player1" ? "Player 1" : "Player 2"} wants to reset plays. Accept?`)) {
        acceptReset();
      } else {
        declineReset();
      }
    }

    // Accept reset
    async function acceptReset() {
      try {
        await set(resetRequestRef, null);
        await resetPlays();
      } catch (error) {
        console.error("Error accepting reset:", error);
      }
    }

    // Decline reset
    async function declineReset() {
      try {
        await set(resetRequestRef, null);
      } catch (error) {
        console.error("Error declining reset:", error);
      }
    }

    // Add commentary
    function addCommentary(message, type = "") {
      if (commentaryPaused) return;
      
      const now = new Date();
      const timeString = now.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
      
      const commentaryItem = document.createElement("div");
      commentaryItem.className = `commentary-item ${type}`;
      commentaryItem.innerHTML = `<span class="commentary-time">${timeString}</span>${message}`;
      
      commentaryBox.insertBefore(commentaryItem, commentaryBox.firstChild);
      
      // Limit to 50 commentary items
      if (commentaryBox.children.length > 50) {
        commentaryBox.removeChild(commentaryBox.lastChild);
      }
    }

    // Show modal
    function showModal(modal) {
      modal.style.display = "flex";
    }

    // Hide modal
    function hideModal(modal) {
      modal.style.display = "none";
    }

    // Disable buttons
    function disableButtons() {
      buttons.forEach(btn => {
        btn.disabled = true;
      });
    }

    // Enable buttons
    function enableButtons() {
      if (isResetting) return;
      
      const canPlay = (isBatting && currentBatter) || (!isBatting && currentBowler);
      buttons.forEach(btn => {
        btn.disabled = !canPlay;
      });
      
      if (canPlay) {
        resultEl.textContent = isBatting ? "Select your shot" : "Select your delivery";
      }
    }

    // Update button states
    function updateButtonStates() {
      const canPlay = (isBatting && currentBatter) || (!isBatting && currentBowler);
      buttons.forEach(btn => {
        btn.disabled = !canPlay;
      });
    }

    // Highlight selected card
    function highlightSelectedCard(value) {
      buttons.forEach(btn => {
        btn.classList.toggle("selected", parseInt(btn.dataset.value) === value);
      });
    }

    // Clear card selection
    function clearCardSelection() {
      buttons.forEach(btn => {
        btn.classList.remove("selected");
      });
      selectedCardValue = null;
    }

    // Start the game
    initGame();
  </script>
</body>
</html>