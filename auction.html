<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HandiCricket - IPL 2025 Auction</title>
  <style>
    body {
      background: linear-gradient(135deg, #061e3e, #0a2a4a);
      color: white;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    h1 {
      color: #ffeb3b;
      text-shadow: 0 0 10px rgba(255, 235, 59, 0.5);
      margin-top: 0;
      text-align: center;
    }
    
    .section {
      display: none;
      margin-bottom: 20px;
    }
    
    .section.active {
      display: block;
    }
    
    .user-info {
      margin-bottom: 20px;
      padding: 15px;
      background: rgba(13, 42, 82, 0.5);
      border-radius: 10px;
    }
    
    .user-info p {
      margin: 5px 0;
    }
    
    .user-team {
      font-weight: bold;
      color: #ffeb3b;
    }
    
    .card {
      background: rgba(13, 42, 82, 0.5);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .card h2 {
      margin-top: 0;
      color: #1e88e5;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding-bottom: 8px;
    }
    
    .btn {
      padding: 10px 15px;
      border: none;
      border-radius: 8px;
      background: linear-gradient(145deg, #1e88e5, #1565c0);
      color: white;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      margin: 5px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    }
    
    .btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 10px rgba(0, 0, 0, 0.3);
    }
    
    .btn:active {
      transform: translateY(1px);
    }
    
    .btn-retain {
      background: linear-gradient(145deg, #4CAF50, #2E7D32);
    }
    
    .btn-captain {
      background: linear-gradient(145deg, #FFD700, #FFC000);
      color: #333;
    }
    
    .btn-admin {
      background: linear-gradient(145deg, #9C27B0, #7B1FA2);
    }
    
    .btn-start {
      background: linear-gradient(145deg, #FF5722, #E64A19);
    }
    
    .btn-bid {
      background: linear-gradient(145deg, #FF9800, #F57C00);
    }
    
    .btn-rtm {
      background: linear-gradient(145deg, #607D8B, #455A64);
    }
    
    .btn-pass {
      background: linear-gradient(145deg, #f44336, #d32f2f);
    }
    
    .btn-back {
      background: linear-gradient(145deg, #795548, #5D4037);
    }
    
    .btn-add {
      background: linear-gradient(145deg, #009688, #00796B);
    }
    
    .player-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin: 15px 0;
    }
    
    .player-card {
      background: rgba(30, 136, 229, 0.2);
      border-radius: 8px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.3s;
      border: 2px solid transparent;
      position: relative;
    }
    
    .player-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 10px rgba(0, 0, 0, 0.3);
    }
    
    .player-card.selected {
      border-color: #ffeb3b;
      background: rgba(255, 235, 59, 0.1);
    }
    
    .player-card.captain {
      border-color: #FFD700;
      background: rgba(255, 215, 0, 0.1);
    }
    
    .player-card h3 {
      margin: 0 0 5px 0;
      color: #ffeb3b;
    }
    
    .player-card p {
      margin: 5px 0;
      font-size: 14px;
      color: #aaa;
    }
    
    .role-badge {
      position: absolute;
      top: 8px;
      right: 8px;
      padding: 3px 6px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .batter {
      background: rgba(76, 175, 80, 0.3);
      color: #a5d6a7;
    }
    
    .bowler {
      background: rgba(244, 67, 54, 0.3);
      color: #ff8a80;
    }
    
    .pacer {
      background: rgba(244, 67, 54, 0.3);
      color: #ff8a80;
    }
    
    .spinner {
      background: rgba(156, 39, 176, 0.3);
      color: #ea80fc;
    }
    
    .allrounder {
      background: rgba(255, 152, 0, 0.3);
      color: #ffd180;
    }
    
    .wicketkeeper {
      background: rgba(0, 150, 136, 0.3);
      color: #84ffff;
    }
    
    .current-player {
      background: rgba(255, 152, 0, 0.3);
      border: 2px solid #FF9800;
      animation: pulse 2s infinite;
    }
    
    .bid-controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin: 20px 0;
    }
    
    .bid-btn {
      min-width: 80px;
    }
    
    .team-info {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    
    .team-card {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      padding: 15px;
    }
    
    .team-card h3 {
      margin-top: 0;
      color: #1e88e5;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding-bottom: 8px;
    }
    
    .team-card p {
      margin: 5px 0;
    }
    
    .budget-bar {
      height: 10px;
      background: rgba(255,255,255,0.1);
      border-radius: 5px;
      margin: 10px 0;
      overflow: hidden;
    }
    
    .budget-progress {
      height: 100%;
      background: linear-gradient(90deg, #4CAF50, #8BC34A);
      border-radius: 5px;
      transition: width 0.5s;
    }
    
    .squad-list {
      list-style: none;
      padding: 0;
      margin: 10px 0;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .squad-list li {
      padding: 5px 0;
      border-bottom: 1px dashed rgba(255,255,255,0.1);
    }
    
    .squad-list li.captain {
      color: #FFD700;
      font-weight: bold;
    }
    
    .timer {
      font-size: 24px;
      font-weight: bold;
      text-align: center;
      margin: 15px 0;
      color: #ffeb3b;
    }
    
    .input-group {
      margin-bottom: 15px;
    }
    
    .input-group label {
      display: block;
      margin-bottom: 8px;
      color: #aaa;
    }
    
    .input-group input, .input-group select, .input-group textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #1e88e5;
      border-radius: 8px;
      background: rgba(30, 136, 229, 0.1);
      color: white;
      font-size: 16px;
      box-sizing: border-box;
    }
    
    .input-group textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .modal-content {
      background: linear-gradient(135deg, #0a2a4a, #061e3e);
      border-radius: 15px;
      padding: 20px;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .modal h2 {
      margin-top: 0;
      color: #ffeb3b;
    }
    
    .close-modal {
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      color: #aaa;
      font-size: 24px;
      cursor: pointer;
    }
    
    .notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      display: none;
      max-width: 300px;
    }
    
    .notification.show {
      display: block;
      animation: slideIn 0.5s, fadeOut 0.5s 4.5s forwards;
    }
    
    .admin-controls {
      background: rgba(156, 39, 176, 0.2);
      border-radius: 10px;
      padding: 15px;
      margin: 15px 0;
      border: 1px dashed rgba(156, 39, 176, 0.5);
    }
    
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(255, 152, 0, 0.4); }
      70% { box-shadow: 0 0 0 10px rgba(255, 152, 0, 0); }
      100% { box-shadow: 0 0 0 0 rgba(255, 152, 0, 0); }
    }
    
    @keyframes slideIn {
      from { transform: translateX(100%); }
      to { transform: translateX(0); }
    }
    
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
    
    @media (max-width: 768px) {
      .player-grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      }
      
      .team-info {
        grid-template-columns: 1fr;
      }
      
      .bid-controls {
        flex-direction: column;
        align-items: center;
      }
      
      .bid-btn {
        width: 100%;
      }
    }
    
    @media (max-width: 480px) {
      .container {
        padding: 15px;
      }
      
      .player-grid {
        grid-template-columns: 1fr;
      }
      
      .btn {
        padding: 8px 12px;
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üèè IPL 2025 Auction</h1>
    
    <div class="user-info">
      <p>Team: <span id="teamDisplay" class="user-team"></span></p>
      <p>Budget: <span id="budgetDisplay">‚Çπ150 Cr</span></p>
      <p>Players: <span id="squadCount">0/25</span></p>
      <p>RTM Cards: <span id="rtmCount">0</span></p>
    </div>
    
    <!-- Retention Section -->
    <div id="retentionSection" class="section active">
      <div class="card">
        <h2>Player Retention</h2>
        <p>Retain up to 6 players from your previous squad. Captain retention costs ‚Çπ4 Cr, others cost ‚Çπ2 Cr.</p>
        <p>You'll earn RTM cards equal to 6 minus retained players.</p>
        
        <div class="player-grid" id="retentionPlayerGrid"></div>
        
        <div class="card">
          <h3>Retention Summary</h3>
          <p>Retained Players: <span id="retainedCount">0</span>/6</p>
          <p>Retention Cost: <span id="retentionCost">‚Çπ0 Cr</span></p>
          <p>Remaining Budget: <span id="remainingBudget">‚Çπ150 Cr</span></p>
          <p>RTM Cards Earned: <span id="earnedRTM">0</span></p>
          
          <button id="confirmRetentionBtn" class="btn btn-retain">Confirm Retention</button>
        </div>
      </div>
    </div>
    
    <!-- Auction Setup Section -->
    <div id="setupSection" class="section">
      <div class="card">
        <h2>Auction Room</h2>
        
        <div id="joinRoomDiv">
          <div class="input-group">
            <label for="roomCodeInput">Enter Room Code</label>
            <input type="text" id="roomCodeInput" placeholder="4-digit code" maxlength="4">
          </div>
          <button id="joinRoomBtn" class="btn">Join Room</button>
        </div>
        
        <div id="roomInfoDiv" style="display: none;">
          <p>Room Code: <strong id="roomCodeDisplay"></strong></p>
          <p>Status: <span id="roomStatus">Waiting to start</span></p>
          <p>Teams Joined: <span id="teamsJoined">0</span></p>
          
          <div id="adminControls" style="display: none;">
            <div class="admin-controls">
              <h3>Admin Controls</h3>
              
              <div class="input-group">
                <label>Add Players to Auction Pool</label>
                <select id="playerRoleSelect">
                  <option value="batter">Batter</option>
                  <option value="bowler">Bowler (Pacer)</option>
                  <option value="spinner">Bowler (Spinner)</option>
                  <option value="allrounder">All-Rounder</option>
                  <option value="wicketkeeper">Wicket-Keeper</option>
                </select>
                <input type="text" id="playerNameInput" placeholder="Player name">
                <input type="number" id="playerBasePrice" placeholder="Base price (Cr)" step="0.25" min="0.25" value="0.25">
                <button id="addPlayerBtn" class="btn btn-add">Add Player</button>
              </div>
              
              <div class="input-group">
                <label>Or bulk add players (CSV format: Name,Role,BasePrice)</label>
                <textarea id="bulkPlayersInput" placeholder="Virat Kohli,batter,2&#10;Jasprit Bumrah,bowler,1.5&#10;Rashid Khan,spinner,1.5&#10;Hardik Pandya,allrounder,2&#10;MS Dhoni,wicketkeeper,2"></textarea>
                <button id="bulkAddBtn" class="btn btn-add">Bulk Add Players</button>
              </div>
              
              <button id="startAuctionBtn" class="btn btn-start">Start Auction</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Auction Section -->
    <div id="auctionSection" class="section">
      <div class="card current-player-card" id="currentPlayerCard">
        <h2>Current Player</h2>
        <div id="currentPlayerInfo">
          <p>Waiting for auction to start...</p>
        </div>
        
        <div class="timer" id="auctionTimer">30</div>
        
        <div class="bid-controls">
          <button class="btn btn-bid bid-btn" data-increment="0.10">+0.10 Cr</button>
          <button class="btn btn-bid bid-btn" data-increment="0.25">+0.25 Cr</button>
          <button class="btn btn-bid bid-btn" data-increment="0.50">+0.50 Cr</button>
          <button class="btn btn-bid bid-btn" data-increment="1.00">+1.00 Cr</button>
          <button id="passBtn" class="btn btn-pass">Pass</button>
          <button id="rtmBtn" class="btn btn-rtm">Use RTM</button>
        </div>
      </div>
      
      <div class="card">
        <h2>Bidding History</h2>
        <div id="biddingHistory"></div>
      </div>
      
      <div class="team-info" id="teamInfoGrid"></div>
      
      <div id="adminAuctionControls" style="display: none;">
        <div class="admin-controls">
          <h3>Admin Auction Controls</h3>
          <button id="nextPlayerBtn" class="btn">Next Player</button>
          <button id="sellPlayerBtn" class="btn btn-retain">Sell Player</button>
          <button id="endAuctionBtn" class="btn btn-pass">End Auction</button>
        </div>
      </div>
    </div>
    
    <button id="backBtn" class="btn btn-back">Back to Home</button>
  </div>
  
  <!-- Player Selection Modal -->
  <div class="modal" id="playerSelectModal">
    <div class="modal-content">
      <button class="close-modal" id="closeModal">&times;</button>
      <h2>Select Next Player</h2>
      
      <div class="input-group">
        <label>Filter by Role</label>
        <select id="modalRoleFilter">
          <option value="all">All Roles</option>
          <option value="batter">Batters</option>
          <option value="bowler">Bowlers (Pacers)</option>
          <option value="spinner">Bowlers (Spinners)</option>
          <option value="allrounder">All-Rounders</option>
          <option value="wicketkeeper">Wicket-Keepers</option>
        </select>
      </div>
      
      <div class="player-grid" id="modalPlayerGrid"></div>
    </div>
  </div>
  
  <!-- Notification -->
  <div class="notification" id="notification"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getDatabase, ref, set, update, get, child, onValue, push } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCN6aZMwlsZe7JJaovU0WA3UQygWr4jYmA",
      authDomain: "handicricket-85a06.firebaseapp.com",
      projectId: "handicricket-85a06",
      storageBucket: "handicricket-85a06.appspot.com",
      messagingSenderId: "599182538558",
      appId: "1:599182538558:web:3e965753ab05f8f1e3de6f",
      measurementId: "G-HSV9H4LEJQ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    
    // DOM elements
    const teamDisplay = document.getElementById('teamDisplay');
    const budgetDisplay = document.getElementById('budgetDisplay');
    const squadCount = document.getElementById('squadCount');
    const rtmCount = document.getElementById('rtmCount');
    
    // Section elements
    const retentionSection = document.getElementById('retentionSection');
    const setupSection = document.getElementById('setupSection');
    const auctionSection = document.getElementById('auctionSection');
    
    // Retention elements
    const retentionPlayerGrid = document.getElementById('retentionPlayerGrid');
    const retainedCount = document.getElementById('retainedCount');
    const retentionCost = document.getElementById('retentionCost');
    const remainingBudget = document.getElementById('remainingBudget');
    const earnedRTM = document.getElementById('earnedRTM');
    const confirmRetentionBtn = document.getElementById('confirmRetentionBtn');
    
    // Setup elements
    const joinRoomDiv = document.getElementById('joinRoomDiv');
    const roomInfoDiv = document.getElementById('roomInfoDiv');
    const roomCodeInput = document.getElementById('roomCodeInput');
    const joinRoomBtn = document.getElementById('joinRoomBtn');
    const roomCodeDisplay = document.getElementById('roomCodeDisplay');
    const roomStatus = document.getElementById('roomStatus');
    const teamsJoined = document.getElementById('teamsJoined');
    const adminControls = document.getElementById('adminControls');
    const playerRoleSelect = document.getElementById('playerRoleSelect');
    const playerNameInput = document.getElementById('playerNameInput');
    const playerBasePrice = document.getElementById('playerBasePrice');
    const addPlayerBtn = document.getElementById('addPlayerBtn');
    const bulkPlayersInput = document.getElementById('bulkPlayersInput');
    const bulkAddBtn = document.getElementById('bulkAddBtn');
    const startAuctionBtn = document.getElementById('startAuctionBtn');
    
    // Auction elements
    const currentPlayerCard = document.getElementById('currentPlayerCard');
    const currentPlayerInfo = document.getElementById('currentPlayerInfo');
    const auctionTimer = document.getElementById('auctionTimer');
    const biddingHistory = document.getElementById('biddingHistory');
    const teamInfoGrid = document.getElementById('teamInfoGrid');
    const adminAuctionControls = document.getElementById('adminAuctionControls');
    const passBtn = document.getElementById('passBtn');
    const rtmBtn = document.getElementById('rtmBtn');
    const nextPlayerBtn = document.getElementById('nextPlayerBtn');
    const sellPlayerBtn = document.getElementById('sellPlayerBtn');
    const endAuctionBtn = document.getElementById('endAuctionBtn');
    
    // Modal elements
    const playerSelectModal = document.getElementById('playerSelectModal');
    const closeModal = document.getElementById('closeModal');
    const modalRoleFilter = document.getElementById('modalRoleFilter');
    const modalPlayerGrid = document.getElementById('modalPlayerGrid');
    
    // Notification
    const notification = document.getElementById('notification');
    
    // Back button
    const backBtn = document.getElementById('backBtn');
    
    // Global variables
    let currentUser = localStorage.getItem('hc_username');
    let currentTeam = localStorage.getItem('hc_team');
    let isAdmin = currentUser === 'imved169' && currentTeam === 'Ratnagiri Hunters';
    let roomCode = '';
    let roomRef;
    let retentionPlayers = [];
    let retainedPlayers = [];
    let retentionCaptain = null;
    let budget = 150;
    let rtmCards = 0;
    let currentPlayer = null;
    let currentBid = 0;
    let currentBidder = null;
    let timerInterval;
    let timerSeconds = 30;
    let auctionPlayers = [];
    let soldPlayers = [];
    let teams = [];
    
    // Initialize
    if (!currentUser || !currentTeam) {
      window.location.href = 'index.html';
    }
    
    teamDisplay.textContent = currentTeam;
    updateBudgetDisplay();
    
    // Load retention players from squad
    loadRetentionPlayers();
    
    // Show notification
    function showNotification(message) {
      notification.textContent = message;
      notification.classList.add('show');
      setTimeout(() => {
        notification.classList.remove('show');
      }, 5000);
    }
    
    // Update budget display
    function updateBudgetDisplay() {
      budgetDisplay.textContent = `‚Çπ${budget.toFixed(2)} Cr`;
    }
    
    // Load retention players from squad
    async function loadRetentionPlayers() {
      const userRef = ref(db, `users/${currentUser}`);
      const userSnap = await get(userRef);
      
      if (userSnap.exists()) {
        const userData = userSnap.val();
        retentionPlayers = userData.players || [];
        
        // Render retention player grid
        renderRetentionPlayers();
      }
    }
    
    // Render retention players
    function renderRetentionPlayers() {
      retentionPlayerGrid.innerHTML = '';
      
      retentionPlayers.forEach(player => {
        const isRetained = retainedPlayers.includes(player);
        const isCaptain = player === retentionCaptain;
        
        const playerCard = document.createElement('div');
        playerCard.className = `player-card ${isRetained ? 'selected' : ''} ${isCaptain ? 'captain' : ''}`;
        playerCard.innerHTML = `
          <h3>${player}</h3>
          <div class="role-badge allrounder">Previous Squad</div>
          ${isCaptain ? '<p>Captain (‚Çπ4 Cr)</p>' : isRetained ? '<p>Retained (‚Çπ2 Cr)</p>' : ''}
        `;
        
        playerCard.addEventListener('click', () => {
          if (isCaptain) {
            // Unset as captain
            retentionCaptain = null;
            const index = retainedPlayers.indexOf(player);
            if (index > -1) {
              retainedPlayers.splice(index, 1);
            }
          } else if (isRetained) {
            // Already retained - make captain if not already
            if (!retentionCaptain && retainedPlayers.length <= 5) {
              retentionCaptain = player;
            } else {
              // Just unretain
              const index = retainedPlayers.indexOf(player);
              if (index > -1) {
                retainedPlayers.splice(index, 1);
              }
            }
          } else {
            // Not retained - retain if we have space
            if (retainedPlayers.length < 6) {
              retainedPlayers.push(player);
            } else {
              showNotification('Maximum 6 players can be retained');
            }
          }
          
          renderRetentionPlayers();
          updateRetentionSummary();
        });
        
        retentionPlayerGrid.appendChild(playerCard);
      });
      
      // Add "Make Captain" button for retained players
      if (retainedPlayers.length > 0 && !retentionCaptain) {
        const captainBtn = document.createElement('button');
        captainBtn.className = 'btn btn-captain';
        captainBtn.textContent = 'Choose Captain';
        captainBtn.style.marginTop = '10px';
        captainBtn.addEventListener('click', () => {
          if (retainedPlayers.length > 0) {
            // Show modal to select captain
            showCaptainSelection();
          }
        });
        retentionPlayerGrid.appendChild(captainBtn);
      }
      
      updateRetentionSummary();
    }
    
    // Show captain selection
    function showCaptainSelection() {
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.display = 'flex';
      
      const modalContent = document.createElement('div');
      modalContent.className = 'modal-content';
      modalContent.innerHTML = `
        <h2>Select Captain</h2>
        <p>Captain retention costs ‚Çπ4 Cr (others cost ‚Çπ2 Cr)</p>
        <div class="player-grid" id="captainSelectionGrid"></div>
      `;
      
      const grid = modalContent.querySelector('#captainSelectionGrid');
      retainedPlayers.forEach(player => {
        const playerCard = document.createElement('div');
        playerCard.className = 'player-card';
        playerCard.innerHTML = `<h3>${player}</h3>`;
        
        playerCard.addEventListener('click', () => {
          retentionCaptain = player;
          modal.remove();
          renderRetentionPlayers();
          updateRetentionSummary();
        });
        
        grid.appendChild(playerCard);
      });
      
      const closeBtn = document.createElement('button');
      closeBtn.className = 'btn btn-back';
      closeBtn.textContent = 'Cancel';
      closeBtn.style.marginTop = '15px';
      closeBtn.addEventListener('click', () => modal.remove());
      
      modalContent.appendChild(closeBtn);
      modal.appendChild(modalContent);
      document.body.appendChild(modal);
    }
    
    // Update retention summary
    function updateRetentionSummary() {
      const captainCost = retentionCaptain ? 4 : 0;
      const otherPlayersCost = (retainedPlayers.length - (retentionCaptain ? 1 : 0)) * 2;
      const totalCost = captainCost + otherPlayersCost;
      
      retainedCount.textContent = `${retainedPlayers.length}/6`;
      retentionCost.textContent = `‚Çπ${totalCost} Cr`;
      remainingBudget.textContent = `‚Çπ${(budget - totalCost).toFixed(2)} Cr`;
      
      // Calculate RTM cards (6 - retained players)
      const earnedRTMCards = 6 - retainedPlayers.length;
      earnedRTM.textContent = earnedRTMCards;
    }
    
    // Confirm retention
    confirmRetentionBtn.addEventListener('click', async () => {
      if (retainedPlayers.length === 0) {
        showNotification('You must retain at least 1 player or click "Skip Retention"');
        return;
      }
      
      try {
        const userRef = ref(db, `users/${currentUser}`);
        
        // Calculate costs
        const captainCost = retentionCaptain ? 4 : 0;
        const otherPlayersCost = (retainedPlayers.length - (retentionCaptain ? 1 : 0)) * 2;
        const totalCost = captainCost + otherPlayersCost;
        
        // Update user data
        await update(userRef, {
          retainedPlayers: retainedPlayers,
          retentionCaptain: retentionCaptain,
          budget: budget - totalCost,
          rtmCards: 6 - retainedPlayers.length
        });
        
        // Update local variables
        budget -= totalCost;
        rtmCards = 6 - retainedPlayers.length;
        updateBudgetDisplay();
        rtmCount.textContent = rtmCards;
        
        // Move to setup section
        retentionSection.classList.remove('active');
        setupSection.classList.add('active');
        
        // If admin, show notification to go to squad.html
        if (isAdmin) {
          showNotification('Admin: Please visit squad.html to retain players for your team first');
        }
      } catch (error) {
        console.error('Error confirming retention:', error);
        showNotification('Failed to save retention. Please try again.');
      }
    });
    
    // Join room
    joinRoomBtn.addEventListener('click', async () => {
      const code = roomCodeInput.value.trim();
      
      if (!code || code.length !== 4 || isNaN(code)) {
        showNotification('Please enter a valid 4-digit room code');
        return;
      }
      
      roomCode = code;
      roomRef = ref(db, `auctionRooms/${roomCode}`);
      
      // Check if room exists
      const roomSnap = await get(roomRef);
      
      if (!roomSnap.exists()) {
        if (isAdmin) {
          // Admin can create new room
          if (confirm('Room not found. Create new auction room?')) {
            await setupNewRoom();
          } else {
            return;
          }
        } else {
          showNotification('Room not found. Please check the code.');
          return;
        }
      } else {
        // Join existing room
        await joinExistingRoom();
      }
      
      // Set up room listeners
      setupRoomListeners();
    });
    
    // Set up new room (admin only)
    async function setupNewRoom() {
      try {
        await set(roomRef, {
          admin: currentUser,
          adminTeam: currentTeam,
          status: 'setup',
          teams: {
            [currentTeam]: {
              name: currentTeam,
              budget: budget,
              players: [],
              rtmCards: rtmCards
            }
          },
          players: {},
          currentPlayer: null,
          biddingHistory: []
        });
        
        joinRoomDiv.style.display = 'none';
        roomInfoDiv.style.display = 'block';
        roomCodeDisplay.textContent = roomCode;
        roomStatus.textContent = 'Setup - Waiting for players';
        teamsJoined.textContent = '1';
        
        if (isAdmin) {
          adminControls.style.display = 'block';
        }
      } catch (error) {
        console.error('Error creating room:', error);
        showNotification('Failed to create room. Please try again.');
      }
    }
    
    // Join existing room
    async function joinExistingRoom() {
      try {
        // Check if team already joined
        const roomSnap = await get(roomRef);
        const roomData = roomSnap.val();
        
        if (roomData.teams && roomData.teams[currentTeam]) {
          showNotification('Your team has already joined this room');
          return;
        }
        
        // Add team to room
        await update(ref(db, `auctionRooms/${roomCode}/teams`), {
          [currentTeam]: {
            name: currentTeam,
            budget: budget,
            players: [],
            rtmCards: rtmCards
          }
        });
        
        joinRoomDiv.style.display = 'none';
        roomInfoDiv.style.display = 'block';
        roomCodeDisplay.textContent = roomCode;
        roomStatus.textContent = roomData.status === 'active' ? 'Auction Active' : 'Waiting to start';
        
        // Update teams count
        const teamsCount = roomData.teams ? Object.keys(roomData.teams).length + 1 : 1;
        teamsJoined.textContent = teamsCount.toString();
        
        if (isAdmin && roomData.admin === currentUser) {
          adminControls.style.display = 'block';
        }
      } catch (error) {
        console.error('Error joining room:', error);
        showNotification('Failed to join room. Please try again.');
      }
    }
    
    // Set up room listeners
    function setupRoomListeners() {
      onValue(roomRef, (snap) => {
        if (!snap.exists()) return;
        
        const roomData = snap.val();
        
        // Update room status
        roomStatus.textContent = roomData.status === 'active' ? 'Auction Active' : 'Waiting to start';
        
        // Update teams count
        if (roomData.teams) {
          teamsJoined.textContent = Object.keys(roomData.teams).length.toString();
        }
        
        // If auction is active, move to auction section
        if (roomData.status === 'active') {
          setupSection.classList.remove('active');
          auctionSection.classList.add('active');
          
          // Set up auction data
          currentPlayer = roomData.currentPlayer;
          currentBid = roomData.currentBid || 0;
          currentBidder = roomData.currentBidder;
          auctionPlayers = roomData.players ? Object.values(roomData.players) : [];
          soldPlayers = roomData.soldPlayers ? Object.values(roomData.soldPlayers) : [];
          teams = roomData.teams ? Object.values(roomData.teams) : [];
          
          // Update UI
          updateAuctionUI();
          
          // Start timer if needed
          if (roomData.timerSeconds && !timerInterval) {
            startTimer(roomData.timerSeconds);
          }
        }
        
        // Show admin controls if admin
        if (isAdmin && roomData.admin === currentUser) {
          adminControls.style.display = 'block';
          
          if (roomData.status === 'active') {
            adminAuctionControls.style.display = 'block';
          }
        }
      });
    }
    
    // Add player to auction pool
    addPlayerBtn.addEventListener('click', async () => {
      const name = playerNameInput.value.trim();
      const role = playerRoleSelect.value;
      const basePrice = parseFloat(playerBasePrice.value);
      
      if (!name) {
        showNotification('Please enter player name');
        return;
      }
      
      if (isNaN(basePrice) {
        showNotification('Please enter valid base price');
        return;
      }
      
      try {
        const playerId = name.toLowerCase().replace(/\s+/g, '_');
        
        await set(ref(db, `auctionRooms/${roomCode}/players/${playerId}`), {
          name: name,
          role: role,
          basePrice: basePrice,
          status: 'unsold'
        });
        
        playerNameInput.value = '';
        playerBasePrice.value = '0.25';
        showNotification(`${name} added to auction pool`);
      } catch (error) {
        console.error('Error adding player:', error);
        showNotification('Failed to add player. Please try again.');
      }
    });
    
    // Bulk add players
    bulkAddBtn.addEventListener('click', async () => {
      const input = bulkPlayersInput.value.trim();
      if (!input) {
        showNotification('Please enter players data');
        return;
      }
      
      const lines = input.split('\n');
      const players = [];
      
      for (const line of lines) {
        const parts = line.split(',');
        if (parts.length >= 2) {
          const name = parts[0].trim();
          const role = parts[1].trim();
          const basePrice = parts.length >= 3 ? parseFloat(parts[2].trim()) : 0.25;
          
          if (name && role && !isNaN(basePrice)) {
            players.push({
              name: name,
              role: role,
              basePrice: basePrice
            });
          }
        }
      }
      
      if (players.length === 0) {
        showNotification('No valid players found in input');
        return;
      }
      
      try {
        const updates = {};
        
        players.forEach(player => {
          const playerId = player.name.toLowerCase().replace(/\s+/g, '_');
          updates[`players/${playerId}`] = {
            name: player.name,
            role: player.role,
            basePrice: player.basePrice,
            status: 'unsold'
          };
        });
        
        await update(ref(db, `auctionRooms/${roomCode}`), updates);
        showNotification(`Added ${players.length} players to auction pool`);
        bulkPlayersInput.value = '';
      } catch (error) {
        console.error('Error bulk adding players:', error);
        showNotification('Failed to add players. Please try again.');
      }
    });
    
    // Start auction
    startAuctionBtn.addEventListener('click', async () => {
      // Check if there are players to auction
      const playersSnap = await get(ref(db, `auctionRooms/${roomCode}/players`));
      
      if (!playersSnap.exists() || Object.keys(playersSnap.val()).length === 0) {
        showNotification('Add at least one player to start auction');
        return;
      }
      
      // Check if there are teams
      const teamsSnap = await get(ref(db, `auctionRooms/${roomCode}/teams`));
      
      if (!teamsSnap.exists() || Object.keys(teamsSnap.val()).length < 2) {
        showNotification('Need at least 2 teams to start auction');
        return;
      }
      
      try {
        // Update room status to active
        await update(ref(db, `auctionRooms/${roomCode}`), {
          status: 'active'
        });
        
        showNotification('Auction started!');
      } catch (error) {
        console.error('Error starting auction:', error);
        showNotification('Failed to start auction. Please try again.');
      }
    });
    
    // Update auction UI
    function updateAuctionUI() {
      // Update current player
      if (currentPlayer) {
        currentPlayerInfo.innerHTML = `
          <h3>${currentPlayer.name}</h3>
          <p>Role: <span class="${currentPlayer.role}">${formatRole(currentPlayer.role)}</span></p>
          <p>Base Price: ‚Çπ${currentPlayer.basePrice} Cr</p>
          <p>Current Bid: ‚Çπ${currentBid.toFixed(2)} Cr ${currentBidder ? `by ${currentBidder}` : ''}</p>
        `;
        currentPlayerCard.classList.add('current-player');
      } else {
        currentPlayerInfo.innerHTML = '<p>Waiting for next player...</p>';
        currentPlayerCard.classList.remove('current-player');
      }
      
      // Update bidding history
      updateBiddingHistory();
      
      // Update team info
      updateTeamInfo();
      
      // Update RTM button state
      rtmBtn.disabled = !canUseRTM();
    }
    
    // Format role for display
    function formatRole(role) {
      switch (role) {
        case 'batter': return 'Batter';
        case 'bowler': return 'Bowler (Pacer)';
        case 'spinner': return 'Bowler (Spinner)';
        case 'allrounder': return 'All-Rounder';
        case 'wicketkeeper': return 'Wicket-Keeper';
        default: return role;
      }
    }
    
    // Update bidding history
    function updateBiddingHistory() {
      const roomRef = ref(db, `auctionRooms/${roomCode}`);
      onValue(child(roomRef, 'biddingHistory'), (snap) => {
        if (!snap.exists()) {
          biddingHistory.innerHTML = '<p>No bidding history yet</p>';
          return;
        }
        
        const history = snap.val();
        biddingHistory.innerHTML = '';
        
        history.forEach((item, index) => {
          const div = document.createElement('div');
          div.style.marginBottom = '8px';
          div.style.padding = '8px';
          div.style.background = index % 2 === 0 ? 'rgba(255,255,255,0.05)' : 'rgba(255,255,255,0.1)';
          div.style.borderRadius = '4px';
          
          if (item.type === 'bid') {
            div.innerHTML = `<strong>${item.team}</strong> bid ‚Çπ${item.amount.toFixed(2)} Cr for ${item.player}`;
          } else if (item.type === 'sold') {
            div.innerHTML = `<strong>SOLD:</strong> ${item.player} to ${item.team} for ‚Çπ${item.amount.toFixed(2)} Cr`;
          } else if (item.type === 'rtm') {
            div.innerHTML = `<strong>RTM:</strong> ${item.team} used RTM card to match ‚Çπ${item.amount.toFixed(2)} Cr for ${item.player}`;
          } else if (item.type === 'pass') {
            div.innerHTML = `<strong>${item.team}</strong> passed on ${item.player}`;
          }
          
          biddingHistory.appendChild(div);
        });
      });
    }
    
    // Update team info
    function updateTeamInfo() {
      const roomRef = ref(db, `auctionRooms/${roomCode}`);
      onValue(child(roomRef, 'teams'), (snap) => {
        if (!snap.exists()) return;
        
        const teamsData = snap.val();
        teamInfoGrid.innerHTML = '';
        
        Object.entries(teamsData).forEach(([teamId, team]) => {
          const teamCard = document.createElement('div');
          teamCard.className = 'team-card';
          
          const spent = team.players ? team.players.reduce((sum, p) => sum + p.price, 0) : 0;
          const budgetPercent = (spent / 150) * 100;
          
          teamCard.innerHTML = `
            <h3>${team.name} ${teamId === currentTeam ? '(Your Team)' : ''}</h3>
            <p>Budget: ‚Çπ${(team.budget || 150).toFixed(2)} Cr remaining</p>
            <div class="budget-bar">
              <div class="budget-progress" style="width: ${budgetPercent}%"></div>
            </div>
            <p>Players: ${team.players ? team.players.length : 0}/25</p>
            <p>RTM Cards: ${team.rtmCards || 0}</p>
            <h4>Squad:</h4>
            <ul class="squad-list">
              ${team.players ? team.players.map(p => 
                `<li ${p.isCaptain ? 'class="captain"' : ''}>${p.name} (‚Çπ${p.price.toFixed(2)} Cr)</li>`
              ).join('') : '<li>No players yet</li>'}
            </ul>
          `;
          
          teamInfoGrid.appendChild(teamCard);
        });
      });
    }
    
    // Start timer
    function startTimer(seconds) {
      clearInterval(timerInterval);
      timerSeconds = seconds;
      auctionTimer.textContent = timerSeconds;
      
      timerInterval = setInterval(() => {
        timerSeconds--;
        auctionTimer.textContent = timerSeconds;
        
        if (timerSeconds <= 0) {
          clearInterval(timerInterval);
          // Auto-sell if admin
          if (isAdmin) {
            sellPlayer();
          }
        }
      }, 1000);
    }
    
    // Place bid
    function placeBid(increment) {
      if (!currentPlayer || !currentTeam) return;
      
      const newBid = currentBid + increment;
      
      // Check if team has enough budget
      const teamRef = ref(db, `auctionRooms/${roomCode}/teams/${currentTeam}`);
      get(teamRef).then((snap) => {
        if (snap.exists()) {
          const team = snap.val();
          
          if (newBid > team.budget) {
            showNotification('Not enough budget for this bid');
            return;
          }
          
          // Update bid
          update(ref(db, `auctionRooms/${roomCode}`), {
            currentBid: newBid,
            currentBidder: currentTeam,
            timerSeconds: 30 // Reset timer
          });
          
          // Add to bidding history
          const historyRef = push(ref(db, `auctionRooms/${roomCode}/biddingHistory`));
          set(historyRef, {
            type: 'bid',
            team: currentTeam,
            player: currentPlayer.name,
            amount: newBid,
            timestamp: Date.now()
          });
          
          // Start/reset timer
          startTimer(30);
        }
      });
    }
    
    // Pass on player
    passBtn.addEventListener('click', () => {
      if (!currentPlayer) return;
      
      // Add to bidding history
      const historyRef = push(ref(db, `auctionRooms/${roomCode}/biddingHistory`));
      set(historyRef, {
        type: 'pass',
        team: currentTeam,
        player: currentPlayer.name,
        timestamp: Date.now()
      });
    });
    
    // Use RTM card
    rtmBtn.addEventListener('click', () => {
      if (!currentPlayer || !canUseRTM()) return;
      
      // Check if player was in previous squad
      if (!retentionPlayers.includes(currentPlayer.name)) {
        showNotification('This player was not in your previous squad');
        return;
      }
      
      // Check if already retained
      if (retainedPlayers.includes(currentPlayer.name)) {
        showNotification('This player is already retained');
        return;
      }
      
      if (confirm(`Use RTM card to match ‚Çπ${currentBid.toFixed(2)} Cr for ${currentPlayer.name}?`)) {
        // Update team data
        update(ref(db, `auctionRooms/${roomCode}/teams/${currentTeam}`), {
          rtmCards: rtmCards - 1,
          budget: budget - currentBid,
          players: push().set({
            name: currentPlayer.name,
            price: currentBid,
            role: currentPlayer.role,
            isCaptain: false
          })
        });
        
        // Add to bidding history
        const historyRef = push(ref(db, `auctionRooms/${roomCode}/biddingHistory`));
        set(historyRef, {
          type: 'rtm',
          team: currentTeam,
          player: currentPlayer.name,
          amount: currentBid,
          timestamp: Date.now()
        });
        
        // Mark player as sold
        update(ref(db, `auctionRooms/${roomCode}/players/${currentPlayer.id}`), {
          status: 'sold'
        });
        
        // Update local variables
        rtmCards--;
        budget -= currentBid;
        rtmCount.textContent = rtmCards;
        updateBudgetDisplay();
        
        // Reset current player
        update(ref(db, `auctionRooms/${roomCode}`), {
          currentPlayer: null,
          currentBid: 0,
          currentBidder: null,
          timerSeconds: 0
        });
      }
    });
    
    // Check if can use RTM
    function canUseRTM() {
      return rtmCards > 0 && 
             currentPlayer && 
             currentBidder && 
             currentBidder !== currentTeam &&
             retentionPlayers.includes(currentPlayer.name) &&
             !retainedPlayers.includes(currentPlayer.name);
    }
    
    // Admin - next player
    nextPlayerBtn.addEventListener('click', () => {
      playerSelectModal.style.display = 'flex';
      loadModalPlayers();
    });
    
    // Close modal
    closeModal.addEventListener('click', () => {
      playerSelectModal.style.display = 'none';
    });
    
    // Load players for modal
    function loadModalPlayers() {
      const roleFilter = modalRoleFilter.value;
      modalPlayerGrid.innerHTML = '';
      
      auctionPlayers
        .filter(player => player.status === 'unsold')
        .filter(player => roleFilter === 'all' || player.role === roleFilter)
        .forEach(player => {
          const playerCard = document.createElement('div');
          playerCard.className = 'player-card';
          playerCard.innerHTML = `
            <h3>${player.name}</h3>
            <p>Role: <span class="${player.role}">${formatRole(player.role)}</span></p>
            <p>Base Price: ‚Çπ${player.basePrice} Cr</p>
          `;
          
          playerCard.addEventListener('click', () => {
            // Set as current player
            update(ref(db, `auctionRooms/${roomCode}`), {
              currentPlayer: {
                id: player.name.toLowerCase().replace(/\s+/g, '_'),
                ...player
              },
              currentBid: player.basePrice,
              currentBidder: null,
              timerSeconds: 30
            });
            
            playerSelectModal.style.display = 'none';
            startTimer(30);
          });
          
          modalPlayerGrid.appendChild(playerCard);
        });
    }
    
    // Role filter change
    modalRoleFilter.addEventListener('change', loadModalPlayers);
    
    // Admin - sell player
    sellPlayerBtn.addEventListener('click', sellPlayer);
    
    function sellPlayer() {
      if (!currentPlayer || !currentBidder) {
        showNotification('No active bid to sell');
        return;
      }
      
      // Update team data
      update(ref(db, `auctionRooms/${roomCode}/teams/${currentBidder}`), {
        budget: budget - currentBid,
        players: push().set({
          name: currentPlayer.name,
          price: currentBid,
          role: currentPlayer.role,
          isCaptain: false
        })
      });
      
      // Add to bidding history
      const historyRef = push(ref(db, `auctionRooms/${roomCode}/biddingHistory`));
      set(historyRef, {
        type: 'sold',
        team: currentBidder,
        player: currentPlayer.name,
        amount: currentBid,
        timestamp: Date.now()
      });
      
      // Mark player as sold
      update(ref(db, `auctionRooms/${roomCode}/players/${currentPlayer.id}`), {
        status: 'sold'
      });
      
      // Reset current player
      update(ref(db, `auctionRooms/${roomCode}`), {
        currentPlayer: null,
        currentBid: 0,
        currentBidder: null,
        timerSeconds: 0
      });
      
      clearInterval(timerInterval);
    }
    
    // Admin - end auction
    endAuctionBtn.addEventListener('click', () => {
      if (confirm('End the auction? This cannot be undone.')) {
        update(ref(db, `auctionRooms/${roomCode}`), {
          status: 'completed'
        });
        
        showNotification('Auction ended!');
      }
    });
    
    // Bid buttons
    document.querySelectorAll('.bid-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const increment = parseFloat(btn.dataset.increment);
        placeBid(increment);
      });
    });
    
    // Back button
    backBtn.addEventListener('click', () => {
      window.location.href = 'index.html';
    });
    
    // Skip retention (for testing)
    document.addEventListener('keydown', (e) => {
      if (e.key === 's' && e.ctrlKey && retentionSection.classList.contains('active')) {
        if (confirm('Skip retention phase?')) {
          retentionSection.classList.remove('active');
          setupSection.classList.add('active');
        }
      }
    });
  </script>
</body>
</html>