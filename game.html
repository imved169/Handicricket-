<!DOCTYPE html>
<html lang="en">
<head>
  <!-- [Previous head content remains exactly the same] -->
</head>
<body>
  <!-- [Previous body content remains exactly the same until script section] -->

  <script type="module">
    // [Previous imports and firebase config remains the same]

    // Game state variables
    let innings = 1; // 1 = first innings, 2 = second innings
    let team1Score = 0;
    let team2Score = 0;
    let currentBattingTeam = "player1";
    let currentBowlingTeam = "player2";

    // Powerplay and wicket calculation logic
    function calculateWicketValue() {
      if (isTestMatch) return 1;

      const batter = currentBatter;
      const remainingLives = batterLives[batter] || currentFormat.livesPerPlayer;

      // ODI Format
      if (currentFormat.name === "ODI") {
        if (isPowerplay) {
          // 0.25 wickets per life during powerplay
          return Math.min(0.25, remainingLives * 0.25);
        } else {
          // 0.5 wickets per life otherwise
          return Math.min(0.5, remainingLives * 0.5);
        }
      }
      // T20/10-over/5-over formats
      else {
        if (isPowerplay) {
          // 0.5 wickets per life during powerplay
          return Math.min(0.5, remainingLives * 0.5);
        } else {
          // 1 wicket per life otherwise
          return Math.min(1, remainingLives * 1);
        }
      }
    }

    // Innings switching logic
    async function endInning() {
      if (innings === 1) {
        // Save first innings score
        team1Score = currentInningRuns;
        team1Wickets = wickets;

        if (isTestMatch && team1Score - team2Score >= 200) {
          // Test match follow-on logic
          status.innerText = `Team 1 can enforce follow-on (lead of ${team1Score - team2Score})`;
          followOnBtn.style.display = "block";
          await set(ref(db, `rooms/${room}/followOn`), true);
        } else {
          // Switch to second innings
          innings = 2;
          resetInning();
        }
      } else {
        // End of match
        team2Score = currentInningRuns;
        team2Wickets = wickets;
        endMatch();
      }
    }

    function resetInning() {
      // Reset temporary inning values
      runs = 0;
      wickets = 0;
      currentInningRuns = 0;
      currentInningWickets = 0;
      legalBalls = 0;
      oversToday = 0;
      battersUsed = [];
      freeHit = false;

      // Switch batting and bowling teams
      [currentBattingTeam, currentBowlingTeam] = [currentBowlingTeam, currentBattingTeam];
      isBatting = !isBatting;

      // Update UI
      updateScoreboard();

      if (isBatting) {
        showBatterSelection();
      } else {
        showBowlerSelection();
      }
    }

    // [Rest of the original code remains exactly the same]
  </script>
</body>
</html>
