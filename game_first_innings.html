<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HandiCricket - Match In Progress</title>
  <style>
    body {
      background: linear-gradient(135deg, #061e3e, #0a2a4a);
      color: white;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      text-align: center;
      padding: 15px;
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    
    .container {
      width: 95%;
      max-width: 500px;
      margin: 0 auto;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    h1 {
      color: #ffeb3b;
      text-shadow: 0 0 8px rgba(255, 235, 59, 0.5);
      margin-bottom: 15px;
      font-size: 1.6rem;
    }
    
    .match-info {
      background: rgba(13, 42, 82, 0.5);
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 15px;
      font-size: 14px;
    }
    
    .scoreboard {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin: 15px 0;
    }
    
    .team-score {
      background: rgba(13, 42, 82, 0.8);
      border-radius: 10px;
      padding: 12px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .team-score h2 {
      margin: 0 0 8px 0;
      color: #ffeb3b;
      font-size: 1.1rem;
    }
    
    .score-display {
      font-size: 1.8rem;
      font-weight: bold;
      margin: 5px 0;
    }
    
    .overs-display {
      font-size: 0.9rem;
      color: #aaa;
    }
    
    .current-status {
      margin: 15px 0;
      padding: 10px;
      background: rgba(255, 235, 59, 0.2);
      border-radius: 8px;
      font-size: 1rem;
    }
    
    .action-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin: 15px 0;
    }
    
    .action-btn {
      padding: 12px;
      border: none;
      border-radius: 8px;
      background: linear-gradient(145deg, #1e88e5, #1565c0);
      color: white;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    }
    
    .action-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 10px rgba(0, 0, 0, 0.3);
    }
    
    .action-btn:active {
      transform: translateY(1px);
    }
    
    .action-btn.run {
      background: linear-gradient(145deg, #4CAF50, #2E7D32);
    }
    
    .action-btn.wicket {
      background: linear-gradient(145deg, #f44336, #d32f2f);
    }
    
    .action-btn.wide {
      background: linear-gradient(145deg, #FF9800, #F57C00);
    }
    
    .action-btn.no-ball {
      background: linear-gradient(145deg, #9C27B0, #7B1FA2);
    }
    
    .action-btn.dot {
      background: linear-gradient(145deg, #607D8B, #455A64);
    }
    
    .batsman-stats, .bowler-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin: 10px 0;
      text-align: left;
      font-size: 0.9rem;
    }
    
    .player-card {
      background: rgba(30, 136, 229, 0.2);
      padding: 8px;
      border-radius: 6px;
      margin: 5px 0;
    }
    
    .player-card h3 {
      margin: 0 0 5px 0;
      font-size: 1rem;
      color: #ffeb3b;
    }
    
    .player-card p {
      margin: 3px 0;
      display: flex;
      justify-content: space-between;
    }
    
    .player-card span {
      font-weight: bold;
    }
    
    .captain-badge {
      font-size: 10px;
      margin-left: 5px;
      padding: 1px 3px;
      border-radius: 3px;
      background: gold;
      color: black;
    }
    
    .vice-badge {
      font-size: 10px;
      margin-left: 5px;
      padding: 1px 3px;
      border-radius: 3px;
      background: silver;
      color: black;
    }
    
    .commentary {
      margin: 15px 0;
      padding: 10px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      max-height: 150px;
      overflow-y: auto;
      text-align: left;
      font-size: 0.9rem;
    }
    
    .commentary p {
      margin: 5px 0;
      padding: 3px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .commentary p:last-child {
      border-bottom: none;
    }
    
    .highlight {
      color: #ffeb3b;
      font-weight: bold;
    }
    
    .loading-spinner {
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 2px solid #1e88e5;
      width: 18px;
      height: 18px;
      animation: spin 1s linear infinite;
      margin: 8px auto;
    }
    
    .modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 350px;
      background: linear-gradient(145deg, #123456, #0a1f3a);
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.1);
      z-index: 100;
      display: none;
    }
    
    .modal h2 {
      margin-top: 0;
      color: #ffeb3b;
      border-bottom: 2px solid #1e88e5;
      padding-bottom: 6px;
    }
    
    .modal-content {
      margin: 10px 0;
    }
    
    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    
    .modal-actions button {
      flex: 1;
      padding: 8px;
      margin: 0;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @media (max-width: 480px) {
      .container {
        padding: 12px;
      }
      
      h1 {
        font-size: 1.4rem;
      }
      
      .action-buttons {
        grid-template-columns: 1fr;
      }
      
      .action-btn {
        padding: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 id="inningsTitle">First Innings</h1>
    
    <div class="match-info">
      <p>Match: <span id="team1Name">Team A</span> vs <span id="team2Name">Team B</span></p>
      <p>Format: <span id="matchFormat">T20 (20 Overs)</span></p>
      <p id="targetDisplay" style="display: none;">Target: <span id="targetScore">0</span> runs</p>
    </div>
    
    <div class="scoreboard">
      <div class="team-score">
        <h2 id="battingTeamName">Batting Team</h2>
        <div class="score-display"><span id="battingRuns">0</span>/<span id="battingWickets">0</span></div>
        <div class="overs-display">Overs: <span id="battingOvers">0.0</span></div>
      </div>
      
      <div class="team-score">
        <h2 id="bowlingTeamName">Bowling Team</h2>
        <div class="score-display"><span id="bowlingWickets">0</span> wkts</div>
        <div class="overs-display">Econ: <span id="bowlingEcon">0.00</span></div>
      </div>
    </div>
    
    <div class="current-status" id="currentStatus">
      <div class="loading-spinner"></div>
      <p>Initializing match...</p>
    </div>
    
    <div id="actionControls" style="display: none;">
      <div class="batsman-stats">
        <div class="player-card">
          <h3>Batsman 1 <span id="batsman1CaptainBadge" class="captain-badge" style="display: none;">C</span></h3>
          <p><span id="batsman1Name">Player 1</span>: <span id="batsman1Runs">0</span> (<span id="batsman1Balls">0</span>)</p>
          <p>SR: <span id="batsman1SR">0.00</span></p>
        </div>
        
        <div class="player-card">
          <h3>Batsman 2 <span id="batsman2CaptainBadge" class="captain-badge" style="display: none;">C</span></h3>
          <p><span id="batsman2Name">Player 2</span>: <span id="batsman2Runs">0</span> (<span id="batsman2Balls">0</span>)</p>
          <p>SR: <span id="batsman2SR">0.00</span></p>
        </div>
      </div>
      
      <div class="bowler-stats">
        <div class="player-card">
          <h3>Current Bowler <span id="bowlerCaptainBadge" class="captain-badge" style="display: none;">C</span></h3>
          <p><span id="bowlerName">Player 3</span>: <span id="bowlerOvers">0.0</span>-<span id="bowlerMaidens">0</span>-<span id="bowlerRuns">0</span>-<span id="bowlerWickets">0</span></p>
          <p>Econ: <span id="bowlerEcon">0.00</span></p>
        </div>
      </div>
      
      <div class="action-buttons">
        <button class="action-btn run" id="run0Btn">0 (Dot)</button>
        <button class="action-btn run" id="run1Btn">1 Run</button>
        <button class="action-btn run" id="run2Btn">2 Runs</button>
        <button class="action-btn run" id="run3Btn">3 Runs</button>
        <button class="action-btn run" id="run4Btn">4 Runs</button>
        <button class="action-btn run" id="run6Btn">6 Runs</button>
        <button class="action-btn wicket" id="wicketBtn">Wicket</button>
        <button class="action-btn wide" id="wideBtn">Wide</button>
        <button class="action-btn no-ball" id="noBallBtn">No Ball</button>
      </div>
    </div>
    
    <div class="commentary" id="commentary">
      <p>Match about to begin...</p>
    </div>
    
    <button id="endInningsBtn" class="action-btn" style="display: none; width: 100%; background: linear-gradient(145deg, #f44336, #d32f2f);">End Innings</button>
  </div>

  <!-- Wicket Modal -->
  <div id="wicketModal" class="modal">
    <h2>Wicket Fallen!</h2>
    <div class="modal-content">
      <p>Select how the wicket fell:</p>
      <select id="wicketType" style="width: 100%; padding: 8px; margin: 8px 0; border-radius: 5px; background: rgba(255,255,255,0.9);">
        <option value="bowled">Bowled</option>
        <option value="caught">Caught</option>
        <option value="lbw">LBW</option>
        <option value="run out">Run Out</option>
        <option value="stumped">Stumped</option>
        <option value="hit wicket">Hit Wicket</option>
      </select>
      <p style="margin-top: 10px;">New Batsman:</p>
      <select id="newBatsman" style="width: 100%; padding: 8px; margin: 8px 0; border-radius: 5px; background: rgba(255,255,255,0.9);">
        <option value="">Select new batsman</option>
      </select>
    </div>
    <div class="modal-actions">
      <button id="confirmWicketBtn" style="background: linear-gradient(145deg, #4CAF50, #2E7D32);">Confirm</button>
      <button id="cancelWicketBtn" style="background: linear-gradient(145deg, #607D8B, #455A64);">Cancel</button>
    </div>
  </div>

  <!-- Bowler Change Modal -->
  <div id="bowlerModal" class="modal">
    <h2>Change Bowler</h2>
    <div class="modal-content">
      <p>Select new bowler:</p>
      <select id="newBowler" style="width: 100%; padding: 8px; margin: 8px 0; border-radius: 5px; background: rgba(255,255,255,0.9);">
        <option value="">Select new bowler</option>
      </select>
    </div>
    <div class="modal-actions">
      <button id="confirmBowlerBtn" style="background: linear-gradient(145deg, #4CAF50, #2E7D32);">Confirm</button>
      <button id="cancelBowlerBtn" style="background: linear-gradient(145deg, #607D8B, #455A64);">Cancel</button>
    </div>
  </div>

  <!-- Innings End Modal -->
  <div id="inningsEndModal" class="modal">
    <h2 id="inningsEndTitle">Innings Complete</h2>
    <div class="modal-content" id="inningsEndContent">
      <p>First innings has ended. <span id="inningsTotal">0/0</span> in <span id="inningsOvers">0.0</span> overs.</p>
    </div>
    <div class="modal-actions">
      <button id="continueToSecondInningsBtn" style="background: linear-gradient(145deg, #4CAF50, #2E7D32);">Continue to 2nd Innings</button>
    </div>
  </div>

  <!-- Match End Modal -->
  <div id="matchEndModal" class="modal">
    <h2 id="matchEndTitle">Match Complete</h2>
    <div class="modal-content" id="matchEndContent">
      <p>Loading match result...</p>
    </div>
    <div class="modal-actions">
      <button id="viewSummaryBtn" style="background: linear-gradient(145deg, #1e88e5, #1565c0);">View Summary</button>
      <button id="backToHomeBtn" style="background: linear-gradient(145deg, #607D8B, #455A64);">Back to Home</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, get } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCN6aZMwlsZe7JJaovU0WA3UQygWr4jYmA",
      authDomain: "handicricket-85a06.firebaseapp.com",
      projectId: "handicricket-85a06",
      storageBucket: "handicricket-85a06.appspot.com",
      messagingSenderId: "599182538558",
      appId: "1:599182538558:web:3e965753ab05f8f1e3de6f",
      measurementId: "G-HSV9H4LEJQ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const params = new URLSearchParams(window.location.search);
    const roomId = params.get('room');
    const playerRole = params.get('player');
    const isSpectator = playerRole === 'spectator';

    if (!roomId) {
      alert('Invalid room ID');
      window.location.href = 'index.html';
    }

    const roomRef = ref(db, `rooms/${roomId}`);
    const matchRef = ref(db, `rooms/${roomId}/match`);
    const commentaryRef = ref(db, `rooms/${roomId}/commentary`);

    // DOM elements
    const inningsTitle = document.getElementById('inningsTitle');
    const team1Name = document.getElementById('team1Name');
    const team2Name = document.getElementById('team2Name');
    const matchFormat = document.getElementById('matchFormat');
    const targetDisplay = document.getElementById('targetDisplay');
    const targetScore = document.getElementById('targetScore');
    const battingTeamName = document.getElementById('battingTeamName');
    const bowlingTeamName = document.getElementById('bowlingTeamName');
    const battingRuns = document.getElementById('battingRuns');
    const battingWickets = document.getElementById('battingWickets');
    const battingOvers = document.getElementById('battingOvers');
    const bowlingWickets = document.getElementById('bowlingWickets');
    const bowlingEcon = document.getElementById('bowlingEcon');
    const currentStatus = document.getElementById('currentStatus');
    const actionControls = document.getElementById('actionControls');
    const batsman1Name = document.getElementById('batsman1Name');
    const batsman1Runs = document.getElementById('batsman1Runs');
    const batsman1Balls = document.getElementById('batsman1Balls');
    const batsman1SR = document.getElementById('batsman1SR');
    const batsman1CaptainBadge = document.getElementById('batsman1CaptainBadge');
    const batsman2Name = document.getElementById('batsman2Name');
    const batsman2Runs = document.getElementById('batsman2Runs');
    const batsman2Balls = document.getElementById('batsman2Balls');
    const batsman2SR = document.getElementById('batsman2SR');
    const batsman2CaptainBadge = document.getElementById('batsman2CaptainBadge');
    const bowlerName = document.getElementById('bowlerName');
    const bowlerOvers = document.getElementById('bowlerOvers');
    const bowlerMaidens = document.getElementById('bowlerMaidens');
    const bowlerRuns = document.getElementById('bowlerRuns');
    const bowlerWickets = document.getElementById('bowlerWickets');
    const bowlerEcon = document.getElementById('bowlerEcon');
    const bowlerCaptainBadge = document.getElementById('bowlerCaptainBadge');
    const commentary = document.getElementById('commentary');
    const endInningsBtn = document.getElementById('endInningsBtn');
    const run0Btn = document.getElementById('run0Btn');
    const run1Btn = document.getElementById('run1Btn');
    const run2Btn = document.getElementById('run2Btn');
    const run3Btn = document.getElementById('run3Btn');
    const run4Btn = document.getElementById('run4Btn');
    const run6Btn = document.getElementById('run6Btn');
    const wicketBtn = document.getElementById('wicketBtn');
    const wideBtn = document.getElementById('wideBtn');
    const noBallBtn = document.getElementById('noBallBtn');

    // Modal elements
    const wicketModal = document.getElementById('wicketModal');
    const wicketType = document.getElementById('wicketType');
    const newBatsman = document.getElementById('newBatsman');
    const confirmWicketBtn = document.getElementById('confirmWicketBtn');
    const cancelWicketBtn = document.getElementById('cancelWicketBtn');
    const bowlerModal = document.getElementById('bowlerModal');
    const newBowler = document.getElementById('newBowler');
    const confirmBowlerBtn = document.getElementById('confirmBowlerBtn');
    const cancelBowlerBtn = document.getElementById('cancelBowlerBtn');
    const inningsEndModal = document.getElementById('inningsEndModal');
    const inningsEndTitle = document.getElementById('inningsEndTitle');
    const inningsEndContent = document.getElementById('inningsEndContent');
    const inningsTotal = document.getElementById('inningsTotal');
    const inningsOvers = document.getElementById('inningsOvers');
    const continueToSecondInningsBtn = document.getElementById('continueToSecondInningsBtn');
    const matchEndModal = document.getElementById('matchEndModal');
    const matchEndTitle = document.getElementById('matchEndTitle');
    const matchEndContent = document.getElementById('matchEndContent');
    const viewSummaryBtn = document.getElementById('viewSummaryBtn');
    const backToHomeBtn = document.getElementById('backToHomeBtn');

    let matchData = {};
    let team1Players = [];
    let team2Players = [];
    let currentInnings = 1;
    let maxOvers = 20;
    let currentBowlerIndex = 0;
    let isMyTurn = false;
    let myTeam = '';
    let opponentTeam = '';

    // Initialize the game
    onValue(roomRef, (snap) => {
      if (!snap.exists()) {
        alert('Room not found');
        window.location.href = 'index.html';
        return;
      }

      const room = snap.val();
      matchData = room.match || {};
      
      // Set team names and format
      team1Name.textContent = room.player1?.team || 'Team A';
      team2Name.textContent = room.player2?.team || 'Team B';
      maxOvers = parseInt(room.player1?.format) || 20;
      matchFormat.textContent = getFormatName(maxOvers);

      // Determine which team is batting first based on toss
      if (room.toss) {
        const battingFirst = room.toss.battingFirst;
        const battingTeam = battingFirst === 'player1' ? room.player1?.team : room.player2?.team;
        const bowlingTeam = battingFirst === 'player1' ? room.player2?.team : room.player1?.team;
        
        battingTeamName.textContent = battingTeam;
        bowlingTeamName.textContent = bowlingTeam;

        // Set my team and opponent team
        if (playerRole === 'player1') {
          myTeam = room.player1?.team;
          opponentTeam = room.player2?.team;
          isMyTurn = (battingFirst === 'player1' && room.match?.battingTeam === 'team1') || 
                     (battingFirst === 'player2' && room.match?.battingTeam === 'team2');
        } else if (playerRole === 'player2') {
          myTeam = room.player2?.team;
          opponentTeam = room.player1?.team;
          isMyTurn = (battingFirst === 'player2' && room.match?.battingTeam === 'team2') || 
                     (battingFirst === 'player1' && room.match?.battingTeam === 'team1');
        }
      }

      // Load teams if available
      if (room.teams) {
        team1Players = room.teams.player1?.players || [];
        team2Players = room.teams.player2?.players || [];
      }

      // Update match data
      if (matchData) {
        updateMatchDisplay(matchData);
        
        // Check if match is complete
        if (matchData.matchComplete) {
          showMatchEndModal(matchData);
          return;
        }
        
        // Check if first innings is complete and second innings hasn't started
        if (matchData.firstInningsComplete && !matchData.secondInningsStarted) {
          showInningsEndModal(matchData, 1);
          return;
        }
        
        // Check if second innings is complete
        if (matchData.secondInningsComplete) {
          showInningsEndModal(matchData, 2);
          return;
        }
        
        // Show controls if it's my turn and not a spectator
        if (isMyTurn && !isSpectator) {
          actionControls.style.display = 'block';
          currentStatus.style.display = 'none';
        } else {
          actionControls.style.display = 'none';
          currentStatus.style.display = 'block';
          currentStatus.innerHTML = isSpectator ? 
            '<p>Spectating the match...</p>' : 
            '<div class="loading-spinner"></div><p>Waiting for opponent to play...</p>';
        }
      }
    });

    // Listen for commentary updates
    onValue(commentaryRef, (snap) => {
      if (snap.exists()) {
        const comments = snap.val();
        commentary.innerHTML = Object.values(comments).reverse().map(comment => 
          `<p>${comment.text}</p>`
        ).join('');
      }
    });

    // Update match display with current data
    function updateMatchDisplay(data) {
      // Determine current innings
      currentInnings = data.secondInningsStarted ? 2 : 1;
      inningsTitle.textContent = currentInnings === 1 ? 'First Innings' : 'Second Innings';
      
      // Update scores based on current innings
      if (currentInnings === 1) {
        battingRuns.textContent = data.team1Runs || 0;
        battingWickets.textContent = data.team1Wickets || 0;
        battingOvers.textContent = formatOvers(data.team1Balls || 0);
        bowlingWickets.textContent = data.team1Wickets || 0;
        bowlingEcon.textContent = calculateEcon(data.team1Runs || 0, data.team1Balls || 0);
        
        // Hide target display in first innings
        targetDisplay.style.display = 'none';
      } else {
        battingRuns.textContent = data.team2Runs || 0;
        battingWickets.textContent = data.team2Wickets || 0;
        battingOvers.textContent = formatOvers(data.team2Balls || 0);
        bowlingWickets.textContent = data.team2Wickets || 0;
        bowlingEcon.textContent = calculateEcon(data.team2Runs || 0, data.team2Balls || 0);
        
        // Show target in second innings
        targetDisplay.style.display = 'block';
        targetScore.textContent = (data.team1Runs || 0) + 1;
      }
      
      // Update batsmen and bowler stats
      if (data.batsmen) {
        const batsman1 = data.batsmen[0] || {};
        const batsman2 = data.batsmen[1] || {};
        
        batsman1Name.textContent = batsman1.name || 'Batsman 1';
        batsman1Runs.textContent = batsman1.runs || 0;
        batsman1Balls.textContent = batsman1.balls || 0;
        batsman1SR.textContent = calculateStrikeRate(batsman1.runs || 0, batsman1.balls || 0);
        batsman1CaptainBadge.style.display = batsman1.isCaptain ? 'inline-block' : 'none';
        
        batsman2Name.textContent = batsman2.name || 'Batsman 2';
        batsman2Runs.textContent = batsman2.runs || 0;
        batsman2Balls.textContent = batsman2.balls || 0;
        batsman2SR.textContent = calculateStrikeRate(batsman2.runs || 0, batsman2.balls || 0);
        batsman2CaptainBadge.style.display = batsman2.isCaptain ? 'inline-block' : 'none';
      }
      
      if (data.bowler) {
        bowlerName.textContent = data.bowler.name || 'Bowler';
        bowlerOvers.textContent = formatOvers(data.bowler.balls || 0);
        bowlerMaidens.textContent = data.bowler.maidens || 0;
        bowlerRuns.textContent = data.bowler.runs || 0;
        bowlerWickets.textContent = data.bowler.wickets || 0;
        bowlerEcon.textContent = calculateEcon(data.bowler.runs || 0, data.bowler.balls || 0);
        bowlerCaptainBadge.style.display = data.bowler.isCaptain ? 'inline-block' : 'none';
      }
      
      // Show end innings button if all wickets fallen or overs completed
      const wicketsFallen = currentInnings === 1 ? data.team1Wickets : data.team2Wickets;
      const ballsBowled = currentInnings === 1 ? data.team1Balls : data.team2Balls;
      
      if ((wicketsFallen >= 10) || (ballsBowled >= maxOvers * 6)) {
        endInningsBtn.style.display = 'block';
      } else {
        endInningsBtn.style.display = 'none';
      }
    }

    // Helper functions
    function formatOvers(balls) {
      const overs = Math.floor(balls / 6);
      const ballsInOver = balls % 6;
      return `${overs}.${ballsInOver}`;
    }

    function calculateEcon(runs, balls) {
      if (balls === 0) return '0.00';
      const overs = balls / 6;
      return (runs / overs).toFixed(2);
    }

    function calculateStrikeRate(runs, balls) {
      if (balls === 0) return '0.00';
      return ((runs / balls) * 100).toFixed(2);
    }

    function getFormatName(overs) {
      switch(overs) {
        case 5: return 'T5 (5 Overs)';
        case 10: return 'T10 (10 Overs)';
        case 20: return 'T20 (20 Overs)';
        case 50: return 'ODI (50 Overs)';
        default: return `${overs} Overs`;
      }
    }

    function addCommentary(text) {
      const timestamp = Date.now();
      update(ref(db, `rooms/${roomId}/commentary/${timestamp}`), {
        text: text
      });
    }

    // Event handlers for action buttons
    run0Btn.addEventListener('click', () => addRun(0));
    run1Btn.addEventListener('click', () => addRun(1));
    run2Btn.addEventListener('click', () => addRun(2));
    run3Btn.addEventListener('click', () => addRun(3));
    run4Btn.addEventListener('click', () => addRun(4));
    run6Btn.addEventListener('click', () => addRun(6));
    wideBtn.addEventListener('click', () => addExtra('wide'));
    noBallBtn.addEventListener('click', () => addExtra('noBall'));
    wicketBtn.addEventListener('click', showWicketModal);
    endInningsBtn.addEventListener('click', endInnings);

    // Add runs to the score
    function addRun(runs) {
      if (!isMyTurn || isSpectator) return;
      
      get(matchRef).then((snap) => {
        if (!snap.exists()) return;
        
        const match = snap.val();
        const isFirstInnings = !match.secondInningsStarted;
        const batsmen = match.batsmen || [];
        const bowler = match.bowler || {};
        
        // Update match data
        const updates = {};
        
        if (isFirstInnings) {
          updates['team1Runs'] = (match.team1Runs || 0) + runs;
          updates['team1Balls'] = (match.team1Balls || 0) + 1;
        } else {
          updates['team2Runs'] = (match.team2Runs || 0) + runs;
          updates['team2Balls'] = (match.team2Balls || 0) + 1;
        }
        
        // Update batsmen stats (rotate strike on odd runs)
        if (batsmen.length > 0) {
          const strikerIndex = match.strikerIndex || 0;
          const strikerKey = isFirstInnings ? `batsmen/${strikerIndex}/runs` : `batsmen/${strikerIndex}/runs`;
          const strikerBallsKey = isFirstInnings ? `batsmen/${strikerIndex}/balls` : `batsmen/${strikerIndex}/balls`;
          
          updates[strikerKey] = (batsmen[strikerIndex].runs || 0) + runs;
          updates[strikerBallsKey] = (batsmen[strikerIndex].balls || 0) + 1;
          
          // Rotate strike on odd runs (except last ball of over)
          const ballsBowled = isFirstInnings ? (match.team1Balls || 0) + 1 : (match.team2Balls || 0) + 1;
          if (runs % 2 !== 0 && ballsBowled % 6 !== 0) {
            updates['strikerIndex'] = strikerIndex === 0 ? 1 : 0;
          }
        }
        
        // Update bowler stats
        if (bowler.name) {
          const bowlerKey = isFirstInnings ? 'bowler/runs' : 'bowler/runs';
          const bowlerBallsKey = isFirstInnings ? 'bowler/balls' : 'bowler/balls';
          
          updates[bowlerKey] = (bowler.runs || 0) + runs;
          updates[bowlerBallsKey] = (bowler.balls || 0) + 1;
          
          // Check for maiden over (no runs in the over)
          if (runs === 0 && (updates[bowlerBallsKey] % 6 === 0)) {
            updates['bowler/maidens'] = (bowler.maidens || 0) + 1;
          }
        }
        
        // Update match data
        update(matchRef, updates).then(() => {
          // Add commentary
          const strikerName = batsmen[match.strikerIndex || 0]?.name || 'Batsman';
          const commentaryText = runs === 0 ? 
            `${strikerName} defends the ball.` :
            `${strikerName} scores ${runs} run${runs > 1 ? 's' : ''}.`;
          addCommentary(commentaryText);
          
          // Check if over is complete and rotate bowler
          const ballsBowled = isFirstInnings ? updates['team1Balls'] : updates['team2Balls'];
          if (ballsBowled % 6 === 0 && !isSpectator) {
            showBowlerModal();
          }
        });
      });
    }

    // Add extras (wides, no balls)
    function addExtra(extraType) {
      if (!isMyTurn || isSpectator) return;
      
      get(matchRef).then((snap) => {
        if (!snap.exists()) return;
        
        const match = snap.val();
        const isFirstInnings = !match.secondInningsStarted;
        const bowler = match.bowler || {};
        
        // Update match data
        const updates = {};
        const extraRuns = extraType === 'wide' ? 1 : (extraType === 'noBall' ? 1 : 0);
        
        if (isFirstInnings) {
          updates['team1Runs'] = (match.team1Runs || 0) + extraRuns;
          if (extraType !== 'noBall') {
            updates['team1Extras'] = (match.team1Extras || 0) + extraRuns;
          }
        } else {
          updates['team2Runs'] = (match.team2Runs || 0) + extraRuns;
          if (extraType !== 'noBall') {
            updates['team2Extras'] = (match.team2Extras || 0) + extraRuns;
          }
        }
        
        // Update bowler stats (no ball counts as a ball, wide doesn't)
        if (bowler.name) {
          const bowlerKey = isFirstInnings ? 'bowler/runs' : 'bowler/runs';
          updates[bowlerKey] = (bowler.runs || 0) + extraRuns;
          
          if (extraType === 'noBall') {
            const bowlerBallsKey = isFirstInnings ? 'bowler/balls' : 'bowler/balls';
            updates[bowlerBallsKey] = (bowler.balls || 0) + 1;
          }
        }
        
        // Update match data
        update(matchRef, updates).then(() => {
          // Add commentary
          const commentaryText = extraType === 'wide' ? 
            'Wide ball! Extra run awarded.' : 
            'No ball! Free hit coming up.';
          addCommentary(commentaryText);
        });
      });
    }

    // Show wicket modal
    function showWicketModal() {
      if (!isMyTurn || isSpectator) return;
      
      get(matchRef).then((snap) => {
        if (!snap.exists()) return;
        
        const match = snap.val();
        const isFirstInnings = !match.secondInningsStarted;
        const batsmen = match.batsmen || [];
        const teamPlayers = isFirstInnings ? 
          (match.battingTeam === 'team1' ? team1Players : team2Players) :
          (match.battingTeam === 'team1' ? team2Players : team1Players);
        
        // Populate new batsman dropdown
        newBatsman.innerHTML = '<option value="">Select new batsman</option>';
        teamPlayers.forEach(player => {
          // Only show players not already batting or out
          const isBatting = batsmen.some(b => b.name === player);
          const isOut = match.dismissedPlayers?.includes(player);
          if (!isBatting && !isOut) {
            const option = document.createElement('option');
            option.value = player;
            option.textContent = player;
            newBatsman.appendChild(option);
          }
        });
        
        wicketModal.style.display = 'block';
      });
    }

    // Confirm wicket
    confirmWicketBtn.addEventListener('click', () => {
      if (!newBatsman.value) {
        alert('Please select a new batsman');
        return;
      }
      
      get(matchRef).then((snap) => {
        if (!snap.exists()) return;
        
        const match = snap.val();
        const isFirstInnings = !match.secondInningsStarted;
        const batsmen = match.batsmen || [];
        const bowler = match.bowler || {};
        const strikerIndex = match.strikerIndex || 0;
        const striker = batsmen[strikerIndex];
        
        if (!striker) return;
        
        // Update match data
        const updates = {};
        
        // Update team wickets
        if (isFirstInnings) {
          updates['team1Wickets'] = (match.team1Wickets || 0) + 1;
          updates['team1Balls'] = (match.team1Balls || 0) + 1;
        } else {
          updates['team2Wickets'] = (match.team2Wickets || 0) + 1;
          updates['team2Balls'] = (match.team2Balls || 0) + 1;
        }
        
        // Update bowler wickets
        updates['bowler/wickets'] = (bowler.wickets || 0) + 1;
        updates['bowler/balls'] = (bowler.balls || 0) + 1;
        
        // Add dismissed player
        const dismissedPlayers = match.dismissedPlayers || [];
        dismissedPlayers.push(striker.name);
        updates['dismissedPlayers'] = dismissedPlayers;
        
        // Add dismissal info
        const dismissals = match.dismissals || [];
        dismissals.push({
          batsman: striker.name,
          bowler: bowler.name,
          howOut: wicketType.value,
          runs: striker.runs || 0,
          balls: striker.balls || 0
        });
        updates['dismissals'] = dismissals;
        
        // Replace batsman
        const newBatsmanData = {
          name: newBatsman.value,
          runs: 0,
          balls: 0,
          isCaptain: team1Players.includes(newBatsman.value) ? 
            (match.teams.player1?.captain === newBatsman.value) :
            (match.teams.player2?.captain === newBatsman.value)
        };
        
        updates[`batsmen/${strikerIndex}`] = newBatsmanData;
        
        // Update match data
        update(matchRef, updates).then(() => {
          // Add commentary
          const commentaryText = `${striker.name} is out! ${bowler.name} takes the wicket. ${newBatsman.value} comes to the crease.`;
          addCommentary(commentaryText);
          
          wicketModal.style.display = 'none';
          
          // Check if all out
          const wicketsFallen = isFirstInnings ? 
            (match.team1Wickets || 0) + 1 : 
            (match.team2Wickets || 0) + 1;
          
          if (wicketsFallen >= 10) {
            endInnings();
          }
        });
      });
    });

    // Cancel wicket
    cancelWicketBtn.addEventListener('click', () => {
      wicketModal.style.display = 'none';
    });

    // Show bowler change modal
    function showBowlerModal() {
      if (!isMyTurn || isSpectator) return;
      
      get(matchRef).then((snap) => {
        if (!snap.exists()) return;
        
        const match = snap.val();
        const isFirstInnings = !match.secondInningsStarted;
        const teamPlayers = isFirstInnings ? 
          (match.bowlingTeam === 'team1' ? team1Players : team2Players) :
          (match.bowlingTeam === 'team1' ? team2Players : team1Players);
        
        // Populate new bowler dropdown
        newBowler.innerHTML = '<option value="">Select new bowler</option>';
        teamPlayers.forEach(player => {
          // Don't select current bowler or batsmen
          const isBatting = match.batsmen?.some(b => b.name === player);
          const isCurrentBowler = match.bowler?.name === player;
          if (!isBatting && !isCurrentBowler) {
            const option = document.createElement('option');
            option.value = player;
            option.textContent = player;
            newBowler.appendChild(option);
          }
        });
        
        bowlerModal.style.display = 'block';
      });
    }

    // Confirm new bowler
    confirmBowlerBtn.addEventListener('click', () => {
      if (!newBowler.value) {
        alert('Please select a new bowler');
        return;
      }
      
      get(matchRef).then((snap) => {
        if (!snap.exists()) return;
        
        const match = snap.val();
        const isFirstInnings = !match.secondInningsStarted;
        const teamPlayers = isFirstInnings ? 
          (match.bowlingTeam === 'team1' ? team1Players : team2Players) :
          (match.bowlingTeam === 'team1' ? team2Players : team1Players);
        
        // Check if player is in the team
        if (!teamPlayers.includes(newBowler.value)) {
          alert('Selected player is not in the bowling team');
          return;
        }
        
        // Update bowler
        const newBowlerData = {
          name: newBowler.value,
          runs: 0,
          balls: 0,
          wickets: 0,
          maidens: 0,
          isCaptain: team1Players.includes(newBowler.value) ? 
            (match.teams.player1?.captain === newBowler.value) :
            (match.teams.player2?.captain === newBowler.value)
        };
        
        update(matchRef, {
          bowler: newBowlerData
        }).then(() => {
          // Add commentary
          addCommentary(`${newBowler.value} comes into the attack.`);
          bowlerModal.style.display = 'none';
        });
      });
    });

    // Cancel bowler change
    cancelBowlerBtn.addEventListener('click', () => {
      bowlerModal.style.display = 'none';
    });

    // End current innings
    function endInnings() {
      if (!isMyTurn || isSpectator) return;
      
      get(matchRef).then((snap) => {
        if (!snap.exists()) return;
        
        const match = snap.val();
        const isFirstInnings = !match.secondInningsStarted;
        
        if (isFirstInnings) {
          // End first innings
          update(matchRef, {
            firstInningsComplete: true,
            battingTeam: match.bowlingTeam,
            bowlingTeam: match.battingTeam,
            strikerIndex: 0,
            batsmen: [
              {
                name: match.teams[match.bowlingTeam === 'team1' ? 'player1' : 'player2']?.players[0],
                runs: 0,
                balls: 0,
                isCaptain: match.teams[match.bowlingTeam === 'team1' ? 'player1' : 'player2']?.captain === 
                          match.teams[match.bowlingTeam === 'team1' ? 'player1' : 'player2']?.players[0]
              },
              {
                name: match.teams[match.bowlingTeam === 'team1' ? 'player1' : 'player2']?.players[1],
                runs: 0,
                balls: 0,
                isCaptain: match.teams[match.bowlingTeam === 'team1' ? 'player1' : 'player2']?.captain === 
                          match.teams[match.bowlingTeam === 'team1' ? 'player1' : 'player2']?.players[1]
              }
            ],
            bowler: {
              name: match.teams[match.battingTeam === 'team1' ? 'player1' : 'player2']?.players[0],
              runs: 0,
              balls: 0,
              wickets: 0,
              maidens: 0,
              isCaptain: match.teams[match.battingTeam === 'team1' ? 'player1' : 'player2']?.captain === 
                        match.teams[match.battingTeam === 'team1' ? 'player1' : 'player2']?.players[0]
            },
            dismissedPlayers: [],
            dismissals: []
          }).then(() => {
            addCommentary(`First innings ends. ${match.battingTeam === 'team1' ? team1Name.textContent : team2Name.textContent} scored ${match.team1Runs || 0}/${match.team1Wickets || 0} in ${formatOvers(match.team1Balls || 0)} overs.`);
          });
        } else {
          // End second innings and match
          update(matchRef, {
            secondInningsComplete: true,
            matchComplete: true,
            winner: calculateWinner(match)
          }).then(() => {
            addCommentary(`Match over! ${calculateWinner(match)} wins the match.`);
            showMatchEndModal(match);
          });
        }
      });
    }

    // Show innings end modal
    function showInningsEndModal(match, innings) {
      if (innings === 1) {
        inningsEndTitle.textContent = 'First Innings Complete';
        inningsTotal.textContent = `${match.team1Runs || 0}/${match.team1Wickets || 0}`;
        inningsOvers.textContent = formatOvers(match.team1Balls || 0);
        continueToSecondInningsBtn.style.display = 'block';
        inningsEndModal.style.display = 'block';
      } else {
        inningsEndTitle.textContent = 'Second Innings Complete';
        inningsTotal.textContent = `${match.team2Runs || 0}/${match.team2Wickets || 0}`;
        inningsOvers.textContent = formatOvers(match.team2Balls || 0);
        continueToSecondInningsBtn.style.display = 'none';
        inningsEndModal.style.display = 'block';
        
        // Automatically proceed to match end after delay
        setTimeout(() => {
          inningsEndModal.style.display = 'none';
          showMatchEndModal(match);
        }, 3000);
      }
    }

    // Continue to second innings
    continueToSecondInningsBtn.addEventListener('click', () => {
      update(matchRef, {
        secondInningsStarted: true
      }).then(() => {
        inningsEndModal.style.display = 'none';
        inningsTitle.textContent = 'Second Innings';
        targetDisplay.style.display = 'block';
        targetScore.textContent = (matchData.team1Runs || 0) + 1;
        addCommentary(`Second innings begins. ${matchData.bowlingTeam === 'team1' ? team1Name.textContent : team2Name.textContent} needs ${(matchData.team1Runs || 0) + 1} runs to win.`);
      });
    });

    // Show match end modal
    function showMatchEndModal(match) {
      matchEndModal.style.display = 'block';
      
      if (match.winner) {
        matchEndTitle.textContent = `${match.winner} Wins!`;
        
        let resultText = '';
        if (match.winner === 'team1') {
          const margin = match.team1Runs - (match.team2Runs || 0);
          resultText = `${team1Name.textContent} wins by ${margin} run${margin !== 1 ? 's' : ''}`;
        } else if (match.winner === 'team2') {
          const wicketsLeft = 10 - (match.team2Wickets || 0);
          const ballsLeft = (maxOvers * 6) - (match.team2Balls || 0);
          const oversLeft = Math.floor(ballsLeft / 6);
          const ballsInOver = ballsLeft % 6;
          
          resultText = `${team2Name.textContent} wins by ${wicketsLeft} wicket${wicketsLeft !== 1 ? 's' : ''}`;
          if (ballsLeft > 0) {
            resultText += ` with ${oversLeft > 0 ? `${oversLeft}.${ballsInOver} overs` : `${ballsLeft} balls`} remaining`;
          }
        } else {
          resultText = 'Match tied!';
        }
        
        matchEndContent.innerHTML = `
          <p>${team1Name.textContent}: ${match.team1Runs || 0}/${match.team1Wickets || 0} (${formatOvers(match.team1Balls || 0)})</p>
          <p>${team2Name.textContent}: ${match.team2Runs || 0}/${match.team2Wickets || 0} (${formatOvers(match.team2Balls || 0)})</p>
          <p style="font-weight: bold; margin-top: 10px;">${resultText}</p>
        `;
      } else {
        matchEndTitle.textContent = 'Match Complete';
        matchEndContent.innerHTML = `
          <p>${team1Name.textContent}: ${match.team1Runs || 0}/${match.team1Wickets || 0} (${formatOvers(match.team1Balls || 0)})</p>
          <p>${team2Name.textContent}: ${match.team2Runs || 0}/${match.team2Wickets || 0} (${formatOvers(match.team2Balls || 0)})</p>
          <p style="font-weight: bold; margin-top: 10px;">Match tied!</p>
        `;
      }
    }

    // Calculate match winner
    function calculateWinner(match) {
      if (!match.secondInningsComplete) return null;
      
      if (match.team2Runs > match.team1Runs) {
        return 'team2';
      } else if (match.team2Runs < match.team1Runs) {
        return 'team1';
      } else {
        return 'tie';
      }
    }

    // View summary button
    viewSummaryBtn.addEventListener('click', () => {
      // In a complete implementation, this would show a detailed match summary
      alert('Match summary would be displayed here');
    });

    // Back to home button
    backToHomeBtn.addEventListener('click', () => {
      window.location.href = 'index.html';
    });

    // Handle page refresh/disconnect
    window.addEventListener('beforeunload', () => {
      if (playerRole === 'player1' || playerRole === 'player2') {
        update(ref(db, `rooms/${roomId}/${playerRole}`), {
          connected: false
        });
      }
    });
  </script>
</body>
  </html>
