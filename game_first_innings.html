<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HandiCricket - First Innings</title>
  <style>
    /* Base Styles */
    body {
      background: #061e3e;
      color: white;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      overflow-x: hidden;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
      position: relative;
    }

    /* Stadium Effects */
    .stadium-effects {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      pointer-events: none;
    }

    .crowd {
      position: absolute;
      bottom: 0;
      width: 100%;
      height: 30%;
      background: linear-gradient(to top, rgba(0, 0, 0, 0.7), transparent);
    }

    .pitch {
      position: absolute;
      bottom: 30%;
      left: 50%;
      transform: translateX(-50%);
      width: 80%;
      height: 40%;
      background: linear-gradient(to bottom, #2a5c2a, #1e3e1e);
      border-radius: 50% / 10%;
    }

    /* Team Names */
    .team-names-compact {
      background: rgba(13, 42, 82, 0.7);
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 15px;
      text-align: center;
    }

    .team-name-line {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    .team-label {
      color: #ffeb3b;
      font-weight: bold;
    }

    .team-divider {
      color: #aaa;
      margin: 0 5px;
    }

    /* Live Ticker */
    .live-ticker {
      background: rgba(30, 136, 229, 0.3);
      border-radius: 8px;
      padding: 8px;
      margin-bottom: 15px;
      overflow: hidden;
      position: relative;
      height: 30px;
    }

    .ticker-content {
      display: flex;
      gap: 20px;
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      white-space: nowrap;
      animation: tickerScroll 30s linear infinite;
    }

    .ticker-item {
      display: inline-block;
      margin-right: 20px;
      font-size: 14px;
    }

    @keyframes tickerScroll {
      0% { transform: translateX(100%) translateY(-50%); }
      100% { transform: translateX(-100%) translateY(-50%); }
    }

    /* Scorebox */
    .scorebox {
      background: rgba(0, 0, 0, 0.5);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    .scorebox-main {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .team-score {
      font-size: 24px;
    }

    .score-large {
      font-size: 32px;
      font-weight: bold;
      color: #ffeb3b;
      margin-left: 10px;
    }

    .score-details {
      text-align: right;
      font-size: 16px;
    }

    /* Match Info Bar */
    .match-info-bar {
      display: flex;
      justify-content: space-between;
      background: rgba(30, 136, 229, 0.2);
      padding: 8px 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      font-size: 14px;
    }

    .match-format {
      font-weight: bold;
      color: #ffeb3b;
    }

    .match-status {
      display: flex;
      gap: 10px;
    }

    .divider {
      color: #aaa;
      margin: 0 5px;
    }

    /* Over Progress */
    .over-progress {
      background: rgba(13, 42, 82, 0.7);
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .over-title {
      font-weight: bold;
      margin-bottom: 8px;
      color: #ffeb3b;
    }

    .balls-container {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    .ball {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      background: #1e88e5;
    }

    .ball.wicket {
      background: #f44336;
    }

    .ball.dot {
      background: #607d8b;
    }

    .ball.run {
      background: #4CAF50;
    }

    .ball.noball {
      background: #FF9800;
    }

    .ball.freehit {
      background: #9C27B0;
    }

    .over-number {
      font-size: 14px;
      color: #aaa;
    }

    /* Match Timeline */
    .timeline-container {
      background: rgba(13, 42, 82, 0.7);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      max-height: 150px;
      overflow-y: auto;
    }

    .timeline-container h4 {
      margin-top: 0;
      color: #ffeb3b;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      padding-bottom: 5px;
    }

    .timeline {
      display: flex;
      flex-direction: column-reverse;
      gap: 5px;
    }

    .timeline-item {
      font-size: 14px;
      padding: 3px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* Player Comparison */
    .comparison-container {
      background: rgba(13, 42, 82, 0.7);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .comparison-container h4 {
      margin-top: 0;
      color: #ffeb3b;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      padding-bottom: 5px;
    }

    .comparison-box {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 15px;
    }

    .player-comparison {
      flex: 1;
      padding: 10px;
      border-radius: 8px;
      text-align: center;
    }

    .batter-comparison {
      background: rgba(76, 175, 80, 0.2);
      border-left: 4px solid #4CAF50;
    }

    .bowler-comparison {
      background: rgba(244, 67, 54, 0.2);
      border-left: 4px solid #F44336;
    }

    .comparison-header {
      font-weight: bold;
      margin-bottom: 5px;
      color: #ffeb3b;
    }

    .comparison-name {
      font-size: 18px;
      margin-bottom: 10px;
    }

    .comparison-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      font-size: 14px;
    }

    .vs-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255, 235, 59, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: #ffeb3b;
    }

    /* Status Indicators */
    #statusIndicators {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .powerplay-indicator {
      background: rgba(255, 235, 59, 0.3);
      color: #ffeb3b;
      padding: 5px 10px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 14px;
    }

    .dead-over {
      background: rgba(96, 125, 139, 0.3);
      color: white;
      padding: 5px 10px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 14px;
    }

    .free-hit-indicator {
      background: rgba(156, 39, 176, 0.3);
      color: #E1BEE7;
      padding: 5px 10px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 14px;
    }

    /* Card Buttons */
    .card-btns {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }

    .btn {
      padding: 15px;
      border: none;
      border-radius: 8px;
      background: linear-gradient(145deg, #1e88e5, #1565c0);
      color: white;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    }

    .btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 10px rgba(0, 0, 0, 0.3);
    }

    .btn:active {
      transform: translateY(1px);
    }

    .btn[data-value="0"] {
      background: linear-gradient(145deg, #607D8B, #455A64);
    }

    .btn[data-value="4"] {
      background: linear-gradient(145deg, #4CAF50, #2E7D32);
    }

    .btn[data-value="6"] {
      background: linear-gradient(145deg, #9C27B0, #7B1FA2);
    }

    /* Over Summary */
    .over-summary-container {
      background: rgba(13, 42, 82, 0.7);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .over-summary-container h4 {
      margin-top: 0;
      color: #ffeb3b;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      padding-bottom: 5px;
    }

    #overSummaryList {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .over-summary-ball {
      width: 25px;
      height: 25px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
    }

    /* Controls */
    #topControls {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    #topControls button {
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    #saveBtn {
      background: linear-gradient(145deg, #4CAF50, #2E7D32);
      color: white;
    }

    #exitBtn {
      background: linear-gradient(145deg, #f44336, #d32f2f);
      color: white;
    }

    #resetPlaysBtn {
      background: linear-gradient(145deg, #FF9800, #F57C00);
      color: white;
    }

    /* Connection Status */
    #connectionStatus {
      padding: 8px;
      border-radius: 6px;
      margin-bottom: 15px;
      text-align: center;
      font-size: 14px;
    }

    .online {
      background: rgba(76, 175, 80, 0.3);
      color: #C8E6C9;
    }

    .offline {
      background: rgba(244, 67, 54, 0.3);
      color: #FFCDD2;
    }

    /* Loading Spinner */
    .loading-spinner {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 3px solid #1e88e5;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
      display: none;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Mini Scorecard */
    .mini-scorecard {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.7);
      padding: 10px 15px;
      border-radius: 8px;
      font-size: 16px;
      z-index: 100;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    /* Selection Modal */
    .selection-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(145deg, #123456, #0a1f3a);
      width: 90%;
      max-width: 400px;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.1);
      z-index: 1000;
      display: none;
    }

    .selection-modal h3 {
      margin-top: 0;
      color: #ffeb3b;
      text-align: center;
      border-bottom: 2px solid #1e88e5;
      padding-bottom: 8px;
    }

    .selection-list {
      max-height: 300px;
      overflow-y: auto;
      margin: 15px 0;
    }

    .selection-item {
      padding: 10px;
      margin: 5px 0;
      background: rgba(30, 136, 229, 0.2);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .selection-item:hover {
      background: rgba(30, 136, 229, 0.4);
    }

    #confirmSelection {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 8px;
      background: linear-gradient(145deg, #4CAF50, #2E7D32);
      color: white;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }

    #confirmSelection:hover {
      background: linear-gradient(145deg, #2E7D32, #1B5E20);
    }

    /* Teams Modal */
    .teams-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(145deg, #123456, #0a1f3a);
      width: 90%;
      max-width: 500px;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.1);
      z-index: 1000;
      display: none;
    }

    .close-teams {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
    }

    .teams-container {
      display: flex;
      overflow: hidden;
      margin-bottom: 15px;
    }

    .team-slide {
      min-width: 100%;
      transition: transform 0.3s ease;
    }

    .team-slide h3 {
      color: #ffeb3b;
      border-bottom: 2px solid #1e88e5;
      padding-bottom: 5px;
      margin-top: 0;
    }

    .team-slide ul {
      list-style: none;
      padding: 0;
    }

    .team-slide li {
      padding: 8px;
      margin: 5px 0;
      background: rgba(30, 136, 229, 0.2);
      border-radius: 6px;
    }

    .team-slide li.captain {
      background: rgba(255, 215, 0, 0.2);
      border-left: 3px solid gold;
    }

    .team-slide li.vice-captain {
      background: rgba(192, 192, 192, 0.2);
      border-left: 3px solid silver;
    }

    .teams-nav {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .team-nav-btn {
      padding: 8px 15px;
      border: none;
      border-radius: 6px;
      background: linear-gradient(145deg, #1e88e5, #1565c0);
      color: white;
      cursor: pointer;
    }

    .team-nav-btn:disabled {
      background: #666;
      cursor: not-allowed;
    }

    .team-nav-indicator {
      display: flex;
      justify-content: center;
      gap: 8px;
    }

    .team-nav-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #666;
      cursor: pointer;
    }

    .team-nav-dot.active {
      background: #1e88e5;
    }

    /* Summary Popup */
    .summary-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(145deg, #123456, #0a1f3a);
      width: 90%;
      max-width: 500px;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.1);
      z-index: 1000;
      display: none;
    }

    .summary-popup h3 {
      margin-top: 0;
      color: #ffeb3b;
      text-align: center;
      border-bottom: 2px solid #1e88e5;
      padding-bottom: 8px;
    }

    .summary-content {
      max-height: 70vh;
      overflow-y: auto;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .summary-label {
      color: #aaa;
    }

    .summary-value {
      font-weight: bold;
    }

    .summary-highlight {
      margin: 15px 0;
      padding: 10px;
      background: rgba(255, 235, 59, 0.2);
      border-radius: 8px;
      text-align: center;
      font-weight: bold;
    }

    .stats-slide {
      min-width: 100%;
      padding: 10px;
    }

    .stats-slide h4 {
      color: #ffeb3b;
      margin-top: 0;
      text-align: center;
    }

    .stats-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    .stats-table th {
      background: rgba(30, 136, 229, 0.5);
      padding: 8px;
      text-align: left;
    }

    .stats-table td {
      padding: 8px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .stats-table tr:nth-child(even) {
      background: rgba(30, 136, 229, 0.1);
    }

    #startSecondInningsBtn {
      width: 100%;
      padding: 12px;
      margin-top: 15px;
      border: none;
      border-radius: 8px;
      background: linear-gradient(145deg, #4CAF50, #2E7D32);
      color: white;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }

    #startSecondInningsBtn:hover {
      background: linear-gradient(145deg, #2E7D32, #1B5E20);
    }

    /* Responsive Styles */
    @media (max-width: 768px) {
      .card-btns {
        grid-template-columns: repeat(3, 1fr);
      }

      .match-info-bar {
        flex-direction: column;
        gap: 5px;
      }

      .comparison-box {
        flex-direction: column;
      }

      .vs-circle {
        margin: 10px 0;
      }
    }

    @media (max-width: 480px) {
      .card-btns {
        grid-template-columns: repeat(2, 1fr);
      }

      .scorebox-main {
        flex-direction: column;
        gap: 10px;
      }

      .score-details {
        text-align: center;
      }
    }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <div class="stadium-effects">
    <div class="crowd"></div>
    <div class="pitch"></div>
  </div>
  
  <div class="match-graphics" id="matchGraphics"></div>
  
  <div class="container">
    <div class="team-names-compact">
      <div class="team-name-line">
        <span class="team-label">Batting:</span>
        <span id="team1Name">Team A</span>
        <span class="team-divider">|</span>
        <span class="team-label">Bowling:</span>
        <span id="team2Name">Team B</span>
      </div>
    </div>
    
    <!-- Live score ticker -->
    <div class="live-ticker">
      <div class="ticker-content" id="tickerContent">
        <div class="ticker-item">Partnership: <span id="tickerPartnership">0</span> runs (<span id="tickerPartnershipBalls">0</span> balls)</div>
        <div class="ticker-item">Run Rate: <span id="tickerRunRate">0.00</span></div>
        <div class="ticker-item">Last 5 Overs: <span id="tickerLast5">0/0</span></div>
        <div class="ticker-item">Required Rate: <span id="tickerRequiredRate">0.00</span></div>
      </div>
    </div>
    
    <!-- Enhanced Scoreboard -->
    <div class="scorebox">
      <div class="scorebox-main">
        <div class="team-score">
          <span id="battingTeamName">Team A</span>
          <span class="score-large"><span id="runs">0</span>/<span id="wickets">0</span></span>
        </div>
        <div class="score-details">
          <div>Overs: <strong id="overs">0.0</strong></div>
          <div>Run Rate: <strong id="runRate">0.00</strong></div>
        </div>
      </div>
    </div>
    
    <!-- Match Info Bar -->
    <div class="match-info-bar">
      <div class="match-format" id="formatDisplay"></div>
      <div class="match-status">
        <span id="inningsNumber">1st Innings</span>
        <span class="divider">|</span>
        <span id="roleText"></span>
      </div>
      <div class="match-time">
        <span id="currentTime">14:30</span>
        <span class="divider">|</span>
        <span id="matchDate">23 Jul 2023</span>
      </div>
    </div>
    
    <!-- Over Progress -->
    <div class="over-progress">
      <div class="over-title">Current Over</div>
      <div class="balls-container" id="ballsContainer">
        <!-- Balls will be added dynamically -->
      </div>
      <div class="over-number">Over <span id="currentOverNumber">1</span></div>
    </div>
    
    <!-- Match Timeline -->
    <div class="timeline-container">
      <h4>Match Timeline</h4>
      <div class="timeline" id="matchTimeline">
        <!-- Timeline items will be added here -->
      </div>
    </div>
    
    <!-- Enhanced Player Comparison -->
    <div class="comparison-container">
      <h4>Current Battle</h4>
      <div class="comparison-box">
        <div class="player-comparison batter-comparison">
          <div class="comparison-header">Batter</div>
          <div class="comparison-name" id="comparisonBatterName">-</div>
          <div class="comparison-stats">
            <div>Runs: <span id="comparisonBatterRuns">0</span></div>
            <div>Balls: <span id="comparisonBatterBalls">0</span></div>
            <div>SR: <span id="comparisonBatterSR">0.00</span></div>
            <div>4s/6s: <span id="comparisonBatterBoundaries">0/0</span></div>
          </div>
        </div>
        <div class="vs-circle">VS</div>
        <div class="player-comparison bowler-comparison">
          <div class="comparison-header">Bowler</div>
          <div class="comparison-name" id="comparisonBowlerName">-</div>
          <div class="comparison-stats">
            <div>Overs: <span id="comparisonBowlerOvers">0.0</span></div>
            <div>Wkts: <span id="comparisonBowlerWickets">0</span></div>
            <div>ER: <span id="comparisonBowlerER">0.00</span></div>
            <div>Runs: <span id="comparisonBowlerRuns">0</span></div>
          </div>
        </div>
      </div>
    </div>
    
    <div id="statusIndicators">
      <span id="powerplayIndicator" class="powerplay-indicator" style="display: none;">Powerplay</span>
      <span id="deadOverIndicator" class="dead-over" style="display: none;">Dead Over</span>
      <span id="freeHitIndicator" class="free-hit-indicator" style="display: none;">Free Hit</span>
    </div>
    
    <div id="result">Initializing game...</div>
    
    <div class="card-btns" id="cardButtons">
      <button class="btn" data-value="0">0</button>
      <button class="btn" data-value="1">1</button>
      <button class="btn" data-value="2">2</button>
      <button class="btn" data-value="3">3</button>
      <button class="btn" data-value="4">4</button>
      <button class="btn" data-value="5">5</button>
      <button class="btn" data-value="6">6</button>
    </div>

    <div class="over-summary-container">
      <h4>Over Summary</h4>
      <div id="overSummaryList"></div>
    </div>

    <button class="show-teams-btn" id="showTeamsBtn">Show Teams</button>

    <div id="topControls">
      <button id="saveBtn">💾 Save & Exit</button>
      <button id="exitBtn">🚪 Exit Without Saving</button>
      <button id="resetPlaysBtn">🔄 Reset Plays</button>
    </div>
    <div id="connectionStatus" class="online">
      Opponent: Online
    </div>
    
    <div id="loading-spinner" class="loading-spinner"></div>
  </div>
  
  <!-- Mini scorecard that stays visible when scrolling -->
  <div class="mini-scorecard" id="miniScorecard" style="display: none;">
    <span id="miniScore">0/0</span> (<span id="miniOvers">0.0</span>)
  </div>
  
  <div id="selectionModal" class="selection-modal">
    <h3 id="selectionTitle">Select Next Batter</h3>
    <div id="selectionList" class="selection-list"></div>
    <button id="confirmSelection">Confirm Selection</button>
  </div>

  <div id="teamsModal" class="teams-modal">
    <button class="close-teams" id="closeTeamsBtn">×</button>
    <div class="teams-container" id="teamsSlider">
      <div class="team-slide" id="team1Slide">
        <h3 id="modalTeam1Name">Team 1</h3>
        <ul id="modalTeam1Players"></ul>
      </div>
      <div class="team-slide" id="team2Slide">
        <h3 id="modalTeam2Name">Team 2</h3>
        <ul id="modalTeam2Players"></ul>
      </div>
    </div>
    <div class="teams-nav">
      <button class="team-nav-btn" id="prevTeamBtn" disabled>Previous</button>
      <button class="team-nav-btn" id="nextTeamBtn">Next</button>
    </div>
    <div class="team-nav-indicator">
      <div class="team-nav-dot active" data-index="0"></div>
      <div class="team-nav-dot" data-index="1"></div>
    </div>
  </div>

  <!-- Enhanced Innings Summary Popup with stats slides -->
  <div id="summaryPopup" class="summary-popup">
    <h3 id="summaryTitle">First Innings Summary</h3>
    <div class="summary-content">
      <div class="summary-row">
        <span class="summary-label">Total Runs:</span>
        <span class="summary-value" id="summaryTotalRuns">0</span>
      </div>
      <div class="summary-row">
        <span class="summary-label">Wickets:</span>
        <span class="summary-value" id="summaryWickets">0</span>
      </div>
      <div class="summary-row">
        <span class="summary-label">Overs:</span>
        <span class="summary-value" id="summaryOvers">0.0</span>
      </div>
      <div class="summary-row">
        <span class="summary-label">Run Rate:</span>
        <span class="summary-value" id="summaryRunRate">0.00</span>
      </div>
      <div class="summary-highlight" id="summaryHighlight"></div>
      
      <!-- Stats slides container -->
      <div class="teams-container" id="statsSlider" style="height: 200px; margin: 10px 0;">
        <!-- Batters stats slide -->
        <div class="stats-slide">
          <h4>Batting Stats</h4>
          <table class="stats-table" id="battersStatsTable">
            <thead>
              <tr>
                <th>Batter</th>
                <th>Runs</th>
                <th>Balls</th>
                <th>SR</th>
                <th>4s/6s</th>
              </tr>
            </thead>
            <tbody id="battersStatsBody"></tbody>
          </table>
        </div>
        
        <!-- Bowlers stats slide -->
        <div class="stats-slide">
          <h4>Bowling Stats</h4>
          <table class="stats-table" id="bowlersStatsTable">
            <thead>
              <tr>
                <th>Bowler</th>
                <th>Overs</th>
                <th>Wkts</th>
                <th>Runs</th>
                <th>ER</th>
              </tr>
            </thead>
            <tbody id="bowlersStatsBody"></tbody>
          </table>
        </div>
      </div>
      
      <!-- Stats navigation -->
      <div class="teams-nav">
        <button class="team-nav-btn" id="prevStatsBtn" disabled>Previous</button>
        <button class="team-nav-btn" id="nextStatsBtn">Next</button>
      </div>
      <div class="team-nav-indicator">
        <div class="team-nav-dot active" data-index="0"></div>
        <div class="team-nav-dot" data-index="1"></div>
      </div>
      
      <!-- Target display for second innings -->
      <div class="summary-row" id="targetDisplay" style="display: none;">
        <span class="summary-label">Target:</span>
        <span class="summary-value" id="targetValue">0</span>
      </div>
      
      <!-- Player of the match -->
      <div class="summary-row" id="pomDisplay" style="display: none;">
        <span class="summary-label">Player of the Match:</span>
        <span class="summary-value" id="pomValue">-</span>
      </div>
      
      <!-- Awards section -->
      <div class="awards-container" id="awardsContainer" style="display: none;">
        <!-- Awards will be added dynamically -->
      </div>
    </div>
    <button id="startSecondInningsBtn">🏏 Start Second Innings</button>
  </div>

  <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
import { getDatabase, ref, set, onValue, update, get, push } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCN6aZMwlsZe7JJaovU0WA3UQygWr4jYmA",
  authDomain: "handicricket-85a06.firebasejs/9.15.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCN6aZMwlsZe7JJaovU0WA3UQygWr4jYmA",
  authDomain: "handicricket-85a06.firebaseapp.com",
  projectId: "handicricket-85a06",
  storageBucket: "handicricket-85a06.appspot.com",
  messagingSenderId: "599182538558",
  appId: "1:599182538558:web:3e965753ab05f8f1e3de6f",
  measurementId: "G-HSV9H4LEJQ"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Get URL parameters
const params = new URLSearchParams(window.location.search);
const roomId = params.get('room');
const playerRole = params.get('player'); // 'player1' or 'player2'
const opponentRole = playerRole === 'player1' ? 'player2' : 'player1';

// DOM elements
const battingTeamNameEl = document.getElementById('battingTeamName');
const runsEl = document.getElementById('runs');
const wicketsEl = document.getElementById('wickets');
const oversEl = document.getElementById('overs');
const runRateEl = document.getElementById('runRate');
const resultEl = document.getElementById('result');
const cardButtons = document.querySelectorAll('.btn');
const connectionStatusEl = document.getElementById('connectionStatus');
const loadingSpinner = document.getElementById('loading-spinner');
const selectionModal = document.getElementById('selectionModal');
const selectionList = document.getElementById('selectionList');
const confirmSelection = document.getElementById('confirmSelection');
const selectionTitle = document.getElementById('selectionTitle');
const teamsModal = document.getElementById('teamsModal');
const closeTeamsBtn = document.getElementById('closeTeamsBtn');
const showTeamsBtn = document.getElementById('showTeamsBtn');
const modalTeam1Name = document.getElementById('modalTeam1Name');
const modalTeam2Name = document.getElementById('modalTeam2Name');
const modalTeam1Players = document.getElementById('modalTeam1Players');
const modalTeam2Players = document.getElementById('modalTeam2Players');
const prevTeamBtn = document.getElementById('prevTeamBtn');
const nextTeamBtn = document.getElementById('nextTeamBtn');
const saveBtn = document.getElementById('saveBtn');
const exitBtn = document.getElementById('exitBtn');
const resetPlaysBtn = document.getElementById('resetPlaysBtn');
const ballsContainer = document.getElementById('ballsContainer');
const currentOverNumber = document.getElementById('currentOverNumber');
const matchTimeline = document.getElementById('matchTimeline');
const summaryPopup = document.getElementById('summaryPopup');
const startSecondInningsBtn = document.getElementById('startSecondInningsBtn');
const summaryTitle = document.getElementById('summaryTitle');
const summaryTotalRuns = document.getElementById('summaryTotalRuns');
const summaryWickets = document.getElementById('summaryWickets');
const summaryOvers = document.getElementById('summaryOvers');
const summaryRunRate = document.getElementById('summaryRunRate');
const summaryHighlight = document.getElementById('summaryHighlight');
const targetDisplay = document.getElementById('targetDisplay');
const targetValue = document.getElementById('targetValue');
const battersStatsBody = document.getElementById('battersStatsBody');
const bowlersStatsBody = document.getElementById('bowlersStatsBody');
const overSummaryList = document.getElementById('overSummaryList');
const formatDisplay = document.getElementById('formatDisplay');
const inningsNumber = document.getElementById('inningsNumber');
const roleText = document.getElementById('roleText');
const powerplayIndicator = document.getElementById('powerplayIndicator');
const deadOverIndicator = document.getElementById('deadOverIndicator');
const freeHitIndicator = document.getElementById('freeHitIndicator');
const miniScorecard = document.getElementById('miniScorecard');
const miniScore = document.getElementById('miniScore');
const miniOvers = document.getElementById('miniOvers');

// Game state variables
let gameState = {
  roomId: roomId,
  currentInnings: 1,
  battingTeam: null,
  bowlingTeam: null,
  currentBatter: null,
  currentBowler: null,
  nextBatter: null,
  runs: 0,
  wickets: 0,
  balls: 0,
  overs: 0,
  maxOvers: 20, // Default, will be updated from room settings
  format: 'T20',
  powerplayOvers: [],
  isPowerplay: false,
  deadOvers: [],
  isDeadOver: false,
  isFreeHit: false,
  target: 0,
  firstInnings: {
    runs: 0,
    wickets: 0,
    overs: 0,
    batterStats: {},
    bowlerStats: {}
  },
  secondInnings: {
    runs: 0,
    wickets: 0,
    overs: 0,
    batterStats: {},
    bowlerStats: {}
  },
  player1Team: {
    name: '',
    players: [],
    captain: '',
    viceCaptain: ''
  },
  player2Team: {
    name: '',
    players: [],
    captain: '',
    viceCaptain: ''
  },
  currentOver: [],
  matchTimeline: [],
  overSummaries: [],
  batterDotCount: 0,
  bowlerDotCount: 0,
  bowlerOverCount: {},
  followOnTarget: 0,
  isFollowOnPossible: false
};

// Firebase references
const roomRef = ref(db, `rooms/${roomId}`);
const gameRef = ref(db, `games/${roomId}`);
const playerRef = ref(db, `rooms/${roomId}/${playerRole}`);
const opponentRef = ref(db, `rooms/${roomId}/${opponentRole}`);
const movesRef = ref(db, `games/${roomId}/moves`);
const completedMatchesRef = ref(db, 'completedMatches');

// Initialize game
function initGame() {
  loadingSpinner.style.display = 'block';
  
  // Load room data
  onValue(roomRef, (snapshot) => {
    if (snapshot.exists()) {
      const roomData = snapshot.val();
      
      // Set format and overs
      gameState.format = roomData.player1?.format || 'T20';
      gameState.maxOvers = getMaxOvers(gameState.format);
      gameState.powerplayOvers = getPowerplayOvers(gameState.format);
      
      // Set team names and players
      if (roomData.teams) {
        gameState.player1Team = roomData.teams.player1 || { name: 'Team A', players: [] };
        gameState.player2Team = roomData.teams.player2 || { name: 'Team B', players: [] };
        
        // Initialize bowler over counts
        gameState.player1Team.players.forEach(player => {
          gameState.bowlerOverCount[player] = 0;
        });
        gameState.player2Team.players.forEach(player => {
          gameState.bowlerOverCount[player] = 0;
        });
      }
      
      // Set batting/bowling teams based on toss
      if (roomData.toss) {
        if (roomData.toss.battingFirst === 'player1') {
          gameState.battingTeam = gameState.player1Team;
          gameState.bowlingTeam = gameState.player2Team;
        } else {
          gameState.battingTeam = gameState.player2Team;
          gameState.bowlingTeam = gameState.player1Team;
        }
        
        battingTeamNameEl.textContent = gameState.battingTeam.name;
        modalTeam1Name.textContent = gameState.player1Team.name;
        modalTeam2Name.textContent = gameState.player2Team.name;
        
        // Update UI with team names
        document.getElementById('team1Name').textContent = gameState.player1Team.name;
        document.getElementById('team2Name').textContent = gameState.player2Team.name;
        
        // Show captain/vice-captain in teams modal
        updateTeamsModal();
      }
      
      // Update format display
      formatDisplay.textContent = getFormatDisplayName(gameState.format);
      inningsNumber.textContent = gameState.currentInnings === 1 ? '1st Innings' : '2nd Innings';
      roleText.textContent = playerRole === 'player1' ? 'Player 1' : 'Player 2';
      
      // Check if game already exists
      get(gameRef).then((gameSnap) => {
        if (gameSnap.exists()) {
          // Load existing game state
          const savedGame = gameSnap.val();
          Object.assign(gameState, savedGame);
          updateUI();
          
          // If game is in second innings, update target
          if (gameState.currentInnings === 2) {
            targetDisplay.style.display = 'flex';
            targetValue.textContent = gameState.firstInnings.runs + 1;
          }
          
          // Check if we need to select a batter or bowler
          checkPlayerSelection();
        } else {
          // Initialize new game
          if (playerRole === 'player1') {
            initializeNewGame();
          } else {
            resultEl.textContent = 'Waiting for host to initialize game...';
          }
        }
      });
      
      loadingSpinner.style.display = 'none';
    } else {
      // Room doesn't exist
      alert('Room not found. Redirecting to home page.');
      window.location.href = 'index.html';
    }
  });
  
  // Listen for opponent moves
  onValue(movesRef, (snapshot) => {
    if (snapshot.exists()) {
      const moves = snapshot.val();
      const lastMoveKey = Object.keys(moves).pop();
      const lastMove = moves[lastMoveKey];
      
      if (lastMove.player !== playerRole) {
        processOpponentMove(lastMove);
      }
    }
  });
  
  // Listen for opponent connection status
  onValue(opponentRef, (snapshot) => {
    if (snapshot.exists() && snapshot.val().connected) {
      connectionStatusEl.textContent = 'Opponent: Online';
      connectionStatusEl.className = 'online';
    } else {
      connectionStatusEl.textContent = 'Opponent: Offline';
      connectionStatusEl.className = 'offline';
    }
  });
}

// Initialize a new game
function initializeNewGame() {
  gameState.currentInnings = 1;
  gameState.runs = 0;
  gameState.wickets = 0;
  gameState.balls = 0;
  gameState.overs = 0;
  gameState.currentOver = [];
  gameState.matchTimeline = [];
  gameState.overSummaries = [];
  gameState.batterDotCount = 0;
  gameState.bowlerDotCount = 0;
  
  // Initialize first innings stats
  gameState.firstInnings = {
    runs: 0,
    wickets: 0,
    overs: 0,
    batterStats: {},
    bowlerStats: {}
  };
  
  // Set powerplay status
  updatePowerplayStatus();
  
  // Save initial game state
  set(gameRef, gameState).then(() => {
    updateUI();
    showBatterSelection();
  });
}

// Update UI based on game state
function updateUI() {
  // Update scoreboard
  runsEl.textContent = gameState.runs;
  wicketsEl.textContent = gameState.wickets;
  oversEl.textContent = formatOvers(gameState.balls);
  runRateEl.textContent = calculateRunRate(gameState.runs, gameState.balls).toFixed(2);
  
  // Update mini scorecard
  miniScore.textContent = `${gameState.runs}/${gameState.wickets}`;
  miniOvers.textContent = formatOvers(gameState.balls);
  miniScorecard.style.display = 'block';
  
  // Update current over display
  updateOverDisplay();
  
  // Update powerplay/dead over indicators
  updateOverTypeIndicators();
  
  // Update timeline
  updateTimeline();
  
  // Update player comparison
  updatePlayerComparison();
}

// Update over display (balls)
function updateOverDisplay() {
  ballsContainer.innerHTML = '';
  gameState.currentOver.forEach((ball, index) => {
    const ballEl = document.createElement('div');
    ballEl.className = 'ball';
    ballEl.textContent = ball === 'W' ? 'W' : ball;
    
    if (ball === 'W') {
      ballEl.classList.add('wicket');
    } else if (ball === '0') {
      ballEl.classList.add('dot');
    } else if (parseInt(ball) >= 4) {
      ballEl.classList.add('boundary');
    }
    
    ballsContainer.appendChild(ballEl);
  });
  
  currentOverNumber.textContent = Math.floor(gameState.balls / 6) + 1;
}

// Update powerplay/dead over indicators
function updateOverTypeIndicators() {
  // Check powerplay
  gameState.isPowerplay = gameState.powerplayOvers.some(range => {
    return gameState.overs >= range[0] && gameState.overs < range[1];
  });
  
  // Check dead over (only in ODI)
  gameState.isDeadOver = gameState.format === 'ODI' && 
    gameState.deadOvers.includes(Math.floor(gameState.balls / 6));
  
  // Update indicators
  powerplayIndicator.style.display = gameState.isPowerplay ? 'inline-block' : 'none';
  deadOverIndicator.style.display = gameState.isDeadOver ? 'inline-block' : 'none';
  freeHitIndicator.style.display = gameState.isFreeHit ? 'inline-block' : 'none';
}

// Update match timeline
function updateTimeline() {
  matchTimeline.innerHTML = '';
  gameState.matchTimeline.slice().reverse().forEach(event => {
    const eventEl = document.createElement('div');
    eventEl.className = 'timeline-event';
    eventEl.innerHTML = `
      <span class="timeline-time">${event.over}.${event.ball}</span>
      <span class="timeline-event">${event.description}</span>
    `;
    matchTimeline.appendChild(eventEl);
  });
}

// Update player comparison
function updatePlayerComparison() {
  if (gameState.currentBatter) {
    const batterStats = getBatterStats(gameState.currentBatter);
    document.getElementById('comparisonBatterName').textContent = gameState.currentBatter;
    document.getElementById('comparisonBatterRuns').textContent = batterStats.runs || 0;
    document.getElementById('comparisonBatterBalls').textContent = batterStats.balls || 0;
    document.getElementById('comparisonBatterSR').textContent = batterStats.balls ? 
      ((batterStats.runs / batterStats.balls) * 100).toFixed(2) : '0.00';
    document.getElementById('comparisonBatterBoundaries').textContent = 
      `${batterStats.fours || 0}/${batterStats.sixes || 0}`;
  }
  
  if (gameState.currentBowler) {
    const bowlerStats = getBowlerStats(gameState.currentBowler);
    document.getElementById('comparisonBowlerName').textContent = gameState.currentBowler;
    document.getElementById('comparisonBowlerOvers').textContent = formatOvers(bowlerStats.balls || 0);
    document.getElementById('comparisonBowlerWickets').textContent = bowlerStats.wickets || 0;
    document.getElementById('comparisonBowlerRuns').textContent = bowlerStats.runsConceded || 0;
    document.getElementById('comparisonBowlerER').textContent = bowlerStats.balls ? 
      (bowlerStats.runsConceded / (bowlerStats.balls / 6)).toFixed(2) : '0.00';
  }
}

// Show batter selection modal
function showBatterSelection() {
  if (playerRole === (gameState.currentInnings === 1 ? 
      (gameState.battingTeam === gameState.player1Team ? 'player1' : 'player2') : 
      (gameState.bowlingTeam === gameState.player1Team ? 'player1' : 'player2'))) {
    // It's our turn to bat
    selectionTitle.textContent = 'Select Next Batter';
    selectionList.innerHTML = '';
    
    const availableBatters = gameState.battingTeam.players.filter(player => {
      const stats = getBatterStats(player);
      return !stats.out && player !== gameState.currentBatter;
    });
    
    if (availableBatters.length === 0) {
      // All out
      endInnings();
      return;
    }
    
    availableBatters.forEach(player => {
      const option = document.createElement('div');
      option.className = 'selection-option';
      option.textContent = player;
      if (player === gameState.battingTeam.captain) {
        option.textContent += ' (C)';
      } else if (player === gameState.battingTeam.viceCaptain) {
        option.textContent += ' (VC)';
      }
      option.addEventListener('click', () => {
        selectionList.querySelectorAll('.selection-option').forEach(opt => {
          opt.classList.remove('selected');
        });
        option.classList.add('selected');
        gameState.nextBatter = player;
      });
      selectionList.appendChild(option);
    });
    
    selectionModal.style.display = 'block';
  } else {
    // It's opponent's turn to bat
    resultEl.textContent = 'Waiting for opponent to select batter...';
  }
}

// Show bowler selection modal
function showBowlerSelection() {
  if (playerRole === (gameState.currentInnings === 1 ? 
      (gameState.bowlingTeam === gameState.player1Team ? 'player1' : 'player2') : 
      (gameState.battingTeam === gameState.player1Team ? 'player1' : 'player2'))) {
    // It's our turn to bowl
    selectionTitle.textContent = 'Select Next Bowler';
    selectionList.innerHTML = '';
    
    const availableBowlers = gameState.bowlingTeam.players.filter(player => {
      const maxOvers = getMaxBowlerOvers(gameState.format);
      const stats = getBowlerStats(player);
      const oversBowled = stats ? stats.balls / 6 : 0;
      return oversBowled < maxOvers && player !== gameState.currentBowler;
    });
    
    availableBowlers.forEach(player => {
      const option = document.createElement('div');
      option.className = 'selection-option';
      option.textContent = player;
      if (player === gameState.bowlingTeam.captain) {
        option.textContent += ' (C)';
      } else if (player === gameState.bowlingTeam.viceCaptain) {
        option.textContent += ' (VC)';
      }
      
      // Show overs bowled
      const stats = getBowlerStats(player);
      const oversBowled = stats ? (stats.balls / 6).toFixed(1) : '0.0';
      const maxOvers = getMaxBowlerOvers(gameState.format);
      option.textContent += ` (${oversBowled}/${maxOvers} overs)`;
      
      option.addEventListener('click', () => {
        selectionList.querySelectorAll('.selection-option').forEach(opt => {
          opt.classList.remove('selected');
        });
        option.classList.add('selected');
        gameState.nextBowler = player;
      });
      selectionList.appendChild(option);
    });
    
    selectionModal.style.display = 'block';
  } else {
    // It's opponent's turn to bowl
    resultEl.textContent = 'Waiting for opponent to select bowler...';
  }
}

// Confirm selection (batter or bowler)
confirmSelection.addEventListener('click', () => {
  if (selectionTitle.textContent.includes('Batter') && gameState.nextBatter) {
    gameState.currentBatter = gameState.nextBatter;
    gameState.nextBatter = null;
    addTimelineEvent(`${gameState.currentBatter} comes to bat`);
    selectionModal.style.display = 'none';
    resultEl.textContent = 'Select your card (0-6)';
    updatePlayerComparison();
    saveGameState();
  } else if (selectionTitle.textContent.includes('Bowler') && gameState.nextBowler) {
    gameState.currentBowler = gameState.nextBowler;
    gameState.nextBowler = null;
    addTimelineEvent(`${gameState.currentBowler} comes to bowl`);
    selectionModal.style.display = 'none';
    resultEl.textContent = 'Select your card (0-6)';
    updatePlayerComparison();
    saveGameState();
  }
});

// Check if we need to select a batter or bowler
function checkPlayerSelection() {
  if (!gameState.currentBatter) {
    showBatterSelection();
  } else if (gameState.balls % 6 === 0 && !gameState.currentBowler) {
    showBowlerSelection();
  } else {
    resultEl.textContent = 'Select your card (0-6)';
  }
}

// Card button click handler
cardButtons.forEach(button => {
  button.addEventListener('click', () => {
    if (!gameState.currentBatter || !gameState.currentBowler) {
      alert('Please wait for player selection to complete');
      return;
    }
    
    const cardValue = button.dataset.value;
    playCard(cardValue);
  });
});

// Play card
function playCard(cardValue) {
  // Disable buttons while processing
  cardButtons.forEach(btn => btn.disabled = true);
  
  // Record player's move
  const move = {
    player: playerRole,
    card: cardValue,
    timestamp: Date.now()
  };
  
  push(movesRef, move).then(() => {
    resultEl.textContent = 'Waiting for opponent to play...';
  }).catch(error => {
    console.error('Error saving move:', error);
    cardButtons.forEach(btn => btn.disabled = false);
    resultEl.textContent = 'Error submitting move. Please try again.';
  });
}

// Process opponent's move
function processOpponentMove(opponentMove) {
  if (opponentMove.player === playerRole) return; // Ignore our own moves
  
  // Get our last move
  get(movesRef).then((snapshot) => {
    const moves = snapshot.val();
    const moveKeys = Object.keys(moves);
    const ourMoveKey = moveKeys.find(key => moves[key].player === playerRole && moves[key].timestamp > opponentMove.timestamp - 5000 && moves[key].timestamp < opponentMove.timestamp + 5000);
    const ourMove = ourMoveKey ? moves[ourMoveKey] : null;
    
    if (ourMove) {
      // We have both moves, process the delivery
      processDelivery(ourMove.card, opponentMove.card);
    } else {
      // Wait for our move
      resultEl.textContent = 'Please select your card (0-6)';
      cardButtons.forEach(btn => btn.disabled = false);
    }
  });
}

// Process a delivery (both cards played)
function processDelivery(ourCard, opponentCard) {
  let batterCard, bowlerCard;
  
  // Determine which card belongs to batter and which to bowler based on innings and roles
  if ((gameState.currentInnings === 1 && playerRole === (gameState.battingTeam === gameState.player1Team ? 'player1' : 'player2')) ||
      (gameState.currentInnings === 2 && playerRole === (gameState.bowlingTeam === gameState.player1Team ? 'player1' : 'player2'))) {
    batterCard = ourCard;
    bowlerCard = opponentCard;
  } else {
    batterCard = opponentCard;
    bowlerCard = ourCard;
  }
  
  // Process based on format rules
  let runs = 0;
  let isWicket = false;
  let isNoBall = false;
  let isFreeHit = gameState.isFreeHit;
  let description = '';
  
  if (gameState.format === 'TEST') {
    // Test match rules
    if (batterCard === '0' && bowlerCard === '0') {
      // Dot ball
      description = 'Dot ball';
    } else if (batterCard === '0' && bowlerCard !== '0') {
      // Bowler's card counts as runs
      runs = parseInt(bowlerCard);
      description = `${runs} run(s) scored (bowler's card)`;
    } else if (batterCard !== '0' && bowlerCard === '0') {
      // Batter's card counts as runs
      runs = parseInt(batterCard);
      description = `${runs} run(s) scored`;
    } else if (batterCard !== '0' && bowlerCard !== '0') {
      if (batterCard === bowlerCard) {
        // Wicket
        isWicket = true;
        description = 'Wicket!';
      } else {
        // Batter's card counts as runs
        runs = parseInt(batterCard);
        description = `${runs} run(s) scored`;
      }
    }
  } else {
    // Limited overs rules (T20, ODI, etc.)
    if (batterCard === '0' && bowlerCard === '0') {
      if (gameState.isDeadOver) {
        // Dead over - dot ball
        description = 'Dot ball (dead over)';
      } else {
        // No ball (+1 run, free hit next ball)
        isNoBall = true;
        runs = 1;
        description = 'No ball! +1 run, free hit next ball';
      }
    } else if (batterCard === '0' && bowlerCard !== '0') {
      if (gameState.isDeadOver) {
        // Dead over - dot ball
        description = 'Dot ball (dead over)';
      } else {
        // Bowler's card counts as runs
        runs = parseInt(bowlerCard);
        description = `${runs} run(s) scored (bowler's card)`;
      }
    } else if (batterCard !== '0' && bowlerCard === '0') {
      if (gameState.isFreeHit) {
        // Free hit - batter's card counts as runs, can't be out
        runs = parseInt(batterCard);
        description = `${runs} run(s) scored (free hit)`;
      } else if (gameState.isDeadOver) {
        // Dead over - dot ball
        description = 'Dot ball (dead over)';
      } else {
        // Dot ball
        description = 'Dot ball';
      }
    } else if (batterCard !== '0' && bowlerCard !== '0') {
      if (batterCard === bowlerCard) {
        if (gameState.isFreeHit) {
          // Free hit - no wicket
          description = 'Wicket saved (free hit)';
        } else {
          // Wicket
          isWicket = true;
          description = 'Wicket!';
        }
      } else {
        // Batter's card counts as runs
        runs = parseInt(batterCard);
        description = `${runs} run(s) scored`;
      }
    }
  }
  
  // Update dot counts
  if (runs === 0 && !isNoBall && !isFreeHit) {
    gameState.batterDotCount++;
    gameState.bowlerDotCount++;
    
    // Check for too many dots
    if (gameState.batterDotCount >= 4) {
      runs -= 5; // Penalty for too many dots
      description = 'Too many dot balls! -5 runs';
      gameState.batterDotCount = 0;
    }
    
    if (gameState.bowlerDotCount >= 4 && gameState.format !== 'TEST') {
      isNoBall = true;
      runs += 1;
      description = 'No ball! +1 run (too many dots)';
      gameState.bowlerDotCount = 0;
    }
  } else {
    gameState.batterDotCount = 0;
    gameState.bowlerDotCount = 0;
  }
  
  // Update game state
  if (!isNoBall) {
    gameState.balls++;
    
    // Check if over completed
    if (gameState.balls % 6 === 0) {
      gameState.overs++;
      gameState.currentBowler = null; // Need to select new bowler
      addOverSummary();
    }
  } else {
    // No ball - ball doesn't count
    gameState.isFreeHit = true;
  }
  
  // Update runs
  gameState.runs += runs;
  
  // Update wicket if applicable
  if (isWicket) {
    const wicketValue = getWicketValue();
    updateBatterWickets(gameState.currentBatter, wicketValue);
    
    if (isBatterOut(gameState.currentBatter)) {
      gameState.wickets++;
      description += ` - ${gameState.currentBatter} out!`;
      addTimelineEvent(`${gameState.currentBatter} out (${getDismissalType()})`);
      gameState.currentBatter = null;
    } else {
      description += ` - ${gameState.currentBatter} loses ${wicketValue} of a wicket`;
    }
  }
  
  // Record the ball in current over
  gameState.currentOver.push(isWicket ? 'W' : runs.toString());
  
  // Update batter stats
  updateBatterStats(gameState.currentBatter, runs, isWicket);
  
  // Update bowler stats
  if (!isFreeHit) {
    updateBowlerStats(gameState.currentBowler, runs, isWicket, isNoBall);
  }
  
  // Add to timeline
  addTimelineEvent(`${gameState.overs}.${gameState.balls % 6}: ${description}`);
  
  // Check for innings end conditions
  if (gameState.wickets >= 10 || 
      (gameState.format !== 'TEST' && gameState.overs >= gameState.maxOvers)) {
    endInnings();
  } else {
    // Update UI and save state
    updateUI();
    saveGameState();
    
    // Check if we need to select a new batter or bowler
    checkPlayerSelection();
    
    // Re-enable buttons
    cardButtons.forEach(btn => btn.disabled = false);
  }
}

// Get wicket value based on format and powerplay status
function getWicketValue() {
  if (gameState.format === 'TEST') return 0.33; // 1/3 of a wicket in Tests
  
  if (gameState.isPowerplay) {
    return gameState.format === 'ODI' ? 0.25 : 0.5;
  } else {
    return gameState.format === 'ODI' ? 0.5 : 1.0;
  }
}

// Check if batter is out (wicket value >= 1)
function isBatterOut(batter) {
  const stats = getBatterStats(batter);
  return stats.wickets >= 1.0;
}

// Get dismissal type
function getDismissalType() {
  const types = ['caught', 'bowled', 'lbw', 'run out', 'stumped'];
  return types[Math.floor(Math.random() * types.length)];
}

// Update batter's wickets
function updateBatterWickets(batter, value) {
  const stats = getBatterStats(batter);
  stats.wickets = (stats.wickets || 0) + value;
  
  if (gameState.currentInnings === 1) {
    gameState.firstInnings.batterStats[batter] = stats;
  } else {
    gameState.secondInnings.batterStats[batter] = stats;
  }
}

// Update batter stats
function updateBatterStats(batter, runs, isWicket) {
  const stats = getBatterStats(batter);
  
  stats.runs = (stats.runs || 0) + runs;
  stats.balls = (stats.balls || 0) + 1;
  
  if (runs === 4) stats.fours = (stats.fours || 0) + 1;
  if (runs === 6) stats.sixes = (stats.sixes || 0) + 1;
  
  if (isWicket) {
    stats.out = true;
  }
  
  if (gameState.currentInnings === 1) {
    gameState.firstInnings.batterStats[batter] = stats;
  } else {
    gameState.secondInnings.batterStats[batter] = stats;
  }
}

// Update bowler stats
function updateBowlerStats(bowler, runs, isWicket, isNoBall) {
  const stats = getBowlerStats(bowler);
  
  stats.runsConceded = (stats.runsConceded || 0) + runs;
  stats.balls = (stats.balls || 0) + (isNoBall ? 0 : 1);
  
  if (isWicket) {
    stats.wickets = (stats.wickets || 0) + 1;
  }
  
  if (gameState.currentInnings === 1) {
    gameState.firstInnings.bowlerStats[bowler] = stats;
  } else {
    gameState.secondInnings.bowlerStats[bowler] = stats;
  }
}

// Get batter stats
function getBatterStats(batter) {
  if (gameState.currentInnings === 1) {
    return gameState.firstInnings.batterStats[batter] || {};
  } else {
    return gameState.secondInnings.batterStats[batter] || {};
  }
}

// Get bowler stats
function getBowlerStats(bowler) {
  if (gameState.currentInnings === 1) {
    return gameState.firstInnings.bowlerStats[bowler] || {};
  } else {
    return gameState.secondInnings.bowlerStats[bowler] || {};
  }
}

// Add over summary
function addOverSummary() {
  const overNumber = gameState.overs;
  const runsInOver = gameState.currentOver.reduce((sum, ball) => {
    return sum + (ball === 'W' ? 0 : parseInt(ball));
  }, 0);
  const wicketsInOver = gameState.currentOver.filter(ball => ball === 'W').length;
  
  const summary = {
    over: overNumber,
    bowler: gameState.currentBowler,
    runs: runsInOver,
    wickets: wicketsInOver,
    balls: gameState.currentOver.map(ball => ball === 'W' ? 'W' : ball)
  };
  
  gameState.overSummaries.push(summary);
  
  // Add to over summary list
  const overEl = document.createElement('div');
  overEl.className = 'over-summary';
  overEl.innerHTML = `
    <strong>Over ${overNumber}:</strong> ${gameState.currentBowler} - ${runsInOver}r/${wicketsInOver}w
    <div class="over-balls">${gameState.currentOver.join(', ')}</div>
  `;
  overSummaryList.insertBefore(overEl, overSummaryList.firstChild);
  
  // Clear current over
  gameState.currentOver = [];
}

// Add timeline event
function addTimelineEvent(description) {
  const event = {
    over: gameState.overs,
    ball: gameState.balls % 6,
    description: description
  };
  
  gameState.matchTimeline.push(event);
  
  // Keep only last 20 events
  if (gameState.matchTimeline.length > 20) {
    gameState.matchTimeline.shift();
  }
}

// End current innings
function endInnings() {
  // Save innings totals
  if (gameState.currentInnings === 1) {
    gameState.firstInnings.runs = gameState.runs;
    gameState.firstInnings.wickets = gameState.wickets;
    gameState.firstInnings.overs = gameState.overs + (gameState.balls % 6) / 6;
    gameState.target = gameState.runs + 1;
  } else {
    gameState.secondInnings.runs = gameState.runs;
    gameState.secondInnings.wickets = gameState.wickets;
    gameState.secondInnings.overs = gameState.overs + (gameState.balls % 6) / 6;
  }
  
  // Show innings summary
  showInningsSummary();
}

// Show innings summary
function showInningsSummary() {
  summaryTitle.textContent = gameState.currentInnings === 1 ? 
    'First Innings Summary' : 'Second Innings Summary';
  
  if (gameState.currentInnings === 1) {
    summaryTotalRuns.textContent = gameState.firstInnings.runs;
    summaryWickets.textContent = gameState.firstInnings.wickets;
    summaryOvers.textContent = gameState.firstInnings.overs.toFixed(1);
    summaryRunRate.textContent = (gameState.firstInnings.runs / gameState.firstInnings.overs).toFixed(2);
    summaryHighlight.textContent = `Target: ${gameState.target} runs`;
    targetDisplay.style.display = 'none'; // Only show target in second innings
    
    // Show top performers
    const topBatter = getTopBatter(gameState.firstInnings.batterStats);
    const topBowler = getTopBowler(gameState.firstInnings.bowlerStats);
    
    if (topBatter) {
      summaryHighlight.textContent += ` | Top scorer: ${topBatter.name} (${topBatter.runs})`;
    }
    if (topBowler) {
      summaryHighlight.textContent += ` | Best bowler: ${topBowler.name} (${topBowler.wickets}/${topBowler.runsConceded})`;
    }
  } else {
    summaryTotalRuns.textContent = gameState.secondInnings.runs;
    summaryWickets.textContent = gameState.secondInnings.wickets;
    summaryOvers.textContent = gameState.secondInnings.overs.toFixed(1);
    summaryRunRate.textContent = (gameState.secondInnings.runs / gameState.secondInnings.overs).toFixed(2);
    
    // Show match result
    const margin = Math.abs(gameState.secondInnings.runs - gameState.firstInnings.runs);
    if (gameState.secondInnings.runs >= gameState.target) {
      summaryHighlight.textContent = `${gameState.battingTeam.name} won by ${10 - gameState.secondInnings.wickets} wickets`;
    } else {
      summaryHighlight.textContent = `${gameState.bowlingTeam.name} won by ${margin} runs`;
    }
    
    // Show player of the match
    const playerOfMatch = getPlayerOfMatch();
    summaryHighlight.textContent += ` | Player of the Match: ${playerOfMatch}`;
    
    // Show awards
    showAwards();
  }
  
  // Update stats tables
  updateStatsTables();
  
  // Show the summary popup
  summaryPopup.style.display = 'block';
  
  // Save game state
  saveGameState();
}

// Get top batter
function getTopBatter(batterStats) {
  let topBatter = null;
  for (const [name, stats] of Object.entries(batterStats)) {
    if (!topBatter || stats.runs > topBatter.runs) {
      topBatter = { name, ...stats };
    }
  }
  return topBatter;
}

// Get top bowler
function getTopBowler(bowlerStats) {
  let topBowler = null;
  for (const [name, stats] of Object.entries(bowlerStats)) {
    if (!topBowler || stats.wickets > topBowler.wickets || 
        (stats.wickets === topBowler.wickets && stats.runsConceded < topBowler.runsConceded)) {
      topBowler = { name, ...stats };
    }
  }
  return topBowler;
}

// Get player of the match
function getPlayerOfMatch() {
  // Simple implementation - could be enhanced
  const firstInningsBatter = getTopBatter(gameState.firstInnings.batterStats);
  const secondInningsBatter = getTopBatter(gameState.secondInnings.batterStats);
  const firstInningsBowler = getTopBowler(gameState.firstInnings.bowlerStats);
  const secondInningsBowler = getTopBowler(gameState.secondInnings.bowlerStats);
  
  const candidates = [
    firstInningsBatter,
    secondInningsBatter,
    firstInningsBowler,
    secondInningsBowler
  ].filter(p => p);
  
  // Find player with most impact (runs + wickets*25)
  let bestPlayer = null;
  let bestScore = 0;
  
  candidates.forEach(player => {
    const score = (player.runs || 0) + ((player.wickets || 0) * 25;
    if (score > bestScore) {
      bestScore = score;
      bestPlayer = player;
    }
  });
  
  return bestPlayer ? bestPlayer.name : 'None';
}

// Show awards
function showAwards() {
  const awardsContainer = document.getElementById('awardsContainer');
  awardsContainer.innerHTML = '';
  awardsContainer.style.display = 'block';
  
  // Top scorer
  const topScorer = getTopBatter({
    ...gameState.firstInnings.batterStats,
    ...gameState.secondInnings.batterStats
  });
  
  if (topScorer) {
    const awardEl = document.createElement('div');
    awardEl.className = 'award';
    awardEl.innerHTML = `<strong>Top Scorer:</strong> ${topScorer.name} (${topScorer.runs} runs)`;
    awardsContainer.appendChild(awardEl);
  }
  
  // Best bowler
  const bestBowler = getTopBowler({
    ...gameState.firstInnings.bowlerStats,
    ...gameState.secondInnings.bowlerStats
  });
  
  if (bestBowler) {
    const awardEl = document.createElement('div');
    awardEl.className = 'award';
    awardEl.innerHTML = `<strong>Best Bowler:</strong> ${bestBowler.name} (${bestBowler.wickets}/${bestBowler.runsConceded})`;
    awardsContainer.appendChild(awardEl);
  }
  
  // Most boundaries
  let mostBoundaries = null;
  let mostBoundariesCount = 0;
  
  for (const [name, stats] of Object.entries({
    ...gameState.firstInnings.batterStats,
    ...gameState.secondInnings.batterStats
  })) {
    const boundaries = (stats.fours || 0) + (stats.sixes || 0);
    if (boundaries > mostBoundariesCount) {
      mostBoundariesCount = boundaries;
      mostBoundaries = { name, ...stats };
    }
  }
  
  if (mostBoundaries) {
    const awardEl = document.createElement('div');
    awardEl.className = 'award';
    awardEl.innerHTML = `<strong>Most Boundaries:</strong> ${mostBoundaries.name} (${mostBoundaries.fours || 0} fours, ${mostBoundaries.sixes || 0} sixes)`;
    awardsContainer.appendChild(awardEl);
  }
}

// Update stats tables
function updateStatsTables() {
  // Batters stats
  battersStatsBody.innerHTML = '';
  const currentBatters = gameState.currentInnings === 1 ? 
    gameState.firstInnings.batterStats : gameState.secondInnings.batterStats;
  
  const battersArray = Object.entries(currentBatters).map(([name, stats]) => ({ name, ...stats }));
  battersArray.sort((a, b) => b.runs - a.runs);
  
  battersArray.forEach(batter => {
    const row = document.createElement('tr');
    const sr = batter.balls ? ((batter.runs / batter.balls) * 100).toFixed(2) : '0.00';
    
    row.innerHTML = `
      <td>${batter.name}${batter.out ? '†' : ''}</td>
      <td>${batter.runs || 0}</td>
      <td>${batter.balls || 0}</td>
      <td>${sr}</td>
      <td>${batter.fours || 0}/${batter.sixes || 0}</td>
    `;
    battersStatsBody.appendChild(row);
  });
  
  // Bowlers stats
  bowlersStatsBody.innerHTML = '';
  const currentBowlers = gameState.currentInnings === 1 ? 
    gameState.firstInnings.bowlerStats : gameState.secondInnings.bowlerStats;
  
  const bowlersArray = Object.entries(currentBowlers).map(([name, stats]) => ({ name, ...stats }));
  bowlersArray.sort((a, b) => b.wickets - a.wickets || a.runsConceded - b.runsConceded);
  
  bowlersArray.forEach(bowler => {
    const row = document.createElement('tr');
    const overs = formatOvers(bowler.balls || 0);
    const economy = bowler.balls ? (bowler.runsConceded / (bowler.balls / 6)).toFixed(2) : '0.00';
    
    row.innerHTML = `
      <td>${bowler.name}</td>
      <td>${overs}</td>
      <td>${bowler.wickets || 0}</td>
      <td>${bowler.runsConceded || 0}</td>
      <td>${economy}</td>
    `;
    bowlersStatsBody.appendChild(row);
  });
}

// Start second innings
startSecondInningsBtn.addEventListener('click', () => {
  if (gameState.currentInnings === 1) {
    // Switch to second innings
    gameState.currentInnings = 2;
    gameState.runs = 0;
    gameState.wickets = 0;
    gameState.balls = 0;
    gameState.overs = 0;
    gameState.currentOver = [];
    gameState.matchTimeline = [];
    gameState.overSummaries = [];
    gameState.batterDotCount = 0;
    gameState.bowlerDotCount = 0;
    gameState.isFreeHit = false;
    
    // Swap batting and bowling teams
    const temp = gameState.battingTeam;
    gameState.battingTeam = gameState.bowlingTeam;
    gameState.bowlingTeam = temp;
    
    // Update UI
    battingTeamNameEl.textContent = gameState.battingTeam.name;
    inningsNumber.textContent = '2nd Innings';
    targetDisplay.style.display = 'flex';
    targetValue.textContent = gameState.target;
    
    // Hide summary popup
    summaryPopup.style.display = 'none';
    
    // Save game state
    saveGameState();
    
    // Show batter selection
    showBatterSelection();
  } else {
    // Match is complete - save to completed matches
    saveCompletedMatch();
  }
});

// Save completed match
function saveCompletedMatch() {
  const matchData = {
    player1: {
      username: gameState.player1Team.name,
      team: gameState.player1Team.name,
      players: gameState.player1Team.players,
      captain: gameState.player1Team.captain,
      viceCaptain: gameState.player1Team.viceCaptain
    },
    player2: {
      username: gameState.player2Team.name,
      team: gameState.player2Team.name,
      players: gameState.player2Team.players,
      captain: gameState.player2Team.captain,
      viceCaptain: gameState.player2Team.viceCaptain
    },
    toss: {
      winner: gameState.battingTeam === gameState.player1Team ? 'player1' : 'player2',
      battingFirst: gameState.battingTeam === gameState.player1Team ? 'player1' : 'player2',
      battingChoice: 'bat' // Simplified
    },
    firstInnings: {
      totalRuns: gameState.firstInnings.runs,
      totalWickets: gameState.firstInnings.wickets,
      balls: gameState.firstInnings.overs * 6,
      batterStats: gameState.firstInnings.batterStats,
      bowlerStats: gameState.firstInnings.bowlerStats
    },
    secondInnings: {
      totalRuns: gameState.secondInnings.runs,
      totalWickets: gameState.secondInnings.wickets,
      balls: gameState.secondInnings.overs * 6,
      batterStats: gameState.secondInnings.batterStats,
      bowlerStats: gameState.secondInnings.bowlerStats
    },
    winner: gameState.secondInnings.runs >= gameState.target ? 
      (gameState.battingTeam === gameState.player1Team ? 'player1' : 'player2') :
      (gameState.bowlingTeam === gameState.player1Team ? 'player1' : 'player2'),
    winningMargin: getWinningMargin(),
    format: gameState.format,
    timestamp: Date.now(),
    player1Stats: getPlayerStats('player1'),
    player2Stats: getPlayerStats('player2'),
    playerOfTheMatch: getPlayerOfMatch()
  };
  
  push(completedMatchesRef, matchData).then(() => {
    // Redirect to match summary
    window.location.href = `match_summary.html?id=${roomId}`;
  });
}

// Get player stats for leaderboard
function getPlayerStats(player) {
  const team = player === 'player1' ? gameState.player1Team : gameState.player2Team;
  const isBattingFirst = gameState.battingTeam === team;
  
  const stats = {};
  
  team.players.forEach(playerName => {
    stats[playerName] = {
      runs: ((isBattingFirst ? gameState.firstInnings.batterStats[playerName]?.runs : gameState.secondInnings.batterStats[playerName]?.runs) || 0) +
             ((!isBattingFirst ? gameState.firstInnings.batterStats[playerName]?.runs : gameState.secondInnings.batterStats[playerName]?.runs) || 0),
      balls: ((isBattingFirst ? gameState.firstInnings.batterStats[playerName]?.balls : gameState.secondInnings.batterStats[playerName]?.balls) || 0) +
             ((!isBattingFirst ? gameState.firstInnings.batterStats[playerName]?.balls : gameState.secondInnings.batterStats[playerName]?.balls) || 0),
      fours: ((isBattingFirst ? gameState.firstInnings.batterStats[playerName]?.fours : gameState.secondInnings.batterStats[playerName]?.fours) || 0) +
             ((!isBattingFirst ? gameState.firstInnings.batterStats[playerName]?.fours : gameState.secondInnings.batterStats[playerName]?.fours) || 0),
      sixes: ((isBattingFirst ? gameState.firstInnings.batterStats[playerName]?.sixes : gameState.secondInnings.batterStats[playerName]?.sixes) || 0) +
             ((!isBattingFirst ? gameState.firstInnings.batterStats[playerName]?.sixes : gameState.secondInnings.batterStats[playerName]?.sixes) || 0),
      wickets: ((isBattingFirst ? gameState.firstInnings.bowlerStats[playerName]?.wickets : gameState.secondInnings.bowlerStats[playerName]?.wickets) || 0) +
               ((!isBattingFirst ? gameState.firstInnings.bowlerStats[playerName]?.wickets : gameState.secondInnings.bowlerStats[playerName]?.wickets) || 0),
      runsConceded: ((isBattingFirst ? gameState.firstInnings.bowlerStats[playerName]?.runsConceded : gameState.secondInnings.bowlerStats[playerName]?.runsConceded) || 0) +
                   ((!isBattingFirst ? gameState.firstInnings.bowlerStats[playerName]?.runsConceded : gameState.secondInnings.bowlerStats[playerName]?.runsConceded) || 0),
      overs: ((isBattingFirst ? gameState.firstInnings.bowlerStats[playerName]?.balls : gameState.secondInnings.bowlerStats[playerName]?.balls) || 0) +
             ((!isBattingFirst ? gameState.firstInnings.bowlerStats[playerName]?.balls : gameState.secondInnings.bowlerStats[playerName]?.balls) || 0) / 6
    };
  });
  
  return stats;
}

// Get winning margin
function getWinningMargin() {
  if (gameState.secondInnings.runs >= gameState.target) {
    return `${10 - gameState.secondInnings.wickets} wickets`;
  } else {
    return `${gameState.target - gameState.secondInnings.runs - 1} runs`;
  }
}

// Save game state
function saveGameState() {
  update(gameRef, gameState).catch(error => {
    console.error('Error saving game state:', error);
  });
}

// Format overs (balls to overs.balls)
function formatOvers(balls) {
  return `${Math.floor(balls / 6)}.${balls % 6}`;
}

// Calculate run rate
function calculateRunRate(runs, balls) {
  const overs = balls / 6;
  return overs > 0 ? runs / overs : 0;
}

// Get max overs based on format
function getMaxOvers(format) {
  switch(format) {
    case 'T5': return 5;
    case 'T10': return 10;
    case 'ODI': return 50;
    case 'TEST': return Infinity; // Unlimited for Test
    default: return 20; // Default to T20
  }
}

// Get max bowler overs based on format
function getMaxBowlerOvers(format) {
  const maxOvers = getMaxOvers(format);
  if (maxOvers === 5) return 1; // T5 - 1 over per bowler
  if (maxOvers === 10) return 2; // T10 - 2 overs per bowler
  if (maxOvers === 50) return 10; // ODI - 10 overs per bowler
  return 4; // T20 - 4 overs per bowler
}

// Get powerplay overs based on format
function getPowerplayOvers(format) {
  switch(format) {
    case 'T5': return [[0, 2]]; // First 2 overs
    case 'T10': return [[0, 3]]; // First 3 overs
    case 'ODI': return [[0, 10], [20, 30], [40, 42]]; // 3 powerplays in ODI
    default: return [[0, 6]]; // T20 - first 6 overs
  }
}

// Get format display name
function getFormatDisplayName(format) {
  switch(format) {
    case 'T5': return 'T5 (5 Overs)';
    case 'T10': return 'T10 (10 Overs)';
    case 'ODI': return 'ODI (50 Overs)';
    case 'TEST': return 'Test Match';
    default: return 'T20 (20 Overs)';
  }
}

// Update teams modal
function updateTeamsModal() {
  modalTeam1Players.innerHTML = '';
  gameState.player1Team.players.forEach(player => {
    const li = document.createElement('li');
    li.textContent = player;
    if (player === gameState.player1Team.captain) {
      li.textContent += ' (C)';
    } else if (player === gameState.player1Team.viceCaptain) {
      li.textContent += ' (VC)';
    }
    modalTeam1Players.appendChild(li);
  });
  
  modalTeam2Players.innerHTML = '';
  gameState.player2Team.players.forEach(player => {
    const li = document.createElement('li');
    li.textContent = player;
    if (player === gameState.player2Team.captain) {
      li.textContent += ' (C)';
    } else if (player === gameState.player2Team.viceCaptain) {
      li.textContent += ' (VC)';
    }
    modalTeam2Players.appendChild(li);
  });
}

// Show teams modal
showTeamsBtn.addEventListener('click', () => {
  teamsModal.style.display = 'block';
});

// Close teams modal
closeTeamsBtn.addEventListener('click', () => {
  teamsModal.style.display = 'none';
});

// Team navigation in modal
let currentTeamSlide = 0;
nextTeamBtn.addEventListener('click', () => {
  currentTeamSlide = 1;
  updateTeamNav();
});

prevTeamBtn.addEventListener('click', () => {
  currentTeamSlide = 0;
  updateTeamNav();
});

function updateTeamNav() {
  document.getElementById('team1Slide').style.display = currentTeamSlide === 0 ? 'block' : 'none';
  document.getElementById('team2Slide').style.display = currentTeamSlide === 1 ? 'block' : 'none';
  prevTeamBtn.disabled = currentTeamSlide === 0;
  nextTeamBtn.disabled = currentTeamSlide === 1;
  
  // Update dots
  document.querySelectorAll('.team-nav-dot').forEach((dot, index) => {
    dot.classList.toggle('active', index === currentTeamSlide);
  });
}

// Stats navigation in summary popup
let currentStatsSlide = 0;
document.getElementById('nextStatsBtn').addEventListener('click', () => {
  currentStatsSlide = 1;
  updateStatsNav();
});

document.getElementById('prevStatsBtn').addEventListener('click', () => {
  currentStatsSlide = 0;
  updateStatsNav();
});

function updateStatsNav() {
  document.querySelectorAll('.stats-slide').forEach((slide, index) => {
    slide.style.display = currentStatsSlide === index ? 'block' : 'none';
  });
  document.getElementById('prevStatsBtn').disabled = currentStatsSlide === 0;
  document.getElementById('nextStatsBtn').disabled = currentStatsSlide === 1;
  
  // Update dots
  document.querySelectorAll('.team-nav-indicator .team-nav-dot').forEach((dot, index) => {
    dot.classList.toggle('active', index === currentStatsSlide);
  });
}

// Save and exit
saveBtn.addEventListener('click', () => {
  saveGameState();
  window.location.href = 'index.html';
});

// Exit without saving
exitBtn.addEventListener('click', () => {
  window.location.href = 'index.html';
});

// Reset plays
resetPlaysBtn.addEventListener('click', () => {
  if (confirm('Are you sure you want to reset all plays in this over?')) {
    gameState.currentOver = [];
    gameState.batterDotCount = 0;
    gameState.bowlerDotCount = 0;
    updateUI();
    saveGameState();
  }
});

// Initialize the game
initGame();

// Handle page unload
window.addEventListener('beforeunload', () => {
  set(playerRef, {
    name: gameState.player1Team.name,
    connected: false
  });
});
</script>
</body>
</html>