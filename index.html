<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HandiCricket - Lobby</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #061e3e;
      color: white;
      margin: 0;
      padding: 20px;
      text-align: center;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: rgba(0, 0, 0, 0.2);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }
    
    h1 {
      color: #ffeb3b;
      margin-bottom: 30px;
      text-shadow: 0 0 5px rgba(255, 235, 59, 0.5);
    }
    
    .card {
      background: rgba(13, 42, 82, 0.8);
      border-radius: 8px;
      padding: 20px;
      margin: 15px 0;
      text-align: left;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    
    input, select, button {
      width: 100%;
      padding: 10px;
      border-radius: 5px;
      border: none;
      font-size: 16px;
    }
    
    button {
      background: linear-gradient(145deg, #1e88e5, #1565c0);
      color: white;
      cursor: pointer;
      margin-top: 10px;
      transition: all 0.2s;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    button:disabled {
      background: #607d8b;
      cursor: not-allowed;
      transform: none;
    }
    
    .team-players {
      margin-top: 10px;
    }
    
    .player-input {
      display: flex;
      margin-bottom: 5px;
    }
    
    .player-input input {
      flex: 1;
      margin-right: 5px;
    }
    
    .add-player {
      background: #4caf50;
      padding: 5px 10px;
      font-size: 14px;
      width: auto;
    }
    
    .room-code {
      font-size: 24px;
      font-weight: bold;
      letter-spacing: 3px;
      color: #ffeb3b;
      margin: 20px 0;
      background: rgba(0,0,0,0.3);
      padding: 10px;
      border-radius: 5px;
      display: none;
    }
    
    .tabs {
      display: flex;
      margin-bottom: 20px;
    }
    
    .tab {
      flex: 1;
      padding: 10px;
      background: rgba(30, 136, 229, 0.3);
      cursor: pointer;
      border-radius: 5px 5px 0 0;
    }
    
    .tab.active {
      background: rgba(30, 136, 229, 0.8);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .spectator-form {
      margin-top: 30px;
    }
    
    @media (max-width: 600px) {
      .container {
        padding: 15px;
      }
      
      .player-input {
        flex-direction: column;
      }
      
      .player-input input {
        margin-right: 0;
        margin-bottom: 5px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üèè HandiCricket</h1>
    
    <div class="tabs">
      <div class="tab active" onclick="switchTab('create')">Create Room</div>
      <div class="tab" onclick="switchTab('join')">Join Room</div>
    </div>
    
    <div id="createTab" class="tab-content active">
      <div class="card">
        <h2>Create New Match</h2>
        
        <div class="form-group">
          <label for="teamName1">Your Team Name</label>
          <input type="text" id="teamName1" placeholder="Enter your team name" required>
        </div>
        
        <div class="form-group">
          <label for="format">Match Format</label>
          <select id="format">
            <option value="5">5 Overs</option>
            <option value="10">10 Overs</option>
            <option value="20">T20 (20 Overs)</option>
            <option value="50">ODI (50 Overs)</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Your Playing 11</label>
          <div class="team-players" id="team1Players">
            <div class="player-input">
              <input type="text" class="player-name" placeholder="Player name" required>
              <button type="button" class="add-player" onclick="addPlayer('team1')">+</button>
            </div>
          </div>
        </div>
        
        <button id="createRoomBtn" onclick="createRoom()">Create Room</button>
      </div>
      
      <div id="roomCreated" class="room-code" style="display: none;">
        Room Code: <span id="roomCodeDisplay"></span>
        <div style="font-size: 14px; margin-top: 10px;">Share this code with your opponent</div>
      </div>
    </div>
    
    <div id="joinTab" class="tab-content">
      <div class="card">
        <h2>Join Existing Match</h2>
        
        <div class="form-group">
          <label for="teamName2">Your Team Name</label>
          <input type="text" id="teamName2" placeholder="Enter your team name" required>
        </div>
        
        <div class="form-group">
          <label for="roomCode">Room Code</label>
          <input type="text" id="roomCode" placeholder="Enter room code" required>
        </div>
        
        <div class="form-group">
          <label>Your Playing 11</label>
          <div class="team-players" id="team2Players">
            <div class="player-input">
              <input type="text" class="player-name" placeholder="Player name" required>
              <button type="button" class="add-player" onclick="addPlayer('team2')">+</button>
            </div>
          </div>
        </div>
        
        <button id="joinRoomBtn" onclick="joinRoom()">Join Room</button>
      </div>
    </div>
    
    <div class="spectator-form">
      <div class="card">
        <h2>Spectator Mode</h2>
        <div class="form-group">
          <label for="spectatorRoomCode">Room Code</label>
          <input type="text" id="spectatorRoomCode" placeholder="Enter room code">
        </div>
        <button id="spectateBtn" onclick="spectateRoom()">Watch Match</button>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCN6aZMwlsZe7JJaovU0WA3UQygWr4jYmA",
      authDomain: "handicricket-85a06.firebaseapp.com",
      projectId: "handicricket-85a06",
      storageBucket: "handicricket-85a06.appspot.com",
      messagingSenderId: "599182538558",
      appId: "1:599182538558:web:3e965753ab05f8f1e3de6f",
      measurementId: "G-HSV9H4LEJQ"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
      document.getElementById(`${tabName}Tab`).classList.add('active');
    }

    function addPlayer(team) {
      const container = document.getElementById(`${team}Players`);
      const playerInputs = container.querySelectorAll('.player-name');
      
      // Check if last input is empty
      const lastInput = playerInputs[playerInputs.length - 1];
      if (!lastInput.value.trim()) {
        alert('Please enter a player name before adding another');
        return;
      }
      
      // Don't allow more than 11 players
      if (playerInputs.length >= 11) {
        alert('Maximum 11 players allowed');
        return;
      }
      
      const newPlayerDiv = document.createElement('div');
      newPlayerDiv.className = 'player-input';
      newPlayerDiv.innerHTML = `
        <input type="text" class="player-name" placeholder="Player name" required>
        <button type="button" class="add-player" onclick="addPlayer('${team}')">+</button>
      `;
      container.appendChild(newPlayerDiv);
    }

    function generateRoomCode() {
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      let code = '';
      for (let i = 0; i < 6; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return code;
    }

    async function createRoom() {
      const teamName = document.getElementById('teamName1').value.trim();
      const format = document.getElementById('format').value;
      const playerInputs = document.querySelectorAll('#team1Players .player-name');
      
      // Validate inputs
      if (!teamName) {
        alert('Please enter your team name');
        return;
      }
      
      const players = [];
      for (const input of playerInputs) {
        const name = input.value.trim();
        if (!name) {
          alert('Please enter all player names');
          return;
        }
        players.push(name);
      }
      
      if (players.length < 1) {
        alert('Please enter at least 1 player');
        return;
      }
      
      const roomCode = generateRoomCode();
      const roomRef = db.ref(`rooms/${roomCode}`);
      
      try {
        // Check if room already exists (unlikely with random code but possible)
        const snapshot = await roomRef.once('value');
        if (snapshot.exists()) {
          alert('Room already exists, please try again');
          return;
        }
        
        // Create room
        await roomRef.set({
          player1: {
            team: teamName,
            players: players,
            format: format,
            ready: false
          },
          gameStarted: false,
          createdAt: firebase.database.ServerValue.TIMESTAMP
        });
        
        // Show room code
        document.getElementById('roomCodeDisplay').textContent = roomCode;
        document.getElementById('roomCreated').style.display = 'block';
        document.getElementById('createRoomBtn').disabled = true;
        
        // Redirect to toss page when opponent joins
        const opponentRef = db.ref(`rooms/${roomCode}/player2`);
        opponentRef.on('value', (snap) => {
          if (snap.exists()) {
            window.location.href = `toss.html?room=${roomCode}&player=player1`;
          }
        });
        
      } catch (error) {
        console.error('Error creating room:', error);
        alert('Failed to create room. Please try again.');
      }
    }

    async function joinRoom() {
      const teamName = document.getElementById('teamName2').value.trim();
      const roomCode = document.getElementById('roomCode').value.trim().toUpperCase();
      const playerInputs = document.querySelectorAll('#team2Players .player-name');
      
      // Validate inputs
      if (!teamName) {
        alert('Please enter your team name');
        return;
      }
      
      if (!roomCode || roomCode.length !== 6) {
        alert('Please enter a valid 6-character room code');
        return;
      }
      
      const players = [];
      for (const input of playerInputs) {
        const name = input.value.trim();
        if (!name) {
          alert('Please enter all player names');
          return;
        }
        players.push(name);
      }
      
      if (players.length < 1) {
        alert('Please enter at least 1 player');
        return;
      }
      
      const roomRef = db.ref(`rooms/${roomCode}`);
      
      try {
        // Check if room exists
        const snapshot = await roomRef.once('value');
        if (!snapshot.exists()) {
          alert('Room not found. Please check the code.');
          return;
        }
        
        const roomData = snapshot.val();
        
        // Check if player2 already exists
        if (roomData.player2) {
          alert('Room is already full');
          return;
        }
        
        // Check if game already started
        if (roomData.gameStarted) {
          alert('Game has already started in this room');
          return;
        }
        
        // Join room as player2
        await db.ref(`rooms/${roomCode}/player2`).set({
          team: teamName,
          players: players,
          ready: false
        });
        
        // Redirect to toss page
        window.location.href = `toss.html?room=${roomCode}&player=player2`;
        
      } catch (error) {
        console.error('Error joining room:', error);
        alert('Failed to join room. Please try again.');
      }
    }

    function spectateRoom() {
      const roomCode = document.getElementById('spectatorRoomCode').value.trim().toUpperCase();
      
      if (!roomCode || roomCode.length !== 6) {
        alert('Please enter a valid 6-character room code');
        return;
      }
      
      window.location.href = `game_first_innings.html?room=${roomCode}&player=spectator`;
    }
  </script>
</body>
</html>
