<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>HandiCricket - Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>

#freeHitBadge {
  display: none;
  background: #ffeb3b;
  color: #000;
  padding: 5px 10px;
  border-radius: 15px;
  font-weight: bold;
  margin: 10px auto;
  width: fit-content;
}
#freeHitBadge {
  display: none;
  background: #ffeb3b;
  color: #000;
  padding: 5px 10px;
  border-radius: 15px;
  font-weight: bold;
  margin: 10px auto;
  width: fit-content;
}
    body { background: #061e3e; color: white; font-family: sans-serif; text-align: center; padding: 20px; }
    .card-row { margin-top: 20px; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
    button.card { width: 60px; height: 60px; font-size: 20px; border-radius: 12px; border: none; background: #1e88e5; color: white; }
    button.card:disabled { background: #607d8b; color: #ccc; }
    #scoreboard, #roleText { margin-top: 10px; font-size: 18px; }
    #status { margin-top: 15px; font-size: 16px; color: #ffeb3b; }
    .powerplay-indicator {
      background: #ffeb3b;
      color: #000;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 12px;
      margin-left: 10px;
      display: inline-block;
    }
    .dead-over {
      background: #f44336;
      color: white;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 12px;
    }
    .selection-modal { 
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: rgba(0,0,0,0.8); display: flex; justify-content: center; 
      align-items: center; z-index: 100; 
    }
    .selection-box { 
      background: #123456; padding: 20px; border-radius: 10px; 
      width: 300px; max-width: 90%; 
    }
    .selection-list { 
      max-height: 300px; overflow-y: auto; margin: 15px 0; 
      text-align: left; 
    }
    .player-item { 
      padding: 8px; margin: 5px 0; background: #1e88e5; 
      border-radius: 5px; cursor: pointer; 
    }
    .player-item:hover { background: #1565c0; }
    .player-item.selected { background: #0d47a1; }
    .test-controls { 
      margin: 15px 0; 
      display: flex;
      justify-content: center;
      gap: 10px;
    }
    .test-controls button {
      padding: 10px 15px;
      font-size: 14px;
      background: #ff9800;
    }
    .test-controls button:hover {
      background: #f57c00;
    }
    .innings-display {
      background: #0d2a52;
      padding: 10px;
      border-radius: 8px;
      margin: 10px 0;
      text-align: left;
    }
    #formatDisplay {
      font-weight: bold;
      color: #4caf50;
      margin-bottom: 10px;
    }
    #teamStatus {
      margin: 15px 0;
      padding: 10px;
      background: #0d2a52;
      border-radius: 8px;
    }
    #specialAlerts {
      margin: 10px 0;
    }
    .alert {
      display: none;
      padding: 10px;
      margin: 5px;
      border-radius: 5px;
      font-weight: bold;
      text-align: center;
    }
    #powerplayAlert { background: yellow; color: black; }
    #freeHitAlert { background: green; color: white; }
    #deadOverAlert { background: red; color: white; }
    #gameControls {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      justify-content: center;
    }
    #connectionStatus {
      padding: 8px;
      border-radius: 5px;
      text-align: center;
      margin: 10px auto;
      max-width: 400px;
    }
    .online { background: #4CAF50; }
    .offline { background: #F44336; }
    #saveBtn { background: #FF9800; }
    #saveBtn:hover { background: #F57C00; }
    #exitBtn { background: #f44336; }
    #exitBtn:hover { background: #d32f2f; }
    #spectatorCount {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #1e88e5;
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 14px;
    }
    #winProbability {
      margin-top: 5px;
      font-size: 14px;
      color: #4caf50;
    }
    #targetDisplay {
      font-weight: bold;
      margin-top: 5px;
      color: #ff9800;
    }
    .player-stats {
      display: flex;
      justify-content: space-around;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    .player-stat-box {
      background: #0d2a52;
      padding: 10px;
      border-radius: 8px;
      margin: 5px;
      min-width: 120px;
    }
  

#aiToggle {
  position: absolute;
  top: 10px;
  left: 10px;
  background: #4CAF50;
  padding: 5px 10px;
  border-radius: 5px;
}

</style>
</head>
<body>
<div id="freeHitBadge">FREE HIT</div>
<div id="rrrDisplay"></div>
<div id="freeHitBadge">FREE HIT</div>
<div id="rrrDisplay"></div>
  <div id="spectatorCount">Spectators: 0</div>
  <h2>üèè HandiCricket - Game</h2>
  <div id="formatDisplay"></div>
  <div id="roleText"></div>
  <div id="aiToggle">ü§ñ AI Mode: OFF</div>
  <div id="teamStatus">
    <div id="currentPlayers" style="font-weight: bold; font-size: 16px;">
      Batter: <span id="currentBatter">-</span> | Bowler: <span id="currentBowler">-</span>
    </div>
    <div id="scoreboard">Runs: 0 | Wickets: 0 | Overs: 0.0</div>
    <div id="targetDisplay"></div>
    <div id="winProbability"></div>
  </div>
  <div id="specialAlerts">
    <div id="powerplayAlert" class="alert">POWERPLAY</div>
    <div id="freeHitAlert" class="alert">FREE HIT</div>
    <div id="deadOverAlert" class="alert">DEAD OVER</div>
  </div>
  <div id="status">Waiting for players...</div>

  <div id="testControls" class="test-controls" style="display: none;">
    <button id="declareInning">Declare Innings</button>
    <button id="enforceFollowOn" style="display: none;">Enforce Follow-On</button>
  </div>

  <div class="card-row" id="cardButtons">
    <button class="card" data-value="0">0</button>
    <button class="card" data-value="1">1</button>
    <button class="card" data-value="2">2</button>
    <button class="card" data-value="3">3</button>
    <button class="card" data-value="4">4</button>
    <button class="card" data-value="5">5</button>
    <button class="card" data-value="6">6</button>
  </div>

  <div id="playingXISection" style="margin-top: 30px;">
    <div style="display: flex; justify-content: space-around; flex-wrap: wrap;">
      <div>
        <h4 id="team1Name">Team 1</h4>
        <ul id="team1Players" style="text-align: left;"></ul>
      </div>
      <div>
        <h4 id="team2Name">Team 2</h4>
        <ul id="team2Players" style="text-align: left;"></ul>
      </div>
    </div>
  </div>

  <div class="player-stats" id="playerStats" style="display: none;">
    <div class="player-stat-box" id="batterStats">
      <h4>Batter Stats</h4>
      <div id="currentBatterStats"></div>
    </div>
    <div class="player-stat-box" id="bowlerStats">
      <h4>Bowler Stats</h4>
      <div id="currentBowlerStats"></div>
    </div>
  </div>

  <div id="selectionModal" class="selection-modal" style="display: none;">
    <div class="selection-box">
      <h3 id="selectionTitle">Select Next Batter</h3>
      <div id="selectionList" class="selection-list"></div>
      <button id="confirmSelection" style="width: 100%;">Confirm</button>
    </div>
  </div>

  <div id="gameControls">
    <button id="saveBtn">üíæ Save & Exit</button>
    <button id="exitBtn">üö™ Exit Without Saving</button>
  </div>
  
  <div id="connectionStatus" class="online">
    Opponent: Online
  </div>

  <script type="module">
const zeroCount = { batter: 0, bowler: 0 };
let freeHit = false;

// === NEW FEATURES IMPLEMENTATION ===

let zeroCount = { batter: 0, bowler: 0 };
let freeHit = false;

function trackZeros(player, card) {
  if (card !== 0) return;
  const role = isBatting ? 'batter' : 'bowler';
  zeroCount[role]++;
  if (zeroCount[role] >= 4) {
    if (role === 'batter') {
      runs = Math.max(0, runs - 5);
      status.innerText = "‚ö†Ô∏è 4th zero! -5 run penalty";
    } else {
      runs += 1;
      freeHit = true;
      status.innerText = "‚ö†Ô∏è 4th zero! No Ball + Free Hit";
      showFreeHitBadge(true);
    }
  }
}

function showFreeHitBadge(active) {
  const badge = document.getElementById("freeHitBadge");
  if (badge) badge.style.display = active ? "block" : "none";
}

function resetFreeHit() {
  freeHit = false;
  showFreeHitBadge(false);
}

function checkMatchEnd() {
  const target = team1Score + 1;
  if (innings === 2) {
    if (runs >= target) {
      endMatch(`Team 2 wins by ${currentFormat.totalWickets - Math.floor(wickets)} wickets`);
    } else if (wickets >= currentFormat.totalWickets || legalBalls >= currentFormat.totalOvers * 6) {
      endMatch(`Team 1 wins by ${target - runs - 1} runs`);
    }
  } else {
    if (wickets >= currentFormat.totalWickets || legalBalls >= currentFormat.totalOvers * 6) {
      endMatch(`Team 1 scored ${runs} runs`);
    }
  }
}

function endMatch(result) {
  status.innerText = `Match Over! ${result}`;
  disableButtons();
  pushMatchSummary({ result, runs, wickets, overs: legalBalls / 6, team1: team1Name, team2: team2Name });
}

function updateRRR() {
  if (innings === 2) {
    const ballsLeft = currentFormat.totalOvers * 6 - legalBalls;
    const runsNeeded = (team1Score + 1) - runs;
    const rrr = (runsNeeded / (ballsLeft / 6)).toFixed(2);
    document.getElementById("rrrDisplay").innerText = `RRR: ${rrr}`;
  }
}

function selectNextBatter() {
  const available = teamPlayers.filter(p => !battersUsed.includes(p) || (batterLives[p] > 0));
  if (available.length === 0) {
    endMatch("All out!");
    return;
  }
  showSelectionModal("Select Next Batter", available);
}

function applyWicket() {
  let wicketValue = currentFormat.regularWicketValue;
  if (isPowerplay) wicketValue = currentFormat.powerplayWicketValue;
  wickets += wicketValue;
  if (currentFormat.type === "test") {
    if (wickets % 1 === 0) {
      selectNextBatter();
    }
  } else {
    selectNextBatter();
  }
}

function initNewFeatures() {
  const teamStatus = document.getElementById("teamStatus");
  if (teamStatus) {
    const rrrEl = document.createElement("div");
    rrrEl.id = "rrrDisplay";
    teamStatus.appendChild(rrrEl);
  }

  const alerts = document.getElementById("specialAlerts");
  if (alerts) {
    const badge = document.createElement("div");
    badge.id = "freeHitBadge";
    badge.textContent = "FREE HIT";
    alerts.appendChild(badge);
  }
}

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getDatabase, ref, onValue, set, get, update, push } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAGU0Tsj9pwZcgwQjZzTFvGOE032l2b7HI",
      authDomain: "handicricket-d1ab7.firebaseapp.com",
      projectId: "handicricket-d1ab7",
      storageBucket: "handicricket-d1ab7.appspot.com",
      messagingSenderId: "356065986337",
      appId: "1:356065986337:web:399102c5dabfca2b6fe060"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const params = new URLSearchParams(window.location.search);
    const room = params.get('room');
    const player = params.get('player');
    const opponent = player === "player1" ? "player2" : "player1";

    // Enhanced format rules with all features
    const formatRules = {
      "5": { 
        name: "5 Overs", 
        totalOvers: 5, 
        totalWickets: 11, 
        powerplayOvers: 2, 
        powerplayWicketValue: 0.5,
        regularWicketValue: 1,
        livesPerPlayer: 2,
        deadOvers: [],
        type: "limited"
      },
      "10": { 
        name: "10 Overs", 
        totalOvers: 10, 
        totalWickets: 11, 
        powerplayOvers: 3, 
        powerplayWicketValue: 0.5,
        regularWicketValue: 1,
        livesPerPlayer: 2,
        deadOvers: [],
        type: "limited"
      },
      "20": { 
        name: "T20", 
        totalOvers: 20, 
        totalWickets: 11, 
        powerplayOvers: 6, 
        powerplayWicketValue: 0.5,
        regularWicketValue: 1,
        livesPerPlayer: 2,
        deadOvers: [],
        type: "limited"
      },
      "50": { 
        name: "ODI", 
        totalOvers: 50, 
        totalWickets: 11, 
        powerplayOvers: [1,10, 21,30, 41,42], 
        powerplayWicketValue: 0.25,
        regularWicketValue: 0.5,
        livesPerPlayer: 4,
        deadOvers: [11,20, 31,40],
        type: "limited"
      },
      "test": { 
        name: "Test Match", 
        totalOvers: Infinity, 
        totalWickets: 30, 
        powerplayOvers: 0, 
        powerplayWicketValue: 1,
        regularWicketValue: 1,
        livesPerPlayer: 3,
        deadOvers: [],
        type: "test",
        followOnMargin: 200,
        maxDays: 5,
        oversPerDay: 90
      },
      "superover": {
        name: "Super Over",
        totalOvers: 1,
        totalWickets: 2,
        powerplayOvers: 0,
        powerplayWicketValue: 1,
        regularWicketValue: 1,
        livesPerPlayer: 1,
        deadOvers: [],
        type: "superover"
      }
    };

    // Game state variables
    let runs = 0, wickets = 0;
    let legalBalls = 0;
    let freeHit = false;
    let currentBatter = null;
    let currentBowler = null;
    let battersUsed = [];
    let bowlersUsed = [];
    let bowlerOvers = {};
    let isBatting = false;
    let currentFormat = {};
    let isTestMatch = false;
    let isSuperOver = false;
    let innings = 1;
    let currentInningRuns = 0;
    let currentInningWickets = 0;
    let team1Score = 0;
    let team2Score = 0;
    let team1Wickets = 0;
    let team2Wickets = 0;
    let daysRemaining = 5;
    let oversToday = 0;
    const maxOversPerDay = 90;
    let isPowerplay = false;
    let isDeadOver = false;
    let batterLives = {};
    let zerosThisOver = { player1: 0, player2: 0 };
    let currentOver = 0;
    let deadOversSelected = [];
    let bowlerRuns = {};
    let batterStats = {};
    let bowlerStats = {};
    let gameInProgress = true;
    let lastOverRuns = 0;
    let lastOverWickets = 0;
    let lastWicketScore = 0;
    let ballByBall = {};
    
    // DOM elements
    const status = document.getElementById("status");
    const scoreboard = document.getElementById("scoreboard");
    const buttons = document.querySelectorAll(".card");
    const roleText = document.getElementById("roleText");
    const currentBatterEl = document.getElementById("currentBatter");
    const currentBowlerEl = document.getElementById("currentBowler");
    const selectionModal = document.getElementById("selectionModal");
    const selectionTitle = document.getElementById("selectionTitle");
    const selectionList = document.getElementById("selectionList");
    const confirmSelection = document.getElementById("confirmSelection");
    const team1NameEl = document.getElementById("team1Name");
    const team2NameEl = document.getElementById("team2Name");
    const team1PlayersEl = document.getElementById("team1Players");
    const team2PlayersEl = document.getElementById("team2Players");
    const testControls = document.getElementById("testControls");
    const declareBtn = document.getElementById("declareInning");
    const followOnBtn = document.getElementById("enforceFollowOn");
    const formatDisplay = document.getElementById("formatDisplay");
    const powerplayAlert = document.getElementById("powerplayAlert");
    const freeHitAlert = document.getElementById("freeHitAlert");
    const deadOverAlert = document.getElementById("deadOverAlert");
    const saveBtn = document.getElementById("saveBtn");
    const exitBtn = document.getElementById("exitBtn");
    const connectionStatus = document.getElementById("connectionStatus");
    const spectatorCountEl = document.getElementById("spectatorCount");
    const winProbabilityEl = document.getElementById("winProbability");
    const targetDisplay = document.getElementById("targetDisplay");
    const playerStatsEl = document.getElementById("playerStats");
    const batterStatsEl = document.getElementById("currentBatterStats");
    const bowlerStatsEl = document.getElementById("currentBowlerStats");

    // Initialize player stats
    function initPlayerStats(players) {
      players.forEach(player => {
        batterStats[player] = { runs: 0, balls: 0, fours: 0, sixes: 0, lives: currentFormat.livesPerPlayer };
        bowlerStats[player] = { overs: 0, maidens: 0, runs: 0, wickets: 0 };
      });
    }

    // Update player stats display
    function updatePlayerStats() {
      if (currentBatter) {
        const bs = batterStats[currentBatter];
        batterStatsEl.innerHTML = `
          Runs: ${bs.runs}<br>
          Balls: ${bs.balls}<br>
          Fours: ${bs.fours}<br>
          Sixes: ${bs.sixes}<br>
          Strike Rate: ${bs.balls > 0 ? ((bs.runs/bs.balls)*100).toFixed(2) : 0}<br>
          Lives: ${bs.lives}/${currentFormat.livesPerPlayer}
        `;
      }
      
      if (currentBowler) {
        const bs = bowlerStats[currentBowler];
        bowlerStatsEl.innerHTML = `
          Overs: ${Math.floor(bs.overs)}.${(bs.overs % 1 * 10).toFixed(0)}<br>
          Runs: ${bs.runs}<br>
          Wickets: ${bs.wickets}<br>
          Maidens: ${bs.maidens}<br>
          Economy: ${bs.overs > 0 ? (bs.runs/bs.overs).toFixed(2) : 0}
        `;
      }
      
      playerStatsEl.style.display = currentBatter || currentBowler ? "flex" : "none";
    }

    // Calculate win probability
    function calculateWinProbability() {
      if (innings !== 2 || isSuperOver) return '--';
      
      const target = team1Score + 1;
      const runsNeeded = target - runs;
      const ballsLeft = currentFormat.totalOvers * 6 - legalBalls;
      const wicketsLeft = currentFormat.totalWickets - Math.floor(wickets);
      
      if (runsNeeded <= 0) return "100%";
      if (ballsLeft <= 0 || wicketsLeft <= 0) return "0%";
      
      const resources = (ballsLeft / (currentFormat.totalOvers * 6)) * (wicketsLeft / currentFormat.totalWickets);
      const requiredRate = runsNeeded / (ballsLeft / 6);
      const currentRate = runs / (legalBalls / 6);
      
      let probability;
      
      if (requiredRate < currentRate) {
        probability = 70 + (currentRate - requiredRate) * 5;
      } else {
        probability = 30 - (requiredRate - currentRate) * 5;
      }
      
      probability = probability * resources;
      probability = Math.min(100, Math.max(0, Math.round(probability)));
      
      return probability + "%";
    }

    // Update spectator data
    function updateSpectatorData() {
      const currentOver = Math.floor(legalBalls / 6);
      if (currentOver > lastOverRuns) {
        const overSummary = `Over ${currentOver}: ${runs - lastOverRuns} runs, ${wickets - lastOverWickets} wickets`;
        set(ref(db, `rooms/${room}/overSummaries/${currentOver}`), overSummary);
        lastOverRuns = runs;
        lastOverWickets = wickets;
      }

      const runRate = (runs / (legalBalls / 6)).toFixed(2);
      const boundaries = Object.values(ballByBall).filter(ball => [4,6].includes(ball.runs)).length;
      const requiredRate = innings === 2 ? ((team1Score - runs + 1) / ((currentFormat.totalOvers * 6 - legalBalls) / 6)).toFixed(2) : null;

      set(ref(db, `rooms/${room}/matchStats`), {
        runRate: runRate,
        boundaries: boundaries,
        dotBalls: Object.values(ballByBall).filter(ball => ball.runs === 0).length,
        wickets: wickets,
        partnership: runs - lastWicketScore,
        requiredRate: requiredRate,
        batterLives: currentBatter ? batterLives[currentBatter] : null,
        isPowerplay: isPowerplay,
        winProbability: calculateWinProbability()
      });

      set(ref(db, `rooms/${room}/liveState`), {
        runs: runs,
        wickets: wickets,
        legalBalls: legalBalls,
        currentBatter: currentBatter,
        currentBowler: currentBowler,
        isPowerplay: isPowerplay,
        isDeadOver: isDeadOver,
        freeHit: freeHit,
        innings: innings
      });
    }

    // Load playing XI
    async function loadPlaying11() {
      const roomRef = ref(db, `rooms/${room}`);
      const snapshot = await get(roomRef);
      const data = snapshot.val();

      if (!data) {
        alert("Room data not found! Returning to home.");
        window.location.href = "index.html";
        return false;
      }

      if (data.player1?.playing11) {
        team1NameEl.innerText = data.player1.teamName || "Team 1";
        team1PlayersEl.innerHTML = data.player1.playing11.map(p => `<li>${p}</li>`).join("");
        initPlayerStats(data.player1.playing11);
      }
      
      if (data.player2?.playing11) {
        team2NameEl.innerText = data.player2.teamName || "Team 2";
        team2PlayersEl.innerHTML = data.player2.playing11.map(p => `<li>${p}</li>`).join("");
        initPlayerStats(data.player2.playing11);
      }

      return data.player1?.playing11 && data.player2?.playing11;
    }

    // Setup connection monitoring
    function setupConnectionMonitoring() {
      set(playerRef, true);
      
      onValue(opponentRef, (snap) => {
        if (!snap.exists() || !snap.val()) {
          connectionStatus.textContent = "Opponent: Offline (Game Paused)";
          connectionStatus.className = "offline";
          disableButtons();
        } else {
          connectionStatus.textContent = "Opponent: Online";
          connectionStatus.className = "online";
          if (!selectionModal.style.display || selectionModal.style.display === "none") {
            enableButtons();
          }
        }
      });
      
      window.addEventListener('beforeunload', () => {
        set(playerRef, false);
      });
    }

    // Check powerplay status
    function checkPowerplayStatus() {
      const currentOver = Math.floor(legalBalls / 6);
      
      isPowerplay = false;
      isDeadOver = false;
      
      powerplayAlert.style.display = "none";
      freeHitAlert.style.display = "none";
      deadOverAlert.style.display = "none";

      if (isTestMatch || isSuperOver) return;

      if (Array.isArray(currentFormat.powerplayOvers)) {
        for (let i = 0; i < currentFormat.powerplayOvers.length; i += 2) {
          if (currentOver >= currentFormat.powerplayOvers[i] - 1 && 
              currentOver <= currentFormat.powerplayOvers[i+1] - 1) {
            isPowerplay = true;
            powerplayAlert.style.display = "block";
            break;
          }
        }
      } else if (currentOver < currentFormat.powerplayOvers) {
        isPowerplay = true;
        powerplayAlert.style.display = "block";
      }

      if (currentFormat.deadOvers?.length > 0) {
        for (let i = 0; i < currentFormat.deadOvers.length; i += 2) {
          if (currentOver >= currentFormat.deadOvers[i] - 1 && 
              currentOver <= currentFormat.deadOvers[i+1] - 1) {
            isDeadOver = true;
            deadOverAlert.style.display = "block";
            break;
          }
        }
      }

      if (freeHit) {
        freeHitAlert.style.display = "block";
      }
    }

    // Update scoreboard
    function updateScoreboard() {
      const overs = Math.floor(legalBalls / 6);
      const balls = legalBalls % 6;
      
      let displayWickets;
      if (isTestMatch) {
        displayWickets = Math.floor(wickets / 3);
      } else {
        displayWickets = wickets % 1 === 0 ? wickets : wickets.toFixed(2).replace(/\.?0+$/, '');
      }

      let totalWickets = currentFormat.totalWickets;

      if (isTestMatch) {
        scoreboard.innerHTML = `
          <div><strong>Innings ${innings}</strong> | Day ${6 - daysRemaining}</div>
          <div>Current: ${currentInningRuns}/${displayWickets} (${overs}.${balls})</div>
          <div>Team 1: ${team1Score}/${Math.floor(team1Wickets/3)}</div>
          <div>Team 2: ${team2Score}/${Math.floor(team2Wickets/3)}</div>
          <div>Overs today: ${oversToday}/${maxOversPerDay}</div>
        `;
      } else if (isSuperOver) {
        scoreboard.innerHTML = `
          <div><strong>SUPER OVER</strong></div>
          <div>Runs: ${runs} | Wickets: ${wickets}/2 | Balls: ${legalBalls}/6</div>
          <div>Target: ${team1Score + 1}</div>
        `;
      } else {
        scoreboard.innerHTML = `Runs: ${runs} | Wickets: ${displayWickets}/${totalWickets} | Overs: ${overs}.${balls}`;
        
        if (innings === 2) {
          const target = team1Score + 1;
          const runsNeeded = target - runs;
          const ballsLeft = currentFormat.totalOvers * 6 - legalBalls;
          
          targetDisplay.innerHTML = `Target: ${target} | Need ${runsNeeded} in ${ballsLeft} balls`;
          winProbabilityEl.textContent = `Win Probability: ${calculateWinProbability()}`;
        } else {
          targetDisplay.innerHTML = "";
          winProbabilityEl.textContent = "";
        }
      }

      checkPowerplayStatus();
      updatePlayerStats();
    }

    // Show batter selection
    async function showBatterSelection() {
      disableButtons();
      try {
        const snapshot = await get(ref(db, `rooms/${room}/${player}/playing11`));
        const players = snapshot.val();
        const availableBatters = players.filter(p => !battersUsed.includes(p) || 
          (batterLives[p] !== undefined && batterLives[p] > 0));
        
        if (availableBatters.length === 0) {
          alert("All batters are out!");
          return;
        }

        selectionTitle.textContent = "Select Next Batter";
        selectionList.innerHTML = "";
        
        availableBatters.forEach(player => {
          const livesLeft = batterLives[player] !== undefined ? 
                          batterLives[player] : currentFormat.livesPerPlayer;
          const playerEl = document.createElement("div");
          playerEl.className = "player-item";
          playerEl.textContent = `${player} (${livesLeft} lives left)`;
          playerEl.dataset.name = player;
          playerEl.addEventListener("click", function() {
            document.querySelectorAll(".player-item").forEach(el => el.classList.remove("selected"));
            this.classList.add("selected");
          });
          selectionList.appendChild(playerEl);
        });

        selectionModal.style.display = "flex";
        status.innerText = "Selecting batter...";
      } catch (error) {
        console.error("Batter selection error:", error);
        alert("Error loading batters. Please try again.");
        enableButtons();
      }
    }

    // Show bowler selection
    async function showBowlerSelection() {
      disableButtons();
      try {
        const snapshot = await get(ref(db, `rooms/${room}/${player}/playing11`));
        const players = snapshot.val();
        const maxOversPerBowler = isTestMatch ? Infinity : Math.ceil(currentFormat.totalOvers / 5);
        const availableBowlers = players.filter(p => (bowlerOvers[p] || 0) < maxOversPerBowler);
        
        if (availableBowlers.length === 0) {
          alert("All bowlers have bowled their maximum overs!");
          return;
        }

        selectionTitle.textContent = "Select Next Bowler";
        selectionList.innerHTML = "";
        
        availableBowlers.forEach(player => {
          const oversBowled = bowlerOvers[player] || 0;
          const playerEl = document.createElement("div");
          playerEl.className = "player-item";
          playerEl.textContent = isTestMatch ? 
            `${player} (${oversBowled.toFixed(1)} overs)` : 
            `${player} (${oversBowled}/${maxOversPerBowler} overs)`;
          playerEl.dataset.name = player;
          playerEl.addEventListener("click", function() {
            document.querySelectorAll(".player-item").forEach(el => el.classList.remove("selected"));
            this.classList.add("selected");
          });
          selectionList.appendChild(playerEl);
        });

        selectionModal.style.display = "flex";
        status.innerText = "Selecting bowler...";
      } catch (error) {
        console.error("Bowler selection error:", error);
        alert("Error loading bowlers. Please try again.");
        enableButtons();
      }
    }

    // Initialize super over
    function initSuperOver() {
      isSuperOver = true;
      currentFormat = formatRules["superover"];
      
      // Reset for super over
      innings = 1;
      runs = 0;
      wickets = 0;
      legalBalls = 0;
      freeHit = false;
      isBatting = true;
      batterLives = {};
      battersUsed = [];
      bowlerOvers = {};
      
      formatDisplay.innerText = "SUPER OVER | 1 over, 2 wickets max";
      testControls.style.display = "none";
      
      alert("üèè SUPER OVER BEGINS! 6 balls, 2 wickets maximum");
      updateScoreboard();
      
      if (isBatting) {
        showBatterSelection();
      } else {
        showBowlerSelection();
      }
    }

    // End match
    function endMatch() {
      if (team1Score === team2Score && !isTestMatch) {
        initSuperOver();
        return;
      }

      let result = "";
      if (isTestMatch) {
        if (team1Score > team2Score) {
          result = `Team 1 wins by ${team1Score - team2Score} runs`;
        } else if (team2Score > team1Score) {
          result = `Team 2 wins by ${10 - Math.floor(team2Wickets)} wickets`;
        } else {
          result = "Match drawn";
        }
      } else if (isSuperOver) {
        if (runs > team1Score) {
          result = `Team 2 wins the Super Over by ${runs - team1Score} runs`;
        } else if (team1Score > runs) {
          result = `Team 1 wins the Super Over by ${team1Score - runs} runs`;
        } else {
          result = "Super Over tied! Match drawn";
        }
      } else {
        if (innings === 2) {
          if (team2Score > team1Score) {
            result = `Team 2 wins by ${currentFormat.totalWickets - Math.floor(team2Wickets)} wickets`;
          } else if (team1Score > team2Score) {
            result = `Team 1 wins by ${team1Score - team2Score} runs`;
          } else {
            result = "Match tied";
          }
        } else {
          result = `Team 1 wins by ${currentFormat.totalWickets - Math.floor(team1Wickets)} wickets`;
        }
      }
      
      status.innerText = `Match Over! ${result}`;
      disableButtons();
      set(ref(db, `rooms/${room}/result`), result);
      updateSpectatorData();
      gameInProgress = false;
    }

    // Initialize the game
function trackZeros(player, card) {
  if (card !== 0) return;

  const role = isBatting ? 'batter' : 'bowler';
  zeroCount[role]++;

  if (zeroCount[role] >= 4) {
    if (role === 'batter') {
      runs = Math.max(0, runs - 5);
      status.innerText = "‚ö†Ô∏è 4th zero! -5 run penalty";
    } else {
      runs += 1;
      freeHit = true;
      status.innerText = "‚ö†Ô∏è 4th zero! No Ball + Free Hit";
      showFreeHitBadge(true);
    }
  }
}

function showFreeHitBadge(active) {
  const badge = document.getElementById("freeHitBadge");
  badge.style.display = active ? "block" : "none";
}

function checkMatchEnd() {
  const target = team1Score + 1;
  if (innings === 2) {
    if (runs >= target) {
      endMatch(`Team 2 wins by ${currentFormat.totalWickets - Math.floor(wickets)} wickets`);
    } else if (wickets >= currentFormat.totalWickets || 
              legalBalls >= currentFormat.totalOvers * 6) {
      endMatch(`Team 1 wins by ${target - runs - 1} runs`);
    }
  } else {
    if (wickets >= currentFormat.totalWickets || 
        legalBalls >= currentFormat.totalOvers * 6) {
      endMatch(`Team 1 scored ${runs} runs`);
    }
  }
}

function updateRRR() {
  if (innings === 2) {
    const ballsLeft = currentFormat.totalOvers * 6 - legalBalls;
    const runsNeeded = (team1Score + 1) - runs;
    const rrr = (runsNeeded / (ballsLeft / 6)).toFixed(2);
    document.getElementById("rrrDisplay").innerText = `RRR: ${rrr}`;
  }
}
    async function initGame() {
  initNewFeatures();
  if (params.get('ai')) enableAIMode();
  const playerStats = new PlayerStats();
      gameInProgress = true;
      
      // Check for saved game
      const savedGameSnap = await get(ref(db, `savedGames/${room}`));
      if (savedGameSnap.exists()) {
        const savedData = savedGameSnap.val();
        if (confirm("Resume saved game?")) {
          // Load saved state
          runs = savedData.runs || 0;
          wickets = savedData.wickets || 0;
          innings = savedData.innings || 1;
          currentInningRuns = savedData.currentInningRuns || 0;
          currentInningWickets = savedData.currentInningWickets || 0;
          batterLives = savedData.batterLives || {};
          bowlerOvers = savedData.bowlerOvers || {};
          team1Score = savedData.players?.player1?.score || 0;
          team2Score = savedData.players?.player2?.score || 0;
          
          // Delete the saved game
          await set(ref(db, `savedGames/${room}`), null);
        } else {
          // Start fresh
          await set(ref(db, `savedGames/${room}`), null);
        }
      }

      const teamsLoaded = await loadPlaying11();
      if (!teamsLoaded) {
        alert("Both teams haven't submitted yet! Returning to team selection.");
        window.location.href = `playing11.html?room=${room}&player=${player}`;
        return;
      }

      const formatSnap = await get(ref(db, `rooms/${room}/player1/format`));
      const format = formatSnap.val() || "5";
      currentFormat = formatRules[format];
      isTestMatch = format === "test";
      
      formatDisplay.innerText = `${currentFormat.name} | ${isTestMatch ? "3 outs/wicket" : currentFormat.livesPerPlayer + " lives/batter"}`;
      
      testControls.style.display = isTestMatch ? "flex" : "none";
      followOnBtn.style.display = "none";
      
      // Initialize spectator data
      await set(ref(db, `rooms/${room}/spectatorData`), {
        overSummaries: {},
        matchStats: {},
        spectatorChat: {}
      });

      setupConnectionMonitoring();
      await setupRole();
      setupSelectionModal();
      setupTestControls();
      updateScoreboard();
      setupFirebaseListeners();
      
      // Setup button events
      saveBtn.addEventListener("click", saveGameState);
      exitBtn.addEventListener("click", async () => {
        if (confirm("Exit without saving?")) {
          await resetGame();
          window.location.href = "index.html";
        }
      });
    }

    // Initialize the game
    initGame();
  

// === NEW FEATURE HOOKS ===

function trackZeros(player, card) {
  if (card !== 0) return;

  zerosThisOver[player] = (zerosThisOver[player] || 0) + 1;
  if (zerosThisOver[player] >= 4) {
    if (isBatting) {
      runs = Math.max(0, runs - 5);
      status.innerText = "‚ö†Ô∏è 4th zero! -5 run penalty";
    } else {
      runs += 1;
      freeHit = true;
      status.innerText = "‚ö†Ô∏è 4th zero! No Ball + Free Hit";
    }
  }

  if (legalBalls % 6 === 0) {
    zerosThisOver = { player1: 0, player2: 0 }; // reset at over end
  }
}

function checkMatchEnd() {
  const target = team1Score + 1;
  if (
    wickets >= currentFormat.totalWickets ||
    legalBalls >= currentFormat.totalOvers * 6 ||
    (innings === 2 && runs >= target)
  ) {
    endMatch();
  }
}

function handleFreeHitReset() {
  if (freeHit) {
    freeHitAlert.style.display = "block";
    setTimeout(() => {
      freeHit = false;
      freeHitAlert.style.display = "none";
    }, 2000);
  }
}

function enableAIMode() {
  if (player === "player1") {
    set(ref(db, `rooms/${room}/aiMode`), true);
    onValue(ref(db, `rooms/${room}/currentPlays/player1`), (snap) => {
      if (snap.exists()) {
        setTimeout(() => {
          const aiPlay = Math.floor(Math.random() * 7);
          set(ref(db, `rooms/${room}/currentPlays/player2`), aiPlay);
        }, 1000);
      }
    });
  }
}

// Inject into initGame
function initAllExtras() {
  if (params.get('ai')) enableAIMode();
}
initAllExtras();

// Modify card handler:
buttons.forEach(btn => {
  btn.addEventListener("click", async () => {
    const val = parseInt(btn.dataset.value);
    trackZeros(player, val); // Add this line
    trackZeros(player, val);
    disableButtons();
    status.innerText = "Waiting...";
    await set(ref(db, `rooms/${room}/currentPlays/${player}`), val);
  });
});

// Modify play listener:
onValue(ref(db, `rooms/${room}/currentPlays`), async (snap) => {
  const plays = snap.val();
  if (!plays || !plays.player1 || !plays.player2) return;

  const batCard = isBatting ? plays[player] : plays[opponent];
  const bowlCard = isBatting ? plays[opponent] : plays[player];

  let outcome = "";
  let isWicket = false;

  if (freeHit) {
    outcome = `Free Hit! Scored ${batCard}`;
  } else if (batCard === bowlCard) {
    wickets++;
    isWicket = true;
    outcome = "WICKET!";
  } else {
    runs += batCard;
    outcome = `${batCard} run(s)`;
  }

  status.innerText = outcome;
  legalBalls++;
  handleFreeHitReset();
  updateScoreboard();
  updatePlayerStats();
  checkMatchEnd();

  // Clear plays after processing
  set(ref(db, `rooms/${room}/currentPlays`), {});
});

</script>

<div id="freeHitBadge" style="display:none;background:#ffc107;color:#000;padding:5px;border-radius:8px;margin-top:10px;">FREE HIT</div>
<script type="module">
import { db, ref, onValue, set, get, child } from './firebase.js';

let zeroCount = { batter: 0, bowler: 0 };
let freeHit = false;
let currentBatter = null;
let currentBowler = null;
let innings = 1;
let target = 0;
let currentRuns = 0;
let currentBalls = 0;
let wickets = 0;
let maxWickets = 10;

// Update free hit UI
function showFreeHitBadge(active) {
  const badge = document.getElementById("freeHitBadge");
  if (badge) badge.style.display = active ? "inline-block" : "none";
}

// Reset free hit after valid delivery
function resetFreeHit() {
  freeHit = false;
  showFreeHitBadge(false);
}

// Zero count logic
function handleZero(value, role) {
  if (value === 0) {
    zeroCount[role]++;
    if (zeroCount[role] > 3) {
      if (role === 'batter') {
        currentRuns = Math.max(0, currentRuns - 5);
        updateScoreboard();
      } else if (role === 'bowler') {
        freeHit = true;
        showFreeHitBadge(true);
      }
    }
  } else {
    zeroCount.batter = 0;
    zeroCount.bowler = 0;
  }
}

// Match end check
function checkMatchEnd() {
  if (innings === 2) {
    if (currentRuns > target) {
      alert("Batting Team Wins!");
      pushMatchSummary("Batting Team Wins");
    } else if (currentBalls >= totalBalls) {
      if (currentRuns === target) {
        alert("Match Tied! Super Over!");
      } else {
        alert("Bowling Team Wins!");
        pushMatchSummary("Bowling Team Wins");
      }
    }
  }
}

// Push summary to Firebase
function pushMatchSummary(result) {
  const summaryRef = ref(db, `rooms/${roomCode}/summary`);
  set(summaryRef, {
    result: result,
    runs: currentRuns,
    wickets: wickets,
    overs: Math.floor(currentBalls / 6) + "." + (currentBalls % 6),
  });
}

// Required RR display
function updateRRR() {
  if (innings === 2) {
    const ballsLeft = totalBalls - currentBalls;
    const runsNeeded = target - currentRuns + 1;
    const rrr = (runsNeeded / (ballsLeft / 6)).toFixed(2);
    document.getElementById("rrrDisplay").innerText = "RRR: " + rrr;
  }
}

// Manual batter selection modal
function selectNextBatter() {
  document.getElementById("selectionModal").style.display = "flex";
}

// Card click sample logic extension
function onCardClick(value) {
  handleZero(value, 'batter'); // update zero logic
  if (freeHit && value === 'W') {
    alert("No wicket on Free Hit!");
    return;
  }
  resetFreeHit();
  currentBalls++;
  if (value === 'W') {
    wickets++;
    if (wickets >= maxWickets) {
      checkMatchEnd();
    } else {
      selectNextBatter();
    }
  } else {
    currentRuns += parseInt(value);
    updateScoreboard();
  }
  checkMatchEnd();
  updateRRR();
}

</script>

</body>
</html>
