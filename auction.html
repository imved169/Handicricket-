<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HandiCricket - IPL 2025 Auction</title>
  <style>
    body {
      background: linear-gradient(135deg, #061e3e, #0a2a4a);
      color: white;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      text-align: center;
      padding: 20px;
      margin: 0;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    h1 {
      color: #ffeb3b;
      text-shadow: 0 0 10px rgba(255, 235, 59, 0.5);
      margin-bottom: 20px;
    }
    
    .user-info {
      margin-bottom: 20px;
      padding: 15px;
      background: rgba(13, 42, 82, 0.5);
      border-radius: 10px;
    }
    
    .user-info p {
      margin: 5px 0;
    }
    
    .user-team {
      font-weight: bold;
      color: #ffeb3b;
    }
    
    .auction-container {
      display: flex;
      gap: 20px;
      margin-top: 20px;
    }
    
    .player-pool {
      flex: 1;
      background: rgba(13, 42, 82, 0.5);
      border-radius: 10px;
      padding: 15px;
      max-height: 600px;
      overflow-y: auto;
    }
    
    .player-pool h2 {
      margin-top: 0;
      color: #ffeb3b;
      border-bottom: 2px solid #1e88e5;
      padding-bottom: 8px;
    }
    
    .team-list {
      width: 300px;
      background: rgba(13, 42, 82, 0.5);
      border-radius: 10px;
      padding: 15px;
      max-height: 600px;
      overflow-y: auto;
    }
    
    .team-list h2 {
      margin-top: 0;
      color: #ffeb3b;
      border-bottom: 2px solid #1e88e5;
      padding-bottom: 8px;
    }
    
    .player-card {
      background: rgba(30, 136, 229, 0.2);
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .player-card:hover {
      background: rgba(30, 136, 229, 0.4);
    }
    
    .player-card h3 {
      margin: 0 0 5px 0;
      color: #ffeb3b;
    }
    
    .player-card p {
      margin: 3px 0;
      font-size: 14px;
    }
    
    .player-role {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
      margin-right: 5px;
    }
    
    .role-batter {
      background: #4CAF50;
    }
    
    .role-bowler {
      background: #F44336;
    }
    
    .role-allrounder {
      background: #FF9800;
    }
    
    .role-wk {
      background: #9C27B0;
    }
    
    .current-player {
      background: rgba(255, 235, 59, 0.3);
      border: 2px solid #ffeb3b;
    }
    
    .bid-controls {
      margin: 20px 0;
      padding: 15px;
      background: rgba(13, 42, 82, 0.5);
      border-radius: 10px;
    }
    
    .bid-info {
      margin-bottom: 15px;
    }
    
    .bid-info h2 {
      margin: 0 0 10px 0;
      color: #ffeb3b;
    }
    
    .bid-amount {
      font-size: 24px;
      font-weight: bold;
      color: #ffeb3b;
    }
    
    .bid-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    }
    
    .btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 10px rgba(0, 0, 0, 0.3);
    }
    
    .btn:active {
      transform: translateY(1px);
    }
    
    .btn-bid {
      background: linear-gradient(145deg, #4CAF50, #2E7D32);
    }
    
    .btn-pass {
      background: linear-gradient(145deg, #607D8B, #455A64);
    }
    
    .btn-sold {
      background: linear-gradient(145deg, #FF5722, #E64A19);
    }
    
    .btn-back {
      background: linear-gradient(145deg, #607D8B, #455A64);
      margin-top: 20px;
    }
    
    .team-budget {
      font-weight: bold;
      color: #ffeb3b;
      margin-bottom: 10px;
    }
    
    .team-players {
      list-style: none;
      padding: 0;
    }
    
    .team-players li {
      padding: 8px;
      margin: 5px 0;
      background: rgba(30, 136, 229, 0.2);
      border-radius: 5px;
    }
    
    .admin-controls {
      margin-top: 20px;
      padding: 15px;
      background: rgba(13, 42, 82, 0.5);
      border-radius: 10px;
      display: none;
    }
    
    .input-group {
      margin-bottom: 15px;
      text-align: left;
    }
    
    .input-group label {
      display: block;
      margin-bottom: 5px;
      color: #aaa;
    }
    
    .input-group input, .input-group select {
      width: 100%;
      padding: 8px;
      border: 1px solid #1e88e5;
      border-radius: 5px;
      background: rgba(30, 136, 229, 0.1);
      color: white;
    }
    
    .btn-add-player {
      background: linear-gradient(145deg, #1e88e5, #1565c0);
    }
    
    .btn-start-auction {
      background: linear-gradient(145deg, #4CAF50, #2E7D32);
    }
    
    .loading-spinner {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 3px solid #1e88e5;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    .room-code-display {
      margin: 20px 0;
      padding: 15px;
      background: rgba(13, 42, 82, 0.5);
      border-radius: 10px;
      font-size: 18px;
      display: none;
    }
    
    .room-code {
      font-weight: bold;
      color: #ffeb3b;
      font-size: 24px;
      letter-spacing: 3px;
    }
    
    /* New retention section styles */
    .retention-section {
      margin: 20px 0;
      padding: 15px;
      background: rgba(13, 42, 82, 0.5);
      border-radius: 10px;
      display: none;
    }
    
    .retention-section h2 {
      margin-top: 0;
      color: #ffeb3b;
      border-bottom: 2px solid #1e88e5;
      padding-bottom: 8px;
    }
    
    .retention-players {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 15px 0;
    }
    
    .retention-player {
      background: rgba(30, 136, 229, 0.2);
      border-radius: 8px;
      padding: 10px;
      width: calc(33% - 10px);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .retention-player:hover {
      background: rgba(30, 136, 229, 0.4);
    }
    
    .retention-player.selected {
      background: rgba(76, 175, 80, 0.3);
      border: 1px solid #4CAF50;
    }
    
    .retention-player.captain {
      background: rgba(255, 235, 59, 0.3);
      border: 1px solid #ffeb3b;
    }
    
    .retention-controls {
      margin-top: 15px;
    }
    
    .rtm-indicator {
      display: inline-block;
      padding: 2px 8px;
      background: #9C27B0;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
      margin-left: 5px;
    }
    
    .btn-rtm {
      background: linear-gradient(145deg, #9C27B0, #7B1FA2);
    }
    
    .btn-final-bid {
      background: linear-gradient(145deg, #FF5722, #E64A19);
    }
    
    .retention-summary {
      margin-top: 20px;
      padding: 10px;
      background: rgba(30, 136, 229, 0.2);
      border-radius: 8px;
    }
    
    /* Bulk add section */
    .bulk-add-section {
      margin: 20px 0;
      padding: 15px;
      background: rgba(13, 42, 82, 0.5);
      border-radius: 10px;
    }
    
    .bulk-textarea {
      width: 100%;
      height: 150px;
      padding: 10px;
      border: 1px solid #1e88e5;
      border-radius: 5px;
      background: rgba(30, 136, 229, 0.1);
      color: white;
      margin-bottom: 10px;
      font-family: inherit;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @media (max-width: 768px) {
      .auction-container {
        flex-direction: column;
      }
      
      .team-list {
        width: auto;
      }
      
      .retention-player {
        width: calc(50% - 10px);
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üèè HandiCricket - IPL 2025 Auction</h1>
    
    <div class="user-info">
      <p>Team: <span id="teamDisplay" class="user-team"></span></p>
      <p>Budget: <span id="budgetDisplay" class="user-team">‚Çπ120.00 Cr</span></p>
      <p>Players: <span id="playerCount">0/25</span></p>
      <p>RTM Cards: <span id="rtmCardsDisplay">0</span></p>
    </div>
    
    <!-- Retention Section -->
    <div id="retentionSection" class="retention-section">
      <h2>Player Retention</h2>
      <p>Select up to 6 players to retain from your previous squad. Captain will cost ‚Çπ4 Cr, others ‚Çπ2 Cr each.</p>
      
      <div class="retention-players" id="retentionPlayersList"></div>
      
      <div class="retention-controls">
        <button id="markCaptainBtn" class="btn" disabled>Mark as Captain (‚Çπ4 Cr)</button>
        <button id="submitRetentionBtn" class="btn btn-bid">Submit Retention</button>
      </div>
      
      <div class="retention-summary">
        <p>Selected: <span id="retentionCount">0</span>/6 players</p>
        <p>Total Retention Cost: ‚Çπ<span id="retentionCost">0</span> Cr</p>
        <p>Remaining Budget: ‚Çπ<span id="remainingAfterRetention">120</span> Cr</p>
        <p>RTM Cards Earned: <span id="rtmEarned">0</span></p>
      </div>
    </div>
    
    <!-- Join Room Section -->
    <div id="joinRoomSection" style="display: none;">
      <div class="input-group">
        <label for="auctionRoomCode">Enter Auction Room Code</label>
        <input type="text" id="auctionRoomCode" placeholder="6-digit code provided by admin">
      </div>
      <button id="joinAuctionBtn" class="btn btn-bid">Join Auction</button>
    </div>
    
    <!-- Admin Setup Section -->
    <div id="adminSetupSection" style="display: none;">
      <h2>Admin Setup</h2>
      <div class="input-group">
        <label for="playerName">Player Name</label>
        <input type="text" id="playerName" placeholder="Enter player name">
      </div>
      <div class="input-group">
        <label for="playerRole">Player Role</label>
        <select id="playerRole">
          <option value="batter">Batter</option>
          <option value="bowler">Bowler (Pacer)</option>
          <option value="spinner">Bowler (Spinner)</option>
          <option value="allrounder">All-Rounder</option>
          <option value="wk">Wicket-Keeper</option>
        </select>
      </div>
      <button id="addPlayerBtn" class="btn btn-add-player">Add Player to Pool</button>
      
      <!-- Bulk Add Section -->
      <div class="bulk-add-section">
        <h3>Bulk Add Players</h3>
        <textarea id="bulkPlayersText" class="bulk-textarea" placeholder="Enter player names, one per line. Format: Player Name,Role (e.g. Virat Kohli,Batter)"></textarea>
        <button id="bulkAddBtn" class="btn btn-add-player">Add All Players</button>
      </div>
      
      <button id="startAuctionBtn" class="btn btn-start-auction">Start Auction</button>
      <div class="room-code-display" id="roomCodeDisplay">
        Share this code with other teams: <span class="room-code" id="roomCodeSpan"></span>
      </div>
    </div>
    
    <!-- Auction Room Section -->
    <div id="auctionRoom" style="display: none;">
      <div class="auction-container">
        <div class="player-pool">
          <h2>Player Pool</h2>
          <div id="playerPoolList"></div>
        </div>
        
        <div class="bid-controls">
          <div class="bid-info">
            <h2>Current Player</h2>
            <div id="currentPlayerCard" class="player-card">
              <p>No player selected</p>
            </div>
            <p>Current Bid: <span id="currentBid" class="bid-amount">‚Çπ0.50 Cr</span></p>
            <p>Bid By: <span id="bidByTeam">-</span></p>
          </div>
          
          <div class="bid-buttons">
            <button id="placeBidBtn" class="btn btn-bid">Bid (+0.25 Cr)</button>
            <button id="passBtn" class="btn btn-pass">Pass</button>
            <button id="rtmBtn" class="btn btn-rtm" style="display: none;">Use RTM Card</button>
            <button id="finalBidBtn" class="btn btn-final-bid" style="display: none;">Final Bid</button>
            <button id="soldBtn" class="btn btn-sold" style="display: none;">Sold!</button>
          </div>
        </div>
        
        <div class="team-list">
          <h2>Your Team</h2>
          <p class="team-budget">Remaining: <span id="remainingBudget">‚Çπ120.00 Cr</span></p>
          <ul class="team-players" id="myTeamPlayers"></ul>
        </div>
      </div>
      
      <button id="backBtn" class="btn btn-back">Back to Home</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, get, child } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCN6aZMwlsZe7JJaovU0WA3UQygWr4jYmA",
      authDomain: "handicricket-85a06.firebaseapp.com",
      projectId: "handicricket-85a06",
      storageBucket: "handicricket-85a06.appspot.com",
      messagingSenderId: "599182538558",
      appId: "1:599182538558:web:3e965753ab05f8f1e3de6f",
      measurementId: "G-HSV9H4LEJQ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // DOM elements
    const teamDisplay = document.getElementById('teamDisplay');
    const budgetDisplay = document.getElementById('budgetDisplay');
    const playerCount = document.getElementById('playerCount');
    const rtmCardsDisplay = document.getElementById('rtmCardsDisplay');
    const joinRoomSection = document.getElementById('joinRoomSection');
    const retentionSection = document.getElementById('retentionSection');
    const retentionPlayersList = document.getElementById('retentionPlayersList');
    const markCaptainBtn = document.getElementById('markCaptainBtn');
    const submitRetentionBtn = document.getElementById('submitRetentionBtn');
    const retentionCount = document.getElementById('retentionCount');
    const retentionCost = document.getElementById('retentionCost');
    const remainingAfterRetention = document.getElementById('remainingAfterRetention');
    const rtmEarned = document.getElementById('rtmEarned');
    const adminSetupSection = document.getElementById('adminSetupSection');
    const auctionRoom = document.getElementById('auctionRoom');
    const auctionRoomCodeInput = document.getElementById('auctionRoomCode');
    const joinAuctionBtn = document.getElementById('joinAuctionBtn');
    const playerPoolList = document.getElementById('playerPoolList');
    const currentPlayerCard = document.getElementById('currentPlayerCard');
    const currentBid = document.getElementById('currentBid');
    const bidByTeam = document.getElementById('bidByTeam');
    const placeBidBtn = document.getElementById('placeBidBtn');
    const passBtn = document.getElementById('passBtn');
    const rtmBtn = document.getElementById('rtmBtn');
    const finalBidBtn = document.getElementById('finalBidBtn');
    const soldBtn = document.getElementById('soldBtn');
    const remainingBudget = document.getElementById('remainingBudget');
    const myTeamPlayers = document.getElementById('myTeamPlayers');
    const playerNameInput = document.getElementById('playerName');
    const playerRoleSelect = document.getElementById('playerRole');
    const addPlayerBtn = document.getElementById('addPlayerBtn');
    const startAuctionBtn = document.getElementById('startAuctionBtn');
    const backBtn = document.getElementById('backBtn');
    const roomCodeDisplay = document.getElementById('roomCodeDisplay');
    const roomCodeSpan = document.getElementById('roomCodeSpan');
    const bulkPlayersText = document.getElementById('bulkPlayersText');
    const bulkAddBtn = document.getElementById('bulkAddBtn');

    // Game state
    let currentUser = localStorage.getItem('hc_username');
    let currentTeam = localStorage.getItem('hc_team');
    let isAdmin = currentUser === 'imved169';
    let auctionRoomCode = '';
    let myTeam = [];
    let myBudget = 120; // Starting budget of 120 Cr
    let currentPlayer = null;
    let currentPlayerBid = 0.5;
    let currentBidder = null;
    let playersPool = [];
    let retainedPlayers = [];
    let rtmCards = 0;
    let previousSquad = [];
    let selectedRetentions = [];
    let retentionCaptain = null;
    let rtmActive = false;
    let finalBidActive = false;
    let autoAuctionInterval = null;

    // Initialize
    if (!currentUser || !currentTeam) {
      alert('Please login first');
      window.location.href = 'index.html';
    }

    teamDisplay.textContent = currentTeam;
    updateBudgetDisplay();

    // Check if we have a room code in URL
    const urlParams = new URLSearchParams(window.location.search);
    const roomCodeFromURL = urlParams.get('room');
    
    if (roomCodeFromURL) {
      // If room code is in URL, join directly
      auctionRoomCode = roomCodeFromURL;
      joinAuctionRoom();
    } else {
      // Otherwise proceed with normal flow
      loadPreviousSquad();
    }

    function loadPreviousSquad() {
      const userRef = ref(db, `users/${currentUser}`);
      get(userRef).then((snap) => {
        if (snap.exists()) {
          const userData = snap.val();
          previousSquad = userData.players || [];
          
          if (previousSquad.length > 0) {
            showRetentionSection();
            populateRetentionPlayers();
          } else {
            // No previous squad, skip retention
            if (isAdmin) {
              showAdminSetup();
            } else {
              joinRoomSection.style.display = 'block';
            }
          }
        } else {
          // No previous squad, skip retention
          if (isAdmin) {
            showAdminSetup();
          } else {
            joinRoomSection.style.display = 'block';
          }
        }
      });
    }

    function showAdminSetup() {
      // Generate room code for admin
      auctionRoomCode = generateRoomCode();
      roomCodeSpan.textContent = auctionRoomCode;
      roomCodeDisplay.style.display = 'block';
      
      // Initialize auction room
      set(ref(db, `auctions/${auctionRoomCode}`), {
        createdBy: currentUser,
        createdAt: Date.now(),
        playersPool: [],
        teams: {},
        status: 'setup'
      });
      
      // Listen for changes to players pool
      const playersPoolRef = ref(db, `auctions/${auctionRoomCode}/playersPool`);
      onValue(playersPoolRef, (snap) => {
        if (snap.exists()) {
          playersPool = snap.val();
          updatePlayerPool();
        } else {
          playersPool = [];
        }
      });
      
      // Listen for team joins to auto-start auction
      const teamsRef = ref(db, `auctions/${auctionRoomCode}/teams`);
      onValue(teamsRef, (snap) => {
        if (snap.exists()) {
          const teams = snap.val();
          if (Object.keys(teams).length >= 2 && playersPool.length > 0) {
            // Auto-start auction when 2+ teams join and players exist
            startAuction();
          }
        }
      });
      
      adminSetupSection.style.display = 'block';
    }

    function showRetentionSection() {
      retentionSection.style.display = 'block';
      joinRoomSection.style.display = 'none';
    }

    function populateRetentionPlayers() {
      retentionPlayersList.innerHTML = '';
      
      previousSquad.forEach(player => {
        const playerCard = document.createElement('div');
        playerCard.className = 'retention-player';
        playerCard.dataset.player = player;
        playerCard.textContent = player;
        
        playerCard.addEventListener('click', () => {
          togglePlayerRetention(player, playerCard);
        });
        
        retentionPlayersList.appendChild(playerCard);
      });
    }

    function togglePlayerRetention(player, card) {
      const index = selectedRetentions.indexOf(player);
      
      if (index === -1) {
        if (selectedRetentions.length < 6) {
          selectedRetentions.push(player);
          card.classList.add('selected');
          
          if (selectedRetentions.length === 1) {
            // First selected player is automatically captain
            retentionCaptain = player;
            card.classList.add('captain');
            markCaptainBtn.disabled = true;
          } else {
            markCaptainBtn.disabled = false;
          }
        }
      } else {
        selectedRetentions.splice(index, 1);
        card.classList.remove('selected');
        
        if (player === retentionCaptain) {
          card.classList.remove('captain');
          retentionCaptain = selectedRetentions.length > 0 ? selectedRetentions[0] : null;
          
          // Update captain class for the first player if any
          if (selectedRetentions.length > 0) {
            const firstPlayerCard = document.querySelector(`.retention-player[data-player="${selectedRetentions[0]}"]`);
            if (firstPlayerCard) {
              firstPlayerCard.classList.add('captain');
            }
          }
        }
        
        markCaptainBtn.disabled = selectedRetentions.length <= 1;
      }
      
      updateRetentionSummary();
    }

    function updateRetentionSummary() {
      retentionCount.textContent = selectedRetentions.length;
      
      // Calculate retention cost (captain 4Cr, others 2Cr)
      const captainCost = retentionCaptain ? 4 : 0;
      const otherPlayersCost = Math.max(0, selectedRetentions.length - 1) * 2;
      const totalRetentionCost = captainCost + otherPlayersCost;
      
      retentionCost.textContent = totalRetentionCost;
      remainingAfterRetention.textContent = (120 - totalRetentionCost).toFixed(2);
      
      // Calculate RTM cards (6 - retained players)
      const rtmCardsEarned = Math.max(0, 6 - selectedRetentions.length);
      rtmEarned.textContent = rtmCardsEarned;
      
      // Enable/disable submit button based on selections
      submitRetentionBtn.disabled = selectedRetentions.length === 0;
    }

    // Mark a different player as captain
    markCaptainBtn.addEventListener('click', () => {
      const selectedPlayerCards = document.querySelectorAll('.retention-player.selected');
      const selectedPlayers = Array.from(selectedPlayerCards).map(card => card.dataset.player);
      
      // Show dialog to select captain
      const captainName = prompt(`Select captain from:\n${selectedPlayers.join('\n')}`);
      
      if (captainName && selectedPlayers.includes(captainName)) {
        // Remove captain class from previous captain
        if (retentionCaptain) {
          const prevCaptainCard = document.querySelector(`.retention-player[data-player="${retentionCaptain}"]`);
          if (prevCaptainCard) prevCaptainCard.classList.remove('captain');
        }
        
        // Set new captain
        retentionCaptain = captainName;
        const newCaptainCard = document.querySelector(`.retention-player[data-player="${captainName}"]`);
        if (newCaptainCard) newCaptainCard.classList.add('captain');
        
        updateRetentionSummary();
      }
    });

    // Submit retention selections
    submitRetentionBtn.addEventListener('click', async () => {
      const captainCost = retentionCaptain ? 4 : 0;
      const otherPlayersCost = Math.max(0, selectedRetentions.length - 1) * 2;
      const totalRetentionCost = captainCost + otherPlayersCost;
      
      // Calculate remaining budget and RTM cards
      myBudget = 120 - totalRetentionCost;
      rtmCards = Math.max(0, 6 - selectedRetentions.length);
      
      // Update UI
      updateBudgetDisplay();
      rtmCardsDisplay.textContent = rtmCards;
      
      // Save retained players to database
      const userRef = ref(db, `users/${currentUser}`);
      await update(userRef, {
        retainedPlayers: selectedRetentions,
        retentionCaptain: retentionCaptain,
        auctionBudget: myBudget,
        rtmCards: rtmCards
      });
      
      // Hide retention section and show appropriate next section
      retentionSection.style.display = 'none';
      
      if (isAdmin) {
        showAdminSetup();
      } else {
        joinRoomSection.style.display = 'block';
      }
      
      alert(`Retention successful! ${selectedRetentions.length} players retained (${retentionCaptain} as captain). You have ‚Çπ${myBudget} Cr remaining and ${rtmCards} RTM cards.`);
    });

    // Join auction room
    joinAuctionBtn.addEventListener('click', () => {
      auctionRoomCode = auctionRoomCodeInput.value.trim();
      
      if (!auctionRoomCode || auctionRoomCode.length !== 6) {
        alert('Please enter a valid 6-digit room code');
        return;
      }
      
      joinAuctionRoom();
    });

    function joinAuctionRoom() {
      // Check if room exists
      const roomRef = ref(db, `auctions/${auctionRoomCode}`);
      get(roomRef).then((roomSnap) => {
        if (!roomSnap.exists()) {
          alert('Auction room not found. Please check the code.');
          return;
        }
        
        const roomData = roomSnap.val();
        
        // Join room
        joinRoomSection.style.display = 'none';
        retentionSection.style.display = 'none';
        adminSetupSection.style.display = 'none';
        auctionRoom.style.display = 'block';
        
        // Add team to auction if not already added
        if (!roomData.teams || !roomData.teams[currentTeam]) {
          update(ref(db, `auctions/${auctionRoomCode}/teams`), {
            [currentTeam]: {
              budget: myBudget,
              players: [],
              rtmCards: rtmCards
            }
          });
        }
        
        // Load room data
        loadAuctionRoom();
      });
    }

    // Load auction room data
    function loadAuctionRoom() {
      const roomRef = ref(db, `auctions/${auctionRoomCode}`);
      
      onValue(roomRef, (snap) => {
        if (snap.exists()) {
          const roomData = snap.val();
          
          // Update players pool
          playersPool = roomData.playersPool || [];
          updatePlayerPool();
          
          // Update current player
          if (roomData.currentPlayer) {
            currentPlayer = roomData.currentPlayer;
            currentPlayerBid = roomData.currentBid || 0.5;
            currentBidder = roomData.currentBidder || null;
            updateCurrentPlayer();
          } else if (isAdmin && roomData.status === 'active' && !currentPlayer && playersPool.length > 0) {
            // Auto-select next player if none is selected
            selectNextPlayer();
          }
          
          // Update my team if exists
          if (roomData.teams && roomData.teams[currentTeam]) {
            myTeam = roomData.teams[currentTeam].players || [];
            myBudget = roomData.teams[currentTeam].budget || myBudget;
            rtmCards = roomData.teams[currentTeam].rtmCards || rtmCards;
            updateMyTeam();
            updateBudgetDisplay();
          }
          
          // Handle RTM status
          if (roomData.rtmActive && roomData.rtmTeam !== currentTeam) {
            // Another team is using RTM
            if (currentBidder === currentTeam) {
              // I'm the current bidder - can make final bid
              finalBidActive = true;
              finalBidBtn.style.display = 'block';
              alert(`${roomData.rtmTeam} is using RTM on ${roomData.rtmPlayer}. You can make one final bid.`);
            }
          }
          
          if (roomData.finalBid) {
            // Final bid made, RTM team must match
            if (roomData.rtmTeam === currentTeam) {
              const confirmMatch = confirm(`Final bid is ‚Çπ${roomData.currentBid} Cr. Match this bid to retain ${roomData.rtmPlayer}?`);
              
              if (confirmMatch) {
                // Match the bid
                update(ref(db, `auctions/${auctionRoomCode}`), {
                  currentBidder: currentTeam,
                  rtmActive: false,
                  finalBid: false,
                  rtmTeam: null,
                  rtmPlayer: null
                });
                
                // Mark player as sold to my team
                markPlayerAsSold();
                rtmCards--;
                rtmCardsDisplay.textContent = rtmCards;
              } else {
                // Decline to match - player goes to original bidder
                update(ref(db, `auctions/${auctionRoomCode}`), {
                  rtmActive: false,
                  finalBid: false,
                  rtmTeam: null,
                  rtmPlayer: null
                });
              }
            }
          }
          
          // Auto-mark player as sold if no bids after timeout (admin only)
          if (isAdmin && currentPlayer && currentBidder && !autoAuctionInterval) {
            startAutoAuctionTimer();
          }
        }
      });
    }
    
    function startAutoAuctionTimer() {
      // Clear any existing interval
      if (autoAuctionInterval) {
        clearInterval(autoAuctionInterval);
      }
      
      // Start new timer (30 seconds)
      let timeLeft = 30;
      autoAuctionInterval = setInterval(() => {
        timeLeft--;
        
        if (timeLeft <= 0) {
          clearInterval(autoAuctionInterval);
          autoAuctionInterval = null;
          
          // Auto-mark player as sold
          if (currentPlayer && currentBidder) {
            markPlayerAsSold();
          }
        }
      }, 1000);
    }

    // Update player pool display
    function updatePlayerPool() {
      playerPoolList.innerHTML = '';
      
      // Group players by role
      const playersByRole = {
        batter: [],
        bowler: [],
        spinner: [],
        allrounder: [],
        wk: []
      };
      
      playersPool.forEach(player => {
        if (!player.sold) {
          playersByRole[player.role].push(player);
        }
      });
      
      // Display players by role
      for (const [role, players] of Object.entries(playersByRole)) {
        if (players.length > 0) {
          const roleHeader = document.createElement('h3');
          roleHeader.textContent = getRoleDisplayName(role);
          roleHeader.style.color = getRoleColor(role);
          playerPoolList.appendChild(roleHeader);
          
          players.forEach(player => {
            const playerCard = document.createElement('div');
            playerCard.className = 'player-card';
            if (currentPlayer && currentPlayer.id === player.id) {
              playerCard.classList.add('current-player');
            }
            playerCard.innerHTML = `
              <h3>${player.name}</h3>
              <span class="player-role role-${player.role}">${getRoleDisplayName(player.role)}</span>
              <p>Base Price: ‚Çπ0.50 Cr</p>
              ${player.stats ? `<p>${player.stats}</p>` : ''}
            `;
            
            if (isAdmin) {
              playerCard.addEventListener('click', () => {
                setCurrentPlayer(player);
              });
            }
            
            playerPoolList.appendChild(playerCard);
          });
        }
      }
    }

    // Update current player display
    function updateCurrentPlayer() {
      if (!currentPlayer) {
        currentPlayerCard.innerHTML = '<p>No player selected</p>';
        currentBid.textContent = '‚Çπ0.50 Cr';
        bidByTeam.textContent = '-';
        placeBidBtn.style.display = 'block';
        passBtn.style.display = 'block';
        rtmBtn.style.display = 'none';
        finalBidBtn.style.display = 'none';
        soldBtn.style.display = 'none';
        return;
      }
      
      currentPlayerCard.innerHTML = `
        <h3>${currentPlayer.name}</h3>
        <span class="player-role role-${currentPlayer.role}">${getRoleDisplayName(currentPlayer.role)}</span>
        <p>Base Price: ‚Çπ0.50 Cr</p>
        ${currentPlayer.stats ? `<p>${currentPlayer.stats}</p>` : ''}
      `;
      
      currentBid.textContent = `‚Çπ${currentPlayerBid.toFixed(2)} Cr`;
      bidByTeam.textContent = currentBidder || '-';
      
      // Disable bid button if I'm the current bidder or if I'm out of budget
      if (currentBidder === currentTeam || (myBudget - currentPlayerBid - 0.25) < 0) {
        placeBidBtn.disabled = true;
      } else {
        placeBidBtn.disabled = false;
      }
      
      // Check if player is from my previous squad (for RTM)
      const isFromMySquad = previousSquad.includes(currentPlayer.name) && 
                           !selectedRetentions.includes(currentPlayer.name);
      
      // Show RTM button if eligible
      rtmBtn.style.display = isFromMySquad && rtmCards > 0 && !rtmActive ? 'block' : 'none';
      
      // Show sold button for admin
      if (isAdmin) {
        soldBtn.style.display = currentBidder ? 'block' : 'none';
      }
    }

    // Update my team display
    function updateMyTeam() {
      myTeamPlayers.innerHTML = '';
      
      if (myTeam.length === 0) {
        myTeamPlayers.innerHTML = '<li>No players yet</li>';
        return;
      }
      
      myTeam.forEach(player => {
        const li = document.createElement('li');
        li.innerHTML = `
          ${player.name} <span class="player-role role-${player.role}">${getRoleDisplayName(player.role)}</span>
          <span style="float: right;">‚Çπ${player.price.toFixed(2)} Cr</span>
        `;
        myTeamPlayers.appendChild(li);
      });
    }

    // Update budget display
    function updateBudgetDisplay() {
      budgetDisplay.textContent = `‚Çπ${myBudget.toFixed(2)} Cr`;
      remainingBudget.textContent = `‚Çπ${myBudget.toFixed(2)} Cr`;
      playerCount.textContent = `${myTeam.length}/25`;
      rtmCardsDisplay.textContent = rtmCards;
    }

    // Place bid
    placeBidBtn.addEventListener('click', () => {
      if (!currentPlayer) return;
      
      const newBid = currentPlayerBid + 0.25;
      
      if (newBid > myBudget) {
        alert('Not enough budget!');
        return;
      }
      
      // Update in Firebase
      update(ref(db, `auctions/${auctionRoomCode}`), {
        currentBid: newBid,
        currentBidder: currentTeam
      });
      
      // Reset auto auction timer
      if (autoAuctionInterval) {
        clearInterval(autoAuctionInterval);
        autoAuctionInterval = null;
      }
      startAutoAuctionTimer();
    });

    // Pass
    passBtn.addEventListener('click', () => {
      if (!currentPlayer) return;
      
      // Just wait for others to bid or admin to mark as sold
    });

    // RTM button handler
    rtmBtn.addEventListener('click', () => {
      if (!currentPlayer || rtmCards <= 0) return;
      
      rtmActive = true;
      rtmBtn.style.display = 'none';
      
      // Notify all users that RTM is being used
      update(ref(db, `auctions/${auctionRoomCode}`), {
        rtmActive: true,
        rtmTeam: currentTeam,
        rtmPlayer: currentPlayer.id
      });
      
      alert(`Using RTM card on ${currentPlayer.name}. Original bidder gets one final chance to bid.`);
    });
    
    // Final bid button handler (for original bidder)
    finalBidBtn.addEventListener('click', () => {
      if (!currentPlayer || !finalBidActive) return;
      
      const newBid = currentPlayerBid + 0.25;
      
      // Update bid in Firebase
      update(ref(db, `auctions/${auctionRoomCode}`), {
        currentBid: newBid,
        currentBidder: currentTeam,
        finalBid: true
      });
      
      finalBidBtn.style.display = 'none';
    });

    // Admin: Add player to pool
    addPlayerBtn.addEventListener('click', async () => {
      const playerName = playerNameInput.value.trim();
      const playerRole = playerRoleSelect.value;
      
      if (!playerName) {
        alert('Please enter player name');
        return;
      }
      
      // Create player object
      const newPlayer = {
        id: Date.now().toString(),
        name: playerName,
        role: playerRole,
        basePrice: 0.5,
        sold: false
      };
      
      // Add to pool in Firebase
      const roomRef = ref(db, `auctions/${auctionRoomCode}/playersPool`);
      const roomSnap = await get(roomRef);
      
      let updatedPool = [];
      if (roomSnap.exists()) {
        updatedPool = roomSnap.val();
      }
      
      updatedPool.push(newPlayer);
      
      await set(roomRef, updatedPool);
      
      playerNameInput.value = '';
      alert('Player added to pool!');
    });

    // Admin: Bulk add players
    bulkAddBtn.addEventListener('click', async () => {
      const bulkText = bulkPlayersText.value.trim();
      if (!bulkText) {
        alert('Please enter player data');
        return;
      }
      
      const lines = bulkText.split('\n');
      const newPlayers = [];
      
      for (const line of lines) {
        const [name, role] = line.split(',').map(s => s.trim());
        if (name && role) {
          newPlayers.push({
            id: Date.now().toString() + Math.random().toString(36).substr(2, 5),
            name: name,
            role: role.toLowerCase(),
            basePrice: 0.5,
            sold: false
          });
        }
      }
      
      if (newPlayers.length === 0) {
        alert('No valid players found. Format: "Player Name,Role"');
        return;
      }
      
      // Add to pool in Firebase
      const roomRef = ref(db, `auctions/${auctionRoomCode}/playersPool`);
      const roomSnap = await get(roomRef);
      
      let updatedPool = [];
      if (roomSnap.exists()) {
        updatedPool = roomSnap.val();
      }
      
      updatedPool = [...updatedPool, ...newPlayers];
      
      await set(roomRef, updatedPool);
      
      bulkPlayersText.value = '';
      alert(`Added ${newPlayers.length} players to pool!`);
    });

    // Admin: Set current player
    function setCurrentPlayer(player) {
  // Only allow admin (imved169) to set players
  if (currentUser !== 'imved169') {
    alert('Only the admin (Ratnagiri Hunters) can set players!');
    return;
  }

  currentPlayer = player;
  currentPlayerBid = 0.5;
  currentBidder = null;

  update(ref(db, `auctions/${auctionRoomCode}`), {
    currentPlayer: player,
    currentBid: 0.5,
    currentBidder: null,
    rtmActive: false,
    finalBid: false,
    rtmTeam: null,
    rtmPlayer: null
  });

  // Reset auto-timer
  if (autoAuctionInterval) clearInterval(autoAuctionInterval);
  startAutoAuctionTimer();
    }
      
      // Start auto auction timer
      if (autoAuctionInterval) {
        clearInterval(autoAuctionInterval);
        autoAuctionInterval = null;
      }
    }

    // Admin: Start auction
    startAuctionBtn.addEventListener('click', startAuction);
    
    function startAuction() {
      // Check if there are players in the pool
      if (playersPool.length === 0) {
        alert('Please add players to the pool first');
        return;
      }
      
      // Initialize teams with all registered users
      const usersRef = ref(db, 'users');
      get(usersRef).then((usersSnap) => {
        if (usersSnap.exists()) {
          const users = usersSnap.val();
          const teamsData = {};
          
          for (const [username, user] of Object.entries(users)) {
            teamsData[user.team] = {
              budget: user.auctionBudget || 120,
              players: user.retainedPlayers ? user.retainedPlayers.map(name => ({
                name: name,
                role: 'unknown',
                price: name === user.retentionCaptain ? 4 : 2
              })) : [],
              rtmCards: user.rtmCards || 0
            };
          }
          
          // Update room status and teams
          update(ref(db, `auctions/${auctionRoomCode}`), {
            teams: teamsData,
            status: 'active'
          }).then(() => {
            // Select first player automatically
            selectNextPlayer();
          });
        }
      });
      
      // Hide setup section and show auction room
      adminSetupSection.style.display = 'none';
      auctionRoom.style.display = 'block';
      
      alert('Auction started! All teams can now join and bid.');
    }
    
    // Select next player from pool
    function selectNextPlayer() {
      const unsoldPlayers = playersPool.filter(p => !p.sold);
      if (unsoldPlayers.length > 0) {
        setCurrentPlayer(unsoldPlayers[0]);
      } else {
        alert('All players have been sold! Auction completed.');
      }
    }

    // Admin: Mark player as sold
    soldBtn.addEventListener('click', markPlayerAsSold);
    
    function markPlayerAsSold() {
      if (!currentPlayer || !currentBidder) return;
      
      // Update player as sold
      const roomRef = ref(db, `auctions/${auctionRoomCode}`);
      const updates = {};
      
      // Add player to winning team
      updates[`teams/${currentBidder}/players`] = [...myTeam, {
        ...currentPlayer,
        price: currentPlayerBid
      }];
      updates[`teams/${currentBidder}/budget`] = myBudget - currentPlayerBid;
      
      // Mark player as sold in pool
      const playerIndex = playersPool.findIndex(p => p.id === currentPlayer.id);
      if (playerIndex !== -1) {
        updates[`playersPool/${playerIndex}/sold`] = true;
      }
      
      // Reset current player and RTM flags
      updates['currentPlayer'] = null;
      updates['currentBid'] = 0.5;
      updates['currentBidder'] = null;
      updates['rtmActive'] = false;
      updates['finalBid'] = false;
      updates['rtmTeam'] = null;
      updates['rtmPlayer'] = null;
      
      // Update RTM cards if used
      if (rtmActive && currentBidder === currentTeam) {
        updates[`teams/${currentTeam}/rtmCards`] = rtmCards - 1;
        rtmCards--;
        rtmCardsDisplay.textContent = rtmCards;
      }
      
      rtmActive = false;
      finalBidActive = false;
      
      update(roomRef, updates).then(() => {
        // Auto-select next player
        if (isAdmin) {
          setTimeout(selectNextPlayer, 1000);
        }
      });
      
      // Clear auto auction timer
      if (autoAuctionInterval) {
        clearInterval(autoAuctionInterval);
        autoAuctionInterval = null;
      }
    }

    // Back button
    backBtn.addEventListener('click', () => {
      window.location.href = 'index.html';
    });

    // Helper functions
    function getRoleDisplayName(role) {
      const roleNames = {
        batter: 'Batter',
        bowler: 'Pacer',
        spinner: 'Spinner',
        allrounder: 'All-Rounder',
        wk: 'Wicket-Keeper'
      };
      return roleNames[role] || role;
    }

    function getRoleColor(role) {
      const roleColors = {
        batter: '#4CAF50',
        bowler: '#F44336',
        spinner: '#F44336',
        allrounder: '#FF9800',
        wk: '#9C27B0'
      };
      return roleColors[role] || '#FFFFFF';
    }

    function generateRoomCode() {
      return Math.floor(100000 + Math.random() * 900000).toString();
    }
  </script>
</body>
</html>
