<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HandiCricket - First Innings</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* PHASE 1: BASIC STRUCTURE STYLES */
    body {
      background: #061e3e;
      color: white;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      text-align: center;
      padding: 8px;
      margin: 0;
      overflow-x: hidden;
      position: relative;
    }
    
    body::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(6, 30, 62, 0.85);
      z-index: -1;
    }
    
    h1 {
      margin: 8px 0 12px;
      color: #ffeb3b;
      text-shadow: 0 0 5px rgba(255, 235, 59, 0.5);
      font-size: 1.5rem;
    }
    
    .container {
      max-width: 100%;
      width: 100%;
      margin: 0 auto;
      background: rgba(0, 0, 0, 0.4);
      border-radius: 10px;
      padding: 8px;
      box-sizing: border-box;
      backdrop-filter: blur(5px);
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    
    /* Team names display */
    .team-names-compact {
      margin-bottom: 8px;
      font-size: 13px;
      background: rgba(13, 42, 82, 0.5);
      padding: 6px;
      border-radius: 6px;
      text-align: center;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .team-name-line {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
      gap: 4px;
    }

    .team-label {
      color: #aaa;
      font-size: 11px;
    }

    .team-divider {
      color: #666;
      margin: 0 4px;
    }
    
    /* Score display */
    .scorebox-main {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background: rgba(13, 42, 82, 0.8);
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      margin-bottom: 10px;
    }

    .team-score {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }

    .score-large {
      font-size: 2rem;
      font-weight: bold;
      color: #ffeb3b;
      line-height: 1;
      margin: 5px 0;
    }

    .score-details {
      text-align: right;
      font-size: 0.9rem;
    }

    .score-details div {
      margin: 3px 0;
    }
    
    /* Match info bar */
    .match-info-bar {
      display: flex;
      justify-content: center;
      align-items: center;
      background: rgba(13, 42, 82, 0.5);
      padding: 8px;
      border-radius: 6px;
      margin: 10px 0;
      font-size: 0.8rem;
      gap: 8px;
      flex-wrap: wrap;
    }

    .match-info-item {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 45%;
    }

    .divider {
      color: #666;
      flex-shrink: 0;
    }
    
    /* Over progress */
    .over-progress {
      display: flex;
      justify-content: center;
      margin: 10px 0;
      gap: 3px;
    }

    .ball {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: bold;
    }

    .ball.boundary {
      background: #4CAF50;
    }

    .ball.six {
      background: #9C27B0;
    }

    .ball.wicket {
      background: #F44336;
    }

    .ball.dot {
      background: #607D8B;
    }

    .ball.free-hit {
      background: #FF9800;
    }
    
    /* Powerplay indicator */
    .powerplay-indicator {
      padding: 5px 10px;
      background: rgba(255, 215, 0, 0.3);
      border-radius: 15px;
      font-size: 12px;
      margin: 5px 0;
      display: inline-block;
      border: 1px solid gold;
    }
    
    /* Card Buttons */
    .card-btns { 
      margin: 15px auto;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
    }
    
    .card-btns button { 
      width: 55px;
      height: 55px;
      font-size: 20px;
      border-radius: 10px;
      border: none;
      background: linear-gradient(145deg, #1e88e5, #1565c0);
      color: white;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
      transition: all 0.2s;
      font-weight: bold;
    }
    
    .card-btns button:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 8px rgba(0, 0, 0, 0.3);
      background: linear-gradient(145deg, #2196f3, #1976d2);
    }
    
    .card-btns button:active {
      transform: translateY(1px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .card-btns button:disabled { 
      background: #607d8b;
      color: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .card-btns button.selected {
      background: #4caf50;
      border: 2px solid #ffeb3b;
      transform: scale(1.05);
    }
    
    /* Result display */
    #result {
      font-size: 16px;
      margin: 12px 0;
      padding: 10px;
      min-height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.5);
      border-radius: 8px;
      border-left: 3px solid #1e88e5;
      font-weight: 500;
    }
    
    /* Connection status */
    #connectionStatus {
      padding: 8px;
      border-radius: 6px;
      text-align: center;
      margin: 12px auto;
      max-width: 250px;
      font-weight: bold;
      font-size: 14px;
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .online { 
      background: #4CAF50;
      color: white;
    }
    
    .offline { 
      background: #F44336;
      color: white;
    }
    
    /* Player selection modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      display: none;
    }
    
    .modal-content {
      background: #0a2a4a;
      border-radius: 10px;
      padding: 20px;
      width: 90%;
      max-width: 400px;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .modal h2 {
      color: #ffeb3b;
      margin-top: 0;
    }
    
    .player-list {
      list-style: none;
      padding: 0;
      margin: 15px 0;
    }
    
    .player-list li {
      padding: 10px;
      margin: 5px 0;
      background: rgba(30, 136, 229, 0.2);
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .player-list li:hover {
      background: rgba(30, 136, 229, 0.4);
    }
    
    /* Commentary section */
    .commentary {
      margin: 15px 0;
      padding: 10px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      max-height: 150px;
      overflow-y: auto;
      text-align: left;
      font-size: 14px;
    }
    
    .commentary-item {
      padding: 5px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    /* Stats section */
    .stats-container {
      display: none;
      margin: 15px 0;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      padding: 10px;
    }
    
    .stats-table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
      font-size: 12px;
    }
    
    .stats-table th, .stats-table td {
      padding: 5px;
      text-align: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .stats-table th {
      background: rgba(30, 136, 229, 0.3);
    }
    
    /* Responsive adjustments */
    @media (max-width: 480px) {
      body {
        padding: 6px;
      }
      
      .container {
        padding: 8px;
      }
      
      h1 {
        font-size: 1.3rem;
        margin: 6px 0 10px;
      }
      
      .card-btns button {
        width: 45px;
        height: 45px;
        font-size: 18px;
      }
      
      .score-large {
        font-size: 1.7rem;
      }
      
      .match-info-bar {
        font-size: 0.75rem;
      }
      
      .score-details {
        font-size: 0.8rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>HandiCricket</h1>
    
    <!-- Team names display -->
    <div class="team-names-compact">
      <div class="team-name-line">
        <span class="team-label">Batting:</span>
        <span id="team1Name">Team A</span>
        <span class="team-divider">|</span>
        <span class="team-label">Bowling:</span>
        <span id="team2Name">Team B</span>
      </div>
    </div>
    
    <!-- Score display -->
    <div class="scorebox">
      <div class="scorebox-main">
        <div class="team-score">
          <span id="battingTeamName">Team A</span>
          <span class="score-large"><span id="runs">0</span>/<span id="wickets">0</span></span>
          <span id="currentBatter">Batter: Not selected</span>
        </div>
        <div class="score-details">
          <div>Overs: <strong id="overs">0.0</strong></div>
          <div>Run Rate: <strong id="runRate">0.00</strong></div>
          <div>Target: <strong id="target">-</strong></div>
        </div>
      </div>
    </div>
    
    <!-- Over progress -->
    <div class="over-progress" id="overProgress"></div>
    
    <!-- Powerplay indicator -->
    <div id="powerplayIndicator" class="powerplay-indicator" style="display: none;">Powerplay</div>
    
    <!-- Match info bar -->
    <div class="match-info-bar">
      <div class="match-format" id="formatDisplay">5 Overs</div>
      <div class="match-status">
        <span id="inningsNumber">1st Innings</span>
        <span class="divider">|</span>
        <span id="roleText">You are Batting</span>
      </div>
      <div class="match-time">
        <span id="currentTime">14:30</span>
        <span class="divider">|</span>
        <span id="matchDate">23 Jul 2023</span>
      </div>
    </div>
    
    <!-- Game status and result display -->
    <div id="result">Initializing game...</div>
    
    <!-- Commentary section -->
    <div class="commentary" id="commentary">
      <div class="commentary-item">Welcome to HandiCricket! Game is initializing...</div>
    </div>
    
    <!-- Card buttons -->
    <div class="card-btns" id="cardButtons">
      <button class="btn" data-value="0">0</button>
      <button class="btn" data-value="1">1</button>
      <button class="btn" data-value="2">2</button>
      <button class="btn" data-value="3">3</button>
      <button class="btn" data-value="4">4</button>
      <button class="btn" data-value="5">5</button>
      <button class="btn" data-value="6">6</button>
    </div>
    
    <!-- Connection status -->
    <div id="connectionStatus" class="online">
      Opponent: Online
    </div>
    
    <!-- Stats section -->
    <div class="stats-container" id="statsContainer">
      <h3>Match Statistics</h3>
      <div class="stats-tables">
        <div class="batting-stats">
          <h4>Batting</h4>
          <table class="stats-table" id="battingStats">
            <thead>
              <tr>
                <th>Batter</th>
                <th>Runs</th>
                <th>Balls</th>
                <th>4s</th>
                <th>6s</th>
                <th>SR</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="bowling-stats">
          <h4>Bowling</h4>
          <table class="stats-table" id="bowlingStats">
            <thead>
              <tr>
                <th>Bowler</th>
                <th>Overs</th>
                <th>Runs</th>
                <th>Wkts</th>
                <th>Economy</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Player selection modal -->
    <div class="modal" id="playerSelectionModal">
      <div class="modal-content">
        <h2 id="modalTitle">Select Player</h2>
        <ul class="player-list" id="playerList"></ul>
        <button id="confirmSelection">Confirm Selection</button>
      </div>
    </div>
    
    <!-- End of innings modal -->
    <div class="modal" id="endInningsModal">
      <div class="modal-content">
        <h2>End of Innings</h2>
        <div id="inningsSummary"></div>
        <button id="startSecondInnings">Start Second Innings</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, get, push } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCN6aZMwlsZe7JJaovU0WA3UQygWr4jYmA",
      authDomain: "handicricket-85a06.firebaseapp.com",
      projectId: "handicricket-85a06",
      storageBucket: "handicricket-85a06.appspot.com",
      messagingSenderId: "599182538558",
      appId: "1:599182538558:web:3e965753ab05f8f1e3de6f",
      measurementId: "G-HSV9H4LEJQ"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Game Constants
    const FORMAT_RULES = {
      "5": { 
        name: "5 Overs", 
        totalOvers: 5, 
        totalWickets: 10,
        powerplayOvers: 2, 
        powerplayWicketValue: 0.5,
        regularWicketValue: 1.0,
        deadOvers: []
      },
      "10": { 
        name: "10 Overs", 
        totalOvers: 10, 
        totalWickets: 10,
        powerplayOvers: 3, 
        powerplayWicketValue: 0.5,
        regularWicketValue: 1.0,
        deadOvers: []
      },
      "20": { 
        name: "T20", 
        totalOvers: 20, 
        totalWickets: 10,
        powerplayOvers: 6, 
        powerplayWicketValue: 0.5,
        regularWicketValue: 1.0,
        deadOvers: []
      },
      "50": { 
        name: "ODI", 
        totalOvers: 50, 
        totalWickets: 10,
        powerplayOvers: [1,10, 21,30, 41,42], 
        powerplayWicketValue: 0.25,
        regularWicketValue: 0.5,
        deadOvers: [11,20, 31,40]
      },
      "Test": { 
        name: "Test", 
        totalOvers: 450, // 90 overs/day * 5 days
        totalWickets: 10,
        powerplayOvers: [], // No powerplays in Test
        powerplayWicketValue: 0.333, // 1/3 wicket per dismissal
        regularWicketValue: 0.333,
        deadOvers: []
      }
    };

    // CricketGame class
    class CricketGame {
      constructor() {
        // DOM Elements
        this.elements = {
          result: document.getElementById("result"),
          team1Name: document.getElementById("team1Name"),
          team2Name: document.getElementById("team2Name"),
          battingTeamName: document.getElementById("battingTeamName"),
          runs: document.getElementById("runs"),
          wickets: document.getElementById("wickets"),
          overs: document.getElementById("overs"),
          runRate: document.getElementById("runRate"),
          target: document.getElementById("target"),
          formatDisplay: document.getElementById("formatDisplay"),
          inningsNumber: document.getElementById("inningsNumber"),
          roleText: document.getElementById("roleText"),
          currentTime: document.getElementById("currentTime"),
          matchDate: document.getElementById("matchDate"),
          connectionStatus: document.getElementById("connectionStatus"),
          cardButtons: document.getElementById("cardButtons"),
          buttons: document.querySelectorAll(".btn"),
          overProgress: document.getElementById("overProgress"),
          powerplayIndicator: document.getElementById("powerplayIndicator"),
          commentary: document.getElementById("commentary"),
          statsContainer: document.getElementById("statsContainer"),
          battingStats: document.getElementById("battingStats"),
          bowlingStats: document.getElementById("bowlingStats"),
          playerSelectionModal: document.getElementById("playerSelectionModal"),
          playerList: document.getElementById("playerList"),
          modalTitle: document.getElementById("modalTitle"),
          confirmSelection: document.getElementById("confirmSelection"),
          endInningsModal: document.getElementById("endInningsModal"),
          inningsSummary: document.getElementById("inningsSummary"),
          startSecondInnings: document.getElementById("startSecondInnings"),
          currentBatter: document.getElementById("currentBatter")
        };

        // Game state
        this.state = {
          runs: 0,
          wickets: 0,
          legalBalls: 0,
          freeHit: false,
          freeHitNextBall: false,
          currentBatter: null,
          currentBowler: null,
          isBatting: false,
          currentFormat: {},
          isPowerplay: false,
          isDeadOver: false,
          gameInProgress: true,
          lastOverRuns: 0,
          lastOverWickets: 0,
          lastWicketScore: 0,
          ballByBall: {},
          fallOfWickets: [],
          batterStats: {},
          bowlerStats: {},
          tossWinner: null,
          battingFirst: null,
          batterSelected: false,
          bowlerSelected: false,
          team1Players: [],
          team2Players: [],
          selectedCardValue: null,
          isProcessingSelection: false,
          currentOverBalls: [],
          team1Name: "",
          team2Name: "",
          format: "5",
          currentPartnership: { runs: 0, balls: 0 },
          partnershipWicket: 0,
          commentaryItems: []
        };

        // Get URL parameters
        const params = new URLSearchParams(window.location.search);
        this.room = params.get('room');
        this.player = params.get('player') || 'player1';
        this.opponent = this.player === "player1" ? "player2" : "player1";
        this.isSpectator = this.player === "spectator";

        // Initialize
        this.init();
      }

      async init() {
        try {
          console.log("Starting game initialization...");
          this.elements.result.innerText = "Initializing game...";

          if (!this.room) {
            throw new Error("Missing room parameter in URL");
          }

          // Set up Firebase
          console.log("Initializing Firebase...");
          await this.setupFirebase();
          console.log("Firebase initialized");

          // Set up game components
          this.setupCardButtons();
          this.updateAllDisplays();

          // Load game data from Firebase
          await this.loadGameData();

        } catch (error) {
          console.error("Initialization failed:", error);
          this.elements.result.innerHTML = `Initialization failed: ${error.message}<br>
                         <button onclick="initGame()" style="margin-top:10px; padding: 8px 15px; background: #1e88e5; color: white; border: none; border-radius: 5px; cursor: pointer;">
                           Retry Initialization
                         </button>`;
        }
      }

      async setupFirebase() {
        // Set up Firebase references
        this.roomRef = ref(db, `rooms/${this.room}`);
        this.gameRef = ref(db, `rooms/${this.room}/game`);
        this.playerRef = ref(db, `rooms/${this.room}/${this.player}`);
        this.opponentRef = ref(db, `rooms/${this.room}/${this.opponent}`);
        
        // Set player online status
        if (!this.isSpectator) {
          await set(this.playerRef, {
            online: true,
            card: null
          });
        }

        // Listen for opponent connection
        onValue(this.opponentRef, (snap) => {
          if (snap.exists() && snap.val().online) {
            this.elements.connectionStatus.textContent = "Opponent: Online";
            this.elements.connectionStatus.className = "online";
          } else {
            this.elements.connectionStatus.textContent = "Opponent: Offline";
            this.elements.connectionStatus.className = "offline";
          }
        });

        // Listen for game state changes
        onValue(this.gameRef, (snap) => {
          if (snap.exists()) {
            const gameData = snap.val();
            this.updateGameState(gameData);
          }
        });
      }

      async loadGameData() {
        // Get room data
        const roomSnap = await get(this.roomRef);
        if (!roomSnap.exists()) {
          throw new Error("Room not found");
        }

        const roomData = roomSnap.val();
        
        // Set team names
        this.state.team1Name = roomData.player1?.team || "Team A";
        this.state.team2Name = roomData.player2?.team || "Team B";
        
        this.elements.team1Name.textContent = this.state.team1Name;
        this.elements.team2Name.textContent = this.state.team2Name;
        
        // Set format
        this.state.format = roomData.format || "5";
        this.state.currentFormat = FORMAT_RULES[this.state.format];
        this.elements.formatDisplay.textContent = this.state.currentFormat.name;
        
        // Set toss data
        if (roomData.toss) {
          this.state.tossWinner = roomData.toss.winner;
          this.state.battingFirst = roomData.toss.battingFirst;
          this.state.isBatting = (this.player === this.state.battingFirst);
          
          this.elements.roleText.textContent = this.state.isBatting ? "You are Batting" : "You are Bowling";
          this.elements.battingTeamName.textContent = this.state.battingFirst === "player1" ? 
            this.state.team1Name : this.state.team2Name;
        }
        
        // Set teams
        if (roomData.teams) {
          this.state.team1Players = roomData.teams.player1?.players || [];
          this.state.team2Players = roomData.teams.player2?.players || [];
        }
        
        // Load game state if it exists
        if (roomData.game) {
          this.updateGameState(roomData.game);
        } else {
          // Initialize new game
          await this.initializeNewGame();
        }
        
        this.elements.result.innerText = "Game ready! Select your players to begin.";
        this.updateButtonStates();
      }

      async initializeNewGame() {
        // Set initial game state
        const initialGameState = {
          runs: 0,
          wickets: 0,
          legalBalls: 0,
          freeHit: false,
          currentBatter: null,
          currentBowler: null,
          currentOverBalls: [],
          batterStats: {},
          bowlerStats: {},
          fallOfWickets: [],
          commentary: ["Match started!"],
          status: "player_selection"
        };
        
        await update(this.gameRef, initialGameState);
        
        // Add initial commentary
        this.addCommentary("Match started! " + 
          (this.state.battingFirst === "player1" ? this.state.team1Name : this.state.team2Name) + 
          " won the toss and elected to bat first.");
      }

      updateGameState(gameData) {
        // Update local state from Firebase
        this.state.runs = gameData.runs || 0;
        this.state.wickets = gameData.wickets || 0;
        this.state.legalBalls = gameData.legalBalls || 0;
        this.state.freeHit = gameData.freeHit || false;
        this.state.currentBatter = gameData.currentBatter;
        this.state.currentBowler = gameData.currentBowler;
        this.state.currentOverBalls = gameData.currentOverBalls || [];
        this.state.batterStats = gameData.batterStats || {};
        this.state.bowlerStats = gameData.bowlerStats || {};
        this.state.fallOfWickets = gameData.fallOfWickets || [];
        this.state.commentaryItems = gameData.commentary || [];
        
        // Update UI
        this.updateAllDisplays();
        this.updateOverProgress();
        this.updateCommentary();
        this.updateStats();
        
        // Handle game status
        if (gameData.status === "player_selection") {
          this.handlePlayerSelection();
        } else if (gameData.status === "in_progress") {
          this.handleGameInProgress();
        } else if (gameData.status === "innings_end") {
          this.handleInningsEnd();
        }
      }

      handlePlayerSelection() {
        if (this.isSpectator) return;
        
        if (this.state.isBatting && !this.state.currentBatter) {
          this.showPlayerSelection("batter");
        } else if (!this.state.isBatting && !this.state.currentBowler) {
          this.showPlayerSelection("bowler");
        }
      }

      handleGameInProgress() {
        this.updateButtonStates();
        
        if (this.isSpectator) {
          this.disableButtons();
          return;
        }
        
        // Check if we need to select a new batter (after wicket)
        if (this.state.isBatting && !this.state.currentBatter) {
          this.showPlayerSelection("batter");
        }
        
        // Check if we need to select a new bowler (after over)
        if (!this.state.isBatting && !this.state.currentBowler) {
          this.showPlayerSelection("bowler");
        }
      }

      handleInningsEnd() {
        this.disableButtons();
        this.showInningsSummary();
      }

      showPlayerSelection(type) {
        this.elements.modalTitle.textContent = `Select ${type === "batter" ? "Batter" : "Bowler"}`;
        this.elements.playerList.innerHTML = "";
        
        const players = type === "batter" ? this.state.team1Players : this.state.team2Players;
        
        players.forEach(player => {
          // Don't show players who are already out (for batters)
          if (type === "batter" && this.state.fallOfWickets.some(w => w.batter === player)) {
            return;
          }
          
          const li = document.createElement("li");
          li.textContent = player;
          li.dataset.player = player;
          li.addEventListener("click", () => {
            // Remove previous selection
            document.querySelectorAll("#playerList li.selected").forEach(item => {
              item.classList.remove("selected");
            });
            // Add selection to clicked item
            li.classList.add("selected");
          });
          this.elements.playerList.appendChild(li);
        });
        
        this.elements.confirmSelection.onclick = () => {
          const selectedPlayer = document.querySelector("#playerList li.selected");
          if (!selectedPlayer) {
            alert(`Please select a ${type}`);
            return;
          }
          
          this.confirmPlayerSelection(type, selectedPlayer.dataset.player);
        };
        
        this.elements.playerSelectionModal.style.display = "flex";
      }

      async confirmPlayerSelection(type, player) {
        this.elements.playerSelectionModal.style.display = "none";
        
        if (type === "batter") {
          await update(this.gameRef, {
            currentBatter: player,
            status: "in_progress"
          });
          
          // Initialize batter stats if not exists
          if (!this.state.batterStats[player]) {
            await update(ref(db, `rooms/${this.room}/game/batterStats/${player}`), {
              runs: 0,
              balls: 0,
              fours: 0,
              sixes: 0
            });
          }
          
          this.addCommentary(`${player} comes to the crease.`);
          
        } else if (type === "bowler") {
          await update(this.gameRef, {
            currentBowler: player,
            status: "in_progress"
          });
          
          // Initialize bowler stats if not exists
          if (!this.state.bowlerStats[player]) {
            await update(ref(db, `rooms/${this.room}/game/bowlerStats/${player}`), {
              runs: 0,
              wickets: 0,
              balls: 0,
              maidens: 0
            });
          }
          
          this.addCommentary(`${player} comes on to bowl.`);
        }
        
        this.updateButtonStates();
      }

      updateScoreboard() {
        this.elements.runs.textContent = this.state.runs;
        this.elements.wickets.textContent = Math.floor(this.state.wickets);
        
        const completedOvers = Math.floor(this.state.legalBalls / 6);
        const ballsInOver = this.state.legalBalls % 6;
        this.elements.overs.textContent = `${completedOvers}.${ballsInOver}`;
        
        const totalBalls = this.state.legalBalls;
        const totalOvers = totalBalls / 6;
        const rr = totalOvers > 0 ? (this.state.runs / totalOvers).toFixed(2) : '0.00';
        this.elements.runRate.textContent = rr;
        
        // Update current batter display
        if (this.state.currentBatter) {
          this.elements.currentBatter.textContent = `Batter: ${this.state.currentBatter}`;
        }
        
        // Check if we're in powerplay
        const currentOver = Math.floor(this.state.legalBalls / 6);
        this.checkPowerplayStatus(currentOver);
      }

      checkPowerplayStatus(currentOver) {
        const format = this.state.currentFormat;
        let isPowerplay = false;
        
        if (Array.isArray(format.powerplayOvers)) {
          // ODI format with multiple powerplay segments
          for (let i = 0; i < format.powerplayOvers.length; i += 2) {
            const start = format.powerplayOvers[i];
            const end = format.powerplayOvers[i + 1];
            if (currentOver >= start - 1 && currentOver < end) {
              isPowerplay = true;
              break;
            }
          }
        } else {
          // Standard format with single powerplay segment
          isPowerplay = currentOver < format.powerplayOvers;
        }
        
        this.state.isPowerplay = isPowerplay;
        
        if (isPowerplay) {
          this.elements.powerplayIndicator.style.display = "inline-block";
        } else {
          this.elements.powerplayIndicator.style.display = "none";
        }
        
        // Check for dead overs (ODI only)
        this.state.isDeadOver = false;
        if (this.state.format === "50") {
          for (let i = 0; i < format.deadOvers.length; i += 2) {
            const start = format.deadOvers[i];
            const end = format.deadOvers[i + 1];
            if (currentOver >= start - 1 && currentOver < end) {
              this.state.isDeadOver = true;
              break;
            }
          }
        }
      }

      updateCurrentTime() {
        const now = new Date();
        this.elements.currentTime.textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        this.elements.matchDate.textContent = now.toLocaleDateString([], { day: 'numeric', month: 'short', year: 'numeric' });
      }

      updateOverProgress() {
        this.elements.overProgress.innerHTML = "";
        
        for (let i = 0; i < 6; i++) {
          const ball = document.createElement("div");
          ball.className = "ball";
          
          if (i < this.state.currentOverBalls.length) {
            const ballData = this.state.currentOverBalls[i];
            ball.textContent = ballData.runs;
            
            if (ballData.runs === 0) {
              ball.className += " dot";
            } else if (ballData.runs === 4) {
              ball.className += " boundary";
            } else if (ballData.runs === 6) {
              ball.className += " six";
            }
            
            if (ballData.wicket) {
              ball.className += " wicket";
            }
            
            if (ballData.freeHit) {
              ball.className += " free-hit";
            }
          }
          
          this.elements.overProgress.appendChild(ball);
        }
      }

      updateCommentary() {
        this.elements.commentary.innerHTML = "";
        
        this.state.commentaryItems.slice().reverse().forEach(item => {
          const div = document.createElement("div");
          div.className = "commentary-item";
          div.textContent = item;
          this.elements.commentary.appendChild(div);
        });
      }

      addCommentary(text) {
        const newCommentary = [...this.state.commentaryItems, text];
        if (newCommentary.length > 20) {
          newCommentary.shift(); // Keep only last 20 commentary items
        }
        
        update(this.gameRef, {
          commentary: newCommentary
        });
      }

      updateStats() {
        // Update batting stats
        const battingStatsBody = this.elements.battingStats.querySelector("tbody");
        battingStatsBody.innerHTML = "";
        
        Object.entries(this.state.batterStats).forEach(([player, stats]) => {
          const row = document.createElement("tr");
          const strikeRate = stats.balls > 0 ? ((stats.runs / stats.balls) * 100).toFixed(2) : "0.00";
          
          row.innerHTML = `
            <td>${player}</td>
            <td>${stats.runs}</td>
            <td>${stats.balls}</td>
            <td>${stats.fours || 0}</td>
            <td>${stats.sixes || 0}</td>
            <td>${strikeRate}</td>
          `;
          
          battingStatsBody.appendChild(row);
        });
        
        // Update bowling stats
        const bowlingStatsBody = this.elements.bowlingStats.querySelector("tbody");
        bowlingStatsBody.innerHTML = "";
        
        Object.entries(this.state.bowlerStats).forEach(([player, stats]) => {
          const row = document.createElement("tr");
          const overs = Math.floor(stats.balls / 6) + "." + (stats.balls % 6);
          const economy = stats.balls > 0 ? ((stats.runs / stats.balls) * 6).toFixed(2) : "0.00";
          
          row.innerHTML = `
            <td>${player}</td>
            <td>${overs}</td>
            <td>${stats.runs}</td>
            <td>${stats.wickets || 0}</td>
            <td>${economy}</td>
          `;
          
          bowlingStatsBody.appendChild(row);
        });
      }

      updateAllDisplays() {
        this.updateScoreboard();
        this.updateCurrentTime();
      }

      updateButtonStates() {
        if (this.isSpectator) {
          this.disableButtons();
          return;
        }
        
        const canPlay = this.state.status === "in_progress" && 
          ((this.state.isBatting && this.state.currentBatter) || 
           (!this.state.isBatting && this.state.currentBowler));
        
        this.elements.buttons.forEach(btn => {
          btn.disabled = !canPlay;
        });
        
        if (canPlay) {
          this.elements.result.innerText = this.state.isBatting ? "Select your shot" : "Select your delivery";
        }
      }

      disableButtons() {
        this.elements.buttons.forEach(btn => {
          btn.disabled = true;
        });
      }

      enableButtons() {
        this.updateButtonStates();
      }

      clearCardSelection() {
        this.elements.buttons.forEach(btn => {
          btn.classList.remove("selected");
        });
        this.state.selectedCardValue = null;
        this.state.isProcessingSelection = false;
      }

      highlightSelectedCard(value) {
        this.elements.buttons.forEach(btn => {
          const val = parseInt(btn.dataset.value);
          btn.classList.toggle("selected", val === value);
        });
      }

      setupCardButtons() {
        this.elements.buttons.forEach(btn => {
          btn.addEventListener("click", () => {
            if (btn.disabled || this.state.isProcessingSelection) return;
            
            const cardValue = parseInt(btn.dataset.value);
            this.state.selectedCardValue = cardValue;
            this.state.isProcessingSelection = true;

            this.disableButtons();
            this.highlightSelectedCard(cardValue);
            
            this.elements.result.innerText = `${this.state.isBatting ? 'Batting' : 'Bowling'} selection: ${cardValue}`;

            // Send selection to Firebase
            set(ref(db, `rooms/${this.room}/${this.player}/card`), cardValue)
              .then(() => {
                // Wait for opponent's selection
                this.waitForOpponentSelection();
              })
              .catch(error => {
                console.error("Error sending card:", error);
                this.elements.result.innerText = "Error sending selection. Please try again.";
                this.enableButtons();
                this.clearCardSelection();
              });
          });
        });
      }

      waitForOpponentSelection() {
        const opponentCardRef = ref(db, `rooms/${this.room}/${this.opponent}/card`);
        
        const unsubscribe = onValue(opponentCardRef, (snap) => {
          if (snap.exists() && snap.val() !== null) {
            unsubscribe(); // Stop listening
            const opponentCard = snap.val();
            
            // Process the ball
            if (this.state.isBatting) {
              this.processBallResult(this.state.selectedCardValue, opponentCard);
            } else {
              this.processBallResult(opponentCard, this.state.selectedCardValue);
            }
          }
        });
        
        // Timeout after 30 seconds
        setTimeout(() => {
          unsubscribe();
          this.elements.result.innerText = "Opponent didn't respond in time.";
          this.enableButtons();
          this.clearCardSelection();
        }, 30000);
      }

      async processBallResult(batterCard, bowlerCard) {
        let outcome = "";
        let isLegalBall = false;
        let isWicket = false;
        let runsScored = 0;
        let isFour = false;
        let isSix = false;
        
        // 1. Check for no ball (both 0)
        if (batterCard === 0 && bowlerCard === 0) {
          outcome = "NO BALL! +1 run (Free Hit next ball)";
          runsScored = 1;
          this.state.runs += runsScored;
          this.state.freeHitNextBall = true;
          isLegalBall = false;
        } 
        // 2. Handle free hit balls
        else if (this.state.freeHit) {
          if (batterCard === bowlerCard && batterCard > 0) {
            outcome = "Wicket on Free Hit (not out)";
            isWicket = false;
          } else {
            runsScored = batterCard;
            this.state.runs += runsScored;
            outcome = `${batterCard} Run(s)! (Free Hit)`;
            if (batterCard === 4) isFour = true;
            if (batterCard === 6) isSix = true;
          }
          this.state.freeHit = false;
          isLegalBall = true;
        }
        // 3. Handle wickets (same number > 0)
        else if (batterCard === bowlerCard && batterCard > 0) {
          const wicketValue = this.state.isPowerplay ? 
            this.state.currentFormat.powerplayWicketValue : 
            this.state.currentFormat.regularWicketValue;
            
          this.state.wickets += wicketValue;
          isWicket = true;
          outcome = `WICKET! (${wicketValue} wicket${wicketValue !== 1 ? 's' : ''})`;
          isLegalBall = true;
        }
        // 4. Normal runs
        else {
          runsScored = batterCard;
          this.state.runs += runsScored;
          outcome = `${batterCard} Run(s)!`;
          isLegalBall = true;
          if (batterCard === 4) isFour = true;
          if (batterCard === 6) isSix = true;
        }

        // Update batter and bowler stats
        await this.updatePlayerStats(runsScored, isWicket, isFour, isSix);

        // Record ball in current over
        const ballData = {
          runs: runsScored,
          wicket: isWicket,
          freeHit: this.state.freeHit,
          batter: this.state.currentBatter,
          bowler: this.state.currentBowler,
          timestamp: Date.now()
        };
        
        const newOverBalls = [...this.state.currentOverBalls, ballData];
        
        // Record ball in ball-by-ball
        const newBallByBall = {...this.state.ballByBall};
        newBallByBall[this.state.legalBalls] = ballData;

        if (isWicket) {
          this.state.lastWicketScore = this.state.runs;
          
          // Add to fall of wickets
          const newFallOfWickets = [...this.state.fallOfWickets, {
            batter: this.state.currentBatter,
            score: this.state.runs,
            partnership: this.state.currentPartnership.runs,
            overs: this.state.legalBalls / 6
          }];
          
          await update(this.gameRef, {
            fallOfWickets: newFallOfWickets
          });
          
          // Reset partnership
          this.state.currentPartnership = { runs: 0, balls: 0 };
          this.state.partnershipWicket = this.state.wickets;
        } else if (isLegalBall) {
          // Update partnership
          this.state.currentPartnership.runs += runsScored;
          this.state.currentPartnership.balls += 1;
        }

        if (isLegalBall) {
          this.state.legalBalls++;
        }

        // Check if over is completed (6 legal balls)
        let isOverCompleted = false;
        if (isLegalBall && newOverBalls.length >= 6) {
          isOverCompleted = true;
          newOverBalls = []; // Reset for new over
          
          // Reset free hit for new over
          this.state.freeHitNextBall = false;
        }
        
        // Set free hit for next ball if applicable
        if (this.state.freeHitNextBall) {
          this.state.freeHit = true;
          this.state.freeHitNextBall = false;
        }

        // Update game state in Firebase
        const updates = {
          runs: this.state.runs,
          wickets: this.state.wickets,
          legalBalls: this.state.legalBalls,
          freeHit: this.state.freeHit,
          currentOverBalls: newOverBalls,
          ballByBall: newBallByBall
        };
        
        // Check if innings is completed
        const isInningsCompleted = this.checkInningsCompletion();
        if (isInningsCompleted) {
          updates.status = "innings_end";
        } else if (isWicket) {
          // If wicket fell, clear current batter
          updates.currentBatter = null;
          updates.status = "player_selection";
        } else if (isOverCompleted) {
          // If over completed, clear current bowler
          updates.currentBowler = null;
          updates.status = "player_selection";
        }
        
        await update(this.gameRef, updates);
        
        // Add commentary
        this.addCommentary(`${this.state.currentBatter} ${outcome} - ${this.state.runs}/${Math.floor(this.state.wickets)}`);
        
        this.updateAllDisplays();
        
        this.elements.result.innerText = outcome;
        
        // Reset for next ball
        setTimeout(() => {
          // Clear card selections
          set(ref(db, `rooms/${this.room}/${this.player}/card`), null);
          set(ref(db, `rooms/${this.room}/${this.opponent}/card`), null);
          
          this.enableButtons();
          this.clearCardSelection();
          
          if (!isInningsCompleted && !isWicket && !isOverCompleted) {
            this.elements.result.innerText = "Next ball...";
          }
        }, 2000);
      }

      async updatePlayerStats(runs, isWicket, isFour, isSix) {
        // Update batter stats
        if (this.state.currentBatter) {
          const batterStats = {...this.state.batterStats[this.state.currentBatter]};
          batterStats.runs = (batterStats.runs || 0) + runs;
          batterStats.balls = (batterStats.balls || 0) + 1;
          if (isFour) batterStats.fours = (batterStats.fours || 0) + 1;
          if (isSix) batterStats.sixes = (batterStats.sixes || 0) + 1;
          
          await update(ref(db, `rooms/${this.room}/game/batterStats/${this.state.currentBatter}`), batterStats);
        }
        
        // Update bowler stats
        if (this.state.currentBowler) {
          const bowlerStats = {...this.state.bowlerStats[this.state.currentBowler]};
          bowlerStats.runs = (bowlerStats.runs || 0) + runs;
          bowlerStats.balls = (bowlerStats.balls || 0) + 1;
          if (isWicket) bowlerStats.wickets = (bowlerStats.wickets || 0) + 1;
          
          await update(ref(db, `rooms/${this.room}/game/bowlerStats/${this.state.currentBowler}`), bowlerStats);
        }
      }

      checkInningsCompletion() {
        const completedOvers = Math.floor(this.state.legalBalls / 6);
        const isOversCompleted = completedOvers >= this.state.currentFormat.totalOvers;
        const isWicketsCompleted = Math.floor(this.state.wickets) >= this.state.currentFormat.totalWickets;
        
        return isOversCompleted || isWicketsCompleted;
      }

      showInningsSummary() {
        this.elements.inningsSummary.innerHTML = `
          <h3>Innings Summary</h3>
          <p>Total: ${this.state.runs}/${Math.floor(this.state.wickets)}</p>
          <p>Overs: ${Math.floor(this.state.legalBalls / 6)}.${this.state.legalBalls % 6}</p>
          <p>Run Rate: ${(this.state.runs / (this.state.legalBalls / 6)).toFixed(2)}</p>
        `;
        
        this.elements.endInningsModal.style.display = "flex";
        
        this.elements.startSecondInnings.onclick = () => {
          // Set target and switch to second innings
          update(this.roomRef, {
            target: this.state.runs + 1,
            game: null // Reset game for second innings
          }).then(() => {
            window.location.href = `game_second_innings.html?room=${this.room}&player=${this.player}`;
          });
        };
      }
    }

    // Initialize the game when page loads
    document.addEventListener('DOMContentLoaded', () => {
      const game = new CricketGame();
      
      // Set up a timer to update time every minute
      setInterval(() => game.updateCurrentTime(), 60000);
    });
  </script>
</body>
</html>