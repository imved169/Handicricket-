<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HandiCricket - First Innings</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #1e88e5;
      --primary-dark: #1565c0;
      --secondary: #ffeb3b;
      --secondary-dark: #fbc02d;
      --danger: #f44336;
      --danger-dark: #d32f2f;
      --success: #4CAF50;
      --success-dark: #2E7D32;
      --warning: #FF9800;
      --warning-dark: #F57C00;
      --info: #2196F3;
      --info-dark: #1565C0;
      --dark: #061e3e;
      --darker: #0a2a4a;
      --light: #f5f5f5;
      --lighter: #ffffff;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: linear-gradient(135deg, var(--dark), var(--darker));
      color: white;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
    }

    .container {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 15px;
      display: flex;
      flex-direction: column;
      flex: 1;
    }

    /* Header Section */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 15px;
    }

    .match-info {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .match-title {
      font-size: 1.5rem;
      color: var(--secondary);
      text-shadow: 0 0 5px rgba(255, 235, 59, 0.3);
    }

    .match-format {
      font-size: 0.9rem;
      color: #aaa;
    }

    .room-code {
      background: rgba(30, 136, 229, 0.2);
      padding: 5px 10px;
      border-radius: 20px;
      font-weight: bold;
      color: var(--secondary);
    }

    /* Scoreboard Section */
    .scoreboard {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 15px;
    }

    .team-score {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.1);
      position: relative;
    }

    .team-score.batting {
      border-left: 4px solid var(--success);
    }

    .team-score.bowling {
      border-left: 4px solid var(--danger);
    }

    .team-name {
      font-size: 1.2rem;
      font-weight: bold;
      margin-bottom: 5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .team-name .role-badge {
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 10px;
      background: var(--success);
      color: black;
    }

    .team-name .bowling-badge {
      background: var(--danger);
    }

    .score-display {
      font-size: 1.8rem;
      font-weight: bold;
      margin: 5px 0;
    }

    .score-details {
      display: flex;
      justify-content: space-between;
      font-size: 0.9rem;
      color: #aaa;
    }

    .run-rate {
      color: var(--secondary);
    }

    .target-display {
      grid-column: span 2;
      background: rgba(255, 235, 59, 0.1);
      border-radius: 8px;
      padding: 10px;
      text-align: center;
      font-size: 1.1rem;
      border: 1px solid var(--secondary);
      margin-top: -10px;
    }

    .target-display span {
      color: var(--secondary);
      font-weight: bold;
    }

    /* Match Progress */
    .match-progress {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 15px 0;
      padding: 10px;
      background: rgba(13, 42, 82, 0.5);
      border-radius: 8px;
    }

    .progress-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
    }

    .progress-label {
      font-size: 0.8rem;
      color: #aaa;
      margin-bottom: 5px;
    }

    .progress-value {
      font-size: 1.1rem;
      font-weight: bold;
    }

    .progress-value.highlight {
      color: var(--secondary);
    }

    /* Current Players */
    .current-players {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 15px;
    }

    .player-card {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .player-card.batter {
      border-left: 4px solid var(--info);
    }

    .player-card.bowler {
      border-left: 4px solid var(--warning);
    }

    .player-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .player-name {
      font-weight: bold;
      font-size: 1.1rem;
    }

    .player-role {
      font-size: 0.8rem;
      padding: 2px 8px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.2);
    }

    .player-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }

    .stat-item {
      display: flex;
      flex-direction: column;
    }

    .stat-label {
      font-size: 0.7rem;
      color: #aaa;
    }

    .stat-value {
      font-size: 1rem;
      font-weight: bold;
    }

    /* Wicket Meter */
    .wicket-meter {
      margin-top: 10px;
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
      overflow: hidden;
    }

    .wicket-progress {
      height: 100%;
      background: var(--danger);
      width: 0%;
      transition: width 0.3s;
    }

    /* Game Controls */
    .game-controls {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-top: 20px;
      margin-bottom: 20px;
    }

    .cards-container {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 10px;
      margin-bottom: 10px;
    }

    .card-btn {
      aspect-ratio: 1/1;
      border: none;
      border-radius: 10px;
      background: rgba(30, 136, 229, 0.2);
      color: white;
      font-size: 1.5rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    }

    .card-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 10px rgba(0, 0, 0, 0.3);
    }

    .card-btn:active {
      transform: translateY(1px);
    }

    .card-btn.zero {
      background: rgba(255, 255, 255, 0.2);
    }

    .card-btn.one {
      background: rgba(76, 175, 80, 0.3);
    }

    .card-btn.two {
      background: rgba(33, 150, 243, 0.3);
    }

    .card-btn.three {
      background: rgba(156, 39, 176, 0.3);
    }

    .card-btn.four {
      background: rgba(255, 152, 0, 0.3);
    }

    .card-btn.five {
      background: rgba(244, 67, 54, 0.3);
    }

    .card-btn.six {
      background: rgba(255, 235, 59, 0.3);
      color: black;
    }

    .card-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    .powerplay-indicator {
      text-align: center;
      padding: 5px;
      background: rgba(255, 235, 59, 0.2);
      border-radius: 5px;
      margin-bottom: 10px;
      border: 1px solid var(--secondary);
      color: var(--secondary);
      font-weight: bold;
      display: none;
    }

    .dead-over-indicator {
      text-align: center;
      padding: 5px;
      background: rgba(244, 67, 54, 0.2);
      border-radius: 5px;
      margin-bottom: 10px;
      border: 1px solid var(--danger);
      color: var(--danger);
      font-weight: bold;
      display: none;
    }

    .free-hit-indicator {
      text-align: center;
      padding: 5px;
      background: rgba(76, 175, 80, 0.2);
      border-radius: 5px;
      margin-bottom: 10px;
      border: 1px solid var(--success);
      color: var(--success);
      font-weight: bold;
      display: none;
    }

    /* Ball Timeline */
    .ball-timeline {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
      max-height: 200px;
      overflow-y: auto;
    }

    .timeline-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      padding-bottom: 5px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .timeline-title {
      font-weight: bold;
    }

    .timeline-clear {
      color: #aaa;
      cursor: pointer;
      font-size: 0.8rem;
    }

    .timeline-clear:hover {
      color: white;
    }

    .timeline-items {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .timeline-item {
      display: flex;
      justify-content: space-between;
      font-size: 0.9rem;
      padding: 3px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .timeline-over {
      color: #aaa;
      min-width: 40px;
    }

    .timeline-event {
      flex: 1;
    }

    .timeline-runs {
      font-weight: bold;
      min-width: 30px;
      text-align: right;
    }

    .timeline-event.wicket {
      color: var(--danger);
    }

    .timeline-event.four {
      color: var(--warning);
    }

    .timeline-event.six {
      color: var(--secondary);
    }

    .timeline-event.noball, .timeline-event.wide {
      color: var(--success);
    }

    /* Modals */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }

    .modal.active {
      opacity: 1;
      pointer-events: all;
    }

    .modal-content {
      background: linear-gradient(145deg, var(--dark), var(--darker));
      border-radius: 10px;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.1);
      position: relative;
    }

    .modal-close {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      color: #aaa;
      font-size: 1.5rem;
      cursor: pointer;
    }

    .modal-close:hover {
      color: white;
    }

    .modal-title {
      color: var(--secondary);
      margin-bottom: 15px;
      text-align: center;
    }

    /* Teams Modal */
    .teams-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .team-modal {
      background: rgba(13, 42, 82, 0.5);
      border-radius: 8px;
      padding: 15px;
    }

    .team-modal-title {
      font-weight: bold;
      margin-bottom: 10px;
      text-align: center;
      color: var(--secondary);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding-bottom: 5px;
    }

    .team-players {
      list-style: none;
    }

    .team-player {
      padding: 8px 5px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      display: flex;
      justify-content: space-between;
    }

    .team-player:last-child {
      border-bottom: none;
    }

    .player-captain {
      color: gold;
      font-size: 0.7rem;
      margin-left: 5px;
    }

    .player-vice {
      color: silver;
      font-size: 0.7rem;
      margin-left: 5px;
    }

    /* Stats Modal */
    .stats-tabs {
      display: flex;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 15px;
    }

    .stats-tab {
      padding: 8px 15px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
    }

    .stats-tab.active {
      border-bottom: 3px solid var(--primary);
      font-weight: bold;
    }

    .stats-content {
      display: none;
    }

    .stats-content.active {
      display: block;
    }

    .stats-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    .stats-table th {
      background: rgba(30, 136, 229, 0.5);
      padding: 8px;
      text-align: left;
    }

    .stats-table td {
      padding: 8px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .stats-table tr:nth-child(even) {
      background: rgba(30, 136, 229, 0.1);
    }

    .stats-table .highlight {
      background: rgba(255, 235, 59, 0.2);
    }

    /* Innings Summary Modal */
    .summary-section {
      margin-bottom: 20px;
      background: rgba(13, 42, 82, 0.5);
      padding: 15px;
      border-radius: 8px;
    }

    .summary-title {
      color: var(--secondary);
      margin-bottom: 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding-bottom: 5px;
    }

    .summary-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .summary-stat {
      display: flex;
      justify-content: space-between;
    }

    .summary-stat-label {
      color: #aaa;
    }

    .summary-stat-value {
      font-weight: bold;
    }

    .awards-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-top: 15px;
    }

    .award-card {
      background: rgba(255, 215, 0, 0.1);
      border: 1px solid gold;
      padding: 15px;
      border-radius: 8px;
    }

    .award-title {
      font-weight: bold;
      color: gold;
      margin-bottom: 5px;
    }

    .award-winner {
      font-size: 1.1rem;
    }

    /* Animations */
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
      20%, 40%, 60%, 80% { transform: translateX(5px); }
    }

    @keyframes ripple {
      0% { transform: scale(0.8); opacity: 1; }
      100% { transform: scale(3); opacity: 0; }
    }

    @keyframes confetti {
      0% { transform: translateY(0) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }

    .bounce {
      animation: bounce 0.5s;
    }

    .shake {
      animation: shake 0.5s;
    }

    .ripple {
      position: relative;
      overflow: hidden;
    }

    .ripple:after {
      content: "";
      display: block;
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      transform: scale(0);
    }

    .ripple.active:after {
      animation: ripple 0.6s ease-out;
    }

    .confetti-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1001;
    }

    .confetti {
      position: absolute;
      width: 10px;
      height: 10px;
      background: var(--secondary);
      opacity: 0;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .scoreboard {
        grid-template-columns: 1fr;
      }

      .target-display {
        grid-column: span 1;
      }

      .current-players {
        grid-template-columns: 1fr;
      }

      .cards-container {
        grid-template-columns: repeat(4, 1fr);
      }

      .teams-container {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 480px) {
      .header {
        flex-direction: column;
        gap: 10px;
        text-align: center;
      }

      .cards-container {
        grid-template-columns: repeat(3, 1fr);
      }

      .player-stats {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header Section -->
    <div class="header">
      <div class="match-info">
        <div class="match-title">HandiCricket Match</div>
        <div class="match-format" id="matchFormat">T20 Match</div>
      </div>
      <div class="room-code" id="roomCodeDisplay">Room: 1234</div>
    </div>

    <!-- Scoreboard Section -->
    <div class="scoreboard">
      <div class="team-score" id="battingTeamScore">
        <div class="team-name">
          <span id="battingTeamName">Team A</span>
          <span class="role-badge">Batting</span>
        </div>
        <div class="score-display" id="battingScore">0/0</div>
        <div class="score-details">
          <span id="battingOvers">Overs: 0.0</span>
          <span class="run-rate" id="battingRunRate">RR: 0.00</span>
        </div>
      </div>

      <div class="team-score" id="bowlingTeamScore">
        <div class="team-name">
          <span id="bowlingTeamName">Team B</span>
          <span class="role-badge bowling-badge">Bowling</span>
        </div>
        <div class="score-display" id="bowlingScore">0/0</div>
        <div class="score-details">
          <span id="bowlingOvers">Overs: 0.0</span>
          <span class="run-rate" id="bowlingRunRate">ER: 0.00</span>
        </div>
      </div>

      <div class="target-display" id="targetDisplay" style="display: none;">
        Target: <span id="targetRuns">0</span> runs in <span id="targetOvers">0.0</span> overs | RR: <span id="requiredRate">0.00</span>
      </div>
    </div>

    <!-- Match Progress -->
    <div class="match-progress">
      <div class="progress-item">
        <div class="progress-label">Innings</div>
        <div class="progress-value" id="inningsNumber">1st</div>
      </div>
      <div class="progress-item">
        <div class="progress-label">Day</div>
        <div class="progress-value" id="matchDay">1/5</div>
      </div>
      <div class="progress-item">
        <div class="progress-label">Partnership</div>
        <div class="progress-value" id="partnershipRuns">0</div>
      </div>
      <div class="progress-item">
        <div class="progress-label">Last Wkt</div>
        <div class="progress-value" id="lastWicket">0</div>
      </div>
    </div>

    <!-- Powerplay Indicators -->
    <div class="powerplay-indicator" id="powerplayIndicator">Powerplay: Overs 1-6</div>
    <div class="dead-over-indicator" id="deadOverIndicator">Dead Over - Special Rules Apply</div>
    <div class="free-hit-indicator" id="freeHitIndicator">FREE HIT</div>

    <!-- Current Players -->
    <div class="current-players">
      <div class="player-card batter">
        <div class="player-header">
          <div class="player-name" id="strikerName">Batter 1</div>
          <div class="player-role">Striker</div>
        </div>
        <div class="player-stats">
          <div class="stat-item">
            <div class="stat-label">Runs</div>
            <div class="stat-value" id="strikerRuns">0</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Balls</div>
            <div class="stat-value" id="strikerBalls">0</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">SR</div>
            <div class="stat-value" id="strikerSR">0.00</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">4s/6s</div>
            <div class="stat-value" id="strikerBoundaries">0/0</div>
          </div>
        </div>
        <div class="wicket-meter">
          <div class="wicket-progress" id="strikerWicketMeter" style="width: 0%"></div>
        </div>
      </div>

      <div class="player-card bowler">
        <div class="player-header">
          <div class="player-name" id="bowlerName">Bowler 1</div>
          <div class="player-role">Bowler</div>
        </div>
        <div class="player-stats">
          <div class="stat-item">
            <div class="stat-label">Overs</div>
            <div class="stat-value" id="bowlerOvers">0</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Wkts</div>
            <div class="stat-value" id="bowlerWickets">0</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Runs</div>
            <div class="stat-value" id="bowlerRuns">0</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">ER</div>
            <div class="stat-value" id="bowlerEconomy">0.00</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Game Controls -->
    <div class="game-controls">
      <div class="cards-container">
        <button class="card-btn zero" id="card0">0</button>
        <button class="card-btn one" id="card1">1</button>
        <button class="card-btn two" id="card2">2</button>
        <button class="card-btn three" id="card3">3</button>
        <button class="card-btn four" id="card4">4</button>
        <button class="card-btn five" id="card5">5</button>
        <button class="card-btn six" id="card6">6</button>
      </div>
    </div>

    <!-- Ball Timeline -->
    <div class="ball-timeline">
      <div class="timeline-header">
        <div class="timeline-title">Ball-by-Ball Commentary</div>
        <div class="timeline-clear" id="clearTimeline">Clear</div>
      </div>
      <div class="timeline-items" id="timelineItems"></div>
    </div>
  </div>

  <!-- Modals -->
  <div class="modal" id="teamsModal">
    <div class="modal-content">
      <button class="modal-close" id="closeTeamsModal">&times;</button>
      <h2 class="modal-title">Teams</h2>
      <div class="teams-container" id="teamsContainer">
        <!-- Filled by JavaScript -->
      </div>
    </div>
  </div>

  <div class="modal" id="statsModal">
    <div class="modal-content">
      <button class="modal-close" id="closeStatsModal">&times;</button>
      <h2 class="modal-title">Match Statistics</h2>
      <div class="stats-tabs">
        <div class="stats-tab active" data-tab="batting">Batting</div>
        <div class="stats-tab" data-tab="bowling">Bowling</div>
        <div class="stats-tab" data-tab="partnerships">Partnerships</div>
      </div>
      <div class="stats-content active" id="battingStats">
        <!-- Filled by JavaScript -->
      </div>
      <div class="stats-content" id="bowlingStats">
        <!-- Filled by JavaScript -->
      </div>
      <div class="stats-content" id="partnershipStats">
        <!-- Filled by JavaScript -->
      </div>
    </div>
  </div>

  <div class="modal" id="summaryModal">
    <div class="modal-content">
      <button class="modal-close" id="closeSummaryModal">&times;</button>
      <h2 class="modal-title">Innings Summary</h2>
      <div class="summary-section">
        <h3 class="summary-title" id="summaryInningsTitle">1st Innings - Team A</h3>
        <div class="summary-stats" id="inningsSummaryStats">
          <!-- Filled by JavaScript -->
        </div>
      </div>
      <div class="awards-container" id="inningsAwards">
        <!-- Filled by JavaScript -->
      </div>
      <button class="card-btn" id="continueGameBtn" style="margin-top: 15px; width: 100%;">Continue</button>
    </div>
  </div>

  <div class="modal" id="matchResultModal">
    <div class="modal-content">
      <button class="modal-close" id="closeResultModal">&times;</button>
      <h2 class="modal-title">Match Result</h2>
      <div class="summary-section">
        <h3 class="summary-title" id="resultTitle">Team A won by X runs</h3>
        <div class="summary-stats" id="resultStats">
          <!-- Filled by JavaScript -->
        </div>
      </div>
      <div class="awards-container" id="matchAwards">
        <!-- Filled by JavaScript -->
      </div>
      <button class="card-btn" id="saveMatchBtn" style="margin-top: 15px; width: 100%; background: var(--success);">Save Match Data</button>
    </div>
  </div>

  <!-- Confetti Container -->
  <div class="confetti-container" id="confettiContainer"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, get, push } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCN6aZMwlsZe7JJaovU0WA3UQygWr4jYmA",
      authDomain: "handicricket-85a06.firebaseapp.com",
      projectId: "handicricket-85a06",
      storageBucket: "handicricket-85a06.appspot.com",
      messagingSenderId: "599182538558",
      appId: "1:599182538558:web:3e965753ab05f8f1e3de6f",
      measurementId: "G-HSV9H4LEJQ"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Get URL parameters
    const params = new URLSearchParams(window.location.search);
    const roomId = params.get('room');
    const playerRole = params.get('player'); // player1 or player2
    const opponentRole = playerRole === 'player1' ? 'player2' : 'player1';

    if (!roomId || !playerRole) {
      alert('Invalid room or player');
      window.location.href = 'index.html';
    }

    // Firebase references
    const roomRef = ref(db, `rooms/${roomId}`);
    const gameRef = ref(db, `rooms/${roomId}/game`);
    const playerRef = ref(db, `rooms/${roomId}/${playerRole}`);
    const opponentRef = ref(db, `rooms/${roomId}/${opponentRole}`);
    const savedMatchesRef = ref(db, 'savedMatches');

    // Game state variables
    let gameState = {
      format: '20', // Default to T20
      innings: 1,
      day: 1,
      totalDays: 5,
      oversPerDay: 90,
      currentOver: 0,
      currentBall: 0,
      totalBalls: 0,
      isPowerplay: false,
      isDeadOver: false,
      isFreeHit: false,
      isNoBall: false,
      isWide: false,
      target: 0,
      battingTeam: playerRole,
      bowlingTeam: opponentRole,
      striker: null,
      nonStriker: null,
      currentBowler: null,
      team1: { name: '', players: [], captain: '', viceCaptain: '' },
      team2: { name: '', players: [], captain: '', viceCaptain: '' },
      score: { runs: 0, wickets: 0, extras: 0 },
      bowlingScore: { runs: 0, wickets: 0 },
      strikerStats: { runs: 0, balls: 0, fours: 0, sixes: 0, dots: 0, wicketMeter: 0 },
      nonStrikerStats: { runs: 0, balls: 0, fours: 0, sixes: 0, dots: 0, wicketMeter: 0 },
      bowlerStats: { runs: 0, wickets: 0, balls: 0, dots: 0, maidens: 0 },
      partnership: { runs: 0, balls: 0 },
      lastWicket: { runs: 0, partnership: 0 },
      batterStats: {},
      bowlerStatsAll: {},
      timeline: [],
      powerplayOvers: [],
      deadOvers: [],
      matchCompleted: false,
      inningsCompleted: false,
      followOn: false,
      toss: { winner: '', battingFirst: '', battingChoice: '' }
    };

    // DOM elements
    const roomCodeDisplay = document.getElementById('roomCodeDisplay');
    const matchFormat = document.getElementById('matchFormat');
    const battingTeamName = document.getElementById('battingTeamName');
    const bowlingTeamName = document.getElementById('bowlingTeamName');
    const battingScore = document.getElementById('battingScore');
    const bowlingScore = document.getElementById('bowlingScore');
    const battingOvers = document.getElementById('battingOvers');
    const bowlingOvers = document.getElementById('bowlingOvers');
    const battingRunRate = document.getElementById('battingRunRate');
    const bowlingRunRate = document.getElementById('bowlingRunRate');
    const targetDisplay = document.getElementById('targetDisplay');
    const targetRuns = document.getElementById('targetRuns');
    const targetOvers = document.getElementById('targetOvers');
    const requiredRate = document.getElementById('requiredRate');
    const inningsNumber = document.getElementById('inningsNumber');
    const matchDay = document.getElementById('matchDay');
    const partnershipRuns = document.getElementById('partnershipRuns');
    const lastWicket = document.getElementById('lastWicket');
    const powerplayIndicator = document.getElementById('powerplayIndicator');
    const deadOverIndicator = document.getElementById('deadOverIndicator');
    const freeHitIndicator = document.getElementById('freeHitIndicator');
    const strikerName = document.getElementById('strikerName');
    const strikerRuns = document.getElementById('strikerRuns');
    const strikerBalls = document.getElementById('strikerBalls');
    const strikerSR = document.getElementById('strikerSR');
    const strikerBoundaries = document.getElementById('strikerBoundaries');
    const strikerWicketMeter = document.getElementById('strikerWicketMeter');
    const bowlerName = document.getElementById('bowlerName');
    const bowlerOvers = document.getElementById('bowlerOvers');
    const bowlerWickets = document.getElementById('bowlerWickets');
    const bowlerRuns = document.getElementById('bowlerRuns');
    const bowlerEconomy = document.getElementById('bowlerEconomy');
    const cardButtons = [document.getElementById('card0'), document.getElementById('card1'), 
                         document.getElementById('card2'), document.getElementById('card3'), 
                         document.getElementById('card4'), document.getElementById('card5'), 
                         document.getElementById('card6')];
    const timelineItems = document.getElementById('timelineItems');
    const clearTimeline = document.getElementById('clearTimeline');
    const teamsModal = document.getElementById('teamsModal');
    const closeTeamsModal = document.getElementById('closeTeamsModal');
    const teamsContainer = document.getElementById('teamsContainer');
    const statsModal = document.getElementById('statsModal');
    const closeStatsModal = document.getElementById('closeStatsModal');
    const statsTabs = document.querySelectorAll('.stats-tab');
    const statsContents = document.querySelectorAll('.stats-content');
    const battingStats = document.getElementById('battingStats');
    const bowlingStats = document.getElementById('bowlingStats');
    const partnershipStats = document.getElementById('partnershipStats');
    const summaryModal = document.getElementById('summaryModal');
    const closeSummaryModal = document.getElementById('closeSummaryModal');
    const summaryInningsTitle = document.getElementById('summaryInningsTitle');
    const inningsSummaryStats = document.getElementById('inningsSummaryStats');
    const inningsAwards = document.getElementById('inningsAwards');
    const continueGameBtn = document.getElementById('continueGameBtn');
    const matchResultModal = document.getElementById('matchResultModal');
    const closeResultModal = document.getElementById('closeResultModal');
    const resultTitle = document.getElementById('resultTitle');
    const resultStats = document.getElementById('resultStats');
    const matchAwards = document.getElementById('matchAwards');
    const saveMatchBtn = document.getElementById('saveMatchBtn');
    const confettiContainer = document.getElementById('confettiContainer');

    // Initialize the game
    async function initGame() {
      // Set player online status
      await set(playerRef, { connected: true });
      
      // Load room data
      onValue(roomRef, (snapshot) => {
        if (snapshot.exists()) {
          const roomData = snapshot.val();
          
          // Set match format
          gameState.format = roomData.player1?.format || '20';
          matchFormat.textContent = getFormatName(gameState.format);
          
          // Set team names and players
          if (roomData.teams) {
            gameState.team1 = roomData.teams.player1 || { name: 'Team A', players: [] };
            gameState.team2 = roomData.teams.player2 || { name: 'Team B', players: [] };
            
            battingTeamName.textContent = gameState.team1.name;
            bowlingTeamName.textContent = gameState.team2.name;
          }
          
          // Set toss info
          if (roomData.toss) {
            gameState.toss = roomData.toss;
            gameState.battingTeam = roomData.toss.battingFirst;
            gameState.bowlingTeam = roomData.toss.battingFirst === 'player1' ? 'player2' : 'player1';
            
            // Update UI based on batting team
            updateTeamDisplay();
          }
          
          // Load game state if exists
          if (roomData.game) {
            Object.assign(gameState, roomData.game);
            updateUI();
            
            // Check if innings or match is completed
            if (gameState.inningsCompleted) {
              showInningsSummary();
            } else if (gameState.matchCompleted) {
              showMatchResult();
            }
          } else {
            // Initialize new game
            initializeNewGame();
          }
        }
      });
      
      // Handle opponent disconnect
      onValue(opponentRef, (snapshot) => {
        if (!snapshot.exists() || !snapshot.val().connected) {
          alert('Opponent disconnected');
          window.location.href = 'index.html';
        }
      });
      
      // Update room code display
      roomCodeDisplay.textContent = `Room: ${roomId}`;
      
      // Set up event listeners
      setupEventListeners();
    }

    // Initialize a new game
    function initializeNewGame() {
      // Set initial players
      if (gameState.battingTeam === 'player1') {
        gameState.striker = gameState.team1.players[0] || 'Batter 1';
        gameState.nonStriker = gameState.team1.players[1] || 'Batter 2';
        gameState.currentBowler = gameState.team2.players[0] || 'Bowler 1';
        
        // Initialize batter stats
        gameState.team1.players.forEach(player => {
          gameState.batterStats[player] = { runs: 0, balls: 0, fours: 0, sixes: 0, dots: 0, wicketMeter: 0 };
        });
        
        // Initialize bowler stats
        gameState.team2.players.forEach(player => {
          gameState.bowlerStatsAll[player] = { runs: 0, wickets: 0, balls: 0, dots: 0, maidens: 0 };
        });
      } else {
        gameState.striker = gameState.team2.players[0] || 'Batter 1';
        gameState.nonStriker = gameState.team2.players[1] || 'Batter 2';
        gameState.currentBowler = gameState.team1.players[0] || 'Bowler 1';
        
        // Initialize batter stats
        gameState.team2.players.forEach(player => {
          gameState.batterStats[player] = { runs: 0, balls: 0, fours: 0, sixes: 0, dots: 0, wicketMeter: 0 };
        });
        
        // Initialize bowler stats
        gameState.team1.players.forEach(player => {
          gameState.bowlerStatsAll[player] = { runs: 0, wickets: 0, balls: 0, dots: 0, maidens: 0 };
        });
      }
      
      // Set powerplay overs based on format
      setPowerplayOvers();
      
      // Set total days and overs per day for Test matches
      if (gameState.format === 'test') {
        gameState.totalDays = 5;
        gameState.oversPerDay = 90; // Default, can be changed in settings
      }
      
      // Save initial game state
      saveGameState();
      updateUI();
    }

    // Set powerplay overs based on match format
    function setPowerplayOvers() {
      switch (gameState.format) {
        case '5': // T5
          gameState.powerplayOvers = [1, 2];
          break;
        case '10': // T10
          gameState.powerplayOvers = [1, 2, 3];
          break;
        case '20': // T20
          gameState.powerplayOvers = [1, 2, 3, 4, 5, 6];
          break;
        case '50': // ODI
          gameState.powerplayOvers = [...Array(10).keys()].map(i => i + 1); // 1-10
          // Also set dead overs (11-20, 31-40)
          gameState.deadOvers = [...Array(10).keys()].map(i => i + 11)
                            .concat([...Array(10).keys()].map(i => i + 31));
          break;
        case 'test': // Test
          gameState.powerplayOvers = []; // No powerplays in Test
          gameState.deadOvers = []; // No dead overs in Test
          break;
        default: // Default to T20
          gameState.powerplayOvers = [1, 2, 3, 4, 5, 6];
      }
    }

    // Update UI based on game state
    function updateUI() {
      // Update scoreboard
      battingTeamName.textContent = gameState.battingTeam === 'player1' ? gameState.team1.name : gameState.team2.name;
      bowlingTeamName.textContent = gameState.bowlingTeam === 'player1' ? gameState.team1.name : gameState.team2.name;
      
      battingScore.textContent = `${gameState.score.runs}/${gameState.score.wickets}`;
      bowlingScore.textContent = `${gameState.bowlingScore.runs}/${gameState.bowlingScore.wickets}`;
      
      const overs = Math.floor(gameState.totalBalls / 6);
      const balls = gameState.totalBalls % 6;
      const overString = `${overs}.${balls}`;
      
      battingOvers.textContent = `Overs: ${overString}`;
      bowlingOvers.textContent = `Overs: ${overString}`;
      
      const runRate = calculateRunRate(gameState.score.runs, gameState.totalBalls);
      battingRunRate.textContent = `RR: ${runRate}`;
      
      if (gameState.innings === 2) {
        const bowlingRunRateValue = calculateRunRate(gameState.bowlingScore.runs, gameState.totalBalls);
        bowlingRunRate.textContent = `ER: ${bowlingRunRateValue}`;
        
        // Show target and required rate
        targetDisplay.style.display = 'block';
        targetRuns.textContent = gameState.target - gameState.score.runs;
        targetOvers.textContent = getTotalOvers() - overString;
        
        const requiredRuns = gameState.target - gameState.score.runs;
        const remainingBalls = (getTotalOvers() * 6) - gameState.totalBalls;
        const requiredRateValue = remainingBalls > 0 ? (requiredRuns / remainingBalls * 6).toFixed(2) : '0.00';
        requiredRate.textContent = requiredRateValue;
      } else {
        bowlingRunRate.textContent = `ER: ${runRate}`;
        targetDisplay.style.display = 'none';
      }
      
      // Update innings and day info
      inningsNumber.textContent = gameState.innings === 1 ? '1st' : '2nd';
      matchDay.textContent = `${gameState.day}/${gameState.totalDays}`;
      
      // Update partnership and last wicket
      partnershipRuns.textContent = gameState.partnership.runs;
      lastWicket.textContent = gameState.lastWicket.runs;
      
      // Update current players
      strikerName.textContent = gameState.striker;
      strikerRuns.textContent = gameState.strikerStats.runs;
      strikerBalls.textContent = gameState.strikerStats.balls;
      strikerSR.textContent = gameState.strikerStats.balls > 0 ? 
        ((gameState.strikerStats.runs / gameState.strikerStats.balls) * 100).toFixed(2) : '0.00';
      strikerBoundaries.textContent = `${gameState.strikerStats.fours}/${gameState.strikerStats.sixes}`;
      strikerWicketMeter.style.width = `${gameState.strikerStats.wicketMeter * 100}%`;
      
      bowlerName.textContent = gameState.currentBowler;
      bowlerOvers.textContent = formatOvers(gameState.bowlerStats.balls);
      bowlerWickets.textContent = gameState.bowlerStats.wickets;
      bowlerRuns.textContent = gameState.bowlerStats.runs;
      bowlerEconomy.textContent = gameState.bowlerStats.balls > 0 ? 
        (gameState.bowlerStats.runs / (gameState.bowlerStats.balls / 6)).toFixed(2) : '0.00';
      
      // Update powerplay/dead over indicators
      updateOverIndicators();
      
      // Update timeline
      updateTimeline();
    }

    // Calculate total overs based on format
    function getTotalOvers() {
      switch (gameState.format) {
        case '5': return 5;
        case '10': return 10;
        case '20': return 20;
        case '50': return 50;
        case 'test': return gameState.oversPerDay;
        default: return 20;
      }
    }

    // Calculate run rate
    function calculateRunRate(runs, balls) {
      const overs = balls / 6;
      return overs > 0 ? (runs / overs).toFixed(2) : '0.00';
    }

    // Format overs (balls to overs.balls)
    function formatOvers(balls) {
      return `${Math.floor(balls / 6)}.${balls % 6}`;
    }

    // Get format name
    function getFormatName(format) {
      switch (format) {
        case '5': return 'T5 (5 Overs)';
        case '10': return 'T10 (10 Overs)';
        case '20': return 'T20 (20 Overs)';
        case '50': return 'ODI (50 Overs)';
        case 'test': return 'Test Match';
        default: return 'T20 (20 Overs)';
      }
    }

    // Update powerplay/dead over indicators
    function updateOverIndicators() {
      const currentOver = Math.floor(gameState.totalBalls / 6) + 1;
      
      // Check powerplay
      if (gameState.powerplayOvers.includes(currentOver)) {
        gameState.isPowerplay = true;
        powerplayIndicator.style.display = 'block';
        
        let ppEnd = gameState.powerplayOvers[gameState.powerplayOvers.length - 1];
        if (gameState.format === '50') {
          // ODI has multiple powerplays
          if (currentOver <= 10) {
            ppEnd = 10;
          } else if (currentOver >= 31 && currentOver <= 40) {
            ppEnd = 40;
          }
        }
        
        powerplayIndicator.textContent = `Powerplay: Overs ${currentOver}-${ppEnd}`;
      } else {
        gameState.isPowerplay = false;
        powerplayIndicator.style.display = 'none';
      }
      
      // Check dead over (ODI only)
      if (gameState.format === '50' && gameState.deadOvers.includes(currentOver)) {
        gameState.isDeadOver = true;
        deadOverIndicator.style.display = 'block';
      } else {
        gameState.isDeadOver = false;
        deadOverIndicator.style.display = 'none';
      }
      
      // Free hit indicator
      if (gameState.isFreeHit) {
        freeHitIndicator.style.display = 'block';
      } else {
        freeHitIndicator.style.display = 'none';
      }
    }

    // Update team display based on batting/bowling team
    function updateTeamDisplay() {
      if (gameState.battingTeam === 'player1') {
        battingTeamName.textContent = gameState.team1.name;
        bowlingTeamName.textContent = gameState.team2.name;
      } else {
        battingTeamName.textContent = gameState.team2.name;
        bowlingTeamName.textContent = gameState.team1.name;
      }
    }

    // Update timeline with ball events
    function updateTimeline() {
      timelineItems.innerHTML = '';
      
      gameState.timeline.forEach(event => {
        const item = document.createElement('div');
        item.className = 'timeline-item';
        
        const over = document.createElement('div');
        over.className = 'timeline-over';
        over.textContent = `${event.over}.${event.ball}`;
        
        const eventDesc = document.createElement('div');
        eventDesc.className = `timeline-event ${event.event.toLowerCase().replace(' ', '')}`;
        
        let eventText = '';
        if (event.event === 'Wicket') {
          eventText = `Wicket! ${event.batsman} ${event.details}`;
        } else if (event.event === 'Four') {
          eventText = `${event.batsman} hits a FOUR`;
        } else if (event.event === 'Six') {
          eventText = `${event.batsman} hits a SIX`;
        } else if (event.event === 'No Ball') {
          eventText = `NO BALL +${event.runs}`;
        } else if (event.event === 'Wide') {
          eventText = `WIDE +${event.runs}`;
        } else {
          eventText = `${event.batsman}: ${event.runs} run${event.runs !== 1 ? 's' : ''}`;
        }
        
        eventDesc.textContent = eventText;
        
        const runs = document.createElement('div');
        runs.className = 'timeline-runs';
        runs.textContent = `+${event.runs}`;
        
        item.appendChild(over);
        item.appendChild(eventDesc);
        item.appendChild(runs);
        
        timelineItems.appendChild(item);
      });
      
      // Scroll to bottom
      timelineItems.scrollTop = timelineItems.scrollHeight;
    }

    // Set up event listeners
    function setupEventListeners() {
      // Card buttons
      cardButtons.forEach((button, index) => {
        button.addEventListener('click', () => playBall(index));
      });
      
      // Clear timeline
      clearTimeline.addEventListener('click', () => {
        gameState.timeline = [];
        updateTimeline();
      });
      
      // Teams modal
      document.addEventListener('keydown', (e) => {
        if (e.key === 't') {
          showTeamsModal();
        } else if (e.key === 's') {
          showStatsModal();
        }
      });
      
      closeTeamsModal.addEventListener('click', () => {
        teamsModal.classList.remove('active');
      });
      
      // Stats modal
      statsTabs.forEach(tab => {
        tab.addEventListener('click', () => {
          statsTabs.forEach(t => t.classList.remove('active'));
          statsContents.forEach(c => c.classList.remove('active'));
          
          tab.classList.add('active');
          document.getElementById(`${tab.dataset.tab}Stats`).classList.add('active');
          
          // Update stats when tab is clicked
          if (tab.dataset.tab === 'batting') updateBattingStats();
          else if (tab.dataset.tab === 'bowling') updateBowlingStats();
          else if (tab.dataset.tab === 'partnerships') updatePartnershipStats();
        });
      });
      
      closeStatsModal.addEventListener('click', () => {
        statsModal.classList.remove('active');
      });
      
      // Summary modal
      closeSummaryModal.addEventListener('click', () => {
        summaryModal.classList.remove('active');
      });
      
      continueGameBtn.addEventListener('click', () => {
        summaryModal.classList.remove('active');
        startNextInnings();
      });
      
      // Match result modal
      closeResultModal.addEventListener('click', () => {
        matchResultModal.classList.remove('active');
      });
      
      saveMatchBtn.addEventListener('click', () => {
        saveMatchData();
      });
    }

    // Show teams modal
    function showTeamsModal() {
      teamsContainer.innerHTML = '';
      
      // Team 1
      const team1Div = document.createElement('div');
      team1Div.className = 'team-modal';
      team1Div.innerHTML = `<div class="team-modal-title">${gameState.team1.name}</div>`;
      
      const team1List = document.createElement('ul');
      team1List.className = 'team-players';
      
      gameState.team1.players.forEach(player => {
        const playerItem = document.createElement('li');
        playerItem.className = 'team-player';
        
        const playerName = document.createElement('span');
        playerName.textContent = player;
        
        if (player === gameState.team1.captain) {
          playerName.innerHTML += '<span class="player-captain">(C)</span>';
        } else if (player === gameState.team1.viceCaptain) {
          playerName.innerHTML += '<span class="player-vice">(VC)</span>';
        }
        
        playerItem.appendChild(playerName);
        team1List.appendChild(playerItem);
      });
      
      team1Div.appendChild(team1List);
      teamsContainer.appendChild(team1Div);
      
      // Team 2
      const team2Div = document.createElement('div');
      team2Div.className = 'team-modal';
      team2Div.innerHTML = `<div class="team-modal-title">${gameState.team2.name}</div>`;
      
      const team2List = document.createElement('ul');
      team2List.className = 'team-players';
      
      gameState.team2.players.forEach(player => {
        const playerItem = document.createElement('li');
        playerItem.className = 'team-player';
        
        const playerName = document.createElement('span');
        playerName.textContent = player;
        
        if (player === gameState.team2.captain) {
          playerName.innerHTML += '<span class="player-captain">(C)</span>';
        } else if (player === gameState.team2.viceCaptain) {
          playerName.innerHTML += '<span class="player-vice">(VC)</span>';
        }
        
        playerItem.appendChild(playerName);
        team2List.appendChild(playerItem);
      });
      
      team2Div.appendChild(team2List);
      teamsContainer.appendChild(team2Div);
      
      teamsModal.classList.add('active');
    }

    // Show stats modal
    function showStatsModal() {
      // Set batting tab as active by default
      statsTabs.forEach(t => t.classList.remove('active'));
      statsContents.forEach(c => c.classList.remove('active'));
      
      document.querySelector('.stats-tab[data-tab="batting"]').classList.add('active');
      battingStats.classList.add('active');
      
      // Update batting stats
      updateBattingStats();
      
      statsModal.classList.add('active');
    }

    // Update batting stats table
    function updateBattingStats() {
      battingStats.innerHTML = '';
      
      const table = document.createElement('table');
      table.className = 'stats-table';
      
      const thead = document.createElement('thead');
      thead.innerHTML = `
        <tr>
          <th>Batter</th>
          <th>Runs</th>
          <th>Balls</th>
          <th>SR</th>
          <th>4s</th>
          <th>6s</th>
          <th>Dots</th>
        </tr>
      `;
      
      const tbody = document.createElement('tbody');
      
      // Get current batting team players
      const battingTeam = gameState.battingTeam === 'player1' ? gameState.team1 : gameState.team2;
      
      // Convert to array and sort by runs descending
      const batters = battingTeam.players.map(player => {
        return { name: player, ...gameState.batterStats[player] };
      }).sort((a, b) => b.runs - a.runs);
      
      batters.forEach(batter => {
        const row = document.createElement('tr');
        if (batter.name === gameState.striker || batter.name === gameState.nonStriker) {
          row.classList.add('highlight');
        }
        
        const sr = batter.balls > 0 ? ((batter.runs / batter.balls) * 100).toFixed(2) : '0.00';
        
        row.innerHTML = `
          <td>${batter.name}</td>
          <td>${batter.runs}</td>
          <td>${batter.balls}</td>
          <td>${sr}</td>
          <td>${batter.fours}</td>
          <td>${batter.sixes}</td>
          <td>${batter.dots}</td>
        `;
        
        tbody.appendChild(row);
      });
      
      table.appendChild(thead);
      table.appendChild(tbody);
      battingStats.appendChild(table);
    }

    // Update bowling stats table
    function updateBowlingStats() {
      bowlingStats.innerHTML = '';
      
      const table = document.createElement('table');
      table.className = 'stats-table';
      
      const thead = document.createElement('thead');
      thead.innerHTML = `
        <tr>
          <th>Bowler</th>
          <th>Overs</th>
          <th>Runs</th>
          <th>Wkts</th>
          <th>ER</th>
          <th>Dots</th>
          <th>Mdns</th>
        </tr>
      `;
      
      const tbody = document.createElement('tbody');
      
      // Get current bowling team players
      const bowlingTeam = gameState.bowlingTeam === 'player1' ? gameState.team1 : gameState.team2;
      
      // Convert to array and sort by wickets descending, then runs ascending
      const bowlers = bowlingTeam.players.map(player => {
        return { name: player, ...gameState.bowlerStatsAll[player] };
      }).sort((a, b) => {
        if (b.wickets !== a.wickets) return b.wickets - a.wickets;
        return a.runs - b.runs;
      });
      
      bowlers.forEach(bowler => {
        const row = document.createElement('tr');
        if (bowler.name === gameState.currentBowler) {
          row.classList.add('highlight');
        }
        
        const overs = formatOvers(bowler.balls);
        const economy = bowler.balls > 0 ? (bowler.runs / (bowler.balls / 6)).toFixed(2) : '0.00';
        
        row.innerHTML = `
          <td>${bowler.name}</td>
          <td>${overs}</td>
          <td>${bowler.runs}</td>
          <td>${bowler.wickets}</td>
          <td>${economy}</td>
          <td>${bowler.dots}</td>
          <td>${bowler.maidens}</td>
        `;
        
        tbody.appendChild(row);
      });
      
      table.appendChild(thead);
      table.appendChild(tbody);
      bowlingStats.appendChild(table);
    }

    // Update partnership stats
    function updatePartnershipStats() {
      partnershipStats.innerHTML = '';
      
      const table = document.createElement('table');
      table.className = 'stats-table';
      
      const thead = document.createElement('thead');
      thead.innerHTML = `
        <tr>
          <th>Partners</th>
          <th>Runs</th>
          <th>Balls</th>
          <th>RR</th>
        </tr>
      `;
      
      const tbody = document.createElement('tbody');
      
      // Current partnership
      const currentRR = gameState.partnership.balls > 0 ? 
        ((gameState.partnership.runs / gameState.partnership.balls) * 100).toFixed(2) : '0.00';
      
      const currentRow = document.createElement('tr');
      currentRow.classList.add('highlight');
      currentRow.innerHTML = `
        <td>${gameState.striker} & ${gameState.nonStriker}</td>
        <td>${gameState.partnership.runs}</td>
        <td>${gameState.partnership.balls}</td>
        <td>${currentRR}</td>
      `;
      tbody.appendChild(currentRow);
      
      // Last wicket partnership
      if (gameState.lastWicket.partnership > 0) {
        const lastRow = document.createElement('tr');
        lastRow.innerHTML = `
          <td>Last Wicket</td>
          <td>${gameState.lastWicket.partnership}</td>
          <td>-</td>
          <td>-</td>
        `;
        tbody.appendChild(lastRow);
      }
      
      table.appendChild(thead);
      table.appendChild(tbody);
      partnershipStats.appendChild(table);
    }

    // Play a ball based on card selection
    function playBall(batterCard) {
      if (gameState.inningsCompleted || gameState.matchCompleted) return;
      
      // Generate bowler's card (random for now, could be AI or opponent's choice)
      const bowlerCard = Math.floor(Math.random() * 7); // 0-6
      
      // Determine outcome based on cards and game rules
      const outcome = determineOutcome(batterCard, bowlerCard);
      
      // Process the outcome
      processOutcome(outcome, batterCard, bowlerCard);
      
      // Update UI and save game state
      updateUI();
      saveGameState();
      
      // Check for innings or match completion
      checkInningsCompletion();
    }

    // Determine outcome based on cards and game rules
    function determineOutcome(batterCard, bowlerCard) {
      // Test match rules
      if (gameState.format === 'test') {
        if (batterCard === 0 && bowlerCard === 0) return { type: 'dot', runs: 0 };
        if (batterCard === 0 && bowlerCard > 0) return { type: 'dot', runs: 0 };
        if (bowlerCard === 0 && batterCard > 0) return { type: 'runs', runs: batterCard };
        if (batterCard === bowlerCard) return { type: 'wicket', runs: 0 };
        return { type: 'runs', runs: batterCard };
      }
      
      // Dead over rules (ODI only)
      if (gameState.isDeadOver && gameState.format === '50') {
        if (batterCard === 0 && bowlerCard === 0) return { type: 'dot', runs: 0 };
        if (batterCard === 0 && bowlerCard > 0) return { type: 'dot', runs: 0 };
        if (bowlerCard === 0 && batterCard > 0) return { type: 'dot', runs: 0 };
        if (batterCard === bowlerCard) return { type: 'wicket', runs: 0 };
        return { type: 'runs', runs: batterCard };
      }
      
      // Standard rules for other formats
      if (batterCard === bowlerCard) return { type: 'wicket', runs: 0 };
      if (batterCard === 0 && bowlerCard > 0) return { type: 'runs', runs: bowlerCard };
      if (bowlerCard === 0 && batterCard > 0) return { type: 'dot', runs: 0 };
      if (batterCard === 0 && bowlerCard === 0) {
        gameState.isNoBall = true;
        return { type: 'noball', runs: 1 };
      }
      return { type: 'runs', runs: batterCard };
    }

    // Process the outcome of a ball
    function processOutcome(outcome, batterCard, bowlerCard) {
      const currentOver = Math.floor(gameState.totalBalls / 6) + 1;
      const currentBall = (gameState.totalBalls % 6) + 1;
      
      // Handle free hit (wickets don't count)
      if (gameState.isFreeHit && outcome.type === 'wicket') {
        outcome.type = 'runs';
        outcome.runs = batterCard;
      }
      
      // Handle no-ball (free hit next ball)
      if (outcome.type === 'noball') {
        gameState.isFreeHit = true;
      } else {
        gameState.isFreeHit = false;
      }
      
      // Update total balls (except for wides/noballs)
      if (outcome.type !== 'wide' && outcome.type !== 'noball') {
        gameState.totalBalls++;
        gameState.bowlerStats.balls++;
        gameState.bowlerStatsAll[gameState.currentBowler].balls++;
        
        // Update striker's balls faced
        gameState.strikerStats.balls++;
        gameState.batterStats[gameState.striker].balls++;
        
        // Check for maiden over (no runs conceded in over)
        if (outcome.runs === 0) {
          gameState.bowlerStats.dots++;
          gameState.bowlerStatsAll[gameState.currentBowler].dots++;
          gameState.strikerStats.dots++;
          gameState.batterStats[gameState.striker].dots++;
        }
      }
      
      // Process runs or wicket
      if (outcome.type === 'runs') {
        gameState.score.runs += outcome.runs;
        gameState.strikerStats.runs += outcome.runs;
        gameState.batterStats[gameState.striker].runs += outcome.runs;
        gameState.bowlerStats.runs += outcome.runs;
        gameState.bowlerStatsAll[gameState.currentBowler].runs += outcome.runs;
        gameState.partnership.runs += outcome.runs;
        gameState.partnership.balls++;
        
        // Update fours/sixes
        if (outcome.runs === 4) {
          gameState.strikerStats.fours++;
          gameState.batterStats[gameState.striker].fours++;
        } else if (outcome.runs === 6) {
          gameState.strikerStats.sixes++;
          gameState.batterStats[gameState.striker].sixes++;
        }
        
        // Add timeline event
        addTimelineEvent({
          over: currentOver,
          ball: currentBall,
          event: outcome.runs === 4 ? 'Four' : (outcome.runs === 6 ? 'Six' : 'Run'),
          batsman: gameState.striker,
          runs: outcome.runs,
          details: ''
        });
        
        // Change strike for odd runs (except last ball of over)
        if (outcome.runs % 2 !== 0 && currentBall !== 6) {
          swapStrike();
        }
      } 
      else if (outcome.type === 'wicket') {
        // Calculate wicket value based on format and situation
        let wicketValue = 1.0; // Default for T20, T10, T5
        
        if (gameState.format === '50') { // ODI
          wicketValue = gameState.isPowerplay ? 0.25 : 0.5;
        } else if (gameState.format === 'test') { // Test
          wicketValue = 0.33; // 1/3 of a wicket
        } else { // T20, T10, T5
          wicketValue = gameState.isPowerplay ? 0.5 : 1.0;
        }
        
        // Update wicket meter
        gameState.strikerStats.wicketMeter += wicketValue;
        gameState.batterStats[gameState.striker].wicketMeter += wicketValue;
        
        // Check if batter is out (meter reaches or exceeds 1.0)
        if (gameState.strikerStats.wicketMeter >= 1.0) {
          gameState.score.wickets++;
          gameState.bowlerStats.wickets++;
          gameState.bowlerStatsAll[gameState.currentBowler].wickets++;
          
          // Record last wicket partnership
          gameState.lastWicket = {
            runs: gameState.score.runs,
            partnership: gameState.partnership.runs
          };
          
          // Reset partnership
          gameState.partnership = { runs: 0, balls: 0 };
          
          // Add timeline event
          addTimelineEvent({
            over: currentOver,
            ball: currentBall,
            event: 'Wicket',
            batsman: gameState.striker,
            runs: 0,
            details: getDismissalType(batterCard, bowlerCard)
          });
          
          // Get next batter
          const battingTeam = gameState.battingTeam === 'player1' ? gameState.team1 : gameState.team2;
          const nextBatterIndex = battingTeam.players.indexOf(gameState.striker) + 1;
          
          if (nextBatterIndex < battingTeam.players.length) {
            gameState.striker = battingTeam.players[nextBatterIndex];
            gameState.strikerStats = { runs: 0, balls: 0, fours: 0, sixes: 0, dots: 0, wicketMeter: 0 };
            
            // Initialize batter stats if not exists
            if (!gameState.batterStats[gameState.striker]) {
              gameState.batterStats[gameState.striker] = { runs: 0, balls: 0, fours: 0, sixes: 0, dots: 0, wicketMeter: 0 };
            }
          }
          
          // Reset wicket meter
          gameState.strikerStats.wicketMeter = 0;
          gameState.batterStats[gameState.striker].wicketMeter = 0;
        } else {
          // Just a warning (meter increased but not out)
          addTimelineEvent({
            over: currentOver,
            ball: currentBall,
            event: 'Warning',
            batsman: gameState.striker,
            runs: 0,
            details: `${Math.round(gameState.strikerStats.wicketMeter * 100)}% danger`
          });
        }
      } 
      else if (outcome.type === 'dot') {
        gameState.strikerStats.dots++;
        gameState.batterStats[gameState.striker].dots++;
        gameState.bowlerStats.dots++;
        gameState.bowlerStatsAll[gameState.currentBowler].dots++;
        
        addTimelineEvent({
          over: currentOver,
          ball: currentBall,
          event: 'Dot',
          batsman: gameState.striker,
          runs: 0,
          details: ''
        });
      } 
      else if (outcome.type === 'noball' || outcome.type === 'wide') {
        gameState.score.runs += outcome.runs;
        gameState.score.extras += outcome.runs;
        gameState.bowlerStats.runs += outcome.runs;
        gameState.bowlerStatsAll[gameState.currentBowler].runs += outcome.runs;
        
        addTimelineEvent({
          over: currentOver,
          ball: currentBall,
          event: outcome.type === 'noball' ? 'No Ball' : 'Wide',
          batsman: gameState.striker,
          runs: outcome.runs,
          details: ''
        });
      }
      
      // Check for over completion (6 legal balls)
      if (currentBall === 6 && outcome.type !== 'wide' && outcome.type !== 'noball') {
        completeOver();
      }
      
      // Check for dot ball rule (4th dot in over = -5 runs)
      if (outcome.type === 'dot' || outcome.type === 'wicket') {
        const dotsThisOver = gameState.timeline
          .filter(e => e.over === currentOver && (e.event === 'Dot' || e.event === 'Wicket'))
          .length;
        
        if (dotsThisOver >= 4) {
          gameState.score.runs -= 5;
          gameState.strikerStats.runs -= 5;
          gameState.batterStats[gameState.striker].runs -= 5;
          
          addTimelineEvent({
            over: currentOver,
            ball: currentBall,
            event: 'Penalty',
            batsman: gameState.striker,
            runs: -5,
            details: '4+ dots in over'
          });
        }
      }
      
      // Check for zero ball rule (4th zero in over = no ball + free hit)
      if (bowlerCard === 0) {
        const zerosThisOver = gameState.timeline
          .filter(e => e.over === currentOver && e.event.includes('0'))
          .length;
        
        if (zerosThisOver >= 4) {
          gameState.score.runs += 1;
          gameState.score.extras += 1;
          gameState.bowlerStats.runs += 1;
          gameState.bowlerStatsAll[gameState.currentBowler].runs += 1;
          gameState.isFreeHit = true;
          
          addTimelineEvent({
            over: currentOver,
            ball: currentBall,
            event: 'No Ball',
            batsman: gameState.striker,
            runs: 1,
            details: '4+ zeros in over'
          });
        }
      }
      
      // Trigger animations based on outcome
      triggerAnimations(outcome);
    }

    // Get dismissal type based on cards
    function getDismissalType(batterCard, bowlerCard) {
      if (batterCard === bowlerCard) {
        const types = [
          'bowled', 'caught', 'lbw', 'stumped', 
          'hit wicket', 'caught & bowled', 'run out'
        ];
        return types[Math.floor(Math.random() * types.length)];
      }
      return 'unknown';
    }

    // Complete an over (6 balls)
    function completeOver() {
      // Check for maiden over (no runs conceded)
      if (gameState.bowlerStats.runs === 0) {
        gameState.bowlerStats.maidens++;
        gameState.bowlerStatsAll[gameState.currentBowler].maidens++;
      }
      
      // Change strike
      swapStrike();
      
      // Get next bowler
      const bowlingTeam = gameState.bowlingTeam === 'player1' ? gameState.team1 : gameState.team2;
      const currentBowlerIndex = bowlingTeam.players.indexOf(gameState.currentBowler);
      const nextBowlerIndex = (currentBowlerIndex + 1) % bowlingTeam.players.length;
      
      gameState.currentBowler = bowlingTeam.players[nextBowlerIndex];
      gameState.bowlerStats = { runs: 0, wickets: 0, balls: 0, dots: 0, maidens: 0 };
      
      // Check for day completion in Test matches
      if (gameState.format === 'test') {
        const oversToday = Math.floor(gameState.totalBalls / 6) - ((gameState.day - 1) * gameState.oversPerDay);
        if (oversToday >= gameState.oversPerDay) {
          completeDay();
        }
      }
    }

    // Swap striker and non-striker
    function swapStrike() {
      const temp = gameState.striker;
      gameState.striker = gameState.nonStriker;
      gameState.nonStriker = temp;
      
      // Also swap their stats for display
      const tempStats = gameState.strikerStats;
      gameState.strikerStats = gameState.nonStrikerStats;
      gameState.nonStrikerStats = tempStats;
    }

    // Complete a day in Test matches
    function completeDay() {
      gameState.day++;
      
      // Check if match is completed (all days or innings)
      if (gameState.day > gameState.totalDays) {
        completeInnings();
      } else {
        // Show day summary
        addTimelineEvent({
          over: 0,
          ball: 0,
          event: 'Day',
          batsman: '',
          runs: gameState.day - 1,
          details: `Stumps on Day ${gameState.day - 1}`
        });
      }
    }

    // Check if innings is completed
    function checkInningsCompletion() {
      const battingTeam = gameState.battingTeam === 'player1' ? gameState.team1 : gameState.team2;
      
      // Innings ends if all wickets lost or all overs bowled
      const totalOvers = getTotalOvers();
      const oversBowled = Math.floor(gameState.totalBalls / 6);
      
      if (gameState.score.wickets >= 10 || oversBowled >= totalOvers) {
        completeInnings();
      }
    }

    // Complete the current innings
    function completeInnings() {
      gameState.inningsCompleted = true;
      
      // For Test matches, check if follow-on is possible
      if (gameState.format === 'test' && gameState.innings === 1) {
        const firstInningsLead = gameState.score.runs - gameState.bowlingScore.runs;
        if (firstInningsLead >= 200) { // Standard Test follow-on rule
          gameState.followOn = true;
        }
      }
      
      // Save bowling team's score (for 2nd innings target)
      if (gameState.innings === 1) {
        gameState.bowlingScore.runs = gameState.score.runs;
        gameState.bowlingScore.wickets = gameState.score.wickets;
      }
      
      // Show innings summary
      showInningsSummary();
      
      // Save game state
      saveGameState();
    }

    // Show innings summary modal
    function showInningsSummary() {
      const battingTeam = gameState.battingTeam === 'player1' ? gameState.team1 : gameState.team2;
      const bowlingTeam = gameState.bowlingTeam === 'player1' ? gameState.team1 : gameState.team2;
      
      summaryInningsTitle.textContent = `${gameState.innings === 1 ? '1st' : '2nd'} Innings - ${battingTeam.name}`;
      
      // Innings stats
      const overs = formatOvers(gameState.totalBalls);
      const runRate = calculateRunRate(gameState.score.runs, gameState.totalBalls);
      
      inningsSummaryStats.innerHTML = `
        <div class="summary-stat">
          <div class="summary-stat-label">Runs</div>
          <div class="summary-stat-value">${gameState.score.runs}</div>
        </div>
        <div class="summary-stat">
          <div class="summary-stat-label">Wickets</div>
          <div class="summary-stat-value">${gameState.score.wickets}</div>
        </div>
        <div class="summary-stat">
          <div class="summary-stat-label">Overs</div>
          <div class="summary-stat-value">${overs}</div>
        </div>
        <div class="summary-stat">
          <div class="summary-stat-label">Run Rate</div>
          <div class="summary-stat-value">${runRate}</div>
        </div>
        <div class="summary-stat">
          <div class="summary-stat-label">Extras</div>
          <div class="summary-stat-value">${gameState.score.extras}</div>
        </div>
      `;
      
      // Awards (best batter, best bowler)
      inningsAwards.innerHTML = '';
      
      // Best batter
      const batters = Object.entries(gameState.batterStats)
        .map(([name, stats]) => ({ name, ...stats }))
        .sort((a, b) => b.runs - a.runs);
      
      if (batters.length > 0 && batters[0].runs > 0) {
        const bestBatterCard = document.createElement('div');
        bestBatterCard.className = 'award-card';
        bestBatterCard.innerHTML = `
          <div class="award-title">Top Batter</div>
          <div class="award-winner">${batters[0].name} (${batters[0].runs})</div>
        `;
        inningsAwards.appendChild(bestBatterCard);
      }
      
      // Best bowler
      const bowlers = Object.entries(gameState.bowlerStatsAll)
        .map(([name, stats]) => ({ name, ...stats }))
        .sort((a, b) => {
          if (b.wickets !== a.wickets) return b.wickets - a.wickets;
          return a.runs - b.runs;
        });
      
      if (bowlers.length > 0 && bowlers[0].wickets > 0) {
        const bestBowlerCard = document.createElement('div');
        bestBowlerCard.className = 'award-card';
        bestBowlerCard.innerHTML = `
          <div class="award-title">Top Bowler</div>
          <div class="award-winner">${bowlers[0].name} (${bowlers[0].wickets}/${bowlers[0].runs})</div>
        `;
        inningsAwards.appendChild(bestBowlerCard);
      }
      
      // Show follow-on message if applicable
      if (gameState.followOn) {
        const followOnCard = document.createElement('div');
        followOnCard.className = 'award-card';
        followOnCard.innerHTML = `
          <div class="award-title">Follow-On</div>
          <div class="award-winner">${battingTeam.name} can enforce follow-on</div>
        `;
        inningsAwards.appendChild(followOnCard);
      }
      
      // Show modal
      summaryModal.classList.add('active');
    }

    // Start next innings or complete match
    function startNextInnings() {
      if (gameState.innings === 1) {
        // Start 2nd innings
        gameState.innings = 2;
        gameState.inningsCompleted = false;
        
        // Swap batting and bowling teams
        const temp = gameState.battingTeam;
        gameState.battingTeam = gameState.bowlingTeam;
        gameState.bowlingTeam = temp;
        
        // Set target for 2nd innings
        gameState.target = gameState.bowlingScore.runs + 1;
        
        // Reset scores but keep bowling team's score
        gameState.score = { runs: 0, wickets: 0, extras: 0 };
        gameState.totalBalls = 0;
        
        // Set new striker and non-striker
        const battingTeam = gameState.battingTeam === 'player1' ? gameState.team1 : gameState.team2;
        gameState.striker = battingTeam.players[0] || 'Batter 1';
        gameState.nonStriker = battingTeam.players[1] || 'Batter 2';
        gameState.strikerStats = { runs: 0, balls: 0, fours: 0, sixes: 0, dots: 0, wicketMeter: 0 };
        gameState.nonStrikerStats = { runs: 0, balls: 0, fours: 0, sixes: 0, dots: 0, wicketMeter: 0 };
        
        // Set new bowler
        const bowlingTeam = gameState.bowlingTeam === 'player1' ? gameState.team1 : gameState.team2;
        gameState.currentBowler = bowlingTeam.players[0] || 'Bowler 1';
        gameState.bowlerStats = { runs: 0, wickets: 0, balls: 0, dots: 0, maidens: 0 };
        
        // Reset partnership and last wicket
        gameState.partnership = { runs: 0, balls: 0 };
        gameState.lastWicket = { runs: 0, partnership: 0 };
        
        // Initialize batter stats if not exists
        battingTeam.players.forEach(player => {
          if (!gameState.batterStats[player]) {
            gameState.batterStats[player] = { runs: 0, balls: 0, fours: 0, sixes: 0, dots: 0, wicketMeter: 0 };
          }
        });
        
        // Initialize bowler stats if not exists
        bowlingTeam.players.forEach(player => {
          if (!gameState.bowlerStatsAll[player]) {
            gameState.bowlerStatsAll[player] = { runs: 0, wickets: 0, balls: 0, dots: 0, maidens: 0 };
          }
        });
        
        // Update UI and save state
        updateUI();
        saveGameState();
      } else {
        // Match completed
        completeMatch();
      }
    }

    // Complete the match and show result
    function completeMatch() {
      gameState.matchCompleted = true;
      
      // Determine result
      let resultText = '';
      let margin = '';
      
      if (gameState.format === 'test') {
        // Test match result
        if (gameState.score.runs > gameState.bowlingScore.runs) {
          const runsDiff = gameState.score.runs - gameState.bowlingScore.runs;
          resultText = `${gameState.battingTeam === 'player1' ? gameState.team1.name : gameState.team2.name} won by ${runsDiff} runs`;
          margin = `${runsDiff} runs`;
        } else if (gameState.bowlingScore.runs > gameState.score.runs) {
          const runsDiff = gameState.bowlingScore.runs - gameState.score.runs;
          resultText = `${gameState.bowlingTeam === 'player1' ? gameState.team1.name : gameState.team2.name} won by ${runsDiff} runs`;
          margin = `${runsDiff} runs`;
        } else {
          resultText = 'Match drawn';
          margin = 'Drawn';
        }
      } else {
        // Limited overs result
        if (gameState.innings === 1) {
          // Only one innings completed (opponent didn't bat)
          resultText = `${gameState.battingTeam === 'player1' ? gameState.team1.name : gameState.team2.name} won by ${10 - gameState.score.wickets} wickets`;
          margin = `${10 - gameState.score.wickets} wickets`;
        } else {
          if (gameState.score.runs >= gameState.target) {
            const wicketsLeft = 10 - gameState.score.wickets;
            resultText = `${gameState.battingTeam === 'player1' ? gameState.team1.name : gameState.team2.name} won by ${wicketsLeft} wickets`;
            margin = `${wicketsLeft} wickets`;
          } else {
            const runsDiff = gameState.target - gameState.score.runs - 1;
            resultText = `${gameState.bowlingTeam === 'player1' ? gameState.team1.name : gameState.team2.name} won by ${runsDiff} runs`;
            margin = `${runsDiff} runs`;
          }
        }
      }
      
      // Show match result modal
      showMatchResult(resultText, margin);
      
      // Save game state
      saveGameState();
    }

    // Show match result modal
    function showMatchResult(resultText = '', margin = '') {
      if (!resultText) {
        // Determine result if not provided
        if (gameState.score.runs >= gameState.target) {
          const wicketsLeft = 10 - gameState.score.wickets;
          resultText = `${gameState.battingTeam === 'player1' ? gameState.team1.name : gameState.team2.name} won by ${wicketsLeft} wickets`;
          margin = `${wicketsLeft} wickets`;
        } else {
          const runsDiff = gameState.target - gameState.score.runs - 1;
          resultText = `${gameState.bowlingTeam === 'player1' ? gameState.team1.name : gameState.team2.name} won by ${runsDiff} runs`;
          margin = `${runsDiff} runs`;
        }
      }
      
      resultTitle.textContent = resultText;
      
      // Result stats
      const battingTeam = gameState.battingTeam === 'player1' ? gameState.team1 : gameState.team2;
      const bowlingTeam = gameState.bowlingTeam === 'player1' ? gameState.team1 : gameState.team2;
      
      resultStats.innerHTML = `
        <div class="summary-stat">
          <div class="summary-stat-label">${battingTeam.name}</div>
          <div class="summary-stat-value">${gameState.score.runs}/${gameState.score.wickets}</div>
        </div>
        <div class="summary-stat">
          <div class="summary-stat-label">${bowlingTeam.name}</div>
          <div class="summary-stat-value">${gameState.bowlingScore.runs}/${gameState.bowlingScore.wickets}</div>
        </div>
        <div class="summary-stat">
          <div class="summary-stat-label">Margin</div>
          <div class="summary-stat-value">${margin}</div>
        </div>
      `;
      
      // Awards (player of the match, best batter, best bowler)
      matchAwards.innerHTML = '';
      
      // Player of the match (highest impact player)
      const batters = Object.entries(gameState.batterStats)
        .map(([name, stats]) => ({ name, ...stats, team: battingTeam.name }))
        .concat(Object.entries(gameState.bowlerStatsAll)
          .map(([name, stats]) => ({ name, ...stats, team: bowlingTeam.name })))
        .sort((a, b) => {
          // Simple impact calculation (runs + wickets*25)
          const aImpact = a.runs + (a.wickets * 25);
          const bImpact = b.runs + (b.wickets * 25);
          return bImpact - aImpact;
        });
      
      if (batters.length > 0) {
        const pomCard = document.createElement('div');
        pomCard.className = 'award-card';
        pomCard.innerHTML = `
          <div class="award-title">Player of the Match</div>
          <div class="award-winner">${batters[0].name} (${batters[0].team})</div>
        `;
        matchAwards.appendChild(pomCard);
      }
      
      // Best batter (most runs)
      const topBatter = batters
        .filter(p => p.balls > 0)
        .sort((a, b) => b.runs - a.runs)[0];
      
      if (topBatter) {
        const bestBatterCard = document.createElement('div');
        bestBatterCard.className = 'award-card';
        bestBatterCard.innerHTML = `
          <div class="award-title">Best Batter</div>
          <div class="award-winner">${topBatter.name} (${topBatter.runs})</div>
        `;
        matchAwards.appendChild(bestBatterCard);
      }
      
      // Best bowler (most wickets)
      const topBowler = batters
        .filter(p => p.wickets > 0)
        .sort((a, b) => b.wickets - a.wickets || a.runs - b.runs)[0];
      
      if (topBowler) {
        const bestBowlerCard = document.createElement('div');
        bestBowlerCard.className = 'award-card';
        bestBowlerCard.innerHTML = `
          <div class="award-title">Best Bowler</div>
          <div class="award-winner">${topBowler.name} (${topBowler.wickets}/${topBowler.runs})</div>
        `;
        matchAwards.appendChild(bestBowlerCard);
      }
      
      // Show modal
      matchResultModal.classList.add('active');
    }

    // Save match data to database
    async function saveMatchData() {
      try {
        // Prepare match data
        const matchData = {
          team1Name: gameState.team1.name,
          team2Name: gameState.team2.name,
          format: getFormatName(gameState.format),
          winner: gameState.score.runs >= gameState.target ? gameState.battingTeam : gameState.bowlingTeam,
          winningMargin: resultTitle.textContent.split('won by ')[1],
          playerOfTheMatch: document.querySelector('#matchAwards .award-card .award-winner').textContent.split(' (')[0],
          timestamp: Date.now(),
          firstInnings: {
            battingTeam: gameState.innings === 1 ? gameState.battingTeam : gameState.bowlingTeam,
            totalRuns: gameState.innings === 1 ? gameState.score.runs : gameState.bowlingScore.runs,
            totalWickets: gameState.innings === 1 ? gameState.score.wickets : gameState.bowlingScore.wickets,
            balls: gameState.innings === 1 ? gameState.totalBalls : gameState.totalBalls,
            batterStats: gameState.innings === 1 ? gameState.batterStats : {},
            bowlerStats: gameState.innings === 1 ? gameState.bowlerStatsAll : {}
          },
          secondInnings: {
            battingTeam: gameState.innings === 2 ? gameState.battingTeam : gameState.bowlingTeam,
            totalRuns: gameState.innings === 2 ? gameState.score.runs : gameState.bowlingScore.runs,
            totalWickets: gameState.innings === 2 ? gameState.score.wickets : gameState.bowlingScore.wickets,
            balls: gameState.innings === 2 ? gameState.totalBalls : gameState.totalBalls,
            batterStats: gameState.innings === 2 ? gameState.batterStats : {},
            bowlerStats: gameState.innings === 2 ? gameState.bowlerStatsAll : {}
          }
        };
        
        // Save to database
        const newMatchRef = push(savedMatchesRef);
        await set(newMatchRef, matchData);
        
        // Redirect to match summary page
        window.location.href = `match_summary.html?id=${newMatchRef.key}`;
      } catch (error) {
        console.error('Error saving match data:', error);
        alert('Failed to save match data. Please try again.');
      }
    }

    // Add timeline event
    function addTimelineEvent(event) {
      gameState.timeline.push(event);
      if (gameState.timeline.length > 50) {
        gameState.timeline.shift();
      }
      updateTimeline();
    }

    // Save game state to Firebase
    function saveGameState() {
      update(gameRef, gameState).catch(error => {
        console.error('Error saving game state:', error);
      });
    }

    // Trigger animations based on outcome
    function triggerAnimations(outcome) {
      // Ripple effect on card buttons
      cardButtons[outcome.runs].classList.add('ripple', 'active');
      setTimeout(() => {
        cardButtons[outcome.runs].classList.remove('active');
      }, 100);
      
      // Bounce effect for runs
      if (outcome.type === 'runs' && outcome.runs > 0) {
        battingScore.classList.add('bounce');
        setTimeout(() => {
          battingScore.classList.remove('bounce');
        }, 500);
      }
      
      // Shake effect for wickets
      if (outcome.type === 'wicket') {
        document.querySelector('.wicket-meter').classList.add('shake');
        setTimeout(() => {
          document.querySelector('.wicket-meter').classList.remove('shake');
        }, 500);
      }
      
      // Confetti for milestones
      if (outcome.type === 'runs') {
        const striker = gameState.batterStats[gameState.striker];
        
        // 50 runs
        if (striker.runs === 50) {
          createConfetti('gold');
        }
        
        // 100 runs
        if (striker.runs === 100) {
          createConfetti('gold', 100);
        }
      }
    }

    // Create confetti effect
    function createConfetti(color = 'gold', count = 50) {
      confettiContainer.innerHTML = '';
      
      for (let i = 0; i < count; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.background = color;
        confetti.style.left = `${Math.random() * 100}%`;
        confetti.style.animationDuration = `${Math.random() * 3 + 2}s`;
        confetti.style.animationDelay = `${Math.random() * 0.5}s`;
        confettiContainer.appendChild(confetti);
        
        // Remove after animation
        setTimeout(() => {
          confetti.remove();
        }, 3000);
      }
    }

    // Initialize the game
    initGame();
  </script>
</body>
</html>