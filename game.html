
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>HandiCricket - Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { background: #061e3e; color: white; font-family: sans-serif; text-align: center; padding: 20px; }
    .card-row { margin-top: 20px; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
    button.card { width: 60px; height: 60px; font-size: 20px; border-radius: 12px; border: none; background: #1e88e5; color: white; }
    button.card:disabled { background: #607d8b; color: #ccc; }
    #scoreboard, #roleText { margin-top: 10px; font-size: 18px; }
    #status { margin-top: 15px; font-size: 16px; color: #ffeb3b; }
  </style>
</head>
<body>
  <h2>üèè HandiCricket - Game</h2>
  <div id="roleText"></div>
  <div id="selectionArea" style="margin: 10px 0;">
    <div id="batterSelectArea" style="display:none;">
      <label for="batterSelect">Select Batter: </label>
      <select id="batterSelect"></select>
      <button onclick="confirmBatter()">Confirm</button>
    </div>
    <div id="bowlerSelectArea" style="display:none;">
      <label for="bowlerSelect">Select Bowler: </label>
      <select id="bowlerSelect"></select>
      <button onclick="confirmBowler()">Confirm</button>
    </div>
  </div>

  
    <div id="currentPlayers" style="margin-top: 10px; font-weight: bold; font-size: 16px;">
      Batter: <span id="currentBatter">-</span> | Bowler: <span id="currentBowler">-</span>
    </div>
    <div id="scoreboard">
    Runs: 0 | Wickets: 0 | Overs: 0.0</div>
  <div id="status">Waiting for players...</div>

  <div class="card-row" id="cardButtons">
    <button class="card" data-value="0">0</button>
    <button class="card" data-value="1">1</button>
    <button class="card" data-value="2">2</button>
    <button class="card" data-value="3">3</button>
    <button class="card" data-value="4">4</button>
    <button class="card" data-value="5">5</button>
    <button class="card" data-value="6">6</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getDatabase, ref, onValue, set, get } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAGU0Tsj9pwZcgwQjZzTFvGOE032l2b7HI",
      authDomain: "handicricket-d1ab7.firebaseapp.com",
      projectId: "handicricket-d1ab7",
      storageBucket: "handicricket-d1ab7.appspot.com",
      messagingSenderId: "356065986337",
      appId: "1:356065986337:web:399102c5dabfca2b6fe060"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const params = new URLSearchParams(window.location.search);
    const room = params.get('room');
    const player = params.get('player');
    const opponent = player === "player1" ? "player2" : "player1";

    let runs = 0, wickets = 0;
    let legalBalls = 0;
    let freeHit = false;

    const status = document.getElementById("status");
    const scoreboard = document.getElementById("scoreboard");
    const buttons = document.querySelectorAll(".card");
    const roleText = document.getElementById("roleText");

    function disableButtons() {
      buttons.forEach(btn => btn.disabled = true);
    }

    function enableButtons() {
      buttons.forEach(btn => btn.disabled = false);
    }

    function updateScoreboard() {
      const overs = Math.floor(legalBalls / 6);
      const balls = legalBalls % 6;
      scoreboard.textContent = `Runs: ${runs} | Wickets: ${wickets} | Overs: ${overs}.${balls}`;
    }

    function resetPlays() {
      set(ref(db, `rooms/${room}/currentPlays`), { player1: null, player2: null });
    }

    async function setupRole() {
      const snapshot = await get(ref(db, `rooms/${room}/tossWinner`));
      const tossWinner = snapshot.val();
      const isBatting = player === tossWinner;
      const teamSnap = await get(ref(db, `rooms/${room}/${opponent}/playing11`));
      const opponentTeam = teamSnap.val()?.[0] || "Opponent";

      roleText.innerText = isBatting ? `You are Batting vs ${opponentTeam}` : `You are Bowling vs ${opponentTeam}`;
    }

    buttons.forEach(btn => {
      btn.addEventListener("click", () => {
        const val = parseInt(btn.dataset.value);
        disableButtons();
        status.innerText = "Waiting for opponent...";
        set(ref(db, `rooms/${room}/currentPlays/${player}`), val);
      });
    });

    onValue(ref(db, `rooms/${room}/currentPlays`), async (snap) => {
      const plays = snap.val();
      if (!plays || plays.player1 == null || plays.player2 == null) return;

      const tossSnap = await get(ref(db, `rooms/${room}/tossWinner`));
      const tossWinner = tossSnap.val();
      const batCard = plays[tossWinner];
      const bowlCard = plays[tossWinner === "player1" ? "player2" : "player1"];

      let outcome = "";
      let isLegalBall = false;

      if (batCard === 0 && bowlCard === 0) {
        outcome = "NO BALL! +1 run";
        runs += 1;
        freeHit = true;
      } else if (batCard === bowlCard && batCard > 0) {
        if (freeHit) {
          outcome = "Wicket on Free Hit (not out)";
        } else {
          outcome = "WICKET!";
          wickets++;
        }
        isLegalBall = true;
        freeHit = false;
      } else if (batCard === 0 && bowlCard > 0) {
        runs += bowlCard;
        outcome = `Batter played 0. Runs = ${bowlCard}`;
        isLegalBall = true;
        freeHit = false;
      } else if (bowlCard === 0 && batCard > 0) {
        outcome = "DOT BALL!";
        isLegalBall = true;
        freeHit = false;
      } else {
        runs += batCard;
        outcome = `${batCard} Run(s)!`;
        isLegalBall = true;
        freeHit = false;
      }

      if (isLegalBall) legalBalls++;

      status.innerText = outcome;
      updateScoreboard();
      setTimeout(() => {
        resetPlays();
        enableButtons();
        status.innerText = freeHit ? "FREE HIT! Play your next card." : "Play your next card.";
      }, 1500);
    });

    setupRole();
    updateScoreboard();

    const team1NameEl = document.getElementById("team1Name");
    const team2NameEl = document.getElementById("team2Name");
    const team1PlayersEl = document.getElementById("team1Players");
    const team2PlayersEl = document.getElementById("team2Players");

    async function loadPlaying11() {
      const roomRef = ref(db, `rooms/${room}`);
      const snapshot = await get(roomRef);
      const data = snapshot.val();

      const p1 = data.player1;
      const p2 = data.player2;

      team1NameEl.innerText = p1.teamName || "Team 1";
      team2NameEl.innerText = p2.teamName || "Team 2";

      p1.playing11.forEach(p => {
        const li = document.createElement("li");
        li.innerText = p;
        team1PlayersEl.appendChild(li);
      });
      p2.playing11.forEach(p => {
        const li = document.createElement("li");
        li.innerText = p;
        team2PlayersEl.appendChild(li);
      });
    }

    loadPlaying11();


    const batterSelect = document.getElementById("batterSelect");
    const bowlerSelect = document.getElementById("bowlerSelect");
    const batterSelectArea = document.getElementById("batterSelectArea");
    const bowlerSelectArea = document.getElementById("bowlerSelectArea");

    const currentBatterEl = document.getElementById("currentBatter");
    const currentBowlerEl = document.getElementById("currentBowler");

    async function loadPlaying11() {
      const roomRef = ref(db, `rooms/${room}`);
      const snap = await get(roomRef);
      const data = snap.val();
      const isBatting = player === data.battingFirst;
      const ownTeam = data[player].playing11;
      const oppTeam = data[opponent].playing11;

      if (isBatting) {
        batterSelectArea.style.display = "block";
        ownTeam.forEach(p => {
          const opt = document.createElement("option");
          opt.textContent = p;
          opt.value = p;
          batterSelect.appendChild(opt);
        });
      } else {
        bowlerSelectArea.style.display = "block";
        oppTeam.forEach(p => {
          const opt = document.createElement("option");
          opt.textContent = p;
          opt.value = p;
          bowlerSelect.appendChild(opt);
        });
      }
    }

    function confirmBatter() {
      const selected = batterSelect.value;
      set(ref(db, `rooms/${room}/currentBatter`), selected);
      batterSelectArea.style.display = "none";
    }

    function confirmBowler() {
      const selected = bowlerSelect.value;
      set(ref(db, `rooms/${room}/currentBowler`), selected);
      bowlerSelectArea.style.display = "none";
    }

    onValue(ref(db, `rooms/${room}/currentBatter`), snap => {
      const name = snap.val() || "-";
      currentBatterEl.textContent = name;
    });

    onValue(ref(db, `rooms/${room}/currentBowler`), snap => {
      const name = snap.val() || "-";
      currentBowlerEl.textContent = name;
    });

    loadPlaying11();

</script>

  <div id="playingXISection" style="margin-top: 30px;">
    <div id="teamAPlayingXI" style="margin-bottom: 20px;"></div>
    <div id="teamBPlayingXI"></div>
  </div>


  <div style="margin-top: 30px; background: #0d2a52; border-radius: 12px; padding: 15px;">
    <h3 style="color: #ffc107;">Playing XI</h3>
    <div style="display: flex; justify-content: space-around; flex-wrap: wrap;">
      <div>
        <h4 id="team1Name">Team 1</h4>
        <ul id="team1Players" style="text-align: left;"></ul>
      </div>
      <div>
        <h4 id="team2Name">Team 2</h4>
        <ul id="team2Players" style="text-align: left;"></ul>
      </div>
    </div>
  </div>

</body>
</html>
